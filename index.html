<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Truy·ªán</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .auth-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: none;
        }

        .story-form {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .story-list {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .story-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .story-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .story-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .story-chapters {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .chapter-list {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .chapter-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #e1e1e1;
        }

        .chapter-title {
            font-weight: 600;
            color: #444;
            margin-bottom: 5px;
        }

        .chapter-content {
            color: #666;
            font-size: 14px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .toggle-chapters {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .toggle-chapters:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .story-form, .story-list {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Qu·∫£n l√Ω Truy·ªán</h1>
            <p style="color: rgba(255,255,255,0.8); font-size: 1.1em;">L∆∞u tr·ªØ v√† qu·∫£n l√Ω truy·ªán c·ªßa b·∫°n tr√™n Google Drive</p>
        </div>

        <div class="auth-section">
            <div id="auth-content">
                <h2 style="margin-bottom: 20px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
                <button id="auth-btn" class="btn">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    ·ª®ng d·ª•ng c·∫ßn quy·ªÅn truy c·∫≠p Google Drive ƒë·ªÉ l∆∞u tr·ªØ truy·ªán c·ªßa b·∫°n
                </p>
            </div>
        </div>

        <div class="main-content" id="main-content">
            <div class="story-form">
                <h2 style="margin-bottom: 25px; color: #333;">‚úçÔ∏è Th√™m truy·ªán m·ªõi</h2>
                <form id="story-form">
                    <div class="form-group">
                        <label for="story-name">T√™n truy·ªán:</label>
                        <input type="text" id="story-name" required placeholder="Nh·∫≠p t√™n truy·ªán...">
                    </div>
                    <div class="form-group">
                        <label for="chapter-title">Ti√™u ƒë·ªÅ ch∆∞∆°ng:</label>
                        <input type="text" id="chapter-title" required placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1 - B·∫Øt ƒë·∫ßu">
                    </div>
                    <div class="form-group">
                        <label for="chapter-content">N·ªôi dung ch∆∞∆°ng:</label>
                        <textarea id="chapter-content" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                    </div>
                    <button type="submit" class="btn" id="save-btn">üíæ L∆∞u truy·ªán</button>
                </form>
                <div id="message-area"></div>
            </div>

            <div class="story-list">
                <h2 style="margin-bottom: 25px; color: #333;">üìñ L·ªãch s·ª≠ truy·ªán</h2>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i danh s√°ch truy·ªán...</p>
                </div>
                <div id="story-list-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapi, tokenClient;
        let isSignedIn = false;
        let mainFolderId = null;

        // Kh·ªüi t·∫°o Google API
        async function initializeGapi() {
            try {
                console.log('Initializing GAPI...');
                
                // Load gapi client
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                console.log('GAPI client loaded');
                
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC]
                });

                console.log('GAPI client initialized');

                // Initialize OAuth2 token client
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                    error_callback: (error) => {
                        console.error('OAuth error:', error);
                        showMessage('L·ªói x√°c th·ª±c OAuth: ' + error.type, 'error');
                    }
                });

                console.log('OAuth2 token client initialized');
                console.log('Google API initialized successfully');
                
                // Update UI
                document.getElementById('auth-content').innerHTML = `
                    <h2 style="margin-bottom: 20px;">‚úÖ K·∫øt n·ªëi th√†nh c√¥ng</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        Google API ƒë√£ s·∫µn s√†ng. Click ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Google c·ªßa b·∫°n.
                    </p>
                    <button id="auth-btn" class="btn">üîê ƒêƒÉng nh·∫≠p v·ªõi Google</button>
                    <p style="margin-top: 15px; color: #666; font-size: 14px;">
                        ·ª®ng d·ª•ng c·∫ßn quy·ªÅn truy c·∫≠p Google Drive ƒë·ªÉ l∆∞u tr·ªØ truy·ªán c·ªßa b·∫°n
                    </p>
                `;
                
                setupAuthButton();
                
            } catch (error) {
                console.error('Error initializing Google API:', error);
                document.getElementById('auth-content').innerHTML = `
                    <h2 style="color: #d32f2f; margin-bottom: 20px;">‚ùå L·ªói kh·ªüi t·∫°o API</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Chi ti·∫øt l·ªói: ${error.message || error}
                    </p>
                    <button class="btn" onclick="window.location.reload()">üîÑ Th·ª≠ l·∫°i</button>
                `;
                throw error;
            }
        }

        function setupAuthButton() {
            const authBtn = document.getElementById('auth-btn');
            authBtn.onclick = () => {
                tokenClient.requestAccessToken();
            };
        }

        function handleAuthCallback(response) {
            if (response.error) {
                console.error('Auth error:', response);
                showMessage('L·ªói x√°c th·ª±c: ' + response.error, 'error');
                return;
            }

            isSignedIn = true;
            document.querySelector('.auth-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            initializeApp();
        }

        async function initializeApp() {
            try {
                await createMainFolder();
                await loadStories();
                setupForm();
            } catch (error) {
                console.error('Error initializing app:', error);
                showMessage('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: ' + error.message, 'error');
            }
        }

        async function createMainFolder() {
            try {
                // T√¨m th∆∞ m·ª•c ch√≠nh
                const response = await gapi.client.drive.files.list({
                    q: "name='Truy·ªán' and mimeType='application/vnd.google-apps.folder'",
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    mainFolderId = response.result.files[0].id;
                    console.log('Found existing main folder:', mainFolderId);
                } else {
                    // T·∫°o th∆∞ m·ª•c ch√≠nh m·ªõi
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'Truy·ªán',
                            mimeType: 'application/vnd.google-apps.folder'
                        }
                    });
                    mainFolderId = createResponse.result.id;
                    console.log('Created new main folder:', mainFolderId);
                }
            } catch (error) {
                console.error('Error creating main folder:', error);
                throw error;
            }
        }

        async function createStoryFolder(storyName) {
            try {
                // Ki·ªÉm tra xem th∆∞ m·ª•c truy·ªán ƒë√£ t·ªìn t·∫°i ch∆∞a
                const response = await gapi.client.drive.files.list({
                    q: `name='${storyName}' and parents='${mainFolderId}' and mimeType='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // T·∫°o th∆∞ m·ª•c truy·ªán m·ªõi
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: storyName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [mainFolderId]
                    }
                });

                return createResponse.result.id;
            } catch (error) {
                console.error('Error creating story folder:', error);
                throw error;
            }
        }

        async function saveChapter(storyName, chapterTitle, chapterContent) {
            try {
                const storyFolderId = await createStoryFolder(storyName);
                
                // T·∫°o file ch∆∞∆°ng
                const fileMetadata = {
                    name: `${chapterTitle}.txt`,
                    parents: [storyFolderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([chapterContent], {type: 'text/plain'}));

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('Failed to upload chapter');
                }

                return await response.json();
            } catch (error) {
                console.error('Error saving chapter:', error);
                throw error;
            }
        }

        async function loadStories() {
            const loadingEl = document.getElementById('loading');
            const storyListEl = document.getElementById('story-list-content');
            
            try {
                loadingEl.style.display = 'block';
                storyListEl.innerHTML = '';

                // L·∫•y danh s√°ch th∆∞ m·ª•c truy·ªán
                const response = await gapi.client.drive.files.list({
                    q: `parents='${mainFolderId}' and mimeType='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name, createdTime)',
                    orderBy: 'createdTime desc'
                });

                const stories = response.result.files;

                if (stories.length === 0) {
                    storyListEl.innerHTML = '<p style="text-align: center; color: #666;">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                } else {
                    for (const story of stories) {
                        await renderStoryItem(story, storyListEl);
                    }
                }
            } catch (error) {
                console.error('Error loading stories:', error);
                storyListEl.innerHTML = '<p style="text-align: center; color: #d32f2f;">L·ªói t·∫£i danh s√°ch truy·ªán.</p>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        async function renderStoryItem(story, container) {
            try {
                // L·∫•y danh s√°ch ch∆∞∆°ng
                const chaptersResponse = await gapi.client.drive.files.list({
                    q: `parents='${story.id}' and mimeType!='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name, createdTime)',
                    orderBy: 'createdTime asc'
                });

                const chapters = chaptersResponse.result.files;
                
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story-item';
                storyDiv.innerHTML = `
                    <div class="story-title">${story.name}</div>
                    <div class="story-chapters">${chapters.length} ch∆∞∆°ng</div>
                    <button class="toggle-chapters" onclick="toggleChapters('${story.id}')">
                        Xem ch∆∞∆°ng
                    </button>
                    <div class="chapter-list" id="chapters-${story.id}">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>ƒêang t·∫£i ch∆∞∆°ng...</p>
                        </div>
                    </div>
                `;

                container.appendChild(storyDiv);

                // L∆∞u tr·ªØ th√¥ng tin ch∆∞∆°ng ƒë·ªÉ s·ª≠ d·ª•ng sau
                storyDiv.dataset.chapters = JSON.stringify(chapters);
            } catch (error) {
                console.error('Error rendering story item:', error);
            }
        }

        async function toggleChapters(storyId) {
            const chaptersDiv = document.getElementById(`chapters-${storyId}`);
            
            if (chaptersDiv.style.display === 'block') {
                chaptersDiv.style.display = 'none';
                return;
            }

            chaptersDiv.style.display = 'block';
            
            // N·∫øu ƒë√£ t·∫£i r·ªìi th√¨ kh√¥ng t·∫£i l·∫°i
            if (chaptersDiv.querySelector('.chapter-item')) {
                return;
            }

            try {
                const storyDiv = chaptersDiv.closest('.story-item');
                const chapters = JSON.parse(storyDiv.dataset.chapters);
                
                chaptersDiv.innerHTML = '';
                
                for (const chapter of chapters) {
                    const content = await getFileContent(chapter.id);
                    const chapterDiv = document.createElement('div');
                    chapterDiv.className = 'chapter-item';
                    chapterDiv.innerHTML = `
                        <div class="chapter-title">${chapter.name.replace('.txt', '')}</div>
                        <div class="chapter-content">${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</div>
                    `;
                    chaptersDiv.appendChild(chapterDiv);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                chaptersDiv.innerHTML = '<p style="color: #d32f2f;">L·ªói t·∫£i ch∆∞∆°ng.</p>';
            }
        }

        async function getFileContent(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                console.error('Error getting file content:', error);
                return 'Kh√¥ng th·ªÉ t·∫£i n·ªôi dung';
            }
        }

        function setupForm() {
            const form = document.getElementById('story-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';
                saveBtn.disabled = true;

                try {
                    const storyName = document.getElementById('story-name').value.trim();
                    const chapterTitle = document.getElementById('chapter-title').value.trim();
                    const chapterContent = document.getElementById('chapter-content').value.trim();

                    if (!storyName || !chapterTitle || !chapterContent) {
                        throw new Error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                    }

                    await saveChapter(storyName, chapterTitle, chapterContent);
                    
                    showMessage('‚úÖ L∆∞u truy·ªán th√†nh c√¥ng!', 'success');
                    
                    // Reset form
                    document.getElementById('chapter-title').value = '';
                    document.getElementById('chapter-content').value = '';
                    
                    // T·∫£i l·∫°i danh s√°ch truy·ªán
                    await loadStories();
                    
                } catch (error) {
                    console.error('Error saving story:', error);
                    showMessage('‚ùå L·ªói l∆∞u truy·ªán: ' + error.message, 'error');
                } finally {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            });
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', async () => {
            console.log('Page loaded, initializing...');
            
            // ƒê·ª£i Google API script t·∫£i xong
            let attempts = 0;
            const maxAttempts = 20;
            
            const waitForGapi = () => {
                return new Promise((resolve, reject) => {
                    const checkGapi = () => {
                        attempts++;
                        console.log(`Checking for gapi... attempt ${attempts}`);
                        
                        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                            console.log('Google APIs loaded successfully');
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Google API failed to load after multiple attempts'));
                        } else {
                            setTimeout(checkGapi, 500);
                        }
                    };
                    checkGapi();
                });
            };
            
            try {
                await waitForGapi();
                await initializeGapi();
            } catch (error) {
                console.error('Error loading Google API:', error);
                document.getElementById('auth-content').innerHTML = `
                    <h2 style="color: #d32f2f; margin-bottom: 20px;">‚ùå L·ªói t·∫£i Google API</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Google API. Vui l√≤ng th·ª≠:
                    </p>
                    <ul style="text-align: left; color: #666; margin-bottom: 20px;">
                        <li>Ki·ªÉm tra k·∫øt n·ªëi internet</li>
                        <li>T·∫Øt tr√¨nh ch·∫∑n qu·∫£ng c√°o (AdBlock)</li>
                        <li>T·∫£i l·∫°i trang</li>
                        <li>Th·ª≠ tr√¨nh duy·ªát kh√°c</li>
                    </ul>
                    <button class="btn" onclick="window.location.reload()">üîÑ T·∫£i l·∫°i trang</button>
                `;
            }
        });
    </script>
</body>
</html>
