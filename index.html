<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
            display: block;
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
            display: block;
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        .nav-menu button.active {
            background: linear-gradient(45deg, #ff9500, #ff7300);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal.show {
            display: block;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .training-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .training-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .training-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .training-item .count {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
            .training-details { grid-template-columns: 1fr; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager Pro</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chủ đề chuyên biệt nâng cấp</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active" data-section="trainingSection">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success" data-section="generationSection">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn" data-section="managementSection">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn" data-section="historySection">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI Nâng Cao</h2>
                        <div class="training-details">
                            <div class="training-item">
                                <h4>📝 Tổng số file</h4>
                                <div class="count" id="totalFiles">0</div>
                            </div>
                            <div class="training-item">
                                <h4>✅ Đã huấn luyện</h4>
                                <div class="count" id="trainedFiles">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📖 Từ vựng học được</h4>
                                <div class="count" id="vocabularyCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>💬 Hội thoại</h4>
                                <div class="count" id="dialogueCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🏠 Bối cảnh</h4>
                                <div class="count" id="contextCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>👤 Chi tiết nhân vật</h4>
                                <div class="count" id="characterCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>❤️ Cảm xúc</h4>
                                <div class="count" id="emotionCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🔥 Nội dung 18+</h4>
                                <div class="count" id="adultCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>⏰ Thời gian</h4>
                                <div class="count" id="timeCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📍 Địa điểm</h4>
                                <div class="count" id="locationCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📜 Cấu trúc câu</h4>
                                <div class="count" id="sentenceCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🎭 Tình tiết</h4>
                                <div class="count" id="plotCount">0</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động</h2>
                        
                        <div class="adult-warning">
                            ⚠️ Cảnh báo: AI sẽ tạo nội dung theo ngôi thứ nhất và có thể chứa nội dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (50-200)" min="50" max="200" value="50">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">Nội dung:</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
                <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
                <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
                <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    dialogues: new Set(),
    contexts: new Set(),
    characterDetails: new Set(),
    emotions: new Set(),
    adultContent: new Set(),
    timeReferences: new Set(),
    locations: new Set(),
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    characterNames: new Set(),
    environmentDetails: new Set(),
    transitionWords: new Set(),
    generationHistory: []
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// Initialize Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; 
        maybeEnableButtons();
    });
}

function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, 
        scope: SCOPES, 
        callback: ''
    });
    gis_inited = true; 
    maybeEnableButtons();
}

function maybeEnableButtons() { 
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'inline-block'; 
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { 
            showStatus('Lỗi đăng nhập: ' + resp.error, 'error'); 
            return; 
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '✅ Đã đăng nhập thành công!';
        await initializeApp();
    };
    
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { 
        google.accounts.oauth2.revoke(token.access_token); 
        gapi.client.setToken(''); 
    }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}

async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    await loadAiKnowledge();
    updateAiStats();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Khởi tạo ứng dụng thành công!', 'success');
    showLoading(false);
}

async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length > 0) {
            mainFolderId = response.result.files[0].id;
        } else {
            const folder = await gapi.client.drive.files.create({ 
                resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, 
                fields: 'id' 
            });
            mainFolderId = folder.result.id;
        }
    } catch (error) {
        console.error('Error creating main folder:', error);
        showStatus('Lỗi tạo thư mục chính!', 'error');
    }
}

async function createStoryFolder(storyTitle) {
    try {
        const folder = await gapi.client.drive.files.create({
            resource: { 
                name: storyTitle, 
                mimeType: 'application/vnd.google-apps.folder', 
                parents: [mainFolderId] 
            }, 
            fields: 'id'
        });
        return folder.result.id;
    } catch (error) {
        console.error('Error creating story folder:', error);
        throw error;
    }
}

async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId) {
    const fileMetadata = { 
        name: `${chapterTitle}.txt`, 
        parents: [storyFolderId]
    };
    
    try {
        await gapi.client.request({
            path: 'https://www.googleapis.com/upload/drive/v3/files', 
            method: 'POST',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
            body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                  JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
                  content + '\r\n--foo_bar_baz--'
        });
    } catch (error) {
        console.error('Error saving story content:', error);
        throw error;
    }
}

async function loadStoryHistory() {
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime)', 
            orderBy: 'createdTime desc'
        });
        
        const folders = response.result.files; 
        storyHistory = [];
        
        for (let folder of folders) {
            const filesResponse = await gapi.client.drive.files.list({
                q: `'${folder.id}' in parents and trashed=false`,
                fields: 'files(id, name, createdTime)'
            });
            storyHistory.push({ 
                storyTitle: folder.name, 
                folderId: folder.id, 
                createdTime: folder.createdTime, 
                chapters: filesResponse.result.files
            });
        }
        
        displayHistory(); 
        displayFolders();
        updateExistingStoryDropdown();
    } catch (error) {
        console.error('Error loading story history:', error);
        showStatus('Lỗi tải lịch sử truyện!', 'error');
    }
}

// Utility functions
function showLoading(show) {
    const loading = document.getElementById('loading');
    if (show) {
        loading.classList.add('show');
    } else {
        loading.classList.remove('show');
    }
}

function showStatus(message, type = 'success') {
    const status = document.getElementById('status');
    status.textContent = message;
    status.className = `status ${type}`;
    
    setTimeout(() => {
        status.style.display = 'none';
    }, 5000);
}

function displayHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    historyList.innerHTML = '';
    
    storyHistory.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">${story.chapters.length} chương</div>
            <div class="story-date">${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
        `;
        
        item.onclick = () => viewChapters(story);
        historyList.appendChild(item);
    });
}

function displayFolders() {
    const folderList = document.getElementById('folderList');
    if (!folderList) return;
    
    folderList.innerHTML = '';
    
    storyHistory.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="story-title">📁 ${story.storyTitle}</div>
            <div class="story-chapter">ID: ${story.folderId}</div>
            <div class="story-date">Tạo: ${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
        `;
        
        folderList.appendChild(item);
    });
}

function updateExistingStoryDropdown() {
    const existingStorySelect = document.getElementById('existingStory');
    if (!existingStorySelect) return;
    
    existingStorySelect.innerHTML = '<option value="">-- Chọn truyện --</option>';
    
    storyHistory.forEach(story => {
        const option = document.createElement('option');
        option.value = story.folderId;
        option.textContent = story.storyTitle;
        existingStorySelect.appendChild(option);
    });
}

// AI Training Functions
async function trainAI() {
    showLoading(true);
    showStatus('Đang bắt đầu huấn luyện AI với phân tích chuyên sâu...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            await advancedContentAnalysis(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    await saveAiKnowledge();
    showLoading(false);
    showStatus(`Huấn luyện hoàn thành! Đã phân tích ${processedFiles} file với AI học sâu.`, 'success');
}

async function advancedContentAnalysis(content, storyTitle, fileName) {
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 5);
    const words = content.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    
    // 1. Học từ vựng cơ bản
    words.forEach(word => {
        const cleanWord = word.replace(/[^\wàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/g, '');
        if (cleanWord.length > 2) {
            aiKnowledge.vocabulary.add(cleanWord);
        }
    });
    
    // 2. Phân tích và học hội thoại
    analyzeDialogues(content);
    
    // 3. Phân tích bối cảnh và địa điểm
    analyzeContextsAndLocations(content);
    
    // 4. Phân tích chi tiết nhân vật
    analyzeCharacterDetails(content);
    
    // 5. Phân tích cảm xúc
    analyzeEmotions(content);
    
    // 6. Phân tích nội dung 18+
    analyzeAdultContent(content);
    
    // 7. Phân tích thời gian
    analyzeTimeReferences(content);
    
    // 8. Học cấu trúc câu
    sentences.forEach(sentence => {
        if (sentence.split(' ').length > 10) {
            aiKnowledge.sentenceStructures.add(sentence.trim());
        }
    });
    
    // 9. Phân tích tình tiết
    analyzePlotPoints(content);
    
    // 10. Lưu story để học
    aiKnowledge.stories.push({
        content: content,
        storyTitle: storyTitle,
        fileName: fileName,
        analysisTimestamp: new Date().toISOString()
    });
}

function analyzeDialogues(content) {
    const dialoguePatterns = [
        /"([^"]{10,})"/g,
        /"([^"]{10,})"/g,
        /- ([A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ][^.!?]{10,}[.!?])/g
    ];
    
    dialoguePatterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(content)) !== null) {
            const dialogue = match[1].trim();
            if (dialogue.length > 10 && !dialogue.includes('{')) {
                aiKnowledge.dialogues.add(dialogue);
            }
        }
    });
}

function analyzeContextsAndLocations(content) {
    const contextKeywords = [
        'trong phòng', 'ở nhà', 'tại', 'khi', 'lúc', 'vào lúc', 'buổi', 'ngày', 'đêm',
        'phòng khách', 'phòng ngủ', 'nhà bếp', 'phòng tắm', 'ban công', 'sân vườn',
        'trên giường', 'dưới bàn', 'bên cạnh', 'gần', 'xa', 'trước', 'sau'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        contextKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const context = sentence.trim();
                if (context.length > 20 && context.length < 200) {
                    aiKnowledge.contexts.add(context);
                }
            }
        });
        
        const locationMatch = sentence.match(/(trong|ở|tại|đến|về) ([^,.\s]{2,})/gi);
        if (locationMatch) {
            locationMatch.forEach(loc => {
                aiKnowledge.locations.add(loc.trim());
            });
        }
    });
}

function analyzeCharacterDetails(content) {
    const characterKeywords = [
        'mắt', 'tóc', 'da', 'mặt', 'dáng', 'cao', 'thấp', 'gầy', 'béo', 'đẹp', 'xấu',
        'cô ấy', 'anh ấy', 'chị', 'em', 'bác', 'chú', 'cô', 'người', 'con',
        'bố chồng', 'con dâu', 'vợ tôi', 'chồng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        characterKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const detail = sentence.trim();
                if (detail.length > 15 && detail.length < 150) {
                    aiKnowledge.characterDetails.add(detail);
                }
            }
        });
        
        const nameMatch = sentence.match(/\b[A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ][a-zàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]{2,}\b/g);
        if (nameMatch) {
            nameMatch.forEach(name => {
                if (!['Tôi', 'Anh', 'Chị', 'Em', 'Bác', 'Chú', 'Cô'].includes(name)) {
                    aiKnowledge.characterNames.add(name);
                }
            });
        }
    });
}

function analyzeEmotions(content) {
    const emotionKeywords = [
        'cảm thấy', 'cảm giác', 'cảm xúc', 'tâm trí', 'tâm lý', 'lòng',
        'vui', 'buồn', 'giận', 'lo', 'sợ', 'hạnh phúc', 'đau khổ', 'thất vọng',
        'yêu', 'thích', 'ghét', 'căng thẳng', 'bối rối', 'xấu hổ', 'tội lỗi',
        'khao khát', 'thèm muốn', 'ham muốn', 'kích thích', 'dục vọng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        emotionKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const emotion = sentence.trim();
                if (emotion.length > 10 && emotion.length < 200) {
                    aiKnowledge.emotions.add(emotion);
                }
            }
        });
    });
}

function analyzeAdultContent(content) {
    const adultKeywords = [
        'cơ thể', 'thân thể', 'da thịt', 'vòng', 'ngực', 'mông', 'đùi',
        'ôm', 'hôn', 'vuốt', 'chạm', 'sờ', 'nắm',
        'khao khát', 'thèm muốn', 'ham muốn', 'dục vọng', 'kích thích',
        'nóng bỏng', 'ướt át', 'căng cứng', 'mềm mại', 'quyến rũ',
        'làm tình', 'quan hệ', 'yêu đương', 'ân ái'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        adultKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const adultSentence = sentence.trim();
                if (adultSentence.length > 15 && adultSentence.length < 250) {
                    aiKnowledge.adultContent.add(adultSentence);
                }
            }
        });
    });
}

function analyzeTimeReferences(content) {
    const timeKeywords = [
        'hôm nay', 'hôm qua', 'mai', 'ngày', 'tuần', 'tháng', 'năm',
        'sáng', 'trưa', 'chiều', 'tối', 'đêm', 'khuya',
        'khi', 'lúc', 'sau khi', 'trước khi', 'trong khi',
        'bỗng nhiên', 'đột ngột', 'từ từ', 'nhanh chóng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        timeKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const timeRef = sentence.trim();
                if (timeRef.length > 10 && timeRef.length < 150) {
                    aiKnowledge.timeReferences.add(timeRef);
                }
            }
        });
    });
}

function analyzePlotPoints(content) {
    const plotKeywords = [
        'bỗng nhiên', 'đột ngột', 'sau đó', 'cuối cùng', 'kết quả',
        'phát hiện', 'nhận ra', 'hiểu ra', 'chợt', 'bất ngờ',
        'quyết định', 'dự định', 'kế hoạch', 'ý định'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        plotKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const plot = sentence.trim();
                if (plot.length > 15 && plot.length < 200) {
                    aiKnowledge.plotPoints.add(plot);
                }
            }
        });
    });
}

function updateAiStats() {
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('dialogueCount').textContent = aiKnowledge.dialogues.size;
    document.getElementById('contextCount').textContent = aiKnowledge.contexts.size;
    document.getElementById('characterCount').textContent = aiKnowledge.characterDetails.size;
    document.getElementById('emotionCount').textContent = aiKnowledge.emotions.size;
    document.getElementById('adultCount').textContent = aiKnowledge.adultContent.size;
    document.getElementById('timeCount').textContent = aiKnowledge.timeReferences.size;
    document.getElementById('locationCount').textContent = aiKnowledge.locations.size;
    document.getElementById('sentenceCount').textContent = aiKnowledge.sentenceStructures.size;
    document.getElementById('plotCount').textContent = aiKnowledge.plotPoints.size;
    document.getElementById('trainedFiles').textContent = aiKnowledge.trainedFiles;
}

async function saveAiKnowledge() {
    const knowledgeData = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        stories: aiKnowledge.stories,
        trainedFiles: aiKnowledge.trainedFiles,
        dialogues: Array.from(aiKnowledge.dialogues),
        contexts: Array.from(aiKnowledge.contexts),
        characterDetails: Array.from(aiKnowledge.characterDetails),
        emotions: Array.from(aiKnowledge.emotions),
        adultContent: Array.from(aiKnowledge.adultContent),
        timeReferences: Array.from(aiKnowledge.timeReferences),
        locations: Array.from(aiKnowledge.locations),
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        plotPoints: Array.from(aiKnowledge.plotPoints),
        characterNames: Array.from(aiKnowledge.characterNames),
        environmentDetails: Array.from(aiKnowledge.environmentDetails),
        transitionWords: Array.from(aiKnowledge.transitionWords),
        generationHistory: aiKnowledge.generationHistory,
        lastUpdated: new Date().toISOString()
    };
    
    const knowledgeStr = JSON.stringify(knowledgeData);
    const fileName = 'ai_knowledge_advanced_v2.json';
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            await gapi.client.request({
                path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: knowledgeStr
            });
        } else {
            const fileMetadata = { 
                name: fileName, 
                parents: [mainFolderId] 
            };
            
            await gapi.client.request({
                path: 'https://www.googleapis.com/upload/drive/v3/files', 
                method: 'POST',
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
                body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                      JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n' +
                      knowledgeStr + '\r\n--foo_bar_baz--'
            });
        }
    } catch (error) {
        console.error('Error saving AI knowledge:', error);
    }
}

async function loadAiKnowledge() {
    const fileName = 'ai_knowledge_advanced_v2.json';
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            const knowledge = JSON.parse(fileResponse.body);
            
            aiKnowledge.vocabulary = new Set(knowledge.vocabulary || []);
            aiKnowledge.stories = knowledge.stories || [];
            aiKnowledge.trainedFiles = knowledge.trainedFiles || 0;
            aiKnowledge.dialogues = new Set(knowledge.dialogues || []);
            aiKnowledge.contexts = new Set(knowledge.contexts || []);
            aiKnowledge.characterDetails = new Set(knowledge.characterDetails || []);
            aiKnowledge.emotions = new Set(knowledge.emotions || []);
            aiKnowledge.adultContent = new Set(knowledge.adultContent || []);
            aiKnowledge.timeReferences = new Set(knowledge.timeReferences || []);
            aiKnowledge.locations = new Set(knowledge.locations || []);
            aiKnowledge.sentenceStructures = new Set(knowledge.sentenceStructures || []);
            aiKnowledge.plotPoints = new Set(knowledge.plotPoints || []);
            aiKnowledge.characterNames = new Set(knowledge.characterNames || []);
            aiKnowledge.environmentDetails = new Set(knowledge.environmentDetails || []);
            aiKnowledge.transitionWords = new Set(knowledge.transitionWords || []);
            aiKnowledge.generationHistory = knowledge.generationHistory || [];
        }
    } catch (error) {
        console.error('Error loading AI knowledge:', error);
    }
}

// Story Generation Functions
async function generateStory() {
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 50;
    if (chapterCount < 50 || chapterCount > 200) {
        showStatus('Số chương phải từ 50 đến 200!', 'error');
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI chưa được huấn luyện đủ! Hãy huấn luyện AI với ít nhất 100 từ vựng.', 'error');
        return;
    }
    
    showLoading(true);
    showStatus('AI đang tạo truyện với logic nâng cao...', 'success');
    
    const storyContext = generateStoryContext();
    const title = generateIntelligentTitle();
    
    try {
        const storyFolderId = await createStoryFolder(title);
        
        let generatedChapters = 0;
        const totalChapters = chapterCount;
        
        for (let i = 1; i <= totalChapters; i++) {
            const chapterTitle = `Chương ${i}: ${generateChapterTitle(i, totalChapters, storyContext)}`;
            const chapterContent = generateAdvancedChapterContent(i, totalChapters, storyContext);
            
            await saveStoryContent(title, chapterTitle, chapterContent, storyFolderId);
            
            generatedChapters++;
            
            const progress = (generatedChapters / totalChapters) * 100;
            document.getElementById('generationProgressFill').style.width = progress + '%';
            document.getElementById('generationStatus').innerHTML = 
                `<div class="status success">Đang tạo chương ${generatedChapters}/${totalChapters}: ${chapterTitle}</div>`;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        await loadStoryHistory();
        await learnFromGeneratedContent(title, totalChapters);
        
        showLoading(false);
        showStatus(`Đã tạo thành công truyện "${title}" với ${totalChapters} chương!`, 'success');
        document.getElementById('generationStatus').innerHTML = '';
    } catch (error) {
        console.error('Error generating story:', error);
        showLoading(false);
        showStatus('Có lỗi xảy ra khi tạo truyện!', 'error');
    }
}

function generateStoryContext() {
    const mainCharacters = {
        protagonist: getRandomFromSet(aiKnowledge.characterNames) || 'Minh',
        spouse: getRandomFromSet(aiKnowledge.characterNames) || 'Linh', 
        parentInLaw: getRandomFromSet(aiKnowledge.characterNames) || 'Hùng'
    };
    
    const setting = {
        primaryLocation: getRandomFromSet(aiKnowledge.locations) || 'trong nhà',
        timeOfDay: getRandomFromSet(aiKnowledge.timeReferences) || 'buổi tối',
        atmosphere: ['riêng tư', 'bí mật', 'thân mật', 'căng thẳng'][Math.floor(Math.random() * 4)]
    };
    
    const emotionalArc = {
        beginning: 'tò mò và quan sát',
        middle: 'nhận thức và xung đột nội tâm', 
        climax: 'khám phá và chấp nhận',
        ending: 'thấu hiểu và bình yên'
    };
    
    return { mainCharacters, setting, emotionalArc };
}

function generateIntelligentTitle() {
    const titleTemplates = [
        "Những Điều Tôi Thầm Biết",
        "Bí Mật Trong Gia Đình", 
        "Góc Nhìn Của Người Chồng",
        "Quan Sát Trong Thầm Lặng",
        "Những Gì Tôi Không Nói Ra",
        "Ranh Giới Mờ Nhạt",
        "Câu Chuyện Chưa Kể",
        "Trong Sự Im Lặng",
        "Khám Phá Bản Thân",
        "Hành Trình Nội Tâm"
    ];
    
    return titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
}

function generateChapterTitle(chapterNum, totalChapters, context) {
    const progress = chapterNum / totalChapters;
    
    if (progress < 0.2) {
        const beginningTitles = ["Khởi đầu quan sát", "Những dấu hiệu đầu tiên", "Sự tò mò bắt đầu", "Cảm giác lạ lùng"];
        return beginningTitles[Math.floor(Math.random() * beginningTitles.length)];
    } else if (progress < 0.5) {
        const developmentTitles = ["Nhận ra điều bất thường", "Quan sát kỹ hơn", "Những phát hiện mới", "Sự thay đổi"];
        return developmentTitles[Math.floor(Math.random() * developmentTitles.length)];
    } else if (progress < 0.8) {
        const climaxTitles = ["Xung đột nội tâm", "Khám phá sự thật", "Không thể phủ nhận", "Đối mặt với thực tế"];
        return climaxTitles[Math.floor(Math.random() * climaxTitles.length)];
    } else {
        const endingTitles = ["Sự thấu hiểu", "Chấp nhận thực tế", "Kết luận cuối cùng", "Bình yên tìm lại"];
        return endingTitles[Math.floor(Math.random() * endingTitles.length)];
    }
}

function generateAdvancedChapterContent(chapterNum, totalChapters, context) {
    const progress = chapterNum / totalChapters;
    let content = "";
    
    let phase = 'beginning';
    if (progress > 0.25) phase = 'middle';
    if (progress > 0.65) phase = 'climax';
    if (progress > 0.85) phase = 'ending';
    
    content += generatePhaseIntroduction(phase, chapterNum, context) + "\n\n";
    
    const paragraphCount = 3 + Math.floor(Math.random() * 3);
    for (let i = 0; i < paragraphCount; i++) {
        content += generateIntelligentParagraph(phase, context, i, paragraphCount) + "\n\n";
    }
    
    content += generateChapterEnding(phase, context) + "\n";
    
    while (content.split(/\s+/).length < 2500) {
        const additionalContent = generateAdditionalSmartContent(phase, context);
        content += additionalContent + "\n\n";
    }
    
    const words = content.split(/\s+/);
    if (words.length > 4000) {
        content = words.slice(0, 4000).join(' ');
    }
    
    return content;
}

function generatePhaseIntroduction(phase, chapterNum, context) {
    const templates = {
        beginning: [
            `Hôm nay là ngày thứ ${chapterNum} kể từ khi tôi bắt đầu để ý đến những điều lạ lùng trong nhà.`,
            `Tôi không thể ngờ được rằng cuộc sống gia đình tôi lại có những bí mật như thế này.`,
            `Mọi thứ bắt đầu từ một cử chỉ nhỏ mà tôi tình cờ nhận ra.`
        ],
        middle: [
            `Càng quan sát, tôi càng thấy rõ hơn về mối quan hệ đặc biệt này.`,
            `Những nghi ngờ trong tôi ngày càng lớn dần theo thời gian.`,
            `Tôi bắt đầu hiểu tại sao mọi thứ trong nhà lại có những thay đổi tinh tế.`
        ],
        climax: [
            `Hôm nay, tôi không thể phủ nhận những gì đang diễn ra trước mắt mình.`,
            `Sự thật đã trở nên quá rõ ràng để tôi có thể bỏ qua.`,
            `Xung đột trong tâm trí tôi đạt đến điểm đỉnh.`
        ],
        ending: [
            `Cuối cùng, tôi cũng tìm được cách để hiểu và chấp nhận thực tế.`,
            `Nhìn lại chặng đường đã qua, tôi nhận ra nhiều điều về bản thân mình.`,
            `Giờ đây, tôi có thể nhìn nhận mọi thứ một cách bình tĩnh hơn.`
        ]
    };
    
    const phaseTemplates = templates[phase] || templates.beginning;
    return phaseTemplates[Math.floor(Math.random() * phaseTemplates.length)];
}

function generateIntelligentParagraph(phase, context, paragraphIndex, totalParagraphs) {
    let paragraph = "";
    const sentenceCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < sentenceCount; i++) {
        const sentenceType = determineSentenceType(phase, i, sentenceCount);
        paragraph += generateSmartSentence(sentenceType, context) + " ";
    }
    
    return paragraph.trim();
}

function determineSentenceType(phase, sentenceIndex, totalSentences) {
    const types = ['observation', 'innerThought', 'emotion', 'action'];
    
    if (phase === 'climax' && Math.random() < 0.3) {
        types.push('adult');
    }
    
    return types[Math.floor(Math.random() * types.length)];
}

function generateSmartSentence(type, context) {
    const templates = {
        observation: [
            `Tôi để ý thấy ${context.mainCharacters.spouse} có những cử chỉ đặc biệt.`,
            `Cách ${context.mainCharacters.spouse} nhìn tôi khiến tôi cảm thấy bối rối.`,
            `Không thể không chú ý đến sự thay đổi trong cách cư xử của ${context.mainCharacters.spouse}.`
        ],
        innerThought: [
            `Trong tâm trí tôi, những suy nghĩ phức tạp cứ lởn vởn.`,
            `Tôi tự hỏi liệu mình có đang suy nghĩ quá nhiều.`,
            `Cảm giác bồn chồn cứ ám ảnh tôi mỗi khi nghĩ về điều này.`
        ],
        emotion: [
            `Tim tôi đập nhanh hơn mỗi khi nghĩ về những gì đang diễn ra.`,
            `Cảm giác tội lỗi và tò mò cứ tranh đấu trong lòng tôi.`,
            `Tôi cảm thấy mình như đang đứng trước một bí ẩn lớn.`
        ],
        action: [
            `Tôi quyết định quan sát kỹ hơn để hiểu rõ tình hình.`,
            `Mỗi cử chỉ nhỏ của ${context.mainCharacters.spouse} đều không thoát khỏi sự chú ý của tôi.`,
            `Tôi cố gắng hành động bình thường để không ai phát hiện.`
        ],
        adult: [
            `Những suy nghĩ táo bạo bắt đầu len lỏi vào tâm trí tôi.`,
            `Cảm giác khao khát bí ẩn khiến tôi không thể ngừng suy nghĩ.`,
            `Tôi cảm nhận được sự căng thẳng trong không khí.`
        ]
    };
    
    const typeTemplates = templates[type] || templates.observation;
    return typeTemplates[Math.floor(Math.random() * typeTemplates.length)];
}

function generateAdditionalSmartContent(phase, context) {
    const contentTypes = ['reflection', 'observation', 'emotion'];
    const selectedType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
    return generateSmartSentence(selectedType, context);
}

function generateChapterEnding(phase, context) {
    const endings = {
        beginning: [
            "Tôi quyết định sẽ quan sát kỹ hơn trong những ngày tới.",
            "Có lẽ tôi cần thời gian để hiểu rõ hơn về tình hình này.",
            "Câu hỏi trong đầu tôi vẫn chưa có lời giải đáp."
        ],
        middle: [
            "Mọi thứ đang trở nên phức tạp hơn tôi nghĩ.",
            "Tôi cảm thấy mình đang đứng trước một bí ẩn lớn.",
            "Những mảnh ghép bắt đầu khớp với nhau trong tâm trí tôi."
        ],
        climax: [
            "Giờ đây tôi không thể làm ngơ trước sự thật này nữa.",
            "Cuộc sống của tôi sẽ không bao giờ như trước.",
            "Tôi phải đối mặt với thực tế dù có đau đớn đến đâu."
        ],
        ending: [
            "Cuối cùng tôi cũng tìm được sự bình yên trong tâm hồn.",
            "Tôi học được rằng cuộc sống luôn phức tạp hơn những gì ta nghĩ.",
            "Giờ đây tôi có thể nhìn mọi thứ với con mắt khác."
        ]
    };
    
    const phaseEndings = endings[phase] || endings.beginning;
    return phaseEndings[Math.floor(Math.random() * phaseEndings.length)];
}

async function learnFromGeneratedContent(storyTitle, chapterCount) {
    try {
        const story = storyHistory.find(s => s.storyTitle === storyTitle);
        if (!story) return;
        
        for (let chapter of story.chapters) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: chapter.id,
                    alt: 'media'
                });
                
                const content = response.body;
                await advancedContentAnalysis(content, storyTitle, chapter.name);
                
            } catch (error) {
                console.error('Error reading generated chapter:', error);
            }
        }
        
        await saveAiKnowledge();
        updateAiStats();
        
        showStatus('AI đã học thêm từ truyện vừa tạo để cải thiện lần sau!', 'success');
        
    } catch (error) {
        console.error('Error learning from generated content:', error);
    }
}

function getRandomFromSet(set) {
    if (!set || set.size === 0) return null;
    const array = Array.from(set);
    return array[Math.floor(Math.random() * array.length)];
}

function resetAI() {
    if (confirm('Bạn có chắc chắn muốn reset toàn bộ kiến thức của AI?')) {
        aiKnowledge = { 
            vocabulary: new Set(), 
            stories: [], 
            trainedFiles: 0,
            dialogues: new Set(),
            contexts: new Set(),
            characterDetails: new Set(),
            emotions: new Set(),
            adultContent: new Set(),
            timeReferences: new Set(),
            locations: new Set(),
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            characterNames: new Set(),
            environmentDetails: new Set(),
            transitionWords: new Set(),
            generationHistory: []
        };
        updateAiStats();
        saveAiKnowledge();
        showStatus('Đã reset kiến thức của AI!', 'success');
    }
}

// UI Navigation Functions
function switchSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Story Management Functions
function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    const newStoryGroup = document.getElementById('newStoryGroup');
    const existingStoryGroup = document.getElementById('existingStoryGroup');
    const submitButtonText = document.getElementById('submitButtonText');
    
    if (mode === 'new') {
        newStoryGroup.style.display = 'block';
        existingStoryGroup.style.display = 'none';
        submitButtonText.textContent = 'Lưu Truyện Mới';
    } else {
        newStoryGroup.style.display = 'none';
        existingStoryGroup.style.display = 'block';
        submitButtonText.textContent = 'Thêm Chương';
    }
}

async function handleStorySubmit(event) {
    event.preventDefault();
    
    const mode = document.getElementById('storyMode').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const storyContent = document.getElementById('storyContent').value;
    
    if (!chapterTitle || !storyContent) {
        showStatus('Vui lòng điền đầy đủ thông tin!', 'error');
        return;
    }
    
    showLoading(true);
    
    try {
        let storyFolderId;
        let storyTitle;
        
        if (mode === 'new') {
            storyTitle = document.getElementById('storyTitle').value;
            if (!storyTitle) {
                showStatus('Vui lòng nhập tên truyện!', 'error');
                showLoading(false);
                return;
            }
            storyFolderId = await createStoryFolder(storyTitle);
        } else {
            storyFolderId = document.getElementById('existingStory').value;
            if (!storyFolderId) {
                showStatus('Vui lòng chọn truyện!', 'error');
                showLoading(false);
                return;
            }
            const story = storyHistory.find(s => s.folderId === storyFolderId);
            storyTitle = story ? story.storyTitle : 'Unknown';
        }
        
        await saveStoryContent(storyTitle, chapterTitle, storyContent, storyFolderId);
        await loadStoryHistory();
        
        // Learn from new content
        await advancedContentAnalysis(storyContent, storyTitle, chapterTitle);
        await saveAiKnowledge();
        updateAiStats();
        
        // Reset form
        document.getElementById('storyForm').reset();
        
        showLoading(false);
        showStatus('Đã lưu thành công!', 'success');
        
    } catch (error) {
        console.error('Error saving story:', error);
        showLoading(false);
        showStatus('Có lỗi xảy ra khi lưu truyện!', 'error');
    }
}

// Modal Functions
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function viewChapters(story) {
    const modal = document.getElementById('chaptersModal');
    const title = document.getElementById('chaptersModalTitle');
    const chapterList = document.getElementById('chapterList');
    
    title.textContent = `Truyện: ${story.storyTitle}`;
    chapterList.innerHTML = '';
    
    story.chapters.forEach(chapter => {
        if (chapter.name.endsWith('.txt')) {
            const item = document.createElement('div');
            item.className = 'chapter-item';
            item.innerHTML = `
                <div class="story-title">${chapter.name.replace('.txt', '')}</div>
                <div class="story-date">Tạo: ${new Date(chapter.createdTime).toLocaleDateString('vi-VN')}</div>
            `;
            item.onclick = () => viewChapterContent(chapter, story.folderId);
            chapterList.appendChild(item);
        }
    });
    
    modal.classList.add('show');
}

async function viewChapterContent(chapter, folderId) {
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapter.id,
            alt: 'media'
        });
        
        const content = response.body;
        chapterContent.textContent = content;
        chapterContent.style.display = 'block';
        chapterActions.style.display = 'block';
        currentEditingChapter = { id: chapter.id, content: content, name: chapter.name };
        
        // AI learns from viewed chapter
        const storyTitle = storyHistory.find(s => s.folderId === folderId)?.storyTitle || 'Unknown';
        await advancedContentAnalysis(content, storyTitle, chapter.name);
        await saveAiKnowledge();
        updateAiStats();
        
    } catch (error) {
        console.error('Error loading chapter content:', error);
        showStatus('Có lỗi khi tải nội dung chương!', 'error');
    }
}

function editChapter() {
    if (!currentEditingChapter) return;
    
    const content = document.getElementById('chapterContent');
    const originalContent = content.textContent;
    
    content.innerHTML = `<textarea style="width: 100%; height: 400px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 15px;">${originalContent}</textarea>`;
}

async function saveChapterChanges() {
    if (!currentEditingChapter) return;
    
    const textarea = document.querySelector('#chapterContent textarea');
    if (!textarea) return;
    
    const newContent = textarea.value;
    
    try {
        showLoading(true);
        
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: newContent
        });
        
        document.getElementById('chapterContent').textContent = newContent;
        currentEditingChapter.content = newContent;
        
        showLoading(false);
        showStatus('Đã lưu thay đổi thành công!', 'success');
        
    } catch (error) {
        console.error('Error saving chapter changes:', error);
        showLoading(false);
        showStatus('Có lỗi khi lưu thay đổi!', 'error');
    }
}

function cancelEdit() {
    if (!currentEditingChapter) return;
    
    const content = document.getElementById('chapterContent');
    content.textContent = currentEditingChapter.content;
}

async function deleteChapter() {
    if (!currentEditingChapter) return;
    
    if (!confirm('Bạn có chắc chắn muốn xóa chương này?')) return;
    
    try {
        showLoading(true);
        
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        await loadStoryHistory();
        closeModal('chaptersModal');
        
        showLoading(false);
        showStatus('Đã xóa chương thành công!', 'success');
        
    } catch (error) {
        console.error('Error deleting chapter:', error);
        showLoading(false);
        showStatus('Có lỗi khi xóa chương!', 'error');
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Google APIs
    initializeGapi();
    initializeGis();
    
    // Auth buttons
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    
    // Navigation buttons
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.onclick = function() {
            const sectionId = this.dataset.section;
            switchSection(sectionId);
        };
    });
    
    // AI Training buttons
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    
    // Story generation buttons
    document.getElementById('generateStoryButton').onclick = generateStory;
    
    // Story management
    document.getElementById('storyMode').onchange = toggleStoryMode;
    document.getElementById('storyForm').onsubmit = handleStorySubmit;
    
    // Modal close events
    document.querySelectorAll('.modal').forEach(modal => {
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.classList.remove('show');
            }
        };
    });
});

</script>
</body>
</html>
