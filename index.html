<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Chat Interface */
        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        .chat-message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 85%;
        }
        .chat-message.user {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.ai {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            margin-right: auto;
        }
        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
        }
        
        /* Safe area for iPhone */
        @supports (padding: max(0px)) {
            .container {
                padding-top: max(20px, env(safe-area-inset-top));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- AI Training Section -->
                <div class="ai-section">
                    <h2>üß† Hu·∫•n luy·ªán AI</h2>
                    <div class="ai-stats" id="aiStats">
                        <div class="stat-item">
                            <span>T·ªïng s·ªë file:</span>
                            <span id="totalFiles">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ƒê√£ hu·∫•n luy·ªán:</span>
                            <span id="trainedFiles">0</span>
                        </div>
                        <div class="stat-item">
                            <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                            <span id="vocabularyCount">0</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                    <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                </div>

                <!-- Chat with AI -->
                <div class="form-section">
                    <h2>üí¨ Tr√≤ chuy·ªán v·ªõi AI</h2>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message ai">Xin ch√†o! T√¥i ƒë√£ s·∫µn s√†ng tr√≤ chuy·ªán. H√£y hu·∫•n luy·ªán t√¥i v·ªõi c√°c file truy·ªán ƒë·ªÉ t√¥i c√≥ th·ªÉ h·ªó tr·ª£ b·∫°n t·ªët h∆°n!</div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                        <button id="sendChatButton" class="btn">üì§</button>
                    </div>
                </div>
                
                <!-- Story Management -->
                <div class="form-section">
                    <h2>‚úçÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                    <form id="storyForm">
                        <div class="form-group">
                            <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                            <select id="storyMode" onchange="toggleStoryMode()">
                                <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                            </select>
                        </div>
                        <div class="form-group" id="newStoryGroup">
                            <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                            <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                        </div>
                        <div class="form-group" id="existingStoryGroup" style="display: none;">
                            <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                            <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                        </div>
                        <div class="form-group">
                            <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                            <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                        </div>
                        <div class="form-group">
                            <label for="storyContent">N·ªôi dung:</label>
                            <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                        </div>
                        <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                    </form>
                </div>
                
                <div class="grid">
                    <div class="history-section">
                        <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                        <div class="history-list" id="historyList"></div>
                    </div>
                    <div class="history-section">
                        <div class="history-header"><h2>üìÅ Th∆∞ m·ª•c Google Drive</h2></div>
                        <div class="history-list" id="folderList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { vocabulary: new Set(), stories: [], trainedFiles: 0 };

// Initialize Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}

function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}

function maybeEnableButtons() { 
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'inline-block'; 
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { 
            showStatus('L·ªói ƒëƒÉng nh·∫≠p: ' + resp.error, 'error'); 
            return; 
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { 
        google.accounts.oauth2.revoke(token.access_token); 
        gapi.client.setToken(''); 
    }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}

async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    await loadAiKnowledge();
    updateAiStats();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Kh·ªüi t·∫°o ·ª©ng d·ª•ng th√†nh c√¥ng!', 'success');
    showLoading(false);
}

async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) {
        mainFolderId = response.result.files[0].id;
    } else {
        const folder = await gapi.client.drive.files.create({ 
            resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, 
            fields: 'id' 
        });
        mainFolderId = folder.result.id;
    }
}

async function createStoryFolder(storyTitle) {
    const folder = await gapi.client.drive.files.create({
        resource: { name: storyTitle, mimeType: 'application/vnd.google-apps.folder', parents: [mainFolderId] }, 
        fields: 'id'
    });
    return folder.result.id;
}

async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId) {
    const fileMetadata = { name: `${chapterTitle}.txt`, parents: [storyFolderId] };
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', 
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}

async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    const folders = response.result.files; 
    storyHistory = [];
    
    for (let folder of folders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime)'
        });
        storyHistory.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files 
        });
    }
    displayHistory(); 
    displayFolders();
}

// AI Training Functions
async function trainAI() {
    showLoading(true);
    showStatus('ƒêang b·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            processContent(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    saveAiKnowledge();
    showLoading(false);
    showStatus(`Hu·∫•n luy·ªán ho√†n th√†nh! ƒê√£ x·ª≠ l√Ω ${processedFiles} file.`, 'success');
}

function processContent(content, storyTitle, fileName) {
    // Simple text processing for AI learning
    const words = content.toLowerCase()
        .replace(/[^\w\s√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 2);
    
    words.forEach(word => aiKnowledge.vocabulary.add(word));
    
    // Store story context
    aiKnowledge.stories.push({
        title: storyTitle,
        chapter: fileName,
        content: content,
        wordCount: words.length
    });
}

function updateAiStats() {
    document.getElementById('totalFiles').textContent = getTotalFiles();
    document.getElementById('trainedFiles').textContent = aiKnowledge.trainedFiles;
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
}

function getTotalFiles() {
    let total = 0;
    storyHistory.forEach(story => {
        total += story.chapters.filter(chapter => chapter.name.endsWith('.txt')).length;
    });
    return total;
}

function resetAI() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô d·ªØ li·ªáu AI?')) {
        aiKnowledge = { vocabulary: new Set(), stories: [], trainedFiles: 0 };
        updateAiStats();
        document.getElementById('progressFill').style.width = '0%';
        clearChat();
        showStatus('ƒê√£ reset AI th√†nh c√¥ng!', 'success');
        saveAiKnowledge();
    }
}

// Chat Functions
function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    
    addChatMessage(message, 'user');
    input.value = '';
    
    // Simple AI response based on trained data
    setTimeout(() => {
        const response = generateAIResponse(message);
        addChatMessage(response, 'ai');
    }, 500);
}

function addChatMessage(message, sender) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function generateAIResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Check if AI has been trained
    if (aiKnowledge.vocabulary.size === 0) {
        return "T√¥i ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán. H√£y nh·∫•n 'B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI' ƒë·ªÉ t√¥i c√≥ th·ªÉ h·ªçc t·ª´ c√°c truy·ªán c·ªßa b·∫°n!";
    }
    
    // Simple keyword matching
    if (lowerMessage.includes('truy·ªán') || lowerMessage.includes('k·ªÉ')) {
        const randomStory = aiKnowledge.stories[Math.floor(Math.random() * aiKnowledge.stories.length)];
        if (randomStory) {
            return `T√¥i c√≥ th·ªÉ k·ªÉ v·ªÅ "${randomStory.title}". ƒê√¢y l√† m·ªôt truy·ªán hay v·ªõi ${randomStory.wordCount} t·ª´. B·∫°n mu·ªën nghe kh√¥ng?`;
        }
    }
    
    if (lowerMessage.includes('bao nhi√™u') && lowerMessage.includes('truy·ªán')) {
        return `T√¥i ƒë√£ h·ªçc ƒë∆∞·ª£c ${aiKnowledge.stories.length} ch∆∞∆°ng truy·ªán t·ª´ ${storyHistory.length} b·ªô truy·ªán kh√°c nhau!`;
    }
    
    if (lowerMessage.includes('t·ª´ v·ª±ng') || lowerMessage.includes('t·ª´')) {
        return `T√¥i ƒë√£ h·ªçc ƒë∆∞·ª£c ${aiKnowledge.vocabulary.size} t·ª´ v·ª±ng t·ª´ c√°c truy·ªán. T·ª´ v·ª±ng n√†y gi√∫p t√¥i hi·ªÉu v√† tr√≤ chuy·ªán t·ªët h∆°n!`;
    }
    
    if (lowerMessage.includes('vi·∫øt') || lowerMessage.includes('s√°ng t√°c')) {
        const randomWords = Array.from(aiKnowledge.vocabulary).slice(0, 10).join(', ');
        return `T√¥i c√≥ th·ªÉ gi√∫p b·∫°n s√°ng t√°c! D·ª±a tr√™n nh·ªØng g√¨ t√¥i ƒë√£ h·ªçc, t√¥i bi·∫øt c√°c t·ª´ nh∆∞: ${randomWords}... B·∫°n mu·ªën vi·∫øt v·ªÅ ch·ªß ƒë·ªÅ g√¨?`;
    }
    
    if (lowerMessage.includes('ch√†o') || lowerMessage.includes('hello')) {
        return `Xin ch√†o! T√¥i ƒë√£ h·ªçc ƒë∆∞·ª£c t·ª´ ${aiKnowledge.trainedFiles} file truy·ªán. T√¥i c√≥ th·ªÉ tr√≤ chuy·ªán v·ªÅ truy·ªán, gi√∫p b·∫°n s√°ng t√°c, ho·∫∑c k·ªÉ v·ªÅ nh·ªØng g√¨ t√¥i ƒë√£ h·ªçc!`;
    }
    
    // Default response
    const responses = [
        "ƒêi·ªÅu ƒë√≥ r·∫•t th√∫ v·ªã! T·ª´ nh·ªØng truy·ªán t√¥i ƒë√£ h·ªçc, t√¥i nghƒ©...",
        "D·ª±a tr√™n ki·∫øn th·ª©c t·ª´ c√°c truy·ªán, t√¥i c√≥ th·ªÉ n√≥i r·∫±ng...",
        "T√¥i ƒë√£ h·ªçc ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÅu t·ª´ c√°c truy·ªán. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ truy·ªán, s√°ng t√°c, ho·∫∑c t·ª´ v·ª±ng!",
        "Hmm, c√≥ th·ªÉ b·∫°n mu·ªën n√≥i v·ªÅ truy·ªán? T√¥i r·∫•t th√≠ch tr√≤ chuy·ªán v·ªÅ ch·ªß ƒë·ªÅ n√†y!"
    ];
    return responses[Math.floor(Math.random() * responses.length)];
}

function clearChat() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '<div class="chat-message ai">Xin ch√†o! T√¥i ƒë√£ s·∫µn s√†ng tr√≤ chuy·ªán. H√£y hu·∫•n luy·ªán t√¥i v·ªõi c√°c file truy·ªán ƒë·ªÉ t√¥i c√≥ th·ªÉ h·ªó tr·ª£ b·∫°n t·ªët h∆°n!</div>';
}

// Save/Load AI Knowledge (using memory storage)
function saveAiKnowledge() {
    // Convert Set to Array for storage
    const knowledgeData = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        stories: aiKnowledge.stories,
        trainedFiles: aiKnowledge.trainedFiles
    };
    // In a real app, this would be saved to a persistent storage
    console.log('AI Knowledge saved:', knowledgeData);
}

function loadAiKnowledge() {
    // In a real app, this would load from persistent storage
    // For now, we'll start fresh each session
    aiKnowledge = { vocabulary: new Set(), stories: [], trainedFiles: 0 };
}

function displayHistory() {
    const historyList = document.getElementById('historyList'); 
    historyList.innerHTML = '';
    
    if (storyHistory.length === 0) { 
        historyList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ truy·ªán n√†o</div>'; 
        return; 
    }
    
    storyHistory.forEach(story => {
        const historyItem = document.createElement('div'); 
        historyItem.className = 'history-item';
        const chaptersText = story.chapters.map(ch => ch.name.replace('.txt', '')).join(', ');
        const date = new Date(story.createdTime).toLocaleString('vi-VN');
        historyItem.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">Ch∆∞∆°ng: ${chaptersText || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</div>
            <div class="story-date">${date}</div>
            <button class="btn" onclick="openStoryDetail('${story.folderId}')">üìñ Xem & Th√™m ch∆∞∆°ng</button>
        `;
        historyList.appendChild(historyItem);
    });
}

function openStoryDetail(folderId) {
    const story = storyHistory.find(s => s.folderId === folderId);
    if (!story) return;
    
    const detailHtml = `
        <div style="padding: 15px;">
            <h3 style="color: #ffffff; margin-bottom: 15px;">${story.storyTitle}</h3>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;"><b>C√°c ch∆∞∆°ng:</b> ${story.chapters.map(ch => ch.name.replace('.txt', '')).join(', ') || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</p>
            <form onsubmit="addChapter(event, '${story.folderId}', '${story.storyTitle}')">
                <div class="form-group">
                    <input type="text" id="newChapterTitle" placeholder="T√™n ch∆∞∆°ng m·ªõi" required style="margin-bottom: 10px;">
                </div>
                <div class="form-group">
                    <textarea id="newChapterContent" placeholder="N·ªôi dung ch∆∞∆°ng..." required style="min-height: 100px;"></textarea>
                </div>
                <button type="submit" class="btn success">‚ûï Th√™m ch∆∞∆°ng</button>
                <button type="button" class="btn" onclick="loadStoryHistory().then(displayHistory)">üîô Quay l·∫°i</button>
            </form>
        </div>
    `;
    document.getElementById('historyList').innerHTML = detailHtml;
}

async function addChapter(e, folderId, storyTitle) {
    e.preventDefault();
    const chapterTitle = document.getElementById('newChapterTitle').value.trim();
    const content = document.getElementById('newChapterContent').value.trim();
    
    if (!chapterTitle || !content) { 
        showStatus("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); 
        return; 
    }
    
    showLoading(true);
    try {
        await saveStoryContent(storyTitle, chapterTitle, content, folderId);
        await loadStoryHistory();
        showStatus(`ƒê√£ th√™m ch∆∞∆°ng "${chapterTitle}" v√†o truy·ªán "${storyTitle}" th√†nh c√¥ng!`, "success");
        displayHistory(); // Return to main view
    } catch (error) { 
        showStatus("L·ªói th√™m ch∆∞∆°ng: " + error.message, "error"); 
    }
    showLoading(false);
}

function displayFolders() {
    const folderList = document.getElementById('folderList'); 
    folderList.innerHTML = '';
    
    if (storyHistory.length === 0) { 
        folderList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ th∆∞ m·ª•c n√†o</div>'; 
        return; 
    }
    
    storyHistory.forEach(story => {
        const folderItem = document.createElement('div'); 
        folderItem.className = 'history-item';
        folderItem.innerHTML = `
            <div class="story-title">üìÅ ${story.storyTitle}</div>
            <div class="story-chapter">${story.chapters.length} file(s)</div>
            <div class="story-date">ID: ${story.folderId.substring(0, 20)}...</div>
        `;
        folderList.appendChild(folderItem);
    });
}

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    const newGroup = document.getElementById('newStoryGroup');
    const existingGroup = document.getElementById('existingStoryGroup');
    const submitText = document.getElementById('submitButtonText');
    const existingSelect = document.getElementById('existingStory');
    
    if (mode === 'existing') {
        newGroup.style.display = 'none';
        existingGroup.style.display = 'block';
        submitText.textContent = 'Th√™m Ch∆∞∆°ng M·ªõi';
        
        // Populate existing stories
        existingSelect.innerHTML = '<option value="">-- Ch·ªçn truy·ªán --</option>';
        storyHistory.forEach(story => {
            const option = document.createElement('option');
            option.value = story.storyTitle;
            option.textContent = story.storyTitle;
            existingSelect.appendChild(option);
        });
    } else {
        newGroup.style.display = 'block';
        existingGroup.style.display = 'none';
        submitText.textContent = 'L∆∞u Truy·ªán M·ªõi';
    }
}

// Event Listeners
document.getElementById('storyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = mode === 'new' ? 
        document.getElementById('storyTitle').value.trim() : 
        document.getElementById('existingStory').value;
    const chapterTitle = document.getElementById('chapterTitle').value.trim();
    const storyContent = document.getElementById('storyContent').value.trim();
    
    if (!storyTitle || !chapterTitle || !storyContent) { 
        showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error'); 
        return; 
    }
    
    showLoading(true);
    try {
        let storyFolderId = null;
        const existingStory = storyHistory.find(story => story.storyTitle === storyTitle);
        
        if (existingStory) {
            storyFolderId = existingStory.folderId;
        } else {
            storyFolderId = await createStoryFolder(storyTitle);
        }
        
        await saveStoryContent(storyTitle, chapterTitle, storyContent, storyFolderId);
        document.getElementById('storyForm').reset();
        toggleStoryMode(); // Reset form display
        await loadStoryHistory();
        showStatus(`ƒê√£ l∆∞u truy·ªán "${storyTitle}" - Ch∆∞∆°ng "${chapterTitle}" th√†nh c√¥ng!`, 'success');
    } catch (error) { 
        showStatus('L·ªói l∆∞u truy·ªán: ' + error.message, 'error'); 
    }
    showLoading(false);
});

// AI Training Event Listeners
document.getElementById('trainAiButton').addEventListener('click', trainAI);
document.getElementById('resetAiButton').addEventListener('click', resetAI);

// Chat Event Listeners
document.getElementById('sendChatButton').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Utility Functions
function showLoading(show) { 
    document.getElementById('loading').style.display = show ? 'block' : 'none'; 
}

function showStatus(message, type) {
    const status = document.getElementById('status');
    status.textContent = message; 
    status.className = `status ${type}`; 
    status.style.display = 'block';
    setTimeout(() => { 
        status.style.display = 'none'; 
    }, 5000);
}

// Auth Event Listeners
document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);

// Initialize app when page loads
window.addEventListener('load', function() { 
    if (CLIENT_ID && API_KEY) { 
        setTimeout(() => { 
            initializeGapi(); 
            initializeGis(); 
        }, 1000); 
    } 
});

// Prevent zoom on input focus (iOS)
document.addEventListener('touchstart', function() {}, true);
</script>
</body>
</html>
