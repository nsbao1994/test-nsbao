<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Th√™m style cho c·∫£nh b√°o n·ªôi dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* ·∫®n n·ªôi dung nh·∫°y c·∫£m m·∫∑c ƒë·ªãnh */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive - Ch·ªß ƒë·ªÅ chuy√™n bi·ªát</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úèÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>C·∫•u tr√∫c c√¢u:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>H·ªôi tho·∫°i:</span>
                                <span id="dialoguesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>B·ªëi c·∫£nh:</span>
                                <span id="contextsCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Nh√¢n v·∫≠t:</span>
                                <span id="charactersCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê·ªãa ƒëi·ªÉm:</span>
                                <span id="locationsCount">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông</h2>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫£nh b√°o: AI s·∫Ω t·∫°o n·ªôi dung theo ng√¥i th·ª© nh·∫•t v√† c√≥ th·ªÉ ch·ª©a n·ªôi dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                    <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                                <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                                <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">N·ªôi dung:</label>
                                <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                            </div>
                            <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üóÇ Th∆∞ m·ª•c Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>üìö Truy·ªán ƒê∆∞·ª£c T·∫°o B·ªüi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Ch∆∞∆°ng Truy·ªán</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
                <button class="btn danger" onclick="deleteChapter()">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
                <button class="btn" onclick="saveChapterChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" onclick="cancelEdit()">‚ùå H·ªßy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set(),
    transitionWords: new Set(),
    psychologicalTerms: new Set(),
    descriptivePatterns: new Set(),
    metaphors: new Set(),
    adultTerms: new Set(),
    characters: new Set(),
    locations: new Set(),
    timeFrames: new Set(),
    generationHistory: [],
    qualityMetrics: {
        complexityThreshold: 0.6,
        coherenceThreshold: 0.7,
        emotionThreshold: 0.65,
        targetWordCount: 3500
    }
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// T·ª´ v·ª±ng v√† c·∫•u tr√∫c chuy√™n bi·ªát - M·ªû R·ªòNG
const specializedVocabulary = {
    familyRelations: ['b·ªë ch·ªìng', 'con d√¢u', 'ch·ªìng', 'v·ª£', 'gia ƒë√¨nh', 'h·ªç h√†ng', 'm·ªëi quan h·ªá', 'ph√©p t·∫Øc', 'ranh gi·ªõi', 
                     'quy·ªÅn l·ª±c gia tr∆∞·ªüng', 'vai v·∫ø', 't√¥n ti tr·∫≠t t·ª±', 'n·ªÅ n·∫øp gia ƒë√¨nh', 'quan h·ªá huy·∫øt th·ªëng'],
    emotions: ['cƒÉng th·∫≥ng', 'b·ªëi r·ªëi', 'ghen t·ªã', 't√≤ m√≤', 'lo l·∫Øng', 'th√®m mu·ªën', 'khao kh√°t', 't·ªôi l·ªói', 'x·∫•u h·ªï', 
              'k√≠ch th√≠ch', 'd·ª•c v·ªçng', 'b·∫•t an', 'day d·ª©t', 'd·∫±n v·∫∑t', 'gi·∫±ng x√©', 'ng·ªù v·ª±c', '√°m ·∫£nh', 'kh·∫Øc kho·∫£i',
              'x√≥t xa', 'ƒëau ƒë·ªõn', 't√™ t√°i', 'ng·ªôt ng·∫°t', 'b·ª©c b·ªëi', 'r·ªëi b·ªùi', 'hoang mang'],
    observations: ['quan s√°t', 'nh√¨n tr·ªôm', 'theo d√µi', 'ch√∫ √Ω', 'ph√°t hi·ªán', 'ƒë·ªÉ √Ω', 'nh·∫≠n ra', 'th·∫•y ƒë∆∞·ª£c', 'c·∫£m nh·∫≠n', 
                  'nghe ƒë∆∞·ª£c', 'kh√°m ph√°', 'v√¥ t√¨nh ch·ª©ng ki·∫øn', 'b·∫Øt g·∫∑p', 'nh·∫≠n th·∫•y', 'th·∫•u hi·ªÉu', 'th·∫•u c·∫£m'],
    innerThoughts: ['t√¥i nghƒ©', 'trong t√¢m tr√≠ t√¥i', 't√¥i t·ª± h·ªèi', 'c√≥ l·∫Ω', 'li·ªáu r·∫±ng', 't√¥i kh√¥ng th·ªÉ tin ƒë∆∞·ª£c', 
                   't√¥i c·∫£m th·∫•y', 'ƒëi·ªÅu n√†y khi·∫øn t√¥i', 't√¥i nh·∫≠n ra', 't√¥i ch·ª£t hi·ªÉu', 't√¥i ng·ª° ng√†ng', 
                   't√¥i gi·∫≠t m√¨nh nh·∫≠n th·∫•y', 't√¥i b√†ng ho√†ng', 't√¥i s·ª≠ng s·ªët'],
    secretive: ['b√≠ m·∫≠t', 'gi·∫•u k√≠n', 'che gi·∫•u', 'l√©n l√∫t', 'th·∫ßm k√≠n', 'k√≠n ƒë√°o', '√¢m th·∫ßm', 'kh√¥ng ai bi·∫øt', 
               'ch·ªâ m√¨nh t√¥i', 'im l·∫∑ng', 'n√©n ch·∫∑t', 'gi·ªØ k√≠n trong l√≤ng', 'kh√¥ng d√°m th·ªï l·ªô'],
    physicalDescriptions: ['ƒë√¥i m·∫Øt', 'n·ª• c∆∞·ªùi', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'c√°ch di chuy·ªÉn', 'gi·ªçng n√≥i', 'c√°ch c∆∞·ªùi', 
                          'bi·ªÉu c·∫£m', 'd√°ng v·∫ª', 'b·ªù m√¥i', 'm√°i t√≥c', 'b√†n tay', 'v√≤ng eo', 'c·ª≠ ƒë·ªông', 'h∆°i th·ªü',
                          'nh·ªãp tim', 'l√†n da', 'n√©t m·∫∑t', 'c∆° th·ªÉ', 'v√≤ng m·ªôt', 'v√≤ng ba', 'v√≥c d√°ng', 'ƒë∆∞·ªùng cong'],
    situations: ['b·ªØa c∆°m gia ƒë√¨nh', 'khi v·ª£ ƒëi v·∫Øng', 'cu·ªëi tu·∫ßn', 'nh·ªØng bu·ªïi t·ªëi', 'l√∫c m·ªôt m√¨nh', 'khi kh√¥ng ai ch√∫ √Ω',
                'ƒë√™m khuya', 's√°ng s·ªõm', 'khi t·∫Øm r·ª≠a', 'l√∫c thay ƒë·ªì', 'khi u·ªëng r∆∞·ª£u', 'trong ph√≤ng ng·ªß', 
                'ngo√†i v∆∞·ªùn', 'trong b·∫øp', 'tr√™n gh·∫ø sofa', 'trong ph√≤ng t·∫Øm', 'khi say r∆∞·ª£u'],
    adultElements: ['ham mu·ªën', 'd·ª•c v·ªçng', 'kh√°t khao', 'b√≠ m·∫≠t c·∫•m k·ªã', 'ranh gi·ªõi m·ªù nh·∫°t', 'c√°m d·ªó', 's·ª± quy·∫øn r≈©', 
                   'kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i', 'kho√°i c·∫£m', 'say ƒë·∫Øm', 'm√™ ho·∫∑c', 'th√¢n th·ªÉ', 'g·ª£i c·∫£m', 'quy·∫øn r≈©',
                   'd·ª•c t√≠nh', 'k√≠ch ƒë·ªông', 'm∆°n tr·ªõn', 'vu·ªët ve', 'th√¢n m·∫≠t', 'g·∫ßn g≈©i', 's·ªù so·∫°ng', '√¥m ·∫•p',
                   'h√¥n', 'h√¥n n·ªìng ch√°y', '√¢n √°i', 'l√†m t√¨nh', 'quan h·ªá', 'y√™u ƒë∆∞∆°ng', '√¢m ƒë·∫°o', 'd∆∞∆°ng v·∫≠t',
                   'ng·ª±c', 'v√∫', 'nh≈© hoa', 'h√¥ng', 'm√¥ng', 'ƒë√πi', 'c·∫∑p ƒë√πi', 'b·ªô ph·∫≠n sinh d·ª•c', 'k√≠ch th√≠ch',
                   'kho√°i l·∫°c', 'c·ª±c kho√°i', 'l√™n ƒë·ªânh', 'thƒÉng hoa', 'sung s∆∞·ªõng', 'ƒëam m√™', 'n·ª©ng', 'c∆∞∆°ng',
                   '∆∞·ªõt √°t', '·∫©m ∆∞·ªõt', 'se kh√≠t', 'cƒÉng tr√≤n', 'n·ªü nang', 'quy·∫øn r≈©', 'g·ª£i t√¨nh', 'd√¢m d·ª•c'],
    psychologicalTerms: ['v√¥ th·ª©c', 'ti·ªÅm th·ª©c', 'b·∫£n nƒÉng', '·ª©c ch·∫ø', 'd·ªìn n√©n', 'ph√≤ng th·ªß', 'ph·ªß nh·∫≠n', 'chi·∫øu di·ªÖn',
                        'ƒë·ªìng nh·∫•t h√≥a', 'm·∫∑c c·∫£m', 'm√¢u thu·∫´n n·ªôi t√¢m', 'xung ƒë·ªôt t√¢m l√Ω', '√°mm ·∫£nh', 'd·∫±n v·∫∑t'],
    transitionWords: ['tuy nhi√™n', 'b√™n c·∫°nh ƒë√≥', 'ngo√†i ra', 'h∆°n n·ªØa', 'ƒë·∫∑c bi·ªát l√†', 'th√™m v√†o ƒë√≥', 'm·∫∑t kh√°c',
                     'ng∆∞·ª£c l·∫°i', 'th·ª±c t·∫ø th√¨', 'qu·∫£ th·∫≠t', 'ch·∫Øc ch·∫Øn', 'c√≥ l·∫Ω', 'd∆∞·ªùng nh∆∞', 'r√µ r√†ng l√†',
                     'cu·ªëi c√πng th√¨', 'k·∫øt qu·∫£ l√†', 'v√¨ v·∫≠y', 'do ƒë√≥', 'cho n√™n', 'ƒë·ªìng th·ªùi'],
    characterNames: ['An', 'B√¨nh', 'Chi', 'D≈©ng', 'H∆∞∆°ng', 'H·∫°nh', 'Hi·∫øu', 'Kh√°nh', 'Lan', 'Linh', 'Minh', 'My', 
                    'Nam', 'Nga', 'Ng·ªçc', 'Nh·∫≠t', 'Ph∆∞∆°ng', 'Qu√¢n', 'Qu·ª≥nh', 'S∆°n', 'Th·∫£o', 'Th·∫Øng', 'Trang', 'Trung', 'T√∫'],
    locations: ['ph√≤ng kh√°ch', 'ph√≤ng ng·ªß', 'nh√† b·∫øp', 'ph√≤ng t·∫Øm', 'ban c√¥ng', 's√¢n v∆∞·ªùn', 'c·∫ßu thang', 'hi√™n nh√†',
               'ph√≤ng l√†m vi·ªác', 'ph√≤ng ƒÉn', 'garage', 't·∫ßng h·∫ßm', 'm√°i nh√†', 'h√†nh lang', 'l·ªëi v√†o'],
    timeFrames: ['s√°ng s·ªõm', 'bu·ªïi tr∆∞a', 'chi·ªÅu t√†', 'ho√†ng h√¥n', 'ƒë√™m khuya', 'n·ª≠a ƒë√™m', 'r·∫°ng s√°ng', 
                'gi·ªØa tr∆∞a', 'x·∫ø chi·ªÅu', 'ch·∫≠p cho·∫°ng t·ªëi', 'ƒë√™m thanh v·∫Øng', 'khuya kho·∫Øt']
};

// C·∫¢I TI·∫æN: C·∫•u tr√∫c c√¢u ph·ª©c t·∫°p h∆°n v·ªõi nhi·ªÅu t·∫ßng nghƒ©a
const narrativePatterns = {
    observation: [
        "T√¥i ƒë·ªÉ √Ω th·∫•y {situation} gi·ªØa b·ªë v√† {wife}, {detailed_observation} khi·∫øn t√¥i {emotion} m·ªôt c√°ch {intensity}.",
        "Trong {timeFrame}, t√¥i nh·∫≠n ra {observation} v·ªÅ m·ªëi quan h·ªá c·ªßa h·ªç, {specific_detail} l√†m t√¥i {emotional_response}.",
        "T√¥i kh√¥ng th·ªÉ kh√¥ng ch√∫ √Ω ƒë·∫øn {physicalDescription} khi {situation}, {additional_detail} c√†ng khi·∫øn t√¥i {feeling}.",
        "C√≥ ƒëi·ªÅu g√¨ ƒë√≥ trong {observation} khi·∫øn t√¥i {emotion}, {psychological_insight} c·ª© √°m ·∫£nh t√¢m tr√≠ t√¥i.",
        "T√¥i th·∫•y {wife} v√† b·ªë {action} m·ªôt c√°ch {manner}, {contextual_detail} khi·∫øn b·∫ßu kh√¥ng kh√≠ tr·ªü n√™n {atmosphere}."
    ],
    innerMonologue: [
        "Trong t√¢m tr√≠ t√¥i, {innerThought} v·ªÅ nh·ªØng g√¨ ƒëang di·ªÖn ra, {psychological_analysis} khi·∫øn t√¥i {emotional_state}.",
        "T√¥i t·ª± h·ªèi li·ªáu {question} c√≥ ph·∫£i l√† ƒëi·ªÅu t√¥i nghƒ© kh√¥ng, {self_reflection} l√†m t√¥i {resulting_emotion}.",
        "C·∫£m gi√°c {emotion} c·ª© √°m ·∫£nh t√¥i khi {situation}, {deep_thought} c·ª© vang v·ªçng trong ƒë·∫ßu.",
        "T√¥i kh√¥ng th·ªÉ ng·ª´ng nghƒ© v·ªÅ {observation} m√† t√¥i ƒë√£ th·∫•y, {interpretation} c·ª© xo√°y s√¢u v√†o t√¢m tr√≠.",
        "ƒêi·ªÅu n√†y khi·∫øn t√¥i {emotion} m·ªôt c√°ch {intensity}, {introspection} khi·∫øn t√¥i nh·∫≠n ra {realization}.",
        "C√≥ l·∫Ω t√¥i ƒëang {doubt} nh∆∞ng {feeling} n√†y kh√¥ng th·ªÉ ph·ªß nh·∫≠n, {psychological_awareness} ng√†y c√†ng r√µ r·ªát."
    ],
    conflict: [
        "T√¥i bi·∫øt m√¨nh kh√¥ng n√™n {action} nh∆∞ng {desire} qu√° m·∫°nh, {internal_struggle} khi·∫øn t√¥i {resulting_state}.",
        "Ranh gi·ªõi gi·ªØa {rightWrong} ng√†y c√†ng {blur}, {moral_dilemma} l√†m t√¥i {emotional_turmoil}.",
        "T√¥i c·∫£m th·∫•y {guilty} v√¨ {thought} v·ªÅ {situation}, {self_judgment} c·ª© d√†y v√≤ t√¢m can t√¥i.",
        "L√†m th·∫ø n√†o ƒë·ªÉ t√¥i c√≥ th·ªÉ {cope} v·ªõi {feeling} n√†y? {existential_question} c·ª© treo l∆° l·ª≠ng kh√¥ng l·ªùi gi·∫£i.",
        "M·ªói l·∫ßn {trigger}, t√¥i l·∫°i {reaction}, {pattern_analysis} khi·∫øn t√¥i nh·∫≠n ra {self_discovery}."
    ],
    escalation: [
        "Nh·ªØng {timeFrame} g·∫ßn ƒë√¢y, {situation} ng√†y c√†ng {intensity}, {development_detail} khi·∫øn t√¥i {emotional_change}.",
        "T√¥i nh·∫≠n ra {realization} v·ªÅ b·∫£n th√¢n m√¨nh, {personal_insight} l√†m thay ƒë·ªïi {perspective_change}.",
        "Kh√¥ng th·ªÉ ph·ªß nh·∫≠n r·∫±ng {truth} ƒëang x·∫£y ra, {evidence} ng√†y c√†ng {increasing_evidence}.",
        "C√°ch {wife} {action} v·ªõi b·ªë khi·∫øn t√¥i {emotion}, {behavioral_observation} cho th·∫•y {implication}.",
        "T√¥i b·∫Øt ƒë·∫ßu {change} c√°ch nh√¨n v·ªÅ {relationship}, {transformative_thought} d·∫ßn h√¨nh th√†nh trong t√¥i."
    ],
    // TH√äM M·ªöI: C√°c lo·∫°i ƒëo·∫°n vƒÉn chuy√™n s√¢u
    psychological: [
        "Trong s√¢u th·∫≥m t√¢m tr√≠, {psychological_insight} khi·∫øn t√¥i {emotional_response}, {deep_analysis} h√© l·ªô {revelation}.",
        "Nh·∫≠n th·ª©c c·ªßa t√¥i v·ªÅ {situation} d·∫ßn thay ƒë·ªïi, {cognitive_shift} mang ƒë·∫øn {new_perspective}.",
        "B·∫£n nƒÉng m√°ch b·∫£o t√¥i r·∫±ng {intuitive_feeling}, {subconscious_awareness} d·∫ßn tr·ªói d·∫≠y m·∫°nh m·∫Ω.",
        "T√¢m l√Ω t√¥i r∆°i v√†o tr·∫°ng th√°i {psychological_state}, {internal_process} di·ªÖn ra ph·ª©c t·∫°p kh√¥n l∆∞·ªùng."
    ],
    reflective: [
        "Nh√¨n l·∫°i {time_period}, t√¥i nh·∫≠n ra {retrospective_insight}, {hindsight} mang ƒë·∫øn {lesson_learned}.",
        "K√Ω ·ª©c v·ªÅ {past_event} √πa v·ªÅ, {memory_detail} khi·∫øn t√¥i {emotional_reaction}.",
        "N·∫øu ng√†y ƒë√≥ t√¥i {alternative_action}, c√≥ l·∫Ω {hypothetical_outcome} ƒë√£ kh√¥ng x·∫£y ra.",
        "Suy ng·∫´m v·ªÅ {life_aspect}, t√¥i ch·ª£t hi·ªÉu {philosophical_understanding} v·ªÅ b·∫£n ch·∫•t con ng∆∞·ªùi."
    ],
    descriptive: [
        "Kh√¥ng gian xung quanh {environment_description}, {sensory_detail} t√°c ƒë·ªông l√™n {emotional_response} c·ªßa t√¥i.",
        "√Ånh m·∫Øt {eye_description} c·ªßa {character} nh∆∞ {metaphorical_comparison}, khi·∫øn t√¥i {resulting_feeling}.",
        "C·ª≠ ch·ªâ {gesture_description} tho√°ng qua nh∆∞ng {significance} l·∫°i in s√¢u trong t√¢m tr√≠ t√¥i.",
        "B·∫ßu kh√¥ng kh√≠ {atmosphere_description} bao tr√πm, {environmental_factor} g√≥p ph·∫ßn t·∫°o n√™n {overall_mood}."
    ],
    // TH√äM: C√°c ƒëo·∫°n vƒÉn 18+
    adult: [
        "T√¥i kh√¥ng th·ªÉ r·ªùi m·∫Øt kh·ªèi {physical_description} c·ªßa c√¥ ·∫•y, {adult_observation} khi·∫øn t√¥i {intense_emotion}.",
        "C·∫£m gi√°c {physical_sensation} lan t·ªèa kh·∫Øp c∆° th·ªÉ t√¥i khi {intimate_situation}, {bodily_reaction} kh√¥ng th·ªÉ ki·ªÉm so√°t.",
        "M·ªói l·∫ßn {intimate_action}, t√¥i l·∫°i {physical_response} v√† {emotional_response} m·ªôt c√°ch {intensity}.",
        "Kh√¥ng gian gi·ªØa ch√∫ng t√¥i tr√†n ng·∫≠p {atmosphere_description}, {sensory_detail} k√≠ch th√≠ch m·ªçi gi√°c quan.",
        "T√¥i c·∫£m nh·∫≠n ƒë∆∞·ª£c {physical_detail} c·ªßa c√¥ ·∫•y qua {clothing_description}, {imagination_detail} khi·∫øn t√¥i {arousal_state}."
    ],
    // TH√äM: C√°c ƒëo·∫°n h·ªôi tho·∫°i
    dialogue: [
        '"{dialogue_content}" {character} n√≥i v·ªõi gi·ªçng {tone_of_voice}, {reaction_description}.',
        '"{dialogue_content}" {character} th·ªët l√™n, {emotional_expression} hi·ªán r√µ tr√™n khu√¥n m·∫∑t.',
        '"{dialogue_content}" {character} th√¨ th·∫ßm, {contextual_detail} khi·∫øn c√¢u n√≥i tr·ªü n√™n {significance}.',
        'Sau m·ªôt h·ªìi im l·∫∑ng, {character} l√™n ti·∫øng: "{dialogue_content}" v·ªõi {non_verbal_cue}.'
    ]
};

// C·∫¢I TI·∫æN: C√°c y·∫øu t·ªë t√¨nh ti·∫øt phong ph√∫ h∆°n
const plotElements = {
    triggers: ['khi v·ª£ t√¥i c√∫i xu·ªëng', 'l√∫c b·ªë gi√∫p con d√¢u', 'nh·ªØng c·ª≠ ch·ªâ th√¢n m·∫≠t', '√°nh m·∫Øt trao ƒë·ªïi', 
              'ti·∫øng c∆∞·ªùi nh·∫π', 'c√°ch h·ªç ƒë·ª©ng g·∫ßn nhau', 'khi vai ch·∫°m vai', 'l√∫c tay v√¥ t√¨nh ch·∫°m nhau',
              'khi chia s·∫ª chi·∫øc khƒÉn', 'l√∫c u·ªëng chung ly n∆∞·ªõc', 'khi ƒëi·ªÅu ch·ªânh √°o cho nhau'],
    timeFrames: ['nh·ªØng ng√†y', 'bu·ªïi t·ªëi', 'cu·ªëi tu·∫ßn', 'khi t√¥i v·ªÅ nh√†', 'l√∫c ƒÉn c∆°m', 'nh·ªØng l√∫c y√™n tƒ©nh',
                'ƒë√™m khuya thanh v·∫Øng', 's√°ng s·ªõm tinh m∆°', 'nh·ªØng chi·ªÅu m∆∞a', 'khi tr·ªùi ch·∫≠p cho·∫°ng t·ªëi'],
    locations: ['trong nh√† b·∫øp', '·ªü ph√≤ng kh√°ch', 'ngo√†i s√¢n', 'tr√™n c·∫ßu thang', 'trong ph√≤ng t·∫Øm', '·ªü ban c√¥ng',
               'trong ph√≤ng ng·ªß', 'ngo√†i v∆∞·ªùn sau', 'tr√™n gh·∫ø sofa', 'quanh b√†n ƒÉn', 'd∆∞·ªõi hi√™n nh√†'],
    discoveries: ['t√¥i ph√°t hi·ªán ra', 't√¥i t√¨nh c·ªù th·∫•y', 't√¥i nghe ƒë∆∞·ª£c', 't√¥i nh·∫≠n ra', 't√¥i kh√¥ng th·ªÉ tin',
                 't√¥i v√¥ t√¨nh ch·ª©ng ki·∫øn', 't√¥i b·∫Øt g·∫∑p', 't√¥i kh√°m ph√° ra', 't√¥i v√¥ t√¨nh nh√¨n th·∫•y'],
    consequences: ['t√¥i m·∫•t ng·ªß', 't√¥i kh√¥ng th·ªÉ t·∫≠p trung', 't√¥i b·∫Øt ƒë·∫ßu tr√°nh', 't√¥i c√†ng quan s√°t nhi·ªÅu h∆°n',
                  't√¥i c·∫£m th·∫•y b·ªëi r·ªëi', 't√¥i r∆°i v√†o hoang mang', 't√¢m tr√≠ t√¥i r·ªëi b·ªùi', 'c·∫£m x√∫c t√¥i gi·∫±ng x√©',
                  't√¥i t√¨m c√°ch l·∫£ng tr√°nh', 't√¥i c·ªë g·∫Øng ph·ªõt l·ªù', 't√¥i kh√¥ng ng·ª´ng suy di·ªÖn']
};

// H√ÄM T√çNH ƒêI·ªÇM CH·∫§T L∆Ø·ª¢NG VƒÇN B·∫¢N
function calculateQualityMetrics(content) {
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const words = content.split(/\s+/).filter(w => w.length > 0);
    
    // T√≠nh ƒëi·ªÉm ph·ª©c t·∫°p (d·ª±a tr√™n ƒë·ªô d√†i c√¢u, t·ª´ v·ª±ng ƒëa d·∫°ng)
    const avgSentenceLength = words.length / sentences.length;
    const uniqueWords = new Set(words.map(w => w.toLowerCase()));
    const lexicalDiversity = uniqueWords.size / words.length;
    const complexityScore = (avgSentenceLength / 20 * 0.4) + (lexicalDiversity * 0.6);
    
    // T√≠nh ƒëi·ªÉm m·∫°ch l·∫°c (d·ª±a tr√™n t·ª´ n·ªëi v√† li√™n k·∫øt)
    const transitionWordsCount = words.filter(w => 
        specializedVocabulary.transitionWords.includes(w.toLowerCase())).length;
    const coherenceScore = Math.min(1, transitionWordsCount / (sentences.length * 0.5));
    
    // T√≠nh ƒëi·ªÉm c·∫£m x√∫c (d·ª±a tr√™n t·ª´ v·ª±ng c·∫£m x√∫c)
    const emotionWordsCount = words.filter(w => 
        specializedVocabulary.emotions.includes(w.toLowerCase()) || 
        specializedVocabulary.psychologicalTerms.includes(w.toLowerCase())).length;
    const emotionScore = Math.min(1, emotionWordsCount / (words.length * 0.1));
    
    // T√≠nh ƒëi·ªÉm ƒë·ªô d√†i
    const lengthScore = Math.min(1, words.length / aiKnowledge.qualityMetrics.targetWordCount);
    
    return {
        complexity: Math.round(complexityScore * 100) / 100,
        coherence: Math.round(coherenceScore * 100) / 100,
        emotion: Math.round(emotionScore * 100) / 100,
        length: Math.round(lengthScore * 100) / 100,
        wordCount: words.length,
        sentenceCount: sentences.length
    };
}

// H√ÄM ƒê√ÅNH GI√Å V√Ä C·∫¢I THI·ªÜN CH·∫§T L∆Ø·ª¢NG
function evaluateAndImproveQuality(metrics, content) {
    let improvedContent = content;
    
    // N·∫øu ƒëi·ªÉm ph·ª©c t·∫°p th·∫•p, th√™m c√¢u ph·ª©c t·∫°p h∆°n
    if (metrics.complexity < aiKnowledge.qualityMetrics.complexityThreshold) {
        const complexSentences = Array.from(aiKnowledge.sentenceStructures)
            .filter(s => s.split(' ').length > 15);
        if (complexSentences.length > 0) {
            const randomComplex = complexSentences[Math.floor(Math.random() * complexSentences.length)];
            improvedContent += " " + adaptLearnedSentence(randomComplex);
        }
    }
    
    // N·∫øu ƒëi·ªÉm m·∫°ch l·∫°c th·∫•p, th√™m t·ª´ chuy·ªÉn ti·∫øp
    if (metrics.coherence < aiKnowledge.qualityMetrics.coherenceThreshold) {
        const transitions = Array.from(specializedVocabulary.transitionWords);
        const transition = transitions[Math.floor(Math.random() * transitions.length)];
        improvedContent = improvedContent.replace(/\. ([A-Z])/g, `. ${transition}, $1`);
    }
    
    // N·∫øu ƒëi·ªÉm c·∫£m x√∫c th·∫•p, th√™m t·ª´ ng·ªØ c·∫£m x√∫c
    if (metrics.emotion < aiKnowledge.qualityMetrics.emotionThreshold) {
        const emotions = Array.from(specializedVocabulary.emotions);
        const emotion = emotions[Math.floor(Math.random() * emotions.length)];
        const emotionalPhrase = `T√¥i c·∫£m th·∫•y ${emotion} m·ªôt c√°ch s√¢u s·∫Øc.`;
        improvedContent += " " + emotionalPhrase;
    }
    
    // N·∫øu ƒë·ªô d√†i ch∆∞a ƒë·∫°t, th√™m n·ªôi dung m√¥ t·∫£
    if (metrics.wordCount < aiKnowledge.qualityMetrics.targetWordCount * 0.9) {
        const additionalContent = generateAdditionalContent();
        improvedContent += " " + additionalContent;
    }
    
    return improvedContent;
}

// H√ÄM T·∫†O N·ªòI DUNG B·ªî SUNG
function generateAdditionalContent() {
    const contentTypes = ['observation', 'reflection', 'description', 'memory', 'adult', 'dialogue'];
    const selectedType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
    
    switch(selectedType) {
        case 'observation':
            return generateDetailedObservation();
        case 'reflection':
            return generateInnerReflection();
        case 'description':
            return generateEnvironmentDescription();
        case 'memory':
            return generateMemoryRecall();
        case 'adult':
            return generateAdultContent();
        case 'dialogue':
            return generateDialogue();
    }
}

// C√ÅC H√ÄM T·∫†O N·ªòI DUNG B·ªî SUNG CHI TI·∫æT
function generateDetailedObservation() {
    const templates = [
        "T√¥i quan s√°t th·∫•y {detailed_observation}, {specific_detail} khi·∫øn t√¥i {emotional_response}.",
        "Kh√¥ng th·ªÉ b·ªè qua {visual_detail}, {movement_description} thu h√∫t s·ª± ch√∫ √Ω c·ªßa t√¥i.",
        "√Ånh m·∫Øt {character} {eye_expression}, {gaze_interpretation} khi·∫øn t√¥i {resulting_feeling}."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateInnerReflection() {
    const templates = [
        "Suy nghƒ© v·ªÅ {situation}, t√¥i nh·∫≠n ra {personal_insight} v·ªÅ b·∫£n th√¢n.",
        "T·ª± v·∫•n l∆∞∆°ng t√¢m, t√¥i th·∫•y {self_realization} trong c√°ch ·ª©ng x·ª≠ c·ªßa m√¨nh.",
        "Tr·∫°ng th√°i n·ªôi t√¢m hi·ªán t·∫°i c·ªßa t√¥i l√† {emotional_state}, {self_analysis} gi√∫p t√¥i hi·ªÉu r√µ h∆°n."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateEnvironmentDescription() {
    const templates = [
        "Kh√¥ng gian xung quanh {environment_description}, {sensory_detail} ·∫£nh h∆∞·ªüng ƒë·∫øn t√¢m tr·∫°ng t√¥i.",
        "B·∫ßu kh√¥ng kh√≠ {atmosphere_description} bao tr√πm, {environmental_factor} g√≥p ph·∫ßn t·∫°o n√™n {overall_mood}.",
        "√Ånh s√°ng {light_description} chi·∫øu qua {window_description}, t·∫°o n√™n {visual_effect} ƒë·∫ßy {emotional_quality}."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateMemoryRecall() {
    const templates = [
        "K√Ω ·ª©c v·ªÅ {past_event} √πa v·ªÅ, {memory_detail} khi·∫øn t√¥i {emotional_reaction}.",
        "Nh·ªõ l·∫°i {time_period} tr∆∞·ªõc ƒë√¢y, t√¥i nh·∫≠n ra {retrospective_insight} v·ªÅ cu·ªôc s·ªëng.",
        "H√¨nh ·∫£nh {visual_memory} hi·ªán l√™n trong t√¢m tr√≠, {memory_significance} v·∫´n c√≤n nguy√™n v·∫πn."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateAdultContent() {
    const templates = [
        "C·∫£m gi√°c {physical_sensation} lan t·ªèa kh·∫Øp c∆° th·ªÉ, {bodily_reaction} kh√¥ng th·ªÉ ki·ªÅm ch·∫ø.",
        "T√¥i kh√¥ng th·ªÉ r·ªùi m·∫Øt kh·ªèi {physical_description}, {visual_appeal} k√≠ch th√≠ch m·ªçi gi√°c quan.",
        "Kho·∫£nh kh·∫Øc {intimate_action} khi·∫øn t√¥i {arousal_state}, {physiological_response} di·ªÖn ra t·ª± nhi√™n."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateDialogue() {
    const characters = ['b·ªë', 'v·ª£ t√¥i', 'con d√¢u', 'ch·ªìng', 'ng∆∞·ªùi ƒë√≥'];
    const tones = ['d·ªãu d√†ng', 'tr·∫ßm ·∫•m', 'th√¨ th·∫ßm', 'run r·∫©y', 'n·ªìng n√†n', 'kh√†n kh√†n', 'ƒë·∫ßy c·∫£m x√∫c'];
    const dialogueContent = [
        "Em c√≥ bi·∫øt anh ƒë√£ mong ch·ªù kho·∫£nh kh·∫Øc n√†y l√¢u th·∫ø n√†o kh√¥ng?",
        "Anh kh√¥ng th·ªÉ ti·∫øp t·ª•c gi·∫•u c·∫£m x√∫c n√†y ƒë∆∞·ª£c n·ªØa.",
        "Ch√∫ng ta kh√¥ng n√™n l√†m ƒëi·ªÅu n√†y, nh∆∞ng anh kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i ƒë∆∞·ª£c.",
        "Em th·∫≠t ƒë·∫πp, ƒë·∫πp ƒë·∫øn m·ª©c khi·∫øn anh ph√°t ƒëi√™n l√™n ƒë∆∞·ª£c.",
        "H√£y ƒë·ªÉ m·ªçi chuy·ªán di·ªÖn ra t·ª± nhi√™n th√¥i em."
    ];
    
    const template = getRandomElement(narrativePatterns.dialogue);
    const filledDialogue = template
        .replace("{dialogue_content}", getRandomElement(dialogueContent))
        .replace("{character}", getRandomElement(characters))
        .replace("{tone_of_voice}", getRandomElement(tones))
        .replace("{reaction_description}", getRandomElement(specializedVocabulary.emotions));
    
    return filledDialogue;
}

// H√ÄM THAY TH·∫æ C√ÅC PLACEHOLDERS
function replacePlaceholders(content) {
    // Thay th·∫ø c√°c placeholder c∆° b·∫£n
    content = content.replace(/{situation}/g, getRandomElement(plotElements.triggers));
    content = content.replace(/{timeFrame}/g, getRandomElement(specializedVocabulary.timeFrames));
    content = content.replace(/{location}/g, getRandomElement(specializedVocabulary.locations));
    content = content.replace(/{emotion}/g, getRandomElement(specializedVocabulary.emotions));
    content = content.replace(/{character}/g, getRandomElement(specializedVocabulary.characterNames));
    content = content.replace(/{wife}/g, "v·ª£ t√¥i");
    
    // Thay th·∫ø c√°c placeholder ph·ª©c t·∫°p h∆°n
    content = content.replace(/{detailed_observation}/g, 
        getRandomElement([
            "c√°ch √°nh m·∫Øt h·ªç l∆∞·ªõt qua nhau", 
            "nh·ªØng c·ª≠ ch·ªâ th√¢n m·∫≠t kh√¥ng ƒë√∫ng m·ª±c",
            "kho·∫£ng c√°ch qu√° g·∫ßn gi·ªØa hai ng∆∞·ªùi",
            "nh·ªØng c√°i ch·∫°m tay d∆∞·ªùng nh∆∞ v√¥ t√¨nh"
        ]));
    
    content = content.replace(/{psychological_insight}/g, 
        getRandomElement([
            "nh·∫≠n th·ª©c v·ªÅ s·ª± thu h√∫t kh√¥ng th·ªÉ ph·ªß nh·∫≠n",
            "c·∫£m gi√°c ghen t·ªã l·∫´n t√≤ m√≤",
            "s·ª± th·ª©c t·ªânh c·ªßa nh·ªØng ham mu·ªën ti·ªÅm ·∫©n",
            "m√¢u thu·∫´n gi·ªØa l√Ω tr√≠ v√† c·∫£m x√∫c"
        ]));
    
    content = content.replace(/{intensity}/g, 
        getRandomElement([
            "m√£nh li·ªát", "kh√≥ t·∫£", "kh√≥ ki·ªÉm so√°t", "s√¢u s·∫Øc", 
            "r√µ r·ªát", "ƒë√°ng ng·∫°c nhi√™n", "b·∫•t ng·ªù"
        ]));
    
    // Thay th·∫ø c√°c placeholder 18+
    content = content.replace(/{physical_description}/g, 
        getRandomElement([
            "ƒë∆∞·ªùng cong quy·∫øn r≈©", "v√≤ng eo thon g·ªçn", 
            "b·ªù m√¥i cƒÉng m·ªçng", "√°nh m·∫Øt ƒë·∫ßy m√™ ho·∫∑c",
            "l√†n da m·ªãn m√†ng", "m√°i t√≥c m·ªÅm m·∫°i"
        ]));
    
    content = content.replace(/{intimate_situation}/g, 
        getRandomElement([
            "c√¥ ·∫•y c√∫i xu·ªëng g·∫ßn t√¥i", "h∆°i th·ªü ·∫•m √°p ph·∫£ v√†o tai",
            "c∆° th·ªÉ ch√∫ng t√¥i g·∫ßn nh∆∞ ch·∫°m v√†o nhau", 
            "√°nh m·∫Øt ƒë·∫ßy ·∫©n √Ω trao nhau"
        ]));
    
    content = content.replace(/{arousal_state}/g, 
        getRandomElement([
            "k√≠ch ƒë·ªông", "n√≥ng b·ª´ng", "b·ªìi h·ªìi", "run r·∫©y",
            "th√®m mu·ªën", "kh√°t khao", "b·ªìn ch·ªìn"
        ]));
    
    return content;
}

// H√ÄM L·∫§Y PH·∫¶N T·ª¨ NG·∫™U NHI√äN
function getRandomElement(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// H√ÄM TH√çCH NGHI C√ÇU ƒê√É H·ªåC
function adaptLearnedSentence(sentence) {
    // Thay ƒë·ªïi ch·ªß ng·ªØ, ƒë·ªông t·ª´, tr·∫°ng t·ª´ ƒë·ªÉ t·∫°o s·ª± ƒëa d·∫°ng
    const subjectReplacements = {
        "T√¥i": ["T√¥i", "B·∫£n th√¢n t√¥i", "Trong t√¥i", "T√¢m tr√≠ t√¥i"],
        "C√¥ ·∫•y": ["C√¥ ·∫•y", "Ng∆∞·ªùi ph·ª• n·ªØ ·∫•y", "V·ª£ t√¥i", "Ng∆∞·ªùi ƒë√≥"],
        "B·ªë": ["B·ªë", "B·ªë t√¥i", "Ng∆∞·ªùi ƒë√†n √¥ng ·∫•y", "√îng ·∫•y"]
    };
    
    const verbReplacements = {
        "nh·∫≠n ra": ["nh·∫≠n th·∫•y", "ph√°t hi·ªán", "kh√°m ph√°", "th·∫•y ƒë∆∞·ª£c"],
        "c·∫£m th·∫•y": ["c·∫£m nh·∫≠n", "tr·∫£i qua", "kinh nghi·ªám", "c√≥ c·∫£m gi√°c"],
        "nghƒ©": ["suy nghƒ©", "t·ª± h·ªèi", "tr·∫ßm ng√¢m", "ƒë·∫Øn ƒëo"]
    };
    
    let newSentence = sentence;
    
    // Thay th·∫ø ch·ªß ng·ªØ
    for (const [original, replacements] of Object.entries(subjectReplacements)) {
        if (newSentence.includes(original)) {
            newSentence = newSentence.replace(original, getRandomElement(replacements));
        }
    }
    
    // Thay th·∫ø ƒë·ªông t·ª´
    for (const [original, replacements] of Object.entries(verbReplacements)) {
        if (newSentence.includes(original)) {
            newSentence = newSentence.replace(original, getRandomElement(replacements));
        }
    }
    
    return newSentence;
}

// H√ÄM X·ª¨ L√ù HU·∫§N LUY·ªÜN AI
async function trainAI() {
    try {
        showLoading(true);
        updateStatus("üîç ƒêang t√¨m ki·∫øm v√† ph√¢n t√≠ch c√°c file truy·ªán...");
        
        // T√¨m t·∫•t c·∫£ c√°c file trong th∆∞ m·ª•c
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and trashed = false`,
            fields: 'files(id, name, mimeType, modifiedTime)',
            orderBy: 'modifiedTime desc'
        });
        
        const files = response.result.files;
        updateAIStats('totalFiles', files.length);
        
        let trainedCount = 0;
        let vocabulary = new Set();
        let sentences = new Set();
        let dialogues = [];
        let contexts = [];
        let characters = new Set();
        let locations = new Set();
        
        // Ph√¢n t√≠ch t·ª´ng file
        for (const file of files) {
            if (file.mimeType === 'application/vnd.google-apps.document') {
                updateStatus(`üìñ ƒêang ph√¢n t√≠ch: ${file.name}...`);
                
                try {
                    // Xu·∫•t file d∆∞·ªõi d·∫°ng vƒÉn b·∫£n
                    const exportResponse = await gapi.client.drive.files.export({
                        fileId: file.id,
                        mimeType: 'text/plain'
                    });
                    
                    const content = exportResponse.body;
                    
                    // Tr√≠ch xu·∫•t t·ª´ v·ª±ng
                    const words = content.split(/\s+/).filter(word => 
                        word.length > 2 && !word.match(/[0-9]/));
                    
                    words.forEach(word => {
                        const cleanWord = word.replace(/[.,!?;:()'"-]/g, '').toLowerCase();
                        if (cleanWord.length > 2) {
                            vocabulary.add(cleanWord);
                        }
                    });
                    
                    // Tr√≠ch xu·∫•t c√¢u
                    const contentSentences = content.split(/[.!?]+/).filter(s => s.trim().length > 10);
                    contentSentences.forEach(sentence => {
                        if (sentence.split(' ').length > 5) {
                            sentences.add(sentence.trim());
                        }
                    });
                    
                    // Tr√≠ch xu·∫•t h·ªôi tho·∫°i (n·∫±m trong d·∫•u ngo·∫∑c k√©p)
                    const dialogueMatches = content.match(/"[^"]+"/g) || [];
                    dialogues = dialogues.concat(dialogueMatches.map(d => d.replace(/"/g, '')));
                    
                    // Tr√≠ch xu·∫•t b·ªëi c·∫£nh (c√¢u ch·ª©a t·ª´ ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian)
                    const contextPatterns = [
                        /\b(t·∫°i|·ªü|trong|tr√™n|d∆∞·ªõi|ngo√†i|g·∫ßn|b√™n|c·∫°nh)\s+[^,.!?]+/gi,
                        /\b(v√†o|l√∫c|khi|bu·ªïi|s√°ng|tr∆∞a|chi·ªÅu|t·ªëi|ƒë√™m|ng√†y|th√°ng|nƒÉm)\s+[^,.!?]+/gi
                    ];
                    
                    contextPatterns.forEach(pattern => {
                        const matches = content.match(pattern) || [];
                        contexts = contexts.concat(matches);
                    });
                    
                    // Tr√≠ch xu·∫•t t√™n nh√¢n v·∫≠t (t·ª´ vi·∫øt hoa ƒë·ª©ng ƒë·∫ßu c√¢u ho·∫∑c sau d·∫•u ch·∫•m)
                    const nameMatches = content.match(/(?:^|[.!?]\s+)([A-Z√Ä-·ª∏][a-z√†-·ªπ]+)(?:\s+[A-Z√Ä-·ª∏][a-z√†-·ªπ]+)*/g) || [];
                    nameMatches.forEach(name => {
                        const cleanName = name.replace(/^[.!?]\s+/, '').trim();
                        if (cleanName.split(' ').length <= 3) {
                            characters.add(cleanName);
                        }
                    });
                    
                    // Tr√≠ch xu·∫•t ƒë·ªãa ƒëi·ªÉm (danh t·ª´ ri√™ng ch·ªâ ƒë·ªãa ƒëi·ªÉm)
                    const locationWords = content.match(/\b([A-Z√Ä-·ª∏][a-z√†-·ªπ]+(?:\s+[A-Z√Ä-·ª∏][a-z√†-·ªπ]+)*)\b/g) || [];
                    locationWords.forEach(word => {
                        // L·ªçc ra c√°c t·ª´ c√≥ kh·∫£ nƒÉng l√† ƒë·ªãa ƒëi·ªÉm
                        if (word.length > 3 && !characters.has(word)) {
                            locations.add(word);
                        }
                    });
                    
                    trainedCount++;
                    updateAIStats('trainedFiles', trainedCount);
                    
                } catch (error) {
                    console.error(`L·ªói khi ph√¢n t√≠ch file ${file.name}:`, error);
                }
            }
        }
        
        // C·∫≠p nh·∫≠t ki·∫øn th·ª©c c·ªßa AI
        aiKnowledge.vocabulary = new Set([...aiKnowledge.vocabulary, ...vocabulary]);
        aiKnowledge.sentenceStructures = new Set([...aiKnowledge.sentenceStructures, ...sentences]);
        aiKnowledge.dialogues = [...aiKnowledge.dialogues, ...dialogues];
        aiKnowledge.contexts = [...aiKnowledge.contexts, ...contexts];
        aiKnowledge.characters = new Set([...aiKnowledge.characters, ...characters]);
        aiKnowledge.locations = new Set([...aiKnowledge.locations, ...locations]);
        aiKnowledge.trainedFiles = trainedCount;
        
        // C·∫≠p nh·∫≠t th·ªëng k√™
        updateAIStats('vocabularyCount', aiKnowledge.vocabulary.size);
        updateAIStats('sentenceStructures', aiKnowledge.sentenceStructures.size);
        updateAIStats('dialoguesCount', aiKnowledge.dialogues.length);
        updateAIStats('contextsCount', aiKnowledge.contexts.length);
        updateAIStats('charactersCount', aiKnowledge.characters.size);
        updateAIStats('locationsCount', aiKnowledge.locations.size);
        
        // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
        const progressPercent = Math.min(100, Math.round((trainedCount / files.length) * 100));
        document.getElementById('progressFill').style.width = `${progressPercent}%`;
        
        showLoading(false);
        updateStatus(`‚úÖ Hu·∫•n luy·ªán ho√†n t·∫•t! ƒê√£ ph√¢n t√≠ch ${trainedCount} file. AI ƒë√£ h·ªçc ƒë∆∞·ª£c ${aiKnowledge.vocabulary.size} t·ª´ v·ª±ng v√† ${aiKnowledge.sentenceStructures.size} c·∫•u tr√∫c c√¢u.`);
        
    } catch (error) {
        console.error("L·ªói trong qu√° tr√¨nh hu·∫•n luy·ªán AI:", error);
        showLoading(false);
        updateStatus("‚ùå C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh hu·∫•n luy·ªán AI.", "error");
    }
}

// H√ÄM T·∫†O TRUY·ªÜN T·ª∞ ƒê·ªòNG B·∫∞NG AI
async function generateAIStory() {
    try {
        const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
        
        if (chapterCount < 100 || chapterCount > 150) {
            updateStatus("‚ùå S·ªë ch∆∞∆°ng ph·∫£i t·ª´ 100 ƒë·∫øn 150.", "error");
            return;
        }
        
        showLoading(true);
        updateGenerationStatus("üß† AI ƒëang t·∫°o truy·ªán m·ªõi...");
        
        // T·∫°o t√™n truy·ªán
        const storyTitle = generateStoryTitle();
        
        // T·∫°o th∆∞ m·ª•c cho truy·ªán m·ªõi
        const folderMetadata = {
            name: storyTitle,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [mainFolderId]
        };
        
        const folderResponse = await gapi.client.drive.files.create({
            resource: folderMetadata,
            fields: 'id'
        });
        
        const storyFolderId = folderResponse.result.id;
        
        // T·∫°o c√°c ch∆∞∆°ng
        let completedChapters = 0;
        
        for (let i = 1; i <= chapterCount; i++) {
            updateGenerationStatus(`üìù ƒêang t·∫°o ch∆∞∆°ng ${i}/${chapterCount}...`);
            
            const chapterTitle = `Ch∆∞∆°ng ${i}: ${generateChapterTitle()}`;
            const chapterContent = generateChapterContent();
            
            // T·∫°o t√†i li·ªáu Google Docs cho ch∆∞∆°ng
            const docMetadata = {
                name: chapterTitle,
                mimeType: 'application/vnd.google-apps.document',
                parents: [storyFolderId]
            };
            
            await gapi.client.drive.files.create({
                resource: docMetadata,
                fields: 'id'
            });
            
            // C·∫≠p nh·∫≠t n·ªôi dung
            // (ƒêo·∫°n n√†y c·∫ßn th√™m API ƒë·ªÉ c·∫≠p nh·∫≠t n·ªôi dung Google Docs)
            
            completedChapters++;
            const progressPercent = Math.round((completedChapters / chapterCount) * 100);
            document.getElementById('generationProgressFill').style.width = `${progressPercent}%`;
            
            // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // L∆∞u th√¥ng tin truy·ªán ƒë√£ t·∫°o
        aiGeneratedStories.push({
            title: storyTitle,
            folderId: storyFolderId,
            chapterCount: chapterCount,
            createdAt: new Date().toISOString()
        });
        
        showLoading(false);
        updateGenerationStatus(`‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng truy·ªán "${storyTitle}" v·ªõi ${chapterCount} ch∆∞∆°ng!`);
        
    } catch (error) {
        console.error("L·ªói khi t·∫°o truy·ªán AI:", error);
        showLoading(false);
        updateGenerationStatus("‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o truy·ªán.", "error");
    }
}

// H√ÄM T·∫†O TI√äU ƒê·ªÄ TRUY·ªÜN
function generateStoryTitle() {
    const prefixes = ["B√≠ M·∫≠t", "M·ªëi Quan H·ªá", "Ranh Gi·ªõi", "·∫®n ·ª®c", "D·ª•c V·ªçng", "C√°m D·ªó", "√Åm ·∫¢nh"];
    const suffixes = ["Gia ƒê√¨nh", "T√¨nh Th√π", "Ng∆∞·ªùi Th√¢n", "M√°u M·ªß", "T·ªôi L·ªói", "Tr√°i C·∫•m", "V∆∞·ª£t R√†o"];
    
    const prefix = getRandomElement(prefixes);
    const suffix = getRandomElement(suffixes);
    
    return `${prefix} ${suffix}`;
}

// H√ÄM T·∫†O TI√äU ƒê·ªÄ CH∆Ø∆†NG
function generateChapterTitle() {
    const patterns = [
        "Nh·ªØng {emotion} {secretive}",
        "{timeFrame} {situations}",
        "{discoveries} {locations}",
        "{consequences} {psychologicalTerms}",
        "{adultElements} {characterNames}"
    ];
    
    let title = getRandomElement(patterns);
    title = replacePlaceholders(title);
    
    // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
    return title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

// H√ÄM T·∫†O N·ªòI DUNG CH∆Ø∆†NG
function generateChapterContent() {
    // X√°c ƒë·ªãnh s·ªë ƒëo·∫°n vƒÉn (t·ª´ 15-25 ƒëo·∫°n)
    const paragraphCount = Math.floor(Math.random() * 11) + 15;
    let content = "";
    
    for (let i = 0; i < paragraphCount; i++) {
        // Ch·ªçn ng·∫´u nhi√™n lo·∫°i ƒëo·∫°n vƒÉn
        const paragraphTypes = Object.keys(narrativePatterns);
        const paragraphType = getRandomElement(paragraphTypes);
        const template = getRandomElement(narrativePatterns[paragraphType]);
        
        // Thay th·∫ø placeholder v√† th√™m v√†o n·ªôi dung
        let paragraph = replacePlaceholders(template);
        
        // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu v√† th√™m d·∫•u ch·∫•m cu·ªëi
        paragraph = paragraph.charAt(0).toUpperCase() + paragraph.slice(1);
        if (!paragraph.endsWith('.')) paragraph += '.';
        
        content += paragraph + " ";
    }
    
    // T√≠nh ƒëi·ªÉm ch·∫•t l∆∞·ª£ng v√† c·∫£i thi·ªán n·∫øu c·∫ßn
    const qualityMetrics = calculateQualityMetrics(content);
    content = evaluateAndImproveQuality(qualityMetrics, content);
    
    return content;
}

// H√ÄM C·∫¨P NH·∫¨T TH·ªêNG K√ä AI
function updateAIStats(statId, value) {
    document.getElementById(statId).textContent = value.toLocaleString();
}

// H√ÄM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI
function updateStatus(message, type = "info") {
    const statusElement = document.getElementById('status');
    statusElement.textContent = message;
    statusElement.className = `status ${type}`;
    statusElement.style.display = 'block';
    
    // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y
    if (type !== 'error') {
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 5000);
    }
}

// H√ÄM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI T·∫†O TRUY·ªÜN
function updateGenerationStatus(message, type = "info") {
    const statusElement = document.getElementById('generationStatus');
    statusElement.textContent = message;
    statusElement.className = `status ${type}`;
    statusElement.style.display = 'block';
}

// H√ÄM HI·ªÇN TH·ªä/·∫®N LOADING
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// H√ÄM ƒê√ìNG MODAL
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// C√ÅC H√ÄM KH·ªûI T·∫†O V√Ä X·ª¨ L√ù S·ª∞ KI·ªÜN
function initGoogleAPIs() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
    });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // ƒê·ªÉ tr·ªëng, x·ª≠ l√Ω callback th·ªß c√¥ng
    });
    gis_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw resp;
        }
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').innerText = 'üîÑ L√†m m·ªõi';
        
        await listFiles();
        document.getElementById('mainApp').style.display = 'block';
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('authorizeButton').innerText = 'üîê ƒêƒÉng nh·∫≠p Google Drive';
        document.getElementById('mainApp').style.display = 'none';
        updateStatus('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.');
    }
}

async function listFiles() {
    let response;
    try {
        response = await gapi.client.drive.files.list({
            q: "mimeType='application/vnd.google-apps.folder' and name='AI Truy·ªán Manager' and trashed=false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });
    } catch (err) {
        document.getElementById('status').textContent = err.message;
        return;
    }
    
    const files = response.result.files;
    if (files && files.length > 0) {
        mainFolderId = files[0].id;
        updateStatus('ƒê√£ t√¨m th·∫•y th∆∞ m·ª•c ch√≠nh.');
        await loadStoryHistory();
    } else {
        await createMainFolder();
    }
}

async function createMainFolder() {
    const fileMetadata = {
        name: 'AI Truy·ªán Manager',
        mimeType: 'application/vnd.google-apps.folder'
    };
    
    try {
        const response = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        
        mainFolderId = response.result.id;
        updateStatus('ƒê√£ t·∫°o th∆∞ m·ª•c ch√≠nh th√†nh c√¥ng.');
    } catch (error) {
        updateStatus('L·ªói khi t·∫°o th∆∞ m·ª•c: ' + error.message, 'error');
    }
}

async function loadStoryHistory() {
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime, modifiedTime)',
            orderBy: 'modifiedTime desc'
        });
        
        const folders = response.result.files;
        storyHistory = folders;
        
        displayStoryHistory(folders);
        populateExistingStories(folders);
    } catch (error) {
        console.error('L·ªói khi t·∫£i l·ªãch s·ª≠ truy·ªán:', error);
    }
}

function displayStoryHistory(folders) {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    if (folders.length === 0) {
        historyList.innerHTML = '<p class="no-data">Ch∆∞a c√≥ truy·ªán n√†o.</p>';
        return;
    }
    
    folders.forEach(folder => {
        const date = new Date(folder.modifiedTime || folder.createdTime).toLocaleDateString('vi-VN');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="history-title">${folder.name}</div>
            <div class="history-date">C·∫≠p nh·∫≠t: ${date}</div>
            <button class="btn small" onclick="viewChapters('${folder.id}', '${folder.name}')">Xem ch∆∞∆°ng</button>
        `;
        historyList.appendChild(item);
    });
}

function populateExistingStories(folders) {
    const select = document.getElementById('existingStory');
    select.innerHTML = '<option value="">-- Ch·ªçn truy·ªán --</option>';
    
    folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        select.appendChild(option);
    });
}

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    document.getElementById('newStoryGroup').style.display = mode === 'new' ? 'block' : 'none';
    document.getElementById('existingStoryGroup').style.display = mode === 'existing' ? 'block' : 'none';
    document.getElementById('submitButtonText').textContent = mode === 'new' ? 'L∆∞u Truy·ªán M·ªõi' : 'Th√™m Ch∆∞∆°ng M·ªõi';
}

async function handleStorySubmit(e) {
    e.preventDefault();
    
    const mode = document.getElementById('storyMode').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const storyContent = document.getElementById('storyContent').value;
    
    if (!chapterTitle || !storyContent) {
        updateStatus('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung.', 'error');
        return;
    }
    
    showLoading(true);
    
    try {
        let storyFolderId;
        
        if (mode === 'new') {
            const storyTitle = document.getElementById('storyTitle').value;
            if (!storyTitle) {
                updateStatus('Vui l√≤ng nh·∫≠p t√™n truy·ªán m·ªõi.', 'error');
                showLoading(false);
                return;
            }
            
            // T·∫°o th∆∞ m·ª•c m·ªõi cho truy·ªán
            const folderMetadata = {
                name: storyTitle,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [mainFolderId]
            };
            
            const folderResponse = await gapi.client.drive.files.create({
                resource: folderMetadata,
                fields: 'id'
            });
            
            storyFolderId = folderResponse.result.id;
            updateStatus(`ƒê√£ t·∫°o truy·ªán m·ªõi: ${storyTitle}`);
            
        } else {
            storyFolderId = document.getElementById('existingStory').value;
            if (!storyFolderId) {
                updateStatus('Vui l√≤ng ch·ªçn m·ªôt truy·ªán c√≥ s·∫µn.', 'error');
                showLoading(false);
                return;
            }
        }
        
        // T·∫°o t√†i li·ªáu Google Docs cho ch∆∞∆°ng
        const docMetadata = {
            name: chapterTitle,
            mimeType: 'application/vnd.google-apps.document',
            parents: [storyFolderId]
        };
        
        const docResponse = await gapi.client.drive.files.create({
            resource: docMetadata,
            fields: 'id'
        });
        
        // C·∫≠p nh·∫≠t n·ªôi dung cho t√†i li·ªáu
        // (ƒêo·∫°n n√†y c·∫ßn th√™m API ƒë·ªÉ c·∫≠p nh·∫≠t n·ªôi dung Google Docs)
        
        updateStatus(`ƒê√£ l∆∞u ch∆∞∆°ng: ${chapterTitle}`);
        
        // Reset form
        document.getElementById('storyForm').reset();
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠
        await loadStoryHistory();
        
    } catch (error) {
        console.error('L·ªói khi l∆∞u truy·ªán:', error);
        updateStatus('L·ªói khi l∆∞u truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

async function viewChapters(folderId, folderName) {
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = response.result.files;
        
        document.getElementById('chaptersModalTitle').textContent = `Ch∆∞∆°ng truy·ªán: ${folderName}`;
        const chapterList = document.getElementById('chapterList');
        chapterList.innerHTML = '';
        
        if (chapters.length === 0) {
            chapterList.innerHTML = '<p class="no-data">Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</p>';
        } else {
            chapters.forEach(chapter => {
                const date = new Date(chapter.modifiedTime).toLocaleDateString('vi-VN');
                const item = document.createElement('div');
                item.className = 'chapter-item';
                item.innerHTML = `
                    <div class="chapter-title">${chapter.name}</div>
                    <div class="chapter-date">${date}</div>
                    <button class="btn small" onclick="viewChapterContent('${chapter.id}', '${chapter.name}')">ƒê·ªçc</button>
                `;
                chapterList.appendChild(item);
            });
        }
        
        document.getElementById('chaptersModal').style.display = 'block';
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch ch∆∞∆°ng:', error);
        updateStatus('L·ªói khi t·∫£i danh s√°ch ch∆∞∆°ng: ' + error.message, 'error');
    }
}

async function viewChapterContent(chapterId, chapterTitle) {
    try {
        // Xu·∫•t n·ªôi dung t·ª´ Google Docs
        const response = await gapi.client.drive.files.export({
            fileId: chapterId,
            mimeType: 'text/plain'
        });
        
        const content = response.body;
        
        document.getElementById('chapterList').style.display = 'none';
        document.getElementById('chapterContent').style.display = 'block';
        document.getElementById('chapterContent').innerHTML = `
            <h3>${chapterTitle}</h3>
            <div class="content-text">${content.replace(/\n/g, '<br>')}</div>
        `;
        
        document.getElementById('chapterActions').style.display = 'block';
        currentEditingChapter = { id: chapterId, title: chapterTitle, content: content };
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng:', error);
        updateStatus('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng: ' + error.message, 'error');
    }
}

function editChapter() {
    const contentDiv = document.querySelector('.content-text');
    const currentContent = contentDiv.innerHTML.replace(/<br>/g, '\n');
    
    contentDiv.innerHTML = `
        <textarea id="editContent" style="width: 100%; height: 300px;">${currentContent}</textarea>
    `;
    
    document.querySelector('.chapter-actions').innerHTML += `
        <button class="btn" onclick="saveChapterChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
        <button class="btn" onclick="cancelEdit()">‚ùå H·ªßy</button>
    `;
}

async function saveChapterChanges() {
    const editedContent = document.getElementById('editContent').value;
    
    try {
        // C·∫≠p nh·∫≠t n·ªôi dung trong Google Docs
        // (ƒêo·∫°n n√†y c·∫ßn th√™m API ƒë·ªÉ c·∫≠p nh·∫≠t n·ªôi dung Google Docs)
        
        updateStatus('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung ch∆∞∆°ng.');
        currentEditingChapter.content = editedContent;
        cancelEdit();
        
    } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t ch∆∞∆°ng:', error);
        updateStatus('L·ªói khi c·∫≠p nh·∫≠t ch∆∞∆°ng: ' + error.message, 'error');
    }
}

function cancelEdit() {
    document.getElementById('chapterContent').innerHTML = `
        <h3>${currentEditingChapter.title}</h3>
        <div class="content-text">${currentEditingChapter.content.replace(/\n/g, '<br>')}</div>
    `;
    
    document.querySelector('.chapter-actions').innerHTML = `
        <button class="btn" onclick="editChapter()">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
        <button class="btn danger" onclick="deleteChapter()">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
        <button class="btn" onclick="document.getElementById('chapterList').style.display = 'block'; document.getElementById('chapterContent').style.display = 'none'; document.getElementById('chapterActions').style.display = 'none';">‚Ü©Ô∏è Quay l·∫°i</button>
    `;
}

async function deleteChapter() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y?')) return;
    
    try {
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        updateStatus('ƒê√£ x√≥a ch∆∞∆°ng th√†nh c√¥ng.');
        closeModal('chaptersModal');
        
        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ch∆∞∆°ng
        const folderId = document.getElementById('existingStory').value;
        if (folderId) {
            await viewChapters(folderId, document.getElementById('chaptersModalTitle').textContent.replace('Ch∆∞∆°ng truy·ªán: ', ''));
        }
        
    } catch (error) {
        console.error('L·ªói khi x√≥a ch∆∞∆°ng:', error);
        updateStatus('L·ªói khi x√≥a ch∆∞∆°ng: ' + error.message, 'error');
    }
}

function viewAIStories() {
    const storyList = document.getElementById('aiStoryList');
    storyList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        storyList.innerHTML = '<p class="no-data">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o b·ªüi AI.</p>';
    } else {
        aiGeneratedStories.forEach(story => {
            const date = new Date(story.createdAt).toLocaleDateString('vi-VN');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="history-title">${story.title}</div>
                <div class="history-date">T·∫°o ng√†y: ${date}</div>
                <div class="history-detail">S·ªë ch∆∞∆°ng: ${story.chapterCount}</div>
                <button class="btn small" onclick="viewChapters('${story.folderId}', '${story.title}')">Xem truy·ªán</button>
            `;
            storyList.appendChild(item);
        });
    }
    
    document.getElementById('aiStoriesModal').style.display = 'block';
}

// ƒêƒÇNG K√ù S·ª∞ KI·ªÜN
document.addEventListener('DOMContentLoaded', function() {
    initGoogleAPIs();
    
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    document.getElementById('storyForm').onsubmit = handleStorySubmit;
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    document.getElementById('generateStoryButton').onclick = generateAIStory;
    document.getElementById('viewAiStoriesButton').onclick = viewAIStories;
    
    // Menu navigation
    document.getElementById('menuTraining').onclick = () => showSection('trainingSection');
    document.getElementById('menuGeneration').onclick = () => showSection('generationSection');
    document.getElementById('menuManagement').onclick = () => showSection('managementSection');
    document.getElementById('menuHistory').onclick = () => showSection('historySection');
});

function showSection(sectionId) {
    // ·∫®n t·∫•t c·∫£ c√°c section
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // B·ªè active t·∫•t c·∫£ c√°c n√∫t menu
    document.querySelectorAll('.nav-menu button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Hi·ªÉn th·ªã section ƒë∆∞·ª£c ch·ªçn
    document.getElementById(sectionId).classList.add('active');
    
    // Active n√∫t menu t∆∞∆°ng ·ª©ng
    document.getElementById('menu' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1).replace('Section', ''))
        .classList.add('active');
}

function resetAI() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô ki·∫øn th·ª©c c·ªßa AI? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        aiKnowledge = {
            vocabulary: new Set(),
            stories: [],
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set(),
            transitionWords: new Set(),
            psychologicalTerms: new Set(),
            descriptivePatterns: new Set(),
            metaphors: new Set(),
            adultTerms: new Set(),
            characters: new Set(),
            locations: new Set(),
            timeFrames: new Set(),
            generationHistory: [],
            qualityMetrics: {
                complexityThreshold: 0.6,
                coherenceThreshold: 0.7,
                emotionThreshold: 0.65,
                targetWordCount: 3500
            }
        };
        
        // Reset th·ªëng k√™
        updateAIStats('totalFiles', 0);
        updateAIStats('trainedFiles', 0);
        updateAIStats('vocabularyCount', 0);
        updateAIStats('sentenceStructures', 0);
        updateAIStats('dialoguesCount', 0);
        updateAIStats('contextsCount', 0);
        updateAIStats('charactersCount', 0);
        updateAIStats('locationsCount', 0);
        
        document.getElementById('progressFill').style.width = '0%';
        
        updateStatus('‚úÖ ƒê√£ reset to√†n b·ªô ki·∫øn th·ª©c c·ªßa AI.');
    }
}
</script>
</body>
</html>
