<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Writer - Enhanced</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            min-width: 120px;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .story-input-area {
            min-height: 400px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
        }

        .chapter-input-area {
            min-height: 300px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .file-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .chapter-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chapter-title {
            font-weight: bold;
            color: #007bff;
        }

        .chapter-meta {
            font-size: 12px;
            color: #666;
        }

        .chapter-preview {
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .story-folder {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .folder-title {
            font-weight: bold;
            color: #333;
        }

        .folder-meta {
            font-size: 12px;
            color: #666;
        }

        .folder-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .folder-content.expanded {
            display: block;
        }

        .folder-toggle {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .tabs {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                margin-right: 0;
            }
            .chapter-actions,
            .folder-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Story Writer Enhanced</h1>
            <p>Viết truyện thủ công và AI với quản lý chương chuyên nghiệp</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="manual">📝 Viết thủ công</button>
                <button class="tab" data-tab="ai">🤖 AI viết truyện</button>
                <button class="tab" data-tab="history">📚 Lịch sử truyện</button>
                <button class="tab" data-tab="training">🧠 Huấn luyện AI</button>
                <button class="tab" data-tab="drive">☁️ Google Drive</button>
            </div>

            <!-- Tab Viết thủ công -->
            <div class="tab-content active" data-content="manual">
                <div class="section">
                    <h3>📖 Thông tin truyện</h3>
                    <div class="form-group">
                        <label>Tên truyện</label>
                        <input type="text" id="manualStoryTitle" placeholder="Nhập tên truyện của bạn...">
                    </div>
                    <div class="form-group">
                        <label>Tác giả</label>
                        <input type="text" id="manualAuthorName" placeholder="Tên tác giả...">
                    </div>
                    <div class="form-group">
                        <label>Thể loại</label>
                        <select id="manualStoryGenre">
                            <option value="romance">Lãng mạn</option>
                            <option value="drama">Tâm lý</option>
                            <option value="adventure">Phiêu lưu</option>
                            <option value="mystery">Bí ẩn</option>
                            <option value="fantasy">Giả tưởng</option>
                            <option value="slice_of_life">Đời thường</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mô tả ngắn</label>
                        <textarea id="manualStoryDescription" placeholder="Viết mô tả ngắn về truyện..." rows="3"></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3>📄 Viết chương</h3>
                    <div class="form-group">
                        <label>Tên chương</label>
                        <input type="text" id="manualChapterTitle" placeholder="Tự động: Chương 1, Chương 2... hoặc nhập tên tùy chỉnh">
                    </div>
                    <div class="form-group">
                        <label>Nội dung chương</label>
                        <textarea id="manualChapterContent" class="chapter-input-area" placeholder="Viết nội dung chương tại đây...

Ví dụ:
Tôi bước ra khỏi tòa nhà văn phòng với tâm trạng nặng nề. Hà Nội hôm nay se lạnh, giống như trái tim tôi vậy. Công việc vừa mất, tình yêu cũng tan vỡ. Tôi không biết mình sẽ đi về đâu trong thành phố rộng lớn này.

Những giọt mưa nhỏ bắt đầu rơi, ướt vai áo tôi. Tôi đứng giữa phố, nhìn những người qua lại với vẻ tìm chỗ trú mưa. Chỉ có tôi, một mình, đứng đó như một kẻ lạc lối..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="saveChapterBtn">💾 Lưu chương</button>
                        <button class="btn btn-primary" id="addNewChapterBtn">➕ Chương mới</button>
                        <button class="btn btn-secondary" id="clearChapterBtn">🗑️ Xóa nội dung</button>
                        <button class="btn btn-warning" id="previewStoryBtn">👁️ Xem trước toàn bộ</button>
                    </div>
                </div>

                <div class="section" id="currentStoryInfo" style="display: none;">
                    <h3>📊 Thông tin truyện hiện tại</h3>
                    <div id="currentStoryStats"></div>
                    <div id="currentChaptersList"></div>
                </div>

                <div id="manualAlert" style="display: none;"></div>
            </div>

            <!-- Tab AI viết truyện -->
            <div class="tab-content" data-content="ai">
                <div class="section">
                    <h3>🤖 Cài đặt AI viết truyện</h3>
                    <div class="form-group">
                        <label>Chủ đề/Ý tưởng truyện</label>
                        <textarea id="aiStoryPrompt" placeholder="Ví dụ: Tôi là một sinh viên đại học sống ở Hà Nội, gặp khó khăn trong cuộc sống và tình yêu. Viết về những trải nghiệm của tôi trong thành phố lớn..." rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phong cách viết</label>
                        <select id="aiWritingStyle">
                            <option value="melancholy">Buồn bã, nội tâm</option>
                            <option value="romantic">Lãng mạn, ngọt ngào</option>
                            <option value="philosophical">Triết lý, sâu sắc</option>
                            <option value="realistic">Thực tế, gần gũi</option>
                            <option value="nostalgic">Hoài niệm, nhớ nhung</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Độ dài mỗi chương (số từ)</label>
                        <select id="aiChapterLength">
                            <option value="short">Ngắn (800-1200 từ)</option>
                            <option value="medium" selected>Trung bình (1500-2000 từ)</option>
                            <option value="long">Dài (2500-3000 từ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Số chương muốn tạo</label>
                        <input type="number" id="aiNumberOfChapters" value="3" min="1" max="20">
                    </div>
                    <button class="btn btn-success" id="generateAIStoryBtn">✨ Tạo truyện bằng AI</button>
                </div>

                <div class="section" id="aiGenerationProgress" style="display: none;">
                    <h3>⏳ Tiến độ tạo truyện</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span id="aiGenerationStatus">Đang khởi tạo...</span>
                            <span id="aiGenerationPercent">0%</span>
                        </div>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="aiGenerationBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div class="section" id="aiGeneratedStory" style="display: none;">
                    <h3>📖 Truyện AI đã tạo</h3>
                    <div id="aiStoryDetails"></div>
                    <div id="aiChaptersList"></div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" id="saveAIStoryBtn">💾 Lưu truyện vào lịch sử</button>
                        <button class="btn btn-success" id="continueAIStoryBtn">📝 Viết thêm chương</button>
                        <button class="btn btn-secondary" id="regenerateChapterBtn" style="display: none;">🔄 Viết lại chương này</button>
                    </div>
                </div>

                <div id="aiAlert" style="display: none;"></div>
            </div>

            <!-- Tab Lịch sử truyện -->
            <div class="tab-content" data-content="history">
                <div class="section">
                    <h3>📚 Lịch sử truyện</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalManualStories">0</div>
                            <div class="stat-label">Truyện thủ công</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalAIStories">0</div>
                            <div class="stat-label">Truyện AI</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalChapters">0</div>
                            <div class="stat-label">Tổng chương</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalWords">0</div>
                            <div class="stat-label">Tổng từ</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>✍️ Truyện viết thủ công</h3>
                    <div id="manualStoriesList" class="file-list">
                        <div class="loading">Chưa có truyện thủ công nào</div>
                    </div>
                </div>

                <div class="section">
                    <h3>🤖 Truyện tạo bằng AI</h3>
                    <div id="aiStoriesList" class="file-list">
                        <div class="loading">Chưa có truyện AI nào</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="refreshHistoryBtn">🔄 Làm mới</button>
                    <button class="btn btn-success" id="exportAllBtn">📤 Xuất tất cả</button>
                </div>

                <div id="historyAlert" style="display: none;"></div>
            </div>

            <!-- Tab Huấn luyện AI (giữ nguyên như cũ) -->
            <div class="tab-content" data-content="training">
                <div class="section">
                    <h3>🧠 Huấn luyện AI chuyên sâu</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        AI sẽ học từ tất cả các nguồn dữ liệu để viết truyện theo phong cách riêng của bạn
                    </p>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalDataSources">0</div>
                            <div class="stat-label">Nguồn dữ liệu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTrainingWords">0</div>
                            <div class="stat-label">Tổng từ đã học</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uniquePhrases">0</div>
                            <div class="stat-label">Cụm từ độc đáo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="aiReadiness">0%</div>
                            <div class="stat-label">Sẵn sàng viết</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>🚀 Bắt đầu huấn luyện</h3>
                    <button class="btn btn-primary" id="startTrainingBtn">🧠 Huấn luyện AI đầy đủ</button>
                    <button class="btn btn-success" id="quickTrainingBtn">⚡ Huấn luyện nhanh</button>
                    <button class="btn btn-secondary" id="testAIBtn">🧪 Kiểm tra AI</button>
                </div>

                <div id="trainingAlert" style="display: none;"></div>
            </div>

            <!-- Tab Google Drive (giữ nguyên như cũ) -->
            <div class="tab-content" data-content="drive">
                <div class="section">
                    <h3>Trạng thái kết nối</h3>
                    <p>
                        <span class="status-indicator status-disconnected" id="driveStatusIndicator"></span>
                        <span id="driveStatusText">Chưa kết nối với Google Drive</span>
                    </p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" id="connectGoogleDriveBtn">🔗 Kết nối Google Drive</button>
                        <button class="btn btn-danger" id="disconnectGoogleDriveBtn" style="display: none;">❌ Ngắt kết nối</button>
                    </div>
                </div>

                <div id="driveAlert" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal xem chi tiết truyện -->
    <div id="storyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalStoryTitle">Chi tiết truyện</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalStoryContent">
                <!-- Nội dung sẽ được load động -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentManualStory = null;
        let currentAIStory = null;
        let manualStories = []; // Truyện viết thủ công
        let aiStories = []; // Truyện tạo bằng AI
        let aiTrainingData = {
            stories: [],
            vocabulary: new Set(),
            patterns: [],
            trainedStories: 0,
            accuracy: 0
        };

        // Khởi tạo ứng dụng
        function initializeApp() {
            setupEventListeners();
            loadStoriesFromMemory();
            updateAllStats();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Manual writing events
            document.getElementById('saveChapterBtn').addEventListener('click', saveManualChapter);
            document.getElementById('addNewChapterBtn').addEventListener('click', addNewChapter);
            document.getElementById('clearChapterBtn').addEventListener('click', clearChapter);
            document.getElementById('previewStoryBtn').addEventListener('click', previewCurrentStory);

            // AI writing events
            document.getElementById('generateAIStoryBtn').addEventListener('click', generateAIStory);
            document.getElementById('saveAIStoryBtn').addEventListener('click', saveAIStoryToHistory);
            document.getElementById('continueAIStoryBtn').addEventListener('click', continueAIStory);

            // Training events
            document.getElementById('startTrainingBtn').addEventListener('click', startFullTraining);
            document.getElementById('quickTrainingBtn').addEventListener('click', startQuickTraining);
            document.getElementById('testAIBtn').addEventListener('click', testAI);

            // History events
            document.getElementById('refreshHistoryBtn').addEventListener('click', refreshHistory);
        }

        // ===== MANUAL WRITING FUNCTIONS =====

        // Lưu chương thủ công
        function saveManualChapter() {
            const storyTitle = document.getElementById('manualStoryTitle').value.trim();
            const author = document.getElementById('manualAuthorName').value.trim() || 'Ẩn danh';
            const genre = document.getElementById('manualStoryGenre').value;
            const description = document.getElementById('manualStoryDescription').value.trim();
            const chapterTitle = document.getElementById('manualChapterTitle').value.trim();
            const chapterContent = document.getElementById('manualChapterContent').value.trim();

            if (!storyTitle) {
                showAlert('manual', 'Vui lòng nhập tên truyện', 'error');
                return;
            }

            if (!chapterContent) {
                showAlert('manual', 'Vui lòng nhập nội dung chương', 'error');
                return;
            }

            // Tìm hoặc tạo truyện
            if (!currentManualStory || currentManualStory.title !== storyTitle) {
                currentManualStory = {
                    id: 'manual_' + Date.now(),
                    title: storyTitle,
                    author: author,
                    genre: genre,
                    description: description,
                    chapters: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    totalWords: 0,
                    type: 'manual'
                };
            }

            // Tạo chương mới
            const chapterNumber = currentManualStory.chapters.length + 1;
            const finalChapterTitle = chapterTitle || `Chương ${chapterNumber}`;
            const wordCount = countWords(chapterContent);

            const chapter = {
                id: 'chapter_' + Date.now(),
                title: finalChapterTitle,
                content: chapterContent,
                wordCount: wordCount,
                createdAt: new Date().toISOString(),
                chapterNumber: chapterNumber
            };

            currentManualStory.chapters.push(chapter);
            currentManualStory.updatedAt = new Date().toISOString();
            currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);

            // Cập nhật danh sách truyện thủ công
            const existingIndex = manualStories.findIndex(s => s.title === storyTitle);
            if (existingIndex >= 0) {
                manualStories[existingIndex] = currentManualStory;
            } else {
                manualStories.push(currentManualStory);
            }

            // Reset form
            document.getElementById('manualChapterTitle').value = '';
            document.getElementById('manualChapterContent').value = '';

            updateCurrentStoryDisplay();
            updateAllStats();
            showAlert('manual', `Đã lưu "${finalChapterTitle}" vào truyện "${storyTitle}"`, 'success');
        }

        // Thêm chương mới
        function addNewChapter() {
            if (!currentManualStory) {
                showAlert('manual', 'Vui lòng lưu chương đầu tiên trước', 'error');
                return;
            }

            document.getElementById('manualChapterTitle').value = '';
            document.getElementById('manualChapterContent').value = '';
            document.getElementById('manualChapterContent').focus();
            showAlert('manual', 'Sẵn sàng viết chương mới!', 'info');
        }

        // Xóa nội dung chương
        function clearChapter() {
            if (confirm('Bạn có chắc chắn muốn xóa nội dung chương hiện tại?')) {
                document.getElementById('manualChapterTitle').value = '';
                document.getElementById('manualChapterContent').value = '';
                showAlert('manual', 'Đã xóa nội dung chương', 'info');
            }
        }

        // Xem trước toàn bộ truyện
        function previewCurrentStory() {
            if (!currentManualStory || currentManualStory.chapters.length === 0) {
                showAlert('manual', 'Chưa có chương nào để xem trước', 'error');
                return;
            }

            showStoryModal(currentManualStory);
        }

        // Cập nhật hiển thị truyện hiện tại
        function updateCurrentStoryDisplay() {
            const infoSection = document.getElementById('currentStoryInfo');
            const statsDiv = document.getElementById('currentStoryStats');
            const chaptersDiv = document.getElementById('currentChaptersList');

            if (!currentManualStory) {
                infoSection.style.display = 'none';
                return;
            }

            infoSection.style.display = 'block';

            // Hiển thị thống kê
            statsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.chapters.length}</div>
                        <div class="stat-label">Chương</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.totalWords.toLocaleString()}</div>
                        <div class="stat-label">Từ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.genre}</div>
                        <div class="stat-label">Thể loại</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #007bff;">
                    <strong>📖 ${currentManualStory.title}</strong><br>
                    <small style="color: #666;">Tác giả: ${currentManualStory.author} • Cập nhật: ${new Date(currentManualStory.updatedAt).toLocaleString('vi-VN')}</small>
                    ${currentManualStory.description ? `<br><em style="color: #666;">${currentManualStory.description}</em>` : ''}
                </div>
            `;

            // Hiển thị danh sách chương
            chaptersDiv.innerHTML = `
                <h4 style="margin-bottom: 15px;">📄 Danh sách chương</h4>
                ${currentManualStory.chapters.map(chapter => `
                    <div class="chapter-item">
                        <div class="chapter-header">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-meta">${chapter.wordCount} từ • ${new Date(chapter.createdAt).toLocaleString('vi-VN')}</div>
                        </div>
                        <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                        <div class="chapter-actions">
                            <button class="btn btn-primary" onclick="editChapter('${chapter.id}')">✏️ Sửa</button>
                            <button class="btn btn-secondary" onclick="viewChapter('${chapter.id}')">👁️ Xem</button>
                            <button class="btn btn-danger" onclick="deleteChapter('${chapter.id}')">🗑️ Xóa</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ===== AI WRITING FUNCTIONS =====

        // Tạo truyện bằng AI
        async function generateAIStory() {
            const prompt = document.getElementById('aiStoryPrompt').value.trim();
            const style = document.getElementById('aiWritingStyle').value;
            const length = document.getElementById('aiChapterLength').value;
            const chapters = parseInt(document.getElementById('aiNumberOfChapters').value);

            if (!prompt) {
                showAlert('ai', 'Vui lòng nhập chủ đề/ý tưởng cho truyện', 'error');
                return;
            }

            if (aiTrainingData.trainedStories === 0) {
                showAlert('ai', 'Vui lòng huấn luyện AI trước khi tạo truyện', 'error');
                return;
            }

            showGenerationProgress();
            updateGenerationStatus('Đang khởi tạo AI...', 0);

            try {
                // Tạo thông tin truyện
                const storyTitle = generateStoryTitle(prompt);
                const storyDescription = generateStoryDescription(prompt);
                
                currentAIStory = {
                    id: 'ai_' + Date.now(),
                    title: storyTitle,
                    author: 'AI Story Writer',
                    genre: getGenreFromStyle(style),
                    description: storyDescription,
                    prompt: prompt,
                    style: style,
                    chapters: [],
                    createdAt: new Date().toISOString(),
                    totalWords: 0,
                    type: 'ai'
                };

                updateGenerationStatus('Đang tạo outline truyện...', 10);

                // Tạo từng chương
                for (let i = 1; i <= chapters; i++) {
                    updateGenerationStatus(`Đang viết chương ${i}/${chapters}...`, 10 + (i / chapters) * 80);
                    
                    const chapterTitle = generateChapterTitle(i, chapters, style);
                    const chapterContent = await generateChapter(prompt, style, length, i, chapters);
                    const wordCount = countWords(chapterContent);

                    const chapter = {
                        id: 'ai_chapter_' + Date.now() + '_' + i,
                        title: chapterTitle,
                        content: chapterContent,
                        wordCount: wordCount,
                        createdAt: new Date().toISOString(),
                        chapterNumber: i
                    };

                    currentAIStory.chapters.push(chapter);
                    currentAIStory.totalWords += wordCount;

                    // Delay để tạo cảm giác thực tế
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                updateGenerationStatus('Hoàn tất!', 100);
                hideGenerationProgress();
                displayAIStory();
                showAlert('ai', `AI đã tạo thành công truyện "${storyTitle}" với ${chapters} chương!`, 'success');

            } catch (error) {
                console.error('Error generating AI story:', error);
                hideGenerationProgress();
                showAlert('ai', 'Lỗi khi tạo truyện: ' + error.message, 'error');
            }
        }

        // Hiển thị truyện AI đã tạo
        function displayAIStory() {
            if (!currentAIStory) return;

            const section = document.getElementById('aiGeneratedStory');
            const details = document.getElementById('aiStoryDetails');
            const chaptersList = document.getElementById('aiChaptersList');

            section.style.display = 'block';

            // Hiển thị thông tin truyện
            details.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 20px;">
                    <h4>📖 ${currentAIStory.title}</h4>
                    <div style="margin: 10px 0; color: #666;">
                        <strong>Tác giả:</strong> ${currentAIStory.author}<br>
                        <strong>Thể loại:</strong> ${currentAIStory.genre}<br>
                        <strong>Phong cách:</strong> ${getStyleName(currentAIStory.style)}<br>
                        <strong>Tổng từ:</strong> ${currentAIStory.totalWords.toLocaleString()}<br>
                        <strong>Số chương:</strong> ${currentAIStory.chapters.length}
                    </div>
                    <p><em>${currentAIStory.description}</em></p>
                </div>
            `;

            // Hiển thị danh sách chương
            chaptersList.innerHTML = `
                <h4 style="margin-bottom: 15px;">📄 Danh sách chương đã tạo</h4>
                ${currentAIStory.chapters.map(chapter => `
                    <div class="chapter-item">
                        <div class="chapter-header">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-meta">${chapter.wordCount} từ</div>
                        </div>
                        <div class="chapter-preview">${chapter.content.substring(0, 150)}...</div>
                        <div class="chapter-actions">
                            <button class="btn btn-secondary" onclick="viewAIChapter('${chapter.id}')">👁️ Xem đầy đủ</button>
                            <button class="btn btn-warning" onclick="regenerateAIChapter('${chapter.id}')">🔄 Viết lại</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Lưu truyện AI vào lịch sử
        function saveAIStoryToHistory() {
            if (!currentAIStory) {
                showAlert('ai', 'Không có truyện nào để lưu', 'error');
                return;
            }

            aiStories.push({...currentAIStory});
            updateAllStats();
            showAlert('ai', `Đã lưu truyện "${currentAIStory.title}" vào lịch sử`, 'success');
        }

        // Tiếp tục viết truyện AI
        async function continueAIStory() {
            if (!currentAIStory) {
                showAlert('ai', 'Không có truyện nào để tiếp tục', 'error');
                return;
            }

            const nextChapterNumber = currentAIStory.chapters.length + 1;
            showAlert('ai', `AI đang viết chương ${nextChapterNumber}...`, 'info');

            try {
                const chapterTitle = generateChapterTitle(nextChapterNumber, nextChapterNumber + 5, currentAIStory.style);
                const chapterContent = await generateChapter(
                    currentAIStory.prompt, 
                    currentAIStory.style, 
                    'medium', 
                    nextChapterNumber, 
                    nextChapterNumber + 5
                );
                const wordCount = countWords(chapterContent);

                const chapter = {
                    id: 'ai_chapter_' + Date.now() + '_' + nextChapterNumber,
                    title: chapterTitle,
                    content: chapterContent,
                    wordCount: wordCount,
                    createdAt: new Date().toISOString(),
                    chapterNumber: nextChapterNumber
                };

                currentAIStory.chapters.push(chapter);
                currentAIStory.totalWords += wordCount;

                displayAIStory();
                showAlert('ai', `Đã thêm "${chapterTitle}"!`, 'success');

            } catch (error) {
                console.error('Error continuing story:', error);
                showAlert('ai', 'Lỗi khi tiếp tục viết: ' + error.message, 'error');
            }
        }

        // ===== HELPER FUNCTIONS =====

        // Tạo tên truyện từ prompt
        function generateStoryTitle(prompt) {
            const templates = [
                'Nhật Ký Của Tôi',
                'Cuộc Sống Trong Thành Phố',
                'Những Ngày Cô Đơn',
                'Tôi Và Thế Giới',
                'Hành Trình Tìm Về',
                'Nơi Tôi Thuộc Về',
                'Câu Chuyện Của Tôi',
                'Những Trang Nhật Ký',
                'Giấc Mơ Và Hiện Thực',
                'Con Đường Tôi Đi'
            ];
            
            // Thử tạo tên từ prompt
            if (prompt.includes('sinh viên')) return 'Nhật Ký Sinh Viên';
            if (prompt.includes('Hà Nội') || prompt.includes('thành phố')) return 'Những Ngày Ở Hà Nội';
            if (prompt.includes('tình yêu')) return 'Chuyện Tình Của Tôi';
            if (prompt.includes('công việc')) return 'Cuộc Sống Công Sở';
            
            return templates[Math.floor(Math.random() * templates.length)];
        }

        // Tạo mô tả truyện
        function generateStoryDescription(prompt) {
            return `Một câu chuyện được AI tạo ra từ ý tưởng: "${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}". Truyện được kể theo ngôi thứ nhất, mang đậm tính cá nhân và cảm xúc.`;
        }

        // Tạo tên chương
        function generateChapterTitle(chapterNum, totalChapters, style) {
            const templates = {
                melancholy: [
                    'Những Giọt Nước Mắt', 'Nỗi Buồn Vô Tận', 'Trái Tim Tan Vỡ',
                    'Đêm Tối Và Cô Đơn', 'Ký Ức Buồn', 'Nước Mắt Trong Mưa'
                ],
                romantic: [
                    'Tình Yêu Đầu Đời', 'Trái Tim Rung Động', 'Nụ Hôn Đầu Tiên',
                    'Những Lời Yêu Thương', 'Giấc Mơ Tình Yêu', 'Hạnh Phúc Bên Em'
                ],
                philosophical: [
                    'Suy Tư Về Cuộc Đời', 'Triết Lý Sống', 'Ý Nghĩa Cuộc Sống',
                    'Những Bài Học', 'Hiểu Về Bản Thân', 'Con Đường Tìm Hiểu'
                ],
                realistic: [
                    'Cuộc Sống Hằng Ngày', 'Thực Tế Cuộc Đời', 'Những Ngày Bình Thường',
                    'Chuyện Đời Thường', 'Hạnh Phúc Giản Đơn', 'Cuộc Sống Thành Phố'
                ],
                nostalgic: [
                    'Nhớ Về Quê Hương', 'Kỷ Niệm Xưa Cũ', 'Thời Thơ Ấu',
                    'Những Ngày Đã Qua', 'Hoài Niệm', 'Ký Ức Tuổi Thơ'
                ]
            };

            const styleTemplates = templates[style] || templates.melancholy;
            
            if (chapterNum === 1) return 'Khởi Đầu';
            if (chapterNum === totalChapters) return 'Kết Thúc';
            
            return styleTemplates[Math.floor(Math.random() * styleTemplates.length)];
        }

        // Tạo nội dung chương
        async function generateChapter(prompt, style, length, chapterNum, totalChapters) {
            const wordCount = getWordCount(length);
            const stylePrompts = getStylePrompts(style);
            
            // Tạo câu mở đầu
            const openings = [
                'Tôi không bao giờ nghĩ rằng cuộc đời mình sẽ đưa tôi đến điểm này.',
                'Khi tôi nhìn lại những ngày qua, tôi cảm thấy như đang sống trong giấc mơ của ai khác.',
                'Hôm nay, tôi thức dậy với cảm giác hoàn toàn khác biệt.',
                'Có những lúc tôi tự hỏi liệu tôi có đang sống đúng với con người thực sự của mình không.',
                'Tôi ngồi bên cửa sổ, nhìn ra thế giới bên ngoài và suy nghĩ về cuộc đời.'
            ];

            let content = openings[Math.floor(Math.random() * openings.length)];
            
            // Tạo nội dung chính
            const paragraphs = Math.floor(wordCount / 200); // Khoảng 200 từ mỗi đoạn
            
            for (let i = 0; i < paragraphs; i++) {
                content += '\n\n' + generateParagraph(stylePrompts, chapterNum, totalChapters);
            }
            
            // Thêm kết thúc chương
            if (chapterNum === totalChapters) {
                content += '\n\nVà tôi biết rằng, dù tương lai có mang đến điều gì, tôi sẽ tiếp tục bước đi với những bài học quý giá mà cuộc sống đã dạy tôi.';
            } else {
                const endings = [
                    'Tôi khép lại ngày hôm nay với những suy nghĩ còn chưa có lời giải.',
                    'Và tôi biết rằng ngày mai sẽ lại là một chương mới trong cuộc đời tôi.',
                    'Tôi mỉm cười, cảm thấy trong lòng có một chút hy vọng le lói.',
                    'Dù biết con đường phía trước còn nhiều thử thách, tôi vẫn sẵn sàng đối mặt.'
                ];
                content += '\n\n' + endings[Math.floor(Math.random() * endings.length)];
            }
            
            return content.trim();
        }

        // Tạo đoạn văn
        function generateParagraph(stylePrompts, chapterNum, totalChapters) {
            const sentences = [
                'Tôi cảm thấy trái tim mình đang rung động khi nghĩ về những kỷ niệm cũ.',
                'Những giọt mưa bên ngoài cửa sổ nhắc tôi nhớ về quê hương xa xôi.',
                'Tôi tự hỏi liệu có ai khác cũng cảm thấy cô đơn như tôi không.',
                'Cuộc sống ở thành phố lớn đôi khi khiến tôi cảm thấy như bị lạc lối.',
                'Tôi nhớ về những ngày thơ ấu khi mọi thứ đều đơn giản và trong sáng.',
                'Có lúc tôi muốn quay trở lại thời điểm mà tôi chưa biết đến nỗi buồn là gì.',
                'Tôi ngồi trong góc quán quen thuộc, quan sát những người qua lại.',
                'Những ánh đèn đường lung linh trong đêm tối khiến tôi suy tư về nhiều điều.'
            ];
            
            const selected = [];
            const numSentences = 3 + Math.floor(Math.random() * 3); // 3-5 câu mỗi đoạn
            
            for (let i = 0; i < numSentences; i++) {
                selected.push(sentences[Math.floor(Math.random() * sentences.length)]);
            }
            
            return selected.join(' ');
        }

        // ===== UTILITY FUNCTIONS =====

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'history') {
                refreshHistory();
            }
        }

        function showGenerationProgress() {
            document.getElementById('aiGenerationProgress').style.display = 'block';
        }

        function hideGenerationProgress() {
            setTimeout(() => {
                document.getElementById('aiGenerationProgress').style.display = 'none';
            }, 2000);
        }

        function updateGenerationStatus(status, percent) {
            document.getElementById('aiGenerationStatus').textContent = status;
            document.getElementById('aiGenerationPercent').textContent = Math.round(percent) + '%';
            document.getElementById('aiGenerationBar').style.width = percent + '%';
        }

        function countWords(text) {
            if (!text) return 0;
            return text.trim().split(/\s+/).length;
        }

        function getWordCount(length) {
            switch (length) {
                case 'short': return 1000;
                case 'medium': return 1750;
                case 'long': return 2750;
                default: return 1750;
            }
        }

        function getStylePrompts(style) {
            const styles = {
                melancholy: ['buồn bã', 'u sầu', 'nặng nề', 'cô đơn'],
                romantic: ['ngọt ngào', 'lãng mạn', 'yêu thương', 'ấm áp'],
                philosophical: ['suy nghĩ', 'triết lý', 'sâu sắc', 'tâm hồn'],
                realistic: ['thực tế', 'đời thường', 'bình dân', 'gần gũi'],
                nostalgic: ['hoài niệm', 'nhớ nhung', 'xa xưa', 'kỷ niệm']
            };
            return styles[style] || styles.melancholy;
        }

        function getStyleName(style) {
            const names = {
                melancholy: 'Buồn bã, nội tâm',
                romantic: 'Lãng mạn, ngọt ngào',
                philosophical: 'Triết lý, sâu sắc',
                realistic: 'Thực tế, gần gũi',
                nostalgic: 'Hoài niệm, nhớ nhung'
            };
            return names[style] || names.melancholy;
        }

        function getGenreFromStyle(style) {
            const genres = {
                melancholy: 'Tâm lý',
                romantic: 'Lãng mạn',
                philosophical: 'Triết lý',
                realistic: 'Đời thường',
                nostalgic: 'Hoài niệm'
            };
            return genres[style] || 'Tâm lý';
        }

        function showAlert(tabId, message, type) {
            const alertElement = document.getElementById(tabId + 'Alert');
            if (alertElement) {
                alertElement.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                alertElement.style.display = 'block';
                
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }

        function updateAllStats() {
            // Manual stories stats
            document.getElementById('totalManualStories').textContent = manualStories.length;
            
            // AI stories stats
            document.getElementById('totalAIStories').textContent = aiStories.length;
            
            // Total chapters
            const totalChapters = manualStories.reduce((sum, story) => sum + story.chapters.length, 0) +
                                 aiStories.reduce((sum, story) => sum + story.chapters.length, 0);
            document.getElementById('totalChapters').textContent = totalChapters;
            
            // Total words
            const totalWords = manualStories.reduce((sum, story) => sum + story.totalWords, 0) +
                              aiStories.reduce((sum, story) => sum + story.totalWords, 0);
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
        }

        function refreshHistory() {
            displayManualStories();
            displayAIStories();
            updateAllStats();
        }

        function displayManualStories() {
            const listElement = document.getElementById('manualStoriesList');
            
            if (manualStories.length === 0) {
                listElement.innerHTML = '<div class="loading">Chưa có truyện thủ công nào</div>';
                return;
            }

            listElement.innerHTML = manualStories.map(story => `
                <div class="story-folder">
                    <div class="folder-header" onclick="toggleFolder('manual_${story.id}')">
                        <div>
                            <div class="folder-title">📖 ${story.title}</div>
                            <div class="folder-meta">${story.author} • ${story.chapters.length} chương • ${story.totalWords.toLocaleString()} từ</div>
                        </div>
                        <button class="folder-toggle">👁️ Xem</button>
                    </div>
                    <div class="folder-content" id="manual_${story.id}">
                        ${story.chapters.map(chapter => `
                            <div class="chapter-item">
                                <div class="chapter-header">
                                    <div class="chapter-title">${chapter.title}</div>
                                    <div class="chapter-meta">${chapter.wordCount} từ</div>
                                </div>
                                <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                                <div class="chapter-actions">
                                    <button class="btn btn-secondary" onclick="viewFullChapter('${story.id}', '${chapter.id}')">👁️ Xem đầy đủ</button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="viewFullStory('${story.id}', 'ai')">📖 Xem toàn bộ truyện</button>
                            <button class="btn btn-danger" onclick="deleteStory('${story.id}', 'ai')">🗑️ Xóa truyện</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle folder display
        function toggleFolder(folderId) {
            const folder = document.getElementById(folderId);
            if (folder) {
                folder.classList.toggle('expanded');
            }
        }

        // View full story
        function viewFullStory(storyId, type) {
            const stories = type === 'manual' ? manualStories : aiStories;
            const story = stories.find(s => s.id === storyId);
            if (story) {
                showStoryModal(story);
            }
        }

        // View full chapter
        function viewFullChapter(storyId, chapterId) {
            const story = [...manualStories, ...aiStories].find(s => s.id === storyId);
            const chapter = story ? story.chapters.find(c => c.id === chapterId) : null;
            
            if (chapter) {
                showChapterModal(chapter, story.title);
            }
        }

        // Show story modal
        function showStoryModal(story) {
            const modal = document.getElementById('storyModal');
            const title = document.getElementById('modalStoryTitle');
            const content = document.getElementById('modalStoryContent');

            title.textContent = story.title;
            
            const fullContent = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div><strong>Tác giả:</strong> ${story.author}</div>
                    <div><strong>Thể loại:</strong> ${story.genre}</div>
                    <div><strong>Số chương:</strong> ${story.chapters.length}</div>
                    <div><strong>Tổng từ:</strong> ${story.totalWords.toLocaleString()}</div>
                    ${story.description ? `<div style="margin-top: 10px;"><em>${story.description}</em></div>` : ''}
                </div>
                ${story.chapters.map((chapter, index) => `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #007bff; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;">
                            ${chapter.title}
                        </h4>
                        <div style="line-height: 1.8; text-align: justify;">
                            ${chapter.content.replace(/\n/g, '<br><br>')}
                        </div>
                        <div style="text-align: right; margin-top: 15px; font-size: 14px; color: #666;">
                            ${chapter.wordCount} từ • ${new Date(chapter.createdAt).toLocaleString('vi-VN')}
                        </div>
                    </div>
                `).join('')}
            `;

            content.innerHTML = fullContent;
            modal.style.display = 'block';
        }

        // Show chapter modal
        function showChapterModal(chapter, storyTitle) {
            const modal = document.getElementById('storyModal');
            const title = document.getElementById('modalStoryTitle');
            const content = document.getElementById('modalStoryContent');

            title.textContent = `${storyTitle} - ${chapter.title}`;
            
            content.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div><strong>Chương:</strong> ${chapter.title}</div>
                    <div><strong>Số từ:</strong> ${chapter.wordCount}</div>
                    <div><strong>Ngày tạo:</strong> ${new Date(chapter.createdAt).toLocaleString('vi-VN')}</div>
                </div>
                <div style="line-height: 1.8; text-align: justify;">
                    ${chapter.content.replace(/\n/g, '<br><br>')}
                </div>
            `;

            modal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('storyModal').style.display = 'none';
        }

        // Delete story
        function deleteStory(storyId, type) {
            const stories = type === 'manual' ? manualStories : aiStories;
            const story = stories.find(s => s.id === storyId);
            
            if (story && confirm(`Bạn có chắc chắn muốn xóa truyện "${story.title}"?`)) {
                if (type === 'manual') {
                    manualStories = manualStories.filter(s => s.id !== storyId);
                    if (currentManualStory && currentManualStory.id === storyId) {
                        currentManualStory = null;
                        updateCurrentStoryDisplay();
                    }
                } else {
                    aiStories = aiStories.filter(s => s.id !== storyId);
                }
                
                refreshHistory();
                showAlert('history', `Đã xóa truyện "${story.title}"`, 'success');
            }
        }

        // Edit chapter (for manual stories)
        function editChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                document.getElementById('manualChapterTitle').value = chapter.title;
                document.getElementById('manualChapterContent').value = chapter.content;
                
                // Remove the chapter from the story temporarily
                currentManualStory.chapters = currentManualStory.chapters.filter(c => c.id !== chapterId);
                currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);
                
                updateCurrentStoryDisplay();
                showAlert('manual', `Đang chỉnh sửa chương "${chapter.title}"`, 'info');
            }
        }

        // View chapter (for current manual story)
        function viewChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                showChapterModal(chapter, currentManualStory.title);
            }
        }

        // Delete chapter (for current manual story)
        function deleteChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter && confirm(`Bạn có chắc chắn muốn xóa chương "${chapter.title}"?`)) {
                currentManualStory.chapters = currentManualStory.chapters.filter(c => c.id !== chapterId);
                currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);
                
                // Update chapter numbers
                currentManualStory.chapters.forEach((ch, index) => {
                    ch.chapterNumber = index + 1;
                });
                
                updateCurrentStoryDisplay();
                showAlert('manual', `Đã xóa chương "${chapter.title}"`, 'success');
            }
        }

        // View AI chapter
        function viewAIChapter(chapterId) {
            if (!currentAIStory) return;
            
            const chapter = currentAIStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                showChapterModal(chapter, currentAIStory.title);
            }
        }

        // Regenerate AI chapter
        async function regenerateAIChapter(chapterId) {
            if (!currentAIStory) return;
            
            const chapter = currentAIStory.chapters.find(c => c.id === chapterId);
            if (!chapter) return;
            
            if (!confirm(`Bạn có chắc chắn muốn viết lại chương "${chapter.title}"?`)) return;
            
            showAlert('ai', `Đang viết lại chương "${chapter.title}"...`, 'info');
            
            try {
                const newContent = await generateChapter(
                    currentAIStory.prompt,
                    currentAIStory.style,
                    'medium',
                    chapter.chapterNumber,
                    currentAIStory.chapters.length
                );
                
                const oldWordCount = chapter.wordCount;
                chapter.content = newContent;
                chapter.wordCount = countWords(newContent);
                
                // Update total words
                currentAIStory.totalWords = currentAIStory.totalWords - oldWordCount + chapter.wordCount;
                
                displayAIStory();
                showAlert('ai', `Đã viết lại chương "${chapter.title}"!`, 'success');
                
            } catch (error) {
                console.error('Error regenerating chapter:', error);
                showAlert('ai', 'Lỗi khi viết lại chương: ' + error.message, 'error');
            }
        }

        // Load stories from memory (placeholder for localStorage functionality)
        function loadStoriesFromMemory() {
            // In a real environment, this would load from localStorage
            // For now, we'll start with empty arrays
            manualStories = [];
            aiStories = [];
        }

        // Training functions (simplified)
        async function startFullTraining() {
            showAlert('training', 'Đang huấn luyện AI từ dữ liệu...', 'info');
            
            try {
                // Simulate training process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Update training data with sample data
                aiTrainingData = {
                    stories: [...manualStories, ...aiStories],
                    vocabulary: new Set(['tôi', 'cuộc sống', 'thành phố', 'trái tim', 'yêu thương', 'nhớ nhung', 'hoài niệm']),
                    patterns: ['Tôi cảm thấy', 'Tôi nhớ về', 'Tôi không thể', 'Tôi muốn'],
                    trainedStories: manualStories.length + aiStories.length + 5,
                    accuracy: 85
                };
                
                updateTrainingStats();
                showAlert('training', 'AI đã được huấn luyện thành công!', 'success');
                
            } catch (error) {
                showAlert('training', 'Lỗi khi huấn luyện AI: ' + error.message, 'error');
            }
        }

        async function startQuickTraining() {
            showAlert('training', 'Đang huấn luyện nhanh...', 'info');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                aiTrainingData = {
                    stories: [],
                    vocabulary: new Set(['tôi', 'cuộc sống', 'cảm xúc']),
                    patterns: ['Tôi cảm thấy', 'Tôi nghĩ'],
                    trainedStories: 3,
                    accuracy: 60
                };
                
                updateTrainingStats();
                showAlert('training', 'Huấn luyện nhanh hoàn tất!', 'success');
                
            } catch (error) {
                showAlert('training', 'Lỗi khi huấn luyện nhanh: ' + error.message, 'error');
            }
        }

        async function testAI() {
            if (aiTrainingData.trainedStories === 0) {
                showAlert('training', 'Vui lòng huấn luyện AI trước khi kiểm tra', 'error');
                return;
            }
            
            showAlert('training', 'AI hoạt động bình thường. Sẵn sàng tạo truyện!', 'success');
        }

        function updateTrainingStats() {
            document.getElementById('totalDataSources').textContent = aiTrainingData.trainedStories;
            document.getElementById('totalTrainingWords').textContent = aiTrainingData.vocabulary.size.toLocaleString();
            document.getElementById('uniquePhrases').textContent = aiTrainingData.patterns.length;
            document.getElementById('aiReadiness').textContent = aiTrainingData.accuracy + '%';
        }

        // Initialize app when page loads
        window.addEventListener('load', initializeApp);

        // Make functions available globally for onclick handlers
        window.toggleFolder = toggleFolder;
        window.viewFullStory = viewFullStory;
        window.viewFullChapter = viewFullChapter;
        window.deleteStory = deleteStory;
        window.editChapter = editChapter;
        window.viewChapter = viewChapter;
        window.deleteChapter = deleteChapter;
        window.viewAIChapter = viewAIChapter;
        window.regenerateAIChapter = regenerateAIChapter;
        window.closeModal = closeModal;

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('storyModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
                                <div class="chapter-header">
                                    <div class="chapter-title">${chapter.title}</div>
                                    <div class="chapter-meta">${chapter.wordCount} từ</div>
                                </div>
                                <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                                <div class="chapter-actions">
                                    <button class="btn btn-secondary" onclick="viewFullChapter('${story.id}', '${chapter.id}')">👁️ Xem đầy đủ</button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="viewFullStory('${story.id}', 'manual')">📖 Xem toàn bộ truyện</button>
                            <button class="btn btn-danger" onclick="deleteStory('${story.id}', 'manual')">🗑️ Xóa truyện</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayAIStories() {
            const listElement = document.getElementById('aiStoriesList');
            
            if (aiStories.length === 0) {
                listElement.innerHTML = '<div class="loading">Chưa có truyện AI nào</div>';
                return;
            }

            listElement.innerHTML = aiStories.map(story => `
                <div class="story-folder">
                    <div class="folder-header" onclick="toggleFolder('ai_${story.id}')">
                        <div>
                            <div class="folder-title">🤖 ${story.title}</div>
                            <div class="folder-meta">${getStyleName(story.style)} • ${story.chapters.length} chương • ${story.totalWords.toLocaleString()} từ</div>
                        </div>
                        <button class="folder-toggle">👁️ Xem</button>
                    </div>
                    <div class="folder-content" id="ai_${story.id}">
                        ${story.chapters.map(chapter => `
                            <div class="chapter-item">
