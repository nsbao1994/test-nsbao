<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Quản Lý Truyện — Phân tích + Viết + Đọc</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
 

  <style>
    :root {
      --primary-color: #9b59b6;
      --secondary-color: #2980b9;
      --dark-color: #1e1e1e;
      --light-color: #bdc3c7;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --text-color: #ecf0f1;
      --card-bg: rgba(30, 30, 30, 0.95);
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#121212;color:var(--text-color);font-family:sans-serif;min-height:100vh;}
    .container{padding:16px;padding-bottom:80px;}
    .header{text-align:center;margin-bottom:20px;}
    .card{background:var(--card-bg);border-radius:var(--border-radius);padding:20px;margin-bottom:20px;}
    .bottom-menu{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;padding:12px;background:#2c3e50;}
    .menu-item{color:var(--light-color);text-decoration:none;font-size:0.9rem;opacity:0.7;}
    .menu-item.active{opacity:1;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .btn{background:var(--primary-color);color:#fff;border:none;padding:10px 16px;border-radius:8px;margin:4px;cursor:pointer;}
    .btn:disabled{background:#777;cursor:not-allowed;}
    .story-content{background:#1e1e1e;padding:12px;border-radius:8px;margin:8px 0;max-height:50vh;overflow-y:auto;white-space:pre-line;}
    select{padding:6px;border-radius:6px;margin:6px 0;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📖 Quản Lý Truyện</h1>
    <p>Phân tích, Viết truyện & Đọc truyện từ Google Drive</p>
  </div>

  <!-- TAB PHÂN TÍCH -->
  <div id="tab-analysis" class="tab-content active">
    <div class="card">
      <h3>🔍 Phân tích nguồn truyện</h3>
      <div id="statusInfo">🔴 Chưa kết nối Google Drive</div>
      <div id="detailedStatus"></div>
      <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:0%"></div></div>
      <button class="btn" onclick="handleAuthClick()">📁 Kết nối Google Drive</button>
      <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>🔍 Quét thư mục</button>
      <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>🧠 Phân tích</button>
    </div>
    <div class="card">
      <h3>📊 Kết quả phân tích</h3>
      <div id="analysisResults"><p>Chưa có dữ liệu phân tích.</p></div>
    </div>
  </div>

  <!-- TAB VIẾT TRUYỆN -->
  <div id="tab-write" class="tab-content">
    <div class="card">
      <h3>✍️ Tạo truyện mới</h3>
      <button class="btn" onclick="generateStory()">🚀 Sinh truyện từ phân tích</button>
      <button class="btn" onclick="saveStoryToDrive()">☁️ Lưu lên Drive</button>
    </div>
    <div class="card">
      <h3>📖 Truyện đã tạo</h3>
      <div id="generatedStory">Chưa có truyện.</div>
    </div>
  </div>

  <!-- TAB ĐỌC TRUYỆN -->
  <div id="tab-read" class="tab-content">
    <div class="card">
      <h3>📂 Chọn truyện để đọc</h3>
      <select id="storySelect"></select>
      <button class="btn" onclick="loadSelectedStory()">📖 Đọc</button>
    </div>
    <div class="card">
      <h3>📖 Nội dung</h3>
      <div id="readerContent" class="story-content">Chưa chọn truyện.</div>
    </div>
  </div>
</div>

<div class="bottom-menu">
  <a href="#" class="menu-item active" onclick="switchTab('tab-analysis', event)">🔍 Phân tích</a>
  <a href="#" class="menu-item" onclick="switchTab('tab-write', event)">✍️ Viết</a>
  <a href="#" class="menu-item" onclick="switchTab('tab-read', event)">📖 Đọc</a>
</div>

<script>
// ===== GOOGLE API CONFIG =====
const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/drive";
const ROOT_FOLDER_NAME = "QuanLyTruyen";

let tokenClient, gapi_inited = false, gsi_inited = false;
let txtFiles = [];
let analysisData = [];
let generatedStoryData = null;

// ===== INIT GOOGLE API =====
function gapiLoaded(){ gapi.load("client", initializeGapiClient); }
async function initializeGapiClient(){
  await gapi.client.init({ apiKey: API_KEY, discoveryDocs:[DISCOVERY_DOC] });
  gapi_inited = true; maybeEnableButtons();
}
function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback:"" });
  gsi_inited = true; maybeEnableButtons();
}
function maybeEnableButtons(){ if(gapi_inited && gsi_inited){ document.getElementById("scanBtn").disabled = false; } }
function handleAuthClick(){
  tokenClient.callback = async (resp)=>{
    if(resp.error) throw(resp);
    gapi.client.setToken({access_token: resp.access_token});
    updateStatus("🟢 Đã kết nối Google Drive");
    document.getElementById("scanBtn").disabled = false;
  };
  if(gapi.client.getToken()===null){ tokenClient.requestAccessToken({prompt:"consent"}); }
  else { tokenClient.requestAccessToken({prompt:""}); }
}

// ===== UI HELPERS =====
function updateStatus(msg){ document.getElementById("statusInfo").innerText = msg; }
function updateProgress(p){ document.getElementById("progressBar").style.width = p+"%"; }

// ===== SCAN DRIVE =====
async function scanFolder(){
  updateStatus("🔍 Đang quét thư mục...");
  const folderRes = await gapi.client.drive.files.list({
    q:`mimeType='application/vnd.google-apps.folder' and name='${ROOT_FOLDER_NAME}' and trashed=false`,
    fields:"files(id,name)"
  });
  if(!folderRes.result.files.length){ updateStatus("❌ Không tìm thấy thư mục QuanLyTruyen"); return; }
  txtFiles = [];
  await fetchFilesRecursive(folderRes.result.files[0].id, ROOT_FOLDER_NAME);
  if(!txtFiles.length){ updateStatus("⚠️ Không có file .txt"); return; }
  updateStatus(`✅ Đã quét ${txtFiles.length} file`);
  document.getElementById("analyzeBtn").disabled = false;
  fillStorySelect();
}
async function fetchFilesRecursive(folderId, path){
  let pageToken=null;
  do{
    const res = await gapi.client.drive.files.list({
      q:`'${folderId}' in parents and trashed=false`,
      fields:"nextPageToken, files(id,name,mimeType)", pageToken
    });
    for(const f of res.result.files){
      if(f.mimeType==="application/vnd.google-apps.folder"){
        await fetchFilesRecursive(f.id, path+"/"+f.name);
      } else if(f.mimeType==="text/plain"||f.name.endsWith(".txt")){
        txtFiles.push({id:f.id,name:f.name,path});
      }
    }
    pageToken=res.result.nextPageToken;
  }while(pageToken);
}


// ===== ANALYZE FILES =====
async function analyzeFiles() {
  if (!txtFiles.length) {
    alert("⚠️ Vui lòng quét thư mục trước!");
    return;
  }

  analysisData = [];
  updateStatus(`🧠 Bắt đầu phân tích ${txtFiles.length} file...`);

  for (let i = 0; i < txtFiles.length; i++) {
    updateProgress((i / txtFiles.length) * 100);
    document.getElementById("detailedStatus").innerText =
      `Đang phân tích: ${txtFiles[i].name} (${i + 1}/${txtFiles.length})`;

    try {
      const content = await readFileFromDrive(txtFiles[i].id);
      const wordCount = content.split(/\s+/).length;
      analysisData.push({
        file: txtFiles[i].name,
        path: txtFiles[i].path,
        words: wordCount,
        sample: content.substring(0, 200) + (content.length > 200 ? "..." : "")
      });
    } catch (err) {
      console.error("Lỗi phân tích:", err);
      analysisData.push({
        file: txtFiles[i].name,
        error: err.message
      });
    }
  }

  updateProgress(100);
  setTimeout(() => updateProgress(0), 2000);

  displayAnalysis();
  updateStatus("✅ Hoàn thành phân tích!");
}


async function readFileFromDrive(fileId){
  const accessToken = gapi.client.getToken().access_token;
  const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,{headers:{Authorization:`Bearer ${accessToken}`}});
  return await r.text();
}
function displayAnalysis(){
  let html = `<h4>Đã phân tích ${analysisData.length} file</h4>`;
  analysisData.forEach(d=>{ html+=`<div class='story-content'><b>${d.file}</b><br/>Số từ: ${d.words}<br/>Mẫu: ${d.sample}...</div>`; });
  document.getElementById("analysisResults").innerHTML=html;
}

// ===== VIẾT TRUYỆN =====
function generateStory(){
  if(!analysisData.length){ alert("Chưa có dữ liệu phân tích"); return; }
  let title = "Truyện Mới " + new Date().toLocaleTimeString();
  let chapters = [];
  for(let i=1;i<=50;i++) chapters.push(`Chương ${i}: Nội dung giả lập dựa trên phân tích...`);
  generatedStoryData = {title, chapters};
  document.getElementById("generatedStory").innerHTML = `<h4>${title}</h4>` + chapters.map(c=>`<p>${c}</p>`).join("");
}
async function saveStoryToDrive(){
  if(!generatedStoryData){ alert("Chưa có truyện"); return; }
  const content = generatedStoryData.title+"\n\n"+generatedStoryData.chapters.join("\n\n");
  const blob = new Blob([content],{type:"text/plain"});
  const metadata={name:generatedStoryData.title+".txt", mimeType:"text/plain"};
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)],{type:"application/json"}));
  form.append("file", blob);
  const accessToken=gapi.client.getToken().access_token;
  await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{
    method:"POST", headers:{Authorization:"Bearer "+accessToken}, body:form
  });
  alert("✅ Đã lưu truyện lên Drive");
}

// ===== ĐỌC TRUYỆN =====
function fillStorySelect(){
  const sel=document.getElementById("storySelect"); sel.innerHTML="";
  txtFiles.forEach(f=>{ let opt=document.createElement("option"); opt.value=f.id; opt.text=f.path+"/"+f.name; sel.appendChild(opt); });
}
async function loadSelectedStory(){
  const sel=document.getElementById("storySelect");
  if(!sel.value){ alert("Chưa chọn truyện"); return; }
  let text = await readFileFromDrive(sel.value);
  document.getElementById("readerContent").innerText=text;
}

// ===== TAB SWITCH =====
function switchTab(id,e){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  e.target.classList.add('active');
}
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
