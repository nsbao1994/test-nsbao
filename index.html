<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Writer - Enhanced</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            min-width: 120px;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .story-input-area {
            min-height: 400px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
        }

        .chapter-input-area {
            min-height: 300px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .file-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .chapter-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chapter-title {
            font-weight: bold;
            color: #007bff;
        }

        .chapter-meta {
            font-size: 12px;
            color: #666;
        }

        .chapter-preview {
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .story-folder {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .folder-title {
            font-weight: bold;
            color: #333;
        }

        .folder-meta {
            font-size: 12px;
            color: #666;
        }

        .folder-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .folder-content.expanded {
            display: block;
        }

        .folder-toggle {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .tabs {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                margin-right: 0;
            }
            .chapter-actions,
            .folder-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Story Writer Enhanced</h1>
            <p>Vi·∫øt truy·ªán th·ªß c√¥ng v√† AI v·ªõi qu·∫£n l√Ω ch∆∞∆°ng chuy√™n nghi·ªáp</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="manual">üìù Vi·∫øt th·ªß c√¥ng</button>
                <button class="tab" data-tab="ai">ü§ñ AI vi·∫øt truy·ªán</button>
                <button class="tab" data-tab="history">üìö L·ªãch s·ª≠ truy·ªán</button>
                <button class="tab" data-tab="training">üß† Hu·∫•n luy·ªán AI</button>
                <button class="tab" data-tab="drive">‚òÅÔ∏è Google Drive</button>
            </div>

            <!-- Tab Vi·∫øt th·ªß c√¥ng -->
            <div class="tab-content active" data-content="manual">
                <div class="section">
                    <h3>üìñ Th√¥ng tin truy·ªán</h3>
                    <div class="form-group">
                        <label>T√™n truy·ªán</label>
                        <input type="text" id="manualStoryTitle" placeholder="Nh·∫≠p t√™n truy·ªán c·ªßa b·∫°n...">
                    </div>
                    <div class="form-group">
                        <label>T√°c gi·∫£</label>
                        <input type="text" id="manualAuthorName" placeholder="T√™n t√°c gi·∫£...">
                    </div>
                    <div class="form-group">
                        <label>Th·ªÉ lo·∫°i</label>
                        <select id="manualStoryGenre">
                            <option value="romance">L√£ng m·∫°n</option>
                            <option value="drama">T√¢m l√Ω</option>
                            <option value="adventure">Phi√™u l∆∞u</option>
                            <option value="mystery">B√≠ ·∫©n</option>
                            <option value="fantasy">Gi·∫£ t∆∞·ªüng</option>
                            <option value="slice_of_life">ƒê·ªùi th∆∞·ªùng</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>M√¥ t·∫£ ng·∫Øn</label>
                        <textarea id="manualStoryDescription" placeholder="Vi·∫øt m√¥ t·∫£ ng·∫Øn v·ªÅ truy·ªán..." rows="3"></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3>üìÑ Vi·∫øt ch∆∞∆°ng</h3>
                    <div class="form-group">
                        <label>T√™n ch∆∞∆°ng</label>
                        <input type="text" id="manualChapterTitle" placeholder="T·ª± ƒë·ªông: Ch∆∞∆°ng 1, Ch∆∞∆°ng 2... ho·∫∑c nh·∫≠p t√™n t√πy ch·ªânh">
                    </div>
                    <div class="form-group">
                        <label>N·ªôi dung ch∆∞∆°ng</label>
                        <textarea id="manualChapterContent" class="chapter-input-area" placeholder="Vi·∫øt n·ªôi dung ch∆∞∆°ng t·∫°i ƒë√¢y...

V√≠ d·ª•:
T√¥i b∆∞·ªõc ra kh·ªèi t√≤a nh√† vƒÉn ph√≤ng v·ªõi t√¢m tr·∫°ng n·∫∑ng n·ªÅ. H√† N·ªôi h√¥m nay se l·∫°nh, gi·ªëng nh∆∞ tr√°i tim t√¥i v·∫≠y. C√¥ng vi·ªác v·ª´a m·∫•t, t√¨nh y√™u c≈©ng tan v·ª°. T√¥i kh√¥ng bi·∫øt m√¨nh s·∫Ω ƒëi v·ªÅ ƒë√¢u trong th√†nh ph·ªë r·ªông l·ªõn n√†y.

Nh·ªØng gi·ªçt m∆∞a nh·ªè b·∫Øt ƒë·∫ßu r∆°i, ∆∞·ªõt vai √°o t√¥i. T√¥i ƒë·ª©ng gi·ªØa ph·ªë, nh√¨n nh·ªØng ng∆∞·ªùi qua l·∫°i v·ªõi v·∫ª t√¨m ch·ªó tr√∫ m∆∞a. Ch·ªâ c√≥ t√¥i, m·ªôt m√¨nh, ƒë·ª©ng ƒë√≥ nh∆∞ m·ªôt k·∫ª l·∫°c l·ªëi..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="saveChapterBtn">üíæ L∆∞u ch∆∞∆°ng</button>
                        <button class="btn btn-primary" id="addNewChapterBtn">‚ûï Ch∆∞∆°ng m·ªõi</button>
                        <button class="btn btn-secondary" id="clearChapterBtn">üóëÔ∏è X√≥a n·ªôi dung</button>
                        <button class="btn btn-warning" id="previewStoryBtn">üëÅÔ∏è Xem tr∆∞·ªõc to√†n b·ªô</button>
                    </div>
                </div>

                <div class="section" id="currentStoryInfo" style="display: none;">
                    <h3>üìä Th√¥ng tin truy·ªán hi·ªán t·∫°i</h3>
                    <div id="currentStoryStats"></div>
                    <div id="currentChaptersList"></div>
                </div>

                <div id="manualAlert" style="display: none;"></div>
            </div>

            <!-- Tab AI vi·∫øt truy·ªán -->
            <div class="tab-content" data-content="ai">
                <div class="section">
                    <h3>ü§ñ C√†i ƒë·∫∑t AI vi·∫øt truy·ªán</h3>
                    <div class="form-group">
                        <label>Ch·ªß ƒë·ªÅ/√ù t∆∞·ªüng truy·ªán</label>
                        <textarea id="aiStoryPrompt" placeholder="V√≠ d·ª•: T√¥i l√† m·ªôt sinh vi√™n ƒë·∫°i h·ªçc s·ªëng ·ªü H√† N·ªôi, g·∫∑p kh√≥ khƒÉn trong cu·ªôc s·ªëng v√† t√¨nh y√™u. Vi·∫øt v·ªÅ nh·ªØng tr·∫£i nghi·ªám c·ªßa t√¥i trong th√†nh ph·ªë l·ªõn..." rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phong c√°ch vi·∫øt</label>
                        <select id="aiWritingStyle">
                            <option value="melancholy">Bu·ªìn b√£, n·ªôi t√¢m</option>
                            <option value="romantic">L√£ng m·∫°n, ng·ªçt ng√†o</option>
                            <option value="philosophical">Tri·∫øt l√Ω, s√¢u s·∫Øc</option>
                            <option value="realistic">Th·ª±c t·∫ø, g·∫ßn g≈©i</option>
                            <option value="nostalgic">Ho√†i ni·ªám, nh·ªõ nhung</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ƒê·ªô d√†i m·ªói ch∆∞∆°ng (s·ªë t·ª´)</label>
                        <select id="aiChapterLength">
                            <option value="short">Ng·∫Øn (800-1200 t·ª´)</option>
                            <option value="medium" selected>Trung b√¨nh (1500-2000 t·ª´)</option>
                            <option value="long">D√†i (2500-3000 t·ª´)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>S·ªë ch∆∞∆°ng mu·ªën t·∫°o</label>
                        <input type="number" id="aiNumberOfChapters" value="3" min="1" max="20">
                    </div>
                    <button class="btn btn-success" id="generateAIStoryBtn">‚ú® T·∫°o truy·ªán b·∫±ng AI</button>
                </div>

                <div class="section" id="aiGenerationProgress" style="display: none;">
                    <h3>‚è≥ Ti·∫øn ƒë·ªô t·∫°o truy·ªán</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span id="aiGenerationStatus">ƒêang kh·ªüi t·∫°o...</span>
                            <span id="aiGenerationPercent">0%</span>
                        </div>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="aiGenerationBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div class="section" id="aiGeneratedStory" style="display: none;">
                    <h3>üìñ Truy·ªán AI ƒë√£ t·∫°o</h3>
                    <div id="aiStoryDetails"></div>
                    <div id="aiChaptersList"></div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" id="saveAIStoryBtn">üíæ L∆∞u truy·ªán v√†o l·ªãch s·ª≠</button>
                        <button class="btn btn-success" id="continueAIStoryBtn">üìù Vi·∫øt th√™m ch∆∞∆°ng</button>
                        <button class="btn btn-secondary" id="regenerateChapterBtn" style="display: none;">üîÑ Vi·∫øt l·∫°i ch∆∞∆°ng n√†y</button>
                    </div>
                </div>

                <div id="aiAlert" style="display: none;"></div>
            </div>

            <!-- Tab L·ªãch s·ª≠ truy·ªán -->
            <div class="tab-content" data-content="history">
                <div class="section">
                    <h3>üìö L·ªãch s·ª≠ truy·ªán</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalManualStories">0</div>
                            <div class="stat-label">Truy·ªán th·ªß c√¥ng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalAIStories">0</div>
                            <div class="stat-label">Truy·ªán AI</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalChapters">0</div>
                            <div class="stat-label">T·ªïng ch∆∞∆°ng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalWords">0</div>
                            <div class="stat-label">T·ªïng t·ª´</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>‚úçÔ∏è Truy·ªán vi·∫øt th·ªß c√¥ng</h3>
                    <div id="manualStoriesList" class="file-list">
                        <div class="loading">Ch∆∞a c√≥ truy·ªán th·ªß c√¥ng n√†o</div>
                    </div>
                </div>

                <div class="section">
                    <h3>ü§ñ Truy·ªán t·∫°o b·∫±ng AI</h3>
                    <div id="aiStoriesList" class="file-list">
                        <div class="loading">Ch∆∞a c√≥ truy·ªán AI n√†o</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="refreshHistoryBtn">üîÑ L√†m m·ªõi</button>
                    <button class="btn btn-success" id="exportAllBtn">üì§ Xu·∫•t t·∫•t c·∫£</button>
                </div>

                <div id="historyAlert" style="display: none;"></div>
            </div>

            <!-- Tab Hu·∫•n luy·ªán AI (gi·ªØ nguy√™n nh∆∞ c≈©) -->
            <div class="tab-content" data-content="training">
                <div class="section">
                    <h3>üß† Hu·∫•n luy·ªán AI chuy√™n s√¢u</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        AI s·∫Ω h·ªçc t·ª´ t·∫•t c·∫£ c√°c ngu·ªìn d·ªØ li·ªáu ƒë·ªÉ vi·∫øt truy·ªán theo phong c√°ch ri√™ng c·ªßa b·∫°n
                    </p>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalDataSources">0</div>
                            <div class="stat-label">Ngu·ªìn d·ªØ li·ªáu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTrainingWords">0</div>
                            <div class="stat-label">T·ªïng t·ª´ ƒë√£ h·ªçc</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uniquePhrases">0</div>
                            <div class="stat-label">C·ª•m t·ª´ ƒë·ªôc ƒë√°o</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="aiReadiness">0%</div>
                            <div class="stat-label">S·∫µn s√†ng vi·∫øt</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üöÄ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán</h3>
                    <button class="btn btn-primary" id="startTrainingBtn">üß† Hu·∫•n luy·ªán AI ƒë·∫ßy ƒë·ªß</button>
                    <button class="btn btn-success" id="quickTrainingBtn">‚ö° Hu·∫•n luy·ªán nhanh</button>
                    <button class="btn btn-secondary" id="testAIBtn">üß™ Ki·ªÉm tra AI</button>
                </div>

                <div id="trainingAlert" style="display: none;"></div>
            </div>

            <!-- Tab Google Drive (gi·ªØ nguy√™n nh∆∞ c≈©) -->
            <div class="tab-content" data-content="drive">
                <div class="section">
                    <h3>Tr·∫°ng th√°i k·∫øt n·ªëi</h3>
                    <p>
                        <span class="status-indicator status-disconnected" id="driveStatusIndicator"></span>
                        <span id="driveStatusText">Ch∆∞a k·∫øt n·ªëi v·ªõi Google Drive</span>
                    </p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" id="connectGoogleDriveBtn">üîó K·∫øt n·ªëi Google Drive</button>
                        <button class="btn btn-danger" id="disconnectGoogleDriveBtn" style="display: none;">‚ùå Ng·∫Øt k·∫øt n·ªëi</button>
                    </div>
                </div>

                <div id="driveAlert" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal xem chi ti·∫øt truy·ªán -->
    <div id="storyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalStoryTitle">Chi ti·∫øt truy·ªán</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalStoryContent">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load ƒë·ªông -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentManualStory = null;
        let currentAIStory = null;
        let manualStories = []; // Truy·ªán vi·∫øt th·ªß c√¥ng
        let aiStories = []; // Truy·ªán t·∫°o b·∫±ng AI
        let aiTrainingData = {
            stories: [],
            vocabulary: new Set(),
            patterns: [],
            trainedStories: 0,
            accuracy: 0
        };

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        function initializeApp() {
            setupEventListeners();
            loadStoriesFromMemory();
            updateAllStats();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Manual writing events
            document.getElementById('saveChapterBtn').addEventListener('click', saveManualChapter);
            document.getElementById('addNewChapterBtn').addEventListener('click', addNewChapter);
            document.getElementById('clearChapterBtn').addEventListener('click', clearChapter);
            document.getElementById('previewStoryBtn').addEventListener('click', previewCurrentStory);

            // AI writing events
            document.getElementById('generateAIStoryBtn').addEventListener('click', generateAIStory);
            document.getElementById('saveAIStoryBtn').addEventListener('click', saveAIStoryToHistory);
            document.getElementById('continueAIStoryBtn').addEventListener('click', continueAIStory);

            // Training events
            document.getElementById('startTrainingBtn').addEventListener('click', startFullTraining);
            document.getElementById('quickTrainingBtn').addEventListener('click', startQuickTraining);
            document.getElementById('testAIBtn').addEventListener('click', testAI);

            // History events
            document.getElementById('refreshHistoryBtn').addEventListener('click', refreshHistory);
        }

        // ===== MANUAL WRITING FUNCTIONS =====

        // L∆∞u ch∆∞∆°ng th·ªß c√¥ng
        function saveManualChapter() {
            const storyTitle = document.getElementById('manualStoryTitle').value.trim();
            const author = document.getElementById('manualAuthorName').value.trim() || '·∫®n danh';
            const genre = document.getElementById('manualStoryGenre').value;
            const description = document.getElementById('manualStoryDescription').value.trim();
            const chapterTitle = document.getElementById('manualChapterTitle').value.trim();
            const chapterContent = document.getElementById('manualChapterContent').value.trim();

            if (!storyTitle) {
                showAlert('manual', 'Vui l√≤ng nh·∫≠p t√™n truy·ªán', 'error');
                return;
            }

            if (!chapterContent) {
                showAlert('manual', 'Vui l√≤ng nh·∫≠p n·ªôi dung ch∆∞∆°ng', 'error');
                return;
            }

            // T√¨m ho·∫∑c t·∫°o truy·ªán
            if (!currentManualStory || currentManualStory.title !== storyTitle) {
                currentManualStory = {
                    id: 'manual_' + Date.now(),
                    title: storyTitle,
                    author: author,
                    genre: genre,
                    description: description,
                    chapters: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    totalWords: 0,
                    type: 'manual'
                };
            }

            // T·∫°o ch∆∞∆°ng m·ªõi
            const chapterNumber = currentManualStory.chapters.length + 1;
            const finalChapterTitle = chapterTitle || `Ch∆∞∆°ng ${chapterNumber}`;
            const wordCount = countWords(chapterContent);

            const chapter = {
                id: 'chapter_' + Date.now(),
                title: finalChapterTitle,
                content: chapterContent,
                wordCount: wordCount,
                createdAt: new Date().toISOString(),
                chapterNumber: chapterNumber
            };

            currentManualStory.chapters.push(chapter);
            currentManualStory.updatedAt = new Date().toISOString();
            currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);

            // C·∫≠p nh·∫≠t danh s√°ch truy·ªán th·ªß c√¥ng
            const existingIndex = manualStories.findIndex(s => s.title === storyTitle);
            if (existingIndex >= 0) {
                manualStories[existingIndex] = currentManualStory;
            } else {
                manualStories.push(currentManualStory);
            }

            // Reset form
            document.getElementById('manualChapterTitle').value = '';
            document.getElementById('manualChapterContent').value = '';

            updateCurrentStoryDisplay();
            updateAllStats();
            showAlert('manual', `ƒê√£ l∆∞u "${finalChapterTitle}" v√†o truy·ªán "${storyTitle}"`, 'success');
        }

        // Th√™m ch∆∞∆°ng m·ªõi
        function addNewChapter() {
            if (!currentManualStory) {
                showAlert('manual', 'Vui l√≤ng l∆∞u ch∆∞∆°ng ƒë·∫ßu ti√™n tr∆∞·ªõc', 'error');
                return;
            }

            document.getElementById('manualChapterTitle').value = '';
            document.getElementById('manualChapterContent').value = '';
            document.getElementById('manualChapterContent').focus();
            showAlert('manual', 'S·∫µn s√†ng vi·∫øt ch∆∞∆°ng m·ªõi!', 'info');
        }

        // X√≥a n·ªôi dung ch∆∞∆°ng
        function clearChapter() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n·ªôi dung ch∆∞∆°ng hi·ªán t·∫°i?')) {
                document.getElementById('manualChapterTitle').value = '';
                document.getElementById('manualChapterContent').value = '';
                showAlert('manual', 'ƒê√£ x√≥a n·ªôi dung ch∆∞∆°ng', 'info');
            }
        }

        // Xem tr∆∞·ªõc to√†n b·ªô truy·ªán
        function previewCurrentStory() {
            if (!currentManualStory || currentManualStory.chapters.length === 0) {
                showAlert('manual', 'Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë·ªÉ xem tr∆∞·ªõc', 'error');
                return;
            }

            showStoryModal(currentManualStory);
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã truy·ªán hi·ªán t·∫°i
        function updateCurrentStoryDisplay() {
            const infoSection = document.getElementById('currentStoryInfo');
            const statsDiv = document.getElementById('currentStoryStats');
            const chaptersDiv = document.getElementById('currentChaptersList');

            if (!currentManualStory) {
                infoSection.style.display = 'none';
                return;
            }

            infoSection.style.display = 'block';

            // Hi·ªÉn th·ªã th·ªëng k√™
            statsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.chapters.length}</div>
                        <div class="stat-label">Ch∆∞∆°ng</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.totalWords.toLocaleString()}</div>
                        <div class="stat-label">T·ª´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${currentManualStory.genre}</div>
                        <div class="stat-label">Th·ªÉ lo·∫°i</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #007bff;">
                    <strong>üìñ ${currentManualStory.title}</strong><br>
                    <small style="color: #666;">T√°c gi·∫£: ${currentManualStory.author} ‚Ä¢ C·∫≠p nh·∫≠t: ${new Date(currentManualStory.updatedAt).toLocaleString('vi-VN')}</small>
                    ${currentManualStory.description ? `<br><em style="color: #666;">${currentManualStory.description}</em>` : ''}
                </div>
            `;

            // Hi·ªÉn th·ªã danh s√°ch ch∆∞∆°ng
            chaptersDiv.innerHTML = `
                <h4 style="margin-bottom: 15px;">üìÑ Danh s√°ch ch∆∞∆°ng</h4>
                ${currentManualStory.chapters.map(chapter => `
                    <div class="chapter-item">
                        <div class="chapter-header">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-meta">${chapter.wordCount} t·ª´ ‚Ä¢ ${new Date(chapter.createdAt).toLocaleString('vi-VN')}</div>
                        </div>
                        <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                        <div class="chapter-actions">
                            <button class="btn btn-primary" onclick="editChapter('${chapter.id}')">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-secondary" onclick="viewChapter('${chapter.id}')">üëÅÔ∏è Xem</button>
                            <button class="btn btn-danger" onclick="deleteChapter('${chapter.id}')">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ===== AI WRITING FUNCTIONS =====

        // T·∫°o truy·ªán b·∫±ng AI
        async function generateAIStory() {
            const prompt = document.getElementById('aiStoryPrompt').value.trim();
            const style = document.getElementById('aiWritingStyle').value;
            const length = document.getElementById('aiChapterLength').value;
            const chapters = parseInt(document.getElementById('aiNumberOfChapters').value);

            if (!prompt) {
                showAlert('ai', 'Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ/√Ω t∆∞·ªüng cho truy·ªán', 'error');
                return;
            }

            if (aiTrainingData.trainedStories === 0) {
                showAlert('ai', 'Vui l√≤ng hu·∫•n luy·ªán AI tr∆∞·ªõc khi t·∫°o truy·ªán', 'error');
                return;
            }

            showGenerationProgress();
            updateGenerationStatus('ƒêang kh·ªüi t·∫°o AI...', 0);

            try {
                // T·∫°o th√¥ng tin truy·ªán
                const storyTitle = generateStoryTitle(prompt);
                const storyDescription = generateStoryDescription(prompt);
                
                currentAIStory = {
                    id: 'ai_' + Date.now(),
                    title: storyTitle,
                    author: 'AI Story Writer',
                    genre: getGenreFromStyle(style),
                    description: storyDescription,
                    prompt: prompt,
                    style: style,
                    chapters: [],
                    createdAt: new Date().toISOString(),
                    totalWords: 0,
                    type: 'ai'
                };

                updateGenerationStatus('ƒêang t·∫°o outline truy·ªán...', 10);

                // T·∫°o t·ª´ng ch∆∞∆°ng
                for (let i = 1; i <= chapters; i++) {
                    updateGenerationStatus(`ƒêang vi·∫øt ch∆∞∆°ng ${i}/${chapters}...`, 10 + (i / chapters) * 80);
                    
                    const chapterTitle = generateChapterTitle(i, chapters, style);
                    const chapterContent = await generateChapter(prompt, style, length, i, chapters);
                    const wordCount = countWords(chapterContent);

                    const chapter = {
                        id: 'ai_chapter_' + Date.now() + '_' + i,
                        title: chapterTitle,
                        content: chapterContent,
                        wordCount: wordCount,
                        createdAt: new Date().toISOString(),
                        chapterNumber: i
                    };

                    currentAIStory.chapters.push(chapter);
                    currentAIStory.totalWords += wordCount;

                    // Delay ƒë·ªÉ t·∫°o c·∫£m gi√°c th·ª±c t·∫ø
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                updateGenerationStatus('Ho√†n t·∫•t!', 100);
                hideGenerationProgress();
                displayAIStory();
                showAlert('ai', `AI ƒë√£ t·∫°o th√†nh c√¥ng truy·ªán "${storyTitle}" v·ªõi ${chapters} ch∆∞∆°ng!`, 'success');

            } catch (error) {
                console.error('Error generating AI story:', error);
                hideGenerationProgress();
                showAlert('ai', 'L·ªói khi t·∫°o truy·ªán: ' + error.message, 'error');
            }
        }

        // Hi·ªÉn th·ªã truy·ªán AI ƒë√£ t·∫°o
        function displayAIStory() {
            if (!currentAIStory) return;

            const section = document.getElementById('aiGeneratedStory');
            const details = document.getElementById('aiStoryDetails');
            const chaptersList = document.getElementById('aiChaptersList');

            section.style.display = 'block';

            // Hi·ªÉn th·ªã th√¥ng tin truy·ªán
            details.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 20px;">
                    <h4>üìñ ${currentAIStory.title}</h4>
                    <div style="margin: 10px 0; color: #666;">
                        <strong>T√°c gi·∫£:</strong> ${currentAIStory.author}<br>
                        <strong>Th·ªÉ lo·∫°i:</strong> ${currentAIStory.genre}<br>
                        <strong>Phong c√°ch:</strong> ${getStyleName(currentAIStory.style)}<br>
                        <strong>T·ªïng t·ª´:</strong> ${currentAIStory.totalWords.toLocaleString()}<br>
                        <strong>S·ªë ch∆∞∆°ng:</strong> ${currentAIStory.chapters.length}
                    </div>
                    <p><em>${currentAIStory.description}</em></p>
                </div>
            `;

            // Hi·ªÉn th·ªã danh s√°ch ch∆∞∆°ng
            chaptersList.innerHTML = `
                <h4 style="margin-bottom: 15px;">üìÑ Danh s√°ch ch∆∞∆°ng ƒë√£ t·∫°o</h4>
                ${currentAIStory.chapters.map(chapter => `
                    <div class="chapter-item">
                        <div class="chapter-header">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-meta">${chapter.wordCount} t·ª´</div>
                        </div>
                        <div class="chapter-preview">${chapter.content.substring(0, 150)}...</div>
                        <div class="chapter-actions">
                            <button class="btn btn-secondary" onclick="viewAIChapter('${chapter.id}')">üëÅÔ∏è Xem ƒë·∫ßy ƒë·ªß</button>
                            <button class="btn btn-warning" onclick="regenerateAIChapter('${chapter.id}')">üîÑ Vi·∫øt l·∫°i</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // L∆∞u truy·ªán AI v√†o l·ªãch s·ª≠
        function saveAIStoryToHistory() {
            if (!currentAIStory) {
                showAlert('ai', 'Kh√¥ng c√≥ truy·ªán n√†o ƒë·ªÉ l∆∞u', 'error');
                return;
            }

            aiStories.push({...currentAIStory});
            updateAllStats();
            showAlert('ai', `ƒê√£ l∆∞u truy·ªán "${currentAIStory.title}" v√†o l·ªãch s·ª≠`, 'success');
        }

        // Ti·∫øp t·ª•c vi·∫øt truy·ªán AI
        async function continueAIStory() {
            if (!currentAIStory) {
                showAlert('ai', 'Kh√¥ng c√≥ truy·ªán n√†o ƒë·ªÉ ti·∫øp t·ª•c', 'error');
                return;
            }

            const nextChapterNumber = currentAIStory.chapters.length + 1;
            showAlert('ai', `AI ƒëang vi·∫øt ch∆∞∆°ng ${nextChapterNumber}...`, 'info');

            try {
                const chapterTitle = generateChapterTitle(nextChapterNumber, nextChapterNumber + 5, currentAIStory.style);
                const chapterContent = await generateChapter(
                    currentAIStory.prompt, 
                    currentAIStory.style, 
                    'medium', 
                    nextChapterNumber, 
                    nextChapterNumber + 5
                );
                const wordCount = countWords(chapterContent);

                const chapter = {
                    id: 'ai_chapter_' + Date.now() + '_' + nextChapterNumber,
                    title: chapterTitle,
                    content: chapterContent,
                    wordCount: wordCount,
                    createdAt: new Date().toISOString(),
                    chapterNumber: nextChapterNumber
                };

                currentAIStory.chapters.push(chapter);
                currentAIStory.totalWords += wordCount;

                displayAIStory();
                showAlert('ai', `ƒê√£ th√™m "${chapterTitle}"!`, 'success');

            } catch (error) {
                console.error('Error continuing story:', error);
                showAlert('ai', 'L·ªói khi ti·∫øp t·ª•c vi·∫øt: ' + error.message, 'error');
            }
        }

        // ===== HELPER FUNCTIONS =====

        // T·∫°o t√™n truy·ªán t·ª´ prompt
        function generateStoryTitle(prompt) {
            const templates = [
                'Nh·∫≠t K√Ω C·ªßa T√¥i',
                'Cu·ªôc S·ªëng Trong Th√†nh Ph·ªë',
                'Nh·ªØng Ng√†y C√¥ ƒê∆°n',
                'T√¥i V√† Th·∫ø Gi·ªõi',
                'H√†nh Tr√¨nh T√¨m V·ªÅ',
                'N∆°i T√¥i Thu·ªôc V·ªÅ',
                'C√¢u Chuy·ªán C·ªßa T√¥i',
                'Nh·ªØng Trang Nh·∫≠t K√Ω',
                'Gi·∫•c M∆° V√† Hi·ªán Th·ª±c',
                'Con ƒê∆∞·ªùng T√¥i ƒêi'
            ];
            
            // Th·ª≠ t·∫°o t√™n t·ª´ prompt
            if (prompt.includes('sinh vi√™n')) return 'Nh·∫≠t K√Ω Sinh Vi√™n';
            if (prompt.includes('H√† N·ªôi') || prompt.includes('th√†nh ph·ªë')) return 'Nh·ªØng Ng√†y ·ªû H√† N·ªôi';
            if (prompt.includes('t√¨nh y√™u')) return 'Chuy·ªán T√¨nh C·ªßa T√¥i';
            if (prompt.includes('c√¥ng vi·ªác')) return 'Cu·ªôc S·ªëng C√¥ng S·ªü';
            
            return templates[Math.floor(Math.random() * templates.length)];
        }

        // T·∫°o m√¥ t·∫£ truy·ªán
        function generateStoryDescription(prompt) {
            return `M·ªôt c√¢u chuy·ªán ƒë∆∞·ª£c AI t·∫°o ra t·ª´ √Ω t∆∞·ªüng: "${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}". Truy·ªán ƒë∆∞·ª£c k·ªÉ theo ng√¥i th·ª© nh·∫•t, mang ƒë·∫≠m t√≠nh c√° nh√¢n v√† c·∫£m x√∫c.`;
        }

        // T·∫°o t√™n ch∆∞∆°ng
        function generateChapterTitle(chapterNum, totalChapters, style) {
            const templates = {
                melancholy: [
                    'Nh·ªØng Gi·ªçt N∆∞·ªõc M·∫Øt', 'N·ªói Bu·ªìn V√¥ T·∫≠n', 'Tr√°i Tim Tan V·ª°',
                    'ƒê√™m T·ªëi V√† C√¥ ƒê∆°n', 'K√Ω ·ª®c Bu·ªìn', 'N∆∞·ªõc M·∫Øt Trong M∆∞a'
                ],
                romantic: [
                    'T√¨nh Y√™u ƒê·∫ßu ƒê·ªùi', 'Tr√°i Tim Rung ƒê·ªông', 'N·ª• H√¥n ƒê·∫ßu Ti√™n',
                    'Nh·ªØng L·ªùi Y√™u Th∆∞∆°ng', 'Gi·∫•c M∆° T√¨nh Y√™u', 'H·∫°nh Ph√∫c B√™n Em'
                ],
                philosophical: [
                    'Suy T∆∞ V·ªÅ Cu·ªôc ƒê·ªùi', 'Tri·∫øt L√Ω S·ªëng', '√ù Nghƒ©a Cu·ªôc S·ªëng',
                    'Nh·ªØng B√†i H·ªçc', 'Hi·ªÉu V·ªÅ B·∫£n Th√¢n', 'Con ƒê∆∞·ªùng T√¨m Hi·ªÉu'
                ],
                realistic: [
                    'Cu·ªôc S·ªëng H·∫±ng Ng√†y', 'Th·ª±c T·∫ø Cu·ªôc ƒê·ªùi', 'Nh·ªØng Ng√†y B√¨nh Th∆∞·ªùng',
                    'Chuy·ªán ƒê·ªùi Th∆∞·ªùng', 'H·∫°nh Ph√∫c Gi·∫£n ƒê∆°n', 'Cu·ªôc S·ªëng Th√†nh Ph·ªë'
                ],
                nostalgic: [
                    'Nh·ªõ V·ªÅ Qu√™ H∆∞∆°ng', 'K·ª∑ Ni·ªám X∆∞a C≈©', 'Th·ªùi Th∆° ·∫§u',
                    'Nh·ªØng Ng√†y ƒê√£ Qua', 'Ho√†i Ni·ªám', 'K√Ω ·ª®c Tu·ªïi Th∆°'
                ]
            };

            const styleTemplates = templates[style] || templates.melancholy;
            
            if (chapterNum === 1) return 'Kh·ªüi ƒê·∫ßu';
            if (chapterNum === totalChapters) return 'K·∫øt Th√∫c';
            
            return styleTemplates[Math.floor(Math.random() * styleTemplates.length)];
        }

        // T·∫°o n·ªôi dung ch∆∞∆°ng
        async function generateChapter(prompt, style, length, chapterNum, totalChapters) {
            const wordCount = getWordCount(length);
            const stylePrompts = getStylePrompts(style);
            
            // T·∫°o c√¢u m·ªü ƒë·∫ßu
            const openings = [
                'T√¥i kh√¥ng bao gi·ªù nghƒ© r·∫±ng cu·ªôc ƒë·ªùi m√¨nh s·∫Ω ƒë∆∞a t√¥i ƒë·∫øn ƒëi·ªÉm n√†y.',
                'Khi t√¥i nh√¨n l·∫°i nh·ªØng ng√†y qua, t√¥i c·∫£m th·∫•y nh∆∞ ƒëang s·ªëng trong gi·∫•c m∆° c·ªßa ai kh√°c.',
                'H√¥m nay, t√¥i th·ª©c d·∫≠y v·ªõi c·∫£m gi√°c ho√†n to√†n kh√°c bi·ªát.',
                'C√≥ nh·ªØng l√∫c t√¥i t·ª± h·ªèi li·ªáu t√¥i c√≥ ƒëang s·ªëng ƒë√∫ng v·ªõi con ng∆∞·ªùi th·ª±c s·ª± c·ªßa m√¨nh kh√¥ng.',
                'T√¥i ng·ªìi b√™n c·ª≠a s·ªï, nh√¨n ra th·∫ø gi·ªõi b√™n ngo√†i v√† suy nghƒ© v·ªÅ cu·ªôc ƒë·ªùi.'
            ];

            let content = openings[Math.floor(Math.random() * openings.length)];
            
            // T·∫°o n·ªôi dung ch√≠nh
            const paragraphs = Math.floor(wordCount / 200); // Kho·∫£ng 200 t·ª´ m·ªói ƒëo·∫°n
            
            for (let i = 0; i < paragraphs; i++) {
                content += '\n\n' + generateParagraph(stylePrompts, chapterNum, totalChapters);
            }
            
            // Th√™m k·∫øt th√∫c ch∆∞∆°ng
            if (chapterNum === totalChapters) {
                content += '\n\nV√† t√¥i bi·∫øt r·∫±ng, d√π t∆∞∆°ng lai c√≥ mang ƒë·∫øn ƒëi·ªÅu g√¨, t√¥i s·∫Ω ti·∫øp t·ª•c b∆∞·ªõc ƒëi v·ªõi nh·ªØng b√†i h·ªçc qu√Ω gi√° m√† cu·ªôc s·ªëng ƒë√£ d·∫°y t√¥i.';
            } else {
                const endings = [
                    'T√¥i kh√©p l·∫°i ng√†y h√¥m nay v·ªõi nh·ªØng suy nghƒ© c√≤n ch∆∞a c√≥ l·ªùi gi·∫£i.',
                    'V√† t√¥i bi·∫øt r·∫±ng ng√†y mai s·∫Ω l·∫°i l√† m·ªôt ch∆∞∆°ng m·ªõi trong cu·ªôc ƒë·ªùi t√¥i.',
                    'T√¥i m·ªâm c∆∞·ªùi, c·∫£m th·∫•y trong l√≤ng c√≥ m·ªôt ch√∫t hy v·ªçng le l√≥i.',
                    'D√π bi·∫øt con ƒë∆∞·ªùng ph√≠a tr∆∞·ªõc c√≤n nhi·ªÅu th·ª≠ th√°ch, t√¥i v·∫´n s·∫µn s√†ng ƒë·ªëi m·∫∑t.'
                ];
                content += '\n\n' + endings[Math.floor(Math.random() * endings.length)];
            }
            
            return content.trim();
        }

        // T·∫°o ƒëo·∫°n vƒÉn
        function generateParagraph(stylePrompts, chapterNum, totalChapters) {
            const sentences = [
                'T√¥i c·∫£m th·∫•y tr√°i tim m√¨nh ƒëang rung ƒë·ªông khi nghƒ© v·ªÅ nh·ªØng k·ª∑ ni·ªám c≈©.',
                'Nh·ªØng gi·ªçt m∆∞a b√™n ngo√†i c·ª≠a s·ªï nh·∫Øc t√¥i nh·ªõ v·ªÅ qu√™ h∆∞∆°ng xa x√¥i.',
                'T√¥i t·ª± h·ªèi li·ªáu c√≥ ai kh√°c c≈©ng c·∫£m th·∫•y c√¥ ƒë∆°n nh∆∞ t√¥i kh√¥ng.',
                'Cu·ªôc s·ªëng ·ªü th√†nh ph·ªë l·ªõn ƒë√¥i khi khi·∫øn t√¥i c·∫£m th·∫•y nh∆∞ b·ªã l·∫°c l·ªëi.',
                'T√¥i nh·ªõ v·ªÅ nh·ªØng ng√†y th∆° ·∫•u khi m·ªçi th·ª© ƒë·ªÅu ƒë∆°n gi·∫£n v√† trong s√°ng.',
                'C√≥ l√∫c t√¥i mu·ªën quay tr·ªü l·∫°i th·ªùi ƒëi·ªÉm m√† t√¥i ch∆∞a bi·∫øt ƒë·∫øn n·ªói bu·ªìn l√† g√¨.',
                'T√¥i ng·ªìi trong g√≥c qu√°n quen thu·ªôc, quan s√°t nh·ªØng ng∆∞·ªùi qua l·∫°i.',
                'Nh·ªØng √°nh ƒë√®n ƒë∆∞·ªùng lung linh trong ƒë√™m t·ªëi khi·∫øn t√¥i suy t∆∞ v·ªÅ nhi·ªÅu ƒëi·ªÅu.'
            ];
            
            const selected = [];
            const numSentences = 3 + Math.floor(Math.random() * 3); // 3-5 c√¢u m·ªói ƒëo·∫°n
            
            for (let i = 0; i < numSentences; i++) {
                selected.push(sentences[Math.floor(Math.random() * sentences.length)]);
            }
            
            return selected.join(' ');
        }

        // ===== UTILITY FUNCTIONS =====

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'history') {
                refreshHistory();
            }
        }

        function showGenerationProgress() {
            document.getElementById('aiGenerationProgress').style.display = 'block';
        }

        function hideGenerationProgress() {
            setTimeout(() => {
                document.getElementById('aiGenerationProgress').style.display = 'none';
            }, 2000);
        }

        function updateGenerationStatus(status, percent) {
            document.getElementById('aiGenerationStatus').textContent = status;
            document.getElementById('aiGenerationPercent').textContent = Math.round(percent) + '%';
            document.getElementById('aiGenerationBar').style.width = percent + '%';
        }

        function countWords(text) {
            if (!text) return 0;
            return text.trim().split(/\s+/).length;
        }

        function getWordCount(length) {
            switch (length) {
                case 'short': return 1000;
                case 'medium': return 1750;
                case 'long': return 2750;
                default: return 1750;
            }
        }

        function getStylePrompts(style) {
            const styles = {
                melancholy: ['bu·ªìn b√£', 'u s·∫ßu', 'n·∫∑ng n·ªÅ', 'c√¥ ƒë∆°n'],
                romantic: ['ng·ªçt ng√†o', 'l√£ng m·∫°n', 'y√™u th∆∞∆°ng', '·∫•m √°p'],
                philosophical: ['suy nghƒ©', 'tri·∫øt l√Ω', 's√¢u s·∫Øc', 't√¢m h·ªìn'],
                realistic: ['th·ª±c t·∫ø', 'ƒë·ªùi th∆∞·ªùng', 'b√¨nh d√¢n', 'g·∫ßn g≈©i'],
                nostalgic: ['ho√†i ni·ªám', 'nh·ªõ nhung', 'xa x∆∞a', 'k·ª∑ ni·ªám']
            };
            return styles[style] || styles.melancholy;
        }

        function getStyleName(style) {
            const names = {
                melancholy: 'Bu·ªìn b√£, n·ªôi t√¢m',
                romantic: 'L√£ng m·∫°n, ng·ªçt ng√†o',
                philosophical: 'Tri·∫øt l√Ω, s√¢u s·∫Øc',
                realistic: 'Th·ª±c t·∫ø, g·∫ßn g≈©i',
                nostalgic: 'Ho√†i ni·ªám, nh·ªõ nhung'
            };
            return names[style] || names.melancholy;
        }

        function getGenreFromStyle(style) {
            const genres = {
                melancholy: 'T√¢m l√Ω',
                romantic: 'L√£ng m·∫°n',
                philosophical: 'Tri·∫øt l√Ω',
                realistic: 'ƒê·ªùi th∆∞·ªùng',
                nostalgic: 'Ho√†i ni·ªám'
            };
            return genres[style] || 'T√¢m l√Ω';
        }

        function showAlert(tabId, message, type) {
            const alertElement = document.getElementById(tabId + 'Alert');
            if (alertElement) {
                alertElement.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                alertElement.style.display = 'block';
                
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }

        function updateAllStats() {
            // Manual stories stats
            document.getElementById('totalManualStories').textContent = manualStories.length;
            
            // AI stories stats
            document.getElementById('totalAIStories').textContent = aiStories.length;
            
            // Total chapters
            const totalChapters = manualStories.reduce((sum, story) => sum + story.chapters.length, 0) +
                                 aiStories.reduce((sum, story) => sum + story.chapters.length, 0);
            document.getElementById('totalChapters').textContent = totalChapters;
            
            // Total words
            const totalWords = manualStories.reduce((sum, story) => sum + story.totalWords, 0) +
                              aiStories.reduce((sum, story) => sum + story.totalWords, 0);
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
        }

        function refreshHistory() {
            displayManualStories();
            displayAIStories();
            updateAllStats();
        }

        function displayManualStories() {
            const listElement = document.getElementById('manualStoriesList');
            
            if (manualStories.length === 0) {
                listElement.innerHTML = '<div class="loading">Ch∆∞a c√≥ truy·ªán th·ªß c√¥ng n√†o</div>';
                return;
            }

            listElement.innerHTML = manualStories.map(story => `
                <div class="story-folder">
                    <div class="folder-header" onclick="toggleFolder('manual_${story.id}')">
                        <div>
                            <div class="folder-title">üìñ ${story.title}</div>
                            <div class="folder-meta">${story.author} ‚Ä¢ ${story.chapters.length} ch∆∞∆°ng ‚Ä¢ ${story.totalWords.toLocaleString()} t·ª´</div>
                        </div>
                        <button class="folder-toggle">üëÅÔ∏è Xem</button>
                    </div>
                    <div class="folder-content" id="manual_${story.id}">
                        ${story.chapters.map(chapter => `
                            <div class="chapter-item">
                                <div class="chapter-header">
                                    <div class="chapter-title">${chapter.title}</div>
                                    <div class="chapter-meta">${chapter.wordCount} t·ª´</div>
                                </div>
                                <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                                <div class="chapter-actions">
                                    <button class="btn btn-secondary" onclick="viewFullChapter('${story.id}', '${chapter.id}')">üëÅÔ∏è Xem ƒë·∫ßy ƒë·ªß</button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="viewFullStory('${story.id}', 'ai')">üìñ Xem to√†n b·ªô truy·ªán</button>
                            <button class="btn btn-danger" onclick="deleteStory('${story.id}', 'ai')">üóëÔ∏è X√≥a truy·ªán</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle folder display
        function toggleFolder(folderId) {
            const folder = document.getElementById(folderId);
            if (folder) {
                folder.classList.toggle('expanded');
            }
        }

        // View full story
        function viewFullStory(storyId, type) {
            const stories = type === 'manual' ? manualStories : aiStories;
            const story = stories.find(s => s.id === storyId);
            if (story) {
                showStoryModal(story);
            }
        }

        // View full chapter
        function viewFullChapter(storyId, chapterId) {
            const story = [...manualStories, ...aiStories].find(s => s.id === storyId);
            const chapter = story ? story.chapters.find(c => c.id === chapterId) : null;
            
            if (chapter) {
                showChapterModal(chapter, story.title);
            }
        }

        // Show story modal
        function showStoryModal(story) {
            const modal = document.getElementById('storyModal');
            const title = document.getElementById('modalStoryTitle');
            const content = document.getElementById('modalStoryContent');

            title.textContent = story.title;
            
            const fullContent = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div><strong>T√°c gi·∫£:</strong> ${story.author}</div>
                    <div><strong>Th·ªÉ lo·∫°i:</strong> ${story.genre}</div>
                    <div><strong>S·ªë ch∆∞∆°ng:</strong> ${story.chapters.length}</div>
                    <div><strong>T·ªïng t·ª´:</strong> ${story.totalWords.toLocaleString()}</div>
                    ${story.description ? `<div style="margin-top: 10px;"><em>${story.description}</em></div>` : ''}
                </div>
                ${story.chapters.map((chapter, index) => `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #007bff; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;">
                            ${chapter.title}
                        </h4>
                        <div style="line-height: 1.8; text-align: justify;">
                            ${chapter.content.replace(/\n/g, '<br><br>')}
                        </div>
                        <div style="text-align: right; margin-top: 15px; font-size: 14px; color: #666;">
                            ${chapter.wordCount} t·ª´ ‚Ä¢ ${new Date(chapter.createdAt).toLocaleString('vi-VN')}
                        </div>
                    </div>
                `).join('')}
            `;

            content.innerHTML = fullContent;
            modal.style.display = 'block';
        }

        // Show chapter modal
        function showChapterModal(chapter, storyTitle) {
            const modal = document.getElementById('storyModal');
            const title = document.getElementById('modalStoryTitle');
            const content = document.getElementById('modalStoryContent');

            title.textContent = `${storyTitle} - ${chapter.title}`;
            
            content.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div><strong>Ch∆∞∆°ng:</strong> ${chapter.title}</div>
                    <div><strong>S·ªë t·ª´:</strong> ${chapter.wordCount}</div>
                    <div><strong>Ng√†y t·∫°o:</strong> ${new Date(chapter.createdAt).toLocaleString('vi-VN')}</div>
                </div>
                <div style="line-height: 1.8; text-align: justify;">
                    ${chapter.content.replace(/\n/g, '<br><br>')}
                </div>
            `;

            modal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('storyModal').style.display = 'none';
        }

        // Delete story
        function deleteStory(storyId, type) {
            const stories = type === 'manual' ? manualStories : aiStories;
            const story = stories.find(s => s.id === storyId);
            
            if (story && confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a truy·ªán "${story.title}"?`)) {
                if (type === 'manual') {
                    manualStories = manualStories.filter(s => s.id !== storyId);
                    if (currentManualStory && currentManualStory.id === storyId) {
                        currentManualStory = null;
                        updateCurrentStoryDisplay();
                    }
                } else {
                    aiStories = aiStories.filter(s => s.id !== storyId);
                }
                
                refreshHistory();
                showAlert('history', `ƒê√£ x√≥a truy·ªán "${story.title}"`, 'success');
            }
        }

        // Edit chapter (for manual stories)
        function editChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                document.getElementById('manualChapterTitle').value = chapter.title;
                document.getElementById('manualChapterContent').value = chapter.content;
                
                // Remove the chapter from the story temporarily
                currentManualStory.chapters = currentManualStory.chapters.filter(c => c.id !== chapterId);
                currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);
                
                updateCurrentStoryDisplay();
                showAlert('manual', `ƒêang ch·ªânh s·ª≠a ch∆∞∆°ng "${chapter.title}"`, 'info');
            }
        }

        // View chapter (for current manual story)
        function viewChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                showChapterModal(chapter, currentManualStory.title);
            }
        }

        // Delete chapter (for current manual story)
        function deleteChapter(chapterId) {
            if (!currentManualStory) return;
            
            const chapter = currentManualStory.chapters.find(c => c.id === chapterId);
            if (chapter && confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng "${chapter.title}"?`)) {
                currentManualStory.chapters = currentManualStory.chapters.filter(c => c.id !== chapterId);
                currentManualStory.totalWords = currentManualStory.chapters.reduce((sum, ch) => sum + ch.wordCount, 0);
                
                // Update chapter numbers
                currentManualStory.chapters.forEach((ch, index) => {
                    ch.chapterNumber = index + 1;
                });
                
                updateCurrentStoryDisplay();
                showAlert('manual', `ƒê√£ x√≥a ch∆∞∆°ng "${chapter.title}"`, 'success');
            }
        }

        // View AI chapter
        function viewAIChapter(chapterId) {
            if (!currentAIStory) return;
            
            const chapter = currentAIStory.chapters.find(c => c.id === chapterId);
            if (chapter) {
                showChapterModal(chapter, currentAIStory.title);
            }
        }

        // Regenerate AI chapter
        async function regenerateAIChapter(chapterId) {
            if (!currentAIStory) return;
            
            const chapter = currentAIStory.chapters.find(c => c.id === chapterId);
            if (!chapter) return;
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën vi·∫øt l·∫°i ch∆∞∆°ng "${chapter.title}"?`)) return;
            
            showAlert('ai', `ƒêang vi·∫øt l·∫°i ch∆∞∆°ng "${chapter.title}"...`, 'info');
            
            try {
                const newContent = await generateChapter(
                    currentAIStory.prompt,
                    currentAIStory.style,
                    'medium',
                    chapter.chapterNumber,
                    currentAIStory.chapters.length
                );
                
                const oldWordCount = chapter.wordCount;
                chapter.content = newContent;
                chapter.wordCount = countWords(newContent);
                
                // Update total words
                currentAIStory.totalWords = currentAIStory.totalWords - oldWordCount + chapter.wordCount;
                
                displayAIStory();
                showAlert('ai', `ƒê√£ vi·∫øt l·∫°i ch∆∞∆°ng "${chapter.title}"!`, 'success');
                
            } catch (error) {
                console.error('Error regenerating chapter:', error);
                showAlert('ai', 'L·ªói khi vi·∫øt l·∫°i ch∆∞∆°ng: ' + error.message, 'error');
            }
        }

        // Load stories from memory (placeholder for localStorage functionality)
        function loadStoriesFromMemory() {
            // In a real environment, this would load from localStorage
            // For now, we'll start with empty arrays
            manualStories = [];
            aiStories = [];
        }

        // Training functions (simplified)
        async function startFullTraining() {
            showAlert('training', 'ƒêang hu·∫•n luy·ªán AI t·ª´ d·ªØ li·ªáu...', 'info');
            
            try {
                // Simulate training process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Update training data with sample data
                aiTrainingData = {
                    stories: [...manualStories, ...aiStories],
                    vocabulary: new Set(['t√¥i', 'cu·ªôc s·ªëng', 'th√†nh ph·ªë', 'tr√°i tim', 'y√™u th∆∞∆°ng', 'nh·ªõ nhung', 'ho√†i ni·ªám']),
                    patterns: ['T√¥i c·∫£m th·∫•y', 'T√¥i nh·ªõ v·ªÅ', 'T√¥i kh√¥ng th·ªÉ', 'T√¥i mu·ªën'],
                    trainedStories: manualStories.length + aiStories.length + 5,
                    accuracy: 85
                };
                
                updateTrainingStats();
                showAlert('training', 'AI ƒë√£ ƒë∆∞·ª£c hu·∫•n luy·ªán th√†nh c√¥ng!', 'success');
                
            } catch (error) {
                showAlert('training', 'L·ªói khi hu·∫•n luy·ªán AI: ' + error.message, 'error');
            }
        }

        async function startQuickTraining() {
            showAlert('training', 'ƒêang hu·∫•n luy·ªán nhanh...', 'info');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                aiTrainingData = {
                    stories: [],
                    vocabulary: new Set(['t√¥i', 'cu·ªôc s·ªëng', 'c·∫£m x√∫c']),
                    patterns: ['T√¥i c·∫£m th·∫•y', 'T√¥i nghƒ©'],
                    trainedStories: 3,
                    accuracy: 60
                };
                
                updateTrainingStats();
                showAlert('training', 'Hu·∫•n luy·ªán nhanh ho√†n t·∫•t!', 'success');
                
            } catch (error) {
                showAlert('training', 'L·ªói khi hu·∫•n luy·ªán nhanh: ' + error.message, 'error');
            }
        }

        async function testAI() {
            if (aiTrainingData.trainedStories === 0) {
                showAlert('training', 'Vui l√≤ng hu·∫•n luy·ªán AI tr∆∞·ªõc khi ki·ªÉm tra', 'error');
                return;
            }
            
            showAlert('training', 'AI ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng. S·∫µn s√†ng t·∫°o truy·ªán!', 'success');
        }

        function updateTrainingStats() {
            document.getElementById('totalDataSources').textContent = aiTrainingData.trainedStories;
            document.getElementById('totalTrainingWords').textContent = aiTrainingData.vocabulary.size.toLocaleString();
            document.getElementById('uniquePhrases').textContent = aiTrainingData.patterns.length;
            document.getElementById('aiReadiness').textContent = aiTrainingData.accuracy + '%';
        }

        // Initialize app when page loads
        window.addEventListener('load', initializeApp);

        // Make functions available globally for onclick handlers
        window.toggleFolder = toggleFolder;
        window.viewFullStory = viewFullStory;
        window.viewFullChapter = viewFullChapter;
        window.deleteStory = deleteStory;
        window.editChapter = editChapter;
        window.viewChapter = viewChapter;
        window.deleteChapter = deleteChapter;
        window.viewAIChapter = viewAIChapter;
        window.regenerateAIChapter = regenerateAIChapter;
        window.closeModal = closeModal;

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('storyModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
                                <div class="chapter-header">
                                    <div class="chapter-title">${chapter.title}</div>
                                    <div class="chapter-meta">${chapter.wordCount} t·ª´</div>
                                </div>
                                <div class="chapter-preview">${chapter.content.substring(0, 100)}...</div>
                                <div class="chapter-actions">
                                    <button class="btn btn-secondary" onclick="viewFullChapter('${story.id}', '${chapter.id}')">üëÅÔ∏è Xem ƒë·∫ßy ƒë·ªß</button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="viewFullStory('${story.id}', 'manual')">üìñ Xem to√†n b·ªô truy·ªán</button>
                            <button class="btn btn-danger" onclick="deleteStory('${story.id}', 'manual')">üóëÔ∏è X√≥a truy·ªán</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayAIStories() {
            const listElement = document.getElementById('aiStoriesList');
            
            if (aiStories.length === 0) {
                listElement.innerHTML = '<div class="loading">Ch∆∞a c√≥ truy·ªán AI n√†o</div>';
                return;
            }

            listElement.innerHTML = aiStories.map(story => `
                <div class="story-folder">
                    <div class="folder-header" onclick="toggleFolder('ai_${story.id}')">
                        <div>
                            <div class="folder-title">ü§ñ ${story.title}</div>
                            <div class="folder-meta">${getStyleName(story.style)} ‚Ä¢ ${story.chapters.length} ch∆∞∆°ng ‚Ä¢ ${story.totalWords.toLocaleString()} t·ª´</div>
                        </div>
                        <button class="folder-toggle">üëÅÔ∏è Xem</button>
                    </div>
                    <div class="folder-content" id="ai_${story.id}">
                        ${story.chapters.map(chapter => `
                            <div class="chapter-item">
