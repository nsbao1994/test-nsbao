<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Th√™m style cho c·∫£nh b√°o n·ªôi dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* ·∫®n n·ªôi dung nh·∫°y c·∫£m m·∫∑c ƒë·ªãnh */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive - Ch·ªß ƒë·ªÅ chuy√™n bi·ªát</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úèÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>C·∫•u tr√∫c c√¢u:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¨nh ti·∫øt:</span>
                                <span id="plotPoints">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Di·ªÖn bi·∫øn c·∫£m x√∫c:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông</h2>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫£nh b√°o: AI s·∫Ω t·∫°o n·ªôi dung theo ng√¥i th·ª© nh·∫•t.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                    <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                                <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                                <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">N·ªôi dung:</label>
                                <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                            </div>
                            <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üóÇ Th∆∞ m·ª•c Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>üìö Truy·ªán ƒê∆∞·ª£c T·∫°o B·ªüi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Ch∆∞∆°ng Truy·ªán</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
                <button class="btn danger" onclick="deleteChapter()">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
                <button class="btn" onclick="saveChapterChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" onclick="cancelEdit()">‚ùå H·ªßy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set()
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// T·ª´ v·ª±ng v√† c·∫•u tr√∫c chuy√™n bi·ªát cho ch·ªß ƒë·ªÅ b·ªë ch·ªìng con d√¢u
const specializedVocabulary = {
    familyRelations: ['b·ªë ch·ªìng', 'con d√¢u', 'ch·ªìng', 'v·ª£', 'gia ƒë√¨nh', 'h·ªç h√†ng', 'm·ªëi quan h·ªá', 'ph√©p t·∫Øc', 'ranh gi·ªõi'],
    emotions: ['cƒÉng th·∫≥ng', 'b·ªëi r·ªëi', 'ghen t·ªã', 't√≤ m√≤', 'lo l·∫Øng', 'th√®m mu·ªën', 'khao kh√°t', 't·ªôi l·ªói', 'x·∫•u h·ªï', 'k√≠ch th√≠ch', 'd·ª•c v·ªçng', 'b·∫•t an'],
    observations: ['quan s√°t', 'nh√¨n tr·ªôm', 'theo d√µi', 'ch√∫ √Ω', 'ph√°t hi·ªán', 'ƒë·ªÉ √Ω', 'nh·∫≠n ra', 'th·∫•y ƒë∆∞·ª£c', 'c·∫£m nh·∫≠n', 'nghe ƒë∆∞·ª£c'],
    innerThoughts: ['t√¥i nghƒ©', 'trong t√¢m tr√≠ t√¥i', 't√¥i t·ª± h·ªèi', 'c√≥ l·∫Ω', 'li·ªáu r·∫±ng', 't√¥i kh√¥ng th·ªÉ tin ƒë∆∞·ª£c', 't√¥i c·∫£m th·∫•y', 'ƒëi·ªÅu n√†y khi·∫øn t√¥i'],
    secretive: ['b√≠ m·∫≠t', 'gi·∫•u k√≠n', 'che gi·∫•u', 'l√©n l√∫t', 'th·∫ßm k√≠n', 'k√≠n ƒë√°o', '√¢m th·∫ßm', 'kh√¥ng ai bi·∫øt', 'ch·ªâ m√¨nh t√¥i'],
    physicalDescriptions: ['ƒë√¥i m·∫Øt', 'n·ª• c∆∞·ªùi', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'c√°ch di chuy·ªÉn', 'gi·ªçng n√≥i', 'c√°ch c∆∞·ªùi', 'bi·ªÉu c·∫£m'],
    situations: ['b·ªØa c∆°m gia ƒë√¨nh', 'khi v·ª£ ƒëi v·∫Øng', 'cu·ªëi tu·∫ßn', 'nh·ªØng bu·ªïi t·ªëi', 'l√∫c m·ªôt m√¨nh', 'khi kh√¥ng ai ch√∫ √Ω'],
    adultElements: ['ham mu·ªën', 'd·ª•c v·ªçng', 'kh√°t khao', 'b√≠ m·∫≠t c·∫•m k·ªã', 'ranh gi·ªõi m·ªù nh·∫°t', 'c√°m d·ªó', 's·ª± quy·∫øn r≈©', 'kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i']
};

// C·∫•u tr√∫c c√¢u chuy·ªÉn bi·ªát cho ng√¥i th·ª© nh·∫•t c·ªßa ng∆∞·ªùi ch·ªìng
const narrativePatterns = {
    observation: [
        "T√¥i ƒë·ªÉ √Ω th·∫•y {situation} gi·ªØa b·ªë v√† {wife}.",
        "Trong {timeFrame}, t√¥i nh·∫≠n ra {observation} v·ªÅ m·ªëi quan h·ªá c·ªßa h·ªç.",
        "T√¥i kh√¥ng th·ªÉ kh√¥ng ch√∫ √Ω ƒë·∫øn {physicalDescription} khi {situation}.",
        "C√≥ ƒëi·ªÅu g√¨ ƒë√≥ trong {observation} khi·∫øn t√¥i {emotion}.",
        "T√¥i th·∫•y {wife} v√† b·ªë {action} m·ªôt c√°ch {manner}."
    ],
    innerMonologue: [
        "Trong t√¢m tr√≠ t√¥i, {innerThought} v·ªÅ nh·ªØng g√¨ ƒëang di·ªÖn ra.",
        "T√¥i t·ª± h·ªèi li·ªáu {question} c√≥ ph·∫£i l√† ƒëi·ªÅu t√¥i nghƒ© kh√¥ng.",
        "C·∫£m gi√°c {emotion} c·ª© √°m ·∫£nh t√¥i khi {situation}.",
        "T√¥i kh√¥ng th·ªÉ ng·ª´ng nghƒ© v·ªÅ {observation} m√† t√¥i ƒë√£ th·∫•y.",
        "ƒêi·ªÅu n√†y khi·∫øn t√¥i {emotion} m·ªôt c√°ch {intensity}.",
        "C√≥ l·∫Ω t√¥i ƒëang {doubt} nh∆∞ng {feeling} n√†y kh√¥ng th·ªÉ ph·ªß nh·∫≠n."
    ],
    conflict: [
        "T√¥i bi·∫øt m√¨nh kh√¥ng n√™n {action} nh∆∞ng {desire} qu√° m·∫°nh.",
        "Ranh gi·ªõi gi·ªØa {rightWrong} ng√†y c√†ng {blur}.",
        "T√¥i c·∫£m th·∫•y {guilty} v√¨ {thought} v·ªÅ {situation}.",
        "L√†m th·∫ø n√†o ƒë·ªÉ t√¥i c√≥ th·ªÉ {cope} v·ªõi {feeling} n√†y?",
        "M·ªói l·∫ßn {trigger}, t√¥i l·∫°i {reaction}."
    ],
    escalation: [
        "Nh·ªØng {timeFrame} g·∫ßn ƒë√¢y, {situation} ng√†y c√†ng {intensity}.",
        "T√¥i nh·∫≠n ra {realization} v·ªÅ b·∫£n th√¢n m√¨nh.",
        "Kh√¥ng th·ªÉ ph·ªß nh·∫≠n r·∫±ng {truth} ƒëang x·∫£y ra.",
        "C√°ch {wife} {action} v·ªõi b·ªë khi·∫øn t√¥i {emotion}.",
        "T√¥i b·∫Øt ƒë·∫ßu {change} c√°ch nh√¨n v·ªÅ {relationship}."
    ]
};

// C√°c y·∫øu t·ªë t√¨nh ti·∫øt chuy√™n bi·ªát
const plotElements = {
    triggers: ['khi v·ª£ t√¥i c√∫i xu·ªëng', 'l√∫c b·ªë gi√∫p con d√¢u', 'nh·ªØng c·ª≠ ch·ªâ th√¢n m·∫≠t', '√°nh m·∫Øt trao ƒë·ªïi', 'ti·∫øng c∆∞·ªùi nh·∫π', 'c√°ch h·ªç ƒë·ª©ng g·∫ßn nhau'],
    timeFrames: ['nh·ªØng ng√†y', 'bu·ªïi t·ªëi', 'cu·ªëi tu·∫ßn', 'khi t√¥i v·ªÅ nh√†', 'l√∫c ƒÉn c∆°m', 'nh·ªØng l√∫c y√™n tƒ©nh'],
    locations: ['trong nh√† b·∫øp', '·ªü ph√≤ng kh√°ch', 'ngo√†i s√¢n', 'tr√™n c·∫ßu thang', 'trong ph√≤ng t·∫Øm', '·ªü ban c√¥ng'],
    discoveries: ['t√¥i ph√°t hi·ªán ra', 't√¥i t√¨nh c·ªù th·∫•y', 't√¥i nghe ƒë∆∞·ª£c', 't√¥i nh·∫≠n ra', 't√¥i kh√¥ng th·ªÉ tin'],
    consequences: ['t√¥i m·∫•t ng·ªß', 't√¥i kh√¥ng th·ªÉ t·∫≠p trung', 't√¥i b·∫Øt ƒë·∫ßu tr√°nh', 't√¥i c√†ng quan s√°t nhi·ªÅu h∆°n', 't√¥i c·∫£m th·∫•y b·ªëi r·ªëi']
};

// Initialize Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}

function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}

function maybeEnableButtons() { 
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'inline-block'; 
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { 
            showStatus('L·ªói ƒëƒÉng nh·∫≠p: ' + resp.error, 'error'); 
            return; 
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { 
        google.accounts.oauth2.revoke(token.access_token); 
        gapi.client.setToken(''); 
    }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}

async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    await loadAiKnowledge();
    await loadAiGeneratedStories();
    updateAiStats();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Kh·ªüi t·∫°o ·ª©ng d·ª•ng th√†nh c√¥ng!', 'success');
    showLoading(false);
}

async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) {
        mainFolderId = response.result.files[0].id;
    } else {
        const folder = await gapi.client.drive.files.create({ 
            resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, 
            fields: 'id' 
        });
        mainFolderId = folder.result.id;
    }
    
    // Create AI Stories folder if it doesn't exist
    const aiFolderName = 'AI_Generated_Stories';
    const aiResponse = await gapi.client.drive.files.list({
        q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id, name)'
    });
    if (aiResponse.result.files.length === 0) {
        const aiFolder = await gapi.client.drive.files.create({ 
            resource: {
                name: aiFolderName, 
                mimeType: 'application/vnd.google-apps.folder', 
                parents: [mainFolderId]
            }, 
            fields: 'id' 
        });
    }
}

async function createStoryFolder(storyTitle, isAiGenerated = false) {
    let parentId = mainFolderId;
    
    if (isAiGenerated) {
        // Find AI Stories folder
        const aiFolderName = 'AI_Generated_Stories';
        const response = await gapi.client.drive.files.list({
            q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        if (response.result.files.length > 0) {
            parentId = response.result.files[0].id;
        }
    }
    
    const folder = await gapi.client.drive.files.create({
        resource: { 
            name: storyTitle, 
            mimeType: 'application/vnd.google-apps.folder', 
            parents: [parentId] 
        }, 
        fields: 'id'
    });
    return folder.result.id;
}

async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId, isAiGenerated = false) {
    const fileMetadata = { 
        name: `${chapterTitle}.txt`, 
        parents: [storyFolderId],
        description: isAiGenerated ? "AI-Generated" : "User-Created"
    };
    
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', 
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}

async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    const folders = response.result.files; 
    storyHistory = [];
    
    for (let folder of folders) {
        if (folder.name === 'AI_Generated_Stories') continue;
        
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime, description)'
        });
        storyHistory.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files,
            isAiGenerated: false
        });
    }
    displayHistory(); 
    displayFolders();
}

async function loadAiGeneratedStories() {
    const aiFolderName = 'AI_Generated_Stories';
    const response = await gapi.client.drive.files.list({
        q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id, name)'
    });
    
    if (response.result.files.length === 0) {
        aiGeneratedStories = [];
        return;
    }
    
    const aiFolderId = response.result.files[0].id;
    const aiFoldersResponse = await gapi.client.drive.files.list({
        q: `'${aiFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    
    const aiFolders = aiFoldersResponse.result.files;
    aiGeneratedStories = [];
    
    for (let folder of aiFolders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime, description)'
        });
        aiGeneratedStories.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files,
            isAiGenerated: true
        });
    }
}

// AI Training Functions - C·∫¢I TI·∫æN CHO H·ªåC S√ÇUH∆†N
async function trainAI() {
    showLoading(true);
    showStatus('ƒêang b·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI chuy√™n s√¢u...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            await deepProcessContent(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    await saveAiKnowledge();
    showLoading(false);
    showStatus(`Hu·∫•n luy·ªán ho√†n th√†nh! ƒê√£ x·ª≠ l√Ω ${processedFiles} file v·ªõi h·ªçc s√¢u.`, 'success');
}

// H√ÄM H·ªåC S√ÇU - PH√ÇN T√çCH CHUY√äN S√ÇU N·ªòI DUNG
async function deepProcessContent(content, storyTitle, fileName) {
    const sentences = content.split(/[.!?]+/).filter(s => s.length > 5);
    const paragraphs = content.split(/\n\s*\n/).filter(p => p.length > 10);
    
    sentences.forEach((sentence, index) => {
        // H·ªçc t·ª´ v·ª±ng c∆° b·∫£n
        const words = sentence.toLowerCase()
            .replace(/[^\w\s√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/g, '')
            .split(/\s+/);
        
        words.forEach(word => {
            if (word.length > 2) {
                aiKnowledge.vocabulary.add(word);
            }
        });
        
        // H·ªçc c·∫•u tr√∫c c√¢u ph·ª©c t·∫°p
        if (sentence.match(/t√¥i (c·∫£m th·∫•y|nghƒ©|th·∫•y|nh·∫≠n ra|ƒë·ªÉ √Ω)/i)) {
            aiKnowledge.sentenceStructures.add(sentence.trim());
        }
        
        // Ph√°t hi·ªán di·ªÖn bi·∫øn t√¨nh ti·∫øt
        if (sentence.match(/(khi|l√∫c|sau khi|tr∆∞·ªõc khi|trong l√∫c|b·ªóng nhi√™n|ƒë·ªôt ng·ªôt)/i)) {
            aiKnowledge.plotPoints.add(sentence.trim());
        }
        
        // H·ªçc pattern c·∫£m x√∫c v√† t√¢m l√Ω
        if (sentence.match(/(cƒÉng th·∫≥ng|lo l·∫Øng|b·ªëi r·ªëi|k√≠ch th√≠ch|khao kh√°t|t·ªôi l·ªói|kh√¥ng th·ªÉ|ph·∫£i chƒÉng)/i)) {
            aiKnowledge.emotionalPatterns.add(sentence.trim());
        }
        
        // Ph√¢n t√≠ch m·ªëi quan h·ªá
        if (sentence.match(/(b·ªë (ch·ªìng|t√¥i)|con d√¢u|v·ª£ t√¥i|h·ªç|ch√∫ng t√¥i)/i)) {
            aiKnowledge.characterRelationships.add(sentence.trim());
        }
        
        // H·ªçc style t∆∞·ªùng thu·∫≠t ng√¥i th·ª© nh·∫•t
        if (sentence.match(/^(t√¥i|trong t√¢m tr√≠|c·∫£m gi√°c|ƒëi·ªÅu n√†y khi·∫øn)/i)) {
            aiKnowledge.narrativeStyles.add(sentence.trim());
        }
        
        // L∆∞u dialogue
        if (sentence.includes('"') || sentence.includes('"') || sentence.includes('"')) {
            const dialogueMatch = sentence.match(/["'"](.*?)["'"]/);
            if (dialogueMatch && !aiKnowledge.dialogues.includes(dialogueMatch[1])) {
                aiKnowledge.dialogues.push(dialogueMatch[1]);
            }
        }
        
        // L∆∞u context
        if (sentence.match(/(trong|khi|l√∫c|sau|tr∆∞·ªõc|v√†o|gi·ªØa|·ªü)/)) {
            if (!aiKnowledge.contexts.includes(sentence) && aiKnowledge.contexts.length < 1000) {
                aiKnowledge.contexts.push(sentence);
            }
        }
    });
    
    // Ph√¢n t√≠ch paragraph ƒë·ªÉ h·ªçc c·∫•u tr√∫c d√†i h∆°n
    paragraphs.forEach(paragraph => {
        if (paragraph.length > 100 && paragraph.length < 500) {
            // H·ªçc c·∫•u tr√∫c ƒëo·∫°n vƒÉn
            if (!aiKnowledge.paragraphStructures) aiKnowledge.paragraphStructures = [];
            if (aiKnowledge.paragraphStructures.length < 500) {
                aiKnowledge.paragraphStructures.push(paragraph.trim());
            }
        }
    });
    
    // L∆∞u th√¥ng tin truy·ªán
    if (!aiKnowledge.stories.includes(storyTitle)) {
        aiKnowledge.stories.push(storyTitle);
    }
}

function updateAiStats() {
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('sentenceStructures').textContent = aiKnowledge.sentenceStructures.size;
    document.getElementById('plotPoints').textContent = aiKnowledge.plotPoints.size;
    document.getElementById('emotionalPatterns').textContent = aiKnowledge.emotionalPatterns.size;
}

// H√ÄM T·∫†O TRUY·ªÜN C·∫¢I TI·∫æN - LOGIC TH√îNG MINH H·ªöN
async function generateStory() {
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
    if (chapterCount < 100 || chapterCount > 150) {
        showStatus('S·ªë ch∆∞∆°ng ph·∫£i t·ª´ 100 ƒë·∫øn 150!', 'error');
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán ƒë·ªß! H√£y hu·∫•n luy·ªán AI v·ªõi √≠t nh·∫•t 100 t·ª´ v·ª±ng.', 'error');
        return;
    }
    
    showLoading(true);
    showStatus('AI ƒëang t·∫°o truy·ªán v·ªõi logic n√¢ng cao...', 'success');
    
    // T·∫°o c·ªët truy·ªán t·ªïng th·ªÉ tr∆∞·ªõc
    const overallPlot = generateOverallPlot();
    const title = generateIntelligentTitle();
    
    // Create folder for the new story
    const storyFolderId = await createStoryFolder(title, true);
    
    // Generate chapters with progressive storyline
    let generatedChapters = 0;
    const totalChapters = chapterCount;
    
    for (let i = 1; i <= totalChapters; i++) {
        const chapterTitle = `Ch∆∞∆°ng ${i}: ${generateChapterTitle(i, totalChapters)}`;
        const chapterContent = generateIntelligentChapterContent(i, totalChapters, overallPlot);
        
        // Save chapter to Google Drive
        await saveStoryContent(title, chapterTitle, chapterContent, storyFolderId, true);
        
        generatedChapters++;
        
        // Update progress
        const progress = (generatedChapters / totalChapters) * 100;
        document.getElementById('generationProgressFill').style.width = progress + '%';
        document.getElementById('generationStatus').innerHTML = 
            `<div class="status success">ƒêang t·∫°o ch∆∞∆°ng ${generatedChapters}/${totalChapters}: ${chapterTitle}</div>`;
        
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // Reload stories
    await loadAiGeneratedStories();
    await loadStoryHistory();
    showLoading(false);
    showStatus(`ƒê√£ t·∫°o th√†nh c√¥ng truy·ªán "${title}" v·ªõi ${totalChapters} ch∆∞∆°ng!`, 'success');
    document.getElementById('generationStatus').innerHTML = '';
}

// H√ÄM T·∫†O C·ªêT TRUY·ªÜN T·ªîNG TH·ªÇ
function generateOverallPlot() {
    const plotPhases = {
        introduction: "Kh·ªüi ƒë·∫ßu v·ªõi s·ª± quan s√°t ƒë·∫ßu ti√™n c·ªßa ng∆∞·ªùi ch·ªìng v·ªÅ m·ªëi quan h·ªá ƒë·∫∑c bi·ªát",
        development: "Ph√°t tri·ªÉn c√°c t√¨nh ti·∫øt ph·ª©c t·∫°p v√† s·ª± thay ƒë·ªïi trong m·ªëi quan h·ªá",
        climax: "ƒê·ªânh cao c·ªßa xung ƒë·ªôt n·ªôi t√¢m v√† nh·ªØng kh√°m ph√° quan tr·ªçng",
        resolution: "Gi·∫£i quy·∫øt v√† k·∫øt th√∫c v·ªõi s·ª± th·∫•u hi·ªÉu s√¢u s·∫Øc"
    };
    
    return {
        mainTheme: "M·ªëi quan h·ªá ph·ª©c t·∫°p trong gia ƒë√¨nh qua g√≥c nh√¨n c·ªßa ng∆∞·ªùi ch·ªìng",
        characterDevelopment: "S·ª± thay ƒë·ªïi nh·∫≠n th·ª©c v√† c·∫£m x√∫c c·ªßa nh√¢n v·∫≠t ch√≠nh",
        emotionalArc: "T·ª´ t√≤ m√≤ ban ƒë·∫ßu ƒë·∫øn hi·ªÉu bi·∫øt s√¢u s·∫Øc v·ªÅ b·∫£n ch·∫•t con ng∆∞·ªùi",
        phases: plotPhases
    };
}

// H√ÄM T·∫†O TI√äU ƒê·ªÄ TH√îNG MINH
function generateIntelligentTitle() {
    const titleTemplates = [
        "Nh·ªØng ƒêi·ªÅu T√¥i Th·∫ßm Bi·∫øt",
        "B√≠ M·∫≠t Trong Gia ƒê√¨nh",
        "G√≥c Nh√¨n C·ªßa Ng∆∞·ªùi Ch·ªìng",
        "Quan S√°t Trong Th·∫ßm L·∫∑ng",
        "Nh·ªØng G√¨ T√¥i Kh√¥ng N√≥i Ra",
        "Ranh Gi·ªõi M·ªù Nh·∫°t",
        "C√¢u Chuy·ªán Ch∆∞a K·ªÉ",
        "Trong S·ª± Im L·∫∑ng"
    ];
    
    return titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
}

// H√ÄM T·∫†O TI√äU ƒê·ªÄ CH∆Ø∆†NG
function generateChapterTitle(chapterNum, totalChapters) {
    const progress = chapterNum / totalChapters;
    
    if (progress < 0.2) {
        // Giai ƒëo·∫°n m·ªü ƒë·∫ßu
        const beginningTitles = ["Kh·ªüi ƒë·∫ßu quan s√°t", "Nh·ªØng d·∫•u hi·ªáu ƒë·∫ßu ti√™n", "S·ª± t√≤ m√≤ b·∫Øt ƒë·∫ßu", "C·∫£m gi√°c l·∫° l√πng"];
        return beginningTitles[Math.floor(Math.random() * beginningTitles.length)];
    } else if (progress < 0.5) {
        // Giai ƒëo·∫°n ph√°t tri·ªÉn
        const developmentTitles = ["Nh·∫≠n ra ƒëi·ªÅu b·∫•t th∆∞·ªùng", "Quan s√°t k·ªπ h∆°n", "Nh·ªØng ph√°t hi·ªán m·ªõi", "S·ª± thay ƒë·ªïi"];
        return developmentTitles[Math.floor(Math.random() * developmentTitles.length)];
    } else if (progress < 0.8) {
        // Giai ƒëo·∫°n cao tr√†o
        const climaxTitles = ["Xung ƒë·ªôt n·ªôi t√¢m", "Kh√°m ph√° s·ª± th·∫≠t", "Kh√¥ng th·ªÉ ph·ªß nh·∫≠n", "ƒê·ªëi m·∫∑t v·ªõi th·ª±c t·∫ø"];
        return climaxTitles[Math.floor(Math.random() * climaxTitles.length)];
    } else {
        // Giai ƒëo·∫°n k·∫øt th√∫c
        const endingTitles = ["S·ª± th·∫•u hi·ªÉu", "Ch·∫•p nh·∫≠n th·ª±c t·∫ø", "K·∫øt lu·∫≠n cu·ªëi c√πng", "B√¨nh y√™n t√¨m l·∫°i"];
        return endingTitles[Math.floor(Math.random() * endingTitles.length)];
    }
}

// H√ÄM T·∫†O N·ªòI DUNG CH∆Ø∆†NG TH√îNG MINH
function generateIntelligentChapterContent(chapterNum, totalChapters, overallPlot) {
    const progress = chapterNum / totalChapters;
    let content = "";
    
    // X√°c ƒë·ªãnh giai ƒëo·∫°n c·ªët truy·ªán
    let phase = 'introduction';
    if (progress > 0.25) phase = 'development';
    if (progress > 0.65) phase = 'climax';
    if (progress > 0.85) phase = 'resolution';
    
    // T·∫°o ƒëo·∫°n m·ªü ƒë·∫ßu ph√π h·ª£p v·ªõi giai ƒëo·∫°n
    content += generatePhaseIntro(phase, chapterNum) + "\n\n";
    
    // T·∫°o 3-5 ƒëo·∫°n vƒÉn ch√≠nh
    const paragraphCount = 3 + Math.floor(Math.random() * 3);
    for (let i = 0; i < paragraphCount; i++) {
        content += generateIntelligentParagraph(phase, i, paragraphCount) + "\n\n";
    }
    
    // Th√™m k·∫øt th√∫c ch∆∞∆°ng
    content += generateChapterEnding(phase) + "\n";
    
    return content;
}

// H√ÄM T·∫†O ƒêO·∫†N M·ªû ƒê·∫¶U THEO GIAI ƒêO·∫†N
function generatePhaseIntro(phase, chapterNum) {
    const templates = {
        introduction: [
            `H√¥m nay l√† ng√†y th·ª© ${chapterNum} k·ªÉ t·ª´ khi t√¥i b·∫Øt ƒë·∫ßu ƒë·ªÉ √Ω ƒë·∫øn nh·ªØng ƒëi·ªÅu l·∫° l√πng trong nh√†.`,
            `T√¥i kh√¥ng th·ªÉ ng·ªù ƒë∆∞·ª£c r·∫±ng cu·ªôc s·ªëng gia ƒë√¨nh t√¥i l·∫°i c√≥ nh·ªØng b√≠ m·∫≠t nh∆∞ th·∫ø n√†y.`,
            `M·ªçi th·ª© b·∫Øt ƒë·∫ßu t·ª´ m·ªôt c·ª≠ ch·ªâ nh·ªè m√† t√¥i t√¨nh c·ªù nh·∫≠n ra.`
        ],
        development: [
            `C√†ng quan s√°t, t√¥i c√†ng th·∫•y r√µ h∆°n v·ªÅ m·ªëi quan h·ªá ƒë·∫∑c bi·ªát n√†y.`,
            `Nh·ªØng nghi ng·ªù trong t√¥i ng√†y c√†ng l·ªõn d·∫ßn theo th·ªùi gian.`,
            `T√¥i b·∫Øt ƒë·∫ßu hi·ªÉu t·∫°i sao m·ªçi th·ª© trong nh√† l·∫°i c√≥ nh·ªØng thay ƒë·ªïi tinh t·∫ø.`
        ],
        climax: [
            `H√¥m nay, t√¥i kh√¥ng th·ªÉ ph·ªß nh·∫≠n nh·ªØng g√¨ ƒëang di·ªÖn ra tr∆∞·ªõc m·∫Øt m√¨nh.`,
            `S·ª± th·∫≠t ƒë√£ tr·ªü n√™n qu√° r√µ r√†ng ƒë·ªÉ t√¥i c√≥ th·ªÉ b·ªè qua.`,
            `Xung ƒë·ªôt trong t√¢m tr√≠ t√¥i ƒë·∫°t ƒë·∫øn ƒë·ªânh ƒëi·ªÉm.`
        ],
        resolution: [
            `Cu·ªëi c√πng, t√¥i c≈©ng t√¨m ƒë∆∞·ª£c c√°ch ƒë·ªÉ hi·ªÉu v√† ch·∫•p nh·∫≠n th·ª±c t·∫ø.`,
            `Nh√¨n l·∫°i ch·∫∑ng ƒë∆∞·ªùng ƒë√£ qua, t√¥i nh·∫≠n ra nhi·ªÅu ƒëi·ªÅu v·ªÅ b·∫£n th√¢n m√¨nh.`,
            `Gi·ªù ƒë√¢y, t√¥i c√≥ th·ªÉ nh√¨n nh·∫≠n m·ªçi th·ª© m·ªôt c√°ch b√¨nh tƒ©nh h∆°n.`
        ]
    };
    
    const phaseTemplates = templates[phase] || templates.introduction;
    return phaseTemplates[Math.floor(Math.random() * phaseTemplates.length)];
}

// H√ÄM T·∫†O ƒêO·∫†N VƒÇN TH√îNG MINH
function generateIntelligentParagraph(phase, paragraphIndex, totalParagraphs) {
    let paragraph = "";
    
    // T·∫°o 4-6 c√¢u cho m·ªói ƒëo·∫°n
    const sentenceCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < sentenceCount; i++) {
        paragraph += generateContextualSentence(phase, i, sentenceCount) + " ";
    }
    
    return paragraph.trim();
}

// H√ÄM T·∫†O C√ÇU V·ªöI NG·ªÆ C·∫¢NH
function generateContextualSentence(phase, sentenceIndex, totalSentences) {
    // S·ª≠ d·ª•ng ki·∫øn th·ª©c ƒë√£ h·ªçc ƒë·ªÉ t·∫°o c√¢u c√≥ nghƒ©a
    const learnedStructures = Array.from(aiKnowledge.sentenceStructures);
    const learnedEmotions = Array.from(aiKnowledge.emotionalPatterns);
    const learnedPlots = Array.from(aiKnowledge.plotPoints);
    
    if (learnedStructures.length > 0 && Math.random() < 0.3) {
        // S·ª≠ d·ª•ng c·∫•u tr√∫c ƒë√£ h·ªçc
        return adaptLearnedSentence(getRandomElement(learnedStructures));
    }
    
    // T·∫°o c√¢u m·ªõi d·ª±a tr√™n pattern
    const patterns = narrativePatterns[phase === 'climax' ? 'conflict' : 'observation'] || narrativePatterns.innerMonologue;
    let sentence = getRandomElement(patterns);
    
    // Thay th·∫ø placeholder
    sentence = replacePlaceholders(sentence);
    
    return sentence;
}

// H√ÄM CHUY·ªÇN ƒê·ªîI C√ÇU ƒê√É H·ªåC
function adaptLearnedSentence(sentence) {
    // Thay ƒë·ªïi nh·∫π c·∫•u tr√∫c ƒë·ªÉ t·∫°o s·ª± ƒëa d·∫°ng
    sentence = sentence.replace(/\b(t√¥i|m√¨nh)\b/gi, Math.random() < 0.3 ? 'b·∫£n th√¢n t√¥i' : 't√¥i');
    sentence = sentence.replace(/\b(th·∫•y|nh√¨n)\b/gi, Math.random() < 0.3 ? 'quan s√°t' : 'th·∫•y');
    sentence = sentence.replace(/\b(c·∫£m th·∫•y|c·∫£m gi√°c)\b/gi, Math.random() < 0.3 ? 'nh·∫≠n th·ª©c' : 'c·∫£m th·∫•y');
    
    return sentence;
}

// H√ÄM THAY TH·∫æ PLACEHOLDER
function replacePlaceholders(sentence) {
    const replacements = {
        '{situation}': getRandomElement(['b·ªØa c∆°m t·ªëi', 'l√∫c xem TV', 'khi t√¥i v·ªÅ nh√†', 'nh·ªØng bu·ªïi chi·ªÅu', 'cu·ªëi tu·∫ßn']),
        '{wife}': getRandomElement(['v·ª£ t√¥i', 'con d√¢u', 'c√¥ ·∫•y', 'ng∆∞·ªùi ph·ª• n·ªØ trong nh√†']),
        '{observation}': getRandomElement(['c√°ch nh√¨n', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'n·ª• c∆∞·ªùi', 'c√°ch c∆∞ x·ª≠']),
        '{emotion}': getRandomElement(['b·ªëi r·ªëi', 't√≤ m√≤', 'lo l·∫Øng', 'k√≠ch th√≠ch', 'kh√¥ng y√™n']),
        '{action}': getRandomElement(['n√≥i chuy·ªán', 'c∆∞·ªùi ƒë√πa', 'gi√∫p ƒë·ª°', 'ƒë·ª©ng g·∫ßn', 'trao ƒë·ªïi']),
        '{manner}': getRandomElement(['th√¢n m·∫≠t', 'k√≠n ƒë√°o', 't·ª± nhi√™n', 'ƒë·∫∑c bi·ªát', 'kh√°c th∆∞·ªùng']),
        '{innerThought}': getRandomElement(['t√¥i th·∫Øc m·∫Øc', 't√¥i bƒÉn khoƒÉn', 't√¥i suy ng·∫´m', 't√¥i t·ª± h·ªèi']),
        '{question}': getRandomElement(['ƒëi·ªÅu n√†y c√≥ √Ω nghƒ©a g√¨', 't√¥i c√≥ n√™n lo l·∫Øng', 'ƒë√¢y c√≥ ph·∫£i ƒëi·ªÅu b√¨nh th∆∞·ªùng', 'm·ªçi th·ª© c√≥ ƒëang thay ƒë·ªïi']),
        '{feeling}': getRandomElement(['cƒÉng th·∫≥ng', 'b·∫•t an', 't√≤ m√≤', 'kh√≥ hi·ªÉu', 'ph·ª©c t·∫°p']),
        '{intensity}': getRandomElement(['m·∫°nh m·∫Ω', 's√¢u s·∫Øc', 'kh√¥ng th·ªÉ ph·ªß nh·∫≠n', 'ng√†y c√†ng r√µ r√†ng']),
        '{physicalDescription}': getRandomElement(['√°nh m·∫Øt', 'n·ª• c∆∞·ªùi', 'c√°ch di chuy·ªÉn', 'c·ª≠ ch·ªâ tay', 'bi·ªÉu c·∫£m']),
        '{timeFrame}': getRandomElement(['nh·ªØng ng√†y g·∫ßn ƒë√¢y', 'th·ªùi gian qua', 'tu·∫ßn v·ª´a r·ªìi', 'g·∫ßn ƒë√¢y'])
    };
    
    Object.keys(replacements).forEach(placeholder => {
        sentence = sentence.replace(new RegExp(placeholder, 'g'), replacements[placeholder]);
    });
    
    return sentence;
}

// H√ÄM T·∫†O K·∫æT TH√öC CH∆Ø∆†NG
function generateChapterEnding(phase) {
    const endings = {
        introduction: [
            "T√¥i quy·∫øt ƒë·ªãnh s·∫Ω quan s√°t k·ªπ h∆°n trong nh·ªØng ng√†y t·ªõi.",
            "C√≥ l·∫Ω t√¥i c·∫ßn th·ªùi gian ƒë·ªÉ hi·ªÉu r√µ h∆°n v·ªÅ t√¨nh h√¨nh n√†y.",
            "C√¢u h·ªèi trong ƒë·∫ßu t√¥i v·∫´n ch∆∞a c√≥ l·ªùi gi·∫£i ƒë√°p."
        ],
        development: [
            "M·ªçi th·ª© ƒëang tr·ªü n√™n ph·ª©c t·∫°p h∆°n t√¥i nghƒ©.",
            "T√¥i c·∫£m th·∫•y m√¨nh ƒëang ƒë·ª©ng tr∆∞·ªõc m·ªôt b√≠ ·∫©n l·ªõn.",
            "Nh·ªØng m·∫£nh gh√©p b·∫Øt ƒë·∫ßu kh·ªõp v·ªõi nhau trong t√¢m tr√≠ t√¥i."
        ],
        climax: [
            "Gi·ªù ƒë√¢y t√¥i kh√¥ng th·ªÉ l√†m ng∆° tr∆∞·ªõc s·ª± th·∫≠t n√†y n·ªØa.",
            "Cu·ªôc s·ªëng c·ªßa t√¥i s·∫Ω kh√¥ng bao gi·ªù nh∆∞ tr∆∞·ªõc.",
            "T√¥i ph·∫£i ƒë·ªëi m·∫∑t v·ªõi th·ª±c t·∫ø d√π c√≥ ƒëau ƒë·ªõn ƒë·∫øn ƒë√¢u."
        ],
        resolution: [
            "Cu·ªëi c√πng t√¥i c≈©ng t√¨m ƒë∆∞·ª£c s·ª± b√¨nh y√™n trong t√¢m h·ªìn.",
            "T√¥i h·ªçc ƒë∆∞·ª£c r·∫±ng cu·ªôc s·ªëng lu√¥n ph·ª©c t·∫°p h∆°n nh·ªØng g√¨ ta nghƒ©.",
            "Gi·ªù ƒë√¢y t√¥i c√≥ th·ªÉ nh√¨n m·ªçi th·ª© v·ªõi con m·∫Øt kh√°c."
        ]
    };
    
    const phaseEndings = endings[phase] || endings.introduction;
    return phaseEndings[Math.floor(Math.random() * phaseEndings.length)];
}

// H√ÄM L·∫§Y PH·∫¶N T·ª¨ NG·∫™U NHI√äN
function getRandomElement(array) {
    if (!array || array.length === 0) return '';
    return array[Math.floor(Math.random() * array.length)];
}

// H√ÄM L·ª∞U KI·∫æN TH·ª®C AI
async function saveAiKnowledge() {
    const knowledgeStr = JSON.stringify({
        vocabulary: Array.from(aiKnowledge.vocabulary),
        stories: aiKnowledge.stories,
        trainedFiles: aiKnowledge.trainedFiles,
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        plotPoints: Array.from(aiKnowledge.plotPoints),
        emotionalPatterns: Array.from(aiKnowledge.emotionalPatterns),
        dialogues: aiKnowledge.dialogues || [],
        contexts: aiKnowledge.contexts || [],
        characterRelationships: Array.from(aiKnowledge.characterRelationships || new Set()),
        narrativeStyles: Array.from(aiKnowledge.narrativeStyles || new Set()),
        paragraphStructures: aiKnowledge.paragraphStructures || []
    });
    
    const fileName = 'ai_knowledge_advanced.json';
    const response = await gapi.client.drive.files.list({
        q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id)'
    });
    
    if (response.result.files.length > 0) {
        const fileId = response.result.files[0].id;
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: knowledgeStr
        });
    } else {
        const fileMetadata = { 
            name: fileName, 
            parents: [mainFolderId] 
        };
        
        await gapi.client.request({
            path: 'https://www.googleapis.com/upload/drive/v3/files', 
            method: 'POST',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
            body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                  JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n' +
                  knowledgeStr + '\r\n--foo_bar_baz--'
        });
    }
}

// H√ÄM T·∫¢I KI·∫æN TH·ª®C AI
async function loadAiKnowledge() {
    const fileName = 'ai_knowledge_advanced.json';
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            const knowledge = JSON.parse(fileResponse.body);
            aiKnowledge.vocabulary = new Set(knowledge.vocabulary);
            aiKnowledge.stories = knowledge.stories;
            aiKnowledge.trainedFiles = knowledge.trainedFiles;
            aiKnowledge.sentenceStructures = new Set(knowledge.sentenceStructures || []);
            aiKnowledge.plotPoints = new Set(knowledge.plotPoints || []);
            aiKnowledge.emotionalPatterns = new Set(knowledge.emotionalPatterns || []);
            aiKnowledge.dialogues = knowledge.dialogues || [];
            aiKnowledge.contexts = knowledge.contexts || [];
            aiKnowledge.characterRelationships = new Set(knowledge.characterRelationships || []);
            aiKnowledge.narrativeStyles = new Set(knowledge.narrativeStyles || []);
            aiKnowledge.paragraphStructures = knowledge.paragraphStructures || [];
        }
    } catch (error) {
        console.error('Error loading AI knowledge:', error);
    }
}

function resetAI() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô ki·∫øn th·ª©c c·ªßa AI?')) {
        aiKnowledge = { 
            vocabulary: new Set(), 
            stories: [], 
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set()
        };
        updateAiStats();
        saveAiKnowledge();
        showStatus('ƒê√£ reset ki·∫øn th·ª©c c·ªßa AI!', 'success');
    }
}

// H√ÄM KI·ªÇM TRA N·ªòI DUNG NH·∫†Y C·∫¢M
function isSensitiveContent(content) {
    const sensitiveKeywords = [
        'b·ªë ch·ªìng', 'con d√¢u', 'khao kh√°t', 'k√≠ch th√≠ch', 'd·ª•c v·ªçng', 'b√≠ m·∫≠t', 
        'th·∫ßm k√≠n', 'c·∫•m k·ªã', 'ranh gi·ªõi', 'quan h·ªá ƒë·∫∑c bi·ªát', 'kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i',
        'ham mu·ªën', 'th√®m mu·ªën', 't·ªôi l·ªói', 'x·∫•u h·ªï', 'b·ªëi r·ªëi v·ªÅ t√¨nh d·ª•c'
    ];
    
    return sensitiveKeywords.some(keyword => 
        content.toLowerCase().includes(keyword.toLowerCase())
    );
}

// H√ÄM HI·ªÇN TH·ªä N·ªòI DUNG CH∆Ø∆†NG
async function viewChapterContent(chapter, folderId) {
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapter.id,
            alt: 'media'
        });
        
        const content = response.body;
        chapterContent.textContent = content;
        chapterContent.style.display = 'block';
        chapterActions.style.display = 'block';
        currentEditingChapter = { id: chapter.id, content: content, name: chapter.name };
        
        // Ki·ªÉm tra v√† x·ª≠ l√Ω n·ªôi dung nh·∫°y c·∫£m
        if (isSensitiveContent(content)) {
            chapterContent.classList.add('sensitive-content');
            
            const revealBtn = document.createElement('button');
            revealBtn.className = 'reveal-btn';
            revealBtn.textContent = 'üëÅÔ∏è Hi·ªÉn th·ªã n·ªôi dung nh·∫°y c·∫£m';
            revealBtn.onclick = function() {
                chapterContent.classList.toggle('revealed');
                this.textContent = chapterContent.classList.contains('revealed') ? 
                    'üôà ·∫®n n·ªôi dung nh·∫°y c·∫£m' : 'üëÅÔ∏è Hi·ªÉn th·ªã n·ªôi dung nh·∫°y c·∫£m';
            };
            
            chapterContent.parentNode.insertBefore(revealBtn, chapterContent);
        }
    } catch (error) {
        console.error('Error loading chapter content:', error);
        showStatus('C√≥ l·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng!', 'error');
    }
}

// UI Functions
function displayHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    const allStories = [...storyHistory, ...aiGeneratedStories];
    
    if (allStories.length === 0) {
        historyList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ truy·ªán n√†o.</div>';
        return;
    }
    
    allStories.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = () => viewStoryChapters(story);
        
        let adultTag = story.isAiGenerated ? ' <span style="color:#ff9a3d">[AI-18+]</span>' : '';
        
        item.innerHTML = `
            <div class="story-title">${story.storyTitle}${adultTag}</div>
            <div class="story-chapter">${story.chapters.length} ch∆∞∆°ng</div>
            <div class="story-date">${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
        `;
        historyList.appendChild(item);
    });
}

function displayFolders() {
    const folderList = document.getElementById('folderList');
    const existingStory = document.getElementById('existingStory');
    folderList.innerHTML = '';
    existingStory.innerHTML = '<option value="">-- Ch·ªçn truy·ªán --</option>';
    
    if (storyHistory.length === 0) {
        folderList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ th∆∞ m·ª•c n√†o.</div>';
        return;
    }
    
    storyHistory.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        item.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">${story.chapters.length} ch∆∞∆°ng</div>
        `;
        folderList.appendChild(item);
        
        const option = document.createElement('option');
        option.value = story.folderId;
        option.textContent = story.storyTitle;
        existingStory.appendChild(option);
    });
}

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'L∆∞u Truy·ªán M·ªõi';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Th√™m Ch∆∞∆°ng M·ªõi';
    }
}

async function handleStoryFormSubmit(e) {
    e.preventDefault();
    showLoading(true);
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = document.getElementById('storyTitle').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const storyContent = document.getElementById('storyContent').value;
    
    try {
        let storyFolderId;
        if (mode === 'new') {
            storyFolderId = await createStoryFolder(storyTitle);
        } else {
            storyFolderId = document.getElementById('existingStory').value;
            if (!storyFolderId) {
                showStatus('Vui l√≤ng ch·ªçn m·ªôt truy·ªán c√≥ s·∫µn!', 'error');
                showLoading(false);
                return;
            }
        }
        
        await saveStoryContent(storyTitle, chapterTitle, storyContent, storyFolderId);
        await loadStoryHistory();
        
        document.getElementById('storyForm').reset();
        showStatus('ƒê√£ l∆∞u truy·ªán th√†nh c√¥ng!', 'success');
    } catch (error) {
        console.error('Error saving story:', error);
        showStatus('C√≥ l·ªói x·∫£y ra khi l∆∞u truy·ªán!', 'error');
    }
    showLoading(false);
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = `status ${type}`;
    statusEl.style.display = 'block';
    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Modal Functions
function viewStoryChapters(story) {
    const modal = document.getElementById('chaptersModal');
    const title = document.getElementById('chaptersModalTitle');
    const chapterList = document.getElementById('chapterList');
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    title.textContent = story.storyTitle;
    chapterList.innerHTML = '';
    chapterContent.style.display = 'none';
    chapterActions.style.display = 'none';
    
    story.chapters.forEach(chapter => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.onclick = () => viewChapterContent(chapter, story.folderId);
        item.textContent = chapter.name.replace('.txt', '');
        chapterList.appendChild(item);
    });
    
    modal.style.display = 'block';
}

function editChapter() {
    const chapterContent = document.getElementById('chapterContent');
    chapterContent.contentEditable = true;
    chapterContent.focus();
    chapterContent.style.background = 'rgba(255, 255, 255, 0.1)';
    chapterContent.style.border = '1px solid rgba(102, 126, 234, 0.5)';
}

async function saveChapterChanges() {
    if (!currentEditingChapter) return;
    
    const chapterContent = document.getElementById('chapterContent');
    const newContent = chapterContent.textContent;
    
    try {
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: newContent
        });
        
        chapterContent.contentEditable = false;
        chapterContent.style.background = 'rgba(255, 255, 255, 0.05)';
        chapterContent.style.border = 'none';
        currentEditingChapter.content = newContent;
        
        showStatus('ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
    } catch (error) {
        console.error('Error saving chapter changes:', error);
        showStatus('C√≥ l·ªói khi l∆∞u thay ƒë·ªïi!', 'error');
    }
}

function cancelEdit() {
    const chapterContent = document.getElementById('chapterContent');
    chapterContent.textContent = currentEditingChapter.content;
    chapterContent.contentEditable = false;
    chapterContent.style.background = 'rgba(255, 255, 255, 0.05)';
    chapterContent.style.border = 'none';
}

async function deleteChapter() {
    if (!currentEditingChapter || !confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y?')) return;
    
    try {
        await gapi.client.drive.files.delete({ fileId: currentEditingChapter.id });
        closeModal('chaptersModal');
        await loadStoryHistory();
        showStatus('ƒê√£ x√≥a ch∆∞∆°ng th√†nh c√¥ng!', 'success');
    } catch (error) {
        console.error('Error deleting chapter:', error);
        showStatus('C√≥ l·ªói khi x√≥a ch∆∞∆°ng!', 'error');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    currentEditingChapter = null;
    
    // Remove reveal buttons
    const revealBtns = document.querySelectorAll('.reveal-btn');
    revealBtns.forEach(btn => btn.remove());
}

function viewAiStories() {
    const modal = document.getElementById('aiStoriesModal');
    const aiStoryList = document.getElementById('aiStoryList');
    
    aiStoryList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        aiStoryList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c AI t·∫°o.</div>';
    } else {
        aiGeneratedStories.forEach(story => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.onclick = () => {
                closeModal('aiStoriesModal');
                viewStoryChapters(story);
            };
            
            item.innerHTML = `
                <div class="story-title">${story.storyTitle} <span style="color:#ff9a3d">[AI-18+]</span></div>
                <div class="story-chapter">${story.chapters.length} ch∆∞∆°ng - ${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
            `;
            aiStoryList.appendChild(item);
        });
    }
    
    modal.style.display = 'block';
}

// Menu Navigation
function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.getElementById(sectionId).classList.add('active');
    
    document.querySelectorAll('.nav-menu button').forEach(button => {
        button.classList.remove('active');
    });
    document.querySelector(`.nav-menu button[data-section="${sectionId}"]`).classList.add('active');
}

// Event Listeners
document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
document.getElementById('storyForm').addEventListener('submit', handleStoryFormSubmit);
document.getElementById('trainAiButton').addEventListener('click', trainAI);
document.getElementById('resetAiButton').addEventListener('click', resetAI);
document.getElementById('generateStoryButton').addEventListener('click', generateStory);
document.getElementById('viewAiStoriesButton').addEventListener('click', viewAiStories);

// Menu navigation event listeners
document.getElementById('menuTraining').addEventListener('click', () => showSection('trainingSection'));
document.getElementById('menuGeneration').addEventListener('click', () => showSection('generationSection'));
document.getElementById('menuManagement').addEventListener('click', () => showSection('managementSection'));
document.getElementById('menuHistory').addEventListener('click', () => showSection('historySection'));

// Add data-section attributes to menu buttons
document.getElementById('menuTraining').setAttribute('data-section', 'trainingSection');
document.getElementById('menuGeneration').setAttribute('data-section', 'generationSection');
document.getElementById('menuManagement').setAttribute('data-section', 'managementSection');
document.getElementById('menuHistory').setAttribute('data-section', 'historySection');

// Initialize the app
window.onload = () => {
    initializeGapi();
    initializeGis();
};
</script>
</body>
</html>
