<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Generator - QuanLyTruyen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .login-panel {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.full-width {
            width: 100%;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background-color: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background-color: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .status.info {
            background-color: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .story-output {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .story-content {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            line-height: 1.8;
            font-size: 16px;
            min-height: 200px;
            white-space: pre-wrap;
            font-family: 'Georgia', serif;
        }

        .progress {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            width: 0%;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .file-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .ai-analysis {
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .theme-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }

        .rating-section {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            color: #d3d3d3;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active, .star:hover {
            color: #ffc107;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .user-info {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="user-info hidden" id="userInfo">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName"></span>
        <button class="btn" onclick="signOut()">ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Story Generator</h1>
            <p>H·ªá th·ªëng AI t·∫°o truy·ªán th√¥ng minh t·ª´ d·ªØ li·ªáu Google Drive</p>
        </div>

        <!-- Panel ƒëƒÉng nh·∫≠p -->
        <div class="login-panel" id="loginPanel">
            <h2>üîê ƒêƒÉng nh·∫≠p Google</h2>
            <p style="margin: 20px 0; color: #666;">
                Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p folder "QuanLyTruyen" v√† s·ª≠ d·ª•ng AI Story Generator
            </p>
            <button class="btn full-width" onclick="signIn()">
                üìß ƒêƒÉng nh·∫≠p v·ªõi Google
            </button>
            <div id="loginStatus"></div>
        </div>

        <!-- N·ªôi dung ch√≠nh -->
        <div class="main-content hidden" id="mainContent">
            <div class="panel">
                <h2>üìÅ Ph√¢n t√≠ch d·ªØ li·ªáu truy·ªán</h2>
                
                <div class="input-group">
                    <label for="folderId">Folder ID "QuanLyTruyen":</label>
                    <input type="text" id="folderId" placeholder="Nh·∫≠p ID folder ho·∫∑c ƒë·ªÉ tr·ªëng t·ª± ƒë·ªông t√¨m">
                </div>

                <button class="btn full-width" onclick="loadAndAnalyzeData()">üîç T·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu</button>

                <div id="connectionStatus"></div>
                <div class="progress">
                    <div class="progress-bar" id="loadProgress"></div>
                </div>

                <div class="ai-analysis hidden" id="aiAnalysis">
                    <h4>üìä K·∫øt qu·∫£ ph√¢n t√≠ch AI:</h4>
                    <div id="analysisResult"></div>
                </div>

                <div class="file-list hidden" id="fileList">
                    <h4>Files ƒë√£ ph√¢n t√≠ch:</h4>
                </div>
            </div>

            <div class="panel">
                <h2>‚úçÔ∏è T·∫°o truy·ªán m·ªõi</h2>
                
                <div class="input-group">
                    <label for="storyLength">ƒê·ªô d√†i truy·ªán:</label>
                    <select id="storyLength">
                        <option value="short">Ng·∫Øn (800-1200 t·ª´)</option>
                        <option value="medium">Trung b√¨nh (1500-2500 t·ª´)</option>
                        <option value="long">D√†i (3000+ t·ª´)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="customPrompt">Y√™u c·∫ßu ƒë·∫∑c bi·ªát:</label>
                    <textarea id="customPrompt" rows="3" placeholder="VD: T·∫≠p trung v√†o t√¢m l√Ω nh√¢n v·∫≠t, th√™m y·∫øu t·ªë b·∫•t ng·ªù, k·∫øt th√∫c c√≥ h·∫≠u..."></textarea>
                </div>

                <button class="btn full-width" onclick="generateStory()" id="generateBtn" disabled>‚ú® T·∫°o truy·ªán m·ªõi</button>

                <div id="generationStatus"></div>
            </div>
        </div>

        <div class="story-output hidden" id="storyOutput">
            <h2>üìñ Truy·ªán ƒë∆∞·ª£c t·∫°o</h2>
            <div class="story-content" id="storyContent">
                Truy·ªán s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
            </div>
            
            <div class="rating-section">
                <h4>‚≠ê ƒê√°nh gi√° truy·ªán ƒë·ªÉ AI h·ªçc t·ªët h∆°n:</h4>
                <div class="star-rating" id="starRating">
                    <span class="star" data-rating="1">‚≠ê</span>
                    <span class="star" data-rating="2">‚≠ê</span>
                    <span class="star" data-rating="3">‚≠ê</span>
                    <span class="star" data-rating="4">‚≠ê</span>
                    <span class="star" data-rating="5">‚≠ê</span>
                </div>
                <textarea id="feedback" rows="3" placeholder="Nh·∫≠n x√©t c·ª• th·ªÉ ƒë·ªÉ AI c·∫£i thi·ªán (t√πy ch·ªçn)..."></textarea>
                <button class="btn" onclick="submitRating()">üíæ G·ª≠i ƒë√°nh gi√°</button>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveStory()">üíæ L∆∞u truy·ªán</button>
                <button class="btn" onclick="generateStory()">üîÑ T·∫°o truy·ªán kh√°c</button>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh Google API
        const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
        const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        // Bi·∫øn to√†n c·ª•c
        let gapi, google, tokenClient;
        let isSignedIn = false;
        let storyData = [];
        let aiModel = null;
        let currentUser = null;
        let isApiLoaded = false;

        // Load Google APIs
        function loadGoogleAPIs() {
            return new Promise((resolve, reject) => {
                // Load gapi first
                const gapiScript = document.createElement('script');
                gapiScript.src = 'https://apis.google.com/js/api.js';
                gapiScript.onload = () => {
                    // Load Google Identity Services
                    const gisScript = document.createElement('script');
                    gisScript.src = 'https://accounts.google.com/gsi/client';
                    gisScript.onload = () => {
                        resolve();
                    };
                    gisScript.onerror = reject;
                    document.head.appendChild(gisScript);
                };
                gapiScript.onerror = reject;
                document.head.appendChild(gapiScript);
            });
        }

        // Kh·ªüi t·∫°o Google API
        async function initializeGapi() {
            try {
                if (!window.gapi) {
                    throw new Error('Google API ch∆∞a ƒë∆∞·ª£c load');
                }

                // Wait for gapi to be ready
                await new Promise((resolve) => {
                    window.gapi.load('client:auth2', resolve);
                });
                
                await window.gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });

                if (!window.google) {
                    throw new Error('Google Identity Services ch∆∞a ƒë∆∞·ª£c load');
                }

                tokenClient = window.google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse,
                });

                isApiLoaded = true;
                console.log('Google API initialized successfully');
                
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showStatus('loginStatus', 'error', 'L·ªói kh·ªüi t·∫°o Google API: ' + error.message);
                throw error;
            }
        }

        // X·ª≠ l√Ω ph·∫£n h·ªìi x√°c th·ª±c
        function handleAuthResponse(resp) {
            if (resp.error !== undefined) {
                showStatus('loginStatus', 'error', 'L·ªói ƒëƒÉng nh·∫≠p: ' + resp.error);
                return;
            }
            
            isSignedIn = true;
            getCurrentUser();
            showMainContent();
        }

        // L·∫•y th√¥ng tin user hi·ªán t·∫°i
        async function getCurrentUser() {
            try {
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v1/userinfo',
                });
                
                currentUser = response.result;
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').src = currentUser.picture;
                document.getElementById('userInfo').classList.remove('hidden');
            } catch (error) {
                console.error('L·ªói l·∫•y th√¥ng tin user:', error);
            }
        }

        // ƒêƒÉng nh·∫≠p
        function signIn() {
            if (!tokenClient) {
                showStatus('loginStatus', 'error', 'Google API ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
                return;
            }
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        // ƒêƒÉng xu·∫•t
        function signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            isSignedIn = false;
            currentUser = null;
            
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('storyOutput').classList.add('hidden');
        }

        // Hi·ªÉn th·ªã n·ªôi dung ch√≠nh
        function showMainContent() {
            document.getElementById('loginPanel').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            showStatus('loginStatus', 'success', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
        }

        // T·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu
        async function loadAndAnalyzeData() {
            if (!isSignedIn) {
                showStatus('connectionStatus', 'error', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
                return;
            }

            if (!window.gapi || !window.gapi.client) {
                showStatus('connectionStatus', 'error', 'Google API ch∆∞a s·∫µn s√†ng');
                return;
            }

            showStatus('connectionStatus', 'info', 'ƒêang t√¨m ki·∫øm folder QuanLyTruyen...');
            updateProgress(10);

            try {
                let folderId = document.getElementById('folderId').value;
                
                if (!folderId) {
                    // T·ª± ƒë·ªông t√¨m folder "QuanLyTruyen"
                    folderId = await findFolderByName('QuanLyTruyen');
                    if (!folderId) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y folder "QuanLyTruyen" trong Google Drive c·ªßa b·∫°n. Vui l√≤ng t·∫°o folder ho·∫∑c nh·∫≠p ID th·ªß c√¥ng.');
                    }
                    document.getElementById('folderId').value = folderId;
                }

                updateProgress(30);
                showStatus('connectionStatus', 'info', 'ƒêang t·∫£i files t·ª´ folder...');

                // L·∫•y danh s√°ch files .txt trong folder
                const files = await getFilesFromFolder(folderId);
                updateProgress(50);

                if (files.length === 0) {
                    throw new Error('Kh√¥ng c√≥ file .txt n√†o trong folder "QuanLyTruyen". Vui l√≤ng th√™m file truy·ªán (.txt) v√†o folder.');
                }

                showStatus('connectionStatus', 'info', `ƒêang ph√¢n t√≠ch ${files.length} files...`);
                
                // T·∫£i v√† ph√¢n t√≠ch n·ªôi dung
                storyData = [];
                for (let i = 0; i < files.length; i++) {
                    try {
                        const content = await getFileContent(files[i].id);
                        if (content && content.trim().length > 0) {
                            storyData.push({
                                name: files[i].name,
                                content: content,
                                size: formatFileSize(files[i].size || content.length)
                            });
                        }
                    } catch (error) {
                        console.warn(`Kh√¥ng th·ªÉ ƒë·ªçc file ${files[i].name}:`, error);
                    }
                    updateProgress(50 + (i + 1) * 30 / files.length);
                }

                if (storyData.length === 0) {
                    throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c n·ªôi dung t·ª´ c√°c file trong folder.');
                }

                // Kh·ªüi t·∫°o v√† hu·∫•n luy·ªán AI
                await initializeAdvancedAI();
                updateProgress(100);

                showStatus('connectionStatus', 'success', `ƒê√£ ph√¢n t√≠ch th√†nh c√¥ng ${storyData.length} truy·ªán!`);
                displayAnalysisResults();
                displayFileList();
                document.getElementById('generateBtn').disabled = false;

            } catch (error) {
                console.error('Error in loadAndAnalyzeData:', error);
                showStatus('connectionStatus', 'error', 'L·ªói: ' + error.message);
                updateProgress(0);
            }
        }

        // T√¨m folder theo t√™n
        async function findFolderByName(folderName) {
            try {
                const response = await window.gapi.client.drive.files.list({
                    q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)'
                });

                const folders = response.result.files;
                return folders.length > 0 ? folders[0].id : null;
            } catch (error) {
                console.error('L·ªói t√¨m folder:', error);
                throw new Error('L·ªói khi t√¨m ki·∫øm folder: ' + error.message);
            }
        }

        // L·∫•y files t·ª´ folder
        async function getFilesFromFolder(folderId) {
            try {
                const response = await window.gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and (name contains '.txt' or mimeType='text/plain') and trashed=false`,
                    fields: 'files(id, name, size, mimeType)',
                    pageSize: 100
                });

                return response.result.files || [];
            } catch (error) {
                console.error('L·ªói l·∫•y files:', error);
                throw new Error('L·ªói khi l·∫•y danh s√°ch file: ' + error.message);
            }
        }

        // L·∫•y n·ªôi dung file
        async function getFileContent(fileId) {
            try {
                const response = await window.gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                // ƒê·∫£m b·∫£o encoding UTF-8
                let content = response.body;
                if (typeof content !== 'string') {
                    content = new TextDecoder('utf-8').decode(content);
                }
                
                return content;
            } catch (error) {
                console.error('L·ªói l·∫•y n·ªôi dung file:', error);
                throw new Error('Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung file: ' + error.message);
            }
        }

        // Kh·ªüi t·∫°o AI n√¢ng cao
        async function initializeAdvancedAI() {
            showStatus('connectionStatus', 'info', 'ƒêang hu·∫•n luy·ªán AI...');
            
            aiModel = {
                vocabulary: new Map(),
                patterns: [],
                themes: new Set(),
                characters: new Set(),
                locations: new Set(),
                emotions: new Set(),
                plotElements: [],
                writingStyle: {
                    averageSentenceLength: 0,
                    commonWords: new Map(),
                    narrativeStyle: '',
                    tone: ''
                },
                qualityMetrics: {
                    ratings: [],
                    feedback: []
                }
            };

            // Ph√¢n t√≠ch t·ª´ng truy·ªán
            for (const story of storyData) {
                await analyzeStoryContent(story.content);
            }

            // X√°c ƒë·ªãnh ƒë·∫∑c tr∆∞ng chung
            determineOverallCharacteristics();
        }

        // Ph√¢n t√≠ch n·ªôi dung truy·ªán
        async function analyzeStoryContent(content) {
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const words = content.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            
            // Ph√¢n t√≠ch vocabulary
            words.forEach(word => {
                const cleanWord = word.replace(/[^\w\s√Ä-·ªπ]/g, '');
                if (cleanWord.length > 2) {
                    aiModel.vocabulary.set(cleanWord, (aiModel.vocabulary.get(cleanWord) || 0) + 1);
                }
            });

            // T√¨m nh√¢n v·∫≠t (t√™n ri√™ng)
            const namePattern = /\b[A-Z√Ä√Å·∫†·∫¢√É√Ç·∫¶·∫§·∫¨·∫®·∫™ƒÇ·∫∞·∫Æ·∫∂·∫≤·∫¥√à√â·∫∏·∫∫·∫º√ä·ªÄ·∫æ·ªÜ·ªÇ·ªÑ√å√ç·ªä·ªàƒ®√í√ì·ªå·ªé√ï√î·ªí·ªê·ªò·ªî·ªñ∆†·ªú·ªö·ª¢·ªû·ª†√ô√ö·ª§·ª¶≈®∆Ø·ª™·ª®·ª∞·ª¨·ªÆ·ª≤√ù·ª¥·ª∂·ª∏ƒê][a-z√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]+\b/g;
            const names = content.match(namePattern) || [];
            names.forEach(name => aiModel.characters.add(name));

            // T√¨m ƒë·ªãa ƒëi·ªÉm
            const locationKeywords = ['th√†nh ph·ªë', 'l√†ng', 'r·ª´ng', 'n√∫i', 'bi·ªÉn', 'tr∆∞·ªùng', 'nh√†', 'c√¥ng vi√™n', 'b·ªánh vi·ªán'];
            locationKeywords.forEach(keyword => {
                if (content.toLowerCase().includes(keyword)) {
                    aiModel.locations.add(keyword);
                }
            });

            // Ph√¢n t√≠ch c·∫£m x√∫c
            const emotionWords = {
                'vui': ['vui', 'h·∫°nh ph√∫c', 'vui v·∫ª', 'ph·∫•n kh√≠ch', 'h·ª©ng th√∫'],
                'bu·ªìn': ['bu·ªìn', 'kh√≥c', 'ƒëau kh·ªï', 'tuy·ªát v·ªçng', 'th·∫•t v·ªçng'],
                's·ª£': ['s·ª£', 'lo l·∫Øng', 'ho·∫£ng s·ª£', 'kinh ho√†ng', 'b·∫•t an'],
                'gi·∫≠n': ['gi·∫≠n', 't·ª©c gi·∫≠n', 'ph·∫´n n·ªô', 'b·ª±c b·ªôi', 'c√°u k·ªânh'],
                'y√™u': ['y√™u', 'th∆∞∆°ng', 'qu√Ω', 'tr√¢n tr·ªçng', '√¢u y·∫øm']
            };

            for (const [emotion, keywords] of Object.entries(emotionWords)) {
                keywords.forEach(keyword => {
                    if (content.toLowerCase().includes(keyword)) {
                        aiModel.emotions.add(emotion);
                    }
                });
            }

            // L∆∞u patterns c√¢u hay
            sentences.filter(s => s.trim().length > 20 && s.trim().length < 100)
                    .forEach(s => aiModel.patterns.push(s.trim()));

            return true;
        }

        // X√°c ƒë·ªãnh ƒë·∫∑c tr∆∞ng t·ªïng th·ªÉ
        function determineOverallCharacteristics() {
            // T√≠nh ƒë·ªô d√†i c√¢u trung b√¨nh
            const allSentences = aiModel.patterns;
            const totalLength = allSentences.reduce((sum, sentence) => sum + sentence.length, 0);
            aiModel.writingStyle.averageSentenceLength = Math.round(totalLength / allSentences.length);

            // T√¨m t·ª´ ph·ªï bi·∫øn
            const sortedWords = Array.from(aiModel.vocabulary.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);
            aiModel.writingStyle.commonWords = new Map(sortedWords);

            // X√°c ƒë·ªãnh ch·ªß ƒë·ªÅ ch√≠nh
            const themeKeywords = {
                't√¨nh y√™u': ['y√™u', 'th∆∞∆°ng', 't√¨nh', 'l√£ng m·∫°n', 'h·∫πn h√≤'],
                'gia ƒë√¨nh': ['gia ƒë√¨nh', 'm·∫π', 'b·ªë', 'con', 'anh ch·ªã em'],
                'h·ªçc ƒë∆∞·ªùng': ['tr∆∞·ªùng', 'h·ªçc', 'gi√°o vi√™n', 'b·∫°n h·ªçc', 'thi c·ª≠'],
                'phi√™u l∆∞u': ['h√†nh tr√¨nh', 'kh√°m ph√°', 'm·∫°o hi·ªÉm', 'cu·ªôc s·ªëng'],
                'huy·ªÅn b√≠': ['b√≠ ·∫©n', 'ma thu·∫≠t', 'si√™u nhi√™n', 'k·ª≥ l·∫°'],
                'x√£ h·ªôi': ['x√£ h·ªôi', 'cu·ªôc s·ªëng', 'ng∆∞·ªùi d√¢n', 'th√†nh ph·ªë']
            };

            for (const [theme, keywords] of Object.entries(themeKeywords)) {
                let score = 0;
                keywords.forEach(keyword => {
                    if (aiModel.writingStyle.commonWords.has(keyword)) {
                        score += aiModel.writingStyle.commonWords.get(keyword);
                    }
                });
                if (score > 0) {
                    aiModel.themes.add(theme);
                }
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ ph√¢n t√≠ch
        function displayAnalysisResults() {
            const analysisDiv = document.getElementById('analysisResult');
            const themes = Array.from(aiModel.themes);
            const characters = Array.from(aiModel.characters).slice(0, 10);
            const emotions = Array.from(aiModel.emotions);

            let html = `
                <p><strong>üéØ Ch·ªß ƒë·ªÅ ƒë∆∞·ª£c ph√°t hi·ªán:</strong></p>
                <div style="margin: 10px 0;">
                    ${themes.map(theme => `<span class="theme-tag">${theme}</span>`).join('')}
                </div>
                <p><strong>üë• Nh√¢n v·∫≠t ph·ªï bi·∫øn:</strong> ${characters.join(', ')}</p>
                <p><strong>üí≠ C·∫£m x√∫c ch·ªß ƒë·∫°o:</strong> ${emotions.join(', ')}</p>
                <p><strong>üìä T·ª´ v·ª±ng:</strong> ${aiModel.vocabulary.size} t·ª´ ƒë·ªôc ƒë√°o</p>
                <p><strong>üìù M·∫´u c√¢u:</strong> ${aiModel.patterns.length} pattern</p>
            `;

            analysisDiv.innerHTML = html;
            document.getElementById('aiAnalysis').classList.remove('hidden');
        }

        // Hi·ªÉn th·ªã danh s√°ch files
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            let html = '<h4>Files ƒë√£ ph√¢n t√≠ch:</h4>';
            
            storyData.forEach(file => {
                html += `
                    <div class="file-item">
                        <span>üìÑ ${file.name}</span>
                        <span style="font-size: 12px; color: #666;">${file.size}</span>
                    </div>
                `;
            });
            
            fileList.innerHTML = html;
            fileList.classList.remove('hidden');
        }

        // T·∫°o truy·ªán m·ªõi
        async function generateStory() {
            if (!aiModel) {
                showStatus('generationStatus', 'error', 'AI ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!');
                return;
            }

            const length = document.getElementById('storyLength').value;
            const customPrompt = document.getElementById('customPrompt').value;

            showStatus('generationStatus', 'info', 'AI ƒëang s√°ng t√°c truy·ªán...');
            document.getElementById('generateBtn').disabled = true;

            try {
                await new Promise(resolve => setTimeout(resolve, 3000)); // Gi·∫£ l·∫≠p qu√° tr√¨nh AI thinking
                
                const story = await generateAdvancedStory(length, customPrompt);
                
                document.getElementById('storyContent').textContent = story;
                document.getElementById('storyOutput').classList.remove('hidden');
                document.getElementById('storyOutput').scrollIntoView({ behavior: 'smooth' });
                
                showStatus('generationStatus', 'success', 'Truy·ªán ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                
            } catch (error) {
                showStatus('generationStatus', 'error', 'L·ªói khi t·∫°o truy·ªán: ' + error.message);
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        // T·∫°o n·ªôi dung truy·ªán n√¢ng cao
        async function generateAdvancedStory(length, customPrompt) {
            const targetLength = length === 'short' ? 1000 : length === 'medium' ? 2000 : 3000;
            const themes = Array.from(aiModel.themes);
            const characters = Array.from(aiModel.characters);
            const emotions = Array.from(aiModel.emotions);
            const commonWords = Array.from(aiModel.writingStyle.commonWords.keys()).slice(0, 20);
            
            // Ch·ªçn ch·ªß ƒë·ªÅ ch√≠nh
            const mainTheme = themes[Math.floor(Math.random() * themes.length)] || 'cu·ªôc s·ªëng';
            
            // T·∫°o nh√¢n v·∫≠t ch√≠nh
            const mainCharacter = characters[Math.floor(Math.random() * characters.length)] || generateVietnameseName();
            const supportCharacter = characters[Math.floor(Math.random() * characters.length)] || generateVietnameseName();
            
            // T·∫°o ti√™u ƒë·ªÅ
            const titles = generateVietnameseTitle(mainTheme);
            
            let story = `${titles}\n\n`;
            
            // Ph·∫ßn m·ªü ƒë·∫ßu (20% ƒë·ªô d√†i)
            story += generateOpening(mainCharacter, mainTheme, Math.floor(targetLength * 0.2));
            story += '\n\n';
            
            // Ph·∫ßn ph√°t tri·ªÉn (50% ƒë·ªô d√†i)
            story += generateDevelopment(mainCharacter, supportCharacter, mainTheme, customPrompt, Math.floor(targetLength * 0.5));
            story += '\n\n';
            
            // Ph·∫ßn cao tr√†o (20% ƒë·ªô d√†i)
            story += generateClimax(mainCharacter, supportCharacter, mainTheme, Math.floor(targetLength * 0.2));
            story += '\n\n';
            
            // Ph·∫ßn k·∫øt th√∫c (10% ƒë·ªô d√†i)
            story += generateEnding(mainCharacter, mainTheme, Math.floor(targetLength * 0.1));
            
            return story;
        }

        // T·∫°o t√™n ti·∫øng Vi·ªát
        function generateVietnameseName() {
            const firstNames = ['An', 'B·∫£o', 'Chi', 'Dung', 'H√†', 'H∆∞∆°ng', 'Linh', 'Minh', 'Nam', 'Ph∆∞∆°ng', 'Qu·ª≥nh', 'Th·∫£o', 'T√πng', 'Uy√™n', 'V√¢n', 'Xu√¢n'];
            const lastNames = ['Nguy·ªÖn', 'Tr·∫ßn', 'L√™', 'Ph·∫°m', 'Ho√†ng', 'Phan', 'V≈©', 'ƒê·∫∑ng', 'B√πi', 'ƒê·ªó'];
            
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            
            return `${lastName} ${firstName}`;
        }

        // T·∫°o ti√™u ƒë·ªÅ ti·∫øng Vi·ªát
        function generateVietnameseTitle(theme) {
            const titleTemplates = {
                't√¨nh y√™u': [
                    'M√πa Thu V√† Em',
                    'N∆°i T√¨nh Y√™u B·∫Øt ƒê·∫ßu', 
                    'Chuy·ªán T√¨nh Kh√¥ng T√™n',
                    'Y√™u Th∆∞∆°ng Ng√†y ·∫§y',
                    'H·∫°nh Ph√∫c Gi·∫£n ƒê∆°n'
                ],
                'gia ƒë√¨nh': [
                    'V·ªÅ Nh√† L√† V·ªÅ',
                    'M·∫π V√† Nh·ªØng ƒêi·ªÅu Ch∆∞a N√≥i',
                    'Gia ƒê√¨nh Nh·ªè',
                    'T√¨nh Ph·ª• T·ª≠',
                    'K√Ω ·ª®c Tu·ªïi Th∆°'
                ],
                'h·ªçc ƒë∆∞·ªùng': [
                    'Nh·ªØng Ng√†y H·ªçc Tr√≤',
                    'Tu·ªïi 18 R·ª±c R·ª°',
                    'Thanh Xu√¢n Nh∆∞ M√¢y Bay',
                    'L·ªõp H·ªçc C·ªßa Ch√∫ng Ta',
                    'K·ª∑ Y·∫øu X∆∞a'
                ],
                'phi√™u l∆∞u': [
                    'H√†nh Tr√¨nh Kh√°m Ph√°',
                    'Cu·ªôc Phi√™u L∆∞u B·∫•t Ng·ªù',
                    'Kh√°m Ph√° Th·∫ø Gi·ªõi M·ªõi',
                    'Chuy·∫øn ƒêi Kh√¥ng H·ªìi K·∫øt',
                    'Nh·ªØng B∆∞·ªõc Ch√¢n Xa'
                ],
                'huy·ªÅn b√≠': [
                    'B√≠ ·∫®n ƒê√™m TrƒÉng',
                    'Th·∫ø Gi·ªõi Song Song',
                    'Ma Thu·∫≠t V√† Hi·ªán Th·ª±c',
                    'Gi·∫•c M∆° K·ª≥ L·∫°',
                    'S·ª©c M·∫°nh B√≠ ·∫®n'
                ]
            };
            
            const templates = titleTemplates[theme] || titleTemplates['t√¨nh y√™u'];
            return templates[Math.floor(Math.random() * templates.length)];
        }

        // T·∫°o ph·∫ßn m·ªü ƒë·∫ßu
        function generateOpening(character, theme, targetLength) {
            const openings = [
                `${character} lu√¥n tin r·∫±ng cu·ªôc s·ªëng s·∫Ω ƒë∆°n gi·∫£n h∆°n nhi·ªÅu n·∫øu nh∆∞ m·ªçi th·ª© ƒë·ªÅu c√≥ th·ªÉ d·ª± ƒëo√°n tr∆∞·ªõc. Nh∆∞ng s√°ng h√¥m ·∫•y, khi √°nh n·∫Øng ƒë·∫ßu ti√™n len l·ªèi qua khe c·ª≠a s·ªï, ${character.split(' ')[1]} bi·∫øt r·∫±ng ng√†y h√¥m nay s·∫Ω kh√°c bi·ªát.`,
                
                `Th·ªùi ti·∫øt th√°ng 10 ·ªü H√† N·ªôi c√≥ c√°i se se l·∫°nh ƒë·∫∑c tr∆∞ng m√† ${character} lu√¥n y√™u th√≠ch. ${character.split(' ')[1]} ng·ªìi b√™n c·ª≠a s·ªï, nh·∫•p t·ª´ng ng·ª•m tr√† n√≥ng v√† ng·∫Øm nh√¨n nh·ªØng chi·∫øc l√° v√†ng r∆°i. Cu·ªôc s·ªëng t∆∞·ªüng ch·ª´ng nh∆∞ ƒëang tr√¥i theo m·ªôt nh·ªãp ƒëi·ªáu quen thu·ªôc, cho ƒë·∫øn khi...`,
                
                `"C√≥ ph·∫£i cu·ªôc ƒë·ªùi n√†y qu√° ng·∫Øn ng·ªßi ƒë·ªÉ ta c·ª© m√£i ch·∫ßn ch·ª´?" - ${character} t·ª± h·ªèi trong l√≤ng khi ƒë·ª©ng tr∆∞·ªõc ng∆∞·ª°ng c·ª≠a c·ªßa m·ªôt quy·∫øt ƒë·ªãnh quan tr·ªçng. Nh·ªØng gi·ªçt m∆∞a li ti b·∫Øt ƒë·∫ßu r∆°i, nh∆∞ th·ªÉ tr·ªùi c≈©ng ƒëang c√πng ${character.split(' ')[1]} suy t∆∞.`
            ];
            
            let opening = openings[Math.floor(Math.random() * openings.length)];
            
            // M·ªü r·ªông n·ªôi dung ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i m·ª•c ti√™u
            const expansions = [
                ` ƒê√£ ba nƒÉm k·ªÉ t·ª´ khi ${character.split(' ')[1]} chuy·ªÉn v·ªÅ th√†nh ph·ªë nh·ªè n√†y ƒë·ªÉ s·ªëng. Ba nƒÉm v·ªõi nh·ªØng ng√†y th√°ng tr√¥i qua m·ªôt c√°ch √™m ƒë·ªÅm, kh√¥ng c√≥ g√¨ ƒë·∫∑c bi·ªát. C√¥ng vi·ªác t·∫°i th∆∞ vi·ªán th√†nh ph·ªë c≈©ng kh√° nh·∫π nh√†ng, cho ${character.split(' ')[1]} nhi·ªÅu th·ªùi gian ƒë·ªÉ ƒë·ªçc s√°ch v√† quan s√°t cu·ªôc s·ªëng xung quanh.`,
                
                ` Nh·ªØng ng∆∞·ªùi h√†ng x√≥m ƒë√£ quen v·ªõi h√¨nh ·∫£nh ${character} ra v∆∞·ªùn t∆∞·ªõi c√¢y m·ªói s√°ng. H·ªç th∆∞·ªùng ch√†o h·ªèi v√†i c√¢u, h·ªèi thƒÉm s·ª©c kh·ªèe, r·ªìi ai v·ªÅ nh√† n·∫•y l√†m nh·ªØng c√¥ng vi·ªác ri√™ng c·ªßa m√¨nh. Cu·ªôc s·ªëng ƒë∆°n gi·∫£n nh∆∞ng kh√¥ng thi·∫øu √Ω nghƒ©a.`,
                
                ` Nh∆∞ng s√°ng h√¥m nay, c√≥ ƒëi·ªÅu g√¨ ƒë√≥ trong kh√¥ng kh√≠ kh√°c l·∫°. C√≥ th·ªÉ l√† c√°ch √°nh n·∫Øng chi·∫øu qua t√°n l√°, hay l√† ti·∫øng chim h√≥t c√≥ v·∫ª trong tr·∫ªo h∆°n, ho·∫∑c ƒë∆°n gi·∫£n ch·ªâ l√† m·ªôt c·∫£m gi√°c m∆° h·ªì m√† ${character.split(' ')[1]} kh√¥ng th·ªÉ gi·∫£i th√≠ch ƒë∆∞·ª£c.`
            ];
            
            opening += expansions[Math.floor(Math.random() * expansions.length)];
            
            return opening;
        }

        // T·∫°o ph·∫ßn ph√°t tri·ªÉn
        function generateDevelopment(mainChar, supportChar, theme, customPrompt, targetLength) {
            let development = "";
            
            // Gi·ªõi thi·ªáu nh√¢n v·∫≠t ph·ª•
            const introductions = [
                `Ch√≠nh l√∫c ·∫•y, ${supportChar} xu·∫•t hi·ªán. ${supportChar.split(' ')[1]} l√† ng∆∞·ªùi m√† ${mainChar.split(' ')[1]} ch∆∞a t·ª´ng g·∫∑p trong th√†nh ph·ªë nh·ªè n√†y.`,
                `Cu·ªôc g·∫∑p g·ª° v·ªõi ${supportChar} di·ªÖn ra m·ªôt c√°ch ho√†n to√†n b·∫•t ng·ªù. Hai ng∆∞·ªùi va v√†o nhau ·ªü g√≥c ph·ªë, nh·ªØng cu·ªën s√°ch trong tay ${mainChar.split(' ')[1]} r∆°i tung t√≥e.`,
                `${supportChar} ƒë√£ l√†m vi·ªác ·ªü ƒë√¢y t·ª´ l√¢u, nh∆∞ng l·∫° thay ${mainChar.split(' ')[1]} ch∆∞a bao gi·ªù ch√∫ √Ω ƒë·∫øn s·ª± hi·ªán di·ªán c·ªßa ${supportChar.split(' ')[1]}.`
            ];
            
            development += introductions[Math.floor(Math.random() * introductions.length)];
            development += "\n\n";
            
            // Ph√°t tri·ªÉn m·ªëi quan h·ªá
            const relationships = [
                `T·ª´ cu·ªôc g·∫∑p g·ª° t√¨nh c·ªù ·∫•y, ${mainChar.split(' ')[1]} v√† ${supportChar.split(' ')[1]} b·∫Øt ƒë·∫ßu c√≥ nh·ªØng cu·ªôc tr√≤ chuy·ªán th√∫ v·ªã. ${supportChar.split(' ')[1]} c√≥ c√°ch nh√¨n v·ªÅ cu·ªôc s·ªëng r·∫•t kh√°c bi·ªát, ƒëi·ªÅu m√† ${mainChar.split(' ')[1]} ch∆∞a t·ª´ng nghƒ© t·ªõi.`,
                
                `H·ªç c√πng nhau kh√°m ph√° nh·ªØng g√≥c nh·ªè trong th√†nh ph·ªë m√† ${mainChar.split(' ')[1]} nghƒ© r·∫±ng m√¨nh ƒë√£ bi·∫øt h·∫øt. H√≥a ra, m·ªói con ƒë∆∞·ªùng, m·ªói ng√¥i nh√† ƒë·ªÅu c√≥ nh·ªØng c√¢u chuy·ªán ri√™ng, nh·ªØng b√≠ m·∫≠t ri√™ng.`,
                
                `${supportChar.split(' ')[1]} k·ªÉ cho ${mainChar.split(' ')[1]} nghe v·ªÅ nh·ªØng chuy·∫øn du l·ªãch, nh·ªØng cu·ªën s√°ch hay, nh·ªØng b·ªô phim c·∫£m ƒë·ªông. D·∫ßn d·∫ßn, th·∫ø gi·ªõi c·ªßa ${mainChar.split(' ')[1]} nh∆∞ ƒë∆∞·ª£c m·ªü r·ªông ra.`
            ];
            
            development += relationships[Math.floor(Math.random() * relationships.length)];
            development += "\n\n";
            
            // Th√™m y·∫øu t·ªë theo customPrompt n·∫øu c√≥
            if (customPrompt) {
                development += `ƒêi·ªÅu ƒë·∫∑c bi·ªát l√† ${customPrompt.toLowerCase().includes('b·∫•t ng·ªù') ? 'm·ªôt s·ª± ki·ªán b·∫•t ng·ªù x·∫£y ra' : 'm·ªçi chuy·ªán di·ªÖn ra theo c√°ch m√† c·∫£ hai ƒë·ªÅu kh√¥ng ng·ªù t·ªõi'}. `;
                development += `${mainChar.split(' ')[1]} nh·∫≠n ra r·∫±ng ${customPrompt.toLowerCase().includes('t√¢m l√Ω') ? 'nh·ªØng suy nghƒ© v√† c·∫£m x√∫c c·ªßa m√¨nh' : 'cu·ªôc s·ªëng'} ${customPrompt.toLowerCase().includes('thay ƒë·ªïi') ? 'ƒëang d·∫ßn thay ƒë·ªïi' : 'c√≥ nh·ªØng kh√≠a c·∫°nh m√† tr∆∞·ªõc ƒë√¢y ch∆∞a t·ª´ng kh√°m ph√°'}.\n\n`;
            }
            
            // Xung ƒë·ªôt ho·∫∑c th·ª≠ th√°ch
            const conflicts = [
                `Tuy nhi√™n, kh√¥ng ph·∫£i l√∫c n√†o m·ªçi th·ª© c≈©ng di·ªÖn ra su√¥n s·∫ª. ${mainChar.split(' ')[1]} v√† ${supportChar.split(' ')[1]} c√≥ nh·ªØng quan ƒëi·ªÉm kh√°c bi·ªát v·ªÅ nhi·ªÅu v·∫•n ƒë·ªÅ, d·∫´n ƒë·∫øn nh·ªØng cu·ªôc tranh lu·∫≠n s√¥i n·ªïi.`,
                
                `M·ªôt ng√†y n·ªç, ${supportChar.split(' ')[1]} ph·∫£i ƒë·ªëi m·∫∑t v·ªõi m·ªôt quy·∫øt ƒë·ªãnh kh√≥ khƒÉn. ${mainChar.split(' ')[1]} mu·ªën gi√∫p ƒë·ª° nh∆∞ng kh√¥ng bi·∫øt l√†m th·∫ø n√†o cho ph√π h·ª£p.`,
                
                `Kho·∫£ng c√°ch gi·ªØa hai ng∆∞·ªùi d∆∞·ªùng nh∆∞ c√†ng ng√†y c√†ng g·∫ßn g≈©i, nh∆∞ng c≈©ng c√≥ l√∫c ${mainChar.split(' ')[1]} c·∫£m th·∫•y lo l·∫Øng v·ªÅ nh·ªØng thay ƒë·ªïi trong cu·ªôc s·ªëng c·ªßa m√¨nh.`
            ];
            
            development += conflicts[Math.floor(Math.random() * conflicts.length)];
            
            return development;
        }

        // T·∫°o ph·∫ßn cao tr√†o
        function generateClimax(mainChar, supportChar, theme, targetLength) {
            const climaxScenarios = [
                `R·ªìi ƒë·∫øn m·ªôt chi·ªÅu m∆∞a t·∫ßm t√£, ${mainChar.split(' ')[1]} nh·∫≠n ƒë∆∞·ª£c tin t·ª©c quan tr·ªçng t·ª´ ${supportChar.split(' ')[1]}. ƒê√≥ l√† tin t·ª©c m√† c·∫£ hai ƒë√£ ch·ªù ƒë·ª£i t·ª´ l√¢u, nh∆∞ng khi n√≥ ƒë·∫øn th√¨ l·∫°i mang theo c·∫£ ni·ªÅm vui l·∫´n n·ªói lo.`,
                
                `S·ª± ki·ªán b∆∞·ªõc ngo·∫∑t x·∫£y ra v√†o ƒë√∫ng l√∫c ${mainChar.split(' ')[1]} nghƒ© r·∫±ng m√¨nh ƒë√£ hi·ªÉu r√µ v·ªÅ cu·ªôc s·ªëng n√†y. ${supportChar.split(' ')[1]} ƒë∆∞a ra m·ªôt ƒë·ªÅ ngh·ªã m√† ${mainChar.split(' ')[1]} c·∫ßn ph·∫£i suy nghƒ© th·∫≠t k·ªπ.`,
                
                `"C√≥ l·∫Ω ƒë√¢y l√† l√∫c ch√∫ng ta c·∫ßn ƒë∆∞a ra quy·∫øt ƒë·ªãnh cu·ªëi c√πng," ${supportChar.split(' ')[1]} n√≥i v·ªõi gi·ªçng ƒëi·ªáu nghi√™m t√∫c. ${mainChar.split(' ')[1]} bi·∫øt r·∫±ng d√π l·ª±a ch·ªçn g√¨, cu·ªôc s·ªëng c·ªßa m√¨nh c≈©ng s·∫Ω kh√¥ng c√≤n nh∆∞ x∆∞a.`
            ];
            
            let climax = climaxScenarios[Math.floor(Math.random() * climaxScenarios.length)];
            
            climax += ` ${mainChar.split(' ')[1]} ƒë·ª©ng tr∆∞·ªõc s·ª± l·ª±a ch·ªçn kh√≥ khƒÉn: ti·∫øp t·ª•c v·ªõi cu·ªôc s·ªëng an to√†n nh∆∞ tr∆∞·ªõc ƒë√¢y, hay m·∫°nh d·∫°n b∆∞·ªõc v√†o m·ªôt ch∆∞∆°ng m·ªõi ƒë·∫ßy b·∫•t ƒë·ªãnh. Nh·ªØng k√Ω ·ª©c v·ªÅ nh·ªØng ng√†y th√°ng v·ª´a qua c·ª© l·∫ßn l∆∞·ª£t tr√¥i qua trong ƒë·∫ßu ${mainChar.split(' ')[1]}.`;
            
            return climax;
        }

        // T·∫°o ph·∫ßn k·∫øt th√∫c
        function generateEnding(mainChar, theme, targetLength) {
            const endings = [
                `Cu·ªëi c√πng, ${mainChar.split(' ')[1]} ƒë√£ t√¨m th·∫•y c√¢u tr·∫£ l·ªùi trong ch√≠nh tr√°i tim m√¨nh. Quy·∫øt ƒë·ªãnh kh√¥ng d·ªÖ d√†ng, nh∆∞ng ${mainChar.split(' ')[1]} bi·∫øt ƒë√≥ l√† ƒëi·ªÅu ƒë√∫ng ƒë·∫Øn. Cu·ªôc s·ªëng ti·∫øp t·ª•c tr√¥i, nh∆∞ng gi·ªù ƒë√¢y v·ªõi m·ªôt √Ω nghƒ©a ho√†n to√†n m·ªõi.`,
                
                `Nh·ªØng ng√†y sau ƒë√≥, ${mainChar.split(' ')[1]} th∆∞·ªùng ng·ªìi ·ªü c√πng v·ªã tr√≠ b√™n c·ª≠a s·ªï, nh∆∞ng c√°ch nh√¨n v·ªÅ cu·ªôc s·ªëng ƒë√£ kh√°c. ${mainChar.split(' ')[1]} hi·ªÉu r·∫±ng m·ªói ng√†y ƒë·ªÅu l√† m·ªôt m√≥n qu√†, v√† ƒëi·ªÅu quan tr·ªçng l√† bi·∫øt tr√¢n tr·ªçng t·ª´ng kho·∫£nh kh·∫Øc.`,
                
                `C√¢u chuy·ªán k·∫øt th√∫c, nh∆∞ng cu·ªôc ƒë·ªùi th√¨ kh√¥ng. ${mainChar.split(' ')[1]} b∆∞·ªõc v√†o nh·ªØng ng√†y m·ªõi v·ªõi t√¢m th·∫ø kh√°c, mang theo nh·ªØng b√†i h·ªçc qu√Ω gi√° v√† hi v·ªçng v·ªÅ m·ªôt t∆∞∆°ng lai t·ªët ƒë·∫πp h∆°n.`
            ];
            
            return endings[Math.floor(Math.random() * endings.length)];
        }

        // X·ª≠ l√Ω ƒë√°nh gi√° sao
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            let currentRating = 0;

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.rating);
                    updateStarDisplay(currentRating);
                });

                star.addEventListener('mouseover', () => {
                    const hoverRating = parseInt(star.dataset.rating);
                    updateStarDisplay(hoverRating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', () => {
                updateStarDisplay(currentRating);
            });

            function updateStarDisplay(rating) {
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
        }

        // G·ª≠i ƒë√°nh gi√°
        function submitRating() {
            const stars = document.querySelectorAll('.star.active');
            const rating = stars.length;
            const feedback = document.getElementById('feedback').value;

            if (rating === 0) {
                alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë·ªÉ ƒë√°nh gi√°!');
                return;
            }

            // L∆∞u ƒë√°nh gi√° v√†o AI model ƒë·ªÉ h·ªçc
            aiModel.qualityMetrics.ratings.push(rating);
            if (feedback) {
                aiModel.qualityMetrics.feedback.push(feedback);
            }

            // Ph√¢n t√≠ch ƒë√°nh gi√° ƒë·ªÉ c·∫£i thi·ªán
            analyzeRatingFeedback(rating, feedback);

            showStatus('generationStatus', 'success', `C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√° ${rating} sao! AI s·∫Ω h·ªçc t·ª´ ph·∫£n h·ªìi n√†y.`);
            
            // Reset form
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.getElementById('feedback').value = '';
        }

        // Ph√¢n t√≠ch ph·∫£n h·ªìi ƒë·ªÉ c·∫£i thi·ªán AI
        function analyzeRatingFeedback(rating, feedback) {
            // C·∫≠p nh·∫≠t tr·ªçng s·ªë d·ª±a tr√™n ƒë√°nh gi√°
            if (rating >= 4) {
                // ƒê√°nh gi√° t·ªët - tƒÉng tr·ªçng s·ªë cho patterns ƒë√£ s·ª≠ d·ª•ng
                console.log('Positive feedback received, adjusting AI parameters...');
            } else if (rating <= 2) {
                // ƒê√°nh gi√° k√©m - gi·∫£m tr·ªçng s·ªë
                console.log('Negative feedback received, learning from mistakes...');
            }

            // Ph√¢n t√≠ch feedback text ƒë·ªÉ t√¨m ƒëi·ªÉm c·∫ßn c·∫£i thi·ªán
            if (feedback) {
                const improvementKeywords = {
                    'nh√¢n v·∫≠t': 'character_development',
                    'c·ªët truy·ªán': 'plot_structure', 
                    'c·∫£m x√∫c': 'emotional_depth',
                    'm·ªü ƒë·∫ßu': 'opening_style',
                    'k·∫øt th√∫c': 'ending_satisfaction',
                    'd√†i': 'story_length',
                    'ng·∫Øn': 'story_length',
                    'chi ti·∫øt': 'detail_level'
                };

                for (const [keyword, aspect] of Object.entries(improvementKeywords)) {
                    if (feedback.toLowerCase().includes(keyword)) {
                        // Ghi nh·∫≠n c·∫ßn c·∫£i thi·ªán kh√≠a c·∫°nh n√†y
                        console.log(`Need to improve: ${aspect}`);
                    }
                }
            }
        }

        // L∆∞u truy·ªán
        function saveStory() {
            const story = document.getElementById('storyContent').textContent;
            const timestamp = new Date().toLocaleString('vi-VN').replace(/[/:]/g, '-');
            
            const blob = new Blob([story], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Truyen_${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('generationStatus', 'success', 'Truy·ªán ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
        }

        // Utility functions
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function updateProgress(percent) {
            document.getElementById('loadProgress').style.width = percent + '%';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi trang ƒë∆∞·ª£c load
        window.onload = function() {
            console.log('Starting application initialization...');
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
            showStatus('loginStatus', 'info', 'ƒêang kh·ªüi t·∫°o Google API...');
            
            loadGoogleAPIs()
                .then(() => {
                    console.log('Google APIs loaded, initializing...');
                    return initializeGapi();
                })
                .then(() => {
                    console.log('Google API initialized successfully');
                    showStatus('loginStatus', 'success', 'Google API ƒë√£ s·∫µn s√†ng! Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.');
                    // Setup star rating
                    setupStarRating();
                })
                .catch(error => {
                    console.error('Error during initialization:', error);
                    showStatus('loginStatus', 'error', 'L·ªói kh·ªüi t·∫°o: ' + error.message + '. Vui l√≤ng t·∫£i l·∫°i trang.');
                });
        };
    </script>
</body>
</html>
