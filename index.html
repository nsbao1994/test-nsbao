<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Th√™m style cho c·∫£nh b√°o n·ªôi dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Style cho t√≠nh nƒÉng ƒë√°nh gi√° */
        .rating-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }
        
        .rating-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rating-btn.like {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .rating-btn.dislike {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
        }
        
        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Style cho giao di·ªán ƒë·ªçc truy·ªán */
        .reader-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            line-height: 1.8;
            font-size: 18px;
            text-align: justify;
        }
        
        .reader-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .chapter-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Style cho l·ªãch s·ª≠ ƒë·ªçc */
        .reading-history-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .history-info {
            flex: 1;
            min-width: 200px;
        }
        
        .continue-reading-btn {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* C·∫£i ti·∫øn giao di·ªán tr√™n mobile */
        @media (max-width: 768px) {
            .reader-content {
                padding: 15px;
                font-size: 16px;
            }
            
            .rating-section {
                flex-direction: column;
            }
            
            .reader-controls, .chapter-nav {
                flex-direction: column;
            }
            
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
            .chapter-actions { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(102, 126, 234, 0.7); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager - B·ªë Ch·ªìng Con D√¢u</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive - Chuy√™n ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úèÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI - Chuy√™n ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¢m l√Ω nh√¢n v·∫≠t:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¨nh hu·ªëng quan h·ªá:</span>
                                <span id="relationshipScenes">0</span>
                            </div>
                            <div class="stat-item">
                                <span>M√¢u thu·∫´n gia ƒë√¨nh:</span>
                                <span id="familyConflicts">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông - B·ªë Ch·ªìng Con D√¢u</h2>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫¢NH B√ÅO: N·ªôi dung 18+ - AI s·∫Ω t·∫°o truy·ªán theo ng√¥i th·ª© nh·∫•t (ng∆∞·ªùi ch·ªìng) k·ªÉ v·ªÅ m·ªëi quan h·ªá gi·ªØa b·ªë ch·ªìng v√† con d√¢u (v·ª£ m√¨nh)
                        </div>
                        
                        <div class="form-group">
                            <label for="storyTheme">Ch·ªçn ch·ªß ƒë·ªÅ ch√≠nh:</label>
                            <select id="storyTheme">
                                <option value="psychological">T√¢m l√Ω - T√¨nh c·∫£m ph·ª©c t·∫°p</option>
                                <option value="forbidden">C·∫•m k·ªµ - M·ªëi quan h·ªá b√≠ m·∫≠t</option>
                                <option value="familyDrama">Gia ƒë√¨nh - M√¢u thu·∫´n n·ªôi t√¢m</option>
                                <option value="emotional">C·∫£m x√∫c - Di·ªÖn bi·∫øn t√¢m tr·∫°ng</option>
                                <option value="fullJourney">H√†nh tr√¨nh ƒë·∫ßy ƒë·ªß t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi</option>
                            </select>
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (10-50)" min="10" max="50" value="20">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi - Ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                                <select id="storyMode">
                                    <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                    <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                                <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                                <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                            </div>
                           <div class="form-group">
                                <label for="storyContent">N·ªôi dung (k·ªÉ t·ª´ ng√¥i th·ª© nh·∫•t - ng∆∞·ªùi ch·ªìng):</label>
                                <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                            </div>
                            <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üìö L·ªãch s·ª≠ ƒê·ªçc Truy·ªán</h2></div>
                            <div class="history-list" id="readingHistoryList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üóÇ Th∆∞ m·ª•c Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>üìö Truy·ªán ƒê∆∞·ª£c T·∫°o B·ªüi AI - B·ªë Ch·ªìng Con D√¢u</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="chaptersModalTitle">Ch∆∞∆°ng Truy·ªán</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" id="editChapterBtn">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
                <button class="btn danger" id="deleteChapterBtn">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
                <button class="btn" id="saveChapterBtn" style="display: none;">üíæ L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" id="cancelEditBtn" style="display: none;">‚ùå H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Giao di·ªán ƒë·ªçc truy·ªán -->
    <div id="readerMode" class="reader-mode">
        <div class="reader-header">
            <h2 id="readerTitle">Ti√™u ƒë·ªÅ truy·ªán</h2>
            <button class="btn danger" id="closeReaderBtn">‚úñ ƒê√≥ng</button>
        </div>
        
        <div class="reader-content" id="readerContent">
            <!-- N·ªôi dung truy·ªán s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
        
        <div class="rating-section" id="ratingSection">
            <p>B·∫°n th·∫•y ch∆∞∆°ng n√†y nh∆∞ th·∫ø n√†o?</p>
            <button class="rating-btn like" id="rateChapterGood">üëç Truy·ªán hay</button>
            <button class="rating-btn dislike" id="rateChapterBad">üëé Truy·ªán ch∆∞a hay</button>
        </div>
        
        <div class="reader-controls">
            <div class="chapter-nav">
                <button class="btn" id="prevChapterBtn">‚¨Ö Ch∆∞∆°ng tr∆∞·ªõc</button>
                <span id="chapterIndicator">Ch∆∞∆°ng 1/100</span>
                <button class="btn" id="nextChapterBtn">Ch∆∞∆°ng sau ‚û°</button>
            </div>
        </div>
    </div>

<script>
// Kh·ªüi t·∫°o c√°c bi·∫øn to√†n c·ª•c
let tokenClient, gapiInited = false, gisInited = false;
let mainFolderId = null;
let storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    trainedFiles: 0,
    emotionalPatterns: new Set(),
    relationshipScenes: new Set(),
    familyConflicts: new Set(),
    processedFiles: new Set(),
    fatherInLawRelations: new Set(),
    daughterInLawRelations: new Set(),
    psychologicalStates: new Set(),
    forbiddenSituations: new Set(),
    goodSentences: new Set(),
    badSentences: new Set(),
    preferredVocabulary: {},
    avoidedVocabulary: {}
};
let aiGeneratedStories = [];
let currentEditingChapter = null;
let currentReadingStory = null;
let currentChapterIndex = 0;
let currentChaptersList = [];
let readingHistory = [];

// T·ª´ v·ª±ng chuy√™n bi·ªát cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
const specializedVocabulary = {
    familyRelations: ['b·ªë ch·ªìng', 'con d√¢u', 'ch·ªìng', 'v·ª£', 'gia ƒë√¨nh', 'h·ªç h√†ng', 'm·ªëi quan h·ªá', 'ph√©p t·∫Øc', 'ranh gi·ªõi', 'gia ƒë√¨nh v·ª£', 'nh√† ch·ªìng', 'b·ªë m·∫π ch·ªìng'],
    emotions: ['cƒÉng th·∫≥ng', 'b·ªëi r·ªëi', 'ghen t·ªã', 't√≤ m√≤', 'lo l·∫Øng', 'th√®m mu·ªën', 'khao kh√°t', 't·ªôi l·ªói', 'x·∫•u h·ªï', 'day d·ª©t', 'd·∫±n v·∫∑t', 'm√¢u thu·∫´n', 'gi·∫±ng x√©', 'ƒëam m√™', 'say ƒë·∫Øm'],
    actions: ['quan s√°t', 'nh√¨n tr·ªôm', 'theo d√µi', 'ch√∫ √Ω', 'ph√°t hi·ªán', 'ƒë·ªÉ √Ω', 'nh·∫≠n ra', 'th·∫•y ƒë∆∞·ª£c', 'c·∫£m nh·∫≠n', 'ti·∫øp x√∫c', 'va ch·∫°m', 'ch·∫°m nh·∫π', '√¥m', 'h√¥n', 'vu·ªët ve'],
    innerThoughts: ['t√¥i nghƒ©', 'trong t√¢m tr√≠ t√¥i', 't√¥i t·ª± h·ªèi', 'c√≥ l·∫Ω', 'li·ªáu r·∫±ng', 't√¥i kh√¥ng th·ªÉ tin ƒë∆∞·ª£c', 't√¥i c·∫£m th·∫•y', 't√¥i nh·∫≠n ra', 't√¥i mu·ªën', 't√¥i khao kh√°t'],
    secretive: ['b√≠ m·∫≠t', 'gi·∫•u k√≠n', 'che gi·∫•u', 'l√©n l√∫t', 'th·∫ßm k√≠n', 'k√≠n ƒë√°o', '√¢m th·∫ßm', 'kh√¥ng ai bi·∫øt', 'sau l∆∞ng', 'v·ª•ng tr·ªôm', 'l√©n l√∫t'],
    physicalDescriptions: ['ƒë√¥i m·∫Øt', 'n·ª• c∆∞·ªùi', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'c√°ch di chuy·ªÉn', 'gi·ªçng n√≥i', 'c√°ch c∆∞·ªùi', 'm√°i t√≥c', 'l√†n da', 'v√≤ng eo', 'c∆° th·ªÉ', 'v·∫ª ƒë·∫πp', 's·ª©c h√∫t'],
    situations: ['b·ªØa c∆°m gia ƒë√¨nh', 'khi v·ª£ ƒëi v·∫Øng', 'cu·ªëi tu·∫ßn', 'nh·ªØng bu·ªïi t·ªëi', 'l√∫c m·ªôt m√¨nh', 'khi kh√¥ng ai ch√∫ √Ω', 'trong ph√≤ng ng·ªß', 'nh√† t·∫Øm', 'ph√≤ng kh√°ch', 'b·∫øp', 'ban c√¥ng'],
    adultElements: ['ham mu·ªën', 'd·ª•c v·ªçng', 'kh√°t khao', 'b√≠ m·∫≠t c·∫•m k·ªã', 'ranh gi·ªõi m·ªù nh·∫°t', 'c√°m d·ªó', 's·ª± quy·∫øn r≈©', 'k√≠ch th√≠ch', 'kho√°i c·∫£m', 'th√¢n th·ªÉ', 'g·ª£i c·∫£m', 'm∆°n tr·ªõn'],
    psychologicalTerms: ['v√¥ th·ª©c', 'ti·ªÅm th·ª©c', 'b·∫£n nƒÉng', '·ª©c ch·∫ø', 'd·ªìn n√©n', 'ph√≤ng th·ªß', 'ph·ªß nh·∫≠n', 'm·∫∑c c·∫£m', '√°m ·∫£nh', 'd·ª•c v·ªçng', 'ƒëam m√™'],
    transitionWords: ['tuy nhi√™n', 'b√™n c·∫°nh ƒë√≥', 'ngo√†i ra', 'h∆°n n·ªØa', 'ƒë·∫∑c bi·ªát l√†', 'th√™m v√†o ƒë√≥', 'm·∫∑t kh√°c', 'm·ªôt ng√†y n·ªç', 'r·ªìi m·ªôt h√¥m', 'theo th·ªùi gian'],
    characterNames: ['Minh', 'H∆∞∆°ng', 'Lan', 'H·∫°nh', 'An', 'B√¨nh', 'D≈©ng', 'H·∫£i', 'Ph∆∞∆°ng', 'Th·∫£o', 'Nam', 'Linh', 'Ng·ªçc', 'My'],
    locations: ['ph√≤ng kh√°ch', 'nh√† b·∫øp', 'ph√≤ng ng·ªß', 'ph√≤ng t·∫Øm', 'ban c√¥ng', 's√¢n v∆∞·ªùn', 'c·∫ßu thang', 'ph√≤ng l√†m vi·ªác', 'ph√≤ng ƒÉn', 'nh√† kho', 'garage'],
    timeFrames: ['s√°ng s·ªõm', 'bu·ªïi tr∆∞a', 'chi·ªÅu t√†', 'ƒë√™m khuya', 'n·ª≠a ƒë√™m', 'r·∫°ng s√°ng', 'ho√†ng h√¥n', 'cu·ªëi tu·∫ßn', 'ng√†y l·ªÖ', 'k·ª≥ ngh·ªâ', 'd·ªãp T·∫øt']
};

// Danh s√°ch t·ª´ d·ª´ng (stop words)
const stopWords = new Set(['v√†', 'ho·∫∑c', 'l√†', 'th√¨', 'm√†', 'nh∆∞ng', 'ƒë·ªÉ', 'n√™n', 'v√¨', 'do', 'b·ªüi', 'c·ªßa', 'cho', 'v·ªõi', 't·ª´', 'v√†o', '·ªü', 't·∫°i', 'tr√™n', 'd∆∞·ªõi', 'trong', 'ngo√†i', 'tr∆∞·ªõc', 'sau', 'gi·ªØa', 'c√πng', 'c√°c', 'nh·ªØng', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n', 'm∆∞·ªùi']);

// H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng
function init() {
    // Thi·∫øt l·∫≠p c√°c event listener
    setupEventListeners();
    
    // Kh·ªüi t·∫°o Google API
    gapiLoaded();
    gisLoaded();
    
    // T·∫£i d·ªØ li·ªáu t·ª´ localStorage
    loadStoryHistory();
    loadAIKnowledge();
    loadAIGeneratedStories();
    loadReadingHistory();
}

// Kh·ªüi t·∫°o Google API Client
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        gapiInited = true;
        maybeEnableButtons();
    } catch (error) {
        console.error('L·ªói kh·ªüi t·∫°o Google API:', error);
        showStatus('L·ªói kh·ªüi t·∫°o Google API: ' + error.message, 'error');
    }
}

// Kh·ªüi t·∫°o Google Identity Services
function gisLoaded() {
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file',
            callback: '',
        });
        gisInited = true;
        maybeEnableButtons();
    } catch (error) {
        console.error('L·ªói kh·ªüi t·∫°o Google Identity Services:', error);
        showStatus('L·ªói kh·ªüi t·∫°o Google Identity Services: ' + error.message, 'error');
    }
}

// K√≠ch ho·∫°t n√∫t khi c·∫£ hai API ƒë√£ s·∫µn s√†ng
function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

// Thi·∫øt l·∫≠p c√°c event listener
function setupEventListeners() {
    // X√°c th·ª±c
    document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
    document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
    
    // Form truy·ªán
    document.getElementById('storyForm').addEventListener('submit', saveStory);
    document.getElementById('storyMode').addEventListener('change', toggleStoryMode);
    
    // Hu·∫•n luy·ªán AI
    document.getElementById('trainAiButton').addEventListener('click', trainAI);
    document.getElementById('resetAiButton').addEventListener('click', resetAI);
    
    // T·∫°o truy·ªán AI
    document.getElementById('generateStoryButton').addEventListener('click', generateAIStory);
    document.getElementById('viewAiStoriesButton').addEventListener('click', viewAIStories);
    
    // Navigation
    document.getElementById('menuTraining').addEventListener('click', () => showSection('trainingSection'));
    document.getElementById('menuGeneration').addEventListener('click', () => showSection('generationSection'));
    document.getElementById('menuManagement').addEventListener('click', () => showSection('managementSection'));
    document.getElementById('menuHistory').addEventListener('click', () => showSection('historySection'));
    
    // Modal
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.closest('.modal').id;
            closeModal(modalId);
        });
    });
    
    // Reader
    document.getElementById('closeReaderBtn').addEventListener('click', closeReader);
    document.getElementById('prevChapterBtn').addEventListener('click', () => navigateChapter(-1));
    document.getElementById('nextChapterBtn').addEventListener('click', () => navigateChapter(1));
    
    // ƒê√°nh gi√° ch∆∞∆°ng
    document.getElementById('rateChapterGood').addEventListener('click', () => rateChapter(true));
    document.getElementById('rateChapterBad').addEventListener('click', () => rateChapter(false));
    
    // Chapter actions
    document.getElementById('editChapterBtn').addEventListener('click', editChapter);
    document.getElementById('deleteChapterBtn').addEventListener('click', deleteChapter);
    document.getElementById('saveChapterBtn').addEventListener('click', saveChapterChanges);
    document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
    
    // ƒê√≥ng modal khi click b√™n ngo√†i
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    });
}

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
function handleAuthClick() {
    showLoading(true);
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            showStatus('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + resp.error, 'error');
            showLoading(false);
            return;
        }
        
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        // T·∫£i ho·∫∑c t·∫°o th∆∞ m·ª•c ch√≠nh
        await loadOrCreateMainFolder();
        
        // T·∫£i l·ªãch s·ª≠ v√† d·ªØ li·ªáu
        loadStoryHistory();
        loadFolderContents();
        loadExistingStories();
        
        showStatus('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        showLoading(false);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

// X·ª≠ l√Ω ƒëƒÉng xu·∫•t
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showStatus('ƒê√£ ƒëƒÉng xu·∫•t', 'success');
    }
}

// T·∫£i ho·∫∑c t·∫°o th∆∞ m·ª•c ch√≠nh
async function loadOrCreateMainFolder() {
    showLoading(true);
    try {
        // T√¨m th∆∞ m·ª•c ch√≠nh QuanLyTruyen
        const response = await gapi.client.drive.files.list({
            q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        if (folders.length > 0) {
            mainFolderId = folders[0].id;
            showStatus('ƒê√£ t√¨m th·∫•y th∆∞ m·ª•c QuanLyTruyen', 'success');
        } else {
            // T·∫°o th∆∞ m·ª•c m·ªõi n·∫øu kh√¥ng t√¨m th·∫•y
            const fileMetadata = {
                name: 'QuanLyTruyen',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            const createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            mainFolderId = createResponse.result.id;
            showStatus('ƒê√£ t·∫°o th∆∞ m·ª•c QuanLyTruyen m·ªõi', 'success');
        }
    } catch (error) {
        console.error('L·ªói khi t·∫°o/t√¨m th∆∞ m·ª•c:', error);
        showStatus('L·ªói khi t·∫°o/t√¨m th∆∞ m·ª•c: ' + error.message, 'error');
    }
    showLoading(false);
}

// Hu·∫•n luy·ªán AI - ƒê√É S·ª¨A L·ªñI
async function trainAI() {
    showLoading(true);
    
    try {
        if (!mainFolderId) {
            showStatus('Ch∆∞a c√≥ th∆∞ m·ª•c ch√≠nh', 'error');
            showLoading(false);
            return;
        }
        
        // L·∫•y danh s√°ch t·∫•t c·∫£ c√°c file vƒÉn b·∫£n trong th∆∞ m·ª•c ch√≠nh v√† c√°c th∆∞ m·ª•c con
        const response = await gapi.client.drive.files.list({
            q: `('${mainFolderId}' in parents or parents in '${mainFolderId}') and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, parents)',
            pageSize: 1000
        });
        
        const textFiles = response.result.files;
        let processedCount = 0;
        let skippedCount = 0;
        
        document.getElementById('progressFill').style.width = '0%';
        
        // X·ª≠ l√Ω t·ª´ng file
        for (const file of textFiles) {
            // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
            if (aiKnowledge.processedFiles.has(file.id)) {
                skippedCount++;
                continue;
            }
            
            try {
                // ƒê·ªçc n·ªôi dung file
                const contentResponse = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });
                
                const content = contentResponse.body;
                
                // C·∫≠p nh·∫≠t ki·∫øn th·ª©c AI t·ª´ n·ªôi dung
                updateAIKnowledge(content, file.id);
                processedCount++;
                
                // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
                const progress = Math.floor((processedCount / textFiles.length) * 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω file:', file.name, error);
            }
        }
        
        showStatus(`ƒê√£ hu·∫•n luy·ªán AI v·ªõi ${processedCount} file m·ªõi (${skippedCount} file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω tr∆∞·ªõc ƒë√≥)`, 'success');
        
    } catch (error) {
        console.error('L·ªói khi hu·∫•n luy·ªán AI:', error);
        showStatus('L·ªói khi hu·∫•n luy·ªán AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

// C·∫≠p nh·∫≠t ki·∫øn th·ª©c AI t·ª´ n·ªôi dung
function updateAIKnowledge(content, fileId) {
    // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
    if (fileId && aiKnowledge.processedFiles.has(fileId)) {
        return;
    }
    
    // ƒê√°nh d·∫•u file ƒë√£ x·ª≠ l√Ω
    if (fileId) {
        aiKnowledge.processedFiles.add(fileId);
    }
    
    // Ph√¢n t√≠ch n·ªôi dung ƒë·ªÉ c·∫≠p nh·∫≠t ki·∫øn th·ª©c cho AI
    const words = content.split(/\s+/);
    words.forEach(word => {
        if (word.length > 3) {
            aiKnowledge.vocabulary.add(word.toLowerCase());
        }
    });
    
    // Ph√¢n t√≠ch c√¢u
    const sentences = content.split(/[.!?]+/);
    aiKnowledge.trainedFiles += sentences.length;
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Ph√¢n t√≠ch t·ª´ kh√≥a c·∫£m x√∫c
            specializedVocabulary.emotions.forEach(emotion => {
                if (sentence.toLowerCase().includes(emotion)) {
                    aiKnowledge.emotionalPatterns.add(emotion);
                }
            });
            
            // Ph√¢n t√≠ch quan h·ªá b·ªë ch·ªìng - con d√¢u
            if (sentence.toLowerCase().includes('b·ªë ch·ªìng') || sentence.toLowerCase().includes('con d√¢u')) {
                aiKnowledge.fatherInLawRelations.add(sentence.trim());
            }
            
            // Ph√¢n t√≠ch t√¨nh hu·ªëng c·∫•m k·ªµ
            specializedVocabulary.adultElements.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.forbiddenSituations.add(sentence.trim());
                }
            });
            
            // Ph√¢n t√≠ch m√¢u thu·∫´n gia ƒë√¨nh
            if (sentence.toLowerCase().includes('gia ƒë√¨nh') || sentence.toLowerCase().includes('m√¢u thu·∫´n') || 
                sentence.toLowerCase().includes('xung ƒë·ªôt')) {
                aiKnowledge.familyConflicts.add(sentence.trim());
            }
            
            // Ph√¢n t√≠ch t√¢m l√Ω nh√¢n v·∫≠t
            specializedVocabulary.psychologicalTerms.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.psychologicalStates.add(sentence.trim());
                }
            });
        }
    });
    
    // L∆∞u ki·∫øn th·ª©c AI
    saveAIKnowledge();
    updateAIStats();
}

// C√°c h√†m kh√°c gi·ªØ nguy√™n t·ª´ code tr∆∞·ªõc ƒë√≥ (hi·ªÉn th·ªã l·ªãch s·ª≠, qu·∫£n l√Ω truy·ªán, v.v.)
// ... (gi·ªØ nguy√™n c√°c h√†m kh√°c)

// Hi·ªÉn th·ªã section
function showSection(sectionId) {
    // ·∫®n t·∫•t c·∫£ sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Hi·ªÉn th·ªã section ƒë∆∞·ª£c ch·ªçn
    document.getElementById(sectionId).classList.add('active');
    
    // C·∫≠p nh·∫≠t n√∫t menu active
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

// Hi·ªÉn th·ªã tr·∫°ng th√°i
function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Hi·ªÉn th·ªã/·∫©n loading
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// M·ªü modal
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

// ƒê√≥ng modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi trang t·∫£i xong
window.addEventListener('load', init);
</script>
</body>
</html>
