<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        /* Gi·ªØ nguy√™n c√°c style hi·ªán c√≥, ch·ªâ thay ƒë·ªïi m√†u s·∫Øc ch·ªß ƒë·ªÅ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c1a1a 0%, #3e1621 50%, #600f2a 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #ea6666, #a27676); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        /* Gi·ªØ nguy√™n c√°c style kh√°c... */
        
        /* Th√™m style m·ªõi cho ch·ªß ƒë·ªÅ */
        .theme-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .theme-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .theme-btn.active {
            background: linear-gradient(45deg, #ea6666, #a27676);
            border-color: rgba(234, 102, 102, 0.5);
        }
        
        /* C√°c style kh√°c gi·ªØ nguy√™n... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager - B·ªë Ch·ªìng Con D√¢u</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úçÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI - Ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>N·ªôi dung 18+:</span>
                                <span id="adultContentCount">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông - B·ªë Ch·ªìng Con D√¢u</h2>
                        
                        <div class="theme-selector">
                            <label>Ch·ªçn g√≥c k·ªÉ chuy·ªán:</label>
                            <div class="theme-buttons">
                                <button class="theme-btn active" data-theme="son-perspective">üë¶ G√≥c nh√¨n ng∆∞·ªùi con trai</button>
                                <button class="theme-btn" data-theme="father-perspective">üë¥ G√≥c nh√¨n b·ªë ch·ªìng</button>
                                <button class="theme-btn" data-theme="daughter-perspective">üë© G√≥c nh√¨n con d√¢u</button>
                            </div>
                        </div>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫£nh b√°o: Ch·∫ø ƒë·ªô n√†y t·∫°o n·ªôi dung d√†nh cho ng∆∞·ªùi l·ªõn. B·∫°n ph·∫£i t·ª´ 18 tu·ªïi tr·ªü l√™n ƒë·ªÉ s·ª≠ d·ª•ng.
                        </div>
                        
                        <div class="adult-toggle">
                            <input type="checkbox" id="adultConsent" checked>
                            <label for="adultConsent">T√¥i x√°c nh·∫≠n ƒë√£ ƒë·ªß 18 tu·ªïi v√† ƒë·ªìng √Ω xem n·ªôi dung ng∆∞·ªùi l·ªõn</label>
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (5-20)" min="5" max="20" value="10">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- C√°c ph·∫ßn kh√°c gi·ªØ nguy√™n... -->
            </div>
        </div>
    </div>

    <!-- C√°c modal gi·ªØ nguy√™n... -->

<script>
// ... (Ph·∫ßn kh·ªüi t·∫°o Google API gi·ªØ nguy√™n)

// T·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
const fatherDaughterInLawVocabulary = {
    relationships: ['b·ªë ch·ªìng', 'con d√¢u', 'ng∆∞·ªùi cha', 'con trai', 'gia ƒë√¨nh', 'm·ªëi quan h·ªá', 
                   'h√¥n nh√¢n', 'r√†o c·∫£n', 'b√≠ m·∫≠t', 'd·ª•c v·ªçng', 'c√°m d·ªó', 't·ªôi l·ªói', 'ƒëam m√™',
                   'ghen tu√¥ng', 'xung ƒë·ªôt', 'l√©n l√∫t', 'ƒÉn nƒÉn', 'kh√°t khao', '·ª©c ch·∫ø', 'th√®m mu·ªën'],
    emotions: ['day d·ª©t', 'gi·∫±ng x√©', 'ƒëau kh·ªï', 'sung s∆∞·ªõng', 'h·ªëi h·∫≠n', 'th·ªèa m√£n', 'khao kh√°t',
              'c√¥ ƒë∆°n', 'tr·ªëng v·∫Øng', '·∫•m √°p', 'nguy hi·ªÉm', 't√≤ m√≤', 's·ª£ h√£i', 'ph·∫•n kh√≠ch', 'lo l·∫Øng'],
    settings: ['ph√≤ng ng·ªß', 'nh√† t·∫Øm', 'b·∫øp', 'ph√≤ng kh√°ch', 'nh√† kho', 'v∆∞·ªùn sau', 'ban ƒë√™m',
              'khi v·∫Øng nh√†', 'ng√†y m∆∞a', 'bu·ªïi tr∆∞a', 'l√∫c m·ªçi ng∆∞·ªùi ng·ªß', 'g√°c m√°i', 't·∫ßng h·∫ßm'],
    actions: ['nh√¨n tr·ªôm', 'ch·∫°m nh·∫π', '√¥m ·∫•p', 'h√¥n', 'vu·ªët ve', 'th√¨ th·∫ßm', 'l√©n l√∫t', 'g·∫∑p g·ª°',
             'gi·∫•u gi·∫øm', 'th·ªï l·ªô', 'th√∫ nh·∫≠n', 'ph√°t hi·ªán', 'ƒë·ªëi m·∫∑t', 'tr·ªën tr√°nh', 'ti·∫øp t·ª•c'],
    bodyParts: ['v√≤ng eo', 'm√°i t√≥c', 'b·ªù m√¥i', 'v√≤ng m·ªôt', 'b√†n tay', 'ƒë√¥i m·∫Øt', 'l∆∞ng tr·∫ßn',
               'v√πng k√≠n', 'c·∫∑p ƒë√πi', 'b·ªù vai', 'c·ªï √°o', 'l√†n da', 'eo l∆∞ng', 'b·ª•ng d∆∞·ªõi']
};

// C·∫•u tr√∫c c√¢u cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
const fatherDaughterInLawPatterns = {
    sonPerspective: [
        "T√¥i kh√¥ng ng·ªù {relationship} c·ªßa b·ªë v√† v·ª£ t√¥i l·∫°i {emotion} ƒë·∫øn v·∫≠y.",
        "M·ªói l·∫ßn th·∫•y b·ªë {action} v·ªõi v·ª£ t√¥i, l√≤ng t√¥i {emotion} v√¥ c√πng.",
        "T√¥i ph√°t hi·ªán ra b√≠ m·∫≠t gi·ªØa b·ªë v√† v·ª£ t·∫°i {setting} khi h·ªç {action}.",
        "V·ª£ t√¥i ng√†y c√†ng {emotion} m·ªói khi b·ªë t√¥i {action} c√¥ ·∫•y.",
        "T√¥i c·∫£m th·∫•y {emotion} khi ch·ª©ng ki·∫øn {relationship} c·ªßa h·ªç ng√†y c√†ng {emotion}.",
        "Kh√¥ng hi·ªÉu sao v·ª£ t√¥i l·∫°i {action} v·ªõi b·ªë t√¥i t·∫°i {setting}.",
        "T√¥i th·∫•y {bodyPart} c·ªßa v·ª£ t√¥i ƒë·ªè ·ª≠ng sau khi b·ªë t√¥i {action}.",
        "B·ªë t√¥i nh√¨n v·ª£ t√¥i b·∫±ng √°nh m·∫Øt {emotion} ƒë·∫ßy {emotion}.",
        "T√¥i nghe th·∫•y ti·∫øng {action} t·ª´ {setting} v√† nh·∫≠n ra ƒë√≥ l√† b·ªë v√† v·ª£ m√¨nh.",
        "M·ªëi {relationship} n√†y khi·∫øn t√¥i {emotion} nh∆∞ng c≈©ng {emotion}."
    ],
    fatherPerspective: [
        "T√¥i bi·∫øt m√¨nh kh√¥ng n√™n {action} v·ªõi con d√¢u nh∆∞ng {emotion} kh√¥ng ki·ªÅm ch·∫ø ƒë∆∞·ª£c.",
        "M·ªói l·∫ßn th·∫•y {bodyPart} c·ªßa con d√¢u, t√¥i c·∫£m th·∫•y {emotion} v√¥ c√πng.",
        "T·∫°i {setting}, ch√∫ng t√¥i {action} m√† kh√¥ng s·ª£ ai ph√°t hi·ªán.",
        "Con d√¢u t√¥i {action} v·ªõi t√¥i b·∫±ng s·ª± {emotion} ƒë·∫ßy {emotion}.",
        "T√¥i {emotion} khi nghƒ© v·ªÅ {relationship} t·ªôi l·ªói n√†y nh∆∞ng v·∫´n {action}.",
        "C√¥ ·∫•y khi·∫øn t√¥i {emotion} nh∆∞ th·ªùi trai tr·∫ª v·ªõi {bodyPart} g·ª£i c·∫£m.",
        "Ch√∫ng t√¥i {action} t·∫°i {setting} trong khi con trai t√¥i {action}.",
        "T√¥i kh√¥ng th·ªÉ ng·ª´ng {action} v·ªõi con d√¢u d√π bi·∫øt l√† {emotion}.",
        "M·ªói l·∫ßn {action}, t√¥i c·∫£m th·∫•y {emotion} v√† {emotion}.",
        "Con d√¢u t√¥i {action} khi·∫øn t√¥i {emotion} kh√¥ng th·ªÉ ki·ªÅm ch·∫ø."
    ],
    daughterPerspective: [
        "T√¥i {emotion} khi b·ªë ch·ªìng {action} v·ªõi t√¥i t·∫°i {setting}.",
        "M·ªói l·∫ßn ch·ªìng ƒëi v·∫Øng, b·ªë ch·ªìng l·∫°i {action} v·ªõi t√¥i khi·∫øn t√¥i {emotion}.",
        "T√¥i bi·∫øt m√¨nh kh√¥ng n√™n {action} v·ªõi b·ªë ch·ªìng nh∆∞ng {emotion} qu√° m·∫°nh.",
        "B·ªë ch·ªìng {action} {bodyPart} c·ªßa t√¥i khi·∫øn t√¥i {emotion}.",
        "T√¥i {emotion} v·ªÅ {relationship} n√†y nh∆∞ng v·∫´n ti·∫øp t·ª•c {action}.",
        "T·∫°i {setting}, ch√∫ng t√¥i {action} m√† kh√¥ng s·ª£ b·ªã ph√°t hi·ªán.",
        "B·ªë ch·ªìng nh√¨n t√¥i b·∫±ng √°nh m·∫Øt {emotion} khi·∫øn t√¥i {emotion}.",
        "T√¥i {action} v·ªõi b·ªë ch·ªìng trong khi nghƒ© v·ªÅ ch·ªìng m√¨nh.",
        "M·ªói l·∫ßn {action}, t√¥i c·∫£m th·∫•y {emotion} v√† {emotion}.",
        "B·ªë ch·ªìng {action} khi·∫øn t√¥i {emotion} kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i."
    ]
};

// S·ª± ki·ªán v√† k√Ω ·ª©c cho c·ªët truy·ªán B·ªë Ch·ªìng Con D√¢u
const fatherDaughterInLawElements = {
    events: ["ƒë√°m c∆∞·ªõi", "ng√†y gi·ªó", "l·ªÖ t·∫øt", "sinh nh·∫≠t", "k·ª∑ ni·ªám", "c√£i v√£", "h√≤a gi·∫£i", 
            "ph√°t hi·ªán", "ƒë·ªëi ch·∫•t", "gi·∫•u gi·∫øm", "th√∫ nh·∫≠n", "b·ªè ƒëi", "tr·ªü v·ªÅ", "tha th·ª©"],
    conflicts: ["ghen tu√¥ng", "hi·ªÉu l·∫ßm", "tranh c√£i", "c∆∞·ª°ng √©p", "t·ª± nguy·ªán", "d·ªëi tr√°", 
               "trung th·ª±c", "ph·∫£n b·ªôi", "trung th√†nh", "chia r·∫Ω", "ƒëo√†n t·ª•", "ly h√¥n"],
    resolutions: ["tha th·ª©", "tr·ª´ng ph·∫°t", "ch·∫•p nh·∫≠n", "t·ª´ b·ªè", "ti·∫øp t·ª•c", "gi·ªØ b√≠ m·∫≠t", 
                 "c√¥ng khai", "d·ªçn ƒëi", "·ªü l·∫°i", "ƒë·ªëi m·∫∑t", "tr·ªën ch·∫°y"]
};

// H√†m x·ª≠ l√Ω n·ªôi dung cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function processFatherDaughterInLawContent(content, storyTitle, fileName) {
    const sentences = content.split(/[.!?]+/).filter(s => s.length > 5);
    
    sentences.forEach(sentence => {
        // Th√™m t·ª´ v√†o t·ª´ ƒëi·ªÉn
        const words = sentence.toLowerCase()
            .replace(/[^\w\s√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/g, '')
            .split(/\s+/);
        
        words.forEach(word => {
            if (word.length > 2) {
                aiKnowledge.vocabulary.add(word);
            }
        });
        
        // Ph√°t hi·ªán v√† ph√¢n lo·∫°i c√¢u theo ch·ªß ƒë·ªÅ
        const lowerSentence = sentence.toLowerCase();
        
        // Ph√°t hi·ªán c√¢u v·ªÅ m·ªëi quan h·ªá
        if (lowerSentence.match(/b·ªë ch·ªìng|con d√¢u|cha ch·ªìng|b·ªë v·ª£|con r·ªÉ|gia ƒë√¨nh|m·ªëi quan h·ªá|h√¥n nh√¢n/)) {
            if (!aiKnowledge.relationshipSentences) aiKnowledge.relationshipSentences = [];
            aiKnowledge.relationshipSentences.push(sentence);
        }
        
        // Ph√°t hi·ªán c√¢u v·ªÅ xung ƒë·ªôt
        if (lowerSentence.match(/ghen tu√¥ng|hi·ªÉu l·∫ßm|tranh c√£i|c∆∞·ª°ng √©p|d·ªëi tr√°|ph·∫£n b·ªôi|t·ªôi l·ªói/)) {
            if (!aiKnowledge.conflictSentences) aiKnowledge.conflictSentences = [];
            aiKnowledge.conflictSentences.push(sentence);
        }
        
        // Ph√°t hi·ªán c√¢u v·ªÅ c·∫£m x√∫c
        if (lowerSentence.match(/day d·ª©t|gi·∫±ng x√©|ƒëau kh·ªï|sung s∆∞·ªõng|h·ªëi h·∫≠n|th·ªèa m√£n|khao kh√°t|c√¥ ƒë∆°n/)) {
            if (!aiKnowledge.emotionSentences) aiKnowledge.emotionSentences = [];
            aiKnowledge.emotionSentences.push(sentence);
        }
        
        // Ph√°t hi·ªán c√¢u 18+
        const adultKeywords = [
            'd·ª•c', 'khao kh√°t', 'ham mu·ªën', 'th√¢n m·∫≠t', 'g·ªëi chƒÉn', '√¢n √°i', 'k√≠ch d·ª•c', 
            'kho√°i c·∫£m', 'd√¢m', 'luy·∫øn', 'c∆° th·ªÉ', 'ch·∫°m', 'vu·ªët ve', 'h√¥n', 'c·∫Øn', '√¥m', 
            'si·∫øt ch·∫∑t', 'l·ªìn', 'c·∫∑c', 'ƒë·ªãt', 'ch·ªãch', 'phang', 'ƒë·ª•', 'd∆∞∆°ng v·∫≠t', '√¢m ƒë·∫°o',
            '√¢m h·ªô', 'h·∫≠u m√¥n', 'v√∫', 'ƒë·∫ßu v√∫', 'm√¥ng', 'h√°ng', 'b∆∞·ªõm', 'c·∫≠u nh·ªè', 'c·ª≠a m√¨nh'
        ];
        
        if (adultKeywords.some(keyword => lowerSentence.includes(keyword))) {
            if (!aiKnowledge.adultSentences) aiKnowledge.adultSentences = [];
            aiKnowledge.adultSentences.push(sentence);
            aiKnowledge.adultContent = (aiKnowledge.adultContent || 0) + 1;
            
            // ƒê√°nh d·∫•u truy·ªán c√≥ n·ªôi dung nh·∫°y c·∫£m
            if (!aiKnowledge.adultStories) aiKnowledge.adultStories = new Set();
            aiKnowledge.adultStories.add(storyTitle);
        }
    });
    
    // L∆∞u th√¥ng tin truy·ªán
    if (!aiKnowledge.stories.includes(storyTitle)) {
        aiKnowledge.stories.push(storyTitle);
    }
}

// H√†m t·∫°o n·ªôi dung ch∆∞∆°ng cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function generateFatherDaughterInLawChapter(perspective = "son-perspective") {
    const minWords = 800;
    const maxWords = 1200;
    const targetWords = minWords + Math.floor(Math.random() * (maxWords - minWords + 1));
    
    let content = "";
    let wordCount = 0;
    
    // T·∫°o ti√™u ƒë·ªÅ ch∆∞∆°ng
    const chapterTitle = generateFatherDaughterInLawTitle(perspective);
    content += chapterTitle + "\n\n";
    wordCount += chapterTitle.split(/\s+/).length;
    
    // T·∫°o n·ªôi dung ch√≠nh
    while (wordCount < targetWords) {
        const paragraph = generateFatherDaughterInLawParagraph(perspective);
        content += paragraph + "\n\n";
        wordCount += paragraph.split(/\s+/).length;
    }
    
    return content;
}

// H√†m t·∫°o ƒëo·∫°n vƒÉn cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function generateFatherDaughterInLawParagraph(perspective) {
    const sentences = [];
    const sentenceCount = 3 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < sentenceCount; i++) {
        sentences.push(generateFatherDaughterInLawSentence(perspective));
    }
    
    return sentences.join(" ");
}

// H√†m t·∫°o c√¢u cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function generateFatherDaughterInLawSentence(perspective) {
    let pattern, sentence;
    let patterns = fatherDaughterInLawPatterns.sonPerspective;
    
    if (perspective === "father-perspective") {
        patterns = fatherDaughterInLawPatterns.fatherPerspective;
    } else if (perspective === "daughter-perspective") {
        patterns = fatherDaughterInLawPatterns.daughterPerspective;
    }
    
    pattern = getRandomElement(patterns);
    sentence = pattern;
    
    // Thay th·∫ø c√°c placeholder
    sentence = sentence.replace(/{relationship}/gi, getRandomElement(fatherDaughterInLawVocabulary.relationships));
    sentence = sentence.replace(/{emotion}/gi, getRandomElement(fatherDaughterInLawVocabulary.emotions));
    sentence = sentence.replace(/{setting}/gi, getRandomElement(fatherDaughterInLawVocabulary.settings));
    sentence = sentence.replace(/{action}/gi, getRandomElement(fatherDaughterInLawVocabulary.actions));
    sentence = sentence.replace(/{bodyPart}/gi, getRandomElement(fatherDaughterInLawVocabulary.bodyParts));
    
    // ƒê·∫£m b·∫£o c√¢u b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ hoa v√† k·∫øt th√∫c b·∫±ng d·∫•u c√¢u
    if (!/[.!?]$/.test(sentence)) {
        sentence += ".";
    }
    
    return sentence.charAt(0).toUpperCase() + sentence.slice(1);
}

// H√†m t·∫°o ti√™u ƒë·ªÅ cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function generateFatherDaughterInLawTitle(perspective) {
    const prefixes = {
        "son-perspective": ["B√≠ m·∫≠t gia ƒë√¨nh", "S·ª± th·∫≠t ƒëau l√≤ng", "Ghen tu√¥ng", "Ph√°t hi·ªán", "L·ªùi th√∫ nh·∫≠n"],
        "father-perspective": ["D·ª•c v·ªçng", "C√°m d·ªó", "T·ªôi l·ªói", "ƒêam m√™", "Kh√°t khao"],
        "daughter-perspective": ["Day d·ª©t", "Gi·∫±ng x√©", "L·ª±a ch·ªçn", "Nguy hi·ªÉm", "·∫®n ·ª©c"]
    };
    
    const suffixes = {
        "son-perspective": ["c·ªßa b·ªë v√† v·ª£ t√¥i", "kh√¥ng ng·ªù t·ªõi", "trong gia ƒë√¨nh", "ƒë·∫ßy ƒëau kh·ªï", "v·ª° l·∫Ω"],
        "father-perspective": ["v·ª•ng tr·ªôm", "t·ªôi l·ªói", "kh√≥ c∆∞·ª°ng", "c·∫•m ƒëo√°n", "nguy hi·ªÉm"],
        "daughter-perspective": ["v·ªõi b·ªë ch·ªìng", "ƒë·∫ßy m√¢u thu·∫´n", "kh√≥ n√≥i", "b√≠ m·∫≠t", "ƒë·∫ßy r·ªßi ro"]
    };
    
    const prefix = getRandomElement(prefixes[perspective]);
    const suffix = getRandomElement(suffixes[perspective]);
    
    return `${prefix} ${suffix}`;
}

// H√†m hu·∫•n luy·ªán AI - t·∫≠p trung v√†o ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
async function trainAI() {
    showLoading(true);
    showStatus('ƒêang b·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI v·ªÅ ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            processFatherDaughterInLawContent(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    saveAiKnowledge();
    showLoading(false);
    showStatus(`Hu·∫•n luy·ªán ho√†n th√†nh! ƒê√£ x·ª≠ l√Ω ${processedFiles} file.`, 'success');
}

// H√†m t·∫°o truy·ªán cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
async function generateStory() {
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 10;
    if (chapterCount < 5 || chapterCount > 20) {
        showStatus('S·ªë ch∆∞∆°ng ph·∫£i t·ª´ 5 ƒë·∫øn 20!', 'error');
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 50) {
        showStatus('AI ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán ƒë·ªß! H√£y hu·∫•n luy·ªán AI v·ªõi √≠t nh·∫•t 50 t·ª´ v·ª±ng.', 'error');
        return;
    }
    
    showLoading(true);
    showStatus('AI ƒëang t·∫°o truy·ªán m·ªõi v·ªÅ ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u...', 'success');
    
    // X√°c ƒë·ªãnh g√≥c nh√¨n
    const activeThemeBtn = document.querySelector('.theme-btn.active');
    const perspective = activeThemeBtn ? activeThemeBtn.dataset.theme : 'son-perspective';
    
    // Generate a story title based on perspective
    const title = generateFatherDaughterInLawStoryTitle(perspective);
    
    // Create folder for the new story
    const storyFolderId = await createStoryFolder(title, true);
    
    // Generate chapters
    let generatedChapters = 0;
    const totalChapters = chapterCount;
    
    for (let i = 1; i <= totalChapters; i++) {
        const chapterTitle = `Ch∆∞∆°ng ${i}: ${generateFatherDaughterInLawTitle(perspective)}`;
        const chapterContent = generateFatherDaughterInLawChapter(perspective);
        
        // Save chapter to Google Drive
        await saveStoryContent(title, chapterTitle, chapterContent, storyFolderId, true);
        
        generatedChapters++;
        
        // Update progress
        const progress = (generatedChapters / totalChapters) * 100;
        document.getElementById('generationProgressFill').style.width = progress + '%';
        document.getElementById('generationStatus').innerHTML = 
            `<div class="status success">ƒêang t·∫°o ch∆∞∆°ng ${generatedChapters}/${totalChapters}: ${chapterTitle}</div>`;
        
        // Small delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // Reload AI generated stories
    await loadAiGeneratedStories();
    await loadStoryHistory();
    showLoading(false);
    showStatus(`ƒê√£ t·∫°o th√†nh c√¥ng truy·ªán "${title}" v·ªõi ${totalChapters} ch∆∞∆°ng!`, 'success');
    document.getElementById('generationStatus').innerHTML = '';
}

// H√†m t·∫°o ti√™u ƒë·ªÅ truy·ªán cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
function generateFatherDaughterInLawStoryTitle(perspective) {
    const titles = {
        "son-perspective": [
            "B√≠ M·∫≠t Gia ƒê√¨nh T√¥i",
            "Ng∆∞·ªùi Cha V√† V·ª£ T√¥i",
            "Ghen Tu√¥ng V√† ƒêau Kh·ªï",
            "S·ª± Th·∫≠t ƒê·∫±ng Sau C√°nh C·ª≠a",
            "M·ªëi T√¨nh T·ªôi L·ªói C·ªßa B·ªë"
        ],
        "father-perspective": [
            "D·ª•c V·ªçng Ng∆∞·ªùi Cha",
            "T√¨nh Y√™u C·∫•m ƒêo√°n",
            "Kh√°t Khao Con D√¢u",
            "T·ªôi L·ªói V√† ƒêam M√™",
            "Ng∆∞·ªùi ƒê√†n √îng C√¥ ƒê∆°n"
        ],
        "daughter-perspective": [
            "Gi·∫±ng X√© Con D√¢u",
            "T√¨nh Y√™u Nguy Hi·ªÉm",
            "B√≠ M·∫≠t C·ªßa T√¥i",
            "Gi·ªØa B·ªë Ch·ªìng V√† Ch·ªìng",
            "Ng∆∞·ªùi Ph·ª• N·ªØ Hai M·∫∑t"
        ]
    };
    
    return getRandomElement(titles[perspective]);
}

// H√†m x·ª≠ l√Ω khi ch·ªçn g√≥c nh√¨n
function handlePerspectiveSelection(perspective) {
    currentTheme = perspective;
}

// C·∫≠p nh·∫≠t s·ª± ki·ªán ch·ªçn g√≥c nh√¨n
document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        handlePerspectiveSelection(this.dataset.theme);
    });
});

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
window.onload = () => {
    initializeGapi();
    initializeGis();
};
</script>
</body>
</html>
