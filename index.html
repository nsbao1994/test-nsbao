<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Trình Phân Tích & Tạo Truyện Nâng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
           --primary-color: #9b59b6;
           --secondary-color: #2980b9;
           --dark-color: #1e1e1e;
           --light-color: #bdc3c7;
           --accent-color: #e74c3c;
           --success-color: #2ecc71;
           --warning-color: #f39c12;
           --text-color: #ecf0f1;
           --card-bg: rgba(30, 30, 30, 0.95);
           --border-radius: 16px;
           --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
           --safe-area-inset-top: env(safe-area-inset-top);
           --safe-area-inset-bottom: env(safe-area-inset-bottom);
           --safe-area-inset-left: env(safe-area-inset-left);
           --safe-area-inset-right: env(safe-area-inset-right);
        }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {background:#121212;color:var(--text-color);font-family:sans-serif;min-height:100vh;}
        .container {padding:16px;padding-bottom:80px;}
        .header {text-align:center;color:#fff;margin-bottom:20px;}
        .card {background:var(--card-bg);border-radius:var(--border-radius);padding:20px;margin-bottom:20px;}
        .bottom-menu {position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;padding:12px;background:#2c3e50;}
        .menu-item {color:var(--light-color);text-decoration:none;font-size:0.8rem;opacity:0.7;}
        .menu-item.active {opacity:1;}
        .tab-content{display:none;}
        .tab-content.active{display:block;}
        .btn{background:var(--primary-color);color:#fff;border:none;padding:10px 16px;border-radius:8px;margin:4px;cursor:pointer;}
        .btn:disabled{background:#777;cursor:not-allowed;}
        .story-content{background:#1e1e1e;padding:12px;border-radius:8px;margin:8px 0;max-height:50vh;overflow-y:auto;}
    </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
    <p>Phân tích nâng cao và tạo truyện tự động</p>
  </div>
  <div id="tab-analysis" class="tab-content active">
    <div class="card">
      <h3>🔍 Phân tích nguồn truyện</h3>
      <div class="status-info" id="statusInfo">🔴 Chưa kết nối Google Drive</div>
      <div class="detailed-status" id="detailedStatus"></div>
      <div class="progress-bar"><div class="progress-fill" id="progressBar" style="height:10px;background:#9b59b6;width:0%"></div></div>
      <button class="btn" onclick="handleAuthClick()">📁 Kết nối Google Drive</button>
      <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>🔍 Quét thư mục</button>
      <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>🧠 Phân tích nâng cao</button>
      <button class="btn" id="downloadAnalysisBtn" onclick="downloadAnalysisFromDrive()" disabled>📥 Tải phân tích</button>
      <button class="btn" onclick="loadAnalysisLocal()">🔄 Tải cache local</button>
      <button class="btn" onclick="uploadAnalysisToDrive()">☁️ Upload phân tích</button>
    </div>
    <div class="card">
      <h3>📊 Kết quả phân tích</h3>
      <div id="analysisResults"><p>Chưa có dữ liệu phân tích.</p></div>
    </div>
  </div>
</div>
<div class="bottom-menu">
  <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">🔍 Phân tích</a>
</div>
<script>
    const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive';
let tokenClient, gapi_inited=false, gsi_inited=false;
let analysisData = [];
const ANALYSIS_CACHE_NAME = 'AnalysisResults_QuanLyTruyen.json';

function gapiLoaded(){gapi.load('client',initializeGapiClient);}
async function initializeGapiClient(){await gapi.client.init({discoveryDocs:[DISCOVERY_DOC]});gapi_inited=true;maybeEnableButtons();}
function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:''});gsi_inited=true;maybeEnableButtons();}
function maybeEnableButtons(){if(gapi_inited&&gsi_inited){document.getElementById('scanBtn').disabled=false;}}

function handleAuthClick(){tokenClient.callback=async(resp)=>{if(resp.error)throw(resp);gapi.client.setToken({access_token:resp.access_token});updateStatus('🟢 Đã kết nối Google Drive');document.getElementById('scanBtn').disabled=false;};
 if(gapi.client.getToken()===null){tokenClient.requestAccessToken({prompt:'consent'});} else{tokenClient.requestAccessToken({prompt:''});}}

function updateStatus(msg){document.getElementById('statusInfo').innerText=msg;}
function updateProgress(p){document.getElementById('progressBar').style.width=p+'%';}
function updateDetailedStatus(msg){document.getElementById('detailedStatus').innerText=msg;}

// ====== Save/Load Local ======
function saveAnalysisLocal(){const analysisContent={analysisData:analysisData,timestamp:new Date().toISOString()};localStorage.setItem('analysisResults',JSON.stringify(analysisContent));}
function loadAnalysisLocal(){const data=localStorage.getItem('analysisResults');if(data){analysisData=JSON.parse(data).analysisData;displayAdvancedAnalysisResults();updateStatus('✅ Đã tải cache local');return true;}return false;}

// ====== Upload/Download Google Drive ======
async function uploadAnalysisToDrive(){try{const content=localStorage.getItem('analysisResults');if(!content){alert('⚠️ Chưa có dữ liệu để upload!');return;}const response=await gapi.client.drive.files.list({q:`name='${ANALYSIS_CACHE_NAME}' and trashed=false`,fields:'files(id)'});if(response.result.files.length>0){await gapi.client.request({path:`/upload/drive/v3/files/${response.result.files[0].id}`,method:'PATCH',params:{uploadType:'media'},body:content});}else{await gapi.client.drive.files.create({resource:{name:ANALYSIS_CACHE_NAME,mimeType:'application/json'},media:{mimeType:'application/json',body:content},fields:'id'});}alert('✅ Đã upload phân tích');}catch(err){console.error(err);}}
async function downloadAnalysisFromDrive(){try{const response=await gapi.client.drive.files.list({q:`name='${ANALYSIS_CACHE_NAME}' and trashed=false`,fields:'files(id)'});if(response.result.files.length===0){alert('❌ Không có file phân tích trên Drive');return;}const fileId=response.result.files[0].id;const analysisResponse=await gapi.client.drive.files.get({fileId:fileId,alt:'media'});localStorage.setItem('analysisResults',analysisResponse.body);loadAnalysisLocal();alert('✅ Đã tải phân tích từ Drive');}catch(err){console.error(err);}}

// ====== Scan + Analyze ======
async function scanFolder(){updateStatus('🔍 Quét thư mục...');updateProgress(10);/* giả lập */window.txtFiles=[{id:'1',name:'demo1.txt',folderPath:'QuanLyTruyen'},{id:'2',name:'demo2.txt',folderPath:'QuanLyTruyen'}];updateProgress(100);updateStatus(`✅ Tìm thấy ${window.txtFiles.length} file`);document.getElementById('analyzeBtn').disabled=false;}

async function analyzeFiles(){if(!window.txtFiles||window.txtFiles.length===0){alert('⚠️ Vui lòng quét thư mục trước!');return;}
let existingAnalysis=[];const localData=localStorage.getItem('analysisResults');if(localData){try{existingAnalysis=JSON.parse(localData).analysisData||[];}catch(e){}}
const analyzedFileNames=existingAnalysis.map(a=>a.fileName);
let filesToAnalyze=window.txtFiles.filter(f=>!analyzedFileNames.includes(f.name));if(filesToAnalyze.length===0){updateStatus('✅ Tất cả file đã phân tích');analysisData=existingAnalysis;displayAdvancedAnalysisResults();return;}
const totalFiles=Math.min(filesToAnalyze.length,100);analysisData=[...existingAnalysis];
for(let i=0;i<totalFiles;i++){const file=filesToAnalyze[i];updateProgress((i/totalFiles)*100);updateDetailedStatus(`Đang phân tích: ${file.name}`);
try{const content="Nội dung giả lập cho "+file.name;const analysis=await performAdvancedAnalysis(content,file.name,file.folderPath);analysisData.push(analysis);saveAnalysisLocal();}catch(err){analysisData.push({fileName:file.name,error:err.message});}}
displayAdvancedAnalysisResults();updateProgress(100);updateStatus(`✅ Hoàn thành ${totalFiles} file`);setTimeout(()=>updateProgress(0),2000);}

async function performAdvancedAnalysis(content, fileName, folderPath) {
    const structure = analyzeStoryStructure(content);

    return {
        fileName: fileName,
        folderPath: folderPath,
        timestamp: new Date().toLocaleString('vi-VN'),
        basicStats: { wordCount: content.split(/\s+/).length },
        contentSample: content.substring(0, 200),
        storyStructure: structure   // 👉 thêm phân tích cấu trúc
    }
}

function displayAdvancedAnalysisResults(){const c=document.getElementById('analysisResults');if(!analysisData||analysisData.length===0){c.innerHTML='<p>Chưa có dữ liệu</p>';return;}let html=`<h4>📊 Có ${analysisData.length} file</h4>`;analysisData.forEach(d=>{if(d.error){html+=`<div>❌ ${d.fileName}: ${d.error}</div>`;}else{html+=`<div>📄 ${d.fileName} - ${d.basicStats.wordCount} từ</div>`;}});c.innerHTML=html;
if (d.storyStructure) {
   html += `<div style="margin-left:15px;">
       <p><strong>Ngôi kể:</strong> ${d.storyStructure.ngoike}</p>
       <p><strong>Nhân vật:</strong> ${d.storyStructure.nhanVat.join(', ')}</p>
       <p><strong>Thời gian:</strong> ${d.storyStructure.thoiGian.join(', ')}</p>
       <p><strong>Địa điểm:</strong> ${d.storyStructure.diaDiem.join(', ')}</p>
       <p><strong>Tình huống:</strong> ${d.storyStructure.tinhHuong.join(', ')}</p>
       <p><strong>Từ ngữ 18+:</strong> ${d.storyStructure.tuNgu18.join(', ')}</p>
       <details><summary>📖 Mở bài</summary><div class="story-content">${d.storyStructure.moBai}</div></details>
       <details><summary>📖 Thân bài</summary><div class="story-content">${d.storyStructure.thanBai}</div></details>
       <details><summary>📖 Kết bài</summary><div class="story-content">${d.storyStructure.ketBai}</div></details>
       <p><strong>Ngôn ngữ tình cảm:</strong> ${d.storyStructure.romantic.join(', ')}</p>
      <p><strong>Ngôn ngữ 18+:</strong> ${d.storyStructure.sexual.join(', ')}</p>
      <p><strong>Tiêu cực:</strong> ${d.storyStructure.negative.join(', ')}</p>
      <p><strong>Gia đình:</strong> ${d.storyStructure.family.join(', ')}</p>
      <p><strong>Bí mật:</strong> ${d.storyStructure.secret.join(', ')}</p>
      <p><strong>Cảm xúc tích cực:</strong> ${d.storyStructure.emotion.positive.join(', ')}</p>
      <p><strong>Cảm xúc tiêu cực:</strong> ${d.storyStructure.emotion.negative.join(', ')}</p>
      <p><strong>Hội thoại:</strong><br> ${d.storyStructure.hoiThoai.join('<br>')}</p>
   </div>`;
}
}

function switchTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(id).classList.add('active');}
// ====== PHÂN TÍCH TRUYỆN NÂNG CAO ======
function analyzeStoryStructure(content) {
    const lower = content.toLowerCase();

    // 1. Mở bài, thân bài, kết bài
    let moBai = content.substring(0, 300);
    let ketBai = content.substring(content.length - 300);
    let thanBai = content.substring(300, content.length - 300);

    // 2. Ngôi kể (dựa vào từ xưng hô)
    let ngoike = "Ngôi thứ ba";
    if (/\btôi\b|\bta\b|\bchúng tôi\b/.test(lower)) ngoike = "Ngôi thứ nhất";
    if (/\bbạn\b|\bcậu\b|\bmày\b/.test(lower)) ngoike = "Ngôi thứ hai";

    // 3. Nhân vật (tên viết hoa)
    let characterMatches = content.match(/\b[A-ZÀÁẢÃẠÂĂĐÊÔƠƯ][a-zàáảãạâăđêôơư]+\b/g) || [];
    let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

    // 4. Hội thoại (câu trong ngoặc kép hoặc có “nói, hỏi…”)
    let dialogues = [];
    content.split("\n").forEach(line => {
        if (/\".*\"/.test(line) || /(nói|hỏi|đáp|thưa|la|hét)/i.test(line)) {
            dialogues.push(line.trim());
        }
    });
    dialogues = dialogues.slice(0, 5);

    // 5. Thời gian
    const timeKeywords = ["sáng", "trưa", "chiều", "tối", "đêm", "hôm qua", "ngày mai", "năm", "tháng"];
    let times = timeKeywords.filter(t => lower.includes(t));

    // 6. Địa điểm / không gian
    const placeKeywords = ["nhà", "làng", "thành phố", "rừng", "biển", "núi", "trường", "chợ", "sông"];
    let places = placeKeywords.filter(p => lower.includes(p));

    // 7. Tình huống (sự kiện)
    const eventKeywords = ["gặp gỡ", "chia ly", "thử thách", "xung đột", "chiến đấu", "giải cứu", "bí mật"];
    let events = eventKeywords.filter(e => lower.includes(e));

    // 8. Từ ngữ 18+ (nhạy cảm)
    const adultKeywords = ["làm tình", "quan hệ", "dâm", "dục", "hôn", "ôm", "sướng"];
    let adults = adultKeywords.filter(w => lower.includes(w));
 // Quét theo bộ từ khóa mới
    function findMatches(words) {
        return words.filter(w => lower.includes(w));
    }

    let romantic = findMatches(sensitiveWords.romantic);
    let sexual = findMatches(sensitiveWords.sexual);
    let negative = findMatches(sensitiveWords.negative);
    let family = findMatches(sensitiveWords.family);
    let secret = findMatches(sensitiveWords.secret);

    let emotionPos = findMatches(emotionalWords.positive);
    let emotionNeg = findMatches(emotionalWords.negative);
    let emotionNeu = findMatches(emotionalWords.neutral);

    // Hội thoại nâng cao
    let dialogueLines = content.split(/\\n+/).filter(line => {
        return dialogueIndicators.some(ind => line.toLowerCase().includes(ind)) ||
               dialoguePunctuation.some(p => line.includes(p));
    }).slice(0, 5);
    return {
        moBai: content.substring(0, 300),
        thanBai: content.substring(300, content.length - 300),
        ketBai: content.substring(content.length - 300),
        ngoike: /\btôi\b|\bchúng tôi\b/.test(lower) ? "Ngôi thứ nhất" : "Ngôi thứ ba",
        nhanVat: uniqueChars,
        hoiThoai: dialogues,
        thoiGian: times,
        diaDiem: places,
        tinhHuong: events,
        tuNgu18: adults
        
    };
}
  // Từ nhạy cảm cho phân tích nâng cao
        const sensitiveWords = {
            romantic: ['yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'âm áp', 'say đắm', 'đam mê', 'dịu dàng', 'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi'],
            sexual: [
                'gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục',
                'dâm', 'dục', 'khoái cảm', 'kích thích', 'khoả thân', 'lõa thể',
                'sướng', 'rên rỉ', 'nứng', 'ướt át', 'cao trào', 'cực khoái', 'xuất tinh',
                'dương vật', 'cặc', 'buồi', 'chim', 'cái ấy',
                'âm đạo', 'lồn', 'bướm', 'âm hộ', 'hột le', 'mu', 'lỗ', 'xoạc',
                'bú vú', 'vú to', 'vú căng', 'bú mút', 'ngực trần', 'ngực khủng', 'đầu ti',
                'bú lồn', 'bú cặc', 'liếm lồn', 'liếm bi', 'nuốt tinh', 'bú hột le', 'bú đầu cặc',
                'tử cung', 'bắn vào tử cung', 'cặc dài 20cm', 'ngậm tinh', 'chịch', 'địt', 'nắc',
                'thổi kèn', 'bj', 'hj', 'anal', 'doggy', '69', 'threesome', 'thủ dâm',
                'chơi gái', 'đĩ', 'gái mại dâm', 'mông to', 'thụt ra thụt vào', 'cắm sâu',
                'sờ soạng', 'mút', 'cắn', 'xoa', 'vuốt ve', 'húp sò', 'phê', 'nghiện sex',
                'xoạc lồn', 'xoạc cặc', 'tra tấn tình dục', 'hành xác', 'chịu trận',
                'nhét', 'đút', 'làm nhục', 'bóp vú', 'tét đít', 'vỗ mông', 'túm tóc',
                'bạo dâm', 'cưỡng hiếp', 'hiếp dâm', 'loạn luân', 'thằng cha', 'ông già dâm đãng',
                'con đĩ', 'con cave', 'chị dâu', 'em dâu', 'anh rể', 'chị gái', 'mẹ chồng', 'cha con', 'mẹ con',
                'rên la', 'rên rỉ', 'hét lên vì sướng', 'mắt lờ đờ', 'mồ hôi nhễ nhại',
                'bắn tinh', 'phun tinh', 'tinh dịch', 'tinh tràn', 'nuốt sạch tinh',
                'mùi tanh', 'vị mặn', 'ướt đẫm', 'nước nhờn', 'dịch nhờn',
                 // ===== Hành động & tình dục =====
        'làm tình', 'quan hệ', 'ân ái', 'thủ dâm', 'kích thích',
        'cởi đồ', 'vuốt ve', 'sờ mó', 'ôm hôn', 'thâm nhập',
        'rên rỉ', 'xuất tinh', 'cao trào', 'cực khoái', 'ướt át',

        // ===== Lời thoại tình dục chung =====
        '"muốn anh"', '"muốn em"', '"làm em sướng"', '"cứng quá"',
        '"em ướt rồi"', '"mạnh lên"', '"ra đi"', '"bắn vào trong"',

        // ===== Quan hệ gia đình nhạy cảm =====
        'bố chồng', 'con dâu', 'cha chồng', 'nàng dâu',
        '"bố chồng"', '"con dâu"', '"cha chồng"', '"nàng dâu"',
        '"bố chồng ơi"', '"con dâu ngoan"', '"bố chồng làm cho con"',
        '"con dâu của bố"', '"bố muốn con"', '"bố chồng không chịu nổi"',
        '"con dâu sướng quá"', '"làm dâu bố"', '"bố chồng yêu con dâu"',
        
        // ===== Các tình huống thoại đặc thù =====
        'quan hệ với bố chồng', 'quan hệ cùng con dâu', 
        'chịch con dâu', 'bố chồng đụ con dâu', 'bố chồng hiếp con dâu',
        'làm tình với con dâu', 'bố chồng ôm con dâu',
        'con dâu rên', 'bố chồng thỏa mãn', 'bố chồng cưỡng hiếp'
            ],
            negative: ['ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi', 'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung'],
            family: ['bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà', 'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ'],
            secret: ['bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm', 'lặng lẽ', 'kín đáo', 'riêng tư']
        };

        const emotionalWords = {
            positive: ['vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 'thành công', 'hy vọng'],
            negative: ['buồn', 'đau', 'khổ', 'tệ', 'xấu', 'thất bại', 'tuyệt vọng', 'ghét', 'tức giận', 'lo lắng', 'sợ hãi', 'khóc', 'tang thương', 'bất hạnh', 'dối trá', 'phản bội', 'lừa dối', 'xót xa', 'đau đớn', 'xấu hổ', 'tủi nhục'],
            neutral: ['bình thường', 'thông thường', 'trung bình', 'ổn', 'được', 'tạm ổn']
        };

        // Từ khóa đặc biệt cho phân tích hội thoại
        const dialogueIndicators = ['nói', 'bảo', 'hỏi', 'đáp', 'thưa', 'kêu', 'gọi', 'hét', 'la', 'thét', 'thì thầm', 'rủ rỉ', 'lên tiếng', 'phát biểu', 'trả lời', 'hỏi lại', 'đáp lại'];
        const dialoguePunctuation = ['"', "'", ':', ';', '-', '—', '–'];
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
