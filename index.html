<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Thêm style cho cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Ẩn nội dung nhạy cảm mặc định */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chủ đề chuyên biệt</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>Tổng số file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Đã huấn luyện:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Từ vựng học được:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Cấu trúc câu:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Hội thoại:</span>
                                <span id="dialoguesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Bối cảnh:</span>
                                <span id="contextsCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Nhân vật:</span>
                                <span id="charactersCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Địa điểm:</span>
                                <span id="locationsCount">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động</h2>
                        
                        <div class="adult-warning">
                            ⚠️ Cảnh báo: AI sẽ tạo nội dung theo ngôi thứ nhất và có thể chứa nội dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">Nội dung:</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
                <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
                <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
                <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set(),
    transitionWords: new Set(),
    psychologicalTerms: new Set(),
    descriptivePatterns: new Set(),
    metaphors: new Set(),
    adultTerms: new Set(),
    characters: new Set(),
    locations: new Set(),
    timeFrames: new Set(),
    generationHistory: [],
    qualityMetrics: {
        complexityThreshold: 0.6,
        coherenceThreshold: 0.7,
        emotionThreshold: 0.65,
        targetWordCount: 3500
    }
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// Từ vựng và cấu trúc chuyên biệt - MỞ RỘNG
const specializedVocabulary = {
    familyRelations: ['bố chồng', 'con dâu', 'chồng', 'vợ', 'gia đình', 'họ hàng', 'mối quan hệ', 'phép tắc', 'ranh giới', 
                     'quyền lực gia trưởng', 'vai vế', 'tôn ti trật tự', 'nề nếp gia đình', 'quan hệ huyết thống'],
    emotions: ['căng thẳng', 'bối rối', 'ghen tị', 'tò mò', 'lo lắng', 'thèm muốn', 'khao khát', 'tội lỗi', 'xấu hổ', 
              'kích thích', 'dục vọng', 'bất an', 'day dứt', 'dằn vặt', 'giằng xé', 'ngờ vực', 'ám ảnh', 'khắc khoải',
              'xót xa', 'đau đớn', 'tê tái', 'ngột ngạt', 'bức bối', 'rối bời', 'hoang mang'],
    observations: ['quan sát', 'nhìn trộm', 'theo dõi', 'chú ý', 'phát hiện', 'để ý', 'nhận ra', 'thấy được', 'cảm nhận', 
                  'nghe được', 'khám phá', 'vô tình chứng kiến', 'bắt gặp', 'nhận thấy', 'thấu hiểu', 'thấu cảm'],
    innerThoughts: ['tôi nghĩ', 'trong tâm trí tôi', 'tôi tự hỏi', 'có lẽ', 'liệu rằng', 'tôi không thể tin được', 
                   'tôi cảm thấy', 'điều này khiến tôi', 'tôi nhận ra', 'tôi chợt hiểu', 'tôi ngỡ ngàng', 
                   'tôi giật mình nhận thấy', 'tôi bàng hoàng', 'tôi sửng sốt'],
    secretive: ['bí mật', 'giấu kín', 'che giấu', 'lén lút', 'thầm kín', 'kín đáo', 'âm thầm', 'không ai biết', 
               'chỉ mình tôi', 'im lặng', 'nén chặt', 'giữ kín trong lòng', 'không dám thổ lộ'],
    physicalDescriptions: ['đôi mắt', 'nụ cười', 'cử chỉ', 'ánh mắt', 'cách di chuyển', 'giọng nói', 'cách cười', 
                          'biểu cảm', 'dáng vẻ', 'bờ môi', 'mái tóc', 'bàn tay', 'vòng eo', 'cử động', 'hơi thở',
                          'nhịp tim', 'làn da', 'nét mặt', 'cơ thể', 'vòng một', 'vòng ba', 'vóc dáng', 'đường cong'],
    situations: ['bữa cơm gia đình', 'khi vợ đi vắng', 'cuối tuần', 'những buổi tối', 'lúc một mình', 'khi không ai chú ý',
                'đêm khuya', 'sáng sớm', 'khi tắm rửa', 'lúc thay đồ', 'khi uống rượu', 'trong phòng ngủ', 
                'ngoài vườn', 'trong bếp', 'trên ghế sofa', 'trong phòng tắm', 'khi say rượu'],
    adultElements: ['ham muốn', 'dục vọng', 'khát khao', 'bí mật cấm kị', 'ranh giới mờ nhạt', 'cám dỗ', 'sự quyến rũ', 
                   'không thể cưỡng lại', 'khoái cảm', 'say đắm', 'mê hoặc', 'thân thể', 'gợi cảm', 'quyến rũ',
                   'dục tính', 'kích động', 'mơn trớn', 'vuốt ve', 'thân mật', 'gần gũi', 'sờ soạng', 'ôm ấp',
                   'hôn', 'hôn nồng cháy', 'ân ái', 'làm tình', 'quan hệ', 'yêu đương', 'âm đạo', 'dương vật',
                   'ngực', 'vú', 'nhũ hoa', 'hông', 'mông', 'đùi', 'cặp đùi', 'bộ phận sinh dục', 'kích thích',
                   'khoái lạc', 'cực khoái', 'lên đỉnh', 'thăng hoa', 'sung sướng', 'đam mê', 'nứng', 'cương',
                   'ướt át', 'ẩm ướt', 'se khít', 'căng tròn', 'nở nang', 'quyến rũ', 'gợi tình', 'dâm dục'],
    psychologicalTerms: ['vô thức', 'tiềm thức', 'bản năng', 'ức chế', 'dồn nén', 'phòng thủ', 'phủ nhận', 'chiếu diễn',
                        'đồng nhất hóa', 'mặc cảm', 'mâu thuẫn nội tâm', 'xung đột tâm lý', 'ámm ảnh', 'dằn vặt'],
    transitionWords: ['tuy nhiên', 'bên cạnh đó', 'ngoài ra', 'hơn nữa', 'đặc biệt là', 'thêm vào đó', 'mặt khác',
                     'ngược lại', 'thực tế thì', 'quả thật', 'chắc chắn', 'có lẽ', 'dường như', 'rõ ràng là',
                     'cuối cùng thì', 'kết quả là', 'vì vậy', 'do đó', 'cho nên', 'đồng thời'],
    characterNames: ['An', 'Bình', 'Chi', 'Dũng', 'Hương', 'Hạnh', 'Hiếu', 'Khánh', 'Lan', 'Linh', 'Minh', 'My', 
                    'Nam', 'Nga', 'Ngọc', 'Nhật', 'Phương', 'Quân', 'Quỳnh', 'Sơn', 'Thảo', 'Thắng', 'Trang', 'Trung', 'Tú'],
    locations: ['phòng khách', 'phòng ngủ', 'nhà bếp', 'phòng tắm', 'ban công', 'sân vườn', 'cầu thang', 'hiên nhà',
               'phòng làm việc', 'phòng ăn', 'garage', 'tầng hầm', 'mái nhà', 'hành lang', 'lối vào'],
    timeFrames: ['sáng sớm', 'buổi trưa', 'chiều tà', 'hoàng hôn', 'đêm khuya', 'nửa đêm', 'rạng sáng', 
                'giữa trưa', 'xế chiều', 'chập choạng tối', 'đêm thanh vắng', 'khuya khoắt']
};

// CẢI TIẾN: Cấu trúc câu phức tạp hơn với nhiều tầng nghĩa
const narrativePatterns = {
    observation: [
        "Tôi để ý thấy {situation} giữa bố và {wife}, {detailed_observation} khiến tôi {emotion} một cách {intensity}.",
        "Trong {timeFrame}, tôi nhận ra {observation} về mối quan hệ của họ, {specific_detail} làm tôi {emotional_response}.",
        "Tôi không thể không chú ý đến {physicalDescription} khi {situation}, {additional_detail} càng khiến tôi {feeling}.",
        "Có điều gì đó trong {observation} khiến tôi {emotion}, {psychological_insight} cứ ám ảnh tâm trí tôi.",
        "Tôi thấy {wife} và bố {action} một cách {manner}, {contextual_detail} khiến bầu không khí trở nên {atmosphere}."
    ],
    innerMonologue: [
        "Trong tâm trí tôi, {innerThought} về những gì đang diễn ra, {psychological_analysis} khiến tôi {emotional_state}.",
        "Tôi tự hỏi liệu {question} có phải là điều tôi nghĩ không, {self_reflection} làm tôi {resulting_emotion}.",
        "Cảm giác {emotion} cứ ám ảnh tôi khi {situation}, {deep_thought} cứ vang vọng trong đầu.",
        "Tôi không thể ngừng nghĩ về {observation} mà tôi đã thấy, {interpretation} cứ xoáy sâu vào tâm trí.",
        "Điều này khiến tôi {emotion} một cách {intensity}, {introspection} khiến tôi nhận ra {realization}.",
        "Có lẽ tôi đang {doubt} nhưng {feeling} này không thể phủ nhận, {psychological_awareness} ngày càng rõ rệt."
    ],
    conflict: [
        "Tôi biết mình không nên {action} nhưng {desire} quá mạnh, {internal_struggle} khiến tôi {resulting_state}.",
        "Ranh giới giữa {rightWrong} ngày càng {blur}, {moral_dilemma} làm tôi {emotional_turmoil}.",
        "Tôi cảm thấy {guilty} vì {thought} về {situation}, {self_judgment} cứ dày vò tâm can tôi.",
        "Làm thế nào để tôi có thể {cope} với {feeling} này? {existential_question} cứ treo lơ lửng không lời giải.",
        "Mỗi lần {trigger}, tôi lại {reaction}, {pattern_analysis} khiến tôi nhận ra {self_discovery}."
    ],
    escalation: [
        "Những {timeFrame} gần đây, {situation} ngày càng {intensity}, {development_detail} khiến tôi {emotional_change}.",
        "Tôi nhận ra {realization} về bản thân mình, {personal_insight} làm thay đổi {perspective_change}.",
        "Không thể phủ nhận rằng {truth} đang xảy ra, {evidence} ngày càng {increasing_evidence}.",
        "Cách {wife} {action} với bố khiến tôi {emotion}, {behavioral_observation} cho thấy {implication}.",
        "Tôi bắt đầu {change} cách nhìn về {relationship}, {transformative_thought} dần hình thành trong tôi."
    ],
    // THÊM MỚI: Các loại đoạn văn chuyên sâu
    psychological: [
        "Trong sâu thẳm tâm trí, {psychological_insight} khiến tôi {emotional_response}, {deep_analysis} hé lộ {revelation}.",
        "Nhận thức của tôi về {situation} dần thay đổi, {cognitive_shift} mang đến {new_perspective}.",
        "Bản năng mách bảo tôi rằng {intuitive_feeling}, {subconscious_awareness} dần trỗi dậy mạnh mẽ.",
        "Tâm lý tôi rơi vào trạng thái {psychological_state}, {internal_process} diễn ra phức tạp khôn lường."
    ],
    reflective: [
        "Nhìn lại {time_period}, tôi nhận ra {retrospective_insight}, {hindsight} mang đến {lesson_learned}.",
        "Ký ức về {past_event} ùa về, {memory_detail} khiến tôi {emotional_reaction}.",
        "Nếu ngày đó tôi {alternative_action}, có lẽ {hypothetical_outcome} đã không xảy ra.",
        "Suy ngẫm về {life_aspect}, tôi chợt hiểu {philosophical_understanding} về bản chất con người."
    ],
    descriptive: [
        "Không gian xung quanh {environment_description}, {sensory_detail} tác động lên {emotional_response} của tôi.",
        "Ánh mắt {eye_description} của {character} như {metaphorical_comparison}, khiến tôi {resulting_feeling}.",
        "Cử chỉ {gesture_description} thoáng qua nhưng {significance} lại in sâu trong tâm trí tôi.",
        "Bầu không khí {atmosphere_description} bao trùm, {environmental_factor} góp phần tạo nên {overall_mood}."
    ],
    // THÊM: Các đoạn văn 18+
    adult: [
        "Tôi không thể rời mắt khỏi {physical_description} của cô ấy, {adult_observation} khiến tôi {intense_emotion}.",
        "Cảm giác {physical_sensation} lan tỏa khắp cơ thể tôi khi {intimate_situation}, {bodily_reaction} không thể kiểm soát.",
        "Mỗi lần {intimate_action}, tôi lại {physical_response} và {emotional_response} một cách {intensity}.",
        "Không gian giữa chúng tôi tràn ngập {atmosphere_description}, {sensory_detail} kích thích mọi giác quan.",
        "Tôi cảm nhận được {physical_detail} của cô ấy qua {clothing_description}, {imagination_detail} khiến tôi {arousal_state}."
    ],
    // THÊM: Các đoạn hội thoại
    dialogue: [
        '"{dialogue_content}" {character} nói với giọng {tone_of_voice}, {reaction_description}.',
        '"{dialogue_content}" {character} thốt lên, {emotional_expression} hiện rõ trên khuôn mặt.',
        '"{dialogue_content}" {character} thì thầm, {contextual_detail} khiến câu nói trở nên {significance}.',
        'Sau một hồi im lặng, {character} lên tiếng: "{dialogue_content}" với {non_verbal_cue}.'
    ]
};

// CẢI TIẾN: Các yếu tố tình tiết phong phú hơn
const plotElements = {
    triggers: ['khi vợ tôi cúi xuống', 'lúc bố giúp con dâu', 'những cử chỉ thân mật', 'ánh mắt trao đổi', 
              'tiếng cười nhẹ', 'cách họ đứng gần nhau', 'khi vai chạm vai', 'lúc tay vô tình chạm nhau',
              'khi chia sẻ chiếc khăn', 'lúc uống chung ly nước', 'khi điều chỉnh áo cho nhau'],
    timeFrames: ['những ngày', 'buổi tối', 'cuối tuần', 'khi tôi về nhà', 'lúc ăn cơm', 'những lúc yên tĩnh',
                'đêm khuya thanh vắng', 'sáng sớm tinh mơ', 'những chiều mưa', 'khi trời chập choạng tối'],
    locations: ['trong nhà bếp', 'ở phòng khách', 'ngoài sân', 'trên cầu thang', 'trong phòng tắm', 'ở ban công',
               'trong phòng ngủ', 'ngoài vườn sau', 'trên ghế sofa', 'quanh bàn ăn', 'dưới hiên nhà'],
    discoveries: ['tôi phát hiện ra', 'tôi tình cờ thấy', 'tôi nghe được', 'tôi nhận ra', 'tôi không thể tin',
                 'tôi vô tình chứng kiến', 'tôi bắt gặp', 'tôi khám phá ra', 'tôi vô tình nhìn thấy'],
    consequences: ['tôi mất ngủ', 'tôi không thể tập trung', 'tôi bắt đầu tránh', 'tôi càng quan sát nhiều hơn',
                  'tôi cảm thấy bối rối', 'tôi rơi vào hoang mang', 'tâm trí tôi rối bời', 'cảm xúc tôi giằng xé',
                  'tôi tìm cách lảng tránh', 'tôi cố gắng phớt lờ', 'tôi không ngừng suy diễn']
};

// HÀM TÍNH ĐIỂM CHẤT LƯỢNG VĂN BẢN
function calculateQualityMetrics(content) {
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const words = content.split(/\s+/).filter(w => w.length > 0);
    
    // Tính điểm phức tạp (dựa trên độ dài câu, từ vựng đa dạng)
    const avgSentenceLength = words.length / sentences.length;
    const uniqueWords = new Set(words.map(w => w.toLowerCase()));
    const lexicalDiversity = uniqueWords.size / words.length;
    const complexityScore = (avgSentenceLength / 20 * 0.4) + (lexicalDiversity * 0.6);
    
    // Tính điểm mạch lạc (dựa trên từ nối và liên kết)
    const transitionWordsCount = words.filter(w => 
        specializedVocabulary.transitionWords.includes(w.toLowerCase())).length;
    const coherenceScore = Math.min(1, transitionWordsCount / (sentences.length * 0.5));
    
    // Tính điểm cảm xúc (dựa trên từ vựng cảm xúc)
    const emotionWordsCount = words.filter(w => 
        specializedVocabulary.emotions.includes(w.toLowerCase()) || 
        specializedVocabulary.psychologicalTerms.includes(w.toLowerCase())).length;
    const emotionScore = Math.min(1, emotionWordsCount / (words.length * 0.1));
    
    // Tính điểm độ dài
    const lengthScore = Math.min(1, words.length / aiKnowledge.qualityMetrics.targetWordCount);
    
    return {
        complexity: Math.round(complexityScore * 100) / 100,
        coherence: Math.round(coherenceScore * 100) / 100,
        emotion: Math.round(emotionScore * 100) / 100,
        length: Math.round(lengthScore * 100) / 100,
        wordCount: words.length,
        sentenceCount: sentences.length
    };
}

// HÀM ĐÁNH GIÁ VÀ CẢI THIỆN CHẤT LƯỢNG
function evaluateAndImproveQuality(metrics, content) {
    let improvedContent = content;
    
    // Nếu điểm phức tạp thấp, thêm câu phức tạp hơn
    if (metrics.complexity < aiKnowledge.qualityMetrics.complexityThreshold) {
        const complexSentences = Array.from(aiKnowledge.sentenceStructures)
            .filter(s => s.split(' ').length > 15);
        if (complexSentences.length > 0) {
            const randomComplex = complexSentences[Math.floor(Math.random() * complexSentences.length)];
            improvedContent += " " + adaptLearnedSentence(randomComplex);
        }
    }
    
    // Nếu điểm mạch lạc thấp, thêm từ chuyển tiếp
    if (metrics.coherence < aiKnowledge.qualityMetrics.coherenceThreshold) {
        const transitions = Array.from(specializedVocabulary.transitionWords);
        const transition = transitions[Math.floor(Math.random() * transitions.length)];
        improvedContent = improvedContent.replace(/\. ([A-Z])/g, `. ${transition}, $1`);
    }
    
    // Nếu điểm cảm xúc thấp, thêm từ ngữ cảm xúc
    if (metrics.emotion < aiKnowledge.qualityMetrics.emotionThreshold) {
        const emotions = Array.from(specializedVocabulary.emotions);
        const emotion = emotions[Math.floor(Math.random() * emotions.length)];
        const emotionalPhrase = `Tôi cảm thấy ${emotion} một cách sâu sắc.`;
        improvedContent += " " + emotionalPhrase;
    }
    
    // Nếu độ dài chưa đạt, thêm nội dung mô tả
    if (metrics.wordCount < aiKnowledge.qualityMetrics.targetWordCount * 0.9) {
        const additionalContent = generateAdditionalContent();
        improvedContent += " " + additionalContent;
    }
    
    return improvedContent;
}

// HÀM TẠO NỘI DUNG BỔ SUNG
function generateAdditionalContent() {
    const contentTypes = ['observation', 'reflection', 'description', 'memory', 'adult', 'dialogue'];
    const selectedType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
    
    switch(selectedType) {
        case 'observation':
            return generateDetailedObservation();
        case 'reflection':
            return generateInnerReflection();
        case 'description':
            return generateEnvironmentDescription();
        case 'memory':
            return generateMemoryRecall();
        case 'adult':
            return generateAdultContent();
        case 'dialogue':
            return generateDialogue();
    }
}

// CÁC HÀM TẠO NỘI DUNG BỔ SUNG CHI TIẾT
function generateDetailedObservation() {
    const templates = [
        "Tôi quan sát thấy {detailed_observation}, {specific_detail} khiến tôi {emotional_response}.",
        "Không thể bỏ qua {visual_detail}, {movement_description} thu hút sự chú ý của tôi.",
        "Ánh mắt {character} {eye_expression}, {gaze_interpretation} khiến tôi {resulting_feeling}."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateInnerReflection() {
    const templates = [
        "Suy nghĩ về {situation}, tôi nhận ra {personal_insight} về bản thân.",
        "Tự vấn lương tâm, tôi thấy {self_realization} trong cách ứng xử của mình.",
        "Trạng thái nội tâm hiện tại của tôi là {emotional_state}, {self_analysis} giúp tôi hiểu rõ hơn."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateEnvironmentDescription() {
    const templates = [
        "Không gian xung quanh {environment_description}, {sensory_detail} ảnh hưởng đến tâm trạng tôi.",
        "Bầu không khí {atmosphere_description} bao trùm, {environmental_factor} góp phần tạo nên {overall_mood}.",
        "Ánh sáng {light_description} chiếu qua {window_description}, tạo nên {visual_effect} đầy {emotional_quality}."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateMemoryRecall() {
    const templates = [
        "Ký ức về {past_event} ùa về, {memory_detail} khiến tôi {emotional_reaction}.",
        "Nhớ lại {time_period} trước đây, tôi nhận ra {retrospective_insight} về cuộc sống.",
        "Hình ảnh {visual_memory} hiện lên trong tâm trí, {memory_significance} vẫn còn nguyên vẹn."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateAdultContent() {
    const templates = [
        "Cảm giác {physical_sensation} lan tỏa khắp cơ thể, {bodily_reaction} không thể kiềm chế.",
        "Tôi không thể rời mắt khỏi {physical_description}, {visual_appeal} kích thích mọi giác quan.",
        "Khoảnh khắc {intimate_action} khiến tôi {arousal_state}, {physiological_response} diễn ra tự nhiên."
    ];
    
    let content = getRandomElement(templates);
    content = replacePlaceholders(content);
    return content;
}

function generateDialogue() {
    const characters = ['bố', 'vợ tôi', 'con dâu', 'chồng', 'người đó'];
    const tones = ['dịu dàng', 'trầm ấm', 'thì thầm', 'run rẩy', 'nồng nàn', 'khàn khàn', 'đầy cảm xúc'];
    const dialogueContent = [
        "Em có biết anh đã mong chờ khoảnh khắc này lâu thế nào không?",
        "Anh không thể tiếp tục giấu cảm xúc này được nữa.",
        "Chúng ta không nên làm điều này, nhưng anh không thể cưỡng lại được.",
        "Em thật đẹp, đẹp đến mức khiến anh phát điên lên được.",
        "Hãy để mọi chuyện diễn ra tự nhiên thôi em."
    ];
    
    const template = getRandomElement(narrativePatterns.dialogue);
    const filledDialogue = template
        .replace("{dialogue_content}", getRandomElement(dialogueContent))
        .replace("{character}", getRandomElement(characters))
        .replace("{tone_of_voice}", getRandomElement(tones))
        .replace("{reaction_description}", getRandomElement(specializedVocabulary.emotions));
    
    return filledDialogue;
}

// HÀM THAY THẾ CÁC PLACEHOLDERS
function replacePlaceholders(content) {
    // Thay thế các placeholder cơ bản
    content = content.replace(/{situation}/g, getRandomElement(plotElements.triggers));
    content = content.replace(/{timeFrame}/g, getRandomElement(specializedVocabulary.timeFrames));
    content = content.replace(/{location}/g, getRandomElement(specializedVocabulary.locations));
    content = content.replace(/{emotion}/g, getRandomElement(specializedVocabulary.emotions));
    content = content.replace(/{character}/g, getRandomElement(specializedVocabulary.characterNames));
    content = content.replace(/{wife}/g, "vợ tôi");
    
    // Thay thế các placeholder phức tạp hơn
    content = content.replace(/{detailed_observation}/g, 
        getRandomElement([
            "cách ánh mắt họ lướt qua nhau", 
            "những cử chỉ thân mật không đúng mực",
            "khoảng cách quá gần giữa hai người",
            "những cái chạm tay dường như vô tình"
        ]));
    
    content = content.replace(/{psychological_insight}/g, 
        getRandomElement([
            "nhận thức về sự thu hút không thể phủ nhận",
            "cảm giác ghen tị lẫn tò mò",
            "sự thức tỉnh của những ham muốn tiềm ẩn",
            "mâu thuẫn giữa lý trí và cảm xúc"
        ]));
    
    content = content.replace(/{intensity}/g, 
        getRandomElement([
            "mãnh liệt", "khó tả", "khó kiểm soát", "sâu sắc", 
            "rõ rệt", "đáng ngạc nhiên", "bất ngờ"
        ]));
    
    // Thay thế các placeholder 18+
    content = content.replace(/{physical_description}/g, 
        getRandomElement([
            "đường cong quyến rũ", "vòng eo thon gọn", 
            "bờ môi căng mọng", "ánh mắt đầy mê hoặc",
            "làn da mịn màng", "mái tóc mềm mại"
        ]));
    
    content = content.replace(/{intimate_situation}/g, 
        getRandomElement([
            "cô ấy cúi xuống gần tôi", "hơi thở ấm áp phả vào tai",
            "cơ thể chúng tôi gần như chạm vào nhau", 
            "ánh mắt đầy ẩn ý trao nhau"
        ]));
    
    content = content.replace(/{arousal_state}/g, 
        getRandomElement([
            "kích động", "nóng bừng", "bồi hồi", "run rẩy",
            "thèm muốn", "khát khao", "bồn chồn"
        ]));
    
    return content;
}

// HÀM LẤY PHẦN TỬ NGẪU NHIÊN
function getRandomElement(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// HÀM THÍCH NGHI CÂU ĐÃ HỌC
function adaptLearnedSentence(sentence) {
    // Thay đổi chủ ngữ, động từ, trạng từ để tạo sự đa dạng
    const subjectReplacements = {
        "Tôi": ["Tôi", "Bản thân tôi", "Trong tôi", "Tâm trí tôi"],
        "Cô ấy": ["Cô ấy", "Người phụ nữ ấy", "Vợ tôi", "Người đó"],
        "Bố": ["Bố", "Bố tôi", "Người đàn ông ấy", "Ông ấy"]
    };
    
    const verbReplacements = {
        "nhận ra": ["nhận thấy", "phát hiện", "khám phá", "thấy được"],
        "cảm thấy": ["cảm nhận", "trải qua", "kinh nghiệm", "có cảm giác"],
        "nghĩ": ["suy nghĩ", "tự hỏi", "trầm ngâm", "đắn đo"]
    };
    
    let newSentence = sentence;
    
    // Thay thế chủ ngữ
    for (const [original, replacements] of Object.entries(subjectReplacements)) {
        if (newSentence.includes(original)) {
            newSentence = newSentence.replace(original, getRandomElement(replacements));
        }
    }
    
    // Thay thế động từ
    for (const [original, replacements] of Object.entries(verbReplacements)) {
        if (newSentence.includes(original)) {
            newSentence = newSentence.replace(original, getRandomElement(replacements));
        }
    }
    
    return newSentence;
}

// HÀM XỬ LÝ HUẤN LUYỆN AI
async function trainAI() {
    try {
        showLoading(true);
        updateStatus("🔍 Đang tìm kiếm và phân tích các file truyện...");
        
        // Tìm tất cả các file trong thư mục
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and trashed = false`,
            fields: 'files(id, name, mimeType, modifiedTime)',
            orderBy: 'modifiedTime desc'
        });
        
        const files = response.result.files;
        updateAIStats('totalFiles', files.length);
        
        let trainedCount = 0;
        let vocabulary = new Set();
        let sentences = new Set();
        let dialogues = [];
        let contexts = [];
        let characters = new Set();
        let locations = new Set();
        
        // Phân tích từng file
        for (const file of files) {
            if (file.mimeType === 'application/vnd.google-apps.document') {
                updateStatus(`📖 Đang phân tích: ${file.name}...`);
                
                try {
                    // Xuất file dưới dạng văn bản
                    const exportResponse = await gapi.client.drive.files.export({
                        fileId: file.id,
                        mimeType: 'text/plain'
                    });
                    
                    const content = exportResponse.body;
                    
                    // Trích xuất từ vựng
                    const words = content.split(/\s+/).filter(word => 
                        word.length > 2 && !word.match(/[0-9]/));
                    
                    words.forEach(word => {
                        const cleanWord = word.replace(/[.,!?;:()'"-]/g, '').toLowerCase();
                        if (cleanWord.length > 2) {
                            vocabulary.add(cleanWord);
                        }
                    });
                    
                    // Trích xuất câu
                    const contentSentences = content.split(/[.!?]+/).filter(s => s.trim().length > 10);
                    contentSentences.forEach(sentence => {
                        if (sentence.split(' ').length > 5) {
                            sentences.add(sentence.trim());
                        }
                    });
                    
                    // Trích xuất hội thoại (nằm trong dấu ngoặc kép)
                    const dialogueMatches = content.match(/"[^"]+"/g) || [];
                    dialogues = dialogues.concat(dialogueMatches.map(d => d.replace(/"/g, '')));
                    
                    // Trích xuất bối cảnh (câu chứa từ chỉ địa điểm, thời gian)
                    const contextPatterns = [
                        /\b(tại|ở|trong|trên|dưới|ngoài|gần|bên|cạnh)\s+[^,.!?]+/gi,
                        /\b(vào|lúc|khi|buổi|sáng|trưa|chiều|tối|đêm|ngày|tháng|năm)\s+[^,.!?]+/gi
                    ];
                    
                    contextPatterns.forEach(pattern => {
                        const matches = content.match(pattern) || [];
                        contexts = contexts.concat(matches);
                    });
                    
                    // Trích xuất tên nhân vật (từ viết hoa đứng đầu câu hoặc sau dấu chấm)
                    const nameMatches = content.match(/(?:^|[.!?]\s+)([A-ZÀ-Ỹ][a-zà-ỹ]+)(?:\s+[A-ZÀ-Ỹ][a-zà-ỹ]+)*/g) || [];
                    nameMatches.forEach(name => {
                        const cleanName = name.replace(/^[.!?]\s+/, '').trim();
                        if (cleanName.split(' ').length <= 3) {
                            characters.add(cleanName);
                        }
                    });
                    
                    // Trích xuất địa điểm (danh từ riêng chỉ địa điểm)
                    const locationWords = content.match(/\b([A-ZÀ-Ỹ][a-zà-ỹ]+(?:\s+[A-ZÀ-Ỹ][a-zà-ỹ]+)*)\b/g) || [];
                    locationWords.forEach(word => {
                        // Lọc ra các từ có khả năng là địa điểm
                        if (word.length > 3 && !characters.has(word)) {
                            locations.add(word);
                        }
                    });
                    
                    trainedCount++;
                    updateAIStats('trainedFiles', trainedCount);
                    
                } catch (error) {
                    console.error(`Lỗi khi phân tích file ${file.name}:`, error);
                }
            }
        }
        
        // Cập nhật kiến thức của AI
        aiKnowledge.vocabulary = new Set([...aiKnowledge.vocabulary, ...vocabulary]);
        aiKnowledge.sentenceStructures = new Set([...aiKnowledge.sentenceStructures, ...sentences]);
        aiKnowledge.dialogues = [...aiKnowledge.dialogues, ...dialogues];
        aiKnowledge.contexts = [...aiKnowledge.contexts, ...contexts];
        aiKnowledge.characters = new Set([...aiKnowledge.characters, ...characters]);
        aiKnowledge.locations = new Set([...aiKnowledge.locations, ...locations]);
        aiKnowledge.trainedFiles = trainedCount;
        
        // Cập nhật thống kê
        updateAIStats('vocabularyCount', aiKnowledge.vocabulary.size);
        updateAIStats('sentenceStructures', aiKnowledge.sentenceStructures.size);
        updateAIStats('dialoguesCount', aiKnowledge.dialogues.length);
        updateAIStats('contextsCount', aiKnowledge.contexts.length);
        updateAIStats('charactersCount', aiKnowledge.characters.size);
        updateAIStats('locationsCount', aiKnowledge.locations.size);
        
        // Cập nhật thanh tiến trình
        const progressPercent = Math.min(100, Math.round((trainedCount / files.length) * 100));
        document.getElementById('progressFill').style.width = `${progressPercent}%`;
        
        showLoading(false);
        updateStatus(`✅ Huấn luyện hoàn tất! Đã phân tích ${trainedCount} file. AI đã học được ${aiKnowledge.vocabulary.size} từ vựng và ${aiKnowledge.sentenceStructures.size} cấu trúc câu.`);
        
    } catch (error) {
        console.error("Lỗi trong quá trình huấn luyện AI:", error);
        showLoading(false);
        updateStatus("❌ Có lỗi xảy ra trong quá trình huấn luyện AI.", "error");
    }
}

// HÀM TẠO TRUYỆN TỰ ĐỘNG BẰNG AI
async function generateAIStory() {
    try {
        const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
        
        if (chapterCount < 100 || chapterCount > 150) {
            updateStatus("❌ Số chương phải từ 100 đến 150.", "error");
            return;
        }
        
        showLoading(true);
        updateGenerationStatus("🧠 AI đang tạo truyện mới...");
        
        // Tạo tên truyện
        const storyTitle = generateStoryTitle();
        
        // Tạo thư mục cho truyện mới
        const folderMetadata = {
            name: storyTitle,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [mainFolderId]
        };
        
        const folderResponse = await gapi.client.drive.files.create({
            resource: folderMetadata,
            fields: 'id'
        });
        
        const storyFolderId = folderResponse.result.id;
        
        // Tạo các chương
        let completedChapters = 0;
        
        for (let i = 1; i <= chapterCount; i++) {
            updateGenerationStatus(`📝 Đang tạo chương ${i}/${chapterCount}...`);
            
            const chapterTitle = `Chương ${i}: ${generateChapterTitle()}`;
            const chapterContent = generateChapterContent();
            
            // Tạo tài liệu Google Docs cho chương
            const docMetadata = {
                name: chapterTitle,
                mimeType: 'application/vnd.google-apps.document',
                parents: [storyFolderId]
            };
            
            await gapi.client.drive.files.create({
                resource: docMetadata,
                fields: 'id'
            });
            
            // Cập nhật nội dung
            // (Đoạn này cần thêm API để cập nhật nội dung Google Docs)
            
            completedChapters++;
            const progressPercent = Math.round((completedChapters / chapterCount) * 100);
            document.getElementById('generationProgressFill').style.width = `${progressPercent}%`;
            
            // Nghỉ một chút để tránh quá tải API
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Lưu thông tin truyện đã tạo
        aiGeneratedStories.push({
            title: storyTitle,
            folderId: storyFolderId,
            chapterCount: chapterCount,
            createdAt: new Date().toISOString()
        });
        
        showLoading(false);
        updateGenerationStatus(`✅ Đã tạo thành công truyện "${storyTitle}" với ${chapterCount} chương!`);
        
    } catch (error) {
        console.error("Lỗi khi tạo truyện AI:", error);
        showLoading(false);
        updateGenerationStatus("❌ Có lỗi xảy ra khi tạo truyện.", "error");
    }
}

// HÀM TẠO TIÊU ĐỀ TRUYỆN
function generateStoryTitle() {
    const prefixes = ["Bí Mật", "Mối Quan Hệ", "Ranh Giới", "Ẩn Ức", "Dục Vọng", "Cám Dỗ", "Ám Ảnh"];
    const suffixes = ["Gia Đình", "Tình Thù", "Người Thân", "Máu Mủ", "Tội Lỗi", "Trái Cấm", "Vượt Rào"];
    
    const prefix = getRandomElement(prefixes);
    const suffix = getRandomElement(suffixes);
    
    return `${prefix} ${suffix}`;
}

// HÀM TẠO TIÊU ĐỀ CHƯƠNG
function generateChapterTitle() {
    const patterns = [
        "Những {emotion} {secretive}",
        "{timeFrame} {situations}",
        "{discoveries} {locations}",
        "{consequences} {psychologicalTerms}",
        "{adultElements} {characterNames}"
    ];
    
    let title = getRandomElement(patterns);
    title = replacePlaceholders(title);
    
    // Viết hoa chữ cái đầu
    return title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

// HÀM TẠO NỘI DUNG CHƯƠNG
function generateChapterContent() {
    // Xác định số đoạn văn (từ 15-25 đoạn)
    const paragraphCount = Math.floor(Math.random() * 11) + 15;
    let content = "";
    
    for (let i = 0; i < paragraphCount; i++) {
        // Chọn ngẫu nhiên loại đoạn văn
        const paragraphTypes = Object.keys(narrativePatterns);
        const paragraphType = getRandomElement(paragraphTypes);
        const template = getRandomElement(narrativePatterns[paragraphType]);
        
        // Thay thế placeholder và thêm vào nội dung
        let paragraph = replacePlaceholders(template);
        
        // Viết hoa chữ cái đầu và thêm dấu chấm cuối
        paragraph = paragraph.charAt(0).toUpperCase() + paragraph.slice(1);
        if (!paragraph.endsWith('.')) paragraph += '.';
        
        content += paragraph + " ";
    }
    
    // Tính điểm chất lượng và cải thiện nếu cần
    const qualityMetrics = calculateQualityMetrics(content);
    content = evaluateAndImproveQuality(qualityMetrics, content);
    
    return content;
}

// HÀM CẬP NHẬT THỐNG KÊ AI
function updateAIStats(statId, value) {
    document.getElementById(statId).textContent = value.toLocaleString();
}

// HÀM CẬP NHẬT TRẠNG THÁI
function updateStatus(message, type = "info") {
    const statusElement = document.getElementById('status');
    statusElement.textContent = message;
    statusElement.className = `status ${type}`;
    statusElement.style.display = 'block';
    
    // Tự động ẩn thông báo sau 5 giây
    if (type !== 'error') {
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 5000);
    }
}

// HÀM CẬP NHẬT TRẠNG THÁI TẠO TRUYỆN
function updateGenerationStatus(message, type = "info") {
    const statusElement = document.getElementById('generationStatus');
    statusElement.textContent = message;
    statusElement.className = `status ${type}`;
    statusElement.style.display = 'block';
}

// HÀM HIỂN THỊ/ẨN LOADING
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// HÀM ĐÓNG MODAL
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// CÁC HÀM KHỞI TẠO VÀ XỬ LÝ SỰ KIỆN
function initGoogleAPIs() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
    });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // Để trống, xử lý callback thủ công
    });
    gis_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw resp;
        }
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').innerText = '🔄 Làm mới';
        
        await listFiles();
        document.getElementById('mainApp').style.display = 'block';
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('authorizeButton').innerText = '🔐 Đăng nhập Google Drive';
        document.getElementById('mainApp').style.display = 'none';
        updateStatus('Đã đăng xuất thành công.');
    }
}

async function listFiles() {
    let response;
    try {
        response = await gapi.client.drive.files.list({
            q: "mimeType='application/vnd.google-apps.folder' and name='AI Truyện Manager' and trashed=false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });
    } catch (err) {
        document.getElementById('status').textContent = err.message;
        return;
    }
    
    const files = response.result.files;
    if (files && files.length > 0) {
        mainFolderId = files[0].id;
        updateStatus('Đã tìm thấy thư mục chính.');
        await loadStoryHistory();
    } else {
        await createMainFolder();
    }
}

async function createMainFolder() {
    const fileMetadata = {
        name: 'AI Truyện Manager',
        mimeType: 'application/vnd.google-apps.folder'
    };
    
    try {
        const response = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        
        mainFolderId = response.result.id;
        updateStatus('Đã tạo thư mục chính thành công.');
    } catch (error) {
        updateStatus('Lỗi khi tạo thư mục: ' + error.message, 'error');
    }
}

async function loadStoryHistory() {
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime, modifiedTime)',
            orderBy: 'modifiedTime desc'
        });
        
        const folders = response.result.files;
        storyHistory = folders;
        
        displayStoryHistory(folders);
        populateExistingStories(folders);
    } catch (error) {
        console.error('Lỗi khi tải lịch sử truyện:', error);
    }
}

function displayStoryHistory(folders) {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    if (folders.length === 0) {
        historyList.innerHTML = '<p class="no-data">Chưa có truyện nào.</p>';
        return;
    }
    
    folders.forEach(folder => {
        const date = new Date(folder.modifiedTime || folder.createdTime).toLocaleDateString('vi-VN');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="history-title">${folder.name}</div>
            <div class="history-date">Cập nhật: ${date}</div>
            <button class="btn small" onclick="viewChapters('${folder.id}', '${folder.name}')">Xem chương</button>
        `;
        historyList.appendChild(item);
    });
}

function populateExistingStories(folders) {
    const select = document.getElementById('existingStory');
    select.innerHTML = '<option value="">-- Chọn truyện --</option>';
    
    folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = folder.name;
        select.appendChild(option);
    });
}

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    document.getElementById('newStoryGroup').style.display = mode === 'new' ? 'block' : 'none';
    document.getElementById('existingStoryGroup').style.display = mode === 'existing' ? 'block' : 'none';
    document.getElementById('submitButtonText').textContent = mode === 'new' ? 'Lưu Truyện Mới' : 'Thêm Chương Mới';
}

async function handleStorySubmit(e) {
    e.preventDefault();
    
    const mode = document.getElementById('storyMode').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const storyContent = document.getElementById('storyContent').value;
    
    if (!chapterTitle || !storyContent) {
        updateStatus('Vui lòng nhập đầy đủ tiêu đề và nội dung.', 'error');
        return;
    }
    
    showLoading(true);
    
    try {
        let storyFolderId;
        
        if (mode === 'new') {
            const storyTitle = document.getElementById('storyTitle').value;
            if (!storyTitle) {
                updateStatus('Vui lòng nhập tên truyện mới.', 'error');
                showLoading(false);
                return;
            }
            
            // Tạo thư mục mới cho truyện
            const folderMetadata = {
                name: storyTitle,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [mainFolderId]
            };
            
            const folderResponse = await gapi.client.drive.files.create({
                resource: folderMetadata,
                fields: 'id'
            });
            
            storyFolderId = folderResponse.result.id;
            updateStatus(`Đã tạo truyện mới: ${storyTitle}`);
            
        } else {
            storyFolderId = document.getElementById('existingStory').value;
            if (!storyFolderId) {
                updateStatus('Vui lòng chọn một truyện có sẵn.', 'error');
                showLoading(false);
                return;
            }
        }
        
        // Tạo tài liệu Google Docs cho chương
        const docMetadata = {
            name: chapterTitle,
            mimeType: 'application/vnd.google-apps.document',
            parents: [storyFolderId]
        };
        
        const docResponse = await gapi.client.drive.files.create({
            resource: docMetadata,
            fields: 'id'
        });
        
        // Cập nhật nội dung cho tài liệu
        // (Đoạn này cần thêm API để cập nhật nội dung Google Docs)
        
        updateStatus(`Đã lưu chương: ${chapterTitle}`);
        
        // Reset form
        document.getElementById('storyForm').reset();
        
        // Cập nhật lịch sử
        await loadStoryHistory();
        
    } catch (error) {
        console.error('Lỗi khi lưu truyện:', error);
        updateStatus('Lỗi khi lưu truyện: ' + error.message, 'error');
    }
    
    showLoading(false);
}

async function viewChapters(folderId, folderName) {
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = response.result.files;
        
        document.getElementById('chaptersModalTitle').textContent = `Chương truyện: ${folderName}`;
        const chapterList = document.getElementById('chapterList');
        chapterList.innerHTML = '';
        
        if (chapters.length === 0) {
            chapterList.innerHTML = '<p class="no-data">Chưa có chương nào.</p>';
        } else {
            chapters.forEach(chapter => {
                const date = new Date(chapter.modifiedTime).toLocaleDateString('vi-VN');
                const item = document.createElement('div');
                item.className = 'chapter-item';
                item.innerHTML = `
                    <div class="chapter-title">${chapter.name}</div>
                    <div class="chapter-date">${date}</div>
                    <button class="btn small" onclick="viewChapterContent('${chapter.id}', '${chapter.name}')">Đọc</button>
                `;
                chapterList.appendChild(item);
            });
        }
        
        document.getElementById('chaptersModal').style.display = 'block';
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
        
    } catch (error) {
        console.error('Lỗi khi tải danh sách chương:', error);
        updateStatus('Lỗi khi tải danh sách chương: ' + error.message, 'error');
    }
}

async function viewChapterContent(chapterId, chapterTitle) {
    try {
        // Xuất nội dung từ Google Docs
        const response = await gapi.client.drive.files.export({
            fileId: chapterId,
            mimeType: 'text/plain'
        });
        
        const content = response.body;
        
        document.getElementById('chapterList').style.display = 'none';
        document.getElementById('chapterContent').style.display = 'block';
        document.getElementById('chapterContent').innerHTML = `
            <h3>${chapterTitle}</h3>
            <div class="content-text">${content.replace(/\n/g, '<br>')}</div>
        `;
        
        document.getElementById('chapterActions').style.display = 'block';
        currentEditingChapter = { id: chapterId, title: chapterTitle, content: content };
        
    } catch (error) {
        console.error('Lỗi khi tải nội dung chương:', error);
        updateStatus('Lỗi khi tải nội dung chương: ' + error.message, 'error');
    }
}

function editChapter() {
    const contentDiv = document.querySelector('.content-text');
    const currentContent = contentDiv.innerHTML.replace(/<br>/g, '\n');
    
    contentDiv.innerHTML = `
        <textarea id="editContent" style="width: 100%; height: 300px;">${currentContent}</textarea>
    `;
    
    document.querySelector('.chapter-actions').innerHTML += `
        <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
        <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
    `;
}

async function saveChapterChanges() {
    const editedContent = document.getElementById('editContent').value;
    
    try {
        // Cập nhật nội dung trong Google Docs
        // (Đoạn này cần thêm API để cập nhật nội dung Google Docs)
        
        updateStatus('Đã cập nhật nội dung chương.');
        currentEditingChapter.content = editedContent;
        cancelEdit();
        
    } catch (error) {
        console.error('Lỗi khi cập nhật chương:', error);
        updateStatus('Lỗi khi cập nhật chương: ' + error.message, 'error');
    }
}

function cancelEdit() {
    document.getElementById('chapterContent').innerHTML = `
        <h3>${currentEditingChapter.title}</h3>
        <div class="content-text">${currentEditingChapter.content.replace(/\n/g, '<br>')}</div>
    `;
    
    document.querySelector('.chapter-actions').innerHTML = `
        <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
        <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
        <button class="btn" onclick="document.getElementById('chapterList').style.display = 'block'; document.getElementById('chapterContent').style.display = 'none'; document.getElementById('chapterActions').style.display = 'none';">↩️ Quay lại</button>
    `;
}

async function deleteChapter() {
    if (!confirm('Bạn có chắc chắn muốn xóa chương này?')) return;
    
    try {
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        updateStatus('Đã xóa chương thành công.');
        closeModal('chaptersModal');
        
        // Cập nhật lại danh sách chương
        const folderId = document.getElementById('existingStory').value;
        if (folderId) {
            await viewChapters(folderId, document.getElementById('chaptersModalTitle').textContent.replace('Chương truyện: ', ''));
        }
        
    } catch (error) {
        console.error('Lỗi khi xóa chương:', error);
        updateStatus('Lỗi khi xóa chương: ' + error.message, 'error');
    }
}

function viewAIStories() {
    const storyList = document.getElementById('aiStoryList');
    storyList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        storyList.innerHTML = '<p class="no-data">Chưa có truyện nào được tạo bởi AI.</p>';
    } else {
        aiGeneratedStories.forEach(story => {
            const date = new Date(story.createdAt).toLocaleDateString('vi-VN');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="history-title">${story.title}</div>
                <div class="history-date">Tạo ngày: ${date}</div>
                <div class="history-detail">Số chương: ${story.chapterCount}</div>
                <button class="btn small" onclick="viewChapters('${story.folderId}', '${story.title}')">Xem truyện</button>
            `;
            storyList.appendChild(item);
        });
    }
    
    document.getElementById('aiStoriesModal').style.display = 'block';
}

// ĐĂNG KÝ SỰ KIỆN
document.addEventListener('DOMContentLoaded', function() {
    initGoogleAPIs();
    
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    document.getElementById('storyForm').onsubmit = handleStorySubmit;
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    document.getElementById('generateStoryButton').onclick = generateAIStory;
    document.getElementById('viewAiStoriesButton').onclick = viewAIStories;
    
    // Menu navigation
    document.getElementById('menuTraining').onclick = () => showSection('trainingSection');
    document.getElementById('menuGeneration').onclick = () => showSection('generationSection');
    document.getElementById('menuManagement').onclick = () => showSection('managementSection');
    document.getElementById('menuHistory').onclick = () => showSection('historySection');
});

function showSection(sectionId) {
    // Ẩn tất cả các section
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Bỏ active tất cả các nút menu
    document.querySelectorAll('.nav-menu button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Hiển thị section được chọn
    document.getElementById(sectionId).classList.add('active');
    
    // Active nút menu tương ứng
    document.getElementById('menu' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1).replace('Section', ''))
        .classList.add('active');
}

function resetAI() {
    if (confirm('Bạn có chắc chắn muốn reset toàn bộ kiến thức của AI? Hành động này không thể hoàn tác.')) {
        aiKnowledge = {
            vocabulary: new Set(),
            stories: [],
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set(),
            transitionWords: new Set(),
            psychologicalTerms: new Set(),
            descriptivePatterns: new Set(),
            metaphors: new Set(),
            adultTerms: new Set(),
            characters: new Set(),
            locations: new Set(),
            timeFrames: new Set(),
            generationHistory: [],
            qualityMetrics: {
                complexityThreshold: 0.6,
                coherenceThreshold: 0.7,
                emotionThreshold: 0.65,
                targetWordCount: 3500
            }
        };
        
        // Reset thống kê
        updateAIStats('totalFiles', 0);
        updateAIStats('trainedFiles', 0);
        updateAIStats('vocabularyCount', 0);
        updateAIStats('sentenceStructures', 0);
        updateAIStats('dialoguesCount', 0);
        updateAIStats('contextsCount', 0);
        updateAIStats('charactersCount', 0);
        updateAIStats('locationsCount', 0);
        
        document.getElementById('progressFill').style.width = '0%';
        
        updateStatus('✅ Đã reset toàn bộ kiến thức của AI.');
    }
}
</script>
</body>
</html>
