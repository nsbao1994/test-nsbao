<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>C√¥ng c·ª• S√°ng t√°c Ti·ªÉu thuy·∫øt v·ªõi AI</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #1a2530;
            --accent-color: #3498db;
            --ai-color: #9b59b6;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #e0e0e0;
            --light-text: #f8f9fa;
            --border-color: #333;
            --success-color: #27ae60;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            padding-bottom: 70px; /* Space for bottom menu */
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .upload-section, .analysis-section, .creation-section, .learning-section, .reader-section, .ai-section {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }
        
        h1, h2, h3 {
            color: var(--light-text);
            margin-top: 0;
        }
        
        textarea, input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            background-color: #2d2d2d;
            color: var(--text-color);
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        input[type="file"] {
            padding: 0.8rem;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
            font-weight: 600;
        }
        
        button:hover, button:active {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        button.secondary {
            background-color: #7f8c8d;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.ai {
            background-color: var(--ai-color);
        }
        
        .analysis-result, .generated-story {
            background-color: #2d2d2d;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            white-space: pre-wrap;
            line-height: 1.8;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .character-grid, .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .character-card, .theme-card {
            background-color: #2d2d2d;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .chapter-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .chapter-item:last-child {
            border-bottom: none;
        }
        
        .chapter-item:hover {
            background-color: #2d2d2d;
        }
        
        .reader-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background-color);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            font-size: 18px;
            padding-bottom: 80px;
        }
        
        .reader-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            color: var(--light-text);
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .menu-item.active {
            opacity: 1;
        }
        
        .menu-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }
        
        .hidden {
            display: none;
        }
        
        .visible {
            display: block;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .ai-suggestion {
            background-color: #2d2d2d;
            border-left: 4px solid var(--ai-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--primary-color);
            color: var(--light-text);
            margin-top: 2rem;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
            }
            
            .character-grid, .theme-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .button-group {
                display: flex;
                gap: 10px;
            }
            
            .button-group button {
                width: auto;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>C√¥ng c·ª• S√°ng t√°c Ti·ªÉu thuy·∫øt v·ªõi AI</h1>
    </header>
    
    <div class="container">
        <section id="uploadSection" class="section active">
            <div class="upload-section">
                <h2>T·∫£i l√™n ti·ªÉu thuy·∫øt</h2>
                <p>Ch·ªçn file vƒÉn b·∫£n (.txt) ƒë·ªÉ ph√¢n t√≠ch ho·∫∑c ti·∫øp t·ª•c vi·∫øt</p>
                <input type="file" id="fileUpload" accept=".txt">
                <p>Ho·∫∑c d√°n n·ªôi dung v√†o ƒë√¢y:</p>
                <textarea id="storyData" rows="10" placeholder="D√°n n·ªôi dung truy·ªán v√†o ƒë√¢y..."></textarea>
                <button id="analyzeBtn">Ph√¢n t√≠ch truy·ªán</button>
            </div>
        </section>
        
        <section id="analysisSection" class="section">
            <div class="analysis-section">
                <h2>K·∫øt qu·∫£ ph√¢n t√≠ch</h2>
                <div class="analysis-result" id="analysisResult">
                    <!-- K·∫øt qu·∫£ ph√¢n t√≠ch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
                
                <h3>Nh√¢n v·∫≠t ch√≠nh</h3>
                <div class="character-grid" id="characterGrid">
                    <!-- Th·∫ª nh√¢n v·∫≠t s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                </div>
                
                <h3>Ch·ªß ƒë·ªÅ v√† c·∫£m x√∫c</h3>
                <div class="theme-grid" id="themeGrid">
                    <!-- Th·∫ª ch·ªß ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                </div>
            </div>
        </section>
        
        <section id="creationSection" class="section">
            <div class="creation-section">
                <h2>S√°ng t√°c ti·ªÉu thuy·∫øt</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                    <input type="text" id="storyTitle" placeholder="Ti√™u ƒë·ªÅ ti·ªÉu thuy·∫øt" style="flex: 2;">
                    <input type="number" id="chapterNumber" placeholder="Ch∆∞∆°ng" min="1" style="flex: 1;">
                </div>
                
                <textarea id="storyPrompt" rows="5" placeholder="M√¥ t·∫£ n·ªôi dung ch∆∞∆°ng ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·∫°o ng·∫´u nhi√™n"></textarea>
                
                <div class="button-group">
                    <button id="generateBtn" class="success">T·∫°o ch∆∞∆°ng m·ªõi</button>
                    <button id="aiGenerateBtn" class="ai">AI vi·∫øt ti·∫øp</button>
                    <button id="saveChapterBtn">L∆∞u ch∆∞∆°ng</button>
                </div>
                
                <h3 style="margin-top: 1.5rem;">Danh s√°ch ch∆∞∆°ng</h3>
                <div class="chapter-list" id="chapterList">
                    <!-- Danh s√°ch ch∆∞∆°ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
                
                <div class="generated-story hidden" id="generatedStory">
                    <!-- Truy·ªán ƒë∆∞·ª£c t·∫°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </section>
        
        <section id="aiSection" class="section">
            <div class="ai-section">
                <h2>Tr·ª£ l√Ω AI s√°ng t√°c</h2>
                <p>S·ª≠ d·ª•ng AI ƒë·ªÉ c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng truy·ªán c·ªßa b·∫°n</p>
                
                <div class="button-group">
                    <button id="aiSuggestPlotBtn" class="ai">G·ª£i √Ω c·ªët truy·ªán</button>
                    <button id="aiDevelopCharacterBtn" class="ai">Ph√°t tri·ªÉn nh√¢n v·∫≠t</button>
                    <button id="aiImproveWritingBtn" class="ai">C·∫£i thi·ªán vƒÉn phong</button>
                </div>
                
                <div id="aiResult" class="ai-suggestion hidden">
                    <!-- K·∫øt qu·∫£ AI s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </section>
        
        <section id="readerSection" class="section">
            <div class="reader-section">
                <h2>Tr√¨nh ƒë·ªçc ti·ªÉu thuy·∫øt</h2>
                <p>Ch·ªçn m·ªôt ti·ªÉu thuy·∫øt ƒë·ªÉ ƒë·ªçc:</p>
                <select id="novelSelector" style="width: 100%; padding: 1rem; margin-bottom: 1rem; background: #2d2d2d; color: white; border: 1px solid #333; border-radius: 8px;">
                    <option value="">-- Ch·ªçn ti·ªÉu thuy·∫øt --</option>
                </select>
                
                <div id="readerChapters" class="chapter-list">
                    <!-- Danh s√°ch ch∆∞∆°ng c·ªßa ti·ªÉu thuy·∫øt ƒë√£ ch·ªçn -->
                </div>
            </div>
        </section>
        
        <section id="learningSection" class="section">
            <div class="learning-section">
                <h2>H·ªçc t·ª´ truy·ªán ƒë√£ t·∫°o</h2>
                <p>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông h·ªçc t·ª´ nh·ªØng truy·ªán b·∫°n ƒë√£ t·∫°o ƒë·ªÉ c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng trong t∆∞∆°ng lai.</p>
                <div id="learningStatus"></div>
                
                <h3>Th·ªëng k√™</h3>
                <div id="statsContainer">
                    <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </section>
    </div>
    
    <!-- Reader View -->
    <div id="readerView" class="reader-container">
        <div class="reader-content" id="readerContent"></div>
        <div class="reader-controls">
            <button id="readerPrev">Ch∆∞∆°ng tr∆∞·ªõc</button>
            <select id="readerChapterSelector" style="padding: 0.5rem; margin: 0 1rem; background: #2d2d2d; color: white; border: 1px solid #555; border-radius: 4px;"></select>
            <button id="readerNext">Ch∆∞∆°ng sau</button>
            <button id="closeReader" style="margin-left: 1rem;">ƒê√≥ng</button>
        </div>
    </div>
    
    <!-- Bottom Menu -->
    <div class="bottom-menu">
        <div class="menu-item active" data-section="uploadSection">
            <div class="menu-icon">üì•</div>
            <span>T·∫£i l√™n</span>
        </div>
        <div class="menu-item" data-section="analysisSection">
            <div class="menu-icon">üìä</div>
            <span>Ph√¢n t√≠ch</span>
        </div>
        <div class="menu-item" data-section="creationSection">
            <div class="menu-icon">‚úçÔ∏è</div>
            <span>S√°ng t√°c</span>
        </div>
        <div class="menu-item" data-section="aiSection">
            <div class="menu-icon">ü§ñ</div>
            <span>AI</span>
        </div>
        <div class="menu-item" data-section="readerSection">
            <div class="menu-icon">üìñ</div>
            <span>ƒê·ªçc</span>
        </div>
    </div>
    
    <footer>
        <p>C√¥ng c·ª• S√°ng t√°c Ti·ªÉu thuy·∫øt v·ªõi AI &copy; 2023</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const menuItems = document.querySelectorAll('.menu-item');
            const sections = document.querySelectorAll('.section');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const generateBtn = document.getElementById('generateBtn');
            const aiGenerateBtn = document.getElementById('aiGenerateBtn');
            const saveChapterBtn = document.getElementById('saveChapterBtn');
            const fileUpload = document.getElementById('fileUpload');
            const storyData = document.getElementById('storyData');
            const analysisSection = document.getElementById('analysisSection');
            const analysisResult = document.getElementById('analysisResult');
            const characterGrid = document.getElementById('characterGrid');
            const themeGrid = document.getElementById('themeGrid');
            const generatedStory = document.getElementById('generatedStory');
            const learningStatus = document.getElementById('learningStatus');
            const chapterList = document.getElementById('chapterList');
            const readerView = document.getElementById('readerView');
            const readerContent = document.getElementById('readerContent');
            const closeReader = document.getElementById('closeReader');
            const readerPrev = document.getElementById('readerPrev');
            const readerNext = document.getElementById('readerNext');
            const readerChapterSelector = document.getElementById('readerChapterSelector');
            const novelSelector = document.getElementById('novelSelector');
            const readerChapters = document.getElementById('readerChapters');
            const statsContainer = document.getElementById('statsContainer');
            const aiResult = document.getElementById('aiResult');
            const aiSuggestPlotBtn = document.getElementById('aiSuggestPlotBtn');
            const aiDevelopCharacterBtn = document.getElementById('aiDevelopCharacterBtn');
            const aiImproveWritingBtn = document.getElementById('aiImproveWritingBtn');
            
            // Data storage
            let analyzedData = {
                characters: [],
                themes: [],
                emotions: [],
                plotPoints: []
            };
            
            let currentNovel = {
                title: '',
                chapters: [],
                currentChapter: 0
            };
            
            let generatedStories = JSON.parse(localStorage.getItem('generatedStories')) || [];
            let novels = JSON.parse(localStorage.getItem('novels')) || [];
            
            // Initialize
            updateNovelSelector();
            if (generatedStories.length > 0) {
                updateLearningSystem();
            }
            
            // Bottom menu functionality
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    
                    // Update menu active state
                    menuItems.forEach(mi => mi.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // File upload handling
            fileUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        storyData.value = e.target.result;
                    };
                    reader.readAsText(file);
                }
            });
            
            // Analyze button event
            analyzeBtn.addEventListener('click', function() {
                const text = storyData.value;
                if (text.trim() === '') {
                    alert('Vui l√≤ng nh·∫≠p n·ªôi dung truy·ªán ƒë·ªÉ ph√¢n t√≠ch');
                    return;
                }
                
                analyzeText(text);
                
                // Switch to analysis section
                menuItems.forEach(mi => mi.classList.remove('active'));
                document.querySelector('[data-section="analysisSection"]').classList.add('active');
                sections.forEach(section => section.classList.remove('active'));
                analysisSection.classList.add('active');
            });
            
            // Generate button event
            generateBtn.addEventListener('click', function() {
                const title = document.getElementById('storyTitle').value || 'Ti·ªÉu thuy·∫øt kh√¥ng ti√™u ƒë·ªÅ';
                const chapterNum = document.getElementById('chapterNumber').value || (currentNovel.chapters.length + 1);
                const prompt = document.getElementById('storyPrompt').value;
                
                currentNovel.title = title;
                
                const newChapter = generateChapter(title, chapterNum, prompt);
                
                generatedStory.textContent = `Ch∆∞∆°ng ${chapterNum}: ${newChapter}`;
                generatedStory.classList.remove('hidden');
                
                // Add to current novel
                currentNovel.chapters.push({
                    number: chapterNum,
                    content: newChapter,
                    title: prompt || `Ch∆∞∆°ng ${chapterNum}`
                });
                
                updateChapterList();
            });
            
            // AI Generate button event
            aiGenerateBtn.addEventListener('click', async function() {
                if (currentNovel.chapters.length === 0) {
                    alert('Vui l√≤ng t·∫°o √≠t nh·∫•t m·ªôt ch∆∞∆°ng tr∆∞·ªõc khi s·ª≠ d·ª•ng AI!');
                    return;
                }
                
                const title = document.getElementById('storyTitle').value || 'Ti·ªÉu thuy·∫øt kh√¥ng ti√™u ƒë·ªÅ';
                const chapterNum = document.getElementById('chapterNumber').value || (currentNovel.chapters.length + 1);
                const prompt = document.getElementById('storyPrompt').value;
                
                currentNovel.title = title;
                
                // Show loading
                aiResult.innerHTML = '<div class="loading"></div> ƒêang t·∫°o n·ªôi dung v·ªõi AI...';
                aiResult.classList.remove('hidden');
                
                try {
                    const newChapter = await generateWithAI(title, chapterNum, prompt);
                    
                    generatedStory.textContent = `Ch∆∞∆°ng ${chapterNum}: ${newChapter}`;
                    generatedStory.classList.remove('hidden');
                    
                    // Add to current novel
                    currentNovel.chapters.push({
                        number: chapterNum,
                        content: newChapter,
                        title: prompt || `Ch∆∞∆°ng ${chapterNum}`
                    });
                    
                    updateChapterList();
                    
                    aiResult.innerHTML = '‚úÖ ƒê√£ t·∫°o ch∆∞∆°ng m·ªõi th√†nh c√¥ng v·ªõi AI!';
                } catch (error) {
                    console.error('AI Error:', error);
                    aiResult.innerHTML = '‚ùå C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';
                    
                    // Fallback to regular generation
                    const newChapter = generateChapter(title, chapterNum, prompt);
                    generatedStory.textContent = `Ch∆∞∆°ng ${chapterNum}: ${newChapter}`;
                    generatedStory.classList.remove('hidden');
                    
                    currentNovel.chapters.push({
                        number: chapterNum,
                        content: newChapter,
                        title: prompt || `Ch∆∞∆°ng ${chapterNum}`
                    });
                    
                    updateChapterList();
                }
            });
            
            // AI Suggestion buttons
            aiSuggestPlotBtn.addEventListener('click', async function() {
                if (currentNovel.chapters.length === 0) {
                    alert('Vui l√≤ng t·∫°o √≠t nh·∫•t m·ªôt ch∆∞∆°ng tr∆∞·ªõc khi s·ª≠ d·ª•ng AI!');
                    return;
                }
                
                aiResult.innerHTML = '<div class="loading"></div> AI ƒëang ph√¢n t√≠ch v√† ƒë∆∞a ra g·ª£i √Ω c·ªët truy·ªán...';
                aiResult.classList.remove('hidden');
                
                try {
                    const suggestion = await getAIPlotSuggestion();
                    aiResult.innerHTML = `<h4>G·ª£i √Ω c·ªët truy·ªán t·ª´ AI:</h4><p>${suggestion}</p>`;
                } catch (error) {
                    console.error('AI Suggestion Error:', error);
                    aiResult.innerHTML = '‚ùå C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';
                }
            });
            
            aiDevelopCharacterBtn.addEventListener('click', async function() {
                if (analyzedData.characters.length === 0) {
                    alert('Vui l√≤ng ph√¢n t√≠ch truy·ªán tr∆∞·ªõc ƒë·ªÉ x√°c ƒë·ªãnh nh√¢n v·∫≠t!');
                    return;
                }
                
                aiResult.innerHTML = '<div class="loading"></div> AI ƒëang ph√¢n t√≠ch v√† ph√°t tri·ªÉn nh√¢n v·∫≠t...';
                aiResult.classList.remove('hidden');
                
                try {
                    const suggestion = await getAICharacterDevelopment();
                    aiResult.innerHTML = `<h4>Ph√°t tri·ªÉn nh√¢n v·∫≠t t·ª´ AI:</h4><p>${suggestion}</p>`;
                } catch (error) {
                    console.error('AI Character Error:', error);
                    aiResult.innerHTML = '‚ùå C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';
                }
            });
            
            aiImproveWritingBtn.addEventListener('click', async function() {
                if (currentNovel.chapters.length === 0) {
                    alert('Vui l√≤ng t·∫°o √≠t nh·∫•t m·ªôt ch∆∞∆°ng tr∆∞·ªõc khi s·ª≠ d·ª•ng AI!');
                    return;
                }
                
                aiResult.innerHTML = '<div class="loading"></div> AI ƒëang ph√¢n t√≠ch v√† c·∫£i thi·ªán vƒÉn phong...';
                aiResult.classList.remove('hidden');
                
                try {
                    const lastChapter = currentNovel.chapters[currentNovel.chapters.length - 1];
                    const improvedText = await getAIWritingImprovement(lastChapter.content);
                    aiResult.innerHTML = `<h4>ƒê·ªÅ xu·∫•t c·∫£i thi·ªán vƒÉn phong t·ª´ AI:</h4><p>${improvedText}</p>`;
                } catch (error) {
                    console.error('AI Writing Error:', error);
                    aiResult.innerHTML = '‚ùå C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i sau.';
                }
            });
            
            // Save chapter button event
            saveChapterBtn.addEventListener('click', function() {
                if (currentNovel.chapters.length === 0) {
                    alert('Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë·ªÉ l∆∞u!');
                    return;
                }
                
                // Check if novel already exists
                const existingIndex = novels.findIndex(n => n.title === currentNovel.title);
                
                if (existingIndex !== -1) {
                    // Update existing novel
                    novels[existingIndex] = currentNovel;
                } else {
                    // Add new novel
                    novels.push(currentNovel);
                }
                
                localStorage.setItem('novels', JSON.stringify(novels));
                updateNovelSelector();
                
                alert(`ƒê√£ l∆∞u ti·ªÉu thuy·∫øt "${currentNovel.title}" v·ªõi ${currentNovel.chapters.length} ch∆∞∆°ng!`);
            });
            
            // Reader functionality
            novelSelector.addEventListener('change', function() {
                const novelTitle = this.value;
                if (!novelTitle) return;
                
                const novel = novels.find(n => n.title === novelTitle);
                if (!novel) return;
                
                // Display chapters
                readerChapters.innerHTML = '';
                novel.chapters.forEach((chapter, index) => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'chapter-item';
                    chapterItem.innerHTML = `<strong>Ch∆∞∆°ng ${chapter.number}</strong>: ${chapter.title}`;
                    chapterItem.addEventListener('click', () => {
                        openReader(novel, index);
                    });
                    readerChapters.appendChild(chapterItem);
                });
            });
            
            closeReader.addEventListener('click', function() {
                readerView.style.display = 'none';
            });
            
            readerPrev.addEventListener('click', function() {
                if (currentNovel.currentChapter > 0) {
                    currentNovel.currentChapter--;
                    displayChapter(currentNovel, currentNovel.currentChapter);
                }
            });
            
            readerNext.addEventListener('click', function() {
                if (currentNovel.currentChapter < currentNovel.chapters.length - 1) {
                    currentNovel.currentChapter++;
                    displayChapter(currentNovel, currentNovel.currentChapter);
                }
            });
            
            readerChapterSelector.addEventListener('change', function() {
                const chapterIndex = parseInt(this.value);
                currentNovel.currentChapter = chapterIndex;
                displayChapter(currentNovel, chapterIndex);
            });
            
            // AI Integration Functions
            async function generateWithAI(title, chapterNum, prompt) {
                // S·ª≠ d·ª•ng m·ªôt trong c√°c API mi·ªÖn ph√≠ sau:
                // 1. Hugging Face Inference API (mi·ªÖn ph√≠ v·ªõi h·∫°n ch·∫ø)
                // 2. OpenAI API (c√≥ th·ªÉ d√πng b·∫£n free trial)
                // 3. Cohere AI (c√≥ free tier)
                // 4. Local models v·ªõi Transformers.js
                
                // ·ªû ƒë√¢y t√¥i s·∫Ω s·ª≠ d·ª•ng Hugging Face Inference API nh∆∞ m·ªôt v√≠ d·ª•
                // L∆∞u √Ω: B·∫°n c·∫ßn ƒëƒÉng k√Ω API key t·∫°i https://huggingface.co/inference-api
                // v√† thay th·∫ø 'YOUR_HUGGING_FACE_API_KEY' b·∫±ng key th·ª±c c·ªßa b·∫°n
                
                const API_URL = "https://api-inference.huggingface.co/models/gpt2";
                const API_KEY = "YOUR_HUGGING_FACE_API_KEY"; // Thay th·∫ø b·∫±ng API key th·ª±c
                
                // N·∫øu kh√¥ng c√≥ API key, s·ª≠ d·ª•ng fallback
                if (API_KEY === "YOUR_HUGGING_FACE_API_KEY") {
                    return generateChapter(title, chapterNum, prompt);
                }
                
                const lastChapter = currentNovel.chapters.length > 0 
                    ? currentNovel.chapters[currentNovel.chapters.length - 1].content 
                    : "";
                
                const inputText = `Ti·ªÉu thuy·∫øt: ${title}. Ch∆∞∆°ng ${chapterNum}. ${prompt ? `H∆∞·ªõng d·∫´n: ${prompt}.` : ""} 
                Ch∆∞∆°ng tr∆∞·ªõc: ${lastChapter.substring(0, 500)}... 
                Vi·∫øt ti·∫øp:`;
                
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        inputs: inputText,
                        parameters: {
                            max_length: 500,
                            temperature: 0.9,
                            do_sample: true
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result[0].generated_text;
            }
            
            async function getAIPlotSuggestion() {
                // S·ª≠ d·ª•ng API t∆∞∆°ng t·ª± ƒë·ªÉ l·∫•y g·ª£i √Ω c·ªët truy·ªán
                const lastChapter = currentNovel.chapters[currentNovel.chapters.length - 1];
                
                // Fallback n·∫øu kh√¥ng c√≥ API key
                return `D·ª±a tr√™n ch∆∞∆°ng tr∆∞·ªõc (${lastChapter.title}), c·ªët truy·ªán c√≥ th·ªÉ ph√°t tri·ªÉn theo h∆∞·ªõng: 
                - M·ªôt nh√¢n v·∫≠t ph·∫£n di·ªán m·ªõi xu·∫•t hi·ªán v·ªõi √¢m m∆∞u b√≠ ·∫©n
                - Nh√¢n v·∫≠t ch√≠nh ph√°t hi·ªán ra b√≠ m·∫≠t ƒë·ªông tr·ªùi v·ªÅ qu√° kh·ª© c·ªßa m√¨nh
                - M·ªôt bi·∫øn c·ªë l·ªõn x·∫£y ra l√†m thay ƒë·ªïi ho√†n to√†n c·ª•c di·ªán truy·ªán
                - M·ªëi quan h·ªá gi·ªØa c√°c nh√¢n v·∫≠t ch√≠nh c√≥ b∆∞·ªõc ngo·∫∑t b·∫•t ng·ªù`;
            }
            
            async function getAICharacterDevelopment() {
                // S·ª≠ d·ª•ng API t∆∞∆°ng t·ª± ƒë·ªÉ ph√°t tri·ªÉn nh√¢n v·∫≠t
                const mainCharacter = analyzedData.characters[0];
                
                // Fallback n·∫øu kh√¥ng c√≥ API key
                return `ƒê·ªëi v·ªõi nh√¢n v·∫≠t ${mainCharacter.name}, b·∫°n c√≥ th·ªÉ:
                - Kh√°m ph√° qu√° kh·ª© h√¨nh th√†nh t√≠nh c√°ch c·ªßa nh√¢n v·∫≠t
                - T·∫°o ra ƒëi·ªÉm y·∫øu ho·∫∑c n·ªói s·ª£ ƒë·ªÉ nh√¢n v·∫≠t tr·ªü n√™n ƒëa chi·ªÅu
                - Thi·∫øt k·∫ø m·ªôt cung ƒë∆∞·ªùng ph√°t tri·ªÉn v·ªõi c√°c th·ª≠ th√°ch c·ª• th·ªÉ
                - X√¢y d·ª±ng m·ªëi quan h·ªá v·ªõi c√°c nh√¢n v·∫≠t kh√°c c√≥ chi·ªÅu s√¢u`;
            }
            
            async function getAIWritingImprovement(text) {
                // S·ª≠ d·ª•ng API t∆∞∆°ng t·ª± ƒë·ªÉ c·∫£i thi·ªán vƒÉn phong
                
                // Fallback n·∫øu kh√¥ng c√≥ API key
                return `ƒê·ªÉ c·∫£i thi·ªán vƒÉn phong cho ƒëo·∫°n vƒÉn, b·∫°n c√≥ th·ªÉ:
                - S·ª≠ d·ª•ng nhi·ªÅu t·ª´ ng·ªØ g·ª£i h√¨nh, g·ª£i c·∫£m h∆°n
                - ƒêa d·∫°ng h√≥a c·∫•u tr√∫c c√¢u (ng·∫Øn/d√†i, ƒë∆°n/gh√©p)
                - Th√™m chi ti·∫øt mi√™u t·∫£ ng≈© gi√°c (h√¨nh ·∫£nh, √¢m thanh, m√πi v·ªã)
                - T·∫≠p trung v√†o "show, don't tell" (hi·ªÉn th·ªã thay v√¨ k·ªÉ l·ªÉ)`;
            }
            
            // Analysis function
            function analyzeText(text) {
                // Improved character analysis
                const characterRegex = /(\b[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆ØƒÇ·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥√ù·ª∂·ª∏][a-z√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª≠·ªØ·ª±·ª≥·ªµ·ª∑·ªπ]+(?:\s[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆ØƒÇ·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥√ù·ª∂·ª∏][a-z√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª≠·ªØ·ª±·ª≥·ªµ·ª∑·ªπ]+)*)\b)/g;
                
                const characterMatches = text.match(characterRegex) || [];
                
                const characterCounts = {};
                characterMatches.forEach(char => {
                    const commonWords = ['√îng', 'B√†', 'Anh', 'Ch·ªã', 'Em', 'T√¥i', 'N√†ng', 'Ch√†ng', 'Cha', 'M·∫π', 'Con', 'C√¥', 'B√°c', 'Ch√∫', 'D√¨'];
                    if (!commonWords.includes(char)) {
                        characterCounts[char] = (characterCounts[char] || 0) + 1;
                    }
                });
                
                analyzedData.characters = Object.entries(characterCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15)
                    .map(([name, count]) => ({ name, count }));
                
                // Theme analysis
                const themes = ['t√¨nh y√™u', 'gia ƒë√¨nh', 'd·ª•c v·ªçng', 'lo·∫°n lu√¢n', 'l·ª´a d·ªëi', 'h·ªëi h·∫≠n', 'k·∫ø ho·∫°ch', 'ghen tu√¥ng', 'tr·∫£ th√π', 'phi√™u l∆∞u', 'h√†nh ƒë·ªông', 'k·ª≥ ·∫£o', 'kinh d·ªã', 'gi·∫£ t∆∞·ªüng', 't√¢m l√Ω'];
                analyzedData.themes = themes.map(theme => {
                    const regex = new RegExp(theme, 'gi');
                    const matches = text.match(regex);
                    return {
                        theme,
                        count: matches ? matches.length : 0
                    };
                }).filter(item => item.count > 0);
                
                // Emotion analysis
                const emotions = ['vui m·ª´ng', 't·ª©c gi·∫≠n', 'bu·ªìn b√£', 's·ª£ h√£i', 'kinh ng·∫°c', 'gh√™ t·ªüm', 'h·ªìi h·ªôp', 'ghen t·ªã', 'x√∫c ƒë·ªông', 'c√¥ ƒë∆°n', 'hy v·ªçng', 'th·∫•t v·ªçng'];
                analyzedData.emotions = emotions.map(emotion => {
                    const regex = new RegExp(emotion, 'gi');
                    const matches = text.match(regex);
                    return {
                        emotion,
                        count: matches ? matches.length : 0
                    };
                }).filter(item => item.count > 0);
                
                // Plot points - extract longer sentences that might be important
                const sentences = text.split(/[.!?]+/).filter(s => s.length > 0);
                analyzedData.plotPoints = sentences
                    .filter(s => s.split(' ').length > 8)
                    .slice(0, 10)
                    .map(s => s.trim());
                
                displayAnalysisResults();
            }
            
            function displayAnalysisResults() {
                analysisResult.innerHTML = `
                    ƒê√£ ph√¢n t√≠ch th√†nh c√¥ng!
                    - T√¨m th·∫•y ${analyzedData.characters.length} nh√¢n v·∫≠t ch√≠nh
                    - X√°c ƒë·ªãnh ${analyzedData.themes.length} ch·ªß ƒë·ªÅ
                    - Nh·∫≠n di·ªán ${analyzedData.emotions.length} lo·∫°i c·∫£m x√∫c
                    - Tr√≠ch xu·∫•t ${analyzedData.plotPoints.length} ƒëi·ªÉm c·ªët truy·ªán quan tr·ªçng
                `;
                
                characterGrid.innerHTML = '';
                analyzedData.characters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    card.innerHTML = `<strong>${char.name}</strong> (xu·∫•t hi·ªán ${char.count} l·∫ßn)`;
                    characterGrid.appendChild(card);
                });
                
                themeGrid.innerHTML = '';
                analyzedData.themes.forEach(theme => {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    card.innerHTML = `<strong>${theme.theme}</strong> (xu·∫•t hi·ªán ${theme.count} l·∫ßn)`;
                    themeGrid.appendChild(card);
                });
                
                analyzedData.emotions.forEach(emotion => {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    card.innerHTML = `<strong>${emotion.emotion}</strong> (xu·∫•t hi·ªán ${emotion.count} l·∫ßn)`;
                    themeGrid.appendChild(card);
                });
            }
            
            function generateChapter(title, chapterNum, prompt) {
                // Get main characters
                const mainCharacters = analyzedData.characters
                    .slice(0, 3)
                    .map(c => c.name)
                    .join(', ');
                
                // Get main themes
                const mainThemes = analyzedData.themes
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 2)
                    .map(t => t.theme)
                    .join(', ');
                
                // Get a random plot point
                const randomPlotPoint = analyzedData.plotPoints.length > 0 
                    ? analyzedData.plotPoints[Math.floor(Math.random() * analyzedData.plotPoints.length)]
                    : '';
                
                // Generate chapter content based on analyzed data
                let chapterContent = "";
                
                if (prompt) {
                    chapterContent += `# ${prompt}\n\n`;
                } else {
                    chapterContent += `# Ch∆∞∆°ng ${chapterNum}\n\n`;
                }
                
                chapterContent += `Ti·ªÉu thuy·∫øt: ${title}\n\n`;
                
                if (mainCharacters) {
                    chapterContent += `Trong ch∆∞∆°ng n√†y, ${mainCharacters} ti·∫øp t·ª•c h√†nh tr√¨nh c·ªßa m√¨nh.\n\n`;
                }
                
                if (mainThemes) {
                    chapterContent += `Ch·ªß ƒë·ªÅ ${mainThemes} ƒë∆∞·ª£c kh·∫Øc s√¢u th√¥ng qua c√°c t√¨nh ti·∫øt m·ªõi.\n\n`;
                }
                
                chapterContent += `M·ªü ƒë·∫ßu: ${randomPlotPoint}\n\n`;
                
                // Add content based on previous chapters
                if (currentNovel.chapters.length > 0) {
                    const lastChapter = currentNovel.chapters[currentNovel.chapters.length - 1];
                    chapterContent += `Ti·∫øp n·ªëi: ${lastChapter.content.substring(0, 150)}...\n\n`;
                } else {
                    chapterContent += "T√¨nh ti·∫øt: Nh·ªØng di·ªÖn bi·∫øn b·∫•t ng·ªù x·∫£y ra, l√†m thay ƒë·ªïi c·ª•c di·ªán c√¢u chuy·ªán.\n\n";
                }
                
                chapterContent += "K·∫øt th√∫c ch∆∞∆°ng: M·ªçi chuy·ªán d·∫ßn h√© l·ªô, chu·∫©n b·ªã cho nh·ªØng b∆∞·ªõc ngo·∫∑t l·ªõn trong c√°c ch∆∞∆°ng ti·∫øp theo.";
                
                return chapterContent;
            }
            
            function updateChapterList() {
                chapterList.innerHTML = '';
                currentNovel.chapters.forEach((chapter, index) => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'chapter-item';
                    chapterItem.innerHTML = `<strong>Ch∆∞∆°ng ${chapter.number}</strong>: ${chapter.title}`;
                    chapterItem.addEventListener('click', () => {
                        generatedStory.textContent = `Ch∆∞∆°ng ${chapter.number}: ${chapter.content}`;
                        generatedStory.classList.remove('hidden');
                    });
                    chapterList.appendChild(chapterItem);
                });
            }
            
            function updateNovelSelector() {
                novelSelector.innerHTML = '<option value="">-- Ch·ªçn ti·ªÉu thuy·∫øt --</option>';
                novels.forEach(novel => {
                    const option = document.createElement('option');
                    option.value = novel.title;
                    option.textContent = `${novel.title} (${novel.chapters.length} ch∆∞∆°ng)`;
                    novelSelector.appendChild(option);
                });
            }
            
            function openReader(novel, chapterIndex) {
                currentNovel = novel;
                currentNovel.currentChapter = chapterIndex;
                
                readerView.style.display = 'block';
                displayChapter(novel, chapterIndex);
                
                // Update chapter selector
                readerChapterSelector.innerHTML = '';
                novel.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Ch∆∞∆°ng ${chapter.number}: ${chapter.title}`;
                    if (index === chapterIndex) option.selected = true;
                    readerChapterSelector.appendChild(option);
                });
            }
            
            function displayChapter(novel, chapterIndex) {
                const chapter = novel.chapters[chapterIndex];
                readerContent.innerHTML = `
                    <h1>${novel.title}</h1>
                    <h2>Ch∆∞∆°ng ${chapter.number}: ${chapter.title}</h2>
                    <div style="white-space: pre-line;">${chapter.content}</div>
                `;
                
                // Update selector
                readerChapterSelector.value = chapterIndex;
            }
            
            function updateLearningSystem() {
                const totalChapters = novels.reduce((acc, novel) => acc + novel.chapters.length, 0);
                learningStatus.textContent = `H·ªá th·ªëng ƒë√£ h·ªçc t·ª´ ${novels.length} ti·ªÉu thuy·∫øt v·ªõi t·ªïng c·ªông ${totalChapters} ch∆∞∆°ng.`;
                
                // Display stats
                statsContainer.innerHTML = `
                    <div class="character-card">
                        <strong>T·ªïng s·ªë ti·ªÉu thuy·∫øt:</strong> ${novels.length}
                    </div>
                    <div class="character-card">
                        <strong>T·ªïng s·ªë ch∆∞∆°ng:</strong> ${totalChapters}
                    </div>
                    <div class="character-card">
                        <strong>Ch∆∞∆°ng trung b√¨nh m·ªói ti·ªÉu thuy·∫øt:</strong> ${(totalChapters / novels.length).toFixed(1)}
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
