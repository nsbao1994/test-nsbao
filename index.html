<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Th√™m style cho c·∫£nh b√°o n·ªôi dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* ·∫®n n·ªôi dung nh·∫°y c·∫£m m·∫∑c ƒë·ªãnh */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Style cho t√≠nh nƒÉng ƒë√°nh gi√° */
        .rating-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .rating-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rating-btn.like {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .rating-btn.dislike {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
        }
        
        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Style cho giao di·ªán ƒë·ªçc truy·ªán */
        .reader-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            line-height: 1.8;
            font-size: 18px;
            text-align: justify;
        }
        
        .reader-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .chapter-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Style cho l·ªãch s·ª≠ ƒë·ªçc */
        .reading-history-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-info {
            flex: 1;
        }
        
        .continue-reading-btn {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }
        
        /* C·∫£i ti·∫øn giao di·ªán tr√™n mobile */
        @media (max-width: 768px) {
            .reader-content {
                padding: 15px;
                font-size: 16px;
            }
            
            .rating-section {
                flex-direction: column;
            }
            
            .reader-controls {
                flex-wrap: wrap;
            }
            
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager - B·ªë Ch·ªìng Con D√¢u</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive - Chuy√™n ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úèÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI - Chuy√™n ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¢m l√Ω nh√¢n v·∫≠t:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¨nh hu·ªëng quan h·ªá:</span>
                                <span id="relationshipScenes">0</span>
                            </div>
                            <div class="stat-item">
                                <span>M√¢u thu·∫´n gia ƒë√¨nh:</span>
                                <span id="familyConflicts">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông - B·ªë Ch·ªìng Con D√¢u</h2>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫¢NH B√ÅO: N·ªôi dung 18+ - AI s·∫Ω t·∫°o truy·ªán theo ng√¥i th·ª© nh·∫•t (ng∆∞·ªùi ch·ªìng) k·ªÉ v·ªÅ m·ªëi quan h·ªá gi·ªØa b·ªë ch·ªìng v√† con d√¢u (v·ª£ m√¨nh)
                        </div>
                        
                        <div class="form-group">
                            <label for="storyTheme">Ch·ªçn ch·ªß ƒë·ªÅ ch√≠nh:</label>
                            <select id="storyTheme">
                                <option value="psychological">T√¢m l√Ω - T√¨nh c·∫£m ph·ª©c t·∫°p</option>
                                <option value="forbidden">C·∫•m k·ªµ - M·ªëi quan h·ªá b√≠ m·∫≠t</option>
                                <option value="familyDrama">Gia ƒë√¨nh - M√¢u thu·∫´n n·ªôi t√¢m</option>
                                <option value="emotional">C·∫£m x√∫c - Di·ªÖn bi·∫øn t√¢m tr·∫°ng</option>
                                <option value="fullJourney">H√†nh tr√¨nh ƒë·∫ßy ƒë·ªß t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi</option>
                            </select>
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (10-50)" min="10" max="50" value="20">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi - Ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                    <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                                <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                                <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                            </div>
                           <div class="form-group">
                                <label for="storyContent">N·ªôi dung (k·ªÉ t·ª´ ng√¥i th·ª© nh·∫•t - ng∆∞·ªùi ch·ªìng):</label>
                                <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                            </div>
                            <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üìö L·ªãch s·ª≠ ƒê·ªçc Truy·ªán</h2></div>
                            <div class="history-list" id="readingHistoryList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üóÇ Th∆∞ m·ª•c Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>üìö Truy·ªán ƒê∆∞·ª£c T·∫°o B·ªüi AI - B·ªë Ch·ªìng Con D√¢u</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Ch∆∞∆°ng Truy·ªán</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
                <button class="btn danger" onclick="deleteChapter()">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
                <button class="btn" onclick="saveChapterChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" onclick="cancelEdit()">‚ùå H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Giao di·ªán ƒë·ªçc truy·ªán -->
    <div id="readerMode" class="reader-mode">
        <div class="reader-header">
            <h2 id="readerTitle">Ti√™u ƒë·ªÅ truy·ªán</h2>
            <button class="btn danger" onclick="closeReader()">‚úñ ƒê√≥ng</button>
        </div>
        
        <div class="reader-content" id="readerContent">
            <!-- N·ªôi dung truy·ªán s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
        
        <div class="rating-section" id="ratingSection">
            <p>B·∫°n th·∫•y ch∆∞∆°ng n√†y nh∆∞ th·∫ø n√†o?</p>
            <button class="rating-btn like" onclick="rateChapter(true)">üëç Truy·ªán hay</button>
            <button class="rating-btn dislike" onclick="rateChapter(false)">üëé Truy·ªán ch∆∞a hay</button>
        </div>
        
        <div class="reader-controls">
            <div class="chapter-nav">
                <button class="btn" onclick="navigateChapter(-1)">‚¨Ö Ch∆∞∆°ng tr∆∞·ªõc</button>
                <span id="chapterIndicator">Ch∆∞∆°ng 1/100</span>
                <button class="btn" onclick="navigateChapter(1)">Ch∆∞∆°ng sau ‚û°</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    trainedFiles: 0,
    emotionalPatterns: new Set(),
    relationshipScenes: new Set(),
    familyConflicts: new Set(),
    processedFiles: new Set(),
    // Th√™m d·ªØ li·ªáu chuy√™n bi·ªát cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
    fatherInLawRelations: new Set(),
    daughterInLawRelations: new Set(),
    psychologicalStates: new Set(),
    forbiddenSituations: new Set(),
    // D·ªØ li·ªáu t·ª´ ƒë√°nh gi√°
    goodSentences: new Set(),
    badSentences: new Set(),
    preferredVocabulary: {},
    avoidedVocabulary: {}
};
let aiGeneratedStories = [];
let currentEditingChapter = null;
let currentReadingStory = null;
let currentChapterIndex = 0;
let currentChaptersList = [];
let readingHistory = [];

// T·ª´ v·ª±ng v√† c·∫•u tr√∫c chuy√™n bi·ªát cho ch·ªß ƒë·ªÅ B·ªë Ch·ªìng Con D√¢u
const specializedVocabulary = {
    // Quan h·ªá gia ƒë√¨nh
    familyRelations: ['b·ªë ch·ªìng', 'con d√¢u', 'ch·ªìng', 'v·ª£', 'gia ƒë√¨nh', 'h·ªç h√†ng', 'm·ªëi quan h·ªá', 'ph√©p t·∫Øc', 'ranh gi·ªõi', 'gia ƒë√¨nh v·ª£', 'nh√† ch·ªìng', 'b·ªë m·∫π ch·ªìng'],
    
    // C·∫£m x√∫c v√† t√¢m l√Ω
    emotions: ['cƒÉng th·∫≥ng', 'b·ªëi r·ªëi', 'ghen t·ªã', 't√≤ m√≤', 'lo l·∫Øng', 'th√®m mu·ªën', 'khao kh√°t', 't·ªôi l·ªói', 'x·∫•u h·ªï', 'day d·ª©t', 'd·∫±n v·∫∑t', 'm√¢u thu·∫´n', 'gi·∫±ng x√©', 'ƒëam m√™', 'say ƒë·∫Øm'],
    
    // H√†nh ƒë·ªông v√† t√¨nh hu·ªëng
    actions: ['quan s√°t', 'nh√¨n tr·ªôm', 'theo d√µi', 'ch√∫ √Ω', 'ph√°t hi·ªán', 'ƒë·ªÉ √Ω', 'nh·∫≠n ra', 'th·∫•y ƒë∆∞·ª£c', 'c·∫£m nh·∫≠n', 'ti·∫øp x√∫c', 'va ch·∫°m', 'ch·∫°m nh·∫π', '√¥m', 'h√¥n', 'vu·ªët ve'],
    
    // Suy nghƒ© n·ªôi t√¢m
    innerThoughts: ['t√¥i nghƒ©', 'trong t√¢m tr√≠ t√¥i', 't√¥i t·ª± h·ªèi', 'c√≥ l·∫Ω', 'li·ªáu r·∫±ng', 't√¥i kh√¥ng th·ªÉ tin ƒë∆∞·ª£c', 't√¥i c·∫£m th·∫•y', 't√¥i nh·∫≠n ra', 't√¥i mu·ªën', 't√¥i khao kh√°t'],
    
    // B√≠ m·∫≠t v√† che gi·∫•u
    secretive: ['b√≠ m·∫≠t', 'gi·∫•u k√≠n', 'che gi·∫•u', 'l√©n l√∫t', 'th·∫ßm k√≠n', 'k√≠n ƒë√°o', '√¢m th·∫ßm', 'kh√¥ng ai bi·∫øt', 'sau l∆∞ng', 'v·ª•ng tr·ªôm', 'l√©n l√∫t'],
    
    // M√¥ t·∫£ ngo·∫°i h√¨nh
    physicalDescriptions: ['ƒë√¥i m·∫Øt', 'n·ª• c∆∞·ªùi', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'c√°ch di chuy·ªÉn', 'gi·ªçng n√≥i', 'c√°ch c∆∞·ªùi', 'm√°i t√≥c', 'l√†n da', 'v√≤ng eo', 'c∆° th·ªÉ', 'v·∫ª ƒë·∫πp', 's·ª©c h√∫t'],
    
    // T√¨nh hu·ªëng v√† b·ªëi c·∫£nh
    situations: ['b·ªØa c∆°m gia ƒë√¨nh', 'khi v·ª£ ƒëi v·∫Øng', 'cu·ªëi tu·∫ßn', 'nh·ªØng bu·ªïi t·ªëi', 'l√∫c m·ªôt m√¨nh', 'khi kh√¥ng ai ch√∫ √Ω', 'trong ph√≤ng ng·ªß', 'nh√† t·∫Øm', 'ph√≤ng kh√°ch', 'b·∫øp', 'ban c√¥ng'],
    
    // Y·∫øu t·ªë 18+
    adultElements: ['ham mu·ªën', 'd·ª•c v·ªçng', 'kh√°t khao', 'b√≠ m·∫≠t c·∫•m k·ªã', 'ranh gi·ªõi m·ªù nh·∫°t', 'c√°m d·ªó', 's·ª± quy·∫øn r≈©', 'k√≠ch th√≠ch', 'kho√°i c·∫£m', 'th√¢n th·ªÉ', 'g·ª£i c·∫£m', 'm∆°n tr·ªõn'],
    
    // Thu·∫≠t ng·ªØ t√¢m l√Ω
    psychologicalTerms: ['v√¥ th·ª©c', 'ti·ªÅm th·ª©c', 'b·∫£n nƒÉng', '·ª©c ch·∫ø', 'd·ªìn n√©n', 'ph√≤ng th·ªß', 'ph·ªß nh·∫≠n', 'm·∫∑c c·∫£m', '√°m ·∫£nh', 'd·ª•c v·ªçng', 'ƒëam m√™'],
    
    // T·ª´ chuy·ªÉn ti·∫øp
    transitionWords: ['tuy nhi√™n', 'b√™n c·∫°nh ƒë√≥', 'ngo√†i ra', 'h∆°n n·ªØa', 'ƒë·∫∑c bi·ªát l√†', 'th√™m v√†o ƒë√≥', 'm·∫∑t kh√°c', 'm·ªôt ng√†y n·ªç', 'r·ªìi m·ªôt h√¥m', 'theo th·ªùi gian'],
    
    // T√™n nh√¢n v·∫≠t
    characterNames: ['Minh', 'H∆∞∆°ng', 'Lan', 'H·∫°nh', 'An', 'B√¨nh', 'D≈©ng', 'H·∫£i', 'Ph∆∞∆°ng', 'Th·∫£o', 'Nam', 'Linh', 'Ng·ªçc', 'My'],
    
    // ƒê·ªãa ƒëi·ªÉm
    locations: ['ph√≤ng kh√°ch', 'nh√† b·∫øp', 'ph√≤ng ng·ªß', 'ph√≤ng t·∫Øm', 'ban c√¥ng', 's√¢n v∆∞·ªùn', 'c·∫ßu thang', 'ph√≤ng l√†m vi·ªác', 'ph√≤ng ƒÉn', 'nh√† kho', 'garage'],
    
    // Khung th·ªùi gian
    timeFrames: ['s√°ng s·ªõm', 'bu·ªïi tr∆∞a', 'chi·ªÅu t√†', 'ƒë√™m khuya', 'n·ª≠a ƒë√™m', 'r·∫°ng s√°ng', 'ho√†ng h√¥n', 'cu·ªëi tu·∫ßn', 'ng√†y l·ªÖ', 'k·ª≥ ngh·ªâ', 'd·ªãp T·∫øt']
};

// Danh s√°ch t·ª´ d·ª´ng (stop words) ƒë·ªÉ l·ªçc
const stopWords = new Set(['v√†', 'ho·∫∑c', 'l√†', 'th√¨', 'm√†', 'nh∆∞ng', 'ƒë·ªÉ', 'n√™n', 'v√¨', 'do', 'b·ªüi', 'c·ªßa', 'cho', 'v·ªõi', 't·ª´', 'v√†o', '·ªü', 't·∫°i', 'tr√™n', 'd∆∞·ªõi', 'trong', 'ngo√†i', 'tr∆∞·ªõc', 'sau', 'gi·ªØa', 'c√πng', 'c√°c', 'nh·ªØng', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n', 'm∆∞·ªùi']);

// H√†m kh·ªüi t·∫°o
function init() {
    gapiLoaded();
    gisLoaded();
    setupEventListeners();
    loadReadingHistory();
}

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
    });
    gis_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

function setupEventListeners() {
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    document.getElementById('storyForm').onsubmit = saveStory;
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    document.getElementById('generateStoryButton').onclick = generateAIStory;
    document.getElementById('viewAiStoriesButton').onclick = viewAIStories;
    
    // Menu navigation
    document.getElementById('menuTraining').onclick = () => showSection('trainingSection');
    document.getElementById('menuGeneration').onclick = () => showSection('generationSection');
    document.getElementById('menuManagement').onclick = () => showSection('managementSection');
    document.getElementById('menuHistory').onclick = () => showSection('historySection');
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show the selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Update active menu button
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load data if needed
    if (sectionId === 'historySection') {
        loadStoryHistory();
        loadFolderContents();
    } else if (sectionId === 'managementSection') {
        loadExistingStories();
    }
}

function handleAuthClick() {
    showLoading(true);
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            showStatus('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + resp.error, 'error');
            showLoading(false);
            return;
        }
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        showStatus('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        
        // Load data
        await loadOrCreateMainFolder();
        loadStoryHistory();
        loadAIKnowledge();
        showLoading(false);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showStatus('ƒê√£ ƒëƒÉng xu·∫•t', 'success');
    }
}

async function loadOrCreateMainFolder() {
    showLoading(true);
    try {
        // T√¨m th∆∞ m·ª•c ch√≠nh QuanLyTruyen
        const response = await gapi.client.drive.files.list({
            q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        if (folders.length > 0) {
            mainFolderId = folders[0].id;
            showStatus('ƒê√£ t√¨m th·∫•y th∆∞ m·ª•c QuanLyTruyen', 'success');
        } else {
            // T·∫°o th∆∞ m·ª•c m·ªõi n·∫øu kh√¥ng t√¨m th·∫•y
            const fileMetadata = {
                name: 'QuanLyTruyen',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            const createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            mainFolderId = createResponse.result.id;
            showStatus('ƒê√£ t·∫°o th∆∞ m·ª•c QuanLyTruyen m·ªõi', 'success');
        }
        
    } catch (error) {
        showStatus('L·ªói khi t·∫°o/t√¨m th∆∞ m·ª•c: ' + error.message, 'error');
    }
    showLoading(false);
}

async function saveStory(e) {
    e.preventDefault();
    showLoading(true);
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = mode === 'new' ? document.getElementById('storyTitle').value : document.getElementById('existingStory').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const content = document.getElementById('storyContent').value;
    
    if (!storyTitle || !chapterTitle || !content) {
        showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        showLoading(false);
        return;
    }
    
    try {
        let storyFolderId;
        
        if (mode === 'new') {
            // T·∫°o th∆∞ m·ª•c m·ªõi cho truy·ªán
            const fileMetadata = {
                name: storyTitle,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [mainFolderId]
            };
            
            const folderResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            storyFolderId = folderResponse.result.id;
            
        } else {
            // T√¨m th∆∞ m·ª•c truy·ªán ƒë√£ c√≥
            const response = await gapi.client.drive.files.list({
                q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
                fields: 'files(id, name)'
            });
            
            if (response.result.files.length === 0) {
                showStatus('Kh√¥ng t√¨m th·∫•y truy·ªán', 'error');
                showLoading(false);
                return;
            }
            
            storyFolderId = response.result.files[0].id;
        }
        
        // T·∫°o file ch∆∞∆°ng m·ªõi
        const fileMetadata = {
            name: `${chapterTitle}.txt`,
            parents: [storyFolderId],
            mimeType: 'text/plain'
        };
        
        const contentBlob = new Blob([content], {type: 'text/plain'});
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        formData.append('file', contentBlob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token
            }),
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error.message);
        }
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠
        const existingStoryIndex = storyHistory.findIndex(item => item.title === storyTitle);
        
        if (existingStoryIndex !== -1) {
            // C·∫≠p nh·∫≠t s·ªë ch∆∞∆°ng n·∫øu truy·ªán ƒë√£ t·ªìn t·∫°i
            storyHistory[existingStoryIndex].chapters++;
            storyHistory[existingStoryIndex].date = new Date().toISOString();
            storyHistory[existingStoryIndex].lastChapter = chapterTitle;
        } else {
            // Th√™m m·ªõi v√†o l·ªãch s·ª≠
            storyHistory.unshift({
                title: storyTitle,
                chapters: 1,
                lastChapter: chapterTitle,
                date: new Date().toISOString(),
                folderId: storyFolderId
            });
        }
        
        saveStoryHistory();
        updateAIKnowledge(content, result.id);
        
        showStatus(`ƒê√£ l∆∞u ch∆∞∆°ng "${chapterTitle}" v√†o truy·ªán "${storyTitle}"`, 'success');
        document.getElementById('storyForm').reset();
        
        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch th∆∞ m·ª•c
        loadFolderContents();
        
    } catch (error) {
        showStatus('L·ªói khi l∆∞u truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function saveStoryHistory() {
    localStorage.setItem('storyHistory', JSON.stringify(storyHistory));
    displayStoryHistory();
}

function loadStoryHistory() {
    const savedHistory = localStorage.getItem('storyHistory');
    if (savedHistory) {
        storyHistory = JSON.parse(savedHistory);
    }
    displayStoryHistory();
}

function displayStoryHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    if (storyHistory.length === 0) {
        historyList.innerHTML = '<div class="history-item"><p>Ch∆∞a c√≥ l·ªãch s·ª≠ truy·ªán</p></div>';
        return;
    }
    
    storyHistory.slice(0, 10).forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.onclick = () => viewStory(item.title);
        
        historyItem.innerHTML = `
            <div class="story-title">${item.title}</div>
            <div class="story-chapter">${item.chapters} ch∆∞∆°ng - M·ªõi nh·∫•t: ${item.lastChapter}</div>
            <div class="story-date">C·∫≠p nh·∫≠t: ${new Date(item.date).toLocaleDateString('vi-VN')}</div>
        `;
        
        historyList.appendChild(historyItem);
    });
}

async function loadFolderContents() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime)',
            orderBy: 'createdTime desc'
        });
        
        const folders = response.result.files;
        const folderList = document.getElementById('folderList');
        folderList.innerHTML = '';
        
        if (folders.length === 0) {
            folderList.innerHTML = '<div class="history-item"><p>Ch∆∞a c√≥ th∆∞ m·ª•c truy·ªán</p></div>';
            return;
        }
        
        // L·∫•y th√¥ng tin s·ªë ch∆∞∆°ng cho m·ªói th∆∞ m·ª•c
        for (const folder of folders) {
            try {
                const chaptersResponse = await gapi.client.drive.files.list({
                    q: `'${folder.id}' in parents and mimeType='text/plain' and trashed=false`,
                    fields: 'files(id)'
                });
                
                const chapterCount = chaptersResponse.result.files.length;
                
                const folderItem = document.createElement('div');
                folderItem.className = 'history-item';
                folderItem.onclick = () => viewStory(folder.name);
                
                folderItem.innerHTML = `
                    <div class="story-title">${folder.name}</div>
                    <div class="story-chapter">${chapterCount} ch∆∞∆°ng</div>
                    <div class="story-date">T·∫°o ng√†y: ${new Date(folder.createdTime).toLocaleDateString('vi-VN')}</div>
                `;
                
                folderList.appendChild(folderItem);
            } catch (error) {
                console.error('L·ªói khi t·∫£i th√¥ng tin th∆∞ m·ª•c:', folder.name, error);
            }
        }
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch th∆∞ m·ª•c:', error);
    }
}

async function viewStory(storyTitle) {
    showLoading(true);
    
    try {
        // T√¨m th∆∞ m·ª•c truy·ªán
        const response = await gapi.client.drive.files.list({
            q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length === 0) {
            showStatus('Kh√¥ng t√¨m th·∫•y truy·ªán', 'error');
            showLoading(false);
            return;
        }
        
        const storyFolderId = response.result.files[0].id;
        
        // L·∫•y danh s√°ch ch∆∞∆°ng
        const chaptersResponse = await gapi.client.drive.files.list({
            q: `'${storyFolderId}' in parents and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = chaptersResponse.result.files;
        
        // M·ªü tr√¨nh ƒë·ªçc truy·ªán
        openReader(storyTitle, chapters, 0);
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

async function loadChapterContent(chapterId, chapterTitle, storyTitle) {
    showLoading(true);
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapterId,
            alt: 'media'
        });
        
        const content = response.body;
        
        document.getElementById('chapterList').style.display = 'none';
        document.getElementById('chapterContent').style.display = 'block';
        document.getElementById('chapterContent').textContent = content;
        document.getElementById('chapterActions').style.display = 'flex';
        
        // L∆∞u th√¥ng tin ch∆∞∆°ng ƒëang xem
        currentEditingChapter = {
            id: chapterId,
            title: chapterTitle,
            storyTitle: storyTitle,
            content: content
        };
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function editChapter() {
    const contentDiv = document.getElementById('chapterContent');
    const currentContent = contentDiv.textContent;
    
    contentDiv.innerHTML = `<textarea id="editChapterContent" style="width: 100%; height: 400px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 15px;">${currentContent}</textarea>`;
}

async function saveChapterChanges() {
    showLoading(true);
    
    try {
        const editedContent = document.getElementById('editChapterContent').value;
        
        // C·∫≠p nh·∫≠t file tr√™n Google Drive
        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'text/plain'
            }),
            body: editedContent
        });
        
        if (!response.ok) {
            throw new Error('L·ªói khi l∆∞u thay ƒë·ªïi');
        }
        
        // C·∫≠p nh·∫≠t n·ªôi dung hi·ªÉn th·ªã
        document.getElementById('chapterContent').innerHTML = '';
        document.getElementById('chapterContent').textContent = editedContent;
        
        showStatus('ƒê√£ l∆∞u thay ƒë·ªïi', 'success');
        
        // C·∫≠p nh·∫≠t l·∫°i knowledge base
        updateAIKnowledge(editedContent, currentEditingChapter.id);
        
    } catch (error) {
        showStatus('L·ªói khi l∆∞u thay ƒë·ªïi: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function cancelEdit() {
    document.getElementById('chapterContent').innerHTML = '';
    document.getElementById('chapterContent').textContent = currentEditingChapter.content;
}

async function deleteChapter() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y?')) return;
    
    showLoading(true);
    
    try {
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        showStatus('ƒê√£ x√≥a ch∆∞∆°ng', 'success');
        closeModal('chaptersModal');
        
        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch th∆∞ m·ª•c
        loadFolderContents();
        
    } catch (error) {
        showStatus('L·ªói khi x√≥a ch∆∞∆°ng: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Reset modal state
    if (modalId === 'chaptersModal') {
        document.getElementById('chapterList').style.display = 'block';
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'L∆∞u Truy·ªán M·ªõi';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Th√™m Ch∆∞∆°ng M·ªõi';
        loadExistingStories();
    }
}

async function loadExistingStories() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        const select = document.getElementById('existingStory');
        select.innerHTML = '<option value="">-- Ch·ªçn truy·ªán --</option>';
        
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.name;
            option.textContent = folder.name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch truy·ªán:', error);
    }
}

function updateAIKnowledge(content, fileId) {
    // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
    if (fileId && aiKnowledge.processedFiles.has(fileId)) {
        return; // B·ªè qua n·∫øu ƒë√£ x·ª≠ l√Ω
    }
    
    // ƒê√°nh d·∫•u file ƒë√£ x·ª≠ l√Ω
    if (fileId) {
        aiKnowledge.processedFiles.add(fileId);
    }
    
    // Ph√¢n t√≠ch n·ªôi dung ƒë·ªÉ c·∫≠p nh·∫≠t ki·∫øn th·ª©c cho AI
    const words = content.split(/\s+/);
    words.forEach(word => {
        if (word.length > 3) {
            aiKnowledge.vocabulary.add(word.toLowerCase());
        }
    });
    
    // Ph√¢n t√≠ch c√¢u
    const sentences = content.split(/[.!?]+/);
    aiKnowledge.trainedFiles += sentences.length;
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Ph√¢n t√≠ch t·ª´ kh√≥a c·∫£m x√∫c
            specializedVocabulary.emotions.forEach(emotion => {
                if (sentence.toLowerCase().includes(emotion)) {
                    aiKnowledge.emotionalPatterns.add(emotion);
                }
            });
            
            // Ph√¢n t√≠ch quan h·ªá b·ªë ch·ªìng - con d√¢u
            if (sentence.toLowerCase().includes('b·ªë ch·ªìng') || sentence.toLowerCase().includes('con d√¢u')) {
                aiKnowledge.fatherInLawRelations.add(sentence.trim());
            }
            
            // Ph√¢n t√≠ch t√¨nh hu·ªëng c·∫•m k·ªµ
            specializedVocabulary.adultElements.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.forbiddenSituations.add(sentence.trim());
                }
            });
            
            // Ph√¢n t√≠ch m√¢u thu·∫´n gia ƒë√¨nh
            if (sentence.toLowerCase().includes('gia ƒë√¨nh') || sentence.toLowerCase().includes('m√¢u thu·∫´n') || 
                sentence.toLowerCase().includes('xung ƒë·ªôt')) {
                aiKnowledge.familyConflicts.add(sentence.trim());
            }
            
            // Ph√¢n t√≠ch t√¢m l√Ω nh√¢n v·∫≠t
            specializedVocabulary.psychologicalTerms.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.psychologicalStates.add(sentence.trim());
                }
            });
        }
    });
    
    // L∆∞u ki·∫øn th·ª©c AI
    saveAIKnowledge();
    updateAIStats();
}

function saveAIKnowledge() {
    // Chuy·ªÉn Set th√†nh Array ƒë·ªÉ l∆∞u tr·ªØ
    const knowledgeToSave = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        trainedFiles: aiKnowledge.trainedFiles,
        emotionalPatterns: Array.from(aiKnowledge.emotionalPatterns),
        relationshipScenes: Array.from(aiKnowledge.relationshipScenes),
        familyConflicts: Array.from(aiKnowledge.familyConflicts),
        processedFiles: Array.from(aiKnowledge.processedFiles),
        fatherInLawRelations: Array.from(aiKnowledge.fatherInLawRelations),
        daughterInLawRelations: Array.from(aiKnowledge.daughterInLawRelations),
        psychologicalStates: Array.from(aiKnowledge.psychologicalStates),
        forbiddenSituations: Array.from(aiKnowledge.forbiddenSituations),
        // Th√™m d·ªØ li·ªáu m·ªõi
        goodSentences: aiKnowledge.goodSentences ? Array.from(aiKnowledge.goodSentences) : [],
        badSentences: aiKnowledge.badSentences ? Array.from(aiKnowledge.badSentences) : [],
        preferredVocabulary: aiKnowledge.preferredVocabulary || {},
        avoidedVocabulary: aiKnowledge.avoidedVocabulary || {}
    };
    
    localStorage.setItem('aiKnowledge', JSON.stringify(knowledgeToSave));
}

function loadAIKnowledge() {
    const savedKnowledge = localStorage.getItem('aiKnowledge');
    if (savedKnowledge) {
        const parsedKnowledge = JSON.parse(savedKnowledge);
        
        // Kh√¥i ph·ª•c c√°c Set t·ª´ Array
        aiKnowledge.vocabulary = new Set(parsedKnowledge.vocabulary || []);
        aiKnowledge.trainedFiles = parsedKnowledge.trainedFiles || 0;
        aiKnowledge.emotionalPatterns = new Set(parsedKnowledge.emotionalPatterns || []);
        aiKnowledge.relationshipScenes = new Set(parsedKnowledge.relationshipScenes || []);
        aiKnowledge.familyConflicts = new Set(parsedKnowledge.familyConflicts || []);
        aiKnowledge.processedFiles = new Set(parsedKnowledge.processedFiles || []);
        aiKnowledge.fatherInLawRelations = new Set(parsedKnowledge.fatherInLawRelations || []);
        aiKnowledge.daughterInLawRelations = new Set(parsedKnowledge.daughterInLawRelations || []);
        aiKnowledge.psychologicalStates = new Set(parsedKnowledge.psychologicalStates || []);
        aiKnowledge.forbiddenSituations = new Set(parsedKnowledge.forbiddenSituations || []);
        
        // Kh√¥i ph·ª•c d·ªØ li·ªáu m·ªõi
        aiKnowledge.goodSentences = new Set(parsedKnowledge.goodSentences || []);
        aiKnowledge.badSentences = new Set(parsedKnowledge.badSentences || []);
        aiKnowledge.preferredVocabulary = parsedKnowledge.preferredVocabulary || {};
        aiKnowledge.avoidedVocabulary = parsedKnowledge.avoidedVocabulary || {};
    }
    updateAIStats();
}

function updateAIStats() {
    document.getElementById('totalFiles').textContent = aiKnowledge.processedFiles.size;
    document.getElementById('trainedFiles').textContent = aiKnowledge.trainedFiles;
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('emotionalPatterns').textContent = aiKnowledge.emotionalPatterns.size;
    document.getElementById('relationshipScenes').textContent = aiKnowledge.relationshipScenes.size;
    document.getElementById('familyConflicts').textContent = aiKnowledge.familyConflicts.size;
    
    // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
    const progress = Math.min(100, (aiKnowledge.processedFiles.size / 500) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
}

async function trainAI() {
    showLoading(true);
    
    try {
        // Thu th·∫≠p t·∫•t c·∫£ n·ªôi dung t·ª´ c√°c truy·ªán ƒë√£ l∆∞u ƒë·ªÉ hu·∫•n luy·ªán AI
        if (!mainFolderId) {
            showStatus('Ch∆∞a c√≥ th∆∞ m·ª•c ch√≠nh', 'error');
            showLoading(false);
            return;
        }
        
        // L·∫•y danh s√°ch t·∫•t c·∫£ file .txt trong th∆∞ m·ª•c QuanLyTruyen v√† c√°c th∆∞ m·ª•c con
        const response = await gapi.client.drive.files.list({
            q: `('${mainFolderId}' in parents or parents in '${mainFolderId}') and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, parents)',
            pageSize: 1000
        });
        
        const textFiles = response.result.files;
        let processedCount = 0;
        let skippedCount = 0;
        
        document.getElementById('progressFill').style.width = '0%';
        
        for (const file of textFiles) {
            // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
            if (aiKnowledge.processedFiles.has(file.id)) {
                skippedCount++;
                continue;
            }
            
            try {
                // ƒê·ªçc n·ªôi dung file
                const contentResponse = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });
                
                const content = contentResponse.body;
                
                // C·∫≠p nh·∫≠t ki·∫øn th·ª©c AI t·ª´ n·ªôi dung
                updateAIKnowledge(content, file.id);
                processedCount++;
                
                // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
                const progress = Math.floor((processedCount / textFiles.length) * 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω file:', file.name, error);
            }
        }
        
        showStatus(`ƒê√£ hu·∫•n luy·ªán AI v·ªõi ${processedCount} file m·ªõi (${skippedCount} file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω tr∆∞·ªõc ƒë√≥)`, 'success');
        
    } catch (error) {
        showStatus('L·ªói khi hu·∫•n luy·ªán AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function resetAI() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô ki·∫øn th·ª©c c·ªßa AI? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        aiKnowledge = {
            vocabulary: new Set(),
            trainedFiles: 0,
            emotionalPatterns: new Set(),
            relationshipScenes: new Set(),
            familyConflicts: new Set(),
            processedFiles: new Set(),
            fatherInLawRelations: new Set(),
            daughterInLawRelations: new Set(),
            psychologicalStates: new Set(),
            forbiddenSituations: new Set(),
            goodSentences: new Set(),
            badSentences: new Set(),
            preferredVocabulary: {},
            avoidedVocabulary: {}
        };
        
        localStorage.removeItem('aiKnowledge');
        updateAIStats();
        showStatus('ƒê√£ reset ki·∫øn th·ª©c AI', 'success');
    }
}

async function generateAIStory() {
    showLoading(true);
    
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 20;
    const storyTheme = document.getElementById('storyTheme').value;
    
    if (chapterCount < 10 || chapterCount > 50) {
        showStatus('S·ªë ch∆∞∆°ng ph·∫£i t·ª´ 10 ƒë·∫øn 50', 'error');
        showLoading(false);
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán ƒë·ªß. Vui l√≤ng hu·∫•n luy·ªán AI tr∆∞·ªõc.', 'error');
        showLoading(false);
        return;
    }
    
    try {
        // T·∫°o th∆∞ m·ª•c m·ªõi cho truy·ªán AI
        const storyTitle = `B·ªë Ch·ªìng Con D√¢u - ${new Date().toLocaleDateString('vi-VN')}`;
        const fileMetadata = {
            name: storyTitle,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [mainFolderId]
        };
        
        const folderResponse = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        
        const storyFolderId = folderResponse.result.id;
        
        // T·∫°o c√°c ch∆∞∆°ng
        let progress = 0;
        document.getElementById('generationProgressFill').style.width = '0%';
        document.getElementById('generationStatus').innerHTML = '<div class="status info">ƒêang t·∫°o truy·ªán... 0%</div>';
        
        for (let i = 1; i <= chapterCount; i++) {
            const chapterTitle = `Ch∆∞∆°ng ${i}: ${generateChapterTitle(i, storyTheme)}`;
            const chapterContent = generateChapterContent(i, chapterCount, storyTheme);
            
            const fileMetadata = {
                name: `${chapterTitle}.txt`,
                parents: [storyFolderId],
                mimeType: 'text/plain'
            };
            
            const contentBlob = new Blob([chapterContent], {type: 'text/plain'});
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            formData.append('file', contentBlob);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                }),
                body: formData
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error.message);
            }
            
            // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
            progress = Math.floor((i / chapterCount) * 100);
            document.getElementById('generationProgressFill').style.width = `${progress}%`;
            document.getElementById('generationStatus').innerHTML = `<div class="status info">ƒêang t·∫°o truy·ªán... ${progress}%</div>`;
            
            // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // L∆∞u th√¥ng tin truy·ªán AI
        aiGeneratedStories.push({
            title: storyTitle,
            chapters: chapterCount,
            date: new Date().toISOString(),
            folderId: storyFolderId
        });
        
        saveAIGeneratedStories();
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠
        storyHistory.unshift({
            title: storyTitle,
            chapters: chapterCount,
            lastChapter: `Ch∆∞∆°ng ${chapterCount}`,
            date: new Date().toISOString(),
            folderId: storyFolderId
        });
        
        saveStoryHistory();
        
        showStatus(`ƒê√£ t·∫°o th√†nh c√¥ng truy·ªán "${storyTitle}" v·ªõi ${chapterCount} ch∆∞∆°ng`, 'success');
        document.getElementById('generationStatus').innerHTML = '';
        
        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch th∆∞ m·ª•c
        loadFolderContents();
        
    } catch (error) {
        showStatus('L·ªói khi t·∫°o truy·ªán AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function generateChapterTitle(chapterNumber, theme) {
    const titles = {
        psychological: [
            "Nh·ªØng Rung ƒê·ªông ƒê·∫ßu Ti√™n",
            "C·∫£m X√∫c M√¢u Thu·∫´n",
            "√Ånh M·∫Øt Kh√≥ T·∫£",
            "Kho·∫£nh Kh·∫Øc V·ª•ng Tr·ªôm",
            "Day D·ª©t N·ªôi T√¢m",
            "Gi·∫±ng X√© Tr√°i Tim",
            "Nh·∫≠n Ra S·ª± Th·∫≠t",
            "B√≠ M·∫≠t Kh√≥ N√≥i",
            "Nh·ªØng Suy Nghƒ© Khuya",
            "L·ªùi Th√∫ Nh·∫≠n Tr·ªÖ M√†ng"
        ],
        forbidden: [
            "Ranh Gi·ªõi Mong Manh",
            "C·ª≠ Ch·ªâ V∆∞·ª£t Qu√°",
            "Nh·ªØng L·∫ßn ƒê·∫ßu Ti√™n",
            "S·ª± C√°m D·ªó Kh√≥ C∆∞·ª°ng",
            "B√≠ M·∫≠t ƒê√™m Khuya",
            "N∆°i Kh√¥ng √Ånh S√°ng",
            "Kho·∫£nh Kh·∫Øc T·ªôi L·ªói",
            "V∆∞·ª£t Qua L·∫±n Ranh",
            "Nh·ªØng ƒêi·ªÅu C·∫•m K·ªµ",
            "H∆∞∆°ng V·ªã T·ªôi L·ªói"
        ],
        familyDrama: [
            "B·ªØa C∆°m Gia ƒê√¨nh",
            "M√¢u Thu·∫´n B√πng N·ªï",
            "√Ånh M·∫Øt D√≤ X√©t",
            "Nh·ªØng L·ªùi ƒê·ªìn ƒê·∫°i",
            "S·ª± Th·∫≠t Ph≈© Ph√†ng",
            "L·ª±a Ch·ªçn Kh√≥ KhƒÉn",
            "Gia ƒê√¨nh Tan V·ª°",
            "N∆∞·ªõc M·∫Øt √Çm Th·∫ßm",
            "Quy·∫øt ƒê·ªãnh Cu·ªëi C√πng",
            "H·∫≠u Qu·∫£ Kh√¥n L∆∞·ªùng"
        ],
        emotional: [
            "C·∫£m X√∫c D√¢ng Tr√†o",
            "Tr√°i Tim Rung ƒê·ªông",
            "N·ªói Nh·ªõ Kh√¥n Ngu√¥i",
            "Nh·ªØng ƒê√™m Thao Th·ª©c",
            "T√¨nh Y√™u V·ª•ng Tr·ªôm",
            "Gi·ªçt N∆∞·ªõc M·∫Øt Mu·ªôn M√†ng",
            "Tr√°i Tim Tan V·ª°",
            "H·∫°nh Ph√∫c Mong Manh",
            "N·ªói ƒêau Kh√¥ng L·ªùi",
            "T√¨nh Y√™u Vƒ©nh C·ª≠u"
        ],
        fullJourney: [
            "Kh·ªüi ƒê·∫ßu B·∫•t Ng·ªù",
            "Nh·ªØng Ti·∫øp X√∫c ƒê·∫ßu Ti√™n",
            "C·∫£m X√∫c Ch·ªõm N·ªü",
            "Th·ª≠ Th√°ch ƒê·∫ßu Ti√™n",
            "B∆∞·ªõc Ngo·∫∑t L·ªõn",
            "Giai ƒêo·∫°n Chuy·ªÉn M√¨nh",
            "ƒê·ªânh Cao C·∫£m X√∫c",
            "Bi·∫øn C·ªë B·∫•t Ng·ªù",
            "Giai ƒêo·∫°n Quy·∫øt ƒê·ªãnh",
            "K·∫øt Th√∫c Kh√≥ Qu√™n"
        ]
    };
    
    const themeTitles = titles[theme] || titles.psychological;
    return themeTitles[chapterNumber % themeTitles.length];
}

function generateChapterContent(chapterNumber, totalChapters, theme) {
    // T·∫°o n·ªôi dung ch∆∞∆°ng v·ªõi ch·∫•t l∆∞·ª£ng cao h∆°n d·ª±a tr√™n ƒë√°nh gi√°
    let content = `Ch∆∞∆°ng ${chapterNumber}: ${generateChapterTitle(chapterNumber, theme)}\n\n`;
    
    // S·ª≠ d·ª•ng t·ª´ v·ª±ng ∆∞u ti√™n n·∫øu c√≥
    const vocabulary = aiKnowledge.preferredVocabulary ? 
        Object.keys(aiKnowledge.preferredVocabulary) : 
        Array.from(aiKnowledge.vocabulary);
    
    // Tr·ªçng s·ªë t·ª´ v·ª±ng ∆∞u ti√™n
    const vocabWeights = aiKnowledge.preferredVocabulary ? 
        Object.values(aiKnowledge.preferredVocabulary) : 
        Array(vocabulary.length).fill(1);
    
    // T·∫°o c√°c ƒëo·∫°n vƒÉn v·ªõi ch·∫•t l∆∞·ª£ng cao h∆°n
    const paragraphCount = 5 + Math.floor(Math.random() * 4); // 5-8 ƒëo·∫°n
    
    for (let i = 0; i < paragraphCount; i++) {
        const sentenceCount = 3 + Math.floor(Math.random() * 3); // 3-5 c√¢u m·ªói ƒëo·∫°n
        
        for (let j = 0; j < sentenceCount; j++) {
            const sentenceLength = 7 + Math.floor(Math.random() * 8); // 7-14 t·ª´ m·ªói c√¢u
            let sentence = '';
            
            // B·∫Øt ƒë·∫ßu c√¢u v·ªõi ng√¥i th·ª© nh·∫•t
            const firstPersonStarters = [
                "T√¥i nh·∫≠n th·∫•y ", "T√¥i c·∫£m th·∫•y ", "T√¥i nh·ªõ l·∫°i ", "T√¥i kh√¥ng th·ªÉ ", 
                "T√¥i nh·∫≠n ra ", "T√¥i mu·ªën ", "T√¥i khao kh√°t ", "T√¥i th·∫•y ", 
                "ƒê·ªëi v·ªõi t√¥i, ", "Trong m·∫Øt t√¥i, ", "T√¥i nghƒ© ", "T√¥i tin "
            ];
            
            sentence += firstPersonStarters[Math.floor(Math.random() * firstPersonStarters.length)];
            
            // T·∫°o c√¢u v·ªõi t·ª´ v·ª±ng c√≥ tr·ªçng s·ªë
            for (let k = 0; k < sentenceLength; k++) {
                // Ch·ªçn t·ª´ ng·∫´u nhi√™n v·ªõi tr·ªçng s·ªë
                let randomIndex = 0;
                if (vocabWeights.length > 0) {
                    const totalWeight = vocabWeights.reduce((a, b) => a + b, 0);
                    let randomValue = Math.random() * totalWeight;
                    
                    for (let w = 0; w < vocabWeights.length; w++) {
                        randomValue -= vocabWeights[w];
                        if (randomValue <= 0) {
                            randomIndex = w;
                            break;
                        }
                    }
                } else {
                    randomIndex = Math.floor(Math.random() * vocabulary.length);
                }
                
                sentence += vocabulary[randomIndex] + ' ';
            }
            
            content += sentence + '. ';
        }
        
        content += '\n\n';
    }
    
    // Th√™m c√°c y·∫øu t·ªë ƒë·∫∑c tr∆∞ng c·ªßa ch·ªß ƒë·ªÅ
    content += addThemeSpecificContent(theme, chapterNumber, totalChapters);
    
    return content;
}

function addThemeSpecificContent(theme, chapterNumber, totalChapters) {
    let additionalContent = "\n";
    
    switch(theme) {
        case "psychological":
            additionalContent += "T√¥i c·∫£m th·∫•y m√¢u thu·∫´n trong l√≤ng. M·ªôt ph·∫ßn trong t√¥i khao kh√°t ƒë∆∞·ª£c g·∫ßn g≈©i, nh∆∞ng ph·∫ßn kh√°c l·∫°i c·∫£m th·∫•y t·ªôi l·ªói v√¥ c√πng. √Ånh m·∫Øt c·ªßa b·ªë khi nh√¨n v·ª£ t√¥i khi·∫øn tim t√¥i ƒëau nh√≥i, nh∆∞ng ƒë·ªìng th·ªùi c≈©ng k√≠ch th√≠ch s·ª± t√≤ m√≤ kh√¥ng d·ª©t.\n";
            break;
            
        case "forbidden":
            additionalContent += "ƒê√™m ƒë√≥, khi th·∫•y b·ªë v√† v·ª£ t√¥i ·ªü g·∫ßn nhau trong b·∫øp, t√¥i bi·∫øt m√¨nh kh√¥ng th·ªÉ l√†m ng∆° ƒë∆∞·ª£c n·ªØa. Nh·ªØng c·ª≠ ch·ªâ th√¢n m·∫≠t qu√° m·ª©c, nh·ªØng c√°i ch·∫°m tay k√©o d√†i... T·∫•t c·∫£ ƒë·ªÅu v∆∞·ª£t qua ranh gi·ªõi c·ªßa m·ªôt m·ªëi quan h·ªá b·ªë ch·ªìng-con d√¢u th√¥ng th∆∞·ªùng.\n";
            break;
            
        case "familyDrama":
            additionalContent += "B·ªØa c∆°m gia ƒë√¨nh h√¥m ƒë√≥ th·∫≠t cƒÉng th·∫≥ng. M·∫π t√¥i c√≥ v·∫ª ƒë√£ nh·∫≠n ra ƒëi·ªÅu g√¨ ƒë√≥ b·∫•t ·ªïn. √Ånh m·∫Øt b√† li·∫øc nh√¨n b·ªë r·ªìi l·∫°i nh√¨n v·ª£ t√¥i ƒë·∫ßy nghi ng·ªù. T√¥i bi·∫øt m·ªçi chuy·ªán s·∫Øp v·ª° l·∫Ω, nh∆∞ng kh√¥ng bi·∫øt ph·∫£i l√†m sao.\n";
            break;
            
        case "emotional":
            additionalContent += "Tr√°i tim t√¥i nh∆∞ mu·ªën nh·∫£y ra kh·ªèi l·ªìng ng·ª±c m·ªói khi th·∫•y h·ªç c√πng nhau. C√≥ nh·ªØng l√∫c t√¥i ghen t·ªã, nh·ªØng l√∫c l·∫°i c·∫£m th·∫•y h·∫°nh ph√∫c l·∫° k·ª≥. C·∫£m x√∫c c·ªßa t√¥i nh∆∞ m·ªôt m·ªõ h·ªón ƒë·ªôn kh√¥ng th·ªÉ g·ª° r·ªëi.\n";
            break;
            
        case "fullJourney":
            // T·∫°o n·ªôi dung ph√π h·ª£p v·ªõi v·ªã tr√≠ ch∆∞∆°ng trong c·ªët truy·ªán
            if (chapterNumber <= totalChapters * 0.3) {
                additionalContent += "L√∫c ƒë·∫ßu, t√¥i ch·ªâ nghƒ© ƒë√≥ l√† s·ª± quan t√¢m b√¨nh th∆∞·ªùng c·ªßa m·ªôt ng∆∞·ªùi b·ªë ch·ªìng d√†nh cho con d√¢u. Nh∆∞ng d·∫ßn d√†, t√¥i nh·∫≠n ra c√≥ ƒëi·ªÅu g√¨ ƒë√≥ kh√°c l·∫° trong c√°ch h·ªç nh√¨n nhau.\n";
            } else if (chapterNumber <= totalChapters * 0.7) {
                additionalContent += "M·ªçi chuy·ªán ng√†y c√†ng v∆∞·ª£t qu√° t·∫ßm ki·ªÉm so√°t. Nh·ªØng cu·ªôc g·∫∑p g·ª° b√≠ m·∫≠t, nh·ªØng tin nh·∫Øn ƒë√™m khuya... T√¥i bi·∫øt m√¨nh n√™n ngƒÉn c·∫£n, nh∆∞ng m·ªôt ph·∫ßn trong t√¥i l·∫°i mu·ªën m·ªçi chuy·ªán ti·∫øp di·ªÖn.\n";
            } else {
                additionalContent += "Gi·ªù ƒë√¢y, khi m·ªçi chuy·ªán ƒë√£ v·ª° l·∫Ω, t√¥i kh√¥ng bi·∫øt ph·∫£i ƒë·ªëi m·∫∑t v·ªõi gia ƒë√¨nh th·∫ø n√†o. S·ª± th·∫≠t ph≈© ph√†ng khi·∫øn t√¥i ƒëau ƒë·ªõn, nh∆∞ng c≈©ng gi·∫£i t·ªèa ƒë∆∞·ª£c g√°nh n·∫∑ng trong l√≤ng.\n";
            }
            break;
    }
    
    return additionalContent;
}

function saveAIGeneratedStories() {
    localStorage.setItem('aiGeneratedStories', JSON.stringify(aiGeneratedStories));
}

function loadAIGeneratedStories() {
    const savedStories = localStorage.getItem('aiGeneratedStories');
    if (savedStories) {
        aiGeneratedStories = JSON.parse(savedStories);
    }
}

async function viewAIStories() {
    loadAIGeneratedStories();
    
    const aiStoryList = document.getElementById('aiStoryList');
    aiStoryList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        aiStoryList.innerHTML = '<div class="chapter-item">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o b·ªüi AI</div>';
    } else {
        aiGeneratedStories.forEach(story => {
            const storyItem = document.createElement('div');
            storyItem.className = 'chapter-item';
            storyItem.onclick = () => viewStory(story.title);
            
            storyItem.innerHTML = `
                <div class="story-title">${story.title}</div>
                <div class="story-chapter">${story.chapters} ch∆∞∆°ng</div>
                <div class="story-date">${new Date(story.date).toLocaleDateString('vi-VN')}</div>
            `;
            
            aiStoryList.appendChild(storyItem);
        });
    }
    
    openModal('aiStoriesModal');
}

// H√†m t·∫£i l·ªãch s·ª≠ ƒë·ªçc
function loadReadingHistory() {
    const savedHistory = localStorage.getItem('readingHistory');
    if (savedHistory) {
        readingHistory = JSON.parse(savedHistory);
        displayReadingHistory();
    }
}

// Hi·ªÉn th·ªã l·ªãch s·ª≠ ƒë·ªçc
function displayReadingHistory() {
    const historyList = document.getElementById('readingHistoryList');
    historyList.innerHTML = '';
    
    if (readingHistory.length === 0) {
        historyList.innerHTML = '<div class="history-item"><p>Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·ªçc</p></div>';
        return;
    }
    
    // S·∫Øp x·∫øp theo th·ªùi gian ƒë·ªçc g·∫ßn nh·∫•t
    readingHistory.sort((a, b) => new Date(b.lastRead) - new Date(a.lastRead));
    
    readingHistory.slice(0, 10).forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'reading-history-item';
        
        historyItem.innerHTML = `
            <div class="history-info">
                <div class="story-title">${item.storyTitle}</div>
                <div class="story-chapter">ƒê·ªçc ƒë·∫øn: ${item.chapterTitle}</div>
                <div class="story-date">L·∫ßn cu·ªëi: ${new Date(item.lastRead).toLocaleDateString('vi-VN')}</div>
            </div>
            <button class="continue-reading-btn" onclick="continueReading('${item.storyTitle}', '${item.chapterId}')">
                ƒê·ªçc ti·∫øp
            </button>
        `;
        
        historyList.appendChild(historyItem);
    });
}

// H√†m ti·∫øp t·ª•c ƒë·ªçc t·ª´ l·ªãch s·ª≠
async function continueReading(storyTitle, chapterId) {
    showLoading(true);
    
    try {
        // T√¨m th∆∞ m·ª•c truy·ªán
        const response = await gapi.client.drive.files.list({
            q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length === 0) {
            showStatus('Kh√¥ng t√¨m th·∫•y truy·ªán', 'error');
            showLoading(false);
            return;
        }
        
        const storyFolderId = response.result.files[0].id;
        
        // L·∫•y danh s√°ch ch∆∞∆°ng
        const chaptersResponse = await gapi.client.drive.files.list({
            q: `'${storyFolderId}' in parents and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = chaptersResponse.result.files;
        
        // T√¨m index c·ªßa ch∆∞∆°ng ƒëang ƒë·ªçc
        const chapterIndex = chapters.findIndex(ch => ch.id === chapterId);
        
        if (chapterIndex === -1) {
            showStatus('Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng', 'error');
            showLoading(false);
            return;
        }
        
        // M·ªü tr√¨nh ƒë·ªçc
        openReader(storyTitle, chapters, chapterIndex);
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

// M·ªü tr√¨nh ƒë·ªçc truy·ªán
async function openReader(storyTitle, chapters, startIndex = 0) {
    currentReadingStory = storyTitle;
    currentChaptersList = chapters;
    currentChapterIndex = startIndex;
    
    // Hi·ªÉn th·ªã th√¥ng tin ch∆∞∆°ng
    document.getElementById('readerTitle').textContent = `${storyTitle} - ${chapters[startIndex].name.replace('.txt', '')}`;
    document.getElementById('chapterIndicator').textContent = `Ch∆∞∆°ng ${startIndex + 1}/${chapters.length}`;
    
    // T·∫£i n·ªôi dung ch∆∞∆°ng
    showLoading(true);
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapters[startIndex].id,
            alt: 'media'
        });
        
        document.getElementById('readerContent').textContent = response.body;
        document.getElementById('readerMode').style.display = 'block';
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠ ƒë·ªçc
        updateReadingHistory(storyTitle, chapters[startIndex].id, chapters[startIndex].name.replace('.txt', ''));
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng: ' + error.message, 'error');
    }
    showLoading(false);
}

// ƒê√≥ng tr√¨nh ƒë·ªçc
function closeReader() {
    document.getElementById('readerMode').style.display = 'none';
    currentReadingStory = null;
    currentChaptersList = [];
    currentChapterIndex = 0;
}

// Chuy·ªÉn ch∆∞∆°ng
async function navigateChapter(direction) {
    const newIndex = currentChapterIndex + direction;
    
    if (newIndex < 0 || newIndex >= currentChaptersList.length) {
        return; // Kh√¥ng cho ph√©p v∆∞·ª£t qu√° gi·ªõi h·∫°n
    }
    
    currentChapterIndex = newIndex;
    const chapter = currentChaptersList[newIndex];
    
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
    document.getElementById('readerTitle').textContent = `${currentReadingStory} - ${chapter.name.replace('.txt', '')}`;
    document.getElementById('chapterIndicator').textContent = `Ch∆∞∆°ng ${newIndex + 1}/${currentChaptersList.length}`;
    
    // T·∫£i n·ªôi dung ch∆∞∆°ng m·ªõi
    showLoading(true);
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapter.id,
            alt: 'media'
        });
        
        document.getElementById('readerContent').textContent = response.body;
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠ ƒë·ªçc
        updateReadingHistory(currentReadingStory, chapter.id, chapter.name.replace('.txt', ''));
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng: ' + error.message, 'error');
    }
    showLoading(false);
    
    // Cu·ªôn l√™n ƒë·∫ßu trang
    document.getElementById('readerContent').scrollTop = 0;
}

// C·∫≠p nh·∫≠t l·ªãch s·ª≠ ƒë·ªçc
function updateReadingHistory(storyTitle, chapterId, chapterTitle) {
    // T√¨m xem ƒë√£ c√≥ trong l·ªãch s·ª≠ ch∆∞a
    const existingIndex = readingHistory.findIndex(item => 
        item.storyTitle === storyTitle && item.chapterId === chapterId
    );
    
    if (existingIndex !== -1) {
        // C·∫≠p nh·∫≠t th·ªùi gian ƒë·ªçc
        readingHistory[existingIndex].lastRead = new Date().toISOString();
    } else {
        // Th√™m m·ªõi v√†o l·ªãch s·ª≠
        readingHistory.push({
            storyTitle,
            chapterId,
            chapterTitle,
            lastRead: new Date().toISOString()
        });
    }
    
    // Gi·ªõi h·∫°n l·ªãch s·ª≠ t·ªëi ƒëa 50 m·ª•c
    if (readingHistory.length > 50) {
        readingHistory = readingHistory.slice(-50);
    }
    
    // L∆∞u v√†o localStorage
    localStorage.setItem('readingHistory', JSON.stringify(readingHistory));
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
    displayReadingHistory();
}

// ƒê√°nh gi√° ch∆∞∆°ng
function rateChapter(isGood) {
    if (!currentReadingStory || currentChaptersList.length === 0) return;
    
    const currentChapter = currentChaptersList[currentChapterIndex];
    
    // L∆∞u ƒë√°nh gi√°
    const rating = {
        storyTitle: currentReadingStory,
        chapterId: currentChapter.id,
        chapterTitle: currentChapter.name.replace('.txt', ''),
        isGood: isGood,
        ratedAt: new Date().toISOString()
    };
    
    // L·∫•y danh s√°ch ƒë√°nh gi√° hi·ªán c√≥
    let ratings = JSON.parse(localStorage.getItem('chapterRatings') || '[]');
    
    // Ki·ªÉm tra xem ch∆∞∆°ng n√†y ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° ch∆∞a
    const existingIndex = ratings.findIndex(r => 
        r.storyTitle === rating.storyTitle && r.chapterId === rating.chapterId
    );
    
    if (existingIndex !== -1) {
        ratings[existingIndex] = rating;
    } else {
        ratings.push(rating);
    }
    
    // L∆∞u ƒë√°nh gi√°
    localStorage.setItem('chapterRatings', JSON.stringify(ratings));
    
    // C·∫≠p nh·∫≠t ki·∫øn th·ª©c AI d·ª±a tr√™n ƒë√°nh gi√°
    updateAIFromRating(rating);
    
    // Th√¥ng b√°o cho ng∆∞·ªùi d√πng
    showStatus(`ƒê√£ ${isGood ? 'th√≠ch' : 'kh√¥ng th√≠ch'} ch∆∞∆°ng n√†y. C·∫£m ∆°n ph·∫£n h·ªìi c·ªßa b·∫°n!`, 'success');
}

// C·∫≠p nh·∫≠t AI t·ª´ ƒë√°nh gi√°
function updateAIFromRating(rating) {
    // L·∫•y n·ªôi dung ch∆∞∆°ng
    gapi.client.drive.files.get({
        fileId: rating.chapterId,
        alt: 'media'
    }).then(response => {
        const content = response.body;
        
        if (rating.isGood) {
            // N·∫øu ƒë√°nh gi√° t·ªët, th√™m n·ªôi dung n√†y v√†o ki·∫øn th·ª©c ∆∞u ti√™n
            enhanceAIWithGoodContent(content);
        } else {
            // N·∫øu ƒë√°nh gi√° kh√¥ng t·ªët, ghi nh·∫≠n n·ªôi dung c·∫ßn tr√°nh
            learnFromBadContent(content);
        }
    }).catch(error => {
        console.error('L·ªói khi t·∫£i n·ªôi dung ƒë·ªÉ ph√¢n t√≠ch:', error);
    });
}

// C·∫£i thi·ªán AI v·ªõi n·ªôi dung ƒë∆∞·ª£c ƒë√°nh gi√° t·ªët
function enhanceAIWithGoodContent(content) {
    // Ph√¢n t√≠ch n·ªôi dung v√† tƒÉng tr·ªçng s·ªë cho c√°c t·ª´ kh√≥a, c·∫•u tr√∫c t·ªët
    const sentences = content.split(/[.!?]+/);
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Th√™m c√¢u v√†o kho d·ªØ li·ªáu t·ªët
            if (!aiKnowledge.goodSentences) aiKnowledge.goodSentences = new Set();
            aiKnowledge.goodSentences.add(sentence.trim());
            
            // Ph√¢n t√≠ch v√† tƒÉng tr·ªçng s·ªë cho t·ª´ kh√≥a
            const words = sentence.toLowerCase().split(/\s+/);
            words.forEach(word => {
                if (word.length > 3 && !stopWords.includes(word)) {
                    if (!aiKnowledge.preferredVocabulary) aiKnowledge.preferredVocabulary = {};
                    aiKnowledge.preferredVocabulary[word] = (aiKnowledge.preferredVocabulary[word] || 0) + 1;
                }
            });
        }
    });
    
    // L∆∞u ki·∫øn th·ª©c AI
    saveAIKnowledge();
    showStatus('AI ƒë√£ h·ªçc t·ª´ n·ªôi dung ƒë∆∞·ª£c ƒë√°nh gi√° t·ªët', 'success');
}

// H·ªçc t·ª´ n·ªôi dung ƒë∆∞·ª£c ƒë√°nh gi√° kh√¥ng t·ªët
function learnFromBadContent(content) {
    // Ph√¢n t√≠ch n·ªôi dung v√† ghi nh·∫≠n c√°c t·ª´ kh√≥a, c·∫•u tr√∫c c·∫ßn tr√°nh
    const sentences = content.split(/[.!?]+/);
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Th√™m c√¢u v√†o kho d·ªØ li·ªáu x·∫•u
            if (!aiKnowledge.badSentences) aiKnowledge.badSentences = new Set();
            aiKnowledge.badSentences.add(sentence.trim());
            
            // Ph√¢n t√≠ch v√† gi·∫£m tr·ªçng s·ªë cho t·ª´ kh√≥a
            const words = sentence.toLowerCase().split(/\s+/);
            words.forEach(word => {
                if (word.length > 3 && !stopWords.includes(word)) {
                    if (!aiKnowledge.avoidedVocabulary) aiKnowledge.avoidedVocabulary = {};
                    aiKnowledge.avoidedVocabulary[word] = (aiKnowledge.avoidedVocabulary[word] || 0) + 1;
                }
            });
        }
    });
    
    // L∆∞u ki·∫øn th·ª©c AI
    saveAIKnowledge();
    showStatus('AI ƒë√£ ghi nh·∫≠n n·ªôi dung c·∫ßn c·∫£i thi·ªán', 'success');
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
window.onload = init;
</script>
</body>
</html>
