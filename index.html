<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tr√¨nh Ph√¢n T√≠ch & T·∫°o Truy·ªán N√¢ng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding-top: 12px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-bottom: calc(16px + var(--safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .menu-item.active {
            opacity: 1;
        }

        .menu-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 6px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .story-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary-color);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 50vh;
            overflow-y: auto;
        }

        .chapter-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #3498db);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .status-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .detailed-status {
            font-size: 0.9rem;
            color: #ecf0f1;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .character-profile {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(236, 240, 241, 0.3);
            border-radius: 10px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .character-details {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .character-desc {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .emotion-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 3px;
            background: #e74c3c;
            color: white;
        }

        .emotion-buon {
            background: #3498db;
        }

        .emotion-dau {
            background: #e74c3c;
        }

        .emotion-bat-luc {
            background: #95a5a6;
        }

        .sensitive-word {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .dialogue {
            font-style: italic;
            color: #2c3e50;
            margin: 5px 0;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }

        .analysis-result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .adult-content-warning {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        @media only screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .container {
                padding: 12px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .card {
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .story-content {
                font-size: 0.95rem;
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Tr√¨nh Ph√¢n T√≠ch & T·∫°o Truy·ªán</h1>
            <p>Ph√¢n t√≠ch n√¢ng cao v√† t·∫°o truy·ªán t·ª± ƒë·ªông</p>
        </div>

        <div id="tab-analysis" class="tab-content active">
            <div class="card">
                <h3>üîç Ph√¢n t√≠ch ngu·ªìn truy·ªán</h3>
                <p>Ph√¢n t√≠ch c√°c file vƒÉn b·∫£n trong th∆∞ m·ª•c "QuanLyTruyen"</p>
                
                <div class="status-info" id="statusInfo">
                    <p>üî¥ Ch∆∞a k·∫øt n·ªëi Google Drive</p>
                    <div class="detailed-status" id="detailedStatus"></div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="handleAuthClick()">
                    üìÅ K·∫øt n·ªëi Google Drive
                </button>
                
                <button class="btn btn-secondary" id="scanBtn" onclick="scanQuanLyTruyenFolder()" disabled>
                    üîç Qu√©t th∆∞ m·ª•c QuanLyTruyen
                </button>
                
                <button class="btn btn-warning" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    üß† Ph√¢n t√≠ch n√¢ng cao
                </button>

                <button class="btn btn-success" id="downloadDataBtn" onclick="downloadScanData()" disabled>
                    üíæ T·∫£i xu·ªëng d·ªØ li·ªáu qu√©t
                </button>

                <button class="btn btn-secondary" onclick="document.getElementById('uploadDataInput').click()">
                    üì§ T·∫£i l√™n d·ªØ li·ªáu qu√©t
                </button>
                <input type="file" id="uploadDataInput" accept=".json" style="display: none;" onchange="uploadScanData(event)">
                
                <div class="toggle-container">
                    <span>B·ªè qua file ƒë√£ ph√¢n t√≠ch</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipAnalyzedFiles" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="scannedFiles" style="max-height: 200px; overflow-y: auto; margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h3>üìä K·∫øt qu·∫£ ph√¢n t√≠ch</h3>
                <div id="analysisResults">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch. Vui l√≤ng qu√©t v√† ph√¢n t√≠ch th∆∞ m·ª•c tr∆∞·ªõc.</p>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="card">
                <h3>‚úçÔ∏è Vi·∫øt truy·ªán</h3>
                <p>T·∫°o truy·ªán m·ªõi d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch</p>
                
                <div class="character-profile">
                    <div class="character-avatar">üë®</div>
                    <div class="character-details">
                        <div class="character-name">Ng∆∞·ªùi k·ªÉ chuy·ªán</div>
                        <div class="character-desc">T·∫°o truy·ªán t·ª´ d·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch</div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>S·ªë ch∆∞∆°ng (50+):</span>
                    <input type="number" id="minChapters" value="50" min="50" max="100" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                </div>

                <div class="toggle-container">
                    <span>ƒê·ªô nh·∫°y c·∫£m:</span>
                    <input type="range" id="sensitivityLevel" min="1" max="10" value="5" style="width: 120px;">
                    <span id="sensitivityValue">5</span>
                </div>

                <div class="toggle-container">
                    <span>Bao g·ªìm n·ªôi dung 18+:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="includeAdultContent">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-success" id="generateBtn" onclick="generateStories()" disabled>
                    ‚úçÔ∏è B·∫Øt ƒë·∫ßu vi·∫øt truy·ªán
                </button>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="writeProgressBar"></div>
                    </div>
                </div>
                
                <div class="status-info">
                    <p id="writeStatus">Ch∆∞a b·∫Øt ƒë·∫ßu vi·∫øt truy·ªán</p>
                    <div class="detailed-status" id="writeDetailedStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìñ Truy·ªán ƒëang vi·∫øt</h3>
                <div id="generatedStories">
                    <p>Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o. H√£y b·∫•m "B·∫Øt ƒë·∫ßu vi·∫øt truy·ªán" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
            </div>
        </div>

        <div id="tab-stories" class="tab-content">
            <div class="card">
                <h3>üìö Th∆∞ vi·ªán truy·ªán</h3>
                <p>Nh·ªØng truy·ªán ƒë√£ ƒë∆∞·ª£c t·∫°o v√† l∆∞u tr·ªØ</p>
                
                <div id="storiesLibrary">
                    <p>Ch∆∞a c√≥ truy·ªán n√†o trong th∆∞ vi·ªán.</p>
                </div>
                
                <button class="btn btn-secondary" id="loadStoriesBtn" onclick="loadStories()">
                    üîÑ T·∫£i danh s√°ch truy·ªán
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
                
                <div class="toggle-container">
                    <span>T·ª± ƒë·ªông l∆∞u ti·∫øn ƒë·ªô</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveResults" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span>G·ª≠i d·ªØ li·ªáu c·∫£i thi·ªán AI</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sendImprovementData" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="clearCache()">
                    üóëÔ∏è X√≥a d·ªØ li·ªáu t·∫°m
                </button>
                
                <button class="btn btn-danger" onclick="handleSignoutClick()">
                    üö™ ƒêƒÉng xu·∫•t
                </button>
            </div>
            
            <div class="card">
                <h3>‚ÑπÔ∏è Th√¥ng tin ·ª©ng d·ª•ng</h3>
                <p>Phi√™n b·∫£n: 2.2.0</p>
                <p>Ph√¢n t√≠ch n√¢ng cao: H·ªôi tho·∫°i, T·ª´ nh·∫°y c·∫£m, N·ªôi dung 18+</p>
                <p>L∆∞u tr·ªØ: C√≥ th·ªÉ t·∫£i xu·ªëng v√† t·∫£i l√™n d·ªØ li·ªáu</p>
                <p>G√≥c nh√¨n: Linh ho·∫°t theo ph√¢n t√≠ch</p>
            </div>
        </div>
    </div>

    <div class="bottom-menu">
        <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">
            <div class="menu-icon">üîç</div>
            <span>Ph√¢n t√≠ch</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-write')">
            <div class="menu-icon">‚úçÔ∏è</div>
            <span>Vi·∫øt truy·ªán</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-stories')">
            <div class="menu-icon">üìö</div>
            <span>Th∆∞ vi·ªán</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-settings')">
            <div class="menu-icon">‚öôÔ∏è</div>
            <span>C√†i ƒë·∫∑t</span>
        </a>
    </div>

    <script>
        // Google API Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapi_inited = false;
        let gsi_inited = false;

        // Global variables
        let analysisData = [];
        let generatedStories = [];
        let txtFiles = []; // L∆∞u tr·ªØ danh s√°ch file ƒë√£ qu√©t
        let scanData = null; // L∆∞u tr·ªØ d·ªØ li·ªáu qu√©t ƒë·∫ßy ƒë·ªß

        // T·ª´ d·ª´ng ti·∫øng Vi·ªát m·ªü r·ªông
        const vietnameseStopWords = [
            'l√†', 'c·ªßa', 'v√†', 'c√≥', 'm·ªôt', 'ƒë∆∞·ª£c', 'trong', 'kh√¥ng', 'v·ªõi', 't·ª´', 'ƒë·ªÉ', 'ƒë√£', 's·∫Ω',
            'v·ªÅ', 'cho', 'theo', 'nh∆∞', 'khi', 'v√†o', 'ra', 'l√™n', 'xu·ªëng', 'qua', 't·∫°i', 'hay',
            'r·∫±ng', 'n·∫øu', 'm√†', 'th√¨', 'ho·∫∑c', 'nh∆∞ng', 'v√¨', 'n√™n', 'ƒë·∫øn', 'b·∫±ng', 'tr√™n', 'd∆∞·ªõi',
            'gi·ªØa', 'sau', 'tr∆∞·ªõc', 'c√πng', 'c≈©ng', 'ch·ªâ', 'nh·ªØng', 'n√†y', 'ƒë√≥', 'th·∫ø', 'n√†o', 'ai',
            'g√¨', 'ƒë√¢u', 'sao', 'bao', 'l√∫c', 'l·∫°i', 'r·∫•t', 't·∫•t', 'c·∫£', 'm·ªçi', 'b·∫•t', 'cu·ªôc', 'vi·ªác'
        ];

        // T·ª´ nh·∫°y c·∫£m m·ªü r·ªông v·ªõi nhi·ªÅu danh m·ª•c
        const sensitiveWords = {
            romantic: [
                'y√™u', 'th∆∞∆°ng', 'h√¥n', '√¥m', '·∫•p √¥m', '√¢m √°p', 'say ƒë·∫Øm', 'ƒëam m√™', 'd·ªãu d√†ng', 
                'ng·ªçt ng√†o', 'quy·∫øn r≈©', 'm√™ ho·∫∑c', 'th√¢n m·∫≠t', 'g·∫ßn g≈©i', 't√¨nh t·ª©', 'l√£ng m·∫°n',
                'khao kh√°t', 'kh√°t khao', 'nu√¥ng chi·ªÅu', 'c∆∞ng n·ª±ng', 'y√™u th∆∞∆°ng', 'm√™ m·∫£i',
                'si m√™', 'ƒëi√™n cu·ªìng', 'say m√™', 'ƒë·∫Øm ƒëu·ªëi', 'th·ªïn th·ª©c', 'rung ƒë·ªông'
            ],
            intimate: [
                'c·ªüi', 'kh·ªèa th√¢n', 'l√µa th·ªÉ', 'kho·∫£ th√¢n', 'tr·∫ßn tru·ªìng', 'n√≥ng b·ªèng', 'n√≥ng n·ª±c',
                'th√¢n th·ªÉ', 'c∆° th·ªÉ', 'da th·ªãt', 'l√¥ng l√°', 'm·ªãn m√†ng', 'tr∆°n tru', 'sƒÉn ch·∫Øc',
                'ƒë√πi', 'ch√¢n', 'tay', 'c·ªï', 'vai', 'l∆∞ng', 'b·ª•ng', 'ng·ª±c', 'm√°', 'm√¥i', 'h∆°i th·ªü'
            ],
            sexual: [
                'g·ªëi chƒÉn', 'ph√≤ng the', '√¢n √°i', 'l√†m t√¨nh', 'quan h·ªá', 't√¨nh d·ª•c', 'd√¢m', 'd·ª•c',
                'kho√°i c·∫£m', 'k√≠ch th√≠ch', 'sung s∆∞·ªõng', 'c·ª±c kho√°i', 'th·ªèa m√£n', 'd·ª•c v·ªçng',
                'ham mu·ªën', 'th√®m kh√°t', 'khao kh√°t', 'ƒëi√™n d·∫°i', 'cu·ªìng nhi·ªát', 'b√πng ch√°y',
                'r√™n r·ªâ', 'th·ªïn th·ª©c', 'run r·∫©y', 'co gi·∫≠t', 'cƒÉng c·ª©ng', '∆∞·ªõt √°t', 'n√≥ng ran'
            ],
            emotional_negative: [
                'gh√©t', 'h·∫≠n', 'gi·∫≠n', 't·ª©c', 't·ªßi', 'bu·ªìn', 'ƒëau', 'kh·ªï', 's·∫ßu', 'th·∫£m', 'bi',
                'tang', 't·ª≠', 'ch·∫øt', 'gi·∫øt', 'h·∫°i', '√°c', 'd·ªØ', 'hung', 'ƒë·ªôc', 't√†n', 'nh·∫´n',
                'ph·∫´n n·ªô', 'cƒÉm th√π', 'th√π h·∫≠n', 'o√°n h·∫≠n', 'cay ƒë·∫Øng', 'x√≥t xa', 'ƒëau ƒë·ªõn',
                'tuy·ªát v·ªçng', 'ch√°n n·∫£n', 'th·∫•t v·ªçng', 'b·∫•t l·ª±c', 'v√¥ v·ªçng', 'tuy·ªátÊúõ'
            ],
            family_conflict: [
                'b·ªë', 'm·∫π', 'cha', 'con', 'ch·ªìng', 'v·ª£', 'd√¢u', 'r·ªÉ', 'anh', 'ch·ªã', 'em', '√¥ng', 'b√†',
                'ch√∫', 'b√°c', 'c√¥', 'd√¨', 'c·∫≠u', 'm·ª£', 'th√¥ng gia', 'h·ªç h√†ng', 'gia ƒë√¨nh',
                'ph·∫£n b·ªôi gia ƒë√¨nh', 'l·ª´a d·ªëi gia ƒë√¨nh', 'b√™ b·ªëi gia ƒë√¨nh', 'scandal gia ƒë√¨nh'
            ],
            secret_affair: [
                'b√≠ m·∫≠t', 'gi·∫•u gi·∫øm', 'che gi·∫•u', 'gi·∫•u di·∫øm', 'l√©n l√∫t', 'v·ª•ng tr·ªôm', '√¢m th·∫ßm',
                'l·∫∑ng l·∫Ω', 'k√≠n ƒë√°o', 'ri√™ng t∆∞', 'ngo·∫°i t√¨nh', 't√¨nh nh√¢n', 'b·ªì nh√≠', 'ti·ªÉu tam',
                'th·ª© ba', 'chen ch√¢n', 'ph√° ho·∫°i', 'c∆∞·ªõp ch·ªìng', 'c∆∞·ªõp v·ª£', 'l·ª´a d·ªëi'
            ],
            violence: [
                'ƒë√°nh', 'ƒë·∫≠p', 't√°t', 'ÎïåÎ¶¨Îã§', 'b·∫°o l·ª±c', 'b·∫°o h√†nh', 'h√†nh h·∫°', 'tra t·∫•n',
                'd√≠ d·ªèm', '√©p bu·ªôc', 'c∆∞·ª°ng b·ª©c', 'c∆∞·ª°ng ch·∫ø', 'uy hi·∫øp', 'ƒëe d·ªça',
                'm√°u', 'ch·∫£y m√°u', 'ƒë·∫´m m√°u', 'th∆∞∆°ng t√≠ch', 'v·∫øt th∆∞∆°ng'
            ],
            adult_explicit: [
                'ƒë·ªãt', 'ƒë·ª•', 'ch·ªãch', 'doggy', 'blowjob', 'oral', 'anal', 'hardcore',
                'cumshot', 'creampie', 'fingering', 'masturbate', 'orgasm', 'climax',
                'penetrate', 'thrust', 'moan', 'scream', 'wet', 'tight', 'hard', 'soft',
                'lick', 'suck', 'kiss', 'bite', 'squeeze', 'grab', 'touch', 'feel',
                'pussy', 'cock', 'dick', 'tits', 'boobs', 'ass', 'butt', 'hole',
                'l·ªìn', 'c·∫∑c', 'cu', 'v√∫', 'ƒë√≠t', 'm√¥ng', 'n√∫m v√∫', '√¢m ƒë·∫°o', 'd∆∞∆°ng v·∫≠t'
            ]
        };

        // T·ª´ c·∫£m x√∫c m·ªü r·ªông
        const emotionalWords = {
            positive: [
                'vui', 'h·∫°nh ph√∫c', 'y√™u', 'th∆∞∆°ng', 'tuy·ªát v·ªùi', 'ƒë·∫πp', 't·ªët', 'xu·∫•t s·∫Øc', 
                'th√†nh c√¥ng', 'hy v·ªçng', 'ph·∫•n kh√≠ch', 'h√†o h·ª©ng', 't·ª± h√†o', 'm√£n nguy·ªán',
                'th·ªèa m√£n', 'sung s∆∞·ªõng', 'r·∫°ng r·ª°', 't∆∞∆°i c∆∞·ªùi', 'l·∫°c quan', 'nhi·ªát t√¨nh'
            ],
            negative: [
                'bu·ªìn', 'ƒëau', 'kh·ªï', 't·ªá', 'x·∫•u', 'th·∫•t b·∫°i', 'tuy·ªát v·ªçng', 'gh√©t', 't·ª©c gi·∫≠n', 
                'lo l·∫Øng', 's·ª£ h√£i', 'kh√≥c', 'tang th∆∞∆°ng', 'b·∫•t h·∫°nh', 'd·ªëi tr√°', 'ph·∫£n b·ªôi', 
                'l·ª´a d·ªëi', 'x√≥t xa', 'ƒëau ƒë·ªõn', 'x·∫•u h·ªï', 't·ªßi nh·ª•c', 'c√¥ ƒë∆°n', 'tr·ªëng r·ªóng',
                'ch√°n ch∆∞·ªùng', 'ch√°n n·∫£n', 'bi quan', 'u s·∫ßu', 'th√™ l∆∞∆°ng', 'kh·ªën kh·ªï'
            ],
            neutral: [
                'b√¨nh th∆∞·ªùng', 'th√¥ng th∆∞·ªùng', 'trung b√¨nh', '·ªïn', 'ƒë∆∞·ª£c', 't·∫°m ·ªïn', 'b√¨nh y√™n',
                'l·∫∑ng l·∫Ω', 'y√™n tƒ©nh', 'thong th·∫£', 'nh·∫π nh√†ng'
            ]
        };

        // T·ª´ kh√≥a h·ªôi tho·∫°i m·ªü r·ªông
        const dialogueIndicators = [
            'n√≥i', 'b·∫£o', 'h·ªèi', 'ƒë√°p', 'th∆∞a', 'k√™u', 'g·ªçi', 'h√©t', 'la', 'th√©t', 'th√¨ th·∫ßm', 
            'r·ªß r·ªâ', 'l√™n ti·∫øng', 'ph√°t bi·ªÉu', 'tr·∫£ l·ªùi', 'h·ªèi l·∫°i', 'ƒë√°p l·∫°i', 't·ª± nh·ªß', 'nghƒ© th·∫ßm',
            'th·ªët l√™n', 'c·∫•t ti·∫øng', 'l·∫©m b·∫©m', 'l·∫ßm b·∫ßm', 'reo l√™n', 'than th·ªü', 'th·ªü d√†i',
            'kh·∫≥ng ƒë·ªãnh', 'ph·ªß nh·∫≠n', 'ƒë·ªìng √Ω', 't·ª´ ch·ªëi', 'th√∫ nh·∫≠n', 'k·ªÉ', 't√¢m s·ª±', 'b·ªôc b·∫°ch'
        ];

        const dialoguePunctuation = ['"', "'", ':', ';', '-', '‚Äî', '‚Äì', '¬ª', '¬´'];

        // T·ª´ kh√≥a b·ªëi c·∫£nh v√† m√¥i tr∆∞·ªùng
        const contextWords = {
            location: [
                'nh√†', 'ph√≤ng', 'gi∆∞·ªùng', 'b√†n', 'gh·∫ø', 'c·ª≠a', 'c·ª≠a s·ªï', 'v∆∞·ªùn', 's√¢n', 'b·∫øp',
                'ph√≤ng t·∫Øm', 'ph√≤ng ng·ªß', 'ph√≤ng kh√°ch', 't·∫ßng l·∫ßu', 'g√°c x√©p', 'h·∫ßm', 'ban c√¥ng',
                'kh√°ch s·∫°n', 'motel', 'resort', 'bi·ªát th·ª±', 'cƒÉn h·ªô', 'chung c∆∞', 'nh√† tr·ªç'
            ],
            time: [
                's√°ng', 'chi·ªÅu', 't·ªëi', 'khuya', 'ƒë√™m', 'n·ª≠a ƒë√™m', 'r·∫°ng s√°ng', 'ho√†ng h√¥n',
                'l√∫c', 'gi·ªù', 'ph√∫t', 'gi√¢y', 'h√¥m nay', 'h√¥m qua', 'ng√†y mai', 'tu·∫ßn', 'th√°ng',
                'nƒÉm', 'm√πa', 'xu√¢n', 'h·∫°', 'thu', 'ƒë√¥ng'
            ],
            weather: [
                'n·∫Øng', 'm∆∞a', 'gi√≥', 'b√£o', 's∆∞∆°ng', 'n√≥ng', 'l·∫°nh', '·∫•m', 'm√°t', '·∫©m', 'kh√¥',
                'trong', 'ƒë·ª•c', 's√°ng', 't·ªëi', 'm√¢y', 'tr·ªùi', 'kh√¥ng kh√≠'
            ]
        };

        // Initialize Google APIs
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapi_inited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gsi_inited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapi_inited && gsi_inited) {
                document.getElementById('scanBtn').disabled = false;
            }
        }

        // Authentication functions
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                await showLoggedInState();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                showLoggedOutState();
            }
        }

        async function showLoggedInState() {
            updateStatus('üü¢ ƒê√£ k·∫øt n·ªëi Google Drive');
            document.getElementById('scanBtn').disabled = false;
        }

        function showLoggedOutState() {
            updateStatus('üî¥ Ch∆∞a k·∫øt n·ªëi Google Drive');
            const buttons = ['scanBtn', 'analyzeBtn', 'generateBtn', 'downloadDataBtn'];
            buttons.forEach(id => document.getElementById(id).disabled = true);
        }

        // QU√âT TH·ª¶ M·ª§C QUANLYTRUYEN - S·ª¨A L·ªñI
        async function scanQuanLyTruyenFolder() {
            updateStatus('üîç ƒêang t√¨m th∆∞ m·ª•c QuanLyTruyen...');
            updateProgress(5);
            
            try {
                // T√¨m th∆∞ m·ª•c QuanLyTruyen
                const folderResponse = await gapi.client.drive.files.list({
                    q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                });
                
                if (folderResponse.result.files.length === 0) {
                    updateStatus('‚ùå Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c QuanLyTruyen');
                    updateProgress(0);
                    return;
                }
                
                const folderId = folderResponse.result.files[0].id;
                updateStatus('üìÅ ƒêang qu√©t t·∫•t c·∫£ file trong QuanLyTruyen v√† th∆∞ m·ª•c con...');
                updateProgress(10);
                
                txtFiles = [];
                await scanFolderRecursively(folderId, 'QuanLyTruyen');
                
                updateProgress(90);
                updateStatus(`‚úÖ T√¨m th·∫•y ${txtFiles.length} file txt`);
                updateProgress(100);
                
                // L∆∞u d·ªØ li·ªáu qu√©t
                scanData = {
                    scannedAt: new Date().toISOString(),
                    folderName: 'QuanLyTruyen',
                    totalFiles: txtFiles.length,
                    files: txtFiles
                };
                
                displayScannedFiles();
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('downloadDataBtn').disabled = false;
                
                setTimeout(() => updateProgress(0), 2000);
                
            } catch (error) {
                console.error('Error scanning folder:', error);
                updateStatus(`‚ùå L·ªói khi qu√©t th∆∞ m·ª•c: ${error.message}`);
                updateProgress(0);
            }
        }

        // Qu√©t ƒë·ªá quy t·∫•t c·∫£ th∆∞ m·ª•c con
        async function scanFolderRecursively(folderId, folderPath) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, mimeType)',
                    pageSize: 1000
                });
                
                const files = response.result.files;
                
                for (const file of files) {
                    if (file.mimeType === 'application/vnd.google-apps.folder') {
                        // N·∫øu l√† th∆∞ m·ª•c, qu√©t ƒë·ªá quy
                        await scanFolderRecursively(file.id, `${folderPath}/${file.name}`);
                    } else if (file.name.toLowerCase().endsWith('.txt')) {
                        // N·∫øu l√† file txt, th√™m v√†o danh s√°ch
                        txtFiles.push({
                            id: file.id,
                            name: file.name,
                            folderPath: folderPath,
                            fullPath: `${folderPath}/${file.name}`
                        });
                    }
                }
                
                // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
                const progress = 10 + (txtFiles.length * 0.8);
                updateProgress(Math.min(progress, 85));
                updateDetailedStatus(`ƒê√£ t√¨m th·∫•y ${txtFiles.length} file txt...`);
                
            } catch (error) {
                console.error(`Error scanning folder ${folderPath}:`, error);
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch file ƒë√£ qu√©t
        function displayScannedFiles() {
            const container = document.getElementById('scannedFiles');
            
            if (txtFiles.length === 0) {
                container.innerHTML = '<p>Ch∆∞a qu√©t ƒë∆∞·ª£c file n√†o.</p>';
                return;
            }
            
            let html = `<h4>üìÑ Danh s√°ch ${txtFiles.length} file txt ƒë√£ qu√©t:</h4>`;
            
            // Nh√≥m theo th∆∞ m·ª•c
            const filesByFolder = {};
            txtFiles.forEach(file => {
                if (!filesByFolder[file.folderPath]) {
                    filesByFolder[file.folderPath] = [];
                }
                filesByFolder[file.folderPath].push(file);
            });
            
            for (const [folderPath, files] of Object.entries(filesByFolder)) {
                html += `<div style="margin: 8px 0;"><strong>üìÅ ${folderPath} (${files.length} files)</strong></div>`;
                files.slice(0, 5).forEach(file => {
                    html += `<div class="file-item">üìÑ ${file.name}</div>`;
                });
                if (files.length > 5) {
                    html += `<div class="file-item" style="opacity: 0.7;">... v√† ${files.length - 5} file kh√°c</div>`;
                }
            }
            
            container.innerHTML = html;
        }

        // T·∫¢I XU·ªêNG V√Ä T·∫¢I L√äN D·ªÆ LI·ªÜU QU√âT
        function downloadScanData() {
            if (!scanData) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu qu√©t ƒë·ªÉ t·∫£i xu·ªëng!');
                return;
            }
            
            const dataStr = JSON.stringify(scanData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `QuanLyTruyen_ScanData_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus('üíæ ƒê√£ t·∫£i xu·ªëng d·ªØ li·ªáu qu√©t');
        }

        function uploadScanData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.files && Array.isArray(data.files)) {
                        scanData = data;
                        txtFiles = data.files;
                        
                        updateStatus(`üì§ ƒê√£ t·∫£i l√™n d·ªØ li·ªáu qu√©t: ${txtFiles.length} file`);
                        displayScannedFiles();
                        
                        document.getElementById('analyzeBtn').disabled = false;
                        document.getElementById('downloadDataBtn').disabled = false;
                    } else {
                        alert('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!');
                    }
                } catch (error) {
                    alert('L·ªói khi ƒë·ªçc file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // PH√ÇN T√çCH N√ÇNG CAP M·ªû R·ªòNG
        async function analyzeFiles() {
            if (!txtFiles || txtFiles.length === 0) {
                alert('Vui l√≤ng qu√©t th∆∞ m·ª•c tr∆∞·ªõc khi ph√¢n t√≠ch!');
                return;
            }
            
            updateStatus('üß† B·∫Øt ƒë·∫ßu ph√¢n t√≠ch n√¢ng cao...');
            analysisData = [];
            
            const totalFiles = Math.min(txtFiles.length, 50);
            
            for (let i = 0; i < totalFiles; i++) {
                const file = txtFiles[i];
                updateProgress((i / totalFiles) * 100);
                updateStatus(`üß† ƒêang ph√¢n t√≠ch: ${file.name} (${i+1}/${totalFiles})`);
                updateDetailedStatus(`Ph√¢n t√≠ch h·ªôi tho·∫°i, t·ª´ nh·∫°y c·∫£m, n·ªôi dung 18+...`);
                
                try {
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    
                    const content = response.body;
                    const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
                    analysisData.push(analysis);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                } catch (error) {
                    console.error(`Error analyzing file ${file.name}:`, error);
                    analysisData.push({
                        fileName: file.name,
                        folderPath: file.folderPath,
                        error: error.message
                    });
                }
            }
            
            displayAdvancedAnalysisResults();
            document.getElementById('generateBtn').disabled = false;
            updateProgress(100);
            updateStatus(`‚úÖ Ho√†n th√†nh ph√¢n t√≠ch ${totalFiles} file`);
            updateDetailedStatus('');
            
            setTimeout(() => updateProgress(0), 2000);
        }

        // PH√ÇN T√çCH N√ÇNG CAO M·ªöI V·ªöI NHI·ªÄU CHI TI·∫æT H∆†N
        async function performAdvancedAnalysis(content, fileName, folderPath) {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const analysis = {
                fileName: fileName,
                folderPath: folderPath || 'Unknown',
                timestamp: new Date().toLocaleString('vi-VN'),
                
                // Ph√¢n t√≠ch c∆° b·∫£n
                basicStats: analyzeBasicStats(content),
                
                // Ph√¢n t√≠ch c·∫£m x√∫c n√¢ng cao
                emotionalAnalysis: analyzeEmotionsAdvanced(content),
                
                // Ph√¢n t√≠ch ch·ªß ƒë·ªÅ
                thematicAnalysis: analyzeThemes(content),
                
                // Ph√¢n t√≠ch nh√¢n v·∫≠t n√¢ng cao
                characterAnalysis: analyzeCharactersAdvanced(content),
                
                // Ph√¢n t√≠ch h·ªôi tho·∫°i n√¢ng cao
                dialogueAnalysis: analyzeDialoguesAdvanced(content),
                
                // Ph√¢n t√≠ch t·ª´ nh·∫°y c·∫£m n√¢ng cao
                sensitiveAnalysis: analyzeSensitiveContentAdvanced(content),
                
                // Ph√¢n t√≠ch b·ªëi c·∫£nh
                contextAnalysis: analyzeContext(content),
                
                // Ph√¢n t√≠ch n·ªôi dung 18+
                adultContentAnalysis: analyzeAdultContent(content),
                
                // Ph√¢n t√≠ch c·ªët truy·ªán
                narrativeAnalysis: analyzeNarrativeStructure(content),
                
                // M·∫´u n·ªôi dung
                contentSample: content.substring(0, 1500) + (content.length > 1500 ? '...' : '')
            };
            
            return analysis;
        }

        function analyzeBasicStats(content) {
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            const words = content.split(/\s+/).filter(w => w.length > 0);
            const characters = content.length;
            const charactersNoSpaces = content.replace(/\s/g, '').length;
            
            return {
                wordCount: words.length,
                sentenceCount: sentences.length,
                paragraphCount: paragraphs.length,
                characterCount: characters,
                characterCountNoSpaces: charactersNoSpaces,
                avgWordsPerSentence: Math.round(words.length / sentences.length * 10) / 10,
                avgSentencesPerParagraph: Math.round(sentences.length / paragraphs.length * 10) / 10,
                avgWordLength: Math.round(charactersNoSpaces / words.length * 10) / 10,
                readingTime: Math.ceil(words.length / 200) // ph√∫t
            };
        }

        function analyzeEmotionsAdvanced(content) {
            const emotionAnalysis = {};
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            const contentLower = content.toLowerCase();
            
            Object.entries(emotionalWords).forEach(([category, words]) => {
                let totalMentions = 0;
                const wordDetails = {};
                
                words.forEach(word => {
                    const regex = new RegExp(word, 'g');
                    const matches = contentLower.match(regex) || [];
                    if (matches.length > 0) {
                        wordDetails[word] = matches.length;
                        totalMentions += matches.length;
                    }
                });
                
                emotionAnalysis[category] = {
                    count: totalMentions,
                    percentage: ((totalMentions / sentences.length) * 100).toFixed(1) + '%',
                    words: wordDetails
                };
            });
            
            const sentimentScore = calculateSentimentScore(emotionAnalysis);
            const dominantEmotion = findDominantEmotion(emotionAnalysis);
            
            return {
                overallTone: determineOverallTone(emotionAnalysis),
                emotionBreakdown: emotionAnalysis,
                sentimentScore: sentimentScore,
                dominantEmotion: dominantEmotion,
                emotionalIntensity: calculateEmotionalIntensity(emotionAnalysis)
            };
        }

        function analyzeCharactersAdvanced(content) {
            const characters = [];
            const namePattern = /\b[A-Z√Ä-·ª∏][a-z√†-·ªπ]{2,15}(?:\s[A-Z√Ä-·ª∏][a-z√†-·ªπ]{2,15})*\b/g;
            const potentialNames = content.match(namePattern) || [];
            
            const nameCounts = {};
            const nameContexts = {};
            
            potentialNames.forEach(name => {
                if (name.length > 2 && name.length < 30 && !vietnameseStopWords.includes(name.toLowerCase())) {
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                    
                    // L·∫•y ng·ªØ c·∫£nh xung quanh t√™n
                    const nameIndex = content.indexOf(name);
                    if (nameIndex !== -1) {
                        const context = content.substring(
                            Math.max(0, nameIndex - 50),
                            Math.min(content.length, nameIndex + name.length + 50)
                        );
                        nameContexts[name] = context;
                    }
                }
            });
            
            Object.entries(nameCounts)
                .filter(([name, count]) => count >= 2)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8)
                .forEach(([name, count]) => {
                    const importance = count > 10 ? 'Ch√≠nh' : count > 5 ? 'Ph·ª•' : 'N·ªÅn';
                    const relationship = analyzeCharacterRelationship(name, content);
                    
                    characters.push({
                        name: name,
                        appearances: count,
                        importance: importance,
                        relationship: relationship,
                        context: nameContexts[name]?.substring(0, 100) + '...'
                    });
                });
            
            return {
                characterCount: characters.length,
                characters: characters,
                relationshipComplexity: characters.length > 4 ? 'Ph·ª©c t·∫°p' : 'ƒê∆°n gi·∫£n'
            };
        }

        function analyzeCharacterRelationship(characterName, content) {
            const familyWords = sensitiveWords.family_conflict;
            const relationshipContext = content.toLowerCase();
            
            for (const familyTerm of familyWords) {
                if (relationshipContext.includes(characterName.toLowerCase()) && 
                    relationshipContext.includes(familyTerm)) {
                    return familyTerm;
                }
            }
            return 'Kh√¥ng r√µ';
        }

        // PH√ÇN T√çCH H·ªòI THO·∫†I N√ÇNG CAO
        function analyzeDialoguesAdvanced(content) {
            const dialogues = [];
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            for (const sentence of sentences) {
                const dialogue = extractDialogueAdvanced(sentence);
                if (dialogue) {
                    const emotion = analyzeDialogueEmotion(dialogue.text);
                    const speaker = extractSpeaker(sentence);
                    
                    dialogues.push({
                        text: dialogue.text,
                        speaker: speaker,
                        emotion: emotion,
                        length: dialogue.text.length,
                        hasQuotes: dialogue.hasQuotes,
                        hasIndicator: dialogue.hasIndicator,
                        context: sentence.substring(0, 200) + '...'
                    });
                }
            }
            
            return {
                dialogueCount: dialogues.length,
                dialogues: dialogues.slice(0, 15),
                dialoguePercentage: ((dialogues.length / sentences.length) * 100).toFixed(1) + '%',
                averageDialogueLength: dialogues.length > 0 ? 
                    Math.round(dialogues.reduce((sum, d) => sum + d.length, 0) / dialogues.length) : 0,
                emotionalDialogues: dialogues.filter(d => d.emotion !== 'trung t√≠nh').length
            };
        }

        function extractDialogueAdvanced(sentence) {
            // T√¨m vƒÉn b·∫£n trong ngo·∫∑c k√©p
            const quotedText = sentence.match(/["'¬ª¬´](.*?)["'¬ª¬´]/);
            if (quotedText && quotedText[1].length > 5) {
                return {
                    text: quotedText[1],
                    hasQuotes: true,
                    hasIndicator: false
                };
            }
            
            // T√¨m vƒÉn b·∫£n sau d·∫•u hai ch·∫•m ho·∫∑c g·∫°ch ngang
            const colonMatch = sentence.match(/[:‚Äî‚Äì]\s*(.+)$/);
            if (colonMatch && colonMatch[1].length > 10) {
                return {
                    text: colonMatch[1].trim(),
                    hasQuotes: false,
                    hasIndicator: true
                };
            }
            
            // T√¨m vƒÉn b·∫£n sau c√°c t·ª´ ch·ªâ h·ªôi tho·∫°i
            for (const indicator of dialogueIndicators) {
                const regex = new RegExp(`${indicator}\\s*[:"]?\\s*(.+)<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tr√¨nh Ph√¢n T√≠ch & T·∫°o Truy·ªán N√¢ng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding-top: 12px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-bottom: calc(16px + var(--safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .menu-item.active {
            opacity: 1;
        }

        .menu-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 6px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .story-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary-color);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 50vh;
            overflow-y: auto;
        }

        .chapter-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #3498db);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .status-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .detailed-status {
            font-size: 0.9rem;
            color: #ecf0f1;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .character-profile {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(236, 240, 241, 0.3);
            border-radius: 10px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .character-details {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .character-desc {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .emotion-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 3px;
            background: #e74c3c;
            color: white;
        }

        .emotion-buon {
            background: #3498db;
        }

        .emotion-dau {
            background: #e74c3c;
        }

        .emotion-bat-luc {
            background: #95a5a6;
        }

        .sensitive-word {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .dialogue {
            font-style: italic;
            color: #2c3e50;
            margin: 5px 0;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }

        .analysis-result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .adult-content-warning {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        @media only screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .container {
                padding: 12px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .card {
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .story-content {
                font-size: 0.95rem;
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Tr√¨nh Ph√¢n T√≠ch & T·∫°o Truy·ªán</h1>
            <p>Ph√¢n t√≠ch n√¢ng cao v√† t·∫°o truy·ªán t·ª± ƒë·ªông</p>
        </div>

        <div id="tab-analysis" class="tab-content active">
            <div class="card">
                <h3>üîç Ph√¢n t√≠ch ngu·ªìn truy·ªán</h3>
                <p>Ph√¢n t√≠ch c√°c file vƒÉn b·∫£n trong th∆∞ m·ª•c "QuanLyTruyen"</p>
                
                <div class="status-info" id="statusInfo">
                    <p>üî¥ Ch∆∞a k·∫øt n·ªëi Google Drive</p>
                    <div class="detailed-status" id="detailedStatus"></div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="handleAuthClick()">
                    üìÅ K·∫øt n·ªëi Google Drive
                </button>
                
                <button class="btn btn-secondary" id="scanBtn" onclick="scanQuanLyTruyenFolder()" disabled>
                    üîç Qu√©t th∆∞ m·ª•c QuanLyTruyen
                </button>
                
                <button class="btn btn-warning" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    üß† Ph√¢n t√≠ch n√¢ng cao
                </button>

                <button class="btn btn-success" id="downloadDataBtn" onclick="downloadScanData()" disabled>
                    üíæ T·∫£i xu·ªëng d·ªØ li·ªáu qu√©t
                </button>

                <button class="btn btn-secondary" onclick="document.getElementById('uploadDataInput').click()">
                    üì§ T·∫£i l√™n d·ªØ li·ªáu qu√©t
                </button>
                <input type="file" id="uploadDataInput" accept=".json" style="display: none;" onchange="uploadScanData(event)">
                
                <div class="toggle-container">
                    <span>B·ªè qua file ƒë√£ ph√¢n t√≠ch</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipAnalyzedFiles" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="scannedFiles" style="max-height: 200px; overflow-y: auto; margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h3>üìä K·∫øt qu·∫£ ph√¢n t√≠ch</h3>
                <div id="analysisResults">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch. Vui l√≤ng qu√©t v√† ph√¢n t√≠ch th∆∞ m·ª•c tr∆∞·ªõc.</p>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="card">
                <h3>‚úçÔ∏è Vi·∫øt truy·ªán</h3>
                <p>T·∫°o truy·ªán m·ªõi d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch</p>
                
                <div class="character-profile">
                    <div class="character-avatar">üë®</div>
                    <div class="character-details">
                        <div class="character-name">Ng∆∞·ªùi k·ªÉ chuy·ªán</div>
                        <div class="character-desc">T·∫°o truy·ªán t·ª´ d·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch</div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>S·ªë ch∆∞∆°ng (50+):</span>
                    <input type="number" id="minChapters" value="50" min="50" max="100" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                </div>

                <div class="toggle-container">
                    <span>ƒê·ªô nh·∫°y c·∫£m:</span>
                    <input type="range" id="sensitivityLevel" min="1" max="10" value="5" style="width: 120px;">
                    <span id="sensitivityValue">5</span>
                </div>

                <div class="toggle-container">
                    <span>Bao g·ªìm n·ªôi dung 18+:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="includeAdultContent">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-success" id="generateBtn" onclick="generateStories()" disabled>
                    ‚úçÔ∏è B·∫Øt ƒë·∫ßu vi·∫øt truy·ªán
                </button>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="writeProgressBar"></div>
                    </div>
                </div>
                
                <div class="status-info">
                    <p id="writeStatus">Ch∆∞a b·∫Øt ƒë·∫ßu vi·∫øt truy·ªán</p>
                    <div class="detailed-status" id="writeDetailedStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìñ Truy·ªán ƒëang vi·∫øt</h3>
                <div id="generatedStories">
                    <p>Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o. H√£y b·∫•m "B·∫Øt ƒë·∫ßu vi·∫øt truy·ªán" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
            </div>
        </div>

        <div id="tab-stories" class="tab-content">
            <div class="card">
                <h3>üìö Th∆∞ vi·ªán truy·ªán</h3>
                <p>Nh·ªØng truy·ªán ƒë√£ ƒë∆∞·ª£c t·∫°o v√† l∆∞u tr·ªØ</p>
                
                <div id="storiesLibrary">
                    <p>Ch∆∞a c√≥ truy·ªán n√†o trong th∆∞ vi·ªán.</p>
                </div>
                
                <button class="btn btn-secondary" id="loadStoriesBtn" onclick="loadStories()">
                    üîÑ T·∫£i danh s√°ch truy·ªán
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
                
                <div class="toggle-container">
                    <span>T·ª± ƒë·ªông l∆∞u ti·∫øn ƒë·ªô</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveResults" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span>G·ª≠i d·ªØ li·ªáu c·∫£i thi·ªán AI</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sendImprovementData" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="clearCache()">
                    üóëÔ∏è X√≥a d·ªØ li·ªáu t·∫°m
                </button>
                
                <button class="btn btn-danger" onclick="handleSignoutClick()">
                    üö™ ƒêƒÉng xu·∫•t
                </button>
            </div>
            
            <div class="card">
                <h3>‚ÑπÔ∏è Th√¥ng tin ·ª©ng d·ª•ng</h3>
                <p>Phi√™n b·∫£n: 2.2.0</p>
                <p>Ph√¢n t√≠ch n√¢ng cao: H·ªôi tho·∫°i, T·ª´ nh·∫°y c·∫£m, N·ªôi dung 18+</p>
                <p>L∆∞u tr·ªØ: C√≥ th·ªÉ t·∫£i xu·ªëng v√† t·∫£i l√™n d·ªØ li·ªáu</p>
                <p>G√≥c nh√¨n: Linh ho·∫°t theo ph√¢n t√≠ch</p>
            </div>
        </div>
    </div>

    <div class="bottom-menu">
        <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">
            <div class="menu-icon">üîç</div>
            <span>Ph√¢n t√≠ch</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-write')">
            <div class="menu-icon">‚úçÔ∏è</div>
            <span>Vi·∫øt truy·ªán</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-stories')">
            <div class="menu-icon">üìö</div>
            <span>Th∆∞ vi·ªán</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-settings')">
            <div class="menu-icon">‚öôÔ∏è</div>
            <span>C√†i ƒë·∫∑t</span>
        </a>
    </div>

    <script>
        // Google API Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapi_inited = false;
        let gsi_inited = false;

        // Global variables
        let analysisData = [];
        let generatedStories = [];
        let txtFiles = []; // L∆∞u tr·ªØ danh s√°ch file ƒë√£ qu√©t
        let scanData = null; // L∆∞u tr·ªØ d·ªØ li·ªáu qu√©t ƒë·∫ßy ƒë·ªß

        // T·ª´ d·ª´ng ti·∫øng Vi·ªát m·ªü r·ªông
        const vietnameseStopWords = [
            'l√†', 'c·ªßa', 'v√†', 'c√≥', 'm·ªôt', 'ƒë∆∞·ª£c', 'trong', 'kh√¥ng', 'v·ªõi', 't·ª´', 'ƒë·ªÉ', 'ƒë√£', 's·∫Ω',
            'v·ªÅ', 'cho', 'theo', 'nh∆∞', 'khi', 'v√†o', 'ra', 'l√™n', 'xu·ªëng', 'qua', 't·∫°i', 'hay',
            'r·∫±ng', 'n·∫øu', 'm√†', 'th√¨', 'ho·∫∑c', 'nh∆∞ng', 'v√¨', 'n√™n', 'ƒë·∫øn', 'b·∫±ng', 'tr√™n', 'd∆∞·ªõi',
            'gi·ªØa', 'sau', 'tr∆∞·ªõc', 'c√πng', 'c≈©ng', 'ch·ªâ', 'nh·ªØng', 'n√†y', 'ƒë√≥', 'th·∫ø', 'n√†o', 'ai',
            'g√¨', 'ƒë√¢u', 'sao', 'bao', 'l√∫c', 'l·∫°i', 'r·∫•t', 't·∫•t', 'c·∫£', 'm·ªçi', 'b·∫•t', 'cu·ªôc', 'vi·ªác'
        ];

        // T·ª´ nh·∫°y c·∫£m m·ªü r·ªông v·ªõi nhi·ªÅu danh m·ª•c
        const sensitiveWords = {
            romantic: [
                'y√™u', 'th∆∞∆°ng', 'h√¥n', '√¥m', '·∫•p √¥m', '√¢m √°p', 'say ƒë·∫Øm', 'ƒëam m√™', 'd·ªãu d√†ng', 
                'ng·ªçt ng√†o', 'quy·∫øn r≈©', 'm√™ ho·∫∑c', 'th√¢n m·∫≠t', 'g·∫ßn g≈©i', 't√¨nh t·ª©', 'l√£ng m·∫°n',
                'khao kh√°t', 'kh√°t khao', 'nu√¥ng chi·ªÅu', 'c∆∞ng n·ª±ng', 'y√™u th∆∞∆°ng', 'm√™ m·∫£i',
                'si m√™', 'ƒëi√™n cu·ªìng', 'say m√™', 'ƒë·∫Øm ƒëu·ªëi', 'th·ªïn th·ª©c', 'rung ƒë·ªông'
            ],
            intimate: [
                'c·ªüi', 'kh·ªèa th√¢n', 'l√µa th·ªÉ', 'kho·∫£ th√¢n', 'tr·∫ßn tru·ªìng', 'n√≥ng b·ªèng', 'n√≥ng n·ª±c',
                'th√¢n th·ªÉ', 'c∆° th·ªÉ', 'da th·ªãt', 'l√¥ng l√°', 'm·ªãn m√†ng', 'tr∆°n tru', 'sƒÉn ch·∫Øc',
                'ƒë√πi', 'ch√¢n', 'tay', 'c·ªï', 'vai', 'l∆∞ng', 'b·ª•ng', 'ng·ª±c', 'm√°', 'm√¥i', 'h∆°i th·ªü'
            ],
            sexual: [
                'g·ªëi chƒÉn', 'ph√≤ng the', '√¢n √°i', 'l√†m t√¨nh', 'quan h·ªá', 't√¨nh d·ª•c', 'd√¢m', 'd·ª•c',
                'kho√°i c·∫£m', 'k√≠ch th√≠ch', 'sung s∆∞·ªõng', 'c·ª±c kho√°i', 'th·ªèa m√£n', 'd·ª•c v·ªçng',
                'ham mu·ªën', 'th√®m kh√°t', 'khao kh√°t', 'ƒëi√™n d·∫°i', 'cu·ªìng nhi·ªát', 'b√πng ch√°y',
                'r√™n r·ªâ', 'th·ªïn th·ª©c', 'run r·∫©y', 'co gi·∫≠t', 'cƒÉng c·ª©ng', '∆∞·ªõt √°t', 'n√≥ng ran'
            ],
            emotional_negative: [
                'gh√©t', 'h·∫≠n', 'gi·∫≠n', 't·ª©c', 't·ªßi', 'bu·ªìn', 'ƒëau', 'kh·ªï', 's·∫ßu', 'th·∫£m', 'bi',
                'tang', 't·ª≠', 'ch·∫øt', 'gi·∫øt', 'h·∫°i', '√°c', 'd·ªØ', 'hung', 'ƒë·ªôc', 't√†n', 'nh·∫´n',
                'ph·∫´n n·ªô', 'cƒÉm th√π', 'th√π h·∫≠n', 'o√°n h·∫≠n', 'cay ƒë·∫Øng', 'x√≥t xa', 'ƒëau ƒë·ªõn',
                'tuy·ªát v·ªçng', 'ch√°n n·∫£n', 'th·∫•t v·ªçng', 'b·∫•t l·ª±c', 'v√¥ v·ªçng', 'tuy·ªátÊúõ'
            ],
            family_conflict: [
                'b·ªë', 'm·∫π', 'cha', 'con', 'ch·ªìng', 'v·ª£', 'd√¢u', 'r·ªÉ', 'anh', 'ch·ªã', 'em', '√¥ng', 'b√†',
                'ch√∫', 'b√°c', 'c√¥', 'd√¨', 'c·∫≠u', 'm·ª£', 'th√¥ng gia', 'h·ªç h√†ng', 'gia ƒë√¨nh',
                'ph·∫£n b·ªôi gia ƒë√¨nh', 'l·ª´a d·ªëi gia ƒë√¨nh', 'b√™ b·ªëi gia ƒë√¨nh', 'scandal gia ƒë√¨nh'
            ],
            secret_affair: [
                'b√≠ m·∫≠t', 'gi·∫•u gi·∫øm', 'che gi·∫•u', 'gi·∫•u di·∫øm', 'l√©n l√∫t', 'v·ª•ng tr·ªôm', '√¢m th·∫ßm',
                'l·∫∑ng l·∫Ω', 'k√≠n ƒë√°o', 'ri√™ng t∆∞', 'ngo·∫°i t√¨nh', 't√¨nh nh√¢n', 'b·ªì nh√≠', 'ti·ªÉu tam',
                'th·ª© ba', 'chen ch√¢n', 'ph√° ho·∫°i', 'c∆∞·ªõp ch·ªìng', 'c∆∞·ªõp v·ª£', 'l·ª´a d·ªëi'
            ],
            violence: [
                'ƒë√°nh', 'ƒë·∫≠p', 't√°t', 'ÎïåÎ¶¨Îã§', 'b·∫°o l·ª±c', 'b·∫°o h√†nh', 'h√†nh h·∫°', 'tra t·∫•n',
                'd√≠ d·ªèm', '√©p bu·ªôc', 'c∆∞·ª°ng b·ª©c', 'c∆∞·ª°ng ch·∫ø', 'uy hi·∫øp', 'ƒëe d·ªça',
                'm√°u', 'ch·∫£y m√°u', 'ƒë·∫´m m√°u', 'th∆∞∆°ng t√≠ch', 'v·∫øt th∆∞∆°ng'
            ],
            adult_explicit: [
                'ƒë·ªãt', 'ƒë·ª•', 'ch·ªãch', 'doggy', 'blowjob', 'oral', 'anal', 'hardcore',
                'cumshot', 'creampie', 'fingering', 'masturbate', 'orgasm', 'climax',
                'penetrate', 'thrust', 'moan', 'scream', 'wet', 'tight', 'hard', 'soft',
                'lick', 'suck', 'kiss', 'bite', 'squeeze', 'grab', 'touch', 'feel',
                'pussy', 'cock', 'dick', 'tits', 'boobs', 'ass', 'butt', 'hole',
                'l·ªìn', 'c·∫∑c', 'cu', 'v√∫', 'ƒë√≠t', 'm√¥ng', 'n√∫m v√∫', '√¢m ƒë·∫°o', 'd∆∞∆°ng v·∫≠t'
            ]
        };

        // T·ª´ c·∫£m x√∫c m·ªü r·ªông
        const emotionalWords = {
            positive: [
                'vui', 'h·∫°nh ph√∫c', 'y√™u', 'th∆∞∆°ng', 'tuy·ªát v·ªùi', 'ƒë·∫πp', 't·ªët', 'xu·∫•t s·∫Øc', 
                'th√†nh c√¥ng', 'hy v·ªçng', 'ph·∫•n kh√≠ch', 'h√†o h·ª©ng', 't·ª± h√†o', 'm√£n nguy·ªán',
, 'i');
                const match = sentence.match(regex);
                if (match && match[1].length > 10) {
                    return {
                        text: match[1].trim().replace(/["'¬ª¬´]/g, ''),
                        hasQuotes: false,
                        hasIndicator: true
                    };
                }
            }
            
            return null;
        }

        function extractSpeaker(sentence) {
            // T√¨m ng∆∞·ªùi n√≥i trong c√¢u
            const speakerPattern = /([A-Z√Ä-·ª∏][a-z√†-·ªπ]+)\s+(?:n√≥i|b·∫£o|h·ªèi|ƒë√°p|th∆∞a|k√™u)/i;
            const match = sentence.match(speakerPattern);
            return match ? match[1] : 'Kh√¥ng r√µ';
        }

        function analyzeDialogueEmotion(dialogueText) {
            const text = dialogueText.toLowerCase();
            
            const positiveWords = emotionalWords.positive.filter(word => text.includes(word));
            const negativeWords = emotionalWords.negative.filter(word => text.includes(word));
            
            if (positiveWords.length > negativeWords.length) return 't√≠ch c·ª±c';
            if (negativeWords.length > positiveWords.length) return 'ti√™u c·ª±c';
            return 'trung t√≠nh';
        }

        // PH√ÇN T√çCH T·ª™ NH·∫†Y C·∫¢M N√ÇNG CAO
        function analyzeSensitiveContentAdvanced(content) {
            const sensitiveResults = {};
            const contentLower = content.toLowerCase();
            let totalSensitiveWords = 0;
            
            for (const [category, words] of Object.entries(sensitiveWords)) {
                const foundWords = {};
                const contexts = [];
                
                for (const word of words) {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    const matches = contentLower.match(regex);
                    if (matches) {
                        foundWords[word] = matches.length;
                        totalSensitiveWords += matches.length;
                        
                        // L·∫•y ng·ªØ c·∫£nh xung quanh t·ª´ nh·∫°y c·∫£m
                        const wordIndex = contentLower.indexOf(word);
                        if (wordIndex !== -1 && contexts.length < 3) {
                            const context = content.substring(
                                Math.max(0, wordIndex - 30),
                                Math.min(content.length, wordIndex + word.length + 30)
                            );
                            contexts.push(context);
                        }
                    }
                }
                
                if (Object.keys(foundWords).length > 0) {
                    sensitiveResults[category] = {
                        words: foundWords,
                        count: Object.values(foundWords).reduce((a, b) => a + b, 0),
                        contexts: contexts
                    };
                }
            }
            
            const sensitivityLevel = calculateSensitivityLevel(totalSensitiveWords, content.length);
            const riskLevel = determineRiskLevel(sensitiveResults);
            
            return {
                totalSensitiveWords: totalSensitiveWords,
                categories: sensitiveResults,
                sensitivityScore: calculateSensitivityScore(totalSensitiveWords, content.length),
                sensitivityLevel: sensitivityLevel,
                riskLevel: riskLevel,
                hasAdultContent: Object.keys(sensitiveResults).some(cat => 
                    ['sexual', 'adult_explicit', 'intimate'].includes(cat))
            };
        }

        function calculateSensitivityLevel(sensitiveWordCount, totalCharacters) {
            if (totalCharacters === 0) return 'Th·∫•p';
            const ratio = (sensitiveWordCount / (totalCharacters / 1000));
            
            if (ratio > 5) return 'R·∫•t cao';
            if (ratio > 3) return 'Cao';
            if (ratio > 1) return 'Trung b√¨nh';
            return 'Th·∫•p';
        }

        function determineRiskLevel(sensitiveResults) {
            const highRiskCategories = ['sexual', 'adult_explicit', 'violence'];
            const hasHighRisk = Object.keys(sensitiveResults).some(cat => 
                highRiskCategories.includes(cat));
            
            if (hasHighRisk) return 'Cao';
            if (Object.keys(sensitiveResults).length > 3) return 'Trung b√¨nh';
            return 'Th·∫•p';
        }

        // PH√ÇN T√çCH B·ªêI C·∫¢NH
        function analyzeContext(content) {
            const contextAnalysis = {};
            const contentLower = content.toLowerCase();
            
            Object.entries(contextWords).forEach(([category, words]) => {
                const foundWords = {};
                let totalCount = 0;
                
                words.forEach(word => {
                    const count = (contentLower.match(new RegExp(`\\b${word}\\b`, 'g')) || []).length;
                    if (count > 0) {
                        foundWords[word] = count;
                        totalCount += count;
                    }
                });
                
                if (totalCount > 0) {
                    contextAnalysis[category] = {
                        words: foundWords,
                        count: totalCount
                    };
                }
            });
            
            return {
                contexts: contextAnalysis,
                primarySetting: determinePrimarySetting(contextAnalysis),
                timeOfDay: determineTimeOfDay(contextAnalysis),
                atmosphere: determineAtmosphere(content)
            };
        }

        function determinePrimarySetting(contextAnalysis) {
            if (!contextAnalysis.location) return 'Kh√¥ng r√µ';
            
            const locationWords = contextAnalysis.location.words;
            const mostCommon = Object.entries(locationWords)
                .sort(([,a], [,b]) => b - a)[0];
            
            return mostCommon ? mostCommon[0] : 'Kh√¥ng r√µ';
        }

        function determineTimeOfDay(contextAnalysis) {
            if (!contextAnalysis.time) return 'Kh√¥ng r√µ';
            
            const timeWords = contextAnalysis.time.words;
            const mostCommon = Object.entries(timeWords)
                .sort(([,a], [,b]) => b - a)[0];
            
            return mostCommon ? mostCommon[0] : 'Kh√¥ng r√µ';
        }

        function determineAtmosphere(content) {
            const darkWords = ['t·ªëi', 'u √°m', '√¢m th·∫ßm', 'b√≠ m·∫≠t', 'l√©n l√∫t', 's·ª£ h√£i'];
            const lightWords = ['s√°ng', 't∆∞∆°i', 'vui', 'h·∫°nh ph√∫c', 'y√™n b√¨nh'];
            
            const contentLower = content.toLowerCase();
            const darkCount = darkWords.reduce((count, word) => 
                count + (contentLower.match(new RegExp(word, 'g')) || []).length, 0);
            const lightCount = lightWords.reduce((count, word) => 
                count + (contentLower.match(new RegExp(word, 'g')) || []).length, 0);
            
            if (darkCount > lightCount) return 'U √°m';
            if (lightCount > darkCount) return 'T√≠ch c·ª±c';
            return 'Trung t√≠nh';
        }

        // PH√ÇN T√çCH N·ªòI DUNG 18+
        function analyzeAdultContent(content) {
            const contentLower = content.toLowerCase();
            const adultWords = sensitiveWords.adult_explicit;
            const sexualWords = sensitiveWords.sexual;
            const intimateWords = sensitiveWords.intimate;
            
            const adultContent = {};
            let totalAdultWords = 0;
            const adultContexts = [];
            
            [...adultWords, ...sexualWords, ...intimateWords].forEach(word => {
                const count = (contentLower.match(new RegExp(`\\b${word}\\b`, 'g')) || []).length;
                if (count > 0) {
                    adultContent[word] = count;
                    totalAdultWords += count;
                    
                    // L·∫•y ng·ªØ c·∫£nh
                    const wordIndex = contentLower.indexOf(word);
                    if (wordIndex !== -1 && adultContexts.length < 3) {
                        const context = content.substring(
                            Math.max(0, wordIndex - 50),
                            Math.min(content.length, wordIndex + word.length + 50)
                        );
                        adultContexts.push({
                            word: word,
                            context: context
                        });
                    }
                }
            });
            
            const adultLevel = determineAdultContentLevel(totalAdultWords);
            
            return {
                hasAdultContent: totalAdultWords > 0,
                adultWords: adultContent,
                totalAdultWords: totalAdultWords,
                adultLevel: adultLevel,
                contexts: adultContexts,
                warningRequired: totalAdultWords > 5
            };
        }

        function determineAdultContentLevel(adultWordCount) {
            if (adultWordCount === 0) return 'Kh√¥ng c√≥';
            if (adultWordCount < 3) return 'Nh·∫π';
            if (adultWordCount < 10) return 'Trung b√¨nh';
            if (adultWordCount < 20) return 'Cao';
            return 'R·∫•t cao';
        }

        function analyzeNarrativeStructure(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim());
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            return {
                structure: analyzeThreeActStructure(paragraphs),
                pacing: analyzePacing(paragraphs),
                climax: identifyClimax(content),
                narrativeStyle: determineNarrativeStyle(content)
            };
        }

        function analyzeThreeActStructure(paragraphs) {
            const act1End = Math.floor(paragraphs.length * 0.25);
            const act2End = Math.floor(paragraphs.length * 0.75);
            
            return {
                act1: {
                    paragraphs: act1End,
                    percentage: '25%',
                    description: 'M·ªü ƒë·∫ßu, gi·ªõi thi·ªáu'
                },
                act2: {
                    paragraphs: act2End - act1End,
                    percentage: '50%',
                    description: 'Ph√°t tri·ªÉn, xung ƒë·ªôt'
                },
                act3: {
                    paragraphs: paragraphs.length - act2End,
                    percentage: '25%',
                    description: 'Cao tr√†o, k·∫øt th√∫c'
                }
            };
        }

        function analyzePacing(paragraphs) {
            const avgParagraphLength = paragraphs.reduce((sum, p) => 
                sum + p.split(/\s+/).length, 0) / paragraphs.length;
            
            return {
                averageParagraphLength: Math.round(avgParagraphLength),
                pacing: avgParagraphLength > 100 ? 'Ch·∫≠m' : 
                        avgParagraphLength > 50 ? 'V·ª´a ph·∫£i' : 'Nhanh'
            };
        }

        function identifyClimax(content) {
            const climaxIndicators = [
                'ƒë·ªôt nhi√™n', 'b·∫•t ng·ªù', 'l√∫c n√†y', 'cu·ªëi c√πng', 'quy·∫øt ƒë·ªãnh', 
                'quan tr·ªçng nh·∫•t', 'kh√¥ng th·ªÉ', 'ph·∫£i', 'tuy·ªát ƒë·ªëi'
            ];
            const sentences = content.split(/[.!?]+/);
            
            let climaxSentence = '';
            let maxIndicators = 0;
            
            sentences.forEach(sentence => {
                const indicatorCount = climaxIndicators.reduce((count, indicator) => {
                    return count + (sentence.toLowerCase().includes(indicator) ? 1 : 0);
                }, 0);
                
                if (indicatorCount > maxIndicators && sentence.trim().length > 20) {
                    maxIndicators = indicatorCount;
                    climaxSentence = sentence.trim();
                }
            });
            
            return {
                identified: climaxSentence.length > 0,
                sentence: climaxSentence.substring(0, 300) + (climaxSentence.length > 300 ? '...' : ''),
                indicators: maxIndicators
            };
        }

        function determineNarrativeStyle(content) {
            const firstPersonIndicators = ['t√¥i', 'm√¨nh', 'em', 'anh'];
            const thirdPersonIndicators = ['c√¥ ·∫•y', 'anh ·∫•y', 'h·ªç', 'ng∆∞·ªùi'];
            
            const contentLower = content.toLowerCase();
            const firstPersonCount = firstPersonIndicators.reduce((count, indicator) => 
                count + (contentLower.match(new RegExp(`\\b${indicator}\\b`, 'g')) || []).length, 0);
            const thirdPersonCount = thirdPersonIndicators.reduce((count, indicator) => 
                count + (contentLower.match(new RegExp(`\\b${indicator}\\b`, 'g')) || []).length, 0);
            
            if (firstPersonCount > thirdPersonCount * 2) return 'Ng√¥i th·ª© nh·∫•t';
            if (thirdPersonCount > firstPersonCount) return 'Ng√¥i th·ª© ba';
            return 'H·ªón h·ª£p';
        }

        // Utility functions
        function determineOverallTone(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const neutral = emotionAnalysis.neutral?.count || 0;
            
            if (positive > negative && positive > neutral) return 'T√≠ch c·ª±c';
            if (negative > positive && negative > neutral) return 'Ti√™u c·ª±c';
            return 'Trung t√≠nh';
        }

        function calculateSentimentScore(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const total = positive + negative;
            
            if (total === 0) return 0;
            return ((positive - negative) / total * 100).toFixed(1);
        }

        function findDominantEmotion(emotionAnalysis) {
            let maxCount = 0;
            let dominantEmotion = 'Kh√¥ng r√µ';
            
            Object.entries(emotionAnalysis).forEach(([emotion, data]) => {
                if (data.count > maxCount) {
                    maxCount = data.count;
                    dominantEmotion = emotion;
                }
            });
            
            return dominantEmotion;
        }

        function calculateEmotionalIntensity(emotionAnalysis) {
            const totalEmotions = Object.values(emotionAnalysis)
                .reduce((sum, data) => sum + data.count, 0);
            
            if (totalEmotions < 5) return 'Th·∫•p';
            if (totalEmotions < 15) return 'Trung b√¨nh';
            if (totalEmotions < 30) return 'Cao';
            return 'R·∫•t cao';
        }

        function calculateSensitivityScore(sensitiveWordCount, totalCharacters) {
            if (totalCharacters === 0) return 0;
            const ratio = (sensitiveWordCount / (totalCharacters / 1000));
            return Math.min(10, Math.round(ratio * 10) / 10);
        }

        // STORY GENERATION - N√ÇNG CAP V·ªöI N·ªòI DUNG 18+
        async function generateStories() {
            if (analysisData.length === 0) {
                alert('Vui l√≤ng ph√¢n t√≠ch file tr∆∞·ªõc khi t·∫°o truy·ªán!');
                return;
            }
            
            updateWriteStatus('‚úçÔ∏è B·∫Øt ƒë·∫ßu vi·∫øt truy·ªán...', 'Chu·∫©n b·ªã d·ªØ li·ªáu v√† √Ω t∆∞·ªüng');
            updateWriteProgress(5);
            
            try {
                const minChapters = parseInt(document.getElementById('minChapters').value) || 50;
                const sensitivityLevel = parseInt(document.getElementById('sensitivityLevel').value) || 5;
                const includeAdultContent = document.getElementById('includeAdultContent').checked;
                
                const storyTitle = generateStoryTitle(analysisData, includeAdultContent);
                updateWriteStatus(`üìñ ƒêang vi·∫øt: "${storyTitle}"`, `K·∫ø ho·∫°ch ${minChapters} ch∆∞∆°ng`);
                updateWriteProgress(10);
                
                const mainPlot = generateMainPlot(analysisData, includeAdultContent);
                
                const chapters = [];
                for (let i = 1; i <= minChapters; i++) {
                    updateWriteProgress(10 + (i / minChapters) * 80);
                    updateWriteStatus(`üìñ ƒêang vi·∫øt ch∆∞∆°ng ${i}/${minChapters}`, `"${storyTitle}"`);
                    
                    const chapterTitle = generateChapterTitle(i, mainPlot, analysisData, includeAdultContent);
                    const chapterContent = generateChapterContent(i, chapterTitle, mainPlot, analysisData, sensitivityLevel, includeAdultContent);
                    
                    chapters.push({
                        number: i,
                        title: chapterTitle,
                        content: chapterContent,
                        wordCount: chapterContent.split(/\s+/).length,
                        hasAdultContent: includeAdultContent && (i % 5 === 0 || Math.random() < 0.3)
                    });
                    
                    if (i === 1 || i % 10 === 0 || i === minChapters) {
                        displayLatestChapter(storyTitle, chapters[chapters.length - 1], includeAdultContent);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 150));
                }
                
                const generatedStory = {
                    title: storyTitle,
                    chapters: chapters,
                    generatedAt: new Date().toISOString(),
                    basedOnAnalysis: analysisData.length,
                    totalWords: chapters.reduce((sum, ch) => sum + ch.wordCount, 0),
                    hasAdultContent: includeAdultContent,
                    sensitivityLevel: sensitivityLevel
                };
                
                generatedStories.push(generatedStory);
                displayGeneratedStories();
                
                updateWriteProgress(95);
                updateWriteStatus(`‚úÖ ƒê√£ ho√†n th√†nh: "${storyTitle}"`, 
                    `${minChapters} ch∆∞∆°ng, ${generatedStory.totalWords} t·ª´${includeAdultContent ? ' (18+)' : ''}`);
                
                updateWriteProgress(100);
                setTimeout(() => updateWriteProgress(0), 2000);
                
            } catch (error) {
                console.error('Error generating stories:', error);
                updateWriteStatus(`‚ùå L·ªói khi vi·∫øt truy·ªán: ${error.message}`, '');
                updateWriteProgress(0);
            }
        }

        function generateStoryTitle(analysisData, includeAdultContent) {
            const normalTitles = [
                `B√≥ng T·ªëi Trong Gia ƒê√¨nh`,
                `M·ªëi T√¨nh Oan Nghi·ªát`,
                `S·ª± Th·∫≠t ƒêau L√≤ng Sau C√°nh C·ª≠a`,
                `Ng∆∞·ªùi Cha V√† Con D√¢u`,
                `M·∫•t M√°t Trong Im L·∫∑ng`,
                `Tr√°i Tim Ng∆∞·ªùi Ch·ªìng`,
                `M·ªëi T√¨nh C·∫•m ƒêo√°n`,
                `Nh·ªØng Gi·∫•u Gi·∫øm ƒêau ƒê·ªõn`,
                `S·ª± Ph·∫£n B·ªôi Th·∫ßm L·∫∑ng`,
                `Gia ƒê√¨nh Kh√¥ng Tr·ªçn V·∫πn`
            ];
            
            const adultTitles = [
                `ƒêam M√™ C·∫•m ƒêo√°n`,
                `L·ª≠a Y√™u Thi√™u ƒê·ªët`,
                `Cu·ªìng Nhi·ªát Trong ƒê√™m`,
                `Khao Kh√°t B√≠ M·∫≠t`,
                `ƒê√™m Nay Em L√† C·ªßa Anh`,
                `C∆° Th·ªÉ V√† T√¢m H·ªìn`,
                `N√≥ng B·ªèng T·ª´ng ƒê√™m`,
                `Ham Mu·ªën Kh√¥ng Ki·ªÉm So√°t`,
                `T√¨nh D·ª•c V√† T√¨nh Y√™u`,
                `Kho√°i C·∫£m T·ªôt ƒê·ªô`
            ];
            
            const titles = includeAdultContent ? adultTitles : normalTitles;
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function generateMainPlot(analysisData, includeAdultContent) {
            const emotionalTone = determineOverallEmotionalToneFromAnalysis(analysisData);
            const commonThemes = findCommonThemes(analysisData);
            const commonCharacters = findCommonCharacters(analysisData);
            const averageSensitivity = calculateAverageSensitivity(analysisData);
            
            return {
                themes: commonThemes.slice(0, 3),
                mainCharacters: commonCharacters.slice(0, 3),
                emotionalTone: emotionalTone,
                conflict: {
                    type: includeAdultContent ? 't√¨nh d·ª•c v√† t√¨nh c·∫£m' : 't√¨nh c·∫£m gia ƒë√¨nh',
                    intensity: averageSensitivity > 5 ? 'cao' : 'trung b√¨nh',
                    resolution: 'ph·ª©c t·∫°p'
                },
                sensitivity: averageSensitivity,
                includeAdultContent: includeAdultContent
            };
        }

        function determineOverallEmotionalToneFromAnalysis(analysisData) {
            let positive = 0, negative = 0, neutral = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    positive += analysis.emotionalAnalysis.emotionBreakdown.positive?.count || 0;
                    negative += analysis.emotionalAnalysis.emotionBreakdown.negative?.count || 0;
                    neutral += analysis.emotionalAnalysis.emotionBreakdown.neutral?.count || 0;
                }
            });
            
            if (negative > positive && negative > neutral) return 'negative';
            if (positive > negative && positive > neutral) return 'positive';
            return 'neutral';
        }

        function findCommonThemes(analysisData) {
            const allThemes = {};
            analysisData.forEach(analysis => {
                if (analysis.thematicAnalysis && analysis.thematicAnalysis.mainThemes) {
                    analysis.thematicAnalysis.mainThemes.forEach(theme => {
                        allThemes[theme.theme] = (allThemes[theme.theme] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allThemes)
                .sort(([,a], [,b]) => b - a)
                .map(([theme]) => theme);
        }

        function findCommonCharacters(analysisData) {
            const allCharacters = {};
            analysisData.forEach(analysis => {
                if (analysis.characterAnalysis && analysis.characterAnalysis.characters) {
                    analysis.characterAnalysis.characters.forEach(character => {
                        allCharacters[character.name] = (allCharacters[character.name] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allCharacters)
                .sort(([,a], [,b]) => b - a)
                .map(([character]) => character);
        }

        function calculateAverageSensitivity(analysisData) {
            let totalSensitivity = 0;
            let count = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis) {
                    totalSensitivity += analysis.sensitiveAnalysis.sensitivityScore || 0;
                    count++;
                }
            });
            
            return count > 0 ? totalSensitivity / count : 0;
        }

        function generateChapterTitle(chapterNumber, mainPlot, analysisData, includeAdultContent) {
            const normalTemplates = [
                `Kh√∫c D·∫°o ƒê·∫ßu Bu·ªìn`,
                `Nh·ªØng Nghi Ng·ªù ƒê·∫ßu Ti√™n`,
                `D·∫•u Hi·ªáu C·ªßa S·ª± D·ªëi Tr√°`,
                `Cu·ªôc Ch·∫°m Tr√°n B·∫•t Ng·ªù`,
                `S·ª± Th·∫≠t Ph≈© Ph√†ng`,
                `N·ªói ƒêau Kh√¥ng Th·ªÉ N√≥i`,
                `L·ª±a Ch·ªçn Kh√≥ KhƒÉn`,
                `S·ªëng Trong D·ªëi Tr√°`,
                `Kho·∫£nh Kh·∫Øc Y·∫øu L√≤ng`,
                `Im L·∫∑ng L√† V√†ng`,
                `Tr√°i Tim Tan V·ª°`,
                `Ng√†y Th√°ng D√†i`,
                `Quy·∫øt ƒê·ªãnh Cu·ªëi C√πng`,
                `L·ªùi T·ª´ Bi·ªát`,
                `B√¨nh Minh C√¥ ƒê∆°n`
            ];
            
            const adultTemplates = [
                `ƒê√™m ƒê·∫ßu Ti√™n`,
                `C∆°n Kh√°t Kh√¥ng D·∫≠p T·∫Øt`,
                `L√†n Da N√≥ng B·ªèng`,
                `Ham Mu·ªën B√πng Ch√°y`,
                `Cu·ªìng Nhi·ªát Trong T·ªëi`,
                `Kho√°i C·∫£m T·ªôt ƒê·ªô`,
                `Th√¢n Th·ªÉ V√† T√¢m H·ªìn`,
                `ƒêam M√™ Kh√¥ng Ki·ªÅm Ch·∫ø`,
                `L·∫ßn ƒê·∫ßu Ti√™n Em`,
                `N√≥ng N·ª±c C·∫£ ƒê√™m`,
                `T√¨nh D·ª•c V√† Y√™u Th∆∞∆°ng`,
                `C·ª±c Kho√°i Trong ƒê√™m`,
                `Cu·ªôc Y√™u ƒêi√™n D·∫°i`,
                `Sung S∆∞·ªõng T·ªôt B·∫≠c`,
                `Ho√†n H·ªìn C√πng Anh`
            ];
            
            const templates = includeAdultContent ? adultTemplates : normalTemplates;
            const templateIndex = chapterNumber % templates.length;
            return `Ch∆∞∆°ng ${chapterNumber}: ${templates[templateIndex]}`;
        }

        function generateChapterContent(chapterNumber, chapterTitle, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            let content = `# ${chapterTitle}\n\n`;
            
            const paragraphs = 6 + Math.floor(Math.random() * 4);
            
            for (let i = 0; i < paragraphs; i++) {
                content += generateParagraph(chapterNumber, i, paragraphs, mainPlot, analysisData, sensitivityLevel, includeAdultContent) + '\n\n';
            }
            
            return content;
        }

        function generateParagraph(chapterNumber, paragraphIndex, totalParagraphs, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            const sentences = 3 + Math.floor(Math.random() * 3);
            let paragraph = '';
            
            for (let i = 0; i < sentences; i++) {
                paragraph += generateSentence(chapterNumber, paragraphIndex, totalParagraphs, i, sentences, mainPlot, analysisData, sensitivityLevel, includeAdultContent);
                if (i < sentences - 1) paragraph += ' ';
            }
            
            return paragraph;
        }

        function generateSentence(chapterNumber, paragraphIndex, totalParagraphs, sentenceIndex, totalSentences, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            const sensitiveWordsList = extractSensitiveWordsFromAnalysis(analysisData);
            const dialogues = extractDialoguesFromAnalysis(analysisData);
            
            let sentenceTemplates = [];
            
            if (includeAdultContent && sensitivityLevel > 6) {
                sentenceTemplates = [
                    `T√¥i c·∫£m nh·∫≠n ƒë∆∞·ª£c h∆°i th·ªü n√≥ng c·ªßa ${mainPlot.mainCharacters[0] || 'c√¥ ·∫•y'} tr√™n l√†n da m√¨nh.`,
                    `ƒê√¥i tay c·ªßa t√¥i run r·∫©y khi ch·∫°m v√†o c∆° th·ªÉ m·ªÅm m·∫°i c·ªßa ${mainPlot.mainCharacters[1] || 'em'}.`,
                    `Ti·∫øng r√™n r·ªâ nh·∫π nh√†ng c·ªßa em khi·∫øn m√°u t√¥i s√¥i s·ª•c trong huy·∫øt qu·∫£n.`,
                    `Ch√∫ng t√¥i h√≤a quy·ªán trong nhau nh∆∞ hai d√≤ng s√¥ng cu·ªìn cu·ªôn ch·∫£y v·ªÅ bi·ªÉn.`,
                    `Em b√© nh·ªè trong v√≤ng tay t√¥i, nh·ªØng ti·∫øng th·ªü d·ªëc c·ªßa em khi·∫øn t√¥i ƒëi√™n cu·ªìng.`,
                    `CƒÉn ph√≤ng t·ªëi ch·ªâ c√≤n ti·∫øng th·ªü g·∫•p c·ªßa ƒë√¥i ta v√† ti·∫øng tim ƒë·∫≠p th√¨nh th·ªãch.`,
                    `T√¥i h√¥n l√™n t·ª´ng inch da th·ªãt c·ªßa em, t·ª´ c·ªï xu·ªëng vai, r·ªìi xu·ªëng th·∫•p h∆°n.`,
                    `Em si·∫øt ch·∫∑t t√¥i, m√≥ng tay c√†o v√†o l∆∞ng t√¥i khi·∫øn t√¥i c·∫£m th·∫•y ƒëau ƒë·ªõn m√† kho√°i c·∫£m.`,
                    `"Anh y√™u... em mu·ªën..." em th√¨ th·∫ßm v√†o tai t√¥i b·∫±ng gi·ªçng run r·∫©y.`,
                    `Ch√∫ng t√¥i c√πng l√™n ƒë·ªânh trong s·ª± cu·ªìng nhi·ªát kh√¥ng th·ªÉ ki·ªÉm so√°t.`
                ];
            } else if (includeAdultContent) {
                sentenceTemplates = [
                    `√Ånh m·∫Øt ${mainPlot.mainCharacters[0] || 'c√¥ ·∫•y'} nh√¨n t√¥i ƒë·∫ßy khao kh√°t v√† ham mu·ªën.`,
                    `T√¥i c·∫£m nh·∫≠n ƒë∆∞·ª£c s·ª©c h√∫t m·∫°nh m·∫Ω t·ª´ ${mainPlot.mainCharacters[1] || 'em'} m√† kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i.`,
                    `Nh·ªØng c√°i ch·∫°m tay t∆∞·ªüng ch·ª´ng v√¥ t√¨nh nh∆∞ng l·∫°i l√†m tim t√¥i rung ƒë·ªông.`,
                    `Em nh√¨n t√¥i v·ªõi ƒë√¥i m·∫Øt ∆∞·ªõt √°t, ƒë·∫ßy √Ω nghƒ©a m√† t√¥i hi·ªÉu ngay.`,
                    `Kh√¥ng kh√≠ trong ph√≤ng d·∫ßn tr·ªü n√™n n√≥ng b·ªèng v√† cƒÉng th·∫≥ng.`,
                    `T√¥i bi·∫øt r·∫±ng ch√∫ng ta ƒëang v∆∞·ª£t qua ranh gi·ªõi m√† kh√¥ng n√™n v∆∞·ª£t.`,
                    `C·∫£m gi√°c c√≥ em trong v√≤ng tay th·∫≠t ·∫•m √°p v√† t·ª± nhi√™n ƒë·∫øn l·∫°.`,
                    `"Em y√™u anh..." c√¢u n√≥i ·∫•y nh∆∞ m·ªôt l·ªùi th√∫ t·ªôi ƒë·∫ßy t·ªôi l·ªói.`,
                    `Ch√∫ng t√¥i bi·∫øt ƒëi·ªÅu n√†y sai tr√°i nh∆∞ng kh√¥ng th·ªÉ d·ª´ng l·∫°i.`,
                    `ƒê√™m nay s·∫Ω thay ƒë·ªïi m·ªçi th·ª© gi·ªØa ch√∫ng ta m√£i m√£i.`
                ];
            } else {
                sentenceTemplates = [
                    `T√¥i nh√¨n th·∫•y ${mainPlot.mainCharacters[0] || 'b·ªë'} v√† ${mainPlot.mainCharacters[1] || 'v·ª£ t√¥i'} trao ƒë·ªïi √°nh m·∫Øt m√† kh√¥ng d√°m l√™n ti·∫øng.`,
                    `Tr√°i tim t√¥i ƒëau nh√≥i khi ch·ª©ng ki·∫øn c·∫£nh t∆∞·ª£ng ƒë√≥ nh∆∞ng kh√¥ng th·ªÉ l√†m g√¨.`,
                    `M·ªói l·∫ßn th·∫•y h·ªç g·∫ßn nhau, l√≤ng t√¥i l·∫°i qu·∫∑n th·∫Øt v√¨ ghen tu√¥ng v√† t·ªßi nh·ª•c.`,
                    `T√¥i t·ª± h·ªèi m√¨nh ƒë√£ l√†m g√¨ sai ƒë·ªÉ ph·∫£i ch·ªãu ƒë·ª±ng s·ª± ph·∫£n b·ªôi n√†y.`,
                    `ƒê√™m nay l·∫°i m·ªôt ƒë√™m d√†i tr·∫±n tr·ªçc v·ªõi nh·ªØng suy nghƒ© mi√™n man.`,
                    `T√¥i mu·ªën h√©t l√™n cho c·∫£ th·∫ø gi·ªõi bi·∫øt s·ª± th·∫≠t, nh∆∞ng l·∫°i im l·∫∑ng.`,
                    `Gia ƒë√¨nh - hai ti·∫øng ·∫•y gi·ªù ƒë√¢y tr·ªü n√™n th·∫≠t xa l·∫° v√† gi·∫£ d·ªëi.`,
                    `T√¥i th·∫•y m√¨nh th·∫≠t b·∫•t l·ª±c, kh√¥ng d√°m ƒë·ªëi m·∫∑t v·ªõi s·ª± th·∫≠t ph≈© ph√†ng.`,
                    `N·ª• c∆∞·ªùi c·ªßa v·ª£ t√¥i v·ªõi b·ªë t√¥i sao c√≥ th·ªÉ t∆∞∆°i ƒë·∫øn th·∫ø?`,
                    `Im l·∫∑ng c√≥ ph·∫£i l√† v√†ng? Hay t√¥i ch·ªâ ƒëang h√®n nh√°t?`
                ];
            }
            
            const templateIndex = (chapterNumber + paragraphIndex + sentenceIndex) % sentenceTemplates.length;
            let sentence = sentenceTemplates[templateIndex];
            
            // Th√™m t·ª´ nh·∫°y c·∫£m n·∫øu c√≥
            if (sensitiveWordsList.length > 0 && Math.random() < (sensitivityLevel / 15)) {
                const sensitiveWord = sensitiveWordsList[Math.floor(Math.random() * sensitiveWordsList.length)];
                sentence = sentence.replace('.', ` ${sensitiveWord}.`);
            }
            
            // Th√™m h·ªôi tho·∫°i
            if (dialogues.length > 0 && Math.random() < 0.25) {
                const dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
                sentence += ` T√¥i nghe th·∫•y: "${dialogue}"`;
            }
            
            return sentence;
        }

        function extractSensitiveWordsFromAnalysis(analysisData) {
            const words = [];
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis && analysis.sensitiveAnalysis.categories) {
                    for (const category of Object.values(analysis.sensitiveAnalysis.categories)) {
                        for (const word of Object.keys(category.words)) {
                            if (!words.includes(word)) {
                                words.push(word);
                            }
                        }
                    }
                }
            });
            
            return words;
        }

        function extractDialoguesFromAnalysis(analysisData) {
            const dialogues = [];
            
            analysisData.forEach(analysis => {
                if (analysis.dialogueAnalysis && analysis.dialogueAnalysis.dialogues) {
                    analysis.dialogueAnalysis.dialogues.forEach(dialogue => {
                        if (dialogue.text && dialogue.text.length < 100) {
                            dialogues.push(dialogue.text);
                        }
                    });
                }
            });
            
            return dialogues.slice(0, 20);
        }

        // UI DISPLAY FUNCTIONS
        function displayAdvancedAnalysisResults() {
            const container = document.getElementById('analysisResults');
            container.innerHTML = '';
            
            if (analysisData.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch.</p>';
                return;
            }
            
            // T√≠nh to√°n t·ªïng quan
            let emotionalScore = 0;
            let themeCount = 0;
            let dialogueCount = 0;
            let sensitiveWordCount = 0;
            let adultContentCount = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    emotionalScore += parseFloat(analysis.emotionalAnalysis.sentimentScore) || 0;
                }
                if (analysis.thematicAnalysis) {
                    themeCount += analysis.thematicAnalysis.mainThemes.length;
                }
                if (analysis.dialogueAnalysis) {
                    dialogueCount += analysis.dialogueAnalysis.dialogueCount || 0;
                }
                if (analysis.sensitiveAnalysis) {
                    sensitiveWordCount += analysis.sensitiveAnalysis.totalSensitiveWords || 0;
                }
                if (analysis.adultContentAnalysis) {
                    adultContentCount += analysis.adultContentAnalysis.totalAdultWords || 0;
                }
            });
            
            emotionalScore = (emotionalScore / analysisData.length).toFixed(1);
            
            let html = `
                <div class="status-info">
                    <p>üìä T·ªïng quan ph√¢n t√≠ch ${analysisData.length} file</p>
                    <p>ƒêi·ªÉm c·∫£m x√∫c: ${emotionalScore}%</p>
                    <p>S·ªë ch·ªß ƒë·ªÅ ph√°t hi·ªán: ${themeCount}</p>
                    <p>H·ªôi tho·∫°i ph√°t hi·ªán: ${dialogueCount}</p>
                    <p>T·ª´ nh·∫°y c·∫£m: ${sensitiveWordCount}</p>
                    ${adultContentCount > 0 ? `<p class="adult-content-warning">‚ö†Ô∏è N·ªôi dung 18+: ${adultContentCount} t·ª´</p>` : ''}
                </div>
            `;
            
            // Hi·ªÉn th·ªã c√°c c·∫£m x√∫c ch√≠nh
            const emotionalThemes = analysisData.flatMap(a => 
                a.emotionalAnalysis ? [a.emotionalAnalysis.overallTone] : []
            );
            
            const emotionalCounts = emotionalThemes.reduce((acc, tone) => {
                acc[tone] = (acc[tone] || 0) + 1;
                return acc;
            }, {});
            
            html += '<p>C·∫£m x√∫c ch·ªß ƒë·∫°o:</p>';
            for (const [tone, count] of Object.entries(emotionalCounts)) {
                const emotionClass = tone === 'Ti√™u c·ª±c' ? 'emotion-dau' : 
                                   tone === 'T√≠ch c·ª±c' ? 'emotion-buon' : 'emotion-bat-luc';
                html += `<span class="emotion-tag ${emotionClass}">${tone} (${count})</span>`;
            }
            
            // Hi·ªÉn th·ªã t·ª´ nh·∫°y c·∫£m
            const sensitiveWords = extractSensitiveWordsFromAnalysis(analysisData);
            if (sensitiveWords.length > 0) {
                html += `<div style="margin: 10px 0;"><strong>T·ª´ nh·∫°y c·∫£m ph√°t hi·ªán:</strong><br>`;
                sensitiveWords.slice(0, 15).forEach(word => {
                    html += `<span class="sensitive-word">${word}</span> `;
                });
                if (sensitiveWords.length > 15) {
                    html += `<span>... v√† ${sensitiveWords.length - 15} t·ª´ kh√°c</span>`;
                }
                html += '</div>';
            }
            
            // Hi·ªÉn th·ªã m·∫´u h·ªôi tho·∫°i
            const sampleDialogues = [];
            analysisData.forEach(analysis => {
                if (analysis.dialogueAnalysis && analysis.dialogueAnalysis.dialogues) {
                    analysis.dialogueAnalysis.dialogues.forEach(dialogue => {
                        if (sampleDialogues.length < 5 && dialogue.text.length < 150) {
                            sampleDialogues.push(dialogue.text);
                        }
                    });
                }
            });
            
            if (sampleDialogues.length > 0) {
                html += `<div style="margin: 10px 0;"><strong>M·∫´u h·ªôi tho·∫°i:</strong></div>`;
                sampleDialogues.forEach(dialogue => {
                    html += `<div class="dialogue">"${dialogue}"</div>`;
                });
            }
            
            // Hi·ªÉn th·ªã c·∫£nh b√°o n·ªôi dung 18+ n·∫øu c√≥
            if (adultContentCount > 0) {
                html += `
                    <div class="adult-content-warning">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO: Ph√°t hi·ªán ${adultContentCount} t·ª´/c·ª•m t·ª´ 18+<br>
                        N·ªôi dung c√≥ th·ªÉ kh√¥ng ph√π h·ª£p v·ªõi m·ªçi ƒë·ªô tu·ªïi
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function displayLatestChapter(storyTitle, chapter, includeAdultContent) {
            const container = document.getElementById('generatedStories');
            let warningHtml = '';
            
            if (includeAdultContent || chapter.hasAdultContent) {
                warningHtml = `
                    <div class="adult-content-warning">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO 18+: N·ªôi dung d√†nh cho ng∆∞·ªùi tr∆∞·ªüng th√†nh
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${warningHtml}
                <div class="story-content">
                    <div class="chapter-title">${storyTitle} - ${chapter.title}</div>
                    <div>${chapter.content.substring(0, 400)}...</div>
                    <p><i>${chapter.wordCount} t·ª´${chapter.hasAdultContent ? ' ‚Ä¢ 18+' : ''}</i></p>
                </div>
            `;
        }

        function displayGeneratedStories() {
            const container = document.getElementById('generatedStories');
            
            if (generatedStories.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o.</p>';
                return;
            }
            
            const story = generatedStories[generatedStories.length - 1];
            const latestChapter = story.chapters[story.chapters.length - 1];
            
            let warningHtml = '';
            if (story.hasAdultContent) {
                warningHtml = `
                    <div class="adult-content-warning">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO 18+: Truy·ªán ch·ª©a n·ªôi dung d√†nh cho ng∆∞·ªùi tr∆∞·ªüng th√†nh
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${warningHtml}
                <div class="story-content">
                    <div class="chapter-title">${story.title} - ${latestChapter.title}</div>
                    <div>${latestChapter.content.substring(0, 600)}...</div>
                    <p><i>Ch∆∞∆°ng ${story.chapters.length}/${story.chapters.length} ‚Ä¢ ${story.totalWords} t·ª´${story.hasAdultContent ? ' ‚Ä¢ 18+' : ''}</i></p>
                </div>
                <button class="btn btn-success" onclick="downloadStory()">
                    üíæ T·∫£i xu·ªëng truy·ªán
                </button>
                <button class="btn btn-secondary" onclick="saveToGoogleDrive()">
                    ‚òÅÔ∏è L∆∞u l√™n Drive
                </button>
            `;
        }

        // Tab switching function
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const menuItems = document.querySelectorAll('.menu-item');
            for (let item of menuItems) {
                if (item.textContent.includes(
                    tabId === 'tab-analysis' ? 'Ph√¢n t√≠ch' :
                    tabId === 'tab-write' ? 'Vi·∫øt truy·ªán' :
                    tabId === 'tab-stories' ? 'Th∆∞ vi·ªán' : 'C√†i ƒë·∫∑t'
                )) {
                    item.classList.add('active');
                    break;
                }
            }
            
            return false;
        }

        // UI Update Functions
        function updateStatus(message) {
            document.getElementById('statusInfo').innerHTML = `<p>${message}</p>`;
        }

        function updateDetailedStatus(message) {
            document.getElementById('detailedStatus').textContent = message;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function updateWriteStatus(message, detail) {
            document.getElementById('writeStatus').textContent = message;
            document.getElementById('writeDetailedStatus').textContent = detail;
        }

        function updateWriteProgress(percent) {
            document.getElementById('writeProgressBar').style.width = percent + '%';
        }

        // DOWNLOAD AND SAVE FUNCTIONS
        function downloadStory() {
            if (generatedStories.length === 0) {
                alert('Ch∆∞a c√≥ truy·ªán n√†o ƒë·ªÉ t·∫£i xu·ªëng!');
                return;
            }
            
            const story = generatedStories[generatedStories.length - 1];
            let content = `${story.title}\n`;
            content += `T·∫°o ng√†y: ${new Date(story.generatedAt).toLocaleString('vi-VN')}\n`;
            content += `T·ªïng s·ªë t·ª´: ${story.totalWords}\n`;
            content += `D·ª±a tr√™n ph√¢n t√≠ch: ${story.basedOnAnalysis} file\n`;
            if (story.hasAdultContent) {
                content += `‚ö†Ô∏è C·∫¢NH B√ÅO: N·ªôi dung 18+ - D√†nh cho ng∆∞·ªùi tr∆∞·ªüng th√†nh\n`;
            }
            content += `\n${'='.repeat(50)}\n\n`;
            
            story.chapters.forEach(chapter => {
                content += `${chapter.title}\n`;
                content += `${chapter.content}\n\n`;
                content += `--- K·∫øt th√∫c ${chapter.title} ---\n\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${story.title.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateWriteStatus('üíæ ƒê√£ t·∫£i xu·ªëng truy·ªán', story.title);
        }

        async function saveToGoogleDrive() {
            if (generatedStories.length === 0) {
                alert('Ch∆∞a c√≥ truy·ªán n√†o ƒë·ªÉ l∆∞u!');
                return;
            }
            
            updateWriteStatus('‚òÅÔ∏è ƒêang l∆∞u truy·ªán l√™n Google Drive...', '');
            
            try {
                const story = generatedStories[generatedStories.length - 1];
                let content = `${story.title}\n`;
                content += `T·∫°o ng√†y: ${new Date(story.generatedAt).toLocaleString('vi-VN')}\n`;
                content += `T·ªïng s·ªë t·ª´: ${story.totalWords}\n`;
                if (story.hasAdultContent) {
                    content += `‚ö†Ô∏è C·∫¢NH B√ÅO: N·ªôi dung 18+\n`;
                }
                content += `\n${'='.repeat(50)}\n\n`;
                
                story.chapters.forEach(chapter => {
                    content += `${chapter.title}\n`;
                    content += `${chapter.content}\n\n`;
                });
                
                const fileName = `${story.title.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().split('T')[0]}.txt`;
                
                const fileMetadata = {
                    name: fileName,
                    parents: [''] // L∆∞u ·ªü root, c√≥ th·ªÉ thay ƒë·ªïi ƒë·ªÉ l∆∞u v√†o th∆∞ m·ª•c c·ª• th·ªÉ
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([content], {type: 'text/plain'}));
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    }),
                    body: form
                });
                
                if (response.ok) {
                    updateWriteStatus('‚úÖ ƒê√£ l∆∞u truy·ªán l√™n Google Drive', story.title);
                } else {
                    throw new Error('L·ªói khi l∆∞u file');
                }
                
            } catch (error) {
                console.error('Error saving to Drive:', error);
                updateWriteStatus('‚ùå L·ªói khi l∆∞u l√™n Google Drive', error.message);
            }
        }

        async function loadStories() {
            updateStatus('üìö ƒêang t·∫£i danh s√°ch truy·ªán t·ª´ Google Drive...');
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: "name contains 'Truy·ªán' or name contains '.txt'",
                    fields: 'files(id, name, createdTime, size)',
                    orderBy: 'createdTime desc',
                    pageSize: 20
                });
                
                const files = response.result.files;
                const container = document.getElementById('storiesLibrary');
                
                if (files.length === 0) {
                    container.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y truy·ªán n√†o tr√™n Google Drive.</p>';
                    return;
                }
                
                let html = '<h4>üìö Danh s√°ch truy·ªán tr√™n Google Drive:</h4>';
                files.forEach(file => {
                    const size = file.size ? `(${Math.round(file.size / 1024)} KB)` : '';
                    const date = new Date(file.createdTime).toLocaleDateString('vi-VN');
                    html += `
                        <div class="file-item">
                            <strong>üìñ ${file.name}</strong><br>
                            <small>T·∫°o: ${date} ${size}</small>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateStatus('‚úÖ ƒê√£ t·∫£i danh s√°ch truy·ªán');
                
            } catch (error) {
                console.error('Error loading stories:', error);
                updateStatus('‚ùå L·ªói khi t·∫£i danh s√°ch truy·ªán');
            }
        }

        async function clearCache() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu t·∫°m? ƒêi·ªÅu n√†y s·∫Ω x√≥a d·ªØ li·ªáu qu√©t v√† ph√¢n t√≠ch.')) {
                analysisData = [];
                txtFiles = [];
                scanData = null;
                generatedStories = [];
                
                document.getElementById('scannedFiles').innerHTML = '';
                document.getElementById('analysisResults').innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch.</p>';
                document.getElementById('generatedStories').innerHTML = '<p>Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o.</p>';
                document.getElementById('storiesLibrary').innerHTML = '<p>Ch∆∞a c√≥ truy·ªán n√†o trong th∆∞ vi·ªán.</p>';
                
                const buttons = ['analyzeBtn', 'generateBtn', 'downloadDataBtn'];
                buttons.forEach(id => document.getElementById(id).disabled = true);
                
                updateStatus('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu t·∫°m');
            }
        }

        // Initialize when page loads
        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            }
            
            updateStatus('üî¥ Ch∆∞a k·∫øt n·ªëi Google Drive - H√£y k·∫øt n·ªëi ƒë·ªÉ b·∫Øt ƒë·∫ßu');
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã ƒë·ªô nh·∫°y c·∫£m
            document.getElementById('sensitivityLevel').addEventListener('input', function() {
                document.getElementById('sensitivityValue').textContent = this.value;
            });
            
            // C·∫£nh b√°o khi b·∫≠t n·ªôi dung 18+
            document.getElementById('includeAdultContent').addEventListener('change', function() {
                if (this.checked) {
                    if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang b·∫≠t ch·∫ø ƒë·ªô t·∫°o n·ªôi dung 18+.\n\nN·ªôi dung n√†y ch·ªâ d√†nh cho ng∆∞·ªùi tr∆∞·ªüng th√†nh v√† c√≥ th·ªÉ ch·ª©a c√°c y·∫øu t·ªë nh·∫°y c·∫£m.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?')) {
                        this.checked = false;
                    }
                }
            });
        };
    </script>
</body>
</html>
