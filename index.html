<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Truyện AI</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- ml5.js -->
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 1rem; text-align: center; background: #6200ea; color: #fff; }
    .content { padding: 1rem; margin-bottom: 60px; }
    .menu { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: #eee; border-top: 1px solid #ccc; }
    .menu button { flex: 1; padding: 10px; border: none; background: #eee; font-size: 14px; }
    .menu button.active { background: #6200ea; color: #fff; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h2>Quản Lý Truyện AI</h2>
    <div id="g_id_onload"
         data-client_id="398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <p id="login-status">Chưa đăng nhập</p>
  </header>

  <div class="content">
    <section id="data-section">
      <h3>Dữ liệu</h3>
      <button onclick="listAllTxtFiles()">Tải toàn bộ .txt trong 'QuanLyTruyen'</button>
      <ul id="file-list"></ul>
    </section>
    <section id="analysis-section" class="hidden">Phân tích dữ liệu</section>
    <section id="write-section" class="hidden">Viết truyện</section>
    <section id="add-section" class="hidden">Thêm truyện</section>
    <section id="progress-section" class="hidden">Tiến trình</section>
  </div>

  <div class="menu">
    <button onclick="showSection('data-section', this)" class="active">Dữ liệu</button>
    <button onclick="showSection('analysis-section', this)">Phân tích</button>
    <button onclick="showSection('write-section', this)">Viết truyện</button>
    <button onclick="showSection('add-section', this)">Thêm truyện</button>
    <button onclick="showSection('progress-section', this)">Tiến trình</button>
  </div>

  <script>
    let accessToken;

    function handleCredentialResponse(response) {
      const client = google.accounts.oauth2.initTokenClient({
        client_id: "398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly",
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("login-status").innerText = "Đăng nhập thành công!";
          gapiLoad();
        }
      });
      client.requestAccessToken();
    }

    function gapiLoad() {
      gapi.load("client", () => {
        gapi.client.init({
          apiKey: "AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o",
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
        }).then(() => {
          gapi.client.setToken({ access_token: accessToken });
          console.log("Google Drive API sẵn sàng");
        });
      });
    }

    async function listAllTxtFiles() {
      const folderName = "QuanLyTruyen";
      try {
        // Tìm thư mục gốc "QuanLyTruyen"
        const folderRes = await gapi.client.drive.files.list({
          q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: "files(id, name)",
          spaces: "drive"
        });
        if (!folderRes.result.files || folderRes.result.files.length === 0) {
          alert("Không tìm thấy thư mục QuanLyTruyen");
          return;
        }
        const folderId = folderRes.result.files[0].id;

        let files = [];
        let pageToken = null;

        // Lấy tất cả file txt trong thư mục và các mục con bằng cách dùng 'parents in' + 'fullText' query
        do {
          const response = await gapi.client.drive.files.list({
            q: `fullText contains '' and mimeType='text/plain' and '${folderId}' in parents`,
            fields: "nextPageToken, files(id, name, parents)",
            spaces: "drive",
            pageSize: 1000,
            pageToken: pageToken
          });
          files = files.concat(response.result.files);
          pageToken = response.result.nextPageToken;
        } while (pageToken);

        // Hàm đệ quy lấy file txt trong các thư mục con
        async function getSubFiles(parentId) {
          let subPageToken = null;
          do {
            const resp = await gapi.client.drive.files.list({
              q: `'${parentId}' in parents and trashed=false`,
              fields: "nextPageToken, files(id, name, mimeType)",
              spaces: "drive",
              pageSize: 1000,
              pageToken: subPageToken
            });
            for (const f of resp.result.files) {
              if (f.mimeType === 'application/vnd.google-apps.folder') {
                await getSubFiles(f.id);
              } else if (f.mimeType === 'text/plain') {
                files.push(f);
              }
            }
            subPageToken = resp.result.nextPageToken;
          } while (subPageToken);
        }

        await getSubFiles(folderId);

        // Hiển thị file
        const listEl = document.getElementById("file-list");
        listEl.innerHTML = "";
        files.forEach(f => {
          const li = document.createElement("li");
          li.textContent = f.name;
          listEl.appendChild(li);
        });

        console.log("Tìm thấy", files.length, "file txt");
      } catch (err) {
        console.error("Lỗi khi tải file txt:", err);
      }
    }

    function showSection(id, btn) {
      document.querySelectorAll('.content section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
  </script>
</body>
</html>
