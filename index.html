<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Thêm style cho cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Ẩn nội dung nhạy cảm mặc định */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chủ đề chuyên biệt</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>Tổng số file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Đã huấn luyện:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Từ vựng học được:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Cấu trúc câu:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Tình tiết:</span>
                                <span id="plotPoints">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Diễn biến cảm xúc:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Hội thoại:</span>
                                <span id="dialoguesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Bối cảnh:</span>
                                <span id="contextsCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Nhân vật:</span>
                                <span id="charactersCount">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động</h2>
                        
                        <div class="adult-warning">
                            ⚠️ Cảnh báo: AI sẽ tạo nội dung theo ngôi thứ nhất và có thể chứa nội dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">Nội dung:</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
                <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
                <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
                <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set(),
    transitionWords: new Set(),
    psychologicalTerms: new Set(),
    descriptivePatterns: new Set(),
    metaphors: new Set(),
    adultTerms: new Set(),
    characterNames: new Set(),
    locations: new Set(),
    timeFrames: new Set(),
    situations: new Set(),
    generationHistory: [],
    processedFiles: new Set(), // Lưu trữ ID các file đã xử lý
    qualityMetrics: {
        complexityThreshold: 0.6,
        coherenceThreshold: 0.7,
        emotionThreshold: 0.65,
        targetWordCount: 3500
    }
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// Từ vựng và cấu trúc chuyên biệt
const specializedVocabulary = {
    familyRelations: ['bố chồng', 'con dâu', 'chồng', 'vợ', 'gia đình', 'họ hàng', 'mối quan hệ', 'phép tắc', 'ranh giới', 
                     'quyền lực gia trưởng', 'vai vế', 'tôn ti trật tự', 'nề nếp gia đình', 'quan hệ huyết thống'],
    emotions: ['căng thẳng', 'bối rối', 'ghen tị', 'tò mò', 'lo lắng', 'thèm muốn', 'khao khát', 'tội lỗi', 'xấu hổ', 
              'kích thích', 'dục vọng', 'bất an', 'day dứt', 'dằn vặt', 'giằng xé', 'ngờ vực', 'ám ảnh', 'khắc khoải',
              'xót xa', 'đau đớn', 'tê tái', 'ngột ngạt', 'bức bối', 'rối bời', 'hoang mang'],
    observations: ['quan sát', 'nhìn trộm', 'theo dõi', 'chú ý', 'phát hiện', 'để ý', 'nhận ra', 'thấy được', 'cảm nhận', 
                  'nghe được', 'khám phá', 'vô tình chứng kiến', 'bắt gặp', 'nhận thấy', 'thấu hiểu', 'thấu cảm'],
    innerThoughts: ['tôi nghĩ', 'trong tâm trí tôi', 'tôi tự hỏi', 'có lẽ', 'liệu rằng', 'tôi không thể tin được', 
                   'tôi cảm thấy', 'điều này khiến tôi', 'tôi nhận ra', 'tôi chợt hiểu', 'tôi ngỡ ngàng', 
                   'tôi giật mình nhận thấy', 'tôi bàng hoàng', 'tôi sửng sốt'],
    secretive: ['bí mật', 'giấu kín', 'che giấu', 'lén lút', 'thầm kín', 'kín đáo', 'âm thầm', 'không ai biết', 
               'chỉ mình tôi', 'im lặng', 'nén chặt', 'giữ kín trong lòng', 'không dám thổ lộ'],
    physicalDescriptions: ['đôi mắt', 'nụ cười', 'cử chỉ', 'ánh mắt', 'cách di chuyển', 'giọng nói', 'cách cười', 
                          'biểu cảm', 'dáng vẻ', 'bờ môi', 'mái tóc', 'bàn tay', 'vòng eo', 'cử động', 'hơi thở',
                          'nhịp tim', 'làn da', 'nét mặt', 'cơ thể', 'vòng một', 'vòng ba', 'vóc dáng', 'đường cong'],
    situations: ['bữa cơm gia đình', 'khi vợ đi vắng', 'cuối tuần', 'những buổi tối', 'lúc một mình', 'khi không ai chú ý',
                'đêm khuya', 'sáng sớm', 'khi tắm rửa', 'lúc thay đồ', 'khi uống rượu', 'trong phòng ngủ', 
                'ngoài vườn', 'trong bếp', 'trên ghế sofa', 'trong phòng tắm', 'khi say rượu'],
    adultElements: ['ham muốn', 'dục vọng', 'khát khao', 'bí mật cấm kị', 'ranh giới mờ nhạt', 'cám dỗ', 'sự quyến rũ', 
                   'không thể cưỡng lại', 'khoái cảm', 'say đắm', 'mê hoặc', 'thân thể', 'gợi cảm', 'quyến rũ',
                   'dục tính', 'kích động', 'mơn trớn', 'vuốt ve', 'thân mật', 'gần gũi', 'sờ soạng', 'ôm ấp',
                   'hôn', 'hôn nồng cháy', 'ân ái', 'làm tình', 'quan hệ', 'yêu đương'],
    psychologicalTerms: ['vô thức', 'tiềm thức', 'bản năng', 'ức chế', 'dồn nén', 'phòng thủ', 'phủ nhận', 'chiếu diễn',
                        'đồng nhất hóa', 'mặc cảm', 'mâu thuẫn nội tâm', 'xung đột tâm lý', 'ámm ảnh', 'dằn vặt'],
    transitionWords: ['tuy nhiên', 'bên cạnh đó', 'ngoài ra', 'hơn nữa', 'đặc biệt là', 'thêm vào đó', 'mặt khác',
                     'ngược lại', 'thực tế thì', 'quả thật', 'chắc chắn', 'có lẽ', 'dường như', 'rõ ràng là',
                     'cuối cùng thì', 'kết quả là', 'vì vậy', 'do đó', 'cho nên', 'đồng thời'],
    characterNames: ['Minh', 'Hương', 'Lan', 'Hạnh', 'An', 'Bình', 'Dũng', 'Hải', 'Phương', 'Thảo', 'Ngọc', 'Trang'],
    locations: ['phòng khách', 'nhà bếp', 'phòng ngủ', 'phòng tắm', 'ban công', 'sân vườn', 'cầu thang', 'nhà kho', 'garage'],
    timeFrames: ['sáng sớm', 'buổi trưa', 'chiều tà', 'đêm khuya', 'nửa đêm', 'rạng sáng', 'hoàng hôn', 'bình minh']
};

// Hàm khởi tạo
function init() {
    gapiLoaded();
    gisLoaded();
    setupEventListeners();
}

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
    });
    gis_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

function setupEventListeners() {
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    document.getElementById('storyForm').onsubmit = saveStory;
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    document.getElementById('generateStoryButton').onclick = generateAIStory;
    document.getElementById('viewAiStoriesButton').onclick = viewAIStories;
    
    // Menu navigation
    document.getElementById('menuTraining').onclick = () => showSection('trainingSection');
    document.getElementById('menuGeneration').onclick = () => showSection('generationSection');
    document.getElementById('menuManagement').onclick = () => showSection('managementSection');
    document.getElementById('menuHistory').onclick = () => showSection('historySection');
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show the selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Update active menu button
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load data if needed
    if (sectionId === 'historySection') {
        loadStoryHistory();
        loadFolderContents();
    } else if (sectionId === 'managementSection') {
        loadExistingStories();
    }
}

function handleAuthClick() {
    showLoading(true);
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            showStatus('Đăng nhập thất bại: ' + resp.error, 'error');
            showLoading(false);
            return;
        }
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        showStatus('Đăng nhập thành công!', 'success');
        
        // Load data
        await loadOrCreateMainFolder();
        loadStoryHistory();
        loadAIKnowledge();
        showLoading(false);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showStatus('Đã đăng xuất', 'success');
    }
}

async function loadOrCreateMainFolder() {
    showLoading(true);
    try {
        // Tìm thư mục chính QuanLyTruyen
        const response = await gapi.client.drive.files.list({
            q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        if (folders.length > 0) {
            mainFolderId = folders[0].id;
            showStatus('Đã tìm thấy thư mục QuanLyTruyen', 'success');
        } else {
            // Tạo thư mục mới nếu không tìm thấy
            const fileMetadata = {
                name: 'QuanLyTruyen',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            const createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            mainFolderId = createResponse.result.id;
            showStatus('Đã tạo thư mục QuanLyTruyen mới', 'success');
        }
        
    } catch (error) {
        showStatus('Lỗi khi tạo/tìm thư mục: ' + error.message, 'error');
    }
    showLoading(false);
}

async function saveStory(e) {
    e.preventDefault();
    showLoading(true);
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = mode === 'new' ? document.getElementById('storyTitle').value : document.getElementById('existingStory').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const content = document.getElementById('storyContent').value;
    
    if (!storyTitle || !chapterTitle || !content) {
        showStatus('Vui lòng điền đầy đủ thông tin', 'error');
        showLoading(false);
        return;
    }
    
    try {
        let storyFolderId;
        
        if (mode === 'new') {
            // Tạo thư mục mới cho truyện
            const fileMetadata = {
                name: storyTitle,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [mainFolderId]
            };
            
            const folderResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            storyFolderId = folderResponse.result.id;
            
        } else {
            // Tìm thư mục truyện đã có
            const response = await gapi.client.drive.files.list({
                q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
                fields: 'files(id, name)'
            });
            
            if (response.result.files.length === 0) {
                showStatus('Không tìm thấy truyện', 'error');
                showLoading(false);
                return;
            }
            
            storyFolderId = response.result.files[0].id;
        }
        
        // Tạo file chương mới
        const fileMetadata = {
            name: `${chapterTitle}.txt`,
            parents: [storyFolderId],
            mimeType: 'text/plain'
        };
        
        const contentBlob = new Blob([content], {type: 'text/plain'});
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        formData.append('file', contentBlob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token
            }),
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error.message);
        }
        
        // Cập nhật lịch sử
        storyHistory.unshift({
            title: storyTitle,
            chapter: chapterTitle,
            date: new Date().toISOString(),
            fileId: result.id
        });
        
        saveStoryHistory();
        updateAIKnowledge(content, result.id);
        
        showStatus(`Đã lưu chương "${chapterTitle}" vào truyện "${storyTitle}"`, 'success');
        document.getElementById('storyForm').reset();
        
    } catch (error) {
        showStatus('Lỗi khi lưu truyện: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function saveStoryHistory() {
    localStorage.setItem('storyHistory', JSON.stringify(storyHistory));
    displayStoryHistory();
}

function loadStoryHistory() {
    const savedHistory = localStorage.getItem('storyHistory');
    if (savedHistory) {
        storyHistory = JSON.parse(savedHistory);
    }
    displayStoryHistory();
}

function displayStoryHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    if (storyHistory.length === 0) {
        historyList.innerHTML = '<div class="history-item"><p>Chưa có lịch sử truyện</p></div>';
        return;
    }
    
    storyHistory.slice(0, 10).forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.onclick = () => viewStory(item.title);
        
        historyItem.innerHTML = `
            <div class="story-title">${item.title}</div>
            <div class="story-chapter">Chương: ${item.chapter}</div>
            <div class="story-date">${new Date(item.date).toLocaleDateString('vi-VN')}</div>
        `;
        
        historyList.appendChild(historyItem);
    });
}

async function loadFolderContents() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime)',
            orderBy: 'createdTime desc'
        });
        
        const folders = response.result.files;
        const folderList = document.getElementById('folderList');
        folderList.innerHTML = '';
        
        if (folders.length === 0) {
            folderList.innerHTML = '<div class="history-item"><p>Chưa có thư mục truyện</p></div>';
            return;
        }
        
        folders.forEach(folder => {
            const folderItem = document.createElement('div');
            folderItem.className = 'history-item';
            folderItem.onclick = () => viewStory(folder.name);
            
            folderItem.innerHTML = `
                <div class="story-title">${folder.name}</div>
                <div class="story-date">Tạo ngày: ${new Date(folder.createdTime).toLocaleDateString('vi-VN')}</div>
            `;
            
            folderList.appendChild(folderItem);
        });
        
    } catch (error) {
        console.error('Lỗi khi tải danh sách thư mục:', error);
    }
}

async function viewStory(storyTitle) {
    showLoading(true);
    
    try {
        // Tìm thư mục truyện
        const response = await gapi.client.drive.files.list({
            q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length === 0) {
            showStatus('Không tìm thấy truyện', 'error');
            showLoading(false);
            return;
        }
        
        const storyFolderId = response.result.files[0].id;
        
        // Lấy danh sách chương
        const chaptersResponse = await gapi.client.drive.files.list({
            q: `'${storyFolderId}' in parents and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = chaptersResponse.result.files;
        
        // Hiển thị modal với danh sách chương
        document.getElementById('chaptersModalTitle').textContent = `Chương truyện: ${storyTitle}`;
        const chapterList = document.getElementById('chapterList');
        chapterList.innerHTML = '';
        
        if (chapters.length === 0) {
            chapterList.innerHTML = '<div class="chapter-item">Chưa có chương nào</div>';
        } else {
            chapters.forEach(chapter => {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'chapter-item';
                chapterItem.textContent = chapter.name.replace('.txt', '');
                chapterItem.onclick = () => loadChapterContent(chapter.id, chapter.name.replace('.txt', ''), storyTitle);
                chapterList.appendChild(chapterItem);
            });
        }
        
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
        openModal('chaptersModal');
        
    } catch (error) {
        showStatus('Lỗi khi tải chương truyện: ' + error.message, 'error');
    }
    
    showLoading(false);
}

async function loadChapterContent(chapterId, chapterTitle, storyTitle) {
    showLoading(true);
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapterId,
            alt: 'media'
        });
        
        const content = response.body;
        
        document.getElementById('chapterList').style.display = 'none';
        document.getElementById('chapterContent').style.display = 'block';
        document.getElementById('chapterContent').textContent = content;
        document.getElementById('chapterActions').style.display = 'flex';
        
        // Lưu thông tin chương đang xem
        currentEditingChapter = {
            id: chapterId,
            title: chapterTitle,
            storyTitle: storyTitle,
            content: content
        };
        
    } catch (error) {
        showStatus('Lỗi khi tải nội dung chương: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function editChapter() {
    const contentDiv = document.getElementById('chapterContent');
    const currentContent = contentDiv.textContent;
    
    contentDiv.innerHTML = `<textarea id="editChapterContent" style="width: 100%; height: 400px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 15px;">${currentContent}</textarea>`;
}

async function saveChapterChanges() {
    showLoading(true);
    
    try {
        const editedContent = document.getElementById('editChapterContent').value;
        
        // Cập nhật file trên Google Drive
        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'text/plain'
            }),
            body: editedContent
        });
        
        if (!response.ok) {
            throw new Error('Lỗi khi lưu thay đổi');
        }
        
        // Cập nhật nội dung hiển thị
        document.getElementById('chapterContent').innerHTML = '';
        document.getElementById('chapterContent').textContent = editedContent;
        
        showStatus('Đã lưu thay đổi', 'success');
        
        // Cập nhật lại knowledge base
        updateAIKnowledge(editedContent, currentEditingChapter.id);
        
    } catch (error) {
        showStatus('Lỗi khi lưu thay đổi: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function cancelEdit() {
    document.getElementById('chapterContent').innerHTML = '';
    document.getElementById('chapterContent').textContent = currentEditingChapter.content;
}

async function deleteChapter() {
    if (!confirm('Bạn có chắc chắn muốn xóa chương này?')) return;
    
    showLoading(true);
    
    try {
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        showStatus('Đã xóa chương', 'success');
        closeModal('chaptersModal');
        
    } catch (error) {
        showStatus('Lỗi khi xóa chương: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Reset modal state
    if (modalId === 'chaptersModal') {
        document.getElementById('chapterList').style.display = 'block';
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
    }
}

// Đóng modal khi click bên ngoài
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'Lưu Truyện Mới';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Thêm Chương Mới';
        loadExistingStories();
    }
}

async function loadExistingStories() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        const select = document.getElementById('existingStory');
        select.innerHTML = '<option value="">-- Chọn truyện --</option>';
        
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.name;
            option.textContent = folder.name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Lỗi khi tải danh sách truyện:', error);
    }
}

function updateAIKnowledge(content, fileId) {
    // Kiểm tra nếu file đã được xử lý
    if (fileId && aiKnowledge.processedFiles.has(fileId)) {
        return; // Bỏ qua nếu đã xử lý
    }
    
    // Đánh dấu file đã xử lý
    if (fileId) {
        aiKnowledge.processedFiles.add(fileId);
    }
    
    // Phân tích nội dung để cập nhật kiến thức cho AI
    const words = content.split(/\s+/);
    words.forEach(word => {
        if (word.length > 3) {
            aiKnowledge.vocabulary.add(word.toLowerCase());
        }
    });
    
    // Phân tích câu
    const sentences = content.split(/[.!?]+/);
    aiKnowledge.trainedFiles += sentences.length;
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Phân tích cấu trúc câu
            aiKnowledge.sentenceStructures.add(sentence.trim());
            
            // Phân tích từ khóa cảm xúc
            specializedVocabulary.emotions.forEach(emotion => {
                if (sentence.toLowerCase().includes(emotion)) {
                    aiKnowledge.emotionalPatterns.add(emotion);
                }
            });
            
            // Phân tích hội thoại
            if (sentence.includes(':"') || sentence.includes(':"')) {
                aiKnowledge.dialogues.push(sentence.trim());
            }
            
            // Phân tích bối cảnh
            specializedVocabulary.locations.forEach(location => {
                if (sentence.toLowerCase().includes(location)) {
                    aiKnowledge.contexts.push({location, context: sentence.trim()});
                }
            });
            
            // Phân tích tên nhân vật
            specializedVocabulary.characterNames.forEach(name => {
                if (sentence.includes(name)) {
                    aiKnowledge.characterNames.add(name);
                }
            });
            
            // Phân tích yếu tố 18+
            specializedVocabulary.adultElements.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.adultTerms.add(term);
                }
            });
        }
    });
    
    // Lưu kiến thức AI
    saveAIKnowledge();
    updateAIStats();
}

function saveAIKnowledge() {
    // Chuyển Set thành Array để lưu trữ
    const knowledgeToSave = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        trainedFiles: aiKnowledge.trainedFiles,
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        emotionalPatterns: Array.from(aiKnowledge.emotionalPatterns),
        dialogues: aiKnowledge.dialogues,
        contexts: aiKnowledge.contexts,
        characterNames: Array.from(aiKnowledge.characterNames),
        adultTerms: Array.from(aiKnowledge.adultTerms),
        generationHistory: aiKnowledge.generationHistory,
        processedFiles: Array.from(aiKnowledge.processedFiles)
    };
    
    localStorage.setItem('aiKnowledge', JSON.stringify(knowledgeToSave));
}

function loadAIKnowledge() {
    const savedKnowledge = localStorage.getItem('aiKnowledge');
    if (savedKnowledge) {
        const parsedKnowledge = JSON.parse(savedKnowledge);
        
        // Khôi phục các Set từ Array
        aiKnowledge.vocabulary = new Set(parsedKnowledge.vocabulary || []);
        aiKnowledge.trainedFiles = parsedKnowledge.trainedFiles || 0;
        aiKnowledge.sentenceStructures = new Set(parsedKnowledge.sentenceStructures || []);
        aiKnowledge.emotionalPatterns = new Set(parsedKnowledge.emotionalPatterns || []);
        aiKnowledge.dialogues = parsedKnowledge.dialogues || [];
        aiKnowledge.contexts = parsedKnowledge.contexts || [];
        aiKnowledge.characterNames = new Set(parsedKnowledge.characterNames || []);
        aiKnowledge.adultTerms = new Set(parsedKnowledge.adultTerms || []);
        aiKnowledge.generationHistory = parsedKnowledge.generationHistory || [];
        aiKnowledge.processedFiles = new Set(parsedKnowledge.processedFiles || []);
    }
    updateAIStats();
}

function updateAIStats() {
    document.getElementById('totalFiles').textContent = aiKnowledge.processedFiles.size;
    document.getElementById('trainedFiles').textContent = aiKnowledge.trainedFiles;
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('sentenceStructures').textContent = aiKnowledge.sentenceStructures.size;
    document.getElementById('emotionalPatterns').textContent = aiKnowledge.emotionalPatterns.size;
    document.getElementById('dialoguesCount').textContent = aiKnowledge.dialogues.length;
    document.getElementById('contextsCount').textContent = aiKnowledge.contexts.length;
    document.getElementById('charactersCount').textContent = aiKnowledge.characterNames.size;
    
    // Cập nhật thanh tiến trình
    const progress = Math.min(100, (aiKnowledge.processedFiles.size / 500) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
}

async function trainAI() {
    showLoading(true);
    
    try {
        // Thu thập tất cả nội dung từ các truyện đã lưu để huấn luyện AI
        if (!mainFolderId) {
            showStatus('Chưa có thư mục chính', 'error');
            showLoading(false);
            return;
        }
        
        // Lấy danh sách tất cả file .txt trong thư mục QuanLyTruyen và các thư mục con
        const response = await gapi.client.drive.files.list({
            q: `('${mainFolderId}' in parents or parents in '${mainFolderId}') and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, parents)',
            pageSize: 1000
        });
        
        const textFiles = response.result.files;
        let processedCount = 0;
        let skippedCount = 0;
        
        document.getElementById('progressFill').style.width = '0%';
        
        for (const file of textFiles) {
            // Kiểm tra nếu file đã được xử lý
            if (aiKnowledge.processedFiles.has(file.id)) {
                skippedCount++;
                continue;
            }
            
            try {
                // Đọc nội dung file
                const contentResponse = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });
                
                const content = contentResponse.body;
                
                // Cập nhật kiến thức AI từ nội dung
                updateAIKnowledge(content, file.id);
                processedCount++;
                
                // Cập nhật tiến trình
                const progress = Math.floor((processedCount / textFiles.length) * 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Nghỉ một chút để tránh quá tải API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('Lỗi khi xử lý file:', file.name, error);
            }
        }
        
        showStatus(`Đã huấn luyện AI với ${processedCount} file mới (${skippedCount} file đã được xử lý trước đó)`, 'success');
        
    } catch (error) {
        showStatus('Lỗi khi huấn luyện AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function resetAI() {
    if (confirm('Bạn có chắc chắn muốn reset toàn bộ kiến thức của AI? Hành động này không thể hoàn tác.')) {
        aiKnowledge = {
            vocabulary: new Set(),
            stories: [],
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set(),
            transitionWords: new Set(),
            psychologicalTerms: new Set(),
            descriptivePatterns: new Set(),
            metaphors: new Set(),
            adultTerms: new Set(),
            characterNames: new Set(),
            locations: new Set(),
            timeFrames: new Set(),
            situations: new Set(),
            generationHistory: [],
            processedFiles: new Set(),
            qualityMetrics: {
                complexityThreshold: 0.6,
                coherenceThreshold: 0.7,
                emotionThreshold: 0.65,
                targetWordCount: 3500
            }
        };
        
        localStorage.removeItem('aiKnowledge');
        updateAIStats();
        showStatus('Đã reset kiến thức AI', 'success');
    }
}

async function generateAIStory() {
    showLoading(true);
    
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
    
    if (chapterCount < 100 || chapterCount > 150) {
        showStatus('Số chương phải từ 100 đến 150', 'error');
        showLoading(false);
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI chưa được huấn luyện đủ. Vui lòng huấn luyện AI trước.', 'error');
        showLoading(false);
        return;
    }
    
    try {
        // Tạo thư mục mới cho truyện AI
        const storyTitle = `AI Truyện - ${new Date().toLocaleDateString('vi-VN')}`;
        const fileMetadata = {
            name: storyTitle,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [mainFolderId]
        };
        
        const folderResponse = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        
        const storyFolderId = folderResponse.result.id;
        
        // Tạo các chương
        let progress = 0;
        document.getElementById('generationProgressFill').style.width = '0%';
        document.getElementById('generationStatus').innerHTML = '<div class="status info">Đang tạo truyện... 0%</div>';
        
        for (let i = 1; i <= chapterCount; i++) {
            const chapterTitle = `Chương ${i}`;
            const chapterContent = generateChapterContent(i, chapterCount);
            
            const fileMetadata = {
                name: `${chapterTitle}.txt`,
                parents: [storyFolderId],
                mimeType: 'text/plain'
            };
            
            const contentBlob = new Blob([chapterContent], {type: 'text/plain'});
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            formData.append('file', contentBlob);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                }),
                body: formData
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error.message);
            }
            
            // Cập nhật tiến trình
            progress = Math.floor((i / chapterCount) * 100);
            document.getElementById('generationProgressFill').style.width = `${progress}%`;
            document.getElementById('generationStatus').innerHTML = `<div class="status info">Đang tạo truyện... ${progress}%</div>`;
            
            // Nghỉ một chút để tránh quá tải API
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Lưu thông tin truyện AI
        aiGeneratedStories.push({
            title: storyTitle,
            chapters: chapterCount,
            date: new Date().toISOString(),
            folderId: storyFolderId
        });
        
        saveAIGeneratedStories();
        
        showStatus(`Đã tạo thành công truyện "${storyTitle}" với ${chapterCount} chương`, 'success');
        document.getElementById('generationStatus').innerHTML = '';
        
    } catch (error) {
        showStatus('Lỗi khi tạo truyện AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function generateChapterContent(chapterNumber, totalChapters) {
    // Tạo nội dung chương đơn giản dựa trên kiến thức AI
    let content = `Chương ${chapterNumber}\n\n`;
    
    // Sử dụng từ vựng đã học để tạo nội dung
    const vocabulary = Array.from(aiKnowledge.vocabulary);
    const emotions = Array.from(aiKnowledge.emotionalPatterns);
    const names = Array.from(aiKnowledge.characterNames);
    
    // Tạo một số đoạn văn ngẫu nhiên
    for (let i = 0; i < 10; i++) {
        const sentenceLength = 5 + Math.floor(Math.random() * 10);
        let sentence = '';
        
        for (let j = 0; j < sentenceLength; j++) {
            if (j > 0) sentence += ' ';
            sentence += vocabulary[Math.floor(Math.random() * vocabulary.length)];
        }
        
        content += sentence + '. ';
        
        // Thêm cảm xúc ngẫu nhiên
        if (Math.random() > 0.7) {
            content += `Tôi cảm thấy ${emotions[Math.floor(Math.random() * emotions.length)]}. `;
        }
        
        // Thêm tên nhân vật ngẫu nhiên
        if (Math.random() > 0.8 && names.length > 0) {
            content += `${names[Math.floor(Math.random() * names.length)]} `;
        }
        
        content += '\n\n';
    }
    
    return content;
}

function saveAIGeneratedStories() {
    localStorage.setItem('aiGeneratedStories', JSON.stringify(aiGeneratedStories));
}

function loadAIGeneratedStories() {
    const savedStories = localStorage.getItem('aiGeneratedStories');
    if (savedStories) {
        aiGeneratedStories = JSON.parse(savedStories);
    }
}

async function viewAIStories() {
    loadAIGeneratedStories();
    
    const aiStoryList = document.getElementById('aiStoryList');
    aiStoryList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        aiStoryList.innerHTML = '<div class="chapter-item">Chưa có truyện nào được tạo bởi AI</div>';
    } else {
        aiGeneratedStories.forEach(story => {
            const storyItem = document.createElement('div');
            storyItem.className = 'chapter-item';
            storyItem.onclick = () => viewStory(story.title);
            
            storyItem.innerHTML = `
                <div class="story-title">${story.title}</div>
                <div class="story-chapter">${story.chapters} chương</div>
                <div class="story-date">${new Date(story.date).toLocaleDateString('vi-VN')}</div>
            `;
            
            aiStoryList.appendChild(storyItem);
        });
    }
    
    openModal('aiStoriesModal');
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Khởi tạo ứng dụng
window.onload = init;
</script>
</body>
</html>
