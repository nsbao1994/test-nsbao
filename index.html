<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω Truy·ªán - Google Drive</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --muted:#93a3b8; --accent:#7aa2ff; --line:#233059; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: #e7efff; }
    header { padding: 20px; border-bottom: 1px solid var(--line); backdrop-filter: blur(4px); position: sticky; top: 0; background: #0b1020cc; }
    h1 { margin: 0 0 4px; font-size: 20px; letter-spacing: .3px; }
    .sub { color: var(--muted); font-size: 13px; }
    main { max-width: 980px; margin: 24px auto; padding: 0 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.2); }
    label { font-size: 13px; color: var(--muted); }
    input, textarea, select { width: 100%; margin-top: 6px; margin-bottom: 12px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--line); background: #0f162c; color: #e7efff; outline: none; }
    textarea { min-height: 160px; resize: vertical; }
    button { appearance: none; border: 1px solid var(--line); background: #111c3a; color: #e7efff; padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button.primary { background: linear-gradient(180deg, #7aa2ff, #5b8dff); color: #0b1020; border-color: #7aa2ff; font-weight: 600; }
    button.ghost { background: transparent; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .list { display: grid; gap: 8px; }
    .story-item { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: #0f162c; }
    .story-head { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .story-name { font-weight: 600; }
    .chapters { margin-top: 8px; display: none; }
    .chip { display: inline-block; padding: 6px 10px; margin: 4px 6px 0 0; border-radius: 999px; background: #111c3a; border: 1px solid var(--line); font-size: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .hr { height: 1px; background: var(--line); margin: 12px 0; border: 0; }
    .hint { font-size: 12px; color: var(--muted); }
    .ok { color: #9ef5a6; }
    .warn { color: #ffd17a; }
    .err { color: #ff9e9e; }
    @media (max-width: 860px){ main{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>üìö Qu·∫£n l√Ω Truy·ªán ¬∑ Google Drive</h1>
    <div class="sub">T·∫°o th∆∞ m·ª•c cha <b>TruyenApp</b> ¬∑ M·ªói truy·ªán l√† 1 th∆∞ m·ª•c con ¬∑ M·ªói ch∆∞∆°ng l√† 1 file .txt</div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div>
          <div class="hint">Tr·∫°ng th√°i</div>
          <div id="status" class="muted">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
        </div>
        <div class="row">
          <button id="signinBtn" onclick="handleSignIn()" class="primary">üîë ƒêƒÉng nh·∫≠p Google</button>
          <button id="signoutBtn" onclick="handleSignOut()" class="ghost" disabled>ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="row">
        <div style="flex:1">
          <label for="storyName">T√™n truy·ªán</label>
          <input id="storyName" placeholder="V√≠ d·ª•: V√πng ƒê·∫•t K√Ω ·ª®c" />
        </div>
        <div style="width: 190px">
          <label for="chapterName">T√™n ch∆∞∆°ng</label>
          <input id="chapterName" placeholder="Ch∆∞∆°ng 1" />
        </div>
      </div>
      <label for="chapterContent">N·ªôi dung ch∆∞∆°ng</label>
      <textarea id="chapterContent" placeholder="Vi·∫øt n·ªôi dung ch∆∞∆°ng t·∫°i ƒë√¢y..."></textarea>

      <div class="row">
        <button id="saveBtn" class="primary" onclick="saveChapter()" disabled>üíæ L∆∞u ch∆∞∆°ng</button>
        <button class="ghost" onclick="clearForm()">üßπ X√≥a n·ªôi dung</button>
      </div>

      <div class="hr"></div>
      <div class="hint">
        D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u v√†o Google Drive c·ªßa b·∫°n (ph·∫°m vi <code>drive.file</code> ‚Äì ch·ªâ c√°c file do ·ª©ng d·ª•ng t·∫°o).
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <h3 style="margin:0">üìú L·ªãch s·ª≠ truy·ªán</h3>
        <button class="ghost" onclick="refreshStories()">üîÑ T·∫£i l·∫°i</button>
      </div>
      <div id="storyList" class="list" style="margin-top:10px"></div>
      <div id="emptyState" class="muted" style="display:none">Ch∆∞a c√≥ truy·ªán n√†o. H√£y l∆∞u ch∆∞∆°ng ƒë·∫ßu ti√™n!</div>
    </section>
  </main>

  <!-- Google API -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()" onerror="apiLoadError()"></script>

  <script>
    // ====== C·∫§U H√åNH C·ª¶A B·∫†N ======
    const API_KEY   = "AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o";
    const CLIENT_ID = "398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com";
    const SCOPES    = "https://www.googleapis.com/auth/drive.file";
    const DISCOVERY = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
    // T√™n th∆∞ m·ª•c cha
    const ROOT_FOLDER_NAME = "TruyenApp";

    let rootFolderId = null;

    function qs(id){ return document.getElementById(id); }
    function setStatus(text, cls="muted"){ const el=qs("status"); el.className=cls; el.textContent=text; }
    function enableSignedInUI(signedIn){
      qs("signinBtn").disabled = signedIn;
      qs("signoutBtn").disabled = !signedIn;
      qs("saveBtn").disabled = !signedIn;
    }

    function apiLoadError(){
      setStatus("Kh√¥ng t·∫£i ƒë∆∞·ª£c Google API (api.js). Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c ch·∫∑n script.", "err");
    }

    function gapiLoaded(){
      gapi.load("client:auth2", initClient);
    }

    async function initClient(){
      try{
        await gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: [DISCOVERY],
        });

        const auth = gapi.auth2.getAuthInstance();
        auth.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(auth.isSignedIn.get());
      }catch(err){
        console.error(err);
        setStatus("L·ªói kh·ªüi t·∫°o Google API: " + (err?.details || err?.error || "Kh√¥ng r√µ"), "err");
      }
    }

    function updateSigninStatus(isSignedIn){
      if(isSignedIn){
        setStatus("ƒê√£ ƒëƒÉng nh·∫≠p ‚úì", "ok");
        enableSignedInUI(true);
        ensureRootFolder().then(refreshStories).catch(e => {
          console.error(e);
          setStatus("L·ªói t·∫°o/t√¨m th∆∞ m·ª•c g·ªëc: " + e.message, "err");
        });
      }else{
        setStatus("Ch∆∞a ƒëƒÉng nh·∫≠p", "muted");
        enableSignedInUI(false);
        qs("storyList").innerHTML = "";
      }
    }

    function handleSignIn(){ gapi.auth2.getAuthInstance().signIn(); }
    function handleSignOut(){ gapi.auth2.getAuthInstance().signOut(); }

    async function ensureRootFolder(){
      // t√¨m th∆∞ m·ª•c cha
      const list = await gapi.client.drive.files.list({
        q: "name = '" + ROOT_FOLDER_NAME.replace(/'/g, "\'") + "' and mimeType = 'application/vnd.google-apps.folder' and trashed = false",
        fields: "files(id, name)",
        pageSize: 1
      });
      if(list.result.files && list.result.files.length){
        rootFolderId = list.result.files[0].id;
        return rootFolderId;
      }
      // t·∫°o m·ªõi n·∫øu ch∆∞a c√≥
      const created = await gapi.client.drive.files.create({
        resource: {
          name: ROOT_FOLDER_NAME,
          mimeType: "application/vnd.google-apps.folder"
        },
        fields: "id"
      });
      rootFolderId = created.result.id;
      return rootFolderId;
    }

    async function getOrCreateStoryFolder(storyName){
      const safeName = storyName.trim();
      const res = await gapi.client.drive.files.list({
        q: "'" + rootFolderId + "' in parents and name = '" + safeName.replace(/'/g, "\'") + "' and mimeType = 'application/vnd.google-apps.folder' and trashed = false",
        fields: "files(id, name)",
        pageSize: 1
      });
      if(res.result.files && res.result.files.length){
        return res.result.files[0].id;
      }
      const created = await gapi.client.drive.files.create({
        resource: {
          name: safeName,
          mimeType: "application/vnd.google-apps.folder",
          parents: [rootFolderId]
        },
        fields: "id"
      });
      return created.result.id;
    }

    async function saveChapter(){
      const storyName = qs("storyName").value.trim();
      const chapterName = qs("chapterName").value.trim();
      const content = qs("chapterContent").value.trim();

      if(!storyName){ alert("Vui l√≤ng nh·∫≠p T√™n truy·ªán"); return; }
      if(!chapterName){ alert("Vui l√≤ng nh·∫≠p T√™n ch∆∞∆°ng"); return; }
      if(!content){ alert("Vui l√≤ng nh·∫≠p N·ªôi dung ch∆∞∆°ng"); return; }

      setStatus("ƒêang l∆∞u ch∆∞∆°ng...", "warn");
      try{
        const storyFolderId = await getOrCreateStoryFolder(storyName);

        // T·∫°o file ch∆∞∆°ng .txt b·∫±ng media upload
        const fileMetadata = { name: chapterName + ".txt", parents: [storyFolderId] };
        const media = { mimeType: "text/plain", body: content };

        await gapi.client.drive.files.create({
          resource: fileMetadata,
          media: media,
          fields: "id"
        });

        setStatus("ƒê√£ l∆∞u ch∆∞∆°ng ‚úì", "ok");
        clearForm(false);
        await refreshStories();
      }catch(err){
        console.error(err);
        setStatus("L·ªói khi l∆∞u ch∆∞∆°ng: " + (err?.message || "Kh√¥ng r√µ"), "err");
      }
    }

    function clearForm(clearStory=true){
      if(clearStory) qs("storyName").value = "";
      qs("chapterName").value = "";
      qs("chapterContent").value = "";
    }

    async function refreshStories(){
      if(!rootFolderId){ return; }
      const listEl = qs("storyList");
      listEl.innerHTML = "";
      qs("emptyState").style.display = "none";

      try{
        const res = await gapi.client.drive.files.list({
          q: "'" + rootFolderId + "' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false",
          fields: "files(id, name)",
          pageSize: 1000
        });

        const folders = (res.result.files || []).sort((a,b)=> a.name.localeCompare(b.name,'vi'));
        if(!folders.length){
          qs("emptyState").style.display = "block";
          return;
        }

        for(const f of folders){
          const item = document.createElement("div");
          item.className = "story-item";
          item.innerHTML = \`
            <div class="story-head" onclick="toggleChapters(this)">
              <div>
                <div class="story-name">\${f.name}</div>
                <div class="muted" data-folder-id="\${f.id}">ƒêang t·∫£i ch∆∞∆°ng...</div>
              </div>
              <div>‚ñº</div>
            </div>
            <div class="chapters"></div>
          \`;
          listEl.appendChild(item);

          // load chapters
          loadChapters(f.id, item.querySelector(".chapters"), item.querySelector(".muted"));
        }
      }catch(err){
        console.error(err);
        setStatus("L·ªói t·∫£i danh s√°ch truy·ªán: " + (err?.message || "Kh√¥ng r√µ"), "err");
      }
    }

    async function loadChapters(folderId, container, subtitle){
      try{
        const res = await gapi.client.drive.files.list({
          q: "'" + folderId + "' in parents and mimeType != 'application/vnd.google-apps.folder' and trashed = false",
          fields: "files(id, name, modifiedTime)",
          orderBy: "name"
        });
        const files = res.result.files || [];
        subtitle.textContent = files.length ? (files.length + " ch∆∞∆°ng") : "Ch∆∞a c√≥ ch∆∞∆°ng";
        container.innerHTML = files.map(f => {
          return '<span class="chip" title="ID: ' + f.id + '\nC·∫≠p nh·∫≠t: ' + (f.modifiedTime || '') + '">' + f.name.replace(/\.txt$/,'') + '</span>';
        }).join("");
      }catch(err){
        console.error(err);
        subtitle.textContent = "L·ªói t·∫£i ch∆∞∆°ng";
      }
    }

    function toggleChapters(headEl){
      const wrap = headEl.parentElement;
      const pane = wrap.querySelector(".chapters");
      const arrow = headEl.querySelector("div:last-child");
      const show = pane.style.display !== "block";
      pane.style.display = show ? "block" : "none";
      arrow.textContent = show ? "‚ñ≤" : "‚ñº";
    }
  </script>
</body>
</html>
