<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>TrÃ¬nh PhÃ¢n TÃ­ch & Táº¡o Truyá»‡n NÃ¢ng Cao</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    :root {
      --primary-color: #9b59b6;
      --secondary-color: #2980b9;
      --dark-color: #1e1e1e;
      --light-color: #bdc3c7;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --text-color: #ecf0f1;
      --card-bg: rgba(30, 30, 30, 0.95);
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #121212;
      color: var(--text-color);
      font-family: sans-serif;
      min-height: 100vh;
    }

    .container {
      padding: 16px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: #2c3e50;
    }

    .menu-item {
      color: var(--light-color);
      text-decoration: none;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .menu-item.active {
      opacity: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
    .empty-state {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 20px;
}

    .btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
    }

    .btn:disabled {
      background: #777;
      cursor: not-allowed;
    }

    .story-content {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      max-height: 50vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“– TrÃ¬nh PhÃ¢n TÃ­ch & Táº¡o Truyá»‡n</h1>
      <p>PhÃ¢n tÃ­ch nÃ¢ng cao vÃ  táº¡o truyá»‡n tá»± Ä‘á»™ng</p>
    </div>
    <div id="tab-analysis" class="tab-content active">
      <div class="card">
        <h3>ğŸ” PhÃ¢n tÃ­ch nguá»“n truyá»‡n</h3>
        <div class="status-info" id="statusInfo">ğŸ”´ ChÆ°a káº¿t ná»‘i Google
          Drive</div>
        <div class="detailed-status" id="detailedStatus"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="height:10px;background:#9b59b6;width:0%"></div>
        </div>
        <button class="btn" onclick="handleAuthClick()">ğŸ“ Káº¿t ná»‘i Google
          Drive</button>
        <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>ğŸ”
          QuÃ©t thÆ° má»¥c</button>
        <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>ğŸ§  PhÃ¢n tÃ­ch nÃ¢ng cao</button>
        <button class="btn" id="downloadAnalysisBtn" onclick="downloadAnalysisFromDrive()" disabled>ğŸ“¥ Táº£i phÃ¢n
          tÃ­ch</button>
        <button class="btn" onclick="loadAnalysisLocal()">ğŸ”„ Táº£i cache
          local</button>
        <button class="btn" onclick="uploadAnalysisToDrive()">â˜ï¸ Upload phÃ¢n
          tÃ­ch</button>
          <button class="btn" onclick="clearLocalCache()" style="background: #e74c3c;">ğŸ—‘ï¸ XÃ³a cache</button>
      </div>
      <div class="card">
        <h3>ğŸ“Š Káº¿t quáº£ phÃ¢n tÃ­ch</h3>
        <div id="analysisResults">
          <p>ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="bottom-menu">
    <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">ğŸ” PhÃ¢n tÃ­ch</a>
  </div>
  <script>
    const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    let tokenClient, gapi_inited = false, gsi_inited = false;
    let analysisData = [];
    const ANALYSIS_CACHE_NAME = 'AnalysisResults_QuanLyTruyen.json';
    let txtFiles = [];
 // Tá»« nháº¡y cáº£m cho phÃ¢n tÃ­ch nÃ¢ng cao
    const sensitiveWords = {
      romantic: ['yÃªu', 'thÆ°Æ¡ng', 'hÃ´n', 'Ã´m', 'áº¥p Ã´m', 'Ã¢m Ã¡p', 'say Ä‘áº¯m', 'Ä‘am mÃª', 'dá»‹u dÃ ng', 'ngá»t ngÃ o', 'quyáº¿n rÅ©', 'mÃª hoáº·c', 'thÃ¢n máº­t', 'gáº§n gÅ©i'],
      sexual: [
        'gá»‘i chÄƒn', 'phÃ²ng the', 'Ã¢n Ã¡i', 'lÃ m tÃ¬nh', 'quan há»‡', 'tÃ¬nh dá»¥c',
        'dÃ¢m', 'dá»¥c', 'khoÃ¡i cáº£m', 'kÃ­ch thÃ­ch', 'khoáº£ thÃ¢n', 'lÃµa thá»ƒ',
        'sÆ°á»›ng', 'rÃªn rá»‰', 'ná»©ng', 'Æ°á»›t Ã¡t', 'cao trÃ o', 'cá»±c khoÃ¡i', 'xuáº¥t tinh',
        'dÆ°Æ¡ng váº­t', 'cáº·c', 'buá»“i', 'chim', 'cÃ¡i áº¥y',
        'Ã¢m Ä‘áº¡o', 'lá»“n', 'bÆ°á»›m', 'Ã¢m há»™', 'há»™t le', 'mu', 'lá»—', 'xoáº¡c',
        'bÃº vÃº', 'vÃº to', 'vÃº cÄƒng', 'bÃº mÃºt', 'ngá»±c tráº§n', 'ngá»±c khá»§ng', 'Ä‘áº§u ti',
        'bÃº lá»“n', 'bÃº cáº·c', 'liáº¿m lá»“n', 'liáº¿m bi', 'nuá»‘t tinh', 'bÃº há»™t le', 'bÃº Ä‘áº§u cáº·c',
        'tá»­ cung', 'báº¯n vÃ o tá»­ cung', 'cáº·c dÃ i 20cm', 'ngáº­m tinh', 'chá»‹ch', 'Ä‘á»‹t', 'náº¯c',
        'thá»•i kÃ¨n', 'bj', 'hj', 'anal', 'doggy', '69', 'threesome', 'thá»§ dÃ¢m',
        'chÆ¡i gÃ¡i', 'Ä‘Ä©', 'gÃ¡i máº¡i dÃ¢m', 'mÃ´ng to', 'thá»¥t ra thá»¥t vÃ o', 'cáº¯m sÃ¢u',
        'sá» soáº¡ng', 'mÃºt', 'cáº¯n', 'xoa', 'vuá»‘t ve', 'hÃºp sÃ²', 'phÃª', 'nghiá»‡n sex',
        'xoáº¡c lá»“n', 'xoáº¡c cáº·c', 'tra táº¥n tÃ¬nh dá»¥c', 'hÃ nh xÃ¡c', 'chá»‹u tráº­n',
        'nhÃ©t', 'Ä‘Ãºt', 'lÃ m nhá»¥c', 'bÃ³p vÃº', 'tÃ©t Ä‘Ã­t', 'vá»— mÃ´ng', 'tÃºm tÃ³c',
        'báº¡o dÃ¢m', 'cÆ°á»¡ng hiáº¿p', 'hiáº¿p dÃ¢m', 'loáº¡n luÃ¢n', 'tháº±ng cha', 'Ã´ng giÃ  dÃ¢m Ä‘Ã£ng',
        'con Ä‘Ä©', 'con cave', 'chá»‹ dÃ¢u', 'em dÃ¢u', 'anh rá»ƒ', 'chá»‹ gÃ¡i', 'máº¹ chá»“ng', 'cha con', 'máº¹ con',
        'rÃªn la', 'rÃªn rá»‰', 'hÃ©t lÃªn vÃ¬ sÆ°á»›ng', 'máº¯t lá» Ä‘á»', 'má»“ hÃ´i nhá»… nháº¡i',
        'báº¯n tinh', 'phun tinh', 'tinh dá»‹ch', 'tinh trÃ n', 'nuá»‘t sáº¡ch tinh',
        'mÃ¹i tanh', 'vá»‹ máº·n', 'Æ°á»›t Ä‘áº«m', 'nÆ°á»›c nhá»n', 'dá»‹ch nhá»n',
        // ===== HÃ nh Ä‘á»™ng & tÃ¬nh dá»¥c =====
        'lÃ m tÃ¬nh', 'quan há»‡', 'Ã¢n Ã¡i', 'thá»§ dÃ¢m', 'kÃ­ch thÃ­ch',
        'cá»Ÿi Ä‘á»“', 'vuá»‘t ve', 'sá» mÃ³', 'Ã´m hÃ´n', 'thÃ¢m nháº­p',
        'rÃªn rá»‰', 'xuáº¥t tinh', 'cao trÃ o', 'cá»±c khoÃ¡i', 'Æ°á»›t Ã¡t',

        // ===== Lá»i thoáº¡i tÃ¬nh dá»¥c chung =====
        '"muá»‘n anh"', '"muá»‘n em"', '"lÃ m em sÆ°á»›ng"', '"cá»©ng quÃ¡"',
        '"em Æ°á»›t rá»“i"', '"máº¡nh lÃªn"', '"ra Ä‘i"', '"báº¯n vÃ o trong"',

        // ===== Quan há»‡ gia Ä‘Ã¬nh nháº¡y cáº£m =====
        'bá»‘ chá»“ng', 'con dÃ¢u', 'cha chá»“ng', 'nÃ ng dÃ¢u',
        '"bá»‘ chá»“ng"', '"con dÃ¢u"', '"cha chá»“ng"', '"nÃ ng dÃ¢u"',
        '"bá»‘ chá»“ng Æ¡i"', '"con dÃ¢u ngoan"', '"bá»‘ chá»“ng lÃ m cho con"',
        '"con dÃ¢u cá»§a bá»‘"', '"bá»‘ muá»‘n con"', '"bá»‘ chá»“ng khÃ´ng chá»‹u ná»•i"',
        '"con dÃ¢u sÆ°á»›ng quÃ¡"', '"lÃ m dÃ¢u bá»‘"', '"bá»‘ chá»“ng yÃªu con dÃ¢u"',

        // ===== CÃ¡c tÃ¬nh huá»‘ng thoáº¡i Ä‘áº·c thÃ¹ =====
        'quan há»‡ vá»›i bá»‘ chá»“ng', 'quan há»‡ cÃ¹ng con dÃ¢u',
        'chá»‹ch con dÃ¢u', 'bá»‘ chá»“ng Ä‘á»¥ con dÃ¢u', 'bá»‘ chá»“ng hiáº¿p con dÃ¢u',
        'lÃ m tÃ¬nh vá»›i con dÃ¢u', 'bá»‘ chá»“ng Ã´m con dÃ¢u',
        'con dÃ¢u rÃªn', 'bá»‘ chá»“ng thá»a mÃ£n', 'bá»‘ chá»“ng cÆ°á»¡ng hiáº¿p'
      ],
      negative: ['ghÃ©t', 'háº­n', 'giáº­n', 'tá»©c', 'tá»§i', 'buá»“n', 'Ä‘au', 'khá»•', 'sáº§u', 'tháº£m', 'bi', 'tang', 'tá»­', 'cháº¿t', 'giáº¿t', 'háº¡i', 'Ã¡c', 'dá»¯', 'hung'],
      family: ['bá»‘', 'máº¹', 'cha', 'con', 'chá»“ng', 'vá»£', 'dÃ¢u', 'rá»ƒ', 'anh', 'chá»‹', 'em', 'Ã´ng', 'bÃ ', 'chÃº', 'bÃ¡c', 'cÃ´', 'dÃ¬', 'cáº­u', 'má»£'],
      secret: ['bÃ­ máº­t', 'giáº¥u giáº¿m', 'che giáº¥u', 'giáº¥u diáº¿m', 'lÃ©n lÃºt', 'vá»¥ng trá»™m', 'Ã¢m tháº§m', 'láº·ng láº½', 'kÃ­n Ä‘Ã¡o', 'riÃªng tÆ°']
    };

    const emotionalWords = {
      positive: ['vui', 'háº¡nh phÃºc', 'yÃªu', 'thÆ°Æ¡ng', 'tuyá»‡t vá»i', 'Ä‘áº¹p', 'tá»‘t', 'xuáº¥t sáº¯c', 'thÃ nh cÃ´ng', 'hy vá»ng'],
      negative: ['buá»“n', 'Ä‘au', 'khá»•', 'tá»‡', 'xáº¥u', 'tháº¥t báº¡i', 'tuyá»‡t vá»ng', 'ghÃ©t', 'tá»©c giáº­n', 'lo láº¯ng', 'sá»£ hÃ£i', 'khÃ³c', 'tang thÆ°Æ¡ng', 'báº¥t háº¡nh', 'dá»‘i trÃ¡', 'pháº£n bá»™i', 'lá»«a dá»‘i', 'xÃ³t xa', 'Ä‘au Ä‘á»›n', 'xáº¥u há»•', 'tá»§i nhá»¥c'],
      neutral: ['bÃ¬nh thÆ°á»ng', 'thÃ´ng thÆ°á»ng', 'trung bÃ¬nh', 'á»•n', 'Ä‘Æ°á»£c', 'táº¡m á»•n']
    };

    // Tá»« khÃ³a Ä‘áº·c biá»‡t cho phÃ¢n tÃ­ch há»™i thoáº¡i
    const dialogueIndicators = ['nÃ³i', 'báº£o', 'há»i', 'Ä‘Ã¡p', 'thÆ°a', 'kÃªu', 'gá»i', 'hÃ©t', 'la', 'thÃ©t', 'thÃ¬ tháº§m', 'rá»§ rá»‰', 'lÃªn tiáº¿ng', 'phÃ¡t biá»ƒu', 'tráº£ lá»i', 'há»i láº¡i', 'Ä‘Ã¡p láº¡i'];
    const dialoguePunctuation = ['"', "'", ':', ';', '-', 'â€”', 'â€“'];
    // ===== GOOGLE API INITIALIZATION =====
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC]
    });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
    });
    gsi_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gsi_inited) {
        document.getElementById('scanBtn').disabled = false;
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        gapi.client.setToken({access_token: resp.access_token});
        updateStatus('ğŸŸ¢ ÄÃ£ káº¿t ná»‘i Google Drive');
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('downloadAnalysisBtn').disabled = false;
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

// ===== UI UPDATE FUNCTIONS =====
function updateStatus(msg) {
    document.getElementById('statusInfo').innerText = msg;
}

function updateProgress(p) {
    document.getElementById('progressBar').style.width = p + '%';
}

function updateDetailedStatus(msg) {
    document.getElementById('detailedStatus').innerText = msg;
}
  // ===== LOCAL STORAGE FUNCTIONS =====
function saveAnalysisLocal() {
    const analysisContent = {
        analysisData: analysisData,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('analysisResults', JSON.stringify(analysisContent));
}

function loadAnalysisLocal() {
    const data = localStorage.getItem('analysisResults');
    if (data) {
        try {
            const parsed = JSON.parse(data);
            analysisData = parsed.analysisData || [];
            displayAdvancedAnalysisResults();
            updateStatus('âœ… ÄÃ£ táº£i cache local');
            return true;
        } catch (e) {
            console.error('Error loading local cache:', e);
            updateStatus('âŒ Lá»—i khi táº£i cache local');
        }
    } else {
        updateStatus('âš ï¸ KhÃ´ng cÃ³ cache local');
        displayEmptyState();
    }
    return false;
}
// ===== NEW FUNCTION: CLEAR CACHE & EMPTY STATE =====
function clearLocalCache() {
    if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ cache local?')) {
        localStorage.removeItem('analysisResults');
        analysisData = [];
        displayEmptyState();
        updateStatus('ğŸ—‘ï¸ ÄÃ£ xÃ³a cache local');
    }
}

function displayEmptyState() {
    const container = document.getElementById('analysisResults');
    container.innerHTML = `
        <div class="empty-state">
            <p>ğŸ“­ ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                HÃ£y káº¿t ná»‘i Google Drive, quÃ©t thÆ° má»¥c vÃ  phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.
            </p>
        </div>
    `;
}
   // ===== GOOGLE DRIVE FUNCTIONS =====
function uploadAnalysisToDrive() {
    if (!analysisData || analysisData.length === 0) {
        alert("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch Ä‘á»ƒ upload!");
        return;
    }

    const fileContent = JSON.stringify(analysisData, null, 2);
    const file = new Blob([fileContent], { type: 'application/json' });

    const metadata = {
        name: "analysisData.json",
        mimeType: "application/json"
    };

    const accessToken = gapi.client.getToken().access_token;
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", file);

    fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
    }).then(res => res.json()).then(val => {
        alert("âœ… ÄÃ£ upload phÃ¢n tÃ­ch lÃªn Google Drive: " + val.id);
    }).catch(err => {
        console.error("Upload lá»—i:", err);
        alert("âŒ Lá»—i khi upload: " + err.message);
    });
}

async function downloadAnalysisFromDrive() {
    try {
        const accessToken = gapi.client.getToken().access_token;

        let res = await fetch(
            "https://www.googleapis.com/drive/v3/files?q=name='analysisData.json'&fields=files(id,name)",
            { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let data = await res.json();

        if (!data.files || data.files.length === 0) {
            alert("âš ï¸ KhÃ´ng tÃ¬m tháº¥y file analysisData.json trÃªn Google Drive!");
            return;
        }

        const fileId = data.files[0].id;

        let fileRes = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let content = await fileRes.json();

        analysisData = content;
        saveAnalysisLocal();

        alert("âœ… ÄÃ£ táº£i phÃ¢n tÃ­ch vá» tá»« Google Drive!");
        displayAdvancedAnalysisResults();

    } catch (err) {
        console.error("Download lá»—i:", err);
        alert("âŒ Lá»—i khi táº£i phÃ¢n tÃ­ch tá»« Google Drive: " + err.message);
    }
}

const ROOT_FOLDER_NAME = "QuanLyTruyen";
   // ===== SCAN FOLDER FUNCTION =====
async function scanFolder() {
    updateStatus("ğŸ” Äang quÃ©t thÆ° má»¥c QuanLyTruyen...");
    updateProgress(5);

    try {
        const folderRes = await gapi.client.drive.files.list({
            q: `mimeType='application/vnd.google-apps.folder' and name='${ROOT_FOLDER_NAME}' and trashed=false`,
            fields: "files(id, name)"
        });

        if (!folderRes.result.files || folderRes.result.files.length === 0) {
            updateStatus("âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c QuanLyTruyen trÃªn Google Drive!");
            return;
        }

        const rootFolderId = folderRes.result.files[0].id;
        txtFiles = [];
        await fetchFilesRecursive(rootFolderId, ROOT_FOLDER_NAME);

        if (txtFiles.length === 0) {
            updateStatus("âš ï¸ KhÃ´ng cÃ³ file .txt nÃ o trong QuanLyTruyen.");
            return;
        }

        updateStatus(`âœ… ÄÃ£ quÃ©t Ä‘Æ°á»£c ${txtFiles.length} file .txt`);
        updateProgress(100);
        document.getElementById("analyzeBtn").disabled = false;

    } catch (err) {
        console.error("âŒ Lá»—i khi quÃ©t thÆ° má»¥c:", err);
        updateStatus("âŒ Lá»—i khi quÃ©t thÆ° má»¥c: " + err.message);
    }
}

async function fetchFilesRecursive(folderId, folderPath) {
    let pageToken = null;
    do {
        const res = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed=false`,
            fields: "nextPageToken, files(id, name, mimeType)",
            pageToken: pageToken
        });

        for (const file of res.result.files) {
            if (file.mimeType === "application/vnd.google-apps.folder") {
                await fetchFilesRecursive(file.id, `${folderPath}/${file.name}`);
            } else if (file.mimeType === "text/plain" || file.name.endsWith(".txt")) {
                txtFiles.push({
                    id: file.id,
                    name: file.name,
                    folderPath: folderPath
                });
            }
        }
        pageToken = res.result.nextPageToken;
    } while (pageToken);
}


// ===== ANALYZE FILES FUNCTION (FIXED) =====
async function analyzeFiles() {
    if (!txtFiles || txtFiles.length === 0) {
        alert('âš ï¸ Vui lÃ²ng quÃ©t thÆ° má»¥c trÆ°á»›c!');
        return;
    }

    // Load existing analysis from local cache
    let existingAnalysis = [];
    const localData = localStorage.getItem('analysisResults');
    if (localData) {
        try {
            existingAnalysis = JSON.parse(localData).analysisData || [];
        } catch (e) {
            console.error('Error loading existing analysis:', e);
        }
    }

    const analyzedFileNames = existingAnalysis.map(a => a.fileName);
    let filesToAnalyze = txtFiles.filter(f => !analyzedFileNames.includes(f.name));

    if (filesToAnalyze.length === 0) {
        updateStatus('âœ… Táº¥t cáº£ file Ä‘Ã£ Ä‘Æ°á»£c phÃ¢n tÃ­ch');
        analysisData = existingAnalysis;
        displayAdvancedAnalysisResults();
        return;
    }

    const totalFiles = Math.min(filesToAnalyze.length, 50); // Limit to prevent timeout
    analysisData = [...existingAnalysis];
    
    updateStatus(`ğŸ§  Báº¯t Ä‘áº§u phÃ¢n tÃ­ch ${totalFiles} file...`);

    for (let i = 0; i < totalFiles; i++) {
        const file = filesToAnalyze[i];
        updateProgress((i / totalFiles) * 100);
        updateDetailedStatus(`Äang phÃ¢n tÃ­ch: ${file.name} (${i + 1}/${totalFiles})`);

        try {
            // *** FIX: Actually read file content from Google Drive ***
            const content = await readFileFromDrive(file.id);
            const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
            analysisData.push(analysis);
            saveAnalysisLocal();
            
            // Small delay to prevent rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (err) {
            console.error(`Error analyzing ${file.name}:`, err);
            analysisData.push({
                fileName: file.name,
                folderPath: file.folderPath,
                timestamp: new Date().toLocaleString('vi-VN'),
                error: err.message
            });
        }
    }

    displayAdvancedAnalysisResults();
    updateProgress(100);
    updateStatus(`âœ… HoÃ n thÃ nh phÃ¢n tÃ­ch ${totalFiles} file`);
    setTimeout(() => updateProgress(0), 2000);
}
// ===== NEW FUNCTION: READ FILE FROM DRIVE =====
async function readFileFromDrive(fileId) {
    try {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Failed to read file: ${response.status}`);
        }
        
        return await response.text();
    } catch (error) {
        throw new Error(`Error reading file: ${error.message}`);
    }
}
 // ===== STORY ANALYSIS FUNCTIONS =====
async function performAdvancedAnalysis(content, fileName, folderPath) {
    const structure = analyzeStoryStructure(content);
    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;

    // ThÃªm thá»‘ng kÃª chi tiáº¿t
    const sensitiveStats = {
        romanticCount: structure.romantic ? structure.romantic.length : 0,
        sexualCount: structure.sexual ? structure.sexual.length : 0,
        negativeCount: structure.negative ? structure.negative.length : 0,
        familyCount: structure.family ? structure.family.length : 0,
        secretCount: structure.secret ? structure.secret.length : 0
    };

    const emotionStats = {
        positiveCount: structure.emotion?.positive ? structure.emotion.positive.length : 0,
        negativeCount: structure.emotion?.negative ? structure.emotion.negative.length : 0,
        neutralCount: structure.emotion?.neutral ? structure.emotion.neutral.length : 0
    };

    return {
        fileName: fileName,
        folderPath: folderPath,
        timestamp: new Date().toLocaleString('vi-VN'),
        basicStats: { 
            wordCount: wordCount,
            charCount: content.length,
            lineCount: content.split('\n').length
        },
        contentSample: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
        storyStructure: structure,
        sensitiveStats: sensitiveStats,
        emotionStats: emotionStats
    };
}

function analyzeStoryStructure(content) {
    const lower = content.toLowerCase();
    
    // Helper function to find matches
    function findMatches(words) {
        return words.filter(w => lower.includes(w.toLowerCase()));
    }

    // 1. Structural analysis
    const contentLength = content.length;
    const moBai = content.substring(0, Math.min(300, contentLength));
    const ketBai = contentLength > 300 ? content.substring(Math.max(0, contentLength - 300)) : '';
    const thanBai = contentLength > 600 ? content.substring(300, contentLength - 300) : content.substring(300);

    // 2. Narrative perspective
    let ngoike = "NgÃ´i thá»© ba";
    if (/\btÃ´i\b|\bta\b|\bchÃºng tÃ´i\b/i.test(content)) ngoike = "NgÃ´i thá»© nháº¥t";
    if (/\bbáº¡n\b|\bcáº­u\b|\bmÃ y\b/i.test(content)) ngoike = "NgÃ´i thá»© hai";

    // 3. Character detection (proper nouns)
    let characterMatches = content.match(/\b[A-ZÃ€Ãáº¢Ãƒáº Ã‚Ä‚ÄÃŠÃ”Æ Æ¯][a-zÃ Ã¡áº£Ã£áº¡Ã¢ÄƒÄ‘ÃªÃ´Æ¡Æ°]+\b/g) || [];
    let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

    // 4. Dialogue detection
    let dialogues = [];
    const lines = content.split('\n');
    for (const line of lines) {
        if (/["'].*["']/.test(line) || dialogueIndicators.some(ind => line.toLowerCase().includes(ind))) {
            dialogues.push(line.trim());
            if (dialogues.length >= 5) break;
        }
    }

    // 5. Time and place keywords
    const timeKeywords = ["sÃ¡ng", "trÆ°a", "chiá»u", "tá»‘i", "Ä‘Ãªm", "hÃ´m qua", "ngÃ y mai", "nÄƒm", "thÃ¡ng", "tuáº§n", "giá»"];
    const placeKeywords = ["nhÃ ", "lÃ ng", "thÃ nh phá»‘", "rá»«ng", "biá»ƒn", "nÃºi", "trÆ°á»ng", "chá»£", "sÃ´ng", "phá»‘", "quÃª"];
    const eventKeywords = ["gáº·p gá»¡", "chia ly", "thá»­ thÃ¡ch", "xung Ä‘á»™t", "chiáº¿n Ä‘áº¥u", "giáº£i cá»©u", "bÃ­ máº­t", "cÆ°á»›i", "cháº¿t"];

    let times = findMatches(timeKeywords);
    let places = findMatches(placeKeywords);
    let events = findMatches(eventKeywords);

    // 6. Sensitive content analysis
    let romantic = findMatches(sensitiveWords.romantic);
    let sexual = findMatches(sensitiveWords.sexual);
    let negative = findMatches(sensitiveWords.negative);
    let family = findMatches(sensitiveWords.family);
    let secret = findMatches(sensitiveWords.secret);

    // 7. Emotional analysis
    let emotionPos = findMatches(emotionalWords.positive);
    let emotionNeg = findMatches(emotionalWords.negative);
    let emotionNeu = findMatches(emotionalWords.neutral);

    return {
        moBai: moBai,
        thanBai: thanBai.substring(0, 500) + (thanBai.length > 500 ? '...' : ''),
        ketBai: ketBai,
        ngoike: ngoike,
        nhanVat: uniqueChars,
        hoiThoai: dialogues,
        thoiGian: times,
        diaDiem: places,
        tinhHuong: events,
        tuNgu18: sexual, // Renamed for consistency
        romantic: romantic,
        sexual: sexual,
        negative: negative,
        family: family,
        secret: secret,
        emotion: {
            positive: emotionPos,
            negative: emotionNeg,
            neutral: emotionNeu
        }
    };
}
// ===== DISPLAY RESULTS FUNCTION =====
function displayAdvancedAnalysisResults() {
    const safeArray = v => Array.isArray(v) ? v : [];
    const safeJoin = (value, separator = ', ') => {
        if (Array.isArray(value)) {
            return value.join(separator);
        }
        if (typeof value === "string") {
            return value;
        }
        return "";
    };

    const container = document.getElementById('analysisResults');
    if (!analysisData || analysisData.length === 0) {
        container.innerHTML = '<p>ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>';
        return;
    }

    let html = `<h4>ğŸ“Š ÄÃ£ phÃ¢n tÃ­ch ${analysisData.length} file truyá»‡n</h4>`;

    // Statistics summary
    const totalWords = analysisData.reduce((sum, d) => sum + (d.basicStats?.wordCount || 0), 0);
    const avgWords = Math.round(totalWords / analysisData.length);
    html += `<div style="background:#2c3e50;padding:10px;margin:10px 0;border-radius:8px;">
        <p><strong>ğŸ“ˆ Thá»‘ng kÃª tá»•ng quan:</strong></p>
        <p>â€¢ Tá»•ng sá»‘ tá»«: ${totalWords.toLocaleString()} tá»«</p>
        <p>â€¢ Trung bÃ¬nh: ${avgWords.toLocaleString()} tá»«/file</p>
    </div>`;

    analysisData.forEach((d, index) => {
        if (d.error) {
            html += `<div style="background:#e74c3c;padding:10px;margin:10px 0;border-radius:8px;">
                âŒ <strong>${d.fileName}</strong>: ${d.error}
            </div>`;
        } else {
            const struct = d.storyStructure || {};
            html += `<div style="background:#34495e;padding:15px;margin:10px 0;border-radius:8px;">
                <h5>ğŸ“„ ${d.fileName}</h5>
                <p style="color:#bdc3c7;font-size:0.9em;">${d.folderPath} â€¢ ${d.timestamp}</p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
                    <div><strong>ğŸ“Š Sá»‘ tá»«:</strong> ${(d.basicStats?.wordCount || 0).toLocaleString()}</div>
                    <div><strong>ğŸ“ NgÃ´i ká»ƒ:</strong> ${struct.ngoike || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}</div>
                </div>

                <div style="margin:10px 0;">
                    <p><strong>ğŸ‘¥ NhÃ¢n váº­t:</strong> ${safeJoin(struct.nhanVat)}</p>
                    <p><strong>â° Thá»i gian:</strong> ${safeJoin(struct.thoiGian)}</p>
                    <p><strong>ğŸŒ Äá»‹a Ä‘iá»ƒm:</strong> ${safeJoin(struct.diaDiem)}</p>
                    <p><strong>ğŸ­ TÃ¬nh huá»‘ng:</strong> ${safeJoin(struct.tinhHuong)}</p>
                </div>

                <!-- Content Structure -->
                <div style="margin:10px 0;">
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– Má»Ÿ bÃ i</strong></summary>
                        <div class="story-content">${struct.moBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
                    </details>
                    
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– ThÃ¢n bÃ i</strong></summary>
                        <div class="story-content">${struct.thanBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
                    </details>
                    
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– Káº¿t bÃ i</strong></summary>
                        <div class="story-content">${struct.ketBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
                    </details>
                </div>

                <!-- Dialogue -->
                ${struct.hoiThoai && struct.hoiThoai.length > 0 ? `
                <details>
                    <summary style="cursor:pointer;color:#2ecc71;"><strong>ğŸ’¬ Há»™i thoáº¡i (${struct.hoiThoai.length})</strong></summary>
                    <div class="story-content">
                        ${struct.hoiThoai.map(dialogue => `<p>â€¢ ${dialogue}</p>`).join('')}
                    </div>
                </details>` : ''}

                <!-- Emotional Analysis -->
                <div style="margin:10px 0;">
                    <p><strong>ğŸ˜Š Cáº£m xÃºc tÃ­ch cá»±c:</strong> ${safeJoin(safeArray(struct.emotion?.positive))}</p>
                    <p><strong>ğŸ˜¢ Cáº£m xÃºc tiÃªu cá»±c:</strong> ${safeJoin(safeArray(struct.emotion?.negative))}</p>
                    <p><strong>ğŸ˜ Cáº£m xÃºc trung tÃ­nh:</strong> ${safeJoin(safeArray(struct.emotion?.neutral))}</p>
                </div>

                <!-- Content Categories -->
                <div style="margin:10px 0;">
                    <p><strong>ğŸ’ NgÃ´n ngá»¯ tÃ¬nh cáº£m:</strong> ${safeJoin(struct.romantic)}</p>
                    <p><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Gia Ä‘Ã¬nh:</strong> ${safeJoin(struct.family)}</p>
                    <p><strong>ğŸ¤« BÃ­ máº­t:</strong> ${safeJoin(struct.secret)}</p>
                    <p><strong>âš ï¸ TiÃªu cá»±c:</strong> ${safeJoin(struct.negative)}</p>
                    ${struct.sexual && struct.sexual.length > 0 ? `
                        <p><strong>ğŸ” Ná»™i dung nháº¡y cáº£m:</strong> <span style="color:#e74c3c;">${struct.sexual.length} tá»« khÃ³a phÃ¡t hiá»‡n</span></p>
                    ` : ''}
                </div>

                <!-- Content Sample -->
                <details>
                    <summary style="cursor:pointer;color:#95a5a6;"><strong>ğŸ“ Máº«u ná»™i dung</strong></summary>
                    <div class="story-content" style="font-style:italic;">${d.contentSample || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
                </details>
            </div>`;
        }
    });

    container.innerHTML = html;
}
// ===== UI NAVIGATION =====
function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Try to load cached analysis on page load
    displayEmptyState();
});
    // ----------------- HÃ€M PHÃ‚N TÃCH (giá»¯ hoáº·c thay má»›i) -----------------
function analyzeStoryStructure(content) {
  const lower = (content || '').toLowerCase();

  // Ä‘áº£m báº£o fallback náº¿u vocabulary khÃ´ng tá»“n táº¡i (an toÃ n khi dÃ¹ng)
  const sWords = typeof sensitiveWords !== 'undefined' ? sensitiveWords : { romantic: [], sexual: [], negative: [], family: [], secret: [] };
  const eWords = typeof emotionalWords !== 'undefined' ? emotionalWords : { positive: [], negative: [], neutral: [] };
  const dIndicators = typeof dialogueIndicators !== 'undefined' ? dialogueIndicators : [];
  const dPunct = typeof dialoguePunctuation !== 'undefined' ? dialoguePunctuation : [];

  // Má»Ÿ - thÃ¢n - káº¿t
  let moBai = content.substring(0, 300);
  let ketBai = content.substring(Math.max(0, content.length - 300));
  let thanBai = content.substring(300, Math.max(300, content.length - 300));

  // NgÃ´i ká»ƒ
  let ngoike = "NgÃ´i thá»© ba";
  if (/\btÃ´i\b|\bchÃºng tÃ´i\b/.test(lower)) ngoike = "NgÃ´i thá»© nháº¥t";
  if (/\bbáº¡n\b|\bcáº­u\b|\bmÃ y\b/.test(lower)) ngoike = "NgÃ´i thá»© hai";

  // NhÃ¢n váº­t - tÃªn viáº¿t hoa (láº¥y tá»‘i Ä‘a 10)
  let characterMatches = content.match(/\b[A-ZÃ€Ãáº¢Ãƒáº Ã‚Ä‚ÄÃŠÃ”Æ Æ¯][a-zÃ Ã¡áº£Ã£áº¡Ã¢ÄƒÄ‘ÃªÃ´Æ¡Æ°]+\b/g) || [];
  let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

  // Há»™i thoáº¡i (dÃ²ng cÃ³ dáº¥u ngoáº·c hoáº·c chá»©a tá»« chá»‰ thoáº¡i)
  let dialogues = [];
  content.split("\n").forEach(line => {
    if (/".*"/.test(line) || dIndicators.some(k => line.toLowerCase().includes(k))) {
      dialogues.push(line.trim());
    }
  });
  dialogues = dialogues.slice(0, 10);

  // Thá»i gian / Ä‘á»‹a Ä‘iá»ƒm / tÃ¬nh huá»‘ng
  const timeKeywords = ["sÃ¡ng","trÆ°a","chiá»u","tá»‘i","Ä‘Ãªm","hÃ´m qua","ngÃ y mai","nÄƒm","thÃ¡ng"];
  let times = timeKeywords.filter(t => lower.includes(t));
  const placeKeywords = ["nhÃ ","lÃ ng","thÃ nh phá»‘","rá»«ng","biá»ƒn","nÃºi","trÆ°á»ng","chá»£","sÃ´ng"];
  let places = placeKeywords.filter(p => lower.includes(p));
  const eventKeywords = ["gáº·p gá»¡","chia ly","thá»­ thÃ¡ch","xung Ä‘á»™t","chiáº¿n Ä‘áº¥u","giáº£i cá»©u","bÃ­ máº­t"];
  let events = eventKeywords.filter(e => lower.includes(e));

  // Tá»« ngá»¯ nháº¡y cáº£m / cáº£m xÃºc (dÃ¹ng danh sÃ¡ch Ä‘Ã£ khai bÃ¡o)
  function findMatches(list){
    if(!Array.isArray(list) || list.length===0) return [];
    return list.filter(w => lower.includes(w)).slice(0, 20);
  }
  let romantic = findMatches(sWords.romantic);
  let sexual = findMatches(sWords.sexual);
  let negative = findMatches(sWords.negative);
  let family = findMatches(sWords.family);
  let secret = findMatches(sWords.secret);

  let emotionPos = findMatches(eWords.positive);
  let emotionNeg = findMatches(eWords.negative);
  let emotionNeu = findMatches(eWords.neutral);

  // Há»™i thoáº¡i nÃ¢ng cao: dÃ²ng cÃ³ indicator hoáº·c dáº¥u cÃ¢u thoáº¡i
  let dialogueLines = content.split(/\n+/).filter(line => {
    const l = line.toLowerCase();
    return dIndicators.some(ind => l.includes(ind)) || dPunct.some(p => line.includes(p));
  }).slice(0, 10);

  return {
    moBai, thanBai, ketBai,
    ngoike,
    nhanVat: uniqueChars,
    hoiThoai: dialogues,
    dialogueLines,
    thoiGian: times,
    diaDiem: places,
    tinhHuong: events,
    tuNgu18: sexual,
    romantic, sexual, negative, family, secret,
    emotion: { positive: emotionPos, negative: emotionNeg, neutral: emotionNeu }
  };
}
   
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
