<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quáº£n lÃ½ Truyá»‡n vá»›i Google Drive</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, textarea, button { display: block; margin: 10px 0; width: 100%; }
    #history { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ“š Nháº­p truyá»‡n</h2>
  <input type="text" id="storyName" placeholder="TÃªn truyá»‡n">
  <input type="text" id="chapterName" placeholder="TÃªn chÆ°Æ¡ng">
  <textarea id="chapterContent" placeholder="Ná»™i dung chÆ°Æ¡ng..."></textarea>
  <button onclick="saveChapter()">ðŸ’¾ LÆ°u chÆ°Æ¡ng</button>

  <h3>ðŸ“– Lá»‹ch sá»­ truyá»‡n</h3>
  <div id="history"></div>

  <script>
    const CLIENT_ID = "199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // sáº½ set sau khi login
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        handleAuthClick(); // auto login
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw(resp);
        await loadHistory();
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // 2. Táº¡o thÆ° má»¥c
    async function createFolderIfNotExist(folderName) {
      let res = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: "files(id, name)"
      });
      if (res.result.files.length > 0) return res.result.files[0].id;

      let folder = await gapi.client.drive.files.create({
        resource: { name: folderName, mimeType: 'application/vnd.google-apps.folder' },
        fields: 'id'
      });
      return folder.result.id;
    }

    // 3. LÆ°u chÆ°Æ¡ng vÃ o file
    async function saveChapter() {
      let storyName = document.getElementById("storyName").value;
      let chapterName = document.getElementById("chapterName").value;
      let content = document.getElementById("chapterContent").value;

      if (!storyName || !chapterName || !content) {
        alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
        return;
      }

      let folderId = await createFolderIfNotExist(storyName);

      const fileMetadata = { name: chapterName + ".txt", parents: [folderId] };
      const media = new Blob([content], { type: 'text/plain' });
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
      form.append('file', media);

      await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + gapi.client.getToken().access_token }),
        body: form
      });

      alert("ÄÃ£ lÆ°u chÆ°Æ¡ng!");
      loadHistory();
    }

    // 4. Xem láº¡i lá»‹ch sá»­ truyá»‡n
    async function loadHistory() {
      let res = await gapi.client.drive.files.list({
        q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
        fields: "files(id, name)"
      });

      let historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "";

      res.result.files.forEach(folder => {
        let btn = document.createElement("button");
        btn.textContent = folder.name;
        btn.onclick = () => loadChapters(folder.id, folder.name);
        historyDiv.appendChild(btn);
      });
    }

    async function loadChapters(folderId, storyName) {
      let res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: "files(id, name)"
      });

      let historyDiv = document.getElementById("history");
      historyDiv.innerHTML = `<h4>${storyName}</h4>`;
      res.result.files.forEach(file => {
        let p = document.createElement("p");
        p.textContent = file.name;
        historyDiv.appendChild(p);
      });
    }

    gapiLoaded();
    window.gisLoaded = gisLoaded;
  </script>

  <!-- callback khi GIS load -->
  <script>
    window.onload = () => {
      if (typeof google !== "undefined" && google.accounts) {
        gisLoaded();
      }
    };
  </script>
</body>
</html>
