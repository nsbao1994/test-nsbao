<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database v·ªõi AI</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .auth-section { text-align: center; margin-bottom: 30px; }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; border: none; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; cursor: pointer;
            transition: all 0.3s ease; margin: 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-ai {
            background: linear-gradient(45deg, #ff6b6b, #ff9e7d);
        }
        .form-section {
            background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease;
        }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .history-section {
            background: #fff; border-radius: 15px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .history-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; }
        .history-list { max-height: 400px; overflow-y: auto; padding: 10px; }
        .history-item { padding: 15px 20px; border-bottom: 1px solid #eee; transition: background-color 0.3s ease; }
        .history-item:hover { background-color: #f8f9fa; }
        .story-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .story-chapter { color: #666; font-size: 14px; margin-bottom: 5px; }
        .story-date { color: #999; font-size: 12px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        .ai-section { 
            background: linear-gradient(45deg, #ff6b6b, #ff9e7d); 
            color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px;
        }
        .ai-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .ai-option { background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 10px; }
        @media (max-width: 768px) { 
            .grid { grid-template-columns: 1fr; } 
            .ai-options { grid-template-columns: 1fr; }
        }
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border-radius: 15px; width: 80%; max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .ai-output { 
            background: #f8f9fa; padding: 15px; border-radius: 10px; 
            margin-top: 15px; max-height: 300px; overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Qu·∫£n l√Ω Truy·ªán v·ªõi AI</h1>
            <p>S·ª≠ d·ª•ng Google Drive l√†m Database v√† AI ƒë·ªÉ s√°ng t√°c</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            <div class="status" id="status"></div>
            <div id="mainApp" style="display: none;">
                <div class="ai-section">
                    <h2>ü§ñ AI S√°ng T√°c Truy·ªán</h2>
                    <p>AI s·∫Ω h·ªçc t·ª´ c√°c truy·ªán hi·ªán c√≥ v√† s√°ng t√°c truy·ªán m·ªõi v·ªõi ch·ªß ƒë·ªÅ gia ƒë√¨nh, t√¨nh c·∫£m</p>
                    <div class="ai-options">
                        <div class="ai-option">
                            <h3>‚úçÔ∏è Vi·∫øt ti·∫øp truy·ªán c√≥ s·∫µn</h3>
                            <p>AI s·∫Ω vi·∫øt ti·∫øp ch∆∞∆°ng m·ªõi d·ª±a tr√™n truy·ªán ƒë√£ ch·ªçn</p>
                            <select id="aiExistingStory">
                                <option value="">-- Ch·ªçn truy·ªán --</option>
                            </select>
                            <button class="btn btn-ai" onclick="generateContinuation()">Vi·∫øt ti·∫øp</button>
                        </div>
                        <div class="ai-option">
                            <h3>‚ú® T·∫°o truy·ªán ho√†n to√†n m·ªõi</h3>
                            <p>AI s·∫Ω t·∫°o truy·ªán m·ªõi d·ª±a tr√™n phong c√°ch t·ª´ c√°c truy·ªán hi·ªán c√≥</p>
                            <button class="btn btn-ai" onclick="generateNewStory()">T·∫°o truy·ªán m·ªõi</button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                    <form id="storyForm">
                        <div class="form-group">
                            <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                            <select id="storyMode" onchange="toggleStoryMode()">
                                <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                            </select>
                        </div>
                        <div class="form-group" id="newStoryGroup">
                            <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                            <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                        </div>
                        <div class="form-group" id="existingStoryGroup" style="display: none;">
                            <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                            <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                        </div>
                        <div class="form-group">
                            <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                            <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                        </div>
                        <div class="form-group">
                            <label for="storyContent">N·ªôi dung:</label>
                            <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                        </div>
                        <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                    </form>
                </div>
                <div class="grid">
                    <div class="history-section">
                        <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                        <div class="history-list" id="historyList"></div>
                    </div>
                    <div class="history-section">
                        <div class="history-header"><h2>üìÅ Th∆∞ m·ª•c Google Drive</h2></div>
                        <div class="history-list" id="folderList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal hi·ªÉn th·ªã k·∫øt qu·∫£ AI -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>ü§ñ K·∫øt qu·∫£ s√°ng t√°c c·ªßa AI</h2>
            <div id="aiResult" class="ai-output"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="saveAiStory()">üíæ L∆∞u truy·ªán n√†y</button>
                <button class="btn" onclick="regenerateAiStory()">üîÑ T·∫°o l·∫°i</button>
                <button class="btn" onclick="closeModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let currentAiStory = null; // L∆∞u tr·ªØ k·∫øt qu·∫£ AI hi·ªán t·∫°i

// Kh·ªüi t·∫°o Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}
function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}
function maybeEnableButtons() { if (gapi_inited && gis_inited) document.getElementById('authorizeButton').style.display = 'inline-block'; }
function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { showStatus('L·ªói ƒëƒÉng nh·∫≠p: ' + resp.error, 'error'); return; }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
    else tokenClient.requestAccessToken({prompt: ''});
}
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(''); }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}
async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    populateStoryDropdowns();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Kh·ªüi t·∫°o ·ª©ng d·ª•ng th√†nh c√¥ng!', 'success');
    showLoading(false);
}
async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) mainFolderId = response.result.files[0].id;
    else {
        const folder = await gapi.client.drive.files.create({ resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, fields: 'id' });
        mainFolderId = folder.result.id;
    }
}
async function createStoryFolder(storyTitle) {
    const folder = await gapi.client.drive.files.create({
        resource: { name: storyTitle, mimeType: 'application/vnd.google-apps.folder', parents: [mainFolderId] }, fields: 'id'
    });
    return folder.result.id;
}
async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId) {
    const fileMetadata = { name: `${chapterTitle}.txt`, parents: [storyFolderId] };
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}
async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', orderBy: 'createdTime desc'
    });
    const folders = response.result.files; storyHistory = [];
    for (let folder of folders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime, mimeType)'
        });
        
        // ƒê·ªçc n·ªôi dung t·ª´ c√°c file vƒÉn b·∫£n
        const chapters = filesResponse.result.files;
        const chapterContents = [];
        
        for (let chapter of chapters) {
            if (chapter.mimeType === 'text/plain') {
                try {
                    const contentResponse = await gapi.client.drive.files.get({
                        fileId: chapter.id,
                        alt: 'media'
                    });
                    chapterContents.push({
                        name: chapter.name.replace('.txt', ''),
                        content: contentResponse.body,
                        createdTime: chapter.createdTime
                    });
                } catch (error) {
                    console.error("L·ªói ƒë·ªçc n·ªôi dung ch∆∞∆°ng:", error);
                    chapterContents.push({
                        name: chapter.name.replace('.txt', ''),
                        content: "Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung",
                        createdTime: chapter.createdTime
                    });
                }
            } else {
                chapterContents.push({
                    name: chapter.name,
                    content: "",
                    createdTime: chapter.createdTime
                });
            }
        }
        
        storyHistory.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: chapterContents 
        });
    }
    displayHistory(); 
    displayFolders();
    populateStoryDropdowns();
}
function populateStoryDropdowns() {
    const existingStoryDropdown = document.getElementById('existingStory');
    const aiExistingStoryDropdown = document.getElementById('aiExistingStory');
    
    // X√≥a c√°c option c≈© (gi·ªØ l·∫°i option ƒë·∫ßu ti√™n)
    while (existingStoryDropdown.options.length > 1) {
        existingStoryDropdown.remove(1);
    }
    while (aiExistingStoryDropdown.options.length > 1) {
        aiExistingStoryDropdown.remove(1);
    }
    
    // Th√™m c√°c truy·ªán v√†o dropdown
    storyHistory.forEach(story => {
        const option1 = document.createElement('option');
        option1.value = story.folderId;
        option1.textContent = story.storyTitle;
        existingStoryDropdown.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = story.folderId;
        option2.textContent = story.storyTitle;
        aiExistingStoryDropdown.appendChild(option2);
    });
}
function displayHistory() {
    const historyList = document.getElementById('historyList'); historyList.innerHTML = '';
    if (storyHistory.length === 0) { historyList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ truy·ªán n√†o</div>'; return; }
    storyHistory.forEach(story => {
        const historyItem = document.createElement('div'); historyItem.className = 'history-item';
        const chaptersText = story.chapters.map(ch => ch.name).join(', ');
        const date = new Date(story.createdTime).toLocaleString('vi-VN');
        historyItem.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">Ch∆∞∆°ng: ${chaptersText || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</div>
            <div class="story-date">${date}</div>
            <button class="btn" onclick="openStoryDetail('${story.folderId}')">üìñ Xem & Th√™m ch∆∞∆°ng</button>
        `;
        historyList.appendChild(historyItem);
    });
}
function openStoryDetail(folderId) {
    const story = storyHistory.find(s => s.folderId === folderId);
    if (!story) return;
    const detailHtml = `
        <h3>${story.storyTitle}</h3>
        <p><b>C√°c ch∆∞∆°ng:</b> ${story.chapters.map(ch => ch.name).join(', ') || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</p>
        <form onsubmit="addChapter(event, '${story.folderId}', '${story.storyTitle}')">
            <input type="text" id="newChapterTitle" placeholder="T√™n ch∆∞∆°ng m·ªõi" required>
            <textarea id="newChapterContent" placeholder="N·ªôi dung ch∆∞∆°ng..." required></textarea>
            <button type="submit" class="btn">‚ûï Th√™m ch∆∞∆°ng</button>
        </form>
    `;
    document.getElementById('historyList').innerHTML = detailHtml;
}
async function addChapter(e, folderId, storyTitle) {
    e.preventDefault();
    const chapterTitle = document.getElementById('newChapterTitle').value.trim();
    const content = document.getElementById('newChapterContent').value.trim();
    if (!chapterTitle || !content) { showStatus("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); return; }
    showLoading(true);
    try {
        await saveStoryContent(storyTitle, chapterTitle, content, folderId);
        await loadStoryHistory();
        showStatus(`ƒê√£ th√™m ch∆∞∆°ng "${chapterTitle}" v√†o truy·ªán "${storyTitle}" th√†nh c√¥ng!`, "success");
    } catch (error) { showStatus("L·ªói th√™m ch∆∞∆°ng: " + error.message, "error"); }
    showLoading(false);
}
function displayFolders() {
    const folderList = document.getElementById('folderList'); folderList.innerHTML = '';
    if (storyHistory.length === 0) { folderList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ th∆∞ m·ª•c n√†o</div>'; return; }
    storyHistory.forEach(story => {
        const folderItem = document.createElement('div'); folderItem.className = 'history-item';
        folderItem.innerHTML = `<div class="story-title">üìÅ ${story.storyTitle}</div><div class="story-chapter">${story.chapters.length} file(s)</div><div class="story-date">ID: ${story.folderId}</div>`;
        folderList.appendChild(folderItem);
    });
}
function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'L∆∞u Truy·ªán M·ªõi';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Th√™m Ch∆∞∆°ng M·ªõi';
    }
}
document.getElementById('storyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const mode = document.getElementById('storyMode').value;
    const storyTitle = document.getElementById('storyTitle').value.trim();
    const existingStoryId = document.getElementById('existingStory').value;
    const chapterTitle = document.getElementById('chapterTitle').value.trim();
    const storyContent = document.getElementById('storyContent').value.trim();
    
    if (!chapterTitle || !storyContent) { 
        showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error'); 
        return; 
    }
    
    if (mode === 'new' && !storyTitle) {
        showStatus('Vui l√≤ng nh·∫≠p t√™n truy·ªán m·ªõi!', 'error');
        return;
    }
    
    if (mode === 'existing' && !existingStoryId) {
        showStatus('Vui l√≤ng ch·ªçn truy·ªán c√≥ s·∫µn!', 'error');
        return;
    }
    
    showLoading(true);
    try {
        let storyFolderId = null;
        let actualStoryTitle = storyTitle;
        
        if (mode === 'existing') {
            const selectedStory = storyHistory.find(story => story.folderId === existingStoryId);
            if (selectedStory) {
                storyFolderId = selectedStory.folderId;
                actualStoryTitle = selectedStory.storyTitle;
            } else {
                throw new Error("Kh√¥ng t√¨m th·∫•y truy·ªán ƒë√£ ch·ªçn");
            }
        } else {
            // Ki·ªÉm tra xem truy·ªán ƒë√£ t·ªìn t·∫°i ch∆∞a
            const existingStory = storyHistory.find(story => story.storyTitle === storyTitle);
            if (existingStory) {
                storyFolderId = existingStory.folderId;
            } else {
                storyFolderId = await createStoryFolder(storyTitle);
            }
        }
        
        await saveStoryContent(actualStoryTitle, chapterTitle, storyContent, storyFolderId);
        document.getElementById('storyForm').reset();
        await loadStoryHistory();
        showStatus(`ƒê√£ l∆∞u "${actualStoryTitle}" - Ch∆∞∆°ng "${chapterTitle}" th√†nh c√¥ng!`, 'success');
    } catch (error) { 
        showStatus('L·ªói l∆∞u truy·ªán: ' + error.message, 'error'); 
    }
    showLoading(false);
});
function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
function showStatus(message, type) {
    const status = document.getElementById('status');
    status.textContent = message; status.className = `status ${type}`; status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 5000);
}

// ==================== PH·∫¶N M·ªöI: T√çNH NƒÇNG AI ====================

// H√†m ph√¢n t√≠ch n·ªôi dung truy·ªán hi·ªán c√≥ ƒë·ªÉ tr√≠ch xu·∫•t th√¥ng tin
function analyzeStories() {
    let characters = new Set();
    let dialogues = [];
    let settings = [];
    let themes = [];
    
    storyHistory.forEach(story => {
        story.chapters.forEach(chapter => {
            if (chapter.content && chapter.content !== "Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung") {
                // Tr√≠ch xu·∫•t t√™n nh√¢n v·∫≠t (d·ª±a tr√™n c√°c m·∫´u th∆∞·ªùng g·∫∑p)
                const characterMatches = chapter.content.match(/(?:"([^"]+)"|'([^']+)'|‚Äì[^\\n]*|\\b([A-Z·∫Æ·∫∞·∫≤·∫¥·∫∂ƒÇ·∫§·∫¶·∫®·∫™·∫¨√Ç√Å√Ä√É·∫¢·∫†ƒê·∫æ·ªÄ·ªÇ·ªÑ·ªÜ√ä√â√à·∫∫·∫º·∫∏√ç√å·ªàƒ®·ªä·ªê·ªí·ªî·ªñ·ªò√î·ªö·ªú·ªû·ª†·ª¢∆†√ì√í√ï·ªé·ªå·ª®·ª™·ª¨·ªÆ·ª∞∆Ø√ö√ô·ª¶≈®·ª§√ù·ª≤·ª∂·ª∏·ª¥][a-z√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª≠·ªØ·ª±·ª≥·ªµ·ª∑·ªπ]+)\\b)(?=\\s*(?:n√≥i|k√™u|l√™n|th√¨ th·∫ßm|h√©t|h·ªèi|ƒë√°p|tr·∫£ l·ªùi|b·∫£o))/gi);
                if (characterMatches) {
                    characterMatches.forEach(match => {
                        const name = match.replace(/["'‚Äì]/g, '').trim();
                        if (name.length > 1) characters.add(name);
                    });
                }
                
                // Tr√≠ch xu·∫•t h·ªôi tho·∫°i
                const dialogueMatches = chapter.content.match(/"[^"]+"|'[^']+'/g);
                if (dialogueMatches) {
                    dialogues = dialogues.concat(dialogueMatches);
                }
                
                // Ph√¢n t√≠ch ch·ªß ƒë·ªÅ (ƒë∆°n gi·∫£n d·ª±a tr√™n t·ª´ kh√≥a)
                if (chapter.content.toLowerCase().includes('gia ƒë√¨nh')) themes.push('gia ƒë√¨nh');
                if (chapter.content.toLowerCase().includes('t√¨nh y√™u') || chapter.content.toLowerCase().includes('y√™u')) themes.push('t√¨nh y√™u');
                if (chapter.content.toLowerCase().includes('bu·ªìn') || chapter.content.toLowerCase().includes('ƒëau kh·ªï')) themes.push('bu·ªìn');
                if (chapter.content.toLowerCase().includes('h·∫°nh ph√∫c')) themes.push('h·∫°nh ph√∫c');
            }
        });
    });
    
    return {
        characters: Array.from(characters),
        dialogues: dialogues,
        settings: settings,
        themes: Array.from(new Set(themes)) // Lo·∫°i b·ªè c√°c ch·ªß ƒë·ªÅ tr√πng l·∫∑p
    };
}

// H√†m t·∫°o t√™n truy·ªán m·ªõi d·ª±a tr√™n ph√¢n t√≠ch
function generateStoryTitle(analysis) {
    const familyWords = ['Gia ƒê√¨nh', 'T·ªï ·∫§m', 'M√°i Nh√†', 'T√¨nh Th√¢n', 'Huy·∫øt Th·ªëng'];
    const emotionalWords = ['N·ªói Nh·ªõ', 'K√Ω ·ª®c', 'L·∫∑ng Th·∫ßm', 'Gi·ªçt N∆∞·ªõc M·∫Øt', 'Tr√°i Tim', 'Kho·∫£ng Tr·ªëng'];
    const dramaticWords = ['V·ª°', 'Tan', 'M·∫•t', 'Xa', 'L·∫°c', 'Cu·ªëi', 'ƒê·∫ßu'];
    
    const randomFamily = familyWords[Math.floor(Math.random() * familyWords.length)];
    const randomEmotion = emotionalWords[Math.floor(Math.random() * emotionalWords.length)];
    const randomDrama = dramaticWords[Math.floor(Math.random() * dramaticWords.length)];
    
    const patterns = [
        `${randomDrama} ${randomFamily}`,
        `${randomFamily} ${randomEmotion}`,
        `${randomEmotion} ${randomFamily}`,
        `${randomDrama} ${randomEmotion}`,
        `N∆°i ${randomFamily} ${randomDrama}`
    ];
    
    return patterns[Math.floor(Math.random() * patterns.length)];
}

// H√†m t·∫°o t√™n ch∆∞∆°ng m·ªõi
function generateChapterTitle() {
    const prefixes = ['Ch∆∞∆°ng', 'Ph·∫ßn', 'H·ªìi', 'ƒêo·∫°n'];
    const numbers = ['M·ªôt', 'Hai', 'Ba', 'B·ªën', 'NƒÉm', 'S√°u', 'B·∫£y', 'T√°m', 'Ch√≠n', 'M∆∞·ªùi'];
    const themes = ['K·ª∑ Ni·ªám', 'Chia Ly', 'ƒêo√†n T·ª•', 'B√≠ M·∫≠t', 'L·ªùi H·ª©a', 'Ng√†y Mai', 'Qu√° Kh·ª©', 'Hi·ªán T·∫°i', 'T∆∞∆°ng Lai'];
    
    const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
    const randomNumber = numbers[Math.floor(Math.random() * numbers.length)];
    const randomTheme = themes[Math.floor(Math.random() * themes.length)];
    
    const patterns = [
        `${randomPrefix} ${randomNumber}: ${randomTheme}`,
        `${randomTheme} ${randomNumber}`,
        `${randomPrefix} ${randomNumber} - ${randomTheme}`,
        `${randomTheme}`
    ];
    
    return patterns[Math.floor(Math.random() * patterns.length)];
}

// H√†m t·∫°o n·ªôi dung truy·ªán b·∫±ng AI
function generateStoryContent(analysis, isContinuation = false, existingStory = null) {
    // L·∫•y ng·∫´u nhi√™n m·ªôt s·ªë nh√¢n v·∫≠t t·ª´ ph√¢n t√≠ch
    const availableCharacters = analysis.characters.length > 0 
        ? analysis.characters 
        : ['M·∫π', 'Cha', 'Anh', 'Ch·ªã', 'Em', '√îng', 'B√†'];
    
    const mainCharacter = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
    const otherCharacters = availableCharacters.filter(c => c !== mainCharacter);
    const secondCharacter = otherCharacters.length > 0 
        ? otherCharacters[Math.floor(Math.random() * otherCharacters.length)] 
        : 'Ng∆∞·ªùi l·∫°';
    
    // L·∫•y ng·∫´u nhi√™n m·ªôt s·ªë ƒëo·∫°n h·ªôi tho·∫°i t·ª´ ph√¢n t√≠ch (n·∫øu c√≥)
    const availableDialogues = analysis.dialogues.length > 0
        ? analysis.dialogues
        : ['"Con nh·ªõ m·∫π qu√°!"', '"T·∫°i sao l·∫°i l√† con?"', '"Gia ƒë√¨nh m√¨nh s·∫Ω kh√¥ng bao gi·ªù chia l√¨a."'];
    
    const randomDialogue = availableDialogues[Math.floor(Math.random() * availableDialogues.length)];
    
    // X√°c ƒë·ªãnh ch·ªß ƒë·ªÅ ch√≠nh
    const mainTheme = analysis.themes.length > 0 
        ? analysis.themes[Math.floor(Math.random() * analysis.themes.length)]
        : 'gia ƒë√¨nh';
    
    // T·∫°o n·ªôi dung truy·ªán v·ªõi gi·ªçng bu·ªìn, t√¢m l√Ω
    const storyBeginnings = [
        `T√¥i nh·ªõ l·∫°i ng√†y ƒë√≥, khi ${mainCharacter} c√≤n ·ªü b√™n c·∫°nh t√¥i. M·ªçi th·ª© th·∫≠t kh√°c bi·ªát.`,
        `ƒê√£ bao l√¢u r·ªìi k·ªÉ t·ª´ l·∫ßn cu·ªëi t√¥i nghe th·∫•y gi·ªçng n√≥i c·ªßa ${mainCharacter}? C√≥ l·∫Ω l√† qu√° l√¢u r·ªìi.`,
        `Trong cƒÉn ph√≤ng tr·ªëng v·∫Øng n√†y, k√Ω ·ª©c v·ªÅ ${mainCharacter} v·∫´n c√≤n nguy√™n v·∫πn.`,
        `T√¥i kh√¥ng bao gi·ªù nghƒ© r·∫±ng m√¨nh s·∫Ω ph·∫£i s·ªëng thi·∫øu ${mainCharacter}. Cu·ªôc ƒë·ªùi th·∫≠t tr·ªõ tr√™u.`
    ];
    
    const storyMiddles = [
        `R·ªìi m·ªôt ng√†y, m·ªçi th·ª© thay ƒë·ªïi. ${secondCharacter} ƒë·∫øn v√† n√≥i: ${randomDialogue}`,
        `T√¥i nh·∫≠n ra r·∫±ng gia ƒë√¨nh kh√¥ng ph·∫£i l√† n∆°i ƒë·ªÉ quay l∆∞ng l·∫°i, m√† l√† n∆°i ƒë·ªÉ tr·ªü v·ªÅ.`,
        `Nh·ªØng gi·ªçt n∆∞·ªõc m·∫Øt lƒÉn d√†i tr√™n m√° t√¥i khi nh·ªõ v·ªÅ k·ª∑ ni·ªám c≈©. T·∫°i sao ch√∫ng ta kh√¥ng th·ªÉ quay l·∫°i ng√†y x∆∞a?`,
        `Tr√°i tim t√¥i nh∆∞ v·ª° v·ª•n khi nghƒ© v·ªÅ nh·ªØng l·ªùi h·ª©a ch∆∞a th·ª±c hi·ªán ƒë∆∞·ª£c v·ªõi ${mainCharacter}.`
    ];
    
    const storyEndings = [
        `Gi·ªù ƒë√¢y, t√¥i ch·ªâ c√≤n bi·∫øt nh√¨n v·ªÅ ph√≠a tr∆∞·ªõc v·ªõi hy v·ªçng mong manh r·∫±ng m·ªôt ng√†y n√†o ƒë√≥, m·ªçi th·ª© s·∫Ω t·ªët ƒë·∫πp h∆°n.`,
        `T√¥i bi·∫øt r·∫±ng ${mainCharacter} s·∫Ω kh√¥ng mu·ªën th·∫•y t√¥i bu·ªìn b√£ nh∆∞ th·∫ø n√†y. Nh∆∞ng l√†m sao t√¥i c√≥ th·ªÉ vui ƒë∆∞·ª£c?`,
        `D√π th·ªùi gian c√≥ tr√¥i qua, t√¨nh y√™u th∆∞∆°ng d√†nh cho ${mainCharacter} trong t√¥i v·∫´n nguy√™n v·∫πn.`,
        `V√† c·ª© th·∫ø, t√¥i ti·∫øp t·ª•c b∆∞·ªõc ƒëi tr√™n con ƒë∆∞·ªùng ƒë·ªùi, mang theo n·ªói nh·ªõ kh√¥n ngu√¥i v·ªÅ nh·ªØng ng√†y th√°ng ƒë√£ qua.`
    ];
    
    let content = '';
    
    if (isContinuation && existingStory) {
        // N·∫øu l√† ti·∫øp n·ªëi truy·ªán c√≥ s·∫µn, s·ª≠ d·ª•ng th√¥ng tin t·ª´ truy·ªán ƒë√≥
        content += `Ti·∫øp theo ${existingStory.storyTitle}:\n\n`;
        content += storyMiddles[Math.floor(Math.random() * storyMiddles.length)] + ' ';
        content += storyEndings[Math.floor(Math.random() * storyEndings.length)];
    } else {
        // N·∫øu l√† truy·ªán m·ªõi ho√†n to√†n
        content += storyBeginnings[Math.floor(Math.random() * storyBeginnings.length)] + ' ';
        content += storyMiddles[Math.floor(Math.random() * storyMiddles.length)] + ' ';
        content += storyEndings[Math.floor(Math.random() * storyEndings.length)];
    }
    
    return content;
}

// H√†m t·∫°o truy·ªán m·ªõi b·∫±ng AI
async function generateNewStory() {
    showLoading(true);
    try {
        // Ph√¢n t√≠ch c√°c truy·ªán hi·ªán c√≥
        const analysis = analyzeStories();
        
        // T·∫°o th√¥ng tin truy·ªán m·ªõi
        const storyTitle = generateStoryTitle(analysis);
        const chapterTitle = generateChapterTitle();
        const storyContent = generateStoryContent(analysis);
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£ trong modal
        currentAiStory = {
            title: storyTitle,
            chapterTitle: chapterTitle,
            content: storyContent,
            isNew: true
        };
        
        showAiResult(storyTitle, chapterTitle, storyContent);
        showLoading(false);
    } catch (error) {
        showStatus("L·ªói t·∫°o truy·ªán: " + error.message, "error");
        showLoading(false);
    }
}

// H√†m vi·∫øt ti·∫øp truy·ªán c√≥ s·∫µn b·∫±ng AI
async function generateContinuation() {
    const storySelect = document.getElementById('aiExistingStory');
    const selectedStoryId = storySelect.value;
    
    if (!selectedStoryId) {
        showStatus("Vui l√≤ng ch·ªçn m·ªôt truy·ªán ƒë·ªÉ vi·∫øt ti·∫øp", "error");
        return;
    }
    
    showLoading(true);
    try {
        const selectedStory = storyHistory.find(story => story.folderId === selectedStoryId);
        if (!selectedStory) {
            throw new Error("Kh√¥ng t√¨m th·∫•y truy·ªán ƒë√£ ch·ªçn");
        }
        
        // Ph√¢n t√≠ch c√°c truy·ªán hi·ªán c√≥
        const analysis = analyzeStories();
        
        // T·∫°o th√¥ng tin ch∆∞∆°ng ti·∫øp theo
        const chapterTitle = generateChapterTitle();
        const storyContent = generateStoryContent(analysis, true, selectedStory);
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£ trong modal
        currentAiStory = {
            title: selectedStory.storyTitle,
            chapterTitle: chapterTitle,
            content: storyContent,
            isNew: false,
            folderId: selectedStoryId
        };
        
        showAiResult(selectedStory.storyTitle, chapterTitle, storyContent);
        showLoading(false);
    } catch (error) {
        showStatus("L·ªói t·∫°o truy·ªán: " + error.message, "error");
        showLoading(false);
    }
}

// Hi·ªÉn th·ªã k·∫øt qu·∫£ AI trong modal
function showAiResult(storyTitle, chapterTitle, content) {
    document.getElementById('aiResult').innerHTML = `
        <h3>${storyTitle}</h3>
        <h4>${chapterTitle}</h4>
        <p>${content.replace(/\n/g, '<br>')}</p>
    `;
    document.getElementById('aiModal').style.display = 'block';
}

// ƒê√≥ng modal
function closeModal() {
    document.getElementById('aiModal').style.display = 'none';
}

// L∆∞u truy·ªán do AI t·∫°o
async function saveAiStory() {
    if (!currentAiStory) return;
    
    showLoading(true);
    try {
        let storyFolderId = null;
        
        if (currentAiStory.isNew) {
            // Ki·ªÉm tra xem truy·ªán ƒë√£ t·ªìn t·∫°i ch∆∞a
            const existingStory = storyHistory.find(story => story.storyTitle === currentAiStory.title);
            if (existingStory) {
                storyFolderId = existingStory.folderId;
            } else {
                storyFolderId = await createStoryFolder(currentAiStory.title);
            }
        } else {
            storyFolderId = currentAiStory.folderId;
        }
        
        await saveStoryContent(currentAiStory.title, currentAiStory.chapterTitle, currentAiStory.content, storyFolderId);
        await loadStoryHistory();
        showStatus(`ƒê√£ l∆∞u "${currentAiStory.title}" - Ch∆∞∆°ng "${currentAiStory.chapterTitle}" th√†nh c√¥ng!`, 'success');
        closeModal();
    } catch (error) {
        showStatus('L·ªói l∆∞u truy·ªán: ' + error.message, 'error');
    }
    showLoading(false);
}

// T·∫°o l·∫°i truy·ªán v·ªõi AI
function regenerateAiStory() {
    if (!currentAiStory) return;
    
    if (currentAiStory.isNew) {
        generateNewStory();
    } else {
        generateContinuation();
    }
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
window.onload = function() {
    initializeGapi();
    initializeGis();
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutButton;
};
</script>
</body>
</html>
