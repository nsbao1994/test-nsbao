<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Trình Phân Tích & Tạo Truyện Nâng Cao</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    :root {
      --primary-color: #9b59b6;
      --secondary-color: #2980b9;
      --dark-color: #1e1e1e;
      --light-color: #bdc3c7;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --text-color: #ecf0f1;
      --card-bg: rgba(30, 30, 30, 0.95);
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #121212;
      color: var(--text-color);
      font-family: sans-serif;
      min-height: 100vh;
    }

    .container {
      padding: 16px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: #2c3e50;
    }

    .menu-item {
      color: var(--light-color);
      text-decoration: none;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .menu-item.active {
      opacity: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
    .empty-state {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 20px;
}

    .btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
    }

    .btn:disabled {
      background: #777;
      cursor: not-allowed;
    }

    .story-content {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      max-height: 50vh;
      overflow-y: auto;
    }
    .story-generator {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
}

.generator-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 15px 0;
}

.control-group {
    display: flex;
    flex-direction: column;
}

.control-group label {
    color: var(--text-color);
    margin-bottom: 5px;
    font-weight: bold;
}

.control-group select, 
.control-group input[type="number"],
.control-group textarea {
    background: #2c3e50;
    color: var(--text-color);
    border: 1px solid #34495e;
    border-radius: 8px;
    padding: 8px;
}

.story-preview {
    background: #1e1e1e;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid #34495e;
}

.story-stats {
    background: #2c3e50;
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 0.9em;
}

.template-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.template-card {
    background: #34495e;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.template-card:hover {
    border-color: var(--primary-color);
    background: #3d566e;
}

.template-card.selected {
    border-color: var(--success-color);
    background: #2d4a3e;
}

.btn-generate {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn-generate:disabled {
    background: #777;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 768px) {
    .generator-controls {
        grid-template-columns: 1fr;
    }
}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
      <p>Phân tích nâng cao và tạo truyện tự động</p>
    </div>
    <div id="tab-analysis" class="tab-content active">
      <div class="card">
        <h3>🔍 Phân tích nguồn truyện</h3>
        <div class="status-info" id="statusInfo">🔴 Chưa kết nối Google
          Drive</div>
        <div class="detailed-status" id="detailedStatus"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="height:10px;background:#9b59b6;width:0%"></div>
        </div>
        <button class="btn" onclick="handleAuthClick()">📁 Kết nối Google
          Drive</button>
        <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>🔍
          Quét thư mục</button>
        <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>🧠 Phân tích nâng cao</button>
        <button class="btn" id="downloadAnalysisBtn" onclick="downloadAnalysisFromDrive()" disabled>📥 Tải phân
          tích</button>
        <button class="btn" onclick="loadAnalysisLocal()">🔄 Tải cache
          local</button>
        <button class="btn" onclick="uploadAnalysisToDrive()">☁️ Upload phân
          tích</button>
          <button class="btn" onclick="clearLocalCache()" style="background: #e74c3c;">🗑️ Xóa cache</button>
      </div>
      <div class="card">
        <h3>📊 Kết quả phân tích</h3>
        <div id="analysisResults">
          <p>Chưa có dữ liệu phân tích.</p>
        </div>
      </div>
    </div>
    <div id="tab-generator" class="tab-content">
    <div class="card story-generator">
        <h3>✍️ Tạo Truyện Thông Minh</h3>
        <p style="color: #bdc3c7; margin-bottom: 15px;">
            Sử dụng AI để tạo truyện dựa trên phân tích dữ liệu hiện có
        </p>

        <!-- Template Selection -->
        <div class="control-group">
            <label>📝 Chọn Template Truyện:</label>
            <div class="template-selector" id="templateSelector">
                <div class="template-card" data-template="romance">
                    <h4>💕 Lãng Mạn</h4>
                    <p>Câu chuyện tình yêu ngọt ngào</p>
                </div>
                <div class="template-card" data-template="family">
                    <h4>👨‍👩‍👧‍👦 Gia Đình</h4>
                    <p>Tình cảm gia đình ấm áp</p>
                </div>
                <div class="template-card" data-template="adventure">
                    <h4>🗺️ Phiêu Lưu</h4>
                    <p>Cuộc phiêu lưu kỳ thú</p>
                </div>
                <div class="template-card" data-template="drama">
                    <h4>🎭 Chính Kịch</h4>
                    <p>Tình huống phức tạp, cảm xúc sâu sắc</p>
                </div>
            </div>
        </div>

        <!-- Generation Controls -->
        <div class="generator-controls">
            <div class="control-group">
                <label>📏 Độ dài truyện:</label>
                <select id="storyLength">
                    <option value="short">Ngắn (200-500 từ)</option>
                    <option value="medium" selected>Trung bình (500-1000 từ)</option>
                    <option value="long">Dài (1000-2000 từ)</option>
                </select>
            </div>

            <div class="control-group">
                <label>👁️ Ngôi kể:</label>
                <select id="narrativePerspective">
                    <option value="auto">Tự động (dựa trên phân tích)</option>
                    <option value="first">Ngôi thứ nhất</option>
                    <option value="third">Ngôi thứ ba</option>
                </select>
            </div>

            <div class="control-group">
                <label>🎯 Độ tương tự với dữ liệu gốc:</label>
                <input type="range" id="similarityLevel" min="1" max="10" value="7" 
                       oninput="document.getElementById('similarityValue').textContent = this.value">
                <span id="similarityValue">7</span>/10
            </div>

            <div class="control-group">
                <label>🎨 Phong cách viết:</label>
                <select id="writingStyle">
                    <option value="auto">Tự động</option>
                    <option value="descriptive">Miêu tả chi tiết</option>
                    <option value="dialogue">Nhiều hội thoại</option>
                    <option value="emotional">Cảm xúc mạnh</option>
                    <option value="simple">Đơn giản, dễ hiểu</option>
                </select>
            </div>
        </div>

        <!-- Custom Prompt -->
        <div class="control-group">
            <label>💭 Yêu cầu đặc biệt (tùy chọn):</label>
            <textarea id="customPrompt" rows="3" placeholder="Ví dụ: Tập trung vào tình cảm gia đình, có twist bất ngờ, kết thúc có hậu..."></textarea>
        </div>

        <!-- Generate Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn-generate" onclick="generateStory()" id="generateBtn">
                🚀 Tạo Truyện Thông Minh
            </button>
        </div>

        <!-- Story Stats -->
        <div class="story-stats" id="generationStats" style="display: none;">
            <p><strong>📊 Thông tin tạo truyện:</strong></p>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Generated Story Display -->
    <div class="card">
        <h3>📖 Truyện Được Tạo</h3>
        <div id="generatedStory" class="story-preview">
            <p style="color: #7f8c8d; font-style: italic;">
                Chưa có truyện nào được tạo. Hãy chọn template và nhấn "Tạo Truyện Thông Minh" để bắt đầu!
            </p>
        </div>
        
        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 15px;">
            <button class="btn" onclick="copyStory()" id="copyBtn" disabled>📋 Sao Chép</button>
            <button class="btn" onclick="saveStoryToDrive()" id="saveBtn" disabled>💾 Lưu lên Drive</button>
            <button class="btn" onclick="regenerateStory()" id="regenBtn" disabled>🔄 Tạo Lại</button>
        </div>
    </div>
</div>
  </div>
  <div class="bottom-menu">
    <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">🔍 Phân tích</a>
    <a href="#" class="menu-item" onclick="switchTab('tab-generator')">✍️ Tạo truyện</a>

  </div>
  <script>
    const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    let tokenClient, gapi_inited = false, gsi_inited = false;
    let analysisData = [];
    const ANALYSIS_CACHE_NAME = 'AnalysisResults_QuanLyTruyen.json';
    let txtFiles = [];
 // Từ nhạy cảm cho phân tích nâng cao
    const sensitiveWords = {
      romantic: ['yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'âm áp', 'say đắm', 'đam mê', 'dịu dàng', 'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi'],
      sexual: [
        'gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục',
        'dâm', 'dục', 'khoái cảm', 'kích thích', 'khoả thân', 'lõa thể',
        'sướng', 'rên rỉ', 'nứng', 'ướt át', 'cao trào', 'cực khoái', 'xuất tinh',
        'dương vật', 'cặc', 'buồi', 'chim', 'cái ấy',
        'âm đạo', 'lồn', 'bướm', 'âm hộ', 'hột le', 'mu', 'lỗ', 'xoạc',
        'bú vú', 'vú to', 'vú căng', 'bú mút', 'ngực trần', 'ngực khủng', 'đầu ti',
        'bú lồn', 'bú cặc', 'liếm lồn', 'liếm bi', 'nuốt tinh', 'bú hột le', 'bú đầu cặc',
        'tử cung', 'bắn vào tử cung', 'cặc dài 20cm', 'ngậm tinh', 'chịch', 'địt', 'nắc',
        'thổi kèn', 'bj', 'hj', 'anal', 'doggy', '69', 'threesome', 'thủ dâm',
        'chơi gái', 'đĩ', 'gái mại dâm', 'mông to', 'thụt ra thụt vào', 'cắm sâu',
        'sờ soạng', 'mút', 'cắn', 'xoa', 'vuốt ve', 'húp sò', 'phê', 'nghiện sex',
        'xoạc lồn', 'xoạc cặc', 'tra tấn tình dục', 'hành xác', 'chịu trận',
        'nhét', 'đút', 'làm nhục', 'bóp vú', 'tét đít', 'vỗ mông', 'túm tóc',
        'bạo dâm', 'cưỡng hiếp', 'hiếp dâm', 'loạn luân', 'thằng cha', 'ông già dâm đãng',
        'con đĩ', 'con cave', 'chị dâu', 'em dâu', 'anh rể', 'chị gái', 'mẹ chồng', 'cha con', 'mẹ con',
        'rên la', 'rên rỉ', 'hét lên vì sướng', 'mắt lờ đờ', 'mồ hôi nhễ nhại',
        'bắn tinh', 'phun tinh', 'tinh dịch', 'tinh tràn', 'nuốt sạch tinh',
        'mùi tanh', 'vị mặn', 'ướt đẫm', 'nước nhờn', 'dịch nhờn',
        // ===== Hành động & tình dục =====
        'làm tình', 'quan hệ', 'ân ái', 'thủ dâm', 'kích thích',
        'cởi đồ', 'vuốt ve', 'sờ mó', 'ôm hôn', 'thâm nhập',
        'rên rỉ', 'xuất tinh', 'cao trào', 'cực khoái', 'ướt át',

        // ===== Lời thoại tình dục chung =====
        '"muốn anh"', '"muốn em"', '"làm em sướng"', '"cứng quá"',
        '"em ướt rồi"', '"mạnh lên"', '"ra đi"', '"bắn vào trong"',

        // ===== Quan hệ gia đình nhạy cảm =====
        'bố chồng', 'con dâu', 'cha chồng', 'nàng dâu',
        '"bố chồng"', '"con dâu"', '"cha chồng"', '"nàng dâu"',
        '"bố chồng ơi"', '"con dâu ngoan"', '"bố chồng làm cho con"',
        '"con dâu của bố"', '"bố muốn con"', '"bố chồng không chịu nổi"',
        '"con dâu sướng quá"', '"làm dâu bố"', '"bố chồng yêu con dâu"',

        // ===== Các tình huống thoại đặc thù =====
        'quan hệ với bố chồng', 'quan hệ cùng con dâu',
        'chịch con dâu', 'bố chồng đụ con dâu', 'bố chồng hiếp con dâu',
        'làm tình với con dâu', 'bố chồng ôm con dâu',
        'con dâu rên', 'bố chồng thỏa mãn', 'bố chồng cưỡng hiếp'
      ],
      negative: ['ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi', 'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung'],
      family: ['bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà', 'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ'],
      secret: ['bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm', 'lặng lẽ', 'kín đáo', 'riêng tư']
    };

    const emotionalWords = {
      positive: ['vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 'thành công', 'hy vọng'],
      negative: ['buồn', 'đau', 'khổ', 'tệ', 'xấu', 'thất bại', 'tuyệt vọng', 'ghét', 'tức giận', 'lo lắng', 'sợ hãi', 'khóc', 'tang thương', 'bất hạnh', 'dối trá', 'phản bội', 'lừa dối', 'xót xa', 'đau đớn', 'xấu hổ', 'tủi nhục'],
      neutral: ['bình thường', 'thông thường', 'trung bình', 'ổn', 'được', 'tạm ổn']
    };

    // Từ khóa đặc biệt cho phân tích hội thoại
    const dialogueIndicators = ['nói', 'bảo', 'hỏi', 'đáp', 'thưa', 'kêu', 'gọi', 'hét', 'la', 'thét', 'thì thầm', 'rủ rỉ', 'lên tiếng', 'phát biểu', 'trả lời', 'hỏi lại', 'đáp lại'];
    const dialoguePunctuation = ['"', "'", ':', ';', '-', '—', '–'];
    // ===== GOOGLE API INITIALIZATION =====
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC]
    });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
    });
    gsi_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gsi_inited) {
        document.getElementById('scanBtn').disabled = false;
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        gapi.client.setToken({access_token: resp.access_token});
        updateStatus('🟢 Đã kết nối Google Drive');
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('downloadAnalysisBtn').disabled = false;
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

// ===== UI UPDATE FUNCTIONS =====
function updateStatus(msg) {
    document.getElementById('statusInfo').innerText = msg;
}

function updateProgress(p) {
    document.getElementById('progressBar').style.width = p + '%';
}

function updateDetailedStatus(msg) {
    document.getElementById('detailedStatus').innerText = msg;
}
  // ===== LOCAL STORAGE FUNCTIONS =====
function saveAnalysisLocal() {
    const analysisContent = {
        analysisData: analysisData,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem('analysisResults', JSON.stringify(analysisContent));
}

function loadAnalysisLocal() {
    const data = localStorage.getItem('analysisResults');
    if (data) {
        try {
            const parsed = JSON.parse(data);
            analysisData = parsed.analysisData || [];
            displayAdvancedAnalysisResults();
            updateStatus('✅ Đã tải cache local');
            return true;
        } catch (e) {
            console.error('Error loading local cache:', e);
            updateStatus('❌ Lỗi khi tải cache local');
        }
    } else {
        updateStatus('⚠️ Không có cache local');
        displayEmptyState();
    }
    return false;
}
// ===== NEW FUNCTION: CLEAR CACHE & EMPTY STATE =====
function clearLocalCache() {
    if (confirm('Bạn có chắc muốn xóa toàn bộ cache local?')) {
        localStorage.removeItem('analysisResults');
        analysisData = [];
        displayEmptyState();
        updateStatus('🗑️ Đã xóa cache local');
    }
}

function displayEmptyState() {
    const container = document.getElementById('analysisResults');
    container.innerHTML = `
        <div class="empty-state">
            <p>📭 Chưa có dữ liệu phân tích.</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                Hãy kết nối Google Drive, quét thư mục và phân tích để xem kết quả.
            </p>
        </div>
    `;
}
   // ===== GOOGLE DRIVE FUNCTIONS =====
function uploadAnalysisToDrive() {
    if (!analysisData || analysisData.length === 0) {
        alert("⚠️ Không có dữ liệu phân tích để upload!");
        return;
    }

    const fileContent = JSON.stringify(analysisData, null, 2);
    const file = new Blob([fileContent], { type: 'application/json' });

    const metadata = {
        name: "analysisData.json",
        mimeType: "application/json"
    };

    const accessToken = gapi.client.getToken().access_token;
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", file);

    fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
    }).then(res => res.json()).then(val => {
        alert("✅ Đã upload phân tích lên Google Drive: " + val.id);
    }).catch(err => {
        console.error("Upload lỗi:", err);
        alert("❌ Lỗi khi upload: " + err.message);
    });
}

async function downloadAnalysisFromDrive() {
    try {
        const accessToken = gapi.client.getToken().access_token;

        let res = await fetch(
            "https://www.googleapis.com/drive/v3/files?q=name='analysisData.json'&fields=files(id,name)",
            { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let data = await res.json();

        if (!data.files || data.files.length === 0) {
            alert("⚠️ Không tìm thấy file analysisData.json trên Google Drive!");
            return;
        }

        const fileId = data.files[0].id;

        let fileRes = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let content = await fileRes.json();

        analysisData = content;
        saveAnalysisLocal();

        alert("✅ Đã tải phân tích về từ Google Drive!");
        displayAdvancedAnalysisResults();

    } catch (err) {
        console.error("Download lỗi:", err);
        alert("❌ Lỗi khi tải phân tích từ Google Drive: " + err.message);
    }
}

const ROOT_FOLDER_NAME = "QuanLyTruyen";
   // ===== SCAN FOLDER FUNCTION =====
async function scanFolder() {
    updateStatus("🔍 Đang quét thư mục QuanLyTruyen...");
    updateProgress(5);

    try {
        const folderRes = await gapi.client.drive.files.list({
            q: `mimeType='application/vnd.google-apps.folder' and name='${ROOT_FOLDER_NAME}' and trashed=false`,
            fields: "files(id, name)"
        });

        if (!folderRes.result.files || folderRes.result.files.length === 0) {
            updateStatus("❌ Không tìm thấy thư mục QuanLyTruyen trên Google Drive!");
            return;
        }

        const rootFolderId = folderRes.result.files[0].id;
        txtFiles = [];
        await fetchFilesRecursive(rootFolderId, ROOT_FOLDER_NAME);

        if (txtFiles.length === 0) {
            updateStatus("⚠️ Không có file .txt nào trong QuanLyTruyen.");
            return;
        }

        updateStatus(`✅ Đã quét được ${txtFiles.length} file .txt`);
        updateProgress(100);
        document.getElementById("analyzeBtn").disabled = false;

    } catch (err) {
        console.error("❌ Lỗi khi quét thư mục:", err);
        updateStatus("❌ Lỗi khi quét thư mục: " + err.message);
    }
}

async function fetchFilesRecursive(folderId, folderPath) {
    let pageToken = null;
    do {
        const res = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed=false`,
            fields: "nextPageToken, files(id, name, mimeType)",
            pageToken: pageToken
        });

        for (const file of res.result.files) {
            if (file.mimeType === "application/vnd.google-apps.folder") {
                await fetchFilesRecursive(file.id, `${folderPath}/${file.name}`);
            } else if (file.mimeType === "text/plain" || file.name.endsWith(".txt")) {
                txtFiles.push({
                    id: file.id,
                    name: file.name,
                    folderPath: folderPath
                });
            }
        }
        pageToken = res.result.nextPageToken;
    } while (pageToken);
}


// ===== ANALYZE FILES FUNCTION (FIXED) =====
async function analyzeFiles() {
    if (!txtFiles || txtFiles.length === 0) {
        alert('⚠️ Vui lòng quét thư mục trước!');
        return;
    }

    // Load existing analysis from local cache
    let existingAnalysis = [];
    const localData = localStorage.getItem('analysisResults');
    if (localData) {
        try {
            existingAnalysis = JSON.parse(localData).analysisData || [];
        } catch (e) {
            console.error('Error loading existing analysis:', e);
        }
    }

    const analyzedFileNames = existingAnalysis.map(a => a.fileName);
    let filesToAnalyze = txtFiles.filter(f => !analyzedFileNames.includes(f.name));

    if (filesToAnalyze.length === 0) {
        updateStatus('✅ Tất cả file đã được phân tích');
        analysisData = existingAnalysis;
        displayAdvancedAnalysisResults();
        return;
    }

    const totalFiles = Math.min(filesToAnalyze.length, 50); // Limit to prevent timeout
    analysisData = [...existingAnalysis];
    
    updateStatus(`🧠 Bắt đầu phân tích ${totalFiles} file...`);

    for (let i = 0; i < totalFiles; i++) {
        const file = filesToAnalyze[i];
        updateProgress((i / totalFiles) * 100);
        updateDetailedStatus(`Đang phân tích: ${file.name} (${i + 1}/${totalFiles})`);

        try {
            // *** FIX: Actually read file content from Google Drive ***
            const content = await readFileFromDrive(file.id);
            const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
            analysisData.push(analysis);
            saveAnalysisLocal();
            
            // Small delay to prevent rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (err) {
            console.error(`Error analyzing ${file.name}:`, err);
            analysisData.push({
                fileName: file.name,
                folderPath: file.folderPath,
                timestamp: new Date().toLocaleString('vi-VN'),
                error: err.message
            });
        }
    }

    displayAdvancedAnalysisResults();
    updateProgress(100);
    updateStatus(`✅ Hoàn thành phân tích ${totalFiles} file`);
    setTimeout(() => updateProgress(0), 2000);
}
// ===== NEW FUNCTION: READ FILE FROM DRIVE =====
async function readFileFromDrive(fileId) {
    try {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Failed to read file: ${response.status}`);
        }
        
        return await response.text();
    } catch (error) {
        throw new Error(`Error reading file: ${error.message}`);
    }
}
 // ===== STORY ANALYSIS FUNCTIONS =====
async function performAdvancedAnalysis(content, fileName, folderPath) {
    const structure = analyzeStoryStructure(content);
    const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;

    // Thêm thống kê chi tiết
    const sensitiveStats = {
        romanticCount: structure.romantic ? structure.romantic.length : 0,
        sexualCount: structure.sexual ? structure.sexual.length : 0,
        negativeCount: structure.negative ? structure.negative.length : 0,
        familyCount: structure.family ? structure.family.length : 0,
        secretCount: structure.secret ? structure.secret.length : 0
    };

    const emotionStats = {
        positiveCount: structure.emotion?.positive ? structure.emotion.positive.length : 0,
        negativeCount: structure.emotion?.negative ? structure.emotion.negative.length : 0,
        neutralCount: structure.emotion?.neutral ? structure.emotion.neutral.length : 0
    };

    return {
        fileName: fileName,
        folderPath: folderPath,
        timestamp: new Date().toLocaleString('vi-VN'),
        basicStats: { 
            wordCount: wordCount,
            charCount: content.length,
            lineCount: content.split('\n').length
        },
        contentSample: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
        storyStructure: structure,
        sensitiveStats: sensitiveStats,
        emotionStats: emotionStats
    };
}

function analyzeStoryStructure(content) {
    const lower = content.toLowerCase();
    
    // Helper function to find matches
    function findMatches(words) {
        return words.filter(w => lower.includes(w.toLowerCase()));
    }

    // 1. Structural analysis
    const contentLength = content.length;
    const moBai = content.substring(0, Math.min(300, contentLength));
    const ketBai = contentLength > 300 ? content.substring(Math.max(0, contentLength - 300)) : '';
    const thanBai = contentLength > 600 ? content.substring(300, contentLength - 300) : content.substring(300);

    // 2. Narrative perspective
    let ngoike = "Ngôi thứ ba";
    if (/\btôi\b|\bta\b|\bchúng tôi\b/i.test(content)) ngoike = "Ngôi thứ nhất";
    if (/\bbạn\b|\bcậu\b|\bmày\b/i.test(content)) ngoike = "Ngôi thứ hai";

    // 3. Character detection (proper nouns)
    let characterMatches = content.match(/\b[A-ZÀÁẢÃẠÂĂĐÊÔƠƯ][a-zàáảãạâăđêôơư]+\b/g) || [];
    let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

    // 4. Dialogue detection
    let dialogues = [];
    const lines = content.split('\n');
    for (const line of lines) {
        if (/["'].*["']/.test(line) || dialogueIndicators.some(ind => line.toLowerCase().includes(ind))) {
            dialogues.push(line.trim());
            if (dialogues.length >= 5) break;
        }
    }

    // 5. Time and place keywords
    const timeKeywords = ["sáng", "trưa", "chiều", "tối", "đêm", "hôm qua", "ngày mai", "năm", "tháng", "tuần", "giờ"];
    const placeKeywords = ["nhà", "làng", "thành phố", "rừng", "biển", "núi", "trường", "chợ", "sông", "phố", "quê"];
    const eventKeywords = ["gặp gỡ", "chia ly", "thử thách", "xung đột", "chiến đấu", "giải cứu", "bí mật", "cưới", "chết"];

    let times = findMatches(timeKeywords);
    let places = findMatches(placeKeywords);
    let events = findMatches(eventKeywords);

    // 6. Sensitive content analysis
    let romantic = findMatches(sensitiveWords.romantic);
    let sexual = findMatches(sensitiveWords.sexual);
    let negative = findMatches(sensitiveWords.negative);
    let family = findMatches(sensitiveWords.family);
    let secret = findMatches(sensitiveWords.secret);

    // 7. Emotional analysis
    let emotionPos = findMatches(emotionalWords.positive);
    let emotionNeg = findMatches(emotionalWords.negative);
    let emotionNeu = findMatches(emotionalWords.neutral);

    return {
        moBai: moBai,
        thanBai: thanBai.substring(0, 500) + (thanBai.length > 500 ? '...' : ''),
        ketBai: ketBai,
        ngoike: ngoike,
        nhanVat: uniqueChars,
        hoiThoai: dialogues,
        thoiGian: times,
        diaDiem: places,
        tinhHuong: events,
        tuNgu18: sexual, // Renamed for consistency
        romantic: romantic,
        sexual: sexual,
        negative: negative,
        family: family,
        secret: secret,
        emotion: {
            positive: emotionPos,
            negative: emotionNeg,
            neutral: emotionNeu
        }
    };
}
// ===== DISPLAY RESULTS FUNCTION =====
function displayAdvancedAnalysisResults() {
    const safeArray = v => Array.isArray(v) ? v : [];
    const safeJoin = (value, separator = ', ') => {
        if (Array.isArray(value)) {
            return value.join(separator);
        }
        if (typeof value === "string") {
            return value;
        }
        return "";
    };

    const container = document.getElementById('analysisResults');
    if (!analysisData || analysisData.length === 0) {
        container.innerHTML = '<p>Chưa có dữ liệu phân tích.</p>';
        return;
    }

    let html = `<h4>📊 Đã phân tích ${analysisData.length} file truyện</h4>`;

    // Statistics summary
    const totalWords = analysisData.reduce((sum, d) => sum + (d.basicStats?.wordCount || 0), 0);
    const avgWords = Math.round(totalWords / analysisData.length);
    html += `<div style="background:#2c3e50;padding:10px;margin:10px 0;border-radius:8px;">
        <p><strong>📈 Thống kê tổng quan:</strong></p>
        <p>• Tổng số từ: ${totalWords.toLocaleString()} từ</p>
        <p>• Trung bình: ${avgWords.toLocaleString()} từ/file</p>
    </div>`;

    analysisData.forEach((d, index) => {
        if (d.error) {
            html += `<div style="background:#e74c3c;padding:10px;margin:10px 0;border-radius:8px;">
                ❌ <strong>${d.fileName}</strong>: ${d.error}
            </div>`;
        } else {
            const struct = d.storyStructure || {};
            html += `<div style="background:#34495e;padding:15px;margin:10px 0;border-radius:8px;">
                <h5>📄 ${d.fileName}</h5>
                <p style="color:#bdc3c7;font-size:0.9em;">${d.folderPath} • ${d.timestamp}</p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
                    <div><strong>📊 Số từ:</strong> ${(d.basicStats?.wordCount || 0).toLocaleString()}</div>
                    <div><strong>📝 Ngôi kể:</strong> ${struct.ngoike || 'Không xác định'}</div>
                </div>

                <div style="margin:10px 0;">
                    <p><strong>👥 Nhân vật:</strong> ${safeJoin(struct.nhanVat)}</p>
                    <p><strong>⏰ Thời gian:</strong> ${safeJoin(struct.thoiGian)}</p>
                    <p><strong>🌍 Địa điểm:</strong> ${safeJoin(struct.diaDiem)}</p>
                    <p><strong>🎭 Tình huống:</strong> ${safeJoin(struct.tinhHuong)}</p>
                </div>

                <!-- Content Structure -->
                <div style="margin:10px 0;">
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>📖 Mở bài</strong></summary>
                        <div class="story-content">${struct.moBai || 'Không có dữ liệu'}</div>
                    </details>
                    
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>📖 Thân bài</strong></summary>
                        <div class="story-content">${struct.thanBai || 'Không có dữ liệu'}</div>
                    </details>
                    
                    <details>
                        <summary style="cursor:pointer;color:#3498db;"><strong>📖 Kết bài</strong></summary>
                        <div class="story-content">${struct.ketBai || 'Không có dữ liệu'}</div>
                    </details>
                </div>

                <!-- Dialogue -->
                ${struct.hoiThoai && struct.hoiThoai.length > 0 ? `
                <details>
                    <summary style="cursor:pointer;color:#2ecc71;"><strong>💬 Hội thoại (${struct.hoiThoai.length})</strong></summary>
                    <div class="story-content">
                        ${struct.hoiThoai.map(dialogue => `<p>• ${dialogue}</p>`).join('')}
                    </div>
                </details>` : ''}

                <!-- Emotional Analysis -->
                <div style="margin:10px 0;">
                    <p><strong>😊 Cảm xúc tích cực:</strong> ${safeJoin(safeArray(struct.emotion?.positive))}</p>
                    <p><strong>😢 Cảm xúc tiêu cực:</strong> ${safeJoin(safeArray(struct.emotion?.negative))}</p>
                    <p><strong>😐 Cảm xúc trung tính:</strong> ${safeJoin(safeArray(struct.emotion?.neutral))}</p>
                </div>

                <!-- Content Categories -->
                <div style="margin:10px 0;">
                    <p><strong>💝 Ngôn ngữ tình cảm:</strong> ${safeJoin(struct.romantic)}</p>
                    <p><strong>👨‍👩‍👧‍👦 Gia đình:</strong> ${safeJoin(struct.family)}</p>
                    <p><strong>🤫 Bí mật:</strong> ${safeJoin(struct.secret)}</p>
                    <p><strong>⚠️ Tiêu cực:</strong> ${safeJoin(struct.negative)}</p>
                    ${struct.sexual && struct.sexual.length > 0 ? `
                        <p><strong>🔞 Nội dung nhạy cảm:</strong> <span style="color:#e74c3c;">${struct.sexual.length} từ khóa phát hiện</span></p>
                    ` : ''}
                </div>

                <!-- Content Sample -->
                <details>
                    <summary style="cursor:pointer;color:#95a5a6;"><strong>📝 Mẫu nội dung</strong></summary>
                    <div class="story-content" style="font-style:italic;">${d.contentSample || 'Không có dữ liệu'}</div>
                </details>
            </div>`;
        }
    });

    container.innerHTML = html;
}
// ===== UI NAVIGATION =====
function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
    
    // Auto-select first template when entering generator tab
    if (id === 'tab-generator' && !selectedTemplate) {
        document.querySelector('.template-card[data-template="romance"]').click();
    }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Try to load cached analysis on page load
    displayEmptyState();
});
    // ----------------- HÀM PHÂN TÍCH (giữ hoặc thay mới) -----------------
function analyzeStoryStructure(content) {
  const lower = (content || '').toLowerCase();

  // đảm bảo fallback nếu vocabulary không tồn tại (an toàn khi dùng)
  const sWords = typeof sensitiveWords !== 'undefined' ? sensitiveWords : { romantic: [], sexual: [], negative: [], family: [], secret: [] };
  const eWords = typeof emotionalWords !== 'undefined' ? emotionalWords : { positive: [], negative: [], neutral: [] };
  const dIndicators = typeof dialogueIndicators !== 'undefined' ? dialogueIndicators : [];
  const dPunct = typeof dialoguePunctuation !== 'undefined' ? dialoguePunctuation : [];

  // Mở - thân - kết
  let moBai = content.substring(0, 300);
  let ketBai = content.substring(Math.max(0, content.length - 300));
  let thanBai = content.substring(300, Math.max(300, content.length - 300));

  // Ngôi kể
  let ngoike = "Ngôi thứ ba";
  if (/\btôi\b|\bchúng tôi\b/.test(lower)) ngoike = "Ngôi thứ nhất";
  if (/\bbạn\b|\bcậu\b|\bmày\b/.test(lower)) ngoike = "Ngôi thứ hai";

  // Nhân vật - tên viết hoa (lấy tối đa 10)
  let characterMatches = content.match(/\b[A-ZÀÁẢÃẠÂĂĐÊÔƠƯ][a-zàáảãạâăđêôơư]+\b/g) || [];
  let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

  // Hội thoại (dòng có dấu ngoặc hoặc chứa từ chỉ thoại)
  let dialogues = [];
  content.split("\n").forEach(line => {
    if (/".*"/.test(line) || dIndicators.some(k => line.toLowerCase().includes(k))) {
      dialogues.push(line.trim());
    }
  });
  dialogues = dialogues.slice(0, 10);

  // Thời gian / địa điểm / tình huống
  const timeKeywords = ["sáng","trưa","chiều","tối","đêm","hôm qua","ngày mai","năm","tháng"];
  let times = timeKeywords.filter(t => lower.includes(t));
  const placeKeywords = ["nhà","làng","thành phố","rừng","biển","núi","trường","chợ","sông"];
  let places = placeKeywords.filter(p => lower.includes(p));
  const eventKeywords = ["gặp gỡ","chia ly","thử thách","xung đột","chiến đấu","giải cứu","bí mật"];
  let events = eventKeywords.filter(e => lower.includes(e));

  // Từ ngữ nhạy cảm / cảm xúc (dùng danh sách đã khai báo)
  function findMatches(list){
    if(!Array.isArray(list) || list.length===0) return [];
    return list.filter(w => lower.includes(w)).slice(0, 20);
  }
  let romantic = findMatches(sWords.romantic);
  let sexual = findMatches(sWords.sexual);
  let negative = findMatches(sWords.negative);
  let family = findMatches(sWords.family);
  let secret = findMatches(sWords.secret);

  let emotionPos = findMatches(eWords.positive);
  let emotionNeg = findMatches(eWords.negative);
  let emotionNeu = findMatches(eWords.neutral);

  // Hội thoại nâng cao: dòng có indicator hoặc dấu câu thoại
  let dialogueLines = content.split(/\n+/).filter(line => {
    const l = line.toLowerCase();
    return dIndicators.some(ind => l.includes(ind)) || dPunct.some(p => line.includes(p));
  }).slice(0, 10);

  return {
    moBai, thanBai, ketBai,
    ngoike,
    nhanVat: uniqueChars,
    hoiThoai: dialogues,
    dialogueLines,
    thoiGian: times,
    diaDiem: places,
    tinhHuong: events,
    tuNgu18: sexual,
    romantic, sexual, negative, family, secret,
    emotion: { positive: emotionPos, negative: emotionNeg, neutral: emotionNeu }
  };
}
   // ===== STORY GENERATION VARIABLES =====
let selectedTemplate = null;
let generatedStoryContent = '';
let currentGenerationParams = {};

// ===== STORY TEMPLATES =====
const storyTemplates = {
    romance: {
        name: "Lãng Mạn",
        themes: ["tình yêu", "gặp gỡ", "chia ly", "hạnh phúc", "ngọt ngào"],
        structure: "Gặp gỡ → Tình cảm nảy sinh → Thử thách → Hạnh phúc",
        emotion: "positive",
        keywords: ["yêu", "thương", "ngọt ngào", "âm ấp", "hạnh phúc"]
    },
    family: {
        name: "Gia Đình", 
        themes: ["gia đình", "tình thân", "hy sinh", "yêu thương", "đoàn tụ"],
        structure: "Gia đình → Thử thách → Hiểu nhau → Đoàn tụ",
        emotion: "mixed",
        keywords: ["bố", "mẹ", "con", "gia đình", "yêu thương"]
    },
    adventure: {
        name: "Phiêu Lưu",
        themes: ["cuộc phiêu lưu", "khám phá", "thử thách", "bạn bè", "chiến thắng"],
        structure: "Xuất phát → Thử thách → Vượt qua → Thành công",
        emotion: "exciting",
        keywords: ["phiêu lưu", "khám phá", "thử thách", "dũng cảm", "chiến thắng"]
    },
    drama: {
        name: "Chính Kịch",
        themes: ["xung đột", "phức tạp", "cảm xúc", "quyết định", "thay đổi"],
        structure: "Bình thường → Xung đột → Leo thang → Giải quyết",
        emotion: "intense", 
        keywords: ["khó khăn", "quyết định", "thay đổi", "cảm xúc", "vượt qua"]
    }
};

// ===== UI EVENT HANDLERS =====
document.addEventListener('DOMContentLoaded', function() {
    setupTemplateSelector();
});

function setupTemplateSelector() {
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            // Add selection to clicked card
            this.classList.add('selected');
            selectedTemplate = this.dataset.template;
        });
    });
}

// ===== STORY GENERATION CORE =====
async function generateStory() {
    if (!selectedTemplate) {
        alert('⚠️ Vui lòng chọn template truyện trước!');
        return;
    }

    if (!analysisData || analysisData.length === 0) {
        alert('⚠️ Cần có dữ liệu phân tích trước khi tạo truyện!');
        return;
    }

    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '⏳ Đang tạo truyện...';

    try {
        // Get generation parameters
        const params = getGenerationParameters();
        currentGenerationParams = params;
        
        // Analyze existing stories for patterns
        const analysisInsights = extractAnalysisInsights();
        
        // Generate story using AI-like algorithm
        const story = await createStoryFromAnalysis(params, analysisInsights);
        
        // Display results
        displayGeneratedStory(story);
        showGenerationStats(params, analysisInsights);
        
        generatedStoryContent = story;
        enableActionButtons();

    } catch (error) {
        console.error('Story generation error:', error);
        alert('❌ Có lỗi khi tạo truyện: ' + error.message);
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '🚀 Tạo Truyện Thông Minh';
    }
}

function getGenerationParameters() {
    return {
        template: selectedTemplate,
        length: document.getElementById('storyLength').value,
        perspective: document.getElementById('narrativePerspective').value,
        similarity: parseInt(document.getElementById('similarityLevel').value),
        style: document.getElementById('writingStyle').value,
        customPrompt: document.getElementById('customPrompt').value.trim()
    };
}

function extractAnalysisInsights() {
    const insights = {
        commonCharacters: [],
        commonPlaces: [],
        commonEmotions: [],
        commonThemes: [],
        writingStyle: 'descriptive',
        averageLength: 0
    };

    // Analyze all stories for patterns
    const allChars = [];
    const allPlaces = [];
    const allEmotions = [];
    let totalWords = 0;

    analysisData.forEach(story => {
        if (story.storyStructure) {
            // Characters
            if (story.storyStructure.nhanVat) {
                allChars.push(...story.storyStructure.nhanVat);
            }
            // Places  
            if (story.storyStructure.diaDiem) {
                allPlaces.push(...story.storyStructure.diaDiem);
            }
            // Emotions
            if (story.storyStructure.emotion) {
                allEmotions.push(...(story.storyStructure.emotion.positive || []));
                allEmotions.push(...(story.storyStructure.emotion.negative || []));
            }
        }
        
        if (story.basicStats) {
            totalWords += story.basicStats.wordCount || 0;
        }
    });

    // Find most common elements
    insights.commonCharacters = getMostCommon(allChars, 5);
    insights.commonPlaces = getMostCommon(allPlaces, 5);
    insights.commonEmotions = getMostCommon(allEmotions, 10);
    insights.averageLength = Math.round(totalWords / analysisData.length);

    return insights;
}

function getMostCommon(arr, limit) {
    const frequency = {};
    arr.forEach(item => {
        frequency[item] = (frequency[item] || 0) + 1;
    });
    
    return Object.entries(frequency)
        .sort(([,a], [,b]) => b - a)
        .slice(0, limit)
        .map(([item]) => item);
}

// ===== AI-LIKE STORY GENERATION =====
async function createStoryFromAnalysis(params, insights) {
    const template = storyTemplates[params.template];
    
    // Determine story structure
    const structure = generateStoryStructure(params, template, insights);
    
    // Generate content for each part
    const story = {
        title: generateTitle(template, insights),
        opening: generateOpening(structure, params, insights),
        development: generateDevelopment(structure, params, insights),
        climax: generateClimax(structure, params, insights),
        conclusion: generateConclusion(structure, params, insights)
    };

    // Combine all parts
    return formatFullStory(story);
}

function generateStoryStructure(params, template, insights) {
    // Create characters based on analysis
    const characters = generateCharacters(insights, template);
    
    // Create setting based on common places
    const setting = generateSetting(insights, template);
    
    // Create plot points
    const plotPoints = generatePlotPoints(template, params);

    return {
        characters,
        setting, 
        plotPoints,
        perspective: params.perspective === 'auto' ? 'third' : params.perspective,
        length: params.length
    };
}

function generateCharacters(insights, template) {
    const characters = [];
    
    // Main character
    const mainCharName = insights.commonCharacters[0] || generateVietnameseName();
    characters.push({
        name: mainCharName,
        role: 'main',
        traits: generateCharacterTraits(template)
    });

    // Supporting character
    const supportCharName = insights.commonCharacters[1] || generateVietnameseName();
    characters.push({
        name: supportCharName,
        role: 'support',
        traits: generateCharacterTraits(template, true)
    });

    return characters;
}

function generateVietnameseName() {
    const firstNames = ['Minh', 'Hương', 'Nam', 'Lan', 'Hoàng', 'Linh', 'Tuấn', 'Mai', 'Đức', 'Hoa'];
    const lastNames = ['Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Phan', 'Vũ', 'Đặng', 'Bùi', 'Đỗ'];
    
    return lastNames[Math.floor(Math.random() * lastNames.length)] + ' ' + 
           firstNames[Math.floor(Math.random() * firstNames.length)];
}

function generateCharacterTraits(template, isSupporting = false) {
    const traitsByTemplate = {
        romance: isSupporting ? ['hiểu biết', 'ủng hộ'] : ['dễ thương', 'chân thành', 'ấm áp'],
        family: isSupporting ? ['khôn ngoan', 'yêu thương'] : ['có trách nhiệm', 'quan tâm gia đình'],
        adventure: isSupporting ? ['trung thành', 'dũng cảm'] : ['mạo hiểm', 'quyết tâm', 'thông minh'],
        drama: isSupporting ? ['thấu hiểu', 'kiên nhẫn'] : ['phức tạp', 'sâu sắc', 'có nội tâm']
    };
    
    return traitsByTemplate[template.name.toLowerCase()] || ['tốt bụng', 'thân thiện'];
}

function generateSetting(insights, template) {
    const places = insights.commonPlaces.length > 0 ? insights.commonPlaces : 
                  ['thành phố', 'làng quê', 'trường học', 'nhà', 'công viên'];
    
    return {
        primary: places[0],
        secondary: places[1] || places[0],
        timeframe: 'hiện tại'
    };
}

function generatePlotPoints(template, params) {
    const baseStructure = template.structure.split(' → ');
    return baseStructure.map(point => ({
        description: point,
        keywords: template.keywords
    }));
}

// ===== STORY CONTENT GENERATION =====
function generateTitle(template, insights) {
    const titleTemplates = {
        romance: ['Tình Yêu ${char}', 'Ngày Em Đến', 'Nỗi Nhớ', 'Hạnh Phúc Nhỏ'],
        family: ['Gia Đình Nhỏ', 'Tình Thân', 'Về Nhà', 'Ấm Áp Bên Nhau'], 
        adventure: ['Cuộc Phiêu Lưu', 'Hành Trình', 'Khám Phá', 'Chặng Đường'],
        drama: ['Những Ngày Đó', 'Cuộc Đời', 'Thời Gian', 'Kí Ức']
    };
    
    const templates = titleTemplates[selectedTemplate] || titleTemplates.drama;
    return templates[Math.floor(Math.random() * templates.length)];
}

function generateOpening(structure, params, insights) {
    const char = structure.characters[0];
    const setting = structure.setting;
    
    const openings = [
        `${char.name} ngồi bên cửa sổ, nhìn ra ${setting.primary} với tâm trạng trầm lặng. `,
        `Buổi sáng ở ${setting.primary}, ${char.name} thức dậy với cảm giác có điều gì đó sắp thay đổi. `,
        `Khi những tia nắng đầu tiên chiếu xuống ${setting.primary}, ${char.name} đã sẵn sàng cho một ngày mới. `
    ];
    
    return openings[Math.floor(Math.random() * openings.length)];
}

function generateDevelopment(structure, params, insights) {
    const template = storyTemplates[params.template];
    const char1 = structure.characters[0];
    const char2 = structure.characters[1];
    
    return `Cuộc gặp gỡ giữa ${char1.name} và ${char2.name} không hề tình cờ. ` +
           `Trong những ngày qua, ${char1.name} luôn cảm thấy có điều gì đó thiếu vắng trong cuộc sống. ` +
           `${char2.name} xuất hiện như một làn gió mới, mang đến những cảm xúc mà ${char1.name} chưa từng trải qua. `;
}

function generateClimax(structure, params, insights) {
    const template = storyTemplates[params.template];
    const char1 = structure.characters[0];
    
    const climaxByTemplate = {
        romance: `Khoảnh khắc quyết định đã đến. ${char1.name} nhận ra rằng tình yêu không chỉ là cảm xúc mà còn là sự lựa chọn. `,
        family: `${char1.name} hiểu ra rằng gia đình là điều quý giá nhất, những hiểu lầm trước đây chỉ làm cách xa nhau. `,
        adventure: `Thử thách lớn nhất xuất hiện. ${char1.name} phải đưa ra quyết định quan trọng để vượt qua khó khăn. `,
        drama: `Tất cả mọi thứ đến hồi căng thẳng. ${char1.name} đứng trước ngã rẽ quan trọng nhất của cuộc đời. `
    };
    
    return climaxByTemplate[params.template] || climaxByTemplate.drama;
}

function generateConclusion(structure, params, insights) {
    const char1 = structure.characters[0];
    const setting = structure.setting;
    
    return `Và rồi, khi mọi thứ lắng xuống, ${char1.name} nhìn lại chặng đường đã qua với nụ cười thanh thản. ` +
           `${setting.primary} vẫn như xưa, nhưng ${char1.name} đã khác. Cuộc sống tiếp tục, nhưng giờ đây đã có thêm ý nghĩa. ` +
           `Có lẽ đây chính là điều mà ${char1.name} đã tìm kiếm từ lâu - không phải là điều gì hoành tráng, mà chỉ là sự bình yên trong tâm hồn.`;
}

function formatFullStory(story) {
    return `${story.title}\n\n${story.opening}\n\n${story.development}\n\n${story.climax}\n\n${story.conclusion}`;
}

// ===== DISPLAY AND UI FUNCTIONS =====
function displayGeneratedStory(story) {
    const container = document.getElementById('generatedStory');
    const formattedStory = story.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
    container.innerHTML = `<p>${formattedStory}</p>`;
}

function showGenerationStats(params, insights) {
    const statsDiv = document.getElementById('generationStats');
    const statsContent = document.getElementById('statsContent');
    
    const wordCount = generatedStoryContent.split(/\s+/).length;
    
    statsContent.innerHTML = `
        <p>• Template: <strong>${storyTemplates[params.template].name}</strong></p>
        <p>• Số từ: <strong>${wordCount}</strong></p>
        <p>• Ngôi kể: <strong>${params.perspective === 'first' ? 'Ngôi thứ nhất' : 'Ngôi thứ ba'}</strong></p>
        <p>• Dựa trên: <strong>${analysisData.length} truyện đã phân tích</strong></p>
        <p>• Nhân vật phổ biến: <strong>${insights.commonCharacters.slice(0, 3).join(', ')}</strong></p>
    `;
    
    statsDiv.style.display = 'block';
}

function enableActionButtons() {
    document.getElementById('copyBtn').disabled = false;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('regenBtn').disabled = false;
}

// ===== ACTION FUNCTIONS =====
function copyStory() {
    if (!generatedStoryContent) return;
    
    navigator.clipboard.writeText(generatedStoryContent).then(() => {
        alert('📋 Đã sao chép truyện vào clipboard!');
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('❌ Không thể sao chép. Vui lòng thử lại!');
    });
}

function saveStoryToDrive() {
    if (!generatedStoryContent) return;
    
    const fileName = `Generated_Story_${new Date().toISOString().slice(0, 10)}.txt`;
    const fileContent = generatedStoryContent;
    
    const metadata = {
        name: fileName,
        mimeType: "text/plain"
    };

    const accessToken = gapi.client.getToken().access_token;
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", new Blob([fileContent], { type: "text/plain" }));

    fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
    }).then(res => res.json()).then(val => {
        alert(`💾 Đã lưu truyện lên Google Drive: ${fileName}`);
    }).catch(err => {
        console.error("Save error:", err);
        alert("❌ Lỗi khi lưu truyện: " + err.message);
    });
}

function regenerateStory() {
    if (confirm('🔄 Bạn có muốn tạo lại truyện với các tham số hiện tại?')) {
        generateStory();
    }
}
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
