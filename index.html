<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Story Analyzer</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0 30px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            margin: -20px -16px 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            text-align: center;
            padding: 40px 20px;
        }

        .login-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        .login-subtitle {
            font-size: 16px;
            color: #8e8e93;
            margin-bottom: 40px;
            line-height: 1.4;
        }

        /* Buttons */
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 50px;
        }

        .btn:hover {
            background: #0056d3;
        }

        .btn:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #8e8e93;
        }

        .btn-success {
            background: #34c759;
        }

        .btn-danger {
            background: #ff3b30;
        }

        /* Main Content */
        .main-content {
            display: none;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        /* Status */
        .status {
            padding: 12px 16px;
            border-radius: 12px;
            margin: 12px 0;
            font-weight: 500;
            font-size: 14px;
        }

        .status.success {
            background: #d1f2eb;
            color: #0c7c59;
        }

        .status.error {
            background: #fadbd8;
            color: #c0392b;
        }

        .status.info {
            background: #d6eaf8;
            color: #2874a6;
        }

        .status.warning {
            background: #fcf3cf;
            color: #b7950b;
        }

        /* File List */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
        }

        .file-folder {
            margin-bottom: 16px;
        }

        .folder-header {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .file-item {
            padding: 8px 12px;
            margin-left: 16px;
            margin-bottom: 4px;
            font-size: 13px;
            color: #6c757d;
        }

        /* Progress */
        .progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759, #30d158);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Analysis Results */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #007AFF;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #8e8e93;
            margin-top: 4px;
        }

        /* Story Generation */
        .story-output {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            font-size: 15px;
            line-height: 1.6;
        }

        .chapter {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5ea;
        }

        .chapter:last-child {
            border-bottom: none;
        }

        .chapter-title {
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e5ea;
            padding: 8px 0 24px;
            z-index: 100;
            display: none;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100vw;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 0;
        }

        .nav-item.active {
            color: #007AFF;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .container {
                padding: 16px 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ AI Story Analyzer</h1>
            <p>Ph√¢n t√≠ch v√† t·∫°o truy·ªán b·∫±ng AI</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-icon">üì±</div>
            <h2 class="login-title">Ch√†o m·ª´ng!</h2>
            <p class="login-subtitle">ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch v√† t·∫°o truy·ªán v·ªõi AI</p>
            <button id="loginBtn" class="btn">
                <span>üîê ƒêƒÉng nh·∫≠p Google Drive</span>
            </button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content">
            <!-- Status -->
            <div id="status" class="status hidden"></div>

            <!-- Files Tab -->
            <div id="tabFiles" class="tab-content active">
                <div class="section">
                    <h2>üìÅ File Truy·ªán</h2>
                    <div id="fileList" class="file-list">
                        <p style="text-align: center; color: #8e8e93; padding: 20px;">
                            Nh·∫•n "T·∫£i Files" ƒë·ªÉ xem danh s√°ch truy·ªán
                        </p>
                    </div>
                    <button id="loadFilesBtn" class="btn">üì• T·∫£i Files</button>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="tabAnalysis" class="tab-content">
                <div class="section">
                    <h2>üîç Ph√¢n T√≠ch</h2>
                    <button id="analyzeBtn" class="btn btn-success">üß† Ph√¢n T√≠ch AI</button>
                    
                    <div id="progressSection" class="hidden">
                        <div class="progress">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <p id="progressText" style="font-size: 14px; color: #8e8e93; text-align: center;"></p>
                    </div>

                    <div id="analysisResults" class="hidden">
                        <h3 style="margin: 20px 0 12px;">üìä K·∫øt Qu·∫£</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span id="totalStories" class="stat-number">0</span>
                                <div class="stat-label">Truy·ªán</div>
                            </div>
                            <div class="stat-card">
                                <span id="totalWords" class="stat-number">0</span>
                                <div class="stat-label">T·ª´</div>
                            </div>
                            <div class="stat-card">
                                <span id="totalFolders" class="stat-number">0</span>
                                <div class="stat-label">Th∆∞ m·ª•c</div>
                            </div>
                            <div class="stat-card">
                                <span id="vocabularySize" class="stat-number">0</span>
                                <div class="stat-label">T·ª´ v·ª±ng</div>
                            </div>
                        </div>
                        
                        <button id="trainBtn" class="btn btn-success" disabled>üéì Hu·∫•n Luy·ªán AI</button>
                    </div>
                </div>
            </div>

            <!-- Generation Tab -->
            <div id="tabGenerate" class="tab-content">
                <div class="section">
                    <h2>‚úçÔ∏è T·∫°o Truy·ªán</h2>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ch∆∞∆°ng t·ªëi thi·ªÉu:</label>
                        <input type="number" id="chapterCount" value="50" min="10" max="200" 
                               style="width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 16px;">
                    </div>

                    <button id="generateBtn" class="btn btn-success" disabled>üöÄ T·∫°o Truy·ªán</button>
                    
                    <div id="generationProgress" class="hidden">
                        <div class="progress">
                            <div id="generationProgressFill" class="progress-fill"></div>
                        </div>
                        <p id="generationProgressText" style="font-size: 14px; color: #8e8e93; text-align: center;"></p>
                    </div>

                    <div id="storyOutput" class="story-output hidden">
                        <h3 style="margin-bottom: 16px;">üìñ Truy·ªán M·ªõi</h3>
                        <div id="storyContent"></div>
                        <button id="uploadBtn" class="btn btn-success hidden">‚òÅÔ∏è T·∫£i l√™n Drive</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tabSettings" class="tab-content">
                <div class="section">
                    <h2>‚öôÔ∏è C√†i ƒê·∫∑t</h2>
                    <div style="margin-bottom: 16px;">
                        <p><strong>Tr·∫°ng th√°i:</strong> <span id="connectionStatus">ƒê√£ k·∫øt n·ªëi</span></p>
                        <p><strong>M√¥ h√¨nh AI:</strong> <span id="modelStatus">Ch∆∞a s·∫µn s√†ng</span></p>
                    </div>
                    <button id="logoutBtn" class="btn btn-danger">üö™ ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottomNav" class="bottom-nav">
        <div class="nav-items">
            <div class="nav-item active" data-tab="Files">
                <div class="nav-icon">üìÅ</div>
                <div class="nav-label">Files</div>
            </div>
            <div class="nav-item" data-tab="Analysis">
                <div class="nav-icon">üîç</div>
                <div class="nav-label">Ph√¢n t√≠ch</div>
            </div>
            <div class="nav-item" data-tab="Generate">
                <div class="nav-icon">‚úçÔ∏è</div>
                <div class="nav-label">T·∫°o truy·ªán</div>
            </div>
            <div class="nav-item" data-tab="Settings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">C√†i ƒë·∫∑t</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        // Global variables
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let storyFiles = [];
        let analyzedFiles = new Set(); // Track analyzed files
        let storyData = [];
        let aiModel = null;
        let vocabulary = {};
        let currentStory = null;

        // Utility functions
        function log(message, data = '') {
            console.log(`[AI Story] ${message}`, data);
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, type === 'error' ? 8000 : 5000);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        // Tab navigation
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabName = item.getAttribute('data-tab');
                    
                    // Update nav
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`tab${tabName}`).classList.add('active');
                });
            });
        }

        // Google API initialization
        function gapiLoaded() {
            log('GAPI loaded');
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                log('GAPI initialized');
                maybeEnableLogin();
            } catch (error) {
                log('GAPI init error:', error);
                showStatus('L·ªói kh·ªüi t·∫°o API', 'error');
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                });
                gisInited = true;
                log('GIS initialized');
                maybeEnableLogin();
            } catch (error) {
                log('GIS init error:', error);
                showStatus('L·ªói kh·ªüi t·∫°o x√°c th·ª±c', 'error');
            }
        }

        function maybeEnableLogin() {
            if (gapiInited && gisInited) {
                document.getElementById('loginBtn').disabled = false;
                log('Login ready');
            }
        }

        // Authentication
        function handleAuthCallback(resp) {
            if (resp.error) {
                showStatus(`L·ªói ƒëƒÉng nh·∫≠p: ${resp.error}`, 'error');
                return;
            }
            
            showStatus('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            showMainContent();
        }

        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'block';
            document.getElementById('connectionStatus').textContent = 'ƒê√£ k·∫øt n·ªëi';
        }

        // File operations
        async function loadFiles() {
            try {
                showStatus('ƒêang t·∫£i danh s√°ch file...', 'info');
                
                // Find QuanLyTruyen folder
                const folderResponse = await gapi.client.drive.files.list({
                    q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                });

                if (folderResponse.result.files.length === 0) {
                    showStatus('Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c "QuanLyTruyen"', 'warning');
                    return;
                }

                const mainFolderId = folderResponse.result.files[0].id;
                
                // Get all subfolders and files
                const allFolders = await getAllSubfolders(mainFolderId);
                allFolders.unshift({ id: mainFolderId, name: 'QuanLyTruyen', path: 'QuanLyTruyen' });

                storyFiles = [];
                for (const folder of allFolders) {
                    const files = await getFilesFromFolder(folder.id, folder.path);
                    storyFiles.push(...files);
                }

                displayFiles();
                showStatus(`T√¨m th·∫•y ${storyFiles.length} file`, 'success');
                
            } catch (error) {
                log('Load files error:', error);
                showStatus('L·ªói t·∫£i file', 'error');
            }
        }

        async function getAllSubfolders(parentId, basePath = '') {
            const response = await gapi.client.drive.files.list({
                q: `'${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id, name)',
            });

            let folders = response.result.files.map(folder => ({
                id: folder.id,
                name: folder.name,
                path: basePath ? `${basePath}/${folder.name}` : folder.name
            }));

            // Recursively get subfolders
            for (const folder of folders) {
                const subfolders = await getAllSubfolders(folder.id, folder.path);
                folders.push(...subfolders);
            }

            return folders;
        }

        async function getFilesFromFolder(folderId, folderPath) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and name contains '.txt' and trashed=false`,
                fields: 'files(id, name, size, modifiedTime)',
            });

            return response.result.files.map(file => ({
                ...file,
                folderPath,
                isAnalyzed: analyzedFiles.has(file.id)
            }));
        }

        function displayFiles() {
            const fileList = document.getElementById('fileList');
            
            if (storyFiles.length === 0) {
                fileList.innerHTML = '<p style="text-align: center; color: #8e8e93; padding: 20px;">Kh√¥ng c√≥ file n√†o</p>';
                return;
            }

            // Group by folder
            const filesByFolder = {};
            storyFiles.forEach(file => {
                if (!filesByFolder[file.folderPath]) {
                    filesByFolder[file.folderPath] = [];
                }
                filesByFolder[file.folderPath].push(file);
            });

            let html = '';
            Object.keys(filesByFolder).sort().forEach(folderPath => {
                const files = filesByFolder[folderPath];
                const analyzedCount = files.filter(f => f.isAnalyzed).length;
                
                html += `
                    <div class="file-folder">
                        <div class="folder-header">
                            üìÅ ${folderPath} 
                            <span style="font-size: 12px; color: #8e8e93;">
                                (${files.length} files, ${analyzedCount} analyzed)
                            </span>
                        </div>
                        ${files.map(file => `
                            <div class="file-item ${file.isAnalyzed ? 'analyzed' : ''}">
                                üìÑ ${file.name} ${file.isAnalyzed ? '‚úÖ' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            fileList.innerHTML = html;
        }

        // AI Analysis
        async function analyzeStories() {
            if (storyFiles.length === 0) {
                showStatus('Ch∆∞a c√≥ file ƒë·ªÉ ph√¢n t√≠ch', 'error');
                return;
            }

            const unanalyzedFiles = storyFiles.filter(file => !analyzedFiles.has(file.id));
            if (unanalyzedFiles.length === 0) {
                showStatus('T·∫•t c·∫£ file ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch', 'info');
                return;
            }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('progressSection').classList.remove('hidden');
            
            try {
                for (let i = 0; i < unanalyzedFiles.length; i++) {
                    const file = unanalyzedFiles[i];
                    const progress = ((i + 1) / unanalyzedFiles.length) * 100;
                    
                    document.getElementById('progressFill').style.width = `${progress}%`;
                    document.getElementById('progressText').textContent = 
                        `ƒêang ph√¢n t√≠ch: ${file.name} (${i + 1}/${unanalyzedFiles.length})`;
                    
                    const content = await downloadFile(file.id);
                    if (content && content.trim()) {
                        const analysis = analyzeText(content);
                        storyData.push({
                            fileId: file.id,
                            name: file.name,
                            folderPath: file.folderPath,
                            content: content,
                            analysis: analysis
                        });
                        analyzedFiles.add(file.id);
                    }
                }

                await buildVocabulary();
                showAnalysisResults();
                
                // Update file display
                storyFiles.forEach(file => {
                    file.isAnalyzed = analyzedFiles.has(file.id);
                });
                displayFiles();
                
                showStatus('Ph√¢n t√≠ch ho√†n th√†nh!', 'success');
                
            } catch (error) {
                log('Analysis error:', error);
                showStatus('L·ªói ph√¢n t√≠ch', 'error');
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('progressSection').classList.add('hidden');
            }
        }

        async function downloadFile(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                log(`Download error for ${fileId}:`, error);
                return '';
            }
        }

        function analyzeText(text) {
            const words = text.toLowerCase().match(/\b\w+\b/g) || [];
            const sentences = text.split(/[.!?]+/).filter(s => s.trim());
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim());
            
            return {
                wordCount: words.length,
                sentenceCount: sentences.length,
                paragraphCount: paragraphs.length,
                uniqueWords: new Set(words).size,
                avgWordsPerSentence: words.length / sentences.length || 0
            };
        }

        function buildVocabulary() {
            vocabulary = {};
            let index = 1;
            
            storyData.forEach(story => {
                const words = story.content.toLowerCase().match(/\b\w+\b/g) || [];
                words.forEach(word => {
                    if (!vocabulary[word]) {
                        vocabulary[word] = index++;
                    }
                });
            });
            
            log(`Built vocabulary: ${Object.keys(vocabulary).length} words`);
        }

        function showAnalysisResults() {
            const totalWords = storyData.reduce((sum, story) => sum + story.analysis.wordCount, 0);
            const totalFolders = new Set(storyData.map(story => story.folderPath)).size;
            
            document.getElementById('totalStories').textContent = formatNumber(storyData.length);
            document.getElementById('totalWords').textContent = formatNumber(totalWords);
            document.getElementById('totalFolders').textContent = formatNumber(totalFolders);
            document.getElementById('vocabularySize').textContent = formatNumber(Object.keys(vocabulary).length);
            
            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('trainBtn').disabled = false;
            document.getElementById('modelStatus').textContent = 'S·∫µn s√†ng hu·∫•n luy·ªán';
        }

        // AI Training and Generation
        async function trainAI() {
            if (storyData.length === 0) {
                showStatus('C·∫ßn ph√¢n t√≠ch truy·ªán tr∆∞·ªõc', 'error');
                return;
            }

            document.getElementById('trainBtn').disabled = true;
            showStatus('ƒêang hu·∫•n luy·ªán AI...', 'info');
            
            try {
                // Build simple model structure
                const vocabSize = Object.keys(vocabulary).length + 1;
                
                // Create training sequences
                const sequences = [];
                storyData.forEach(story => {
                    const words = story.content.toLowerCase().match(/\b\w+\b/g) || [];
                    const tokens = words.map(word => vocabulary[word] || 0);
                    
                    // Create sequences of length 10
                    for (let i = 0; i < tokens.length - 10; i++) {
                        sequences.push({
                            input: tokens.slice(i, i + 10),
                            output: tokens[i + 10]
                        });
                    }
                });

                // Simple training simulation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showStatus('Hu·∫•n luy·ªán ho√†n th√†nh!', 'success');
                document.getElementById('modelStatus').textContent = 'ƒê√£ hu·∫•n luy·ªán';
                document.getElementById('generateBtn').disabled = false;
                
            } catch (error) {
                log('Training error:', error);
                showStatus('L·ªói hu·∫•n luy·ªán', 'error');
            } finally {
                document.getElementById('trainBtn').disabled = false;
            }
        }

        // Enhanced story generation
        async function generateStory() {
            const chapterCount = parseInt(document.getElementById('chapterCount').value) || 50;
            
            if (Object.keys(vocabulary).length === 0) {
                showStatus('C·∫ßn hu·∫•n luy·ªán AI tr∆∞·ªõc', 'error');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generationProgress').classList.remove('hidden');
            
            try {
                // Generate story title
                const storyTitle = generateStoryTitle();
                
                const chapters = [];
                
                for (let i = 1; i <= chapterCount; i++) {
                    const progress = (i / chapterCount) * 100;
                    document.getElementById('generationProgressFill').style.width = `${progress}%`;
                    document.getElementById('generationProgressText').textContent = 
                        `ƒêang vi·∫øt ch∆∞∆°ng ${i}/${chapterCount}`;
                    
                    const chapterTitle = `Ch∆∞∆°ng ${i}: ${generateChapterTitle(i)}`;
                    const chapterContent = await generateChapterContent(i, chapterCount);
                    
                    chapters.push({
                        title: chapterTitle,
                        content: chapterContent
                    });
                    
                    // Small delay for UI
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                currentStory = {
                    title: storyTitle,
                    chapters: chapters,
                    createdAt: new Date()
                };

                displayGeneratedStory();
                showStatus(`Ho√†n th√†nh truy·ªán "${storyTitle}" v·ªõi ${chapterCount} ch∆∞∆°ng!`, 'success');
                
            } catch (error) {
                log('Generation error:', error);
                showStatus('L·ªói t·∫°o truy·ªán', 'error');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generationProgress').classList.add('hidden');
            }
        }

        function generateStoryTitle() {
            const titleTemplates = [
                'H√†nh Tr√¨nh C·ªßa {hero}',
                'B√≠ M·∫≠t {location}',
                'Cu·ªôc Phi√™u L∆∞u T·∫°i {location}',
                'Truy·ªÅn Thuy·∫øt {hero}',
                'V∆∞∆°ng Qu·ªëc {location}',
                'S·ª© M·ªánh {hero}',
                'Ma Thu·∫≠t V√† {element}',
                'Chi·∫øn Binh {element}',
                'C√¥ng Ch√∫a V√† {creature}',
                'Th·∫ø Gi·ªõi {magical}'
            ];

            const heroes = ['Long Th·∫ßn', 'Ph∆∞·ª£ng Ho√†ng', 'Ki·∫øm Sƒ©', 'Ph√°p S∆∞', 'Th·∫ßn T∆∞·ªõng'];
            const locations = ['R·ª´ng Thi√™ng', 'N√∫i Linh', 'Th√†nh C·ªï', 'Bi·ªÉn C·∫£', 'Hang ƒê·ªông'];
            const elements = ['L·ª≠a', 'N∆∞·ªõc', 'Gi√≥', 'ƒê·∫•t', 'S√©t'];
            const creatures = ['R·ªìng', 'Ph∆∞·ª£ng', 'K·ª≥ L√¢n', 'H·ªï Tr·∫Øng', 'S∆∞ T·ª≠'];
            const magical = ['Huy·ªÅn B√≠', 'Ph√©p Thu·∫≠t', 'K·ª≥ Di·ªáu', 'Th·∫ßn Ti√™n', 'Ma Ph√°p'];

            const template = titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
            
            return template
                .replace('{hero}', heroes[Math.floor(Math.random() * heroes.length)])
                .replace('{location}', locations[Math.floor(Math.random() * locations.length)])
                .replace('{element}', elements[Math.floor(Math.random() * elements.length)])
                .replace('{creature}', creatures[Math.floor(Math.random() * creatures.length)])
                .replace('{magical}', magical[Math.floor(Math.random() * magical.length)]);
        }

        function generateChapterTitle(chapterNumber) {
            const titleTypes = [
                'Kh·ªüi ƒê·∫ßu Cu·ªôc H√†nh Tr√¨nh',
                'Cu·ªôc G·∫∑p G·ª° ƒê·ªãnh M·ªánh',
                'Th·ª≠ Th√°ch ƒê·∫ßu Ti√™n',
                'Ng∆∞·ªùi B·∫°n M·ªõi',
                'B√≠ M·∫≠t ƒê∆∞·ª£c Kh√°m Ph√°',
                'Tr·∫≠n Chi·∫øn Kh·ªëc Li·ªát',
                'S·ª± Ph·∫£n B·ªôi',
                'T√¨m Ki·∫øm S·ª©c M·∫°nh',
                'ƒê·ªëi M·∫∑t V·ªõi Qu√° Kh·ª©',
                'Cu·ªëi H√†nh Tr√¨nh'
            ];

            if (chapterNumber === 1) return 'Kh·ªüi ƒê·∫ßu Cu·ªôc H√†nh Tr√¨nh';
            if (chapterNumber <= 5) return titleTypes[Math.floor(Math.random() * 5) + 1];
            if (chapterNumber >= parseInt(document.getElementById('chapterCount').value) - 2) {
                return titleTypes[titleTypes.length - 1];
            }
            
            return titleTypes[Math.floor(Math.random() * titleTypes.length)];
        }

        async function generateChapterContent(chapterNumber, totalChapters) {
            // Get sample content from analyzed stories
            const sampleTexts = storyData.map(story => {
                const sentences = story.content.split(/[.!?]+/).filter(s => s.trim());
                return sentences.slice(0, 10).join('. ') + '.';
            });

            const randomSample = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            
            // Generate content based on chapter position
            let content = '';
            
            if (chapterNumber === 1) {
                content = generateIntroContent();
            } else if (chapterNumber === totalChapters) {
                content = generateEndingContent();
            } else {
                content = generateMiddleContent(chapterNumber);
            }

            // Add some variation with sample text
            const words = randomSample.split(' ');
            const selectedWords = words.slice(0, 20).join(' ');
            
            return `${content}\n\n${selectedWords}...`;
        }

        function generateIntroContent() {
            const intros = [
                'Trong m·ªôt ng√¥i l√†ng nh·ªè b√© n·∫±m gi·ªØa r·ª´ng gi√†, c√≥ m·ªôt c·∫≠u b√© t√™n l√†...',
                'Bu·ªïi s√°ng h√¥m ·∫•y, √°nh nang ƒë·∫ßu ti√™n chi·∫øu xu·ªëng m·∫∑t ƒë·∫•t...',
                'C√¢u chuy·ªán b·∫Øt ƒë·∫ßu t·ª´ m·ªôt gi·∫•c m∆° k·ª≥ l·∫° m√† nh√¢n v·∫≠t ch√≠nh kh√¥ng th·ªÉ qu√™n...',
                'Trong ho√†ng cung tr√°ng l·ªá, m·ªôt b√≠ m·∫≠t l·ªõn ƒëang ch·ªù ƒë∆∞·ª£c kh√°m ph√°...',
                'Ng√†y x∆∞a, c√≥ m·ªôt v∆∞∆°ng qu·ªëc xinh ƒë·∫πp n·∫±m gi·ªØa nh·ªØng d√£y n√∫i cao...'
            ];
            
            return intros[Math.floor(Math.random() * intros.length)];
        }

        function generateMiddleContent(chapterNumber) {
            const middles = [
                'Cu·ªôc phi√™u l∆∞u ti·∫øp t·ª•c khi nh√¢n v·∫≠t ch√≠nh g·∫∑p ph·∫£i th·ª≠ th√°ch m·ªõi...',
                'Trong h√†nh tr√¨nh t√¨m ki·∫øm s·ª± th·∫≠t, nh·ªØng b√≠ ·∫©n d·∫ßn ƒë∆∞·ª£c h√© m·ªü...',
                'M·ªôt ng∆∞·ªùi b·∫°n m·ªõi xu·∫•t hi·ªán v√† thay ƒë·ªïi c·ª•c di·ªán cu·ªôc ch∆°i...',
                'K·∫ª th√π m·∫°nh m·∫Ω ƒë√£ l·ªô di·ªán v√† cu·ªôc chi·∫øn b·∫Øt ƒë·∫ßu...',
                'Nh·ªØng s·ª©c m·∫°nh ti·ªÅm ·∫©n trong nh√¢n v·∫≠t ch√≠nh d·∫ßn th·ª©c t·ªânh...'
            ];
            
            return middles[Math.floor(Math.random() * middles.length)];
        }

        function generateEndingContent() {
            const endings = [
                'Cu·ªëi c√πng, sau bao th·ª≠ th√°ch, nh√¢n v·∫≠t ch√≠nh ƒë√£ ho√†n th√†nh s·ª© m·ªánh...',
                'Trong tr·∫≠n chi·∫øn cu·ªëi c√πng, t·∫•t c·∫£ ƒë∆∞·ª£c quy·∫øt ƒë·ªãnh...',
                'B√≠ m·∫≠t l·ªõn nh·∫•t ƒë√£ ƒë∆∞·ª£c kh√°m ph√° v√† m·ªçi th·ª© thay ƒë·ªïi...',
                'H√†nh tr√¨nh k·∫øt th√∫c, nh∆∞ng m·ªôt ch∆∞∆°ng m·ªõi c·ªßa cu·ªôc ƒë·ªùi b·∫Øt ƒë·∫ßu...',
                'V·ªõi s·ª± hy sinh cao c·∫£, h√≤a b√¨nh ƒë√£ ƒë∆∞·ª£c mang v·ªÅ cho v∆∞∆°ng qu·ªëc...'
            ];
            
            return endings[Math.floor(Math.random() * endings.length)];
        }

        function displayGeneratedStory() {
            const storyOutput = document.getElementById('storyOutput');
            const storyContent = document.getElementById('storyContent');
            
            let html = `
                <div style="text-align: center; margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 12px;">
                    <h3 style="color: #1d4ed8; margin-bottom: 8px;">${currentStory.title}</h3>
                    <p style="color: #64748b; font-size: 14px;">
                        ${currentStory.chapters.length} ch∆∞∆°ng ‚Ä¢ T·∫°o l√∫c ${currentStory.createdAt.toLocaleString('vi-VN')}
                    </p>
                </div>
            `;

            // Show first 3 chapters as preview
            const previewChapters = currentStory.chapters.slice(0, 3);
            
            previewChapters.forEach(chapter => {
                html += `
                    <div class="chapter">
                        <div class="chapter-title">${chapter.title}</div>
                        <div style="color: #64748b; line-height: 1.6;">
                            ${chapter.content}
                        </div>
                    </div>
                `;
            });

            if (currentStory.chapters.length > 3) {
                html += `
                    <div style="text-align: center; padding: 16px; color: #64748b; font-style: italic;">
                        ... v√† ${currentStory.chapters.length - 3} ch∆∞∆°ng kh√°c
                    </div>
                `;
            }

            storyContent.innerHTML = html;
            storyOutput.classList.remove('hidden');
            document.getElementById('uploadBtn').classList.remove('hidden');
        }

        // Upload to Google Drive
        async function uploadStoryToDrive() {
            if (!currentStory) {
                showStatus('Ch∆∞a c√≥ truy·ªán ƒë·ªÉ t·∫£i l√™n', 'error');
                return;
            }

            document.getElementById('uploadBtn').disabled = true;
            showStatus('ƒêang t·∫£i l√™n Google Drive...', 'info');

            try {
                // Create story content
                let storyText = `${currentStory.title}\n\n`;
                storyText += `T√°c gi·∫£: AI Story Generator\n`;
                storyText += `Ng√†y t·∫°o: ${currentStory.createdAt.toLocaleString('vi-VN')}\n`;
                storyText += `S·ªë ch∆∞∆°ng: ${currentStory.chapters.length}\n\n`;
                storyText += '='.repeat(50) + '\n\n';

                currentStory.chapters.forEach(chapter => {
                    storyText += `${chapter.title}\n\n`;
                    storyText += `${chapter.content}\n\n`;
                    storyText += '-'.repeat(30) + '\n\n';
                });

                // Create file metadata
                const fileMetadata = {
                    name: `${currentStory.title}.txt`,
                    parents: await getQuanLyTruyenFolderId()
                };

                // Upload file
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/upload/drive/v3/files',
                    method: 'POST',
                    params: {
                        uploadType: 'multipart'
                    },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="foo_bar_baz"'
                    },
                    body: createMultipartBody(fileMetadata, storyText)
                });

                showStatus(`ƒê√£ t·∫£i l√™n "${currentStory.title}.txt"`, 'success');
                log('File uploaded:', response.result);
                
                // Refresh file list
                await loadFiles();
                
            } catch (error) {
                log('Upload error:', error);
                showStatus('L·ªói t·∫£i l√™n', 'error');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function getQuanLyTruyenFolderId() {
            const response = await gapi.client.drive.files.list({
                q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                fields: 'files(id)',
            });

            if (response.result.files.length > 0) {
                return [response.result.files[0].id];
            }
            
            throw new Error('Th∆∞ m·ª•c QuanLyTruyen kh√¥ng t·ªìn t·∫°i');
        }

        function createMultipartBody(metadata, data) {
            const delimiter = 'foo_bar_baz';
            const close_delim = `\r\n--${delimiter}--`;
            
            let body = `--${delimiter}\r\n`;
            body += 'Content-Type: application/json\r\n\r\n';
            body += JSON.stringify(metadata) + '\r\n';
            body += `--${delimiter}\r\n`;
            body += 'Content-Type: text/plain\r\n\r\n';
            body += data;
            body += close_delim;
            
            return body;
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', () => {
                if (gapiInited && gisInited) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    showStatus('ƒêang kh·ªüi t·∫°o...', 'info');
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                const token = gapi.client.getToken();
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                }
                location.reload();
            });

            document.getElementById('loadFilesBtn').addEventListener('click', loadFiles);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeStories);
            document.getElementById('trainBtn').addEventListener('click', trainAI);
            document.getElementById('generateBtn').addEventListener('click', generateStory);
            document.getElementById('uploadBtn').addEventListener('click', uploadStoryToDrive);
        }

        // Initialize app
        function initApp() {
            log('Initializing app...');
            initNavigation();
            setupEventListeners();
            
            // Load Google APIs
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
            }
        }

        // Start app when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
