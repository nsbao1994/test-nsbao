<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Studio Tiểu Thuyết + Ollama (ngrok)</title>
  <style>
    body { background:#0b1220; color:#e5e7eb; font-family:sans-serif; margin:0; }
    header { background:#121a2b; padding:12px; text-align:center; position:sticky; top:0; }
    h1 { font-size:18px; margin:0; }
    main { padding:16px; display:grid; gap:16px; }
    .card { background:#0f172a; padding:14px; border-radius:12px; }
    textarea,input,button { width:100%; margin-top:8px; padding:8px; border-radius:8px; border:none; }
    textarea,input { background:#0c1324; color:#e5e7eb; }
    button { background:#1d2a4b; color:#fff; cursor:pointer; }
    button:hover { filter:brightness(1.1); }
    pre { white-space:pre-wrap; background:#0c1324; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Studio Tiểu Thuyết + Ollama (ngrok)</h1>
  </header>
  <main>
    <div class="card">
      <h2>Cấu hình</h2>
      <label>Ollama API URL (ngrok)</label>
      <input id="ollamaUrl" type="text" value="https://31e2d306a8e3.ngrok-free.app" />
      <label>Gợi ý truyện</label>
      <textarea id="storyPrompt" placeholder="Ví dụ: Ngôi thứ nhất, tình cảm gia đình, giọng buồn..."></textarea>
      <label>Số chương</label>
      <input id="chapterCount" type="number" value="3" min="1" max="100" />
      <button id="btnGenerate">Viết bằng Ollama</button>
    </div>
    <div class="card">
      <h2>Kết quả</h2>
      <pre id="output"></pre>
    </div>
  </main>

  <script>
    const btn = document.getElementById('btnGenerate');
    btn.onclick = async () => {
      const baseUrl = document.getElementById('ollamaUrl').value.trim();
      const prompt = document.getElementById('storyPrompt').value.trim();
      const n = parseInt(document.getElementById('chapterCount').value,10)||3;
      const output = document.getElementById('output');
      output.textContent = '⏳ Đang gọi Ollama qua ngrok...';

      try {
        const resp = await fetch(baseUrl + '/api/generate', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            model: 'mistral', // bạn có thể đổi sang 'llama3' nếu đã pull model đó
            prompt: `Hãy viết tiểu thuyết dài ${n} chương. ${prompt}\n\nBắt đầu từ chương 1:`
          })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let out = '';

        while(true){
          const {done,value} = await reader.read();
          if(done) break;
          const chunk = decoder.decode(value,{stream:true});
          try {
            // Ollama stream theo line JSON
            for (const line of chunk.split('\n')) {
              if(!line.trim()) continue;
              const obj = JSON.parse(line);
              if(obj.response){
                out += obj.response;
                output.textContent = out;
              }
            }
          } catch(e){
            // Nếu không phải JSON thì nối thẳng text
            out += chunk;
            output.textContent = out;
          }
        }
      } catch (err){
        output.textContent = '❌ Lỗi: ' + err.message;
      }
    };
  </script>
</body>
</html>
