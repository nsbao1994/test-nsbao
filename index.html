<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>TrÃ¬nh PhÃ¢n TÃ­ch & Táº¡o Truyá»‡n NÃ¢ng cao</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    :root {
      --primary-color: #9b59b6;
      --secondary-color: #2980b9;
      --dark-color: #1e1e1e;
      --light-color: #bdc3c7;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --text-color: #ecf0f1;
      --card-bg: rgba(30, 30, 30, 0.95);
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #121212;
      color: var(--text-color);
      font-family: sans-serif;
      min-height: 100vh;
    }

    .container {
      padding: 16px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: #2c3e50;
    }

    .menu-item {
      color: var(--light-color);
      text-decoration: none;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .menu-item.active {
      opacity: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px;
    }

    .btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
    }

    .btn:disabled {
      background: #777;
      cursor: not-allowed;
    }

    .story-content {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      max-height: 50vh;
      overflow-y: auto;
    }

    /* Enhanced Story Generator Styles */
    .story-generator {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .generator-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-group label {
      color: var(--text-color);
      margin-bottom: 5px;
      font-weight: bold;
    }

    .control-group select, 
    .control-group input[type="number"],
    .control-group input[type="range"],
    .control-group textarea {
      background: #2c3e50;
      color: var(--text-color);
      border: 1px solid #34495e;
      border-radius: 8px;
      padding: 8px;
    }

    .story-preview {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #34495e;
      line-height: 1.8;
    }

    .story-stats {
      background: #2c3e50;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .template-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .template-card {
      background: #34495e;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .template-card:hover {
      border-color: var(--primary-color);
      background: #3d566e;
    }

    .template-card.selected {
      border-color: var(--success-color);
      background: #2d4a3e;
    }

    .btn-generate {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: block;
      margin: 0 auto;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-generate:disabled {
      background: #777;
      cursor: not-allowed;
      transform: none;
    }

    .learning-system {
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .learning-progress {
      display: none;
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid var(--success-color);
    }

    .character-info {
      background: #34495e;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .story-title {
      color: #3498db;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .generator-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“– TrÃ¬nh PhÃ¢n TÃ­ch & Táº¡o Truyá»‡n</h1>
      <p>PhÃ¢n tÃ­ch nÃ¢ng cao vÃ  táº¡o truyá»‡n tá»± Ä‘á»™ng vá»›i AI há»c mÃ¡y</p>
    </div>

    <div id="tab-analysis" class="tab-content active">
      <div class="card">
        <h3>ğŸ” PhÃ¢n tÃ­ch nguá»“n truyá»‡n</h3>
        <div class="status-info" id="statusInfo">ğŸ”´ ChÆ°a káº¿t ná»‘i Google Drive</div>
        <div class="detailed-status" id="detailedStatus"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="height:10px;background:#9b59b6;width:0%"></div>
        </div>
        <button class="btn" onclick="handleAuthClick()">ğŸ” Káº¿t ná»‘i Google Drive</button>
        <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>ğŸ“ QuÃ©t thÆ° má»¥c</button>
        <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>ğŸ§  PhÃ¢n tÃ­ch nÃ¢ng cao</button>
        <button class="btn" id="downloadAnalysisBtn" onclick="downloadAnalysisFromDrive()" disabled>ğŸ“¥ Táº£i phÃ¢n tÃ­ch</button>
        <button class="btn" onclick="loadAnalysisLocal()">ğŸ“„ Táº£i cache local</button>
        <button class="btn" onclick="uploadAnalysisToDrive()">â˜ï¸ Upload phÃ¢n tÃ­ch</button>
        <button class="btn" onclick="clearLocalCache()" style="background: #e74c3c;">ğŸ—‘ï¸ XÃ³a cache</button>
      </div>
      <div class="card">
        <h3>ğŸ“Š Káº¿t quáº£ phÃ¢n tÃ­ch</h3>
        <div id="analysisResults">
          <div class="empty-state">
            <p>ğŸ”­ ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
              HÃ£y káº¿t ná»‘i Google Drive, quÃ©t thÆ° má»¥c vÃ  phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-generator" class="tab-content">
      <!-- Learning System Status -->
      <div class="card learning-system">
        <h3>ğŸ§  Há»‡ thá»‘ng AI há»c mÃ¡y</h3>
        <div id="learningStatus">
          <p>ğŸ“š Tráº¡ng thÃ¡i: <span id="aiStatus">Chá» dá»¯ liá»‡u phÃ¢n tÃ­ch</span></p>
          <p>ğŸ¯ MÃ´ hÃ¬nh hiá»‡n táº¡i: <span id="currentModel">ChÆ°a khá»Ÿi táº¡o</span></p>
          <div id="learningProgress" class="learning-progress">
            <p id="learningContent">Há»‡ thá»‘ng Ä‘ang há»c tá»« dá»¯ liá»‡u...</p>
          </div>
        </div>
      </div>

      <!-- Story Generator -->
      <div class="card story-generator">
        <h3>âœï¸ Táº¡o Truyá»‡n ThÃ´ng Minh</h3>
        <p style="color: #bdc3c7; margin-bottom: 15px;">
          Sá»­ dá»¥ng AI há»c mÃ¡y Ä‘á»ƒ táº¡o truyá»‡n dá»±a trÃªn phÃ¢n tÃ­ch dá»¯ liá»‡u hiá»‡n cÃ³
        </p>

        <!-- Template Selection -->
        <div class="control-group">
          <label>ğŸ“ Chá»n Template Truyá»‡n:</label>
          <div class="template-selector" id="templateSelector">
            <div class="template-card selected" data-template="family_drama">
              <h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Gia ÄÃ¬nh Drama</h4>
              <p>CÃ¢u chuyá»‡n phá»©c táº¡p vá» tÃ¬nh cáº£m gia Ä‘Ã¬nh</p>
            </div>
            <div class="template-card" data-template="romance">
              <h4>ğŸ’• LÃ£ng Máº¡n</h4>
              <p>CÃ¢u chuyá»‡n tÃ¬nh yÃªu ngá»t ngÃ o</p>
            </div>
            <div class="template-card" data-template="adventure">
              <h4>ğŸ—ºï¸ PhiÃªu LÆ°u</h4>
              <p>Cuá»™c phiÃªu lÆ°u ká»³ thÃº</p>
            </div>
            <div class="template-card" data-template="drama">
              <h4>ğŸ­ ChÃ­nh Ká»‹ch</h4>
              <p>TÃ¬nh huá»‘ng phá»©c táº¡p, cáº£m xÃºc sÃ¢u sáº¯c</p>
            </div>
          </div>
        </div>

        <!-- Generation Controls -->
        <div class="generator-controls">
          <div class="control-group">
            <label>ğŸ“ Äá»™ dÃ i truyá»‡n:</label>
            <select id="storyLength">
              <option value="short">Ngáº¯n (800-1200 tá»«)</option>
              <option value="medium" selected>Trung bÃ¬nh (1500-2000 tá»«)</option>
              <option value="long">DÃ i (2500-3500 tá»«)</option>
            </select>
          </div>

          <div class="control-group">
            <label>ğŸ‘ï¸ NgÃ´i ká»ƒ:</label>
            <select id="narrativePerspective">
              <option value="auto">Tá»± Ä‘á»™ng (dá»±a trÃªn phÃ¢n tÃ­ch)</option>
              <option value="first">NgÃ´i thá»© nháº¥t</option>
              <option value="third">NgÃ´i thá»© ba</option>
            </select>
          </div>

          <div class="control-group">
            <label>ğŸ¨ Má»©c Ä‘á»™ sÃ¡ng táº¡o:</label>
            <input type="range" id="creativityLevel" min="1" max="10" value="7" 
                   oninput="document.getElementById('creativityValue').textContent = this.value">
            <span id="creativityValue">7</span>/10
          </div>

          <div class="control-group">
            <label>ğŸ“ˆ Äá»™ há»c tá»« dá»¯ liá»‡u gá»‘c:</label>
            <input type="range" id="learningIntensity" min="1" max="10" value="8" 
                   oninput="document.getElementById('learningValue').textContent = this.value">
            <span id="learningValue">8</span>/10
          </div>
        </div>

        <!-- Custom Prompt -->
        <div class="control-group">
          <label>ğŸ’­ YÃªu cáº§u Ä‘áº·c biá»‡t (tÃ¹y chá»n):</label>
          <textarea id="customPrompt" rows="3" placeholder="VÃ­ dá»¥: Táº­p trung vÃ o tÃ¢m lÃ½ nhÃ¢n váº­t, cÃ³ twist báº¥t ngá», káº¿t thÃºc cÃ³ háº­u..."></textarea>
        </div>

        <!-- Generate Button -->
        <div style="text-align: center; margin: 20px 0;">
          <button class="btn-generate" onclick="generateIntelligentStory()" id="generateBtn">
            ğŸš€ Táº¡o Truyá»‡n ThÃ´ng Minh
          </button>
        </div>

        <!-- Story Stats -->
        <div class="story-stats" id="generationStats" style="display: none;">
          <p><strong>ğŸ“Š ThÃ´ng tin táº¡o truyá»‡n:</strong></p>
          <div id="statsContent"></div>
        </div>
      </div>

      <!-- Generated Story Display -->
      <div class="card">
        <h3>ğŸ“– Truyá»‡n ÄÆ°á»£c Táº¡o</h3>
        <div id="generatedStory" class="story-preview">
          <p style="color: #7f8c8d; font-style: italic;">
            ChÆ°a cÃ³ truyá»‡n nÃ o Ä‘Æ°á»£c táº¡o. HÃ£y chá»n template vÃ  nháº¥n "Táº¡o Truyá»‡n ThÃ´ng Minh" Ä‘á»ƒ báº¯t Ä‘áº§u!
          </p>
        </div>
        
        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 15px;">
          <button class="btn" onclick="copyStory()" id="copyBtn" disabled>ğŸ“‹ Sao ChÃ©p</button>
          <button class="btn" onclick="saveStoryToDrive()" id="saveBtn" disabled>ğŸ’¾ LÆ°u lÃªn Drive</button>
          <button class="btn" onclick="improveStory()" id="improveBtn" disabled>âœ¨ Cáº£i Thiá»‡n</button>
          <button class="btn" onclick="regenerateStory()" id="regenBtn" disabled>ğŸ”„ Táº¡o Láº¡i</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">ğŸ” PhÃ¢n tÃ­ch</a>
    <a href="#" class="menu-item" onclick="switchTab('tab-generator')">âœï¸ Táº¡o truyá»‡n</a>
  </div>

  <script>
    // ===== GOOGLE API & CORE VARIABLES =====
    const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    let tokenClient, gapi_inited = false, gsi_inited = false;
    let analysisData = [];
    let txtFiles = [];

    // ===== STORY GENERATION VARIABLES =====
    let selectedTemplate = 'family_drama';
    let generatedStoryContent = '';
    let storyAI = null;

    // ===== ENHANCED VOCABULARY FOR STORY ANALYSIS =====
    const familyDramaVocabulary = {
      relationships: {
        family: ['bá»‘', 'máº¹', 'con', 'chá»“ng', 'vá»£', 'dÃ¢u', 'rá»ƒ', 'anh', 'chá»‹', 'em'],
        tension: ['cÄƒng tháº³ng', 'xung Ä‘á»™t', 'báº¥t Ä‘á»“ng', 'hiá»ƒu láº§m', 'mÃ¢u thuáº«n'],
        discovery: ['phÃ¡t hiá»‡n', 'tÃ¬m ra', 'biáº¿t Ä‘Æ°á»£c', 'nháº­n ra', 'bÃ­ máº­t']
      },
      emotions: {
        guilt: ['tá»™i lá»—i', 'Ã¢n háº­n', 'há»‘i háº­n', 'xáº¥u há»•', 'day dá»©t'],
        temptation: ['cÃ¡m dá»—', 'quyáº¿n rÅ©', 'khÃ³ cÆ°á»¡ng', 'thu hÃºt', 'mÃª hoáº·c'],
        conflict: ['Ä‘áº¥u tranh', 'phÃ¢n vÃ¢n', 'khÃ³ khÄƒn', 'bÄƒn khoÄƒn', 'trÄƒn trá»Ÿ']
      }
    };

    const storyPatterns = {
      family_drama: {
        openings: [
          "Trong cÄƒn nhÃ  nhá» á»Ÿ",
          "Gia Ä‘Ã¬nh {char1} váº«n luÃ´n",
          "Tá»« khi {char2} vá» lÃ m dÃ¢u"
        ],
        conflicts: [
          "TÃ¬nh cáº£m phá»©c táº¡p náº£y sinh",
          "Nhá»¯ng khoáº£nh kháº¯c riÃªng tÆ°",
          "Sá»± hiá»ƒu láº§m dáº§n lá»›n"
        ],
        resolutions: [
          "Cuá»‘i cÃ¹ng má»i ngÆ°á»i hiá»ƒu ra",
          "TÃ¬nh cáº£m gia Ä‘Ã¬nh chiáº¿n tháº¯ng",
          "Há» há»c Ä‘Æ°á»£c cÃ¡ch yÃªu thÆ°Æ¡ng"
        ]
      }
    };

    // ===== INTELLIGENT STORY LEARNING SYSTEM =====
    class IntelligentStoryAI {
      constructor() {
        this.patterns = this.loadLearningData();
        this.analysisInsights = {};
        this.generationHistory = [];
      }

      loadLearningData() {
        const saved = localStorage.getItem('storyAILearningData');
        return saved ? JSON.parse(saved) : {
          goodSentences: [],
          goodDialogues: [],
          successfulPlots: [],
          characterTraits: {},
          improvedVersions: []
        };
      }

      saveLearningData() {
        localStorage.setItem('storyAILearningData', JSON.stringify(this.patterns));
      }

      analyzeExistingData(analysisData) {
        if (!analysisData || analysisData.length === 0) return null;

        this.analysisInsights = {
          commonCharacters: this.extractCommonElements(analysisData, 'nhanVat'),
          commonPlaces: this.extractCommonElements(analysisData, 'diaDiem'),
          commonEmotions: this.extractEmotionalPatterns(analysisData),
          writingStyle: this.detectWritingStyle(analysisData),
          averageLength: this.calculateAverageLength(analysisData),
          storyStructures: this.analyzeStoryStructures(analysisData)
        };

        return this.analysisInsights;
      }

      extractCommonElements(data, field) {
        const allElements = [];
        data.forEach(story => {
          if (story.storyStructure && story.storyStructure[field]) {
            allElements.push(...story.storyStructure[field]);
          }
        });
        return this.getMostFrequent(allElements, 10);
      }

      extractEmotionalPatterns(data) {
        const emotions = { positive: [], negative: [], neutral: [] };
        data.forEach(story => {
          if (story.storyStructure && story.storyStructure.emotion) {
            const e = story.storyStructure.emotion;
            if (e.positive) emotions.positive.push(...e.positive);
            if (e.negative) emotions.negative.push(...e.negative);
            if (e.neutral) emotions.neutral.push(...e.neutral);
          }
        });
        return emotions;
      }

      detectWritingStyle(data) {
        let dialogueCount = 0;
        let descriptiveCount = 0;
        
        data.forEach(story => {
          if (story.storyStructure) {
            if (story.storyStructure.hoiThoai && story.storyStructure.hoiThoai.length > 3) {
              dialogueCount++;
            }
            if (story.basicStats && story.basicStats.wordCount > 1000) {
              descriptiveCount++;
            }
          }
        });

        return dialogueCount > descriptiveCount ? 'dialogue-heavy' : 'descriptive';
      }

      calculateAverageLength(data) {
        let totalWords = 0;
        let count = 0;
        data.forEach(story => {
          if (story.basicStats && story.basicStats.wordCount) {
            totalWords += story.basicStats.wordCount;
            count++;
          }
        });
        return count > 0 ? Math.round(totalWords / count) : 1500;
      }

      analyzeStoryStructures(data) {
        const structures = [];
        data.forEach(story => {
          if (story.storyStructure) {
            structures.push({
              opening: story.storyStructure.moBai ? story.storyStructure.moBai.substring(0, 100) : '',
              development: story.storyStructure.thanBai ? story.storyStructure.thanBai.substring(0, 200) : '',
              ending: story.storyStructure.ketBai ? story.storyStructure.ketBai.substring(0, 100) : ''
            });
          }
        });
        return structures;
      }

      getMostFrequent(arr, limit = 5) {
        const frequency = {};
        arr.forEach(item => {
          if (item && typeof item === 'string') {
            frequency[item] = (frequency[item] || 0) + 1;
          }
        });
        
        return Object.entries(frequency)
          .sort(([,a], [,b]) => b - a)
          .slice(0, limit)
          .map(([item]) => item);
      }

      generateIntelligentStory(params) {
        if (!this.analysisInsights) {
          throw new Error('Cáº§n phÃ¢n tÃ­ch dá»¯ liá»‡u trÆ°á»›c khi táº¡o truyá»‡n!');
        }

        const storyData = this.createStoryStructure(params);
        const fullStory = this.writeStory(storyData, params);
        
        // Learn from this generation
        this.learnFromGeneration(fullStory, params);
        
        return {
          story: fullStory,
          metadata: storyData,
          insights: this.analysisInsights
        };
      }

      createStoryStructure(params) {
        const characters = this.generateSmartCharacters();
        const setting = this.selectSmartSetting();
        const plot = this.developSmartPlot(params.template, characters);

        return {
          characters,
          setting,
          plot,
          style: this.analysisInsights.writingStyle,
          targetLength: this.getTargetLength(params.length)
        };
      }

      generateSmartCharacters() {
        const characters = [];
        const commonNames = this.analysisInsights.commonCharacters || [];
        
        // Main character
        characters.push({
          name: commonNames[0] || this.generateVietnameseName('male'),
          role: 'bá»‘ chá»“ng',
          age: '50-60',
          traits: ['cÃ³ trÃ¡ch nhiá»‡m', 'quan tÃ¢m gia Ä‘Ã¬nh', 'Ä‘Ã´i khi cÃ´ Ä‘Æ¡n'],
          background: 'LÃ m viá»‡c cáº§n máº«n, lo cho gia Ä‘Ã¬nh'
        });

        // Supporting character  
        characters.push({
          name: commonNames[1] || this.generateVietnameseName('female'),
          role: 'nÃ ng dÃ¢u',
          age: '28-35', 
          traits: ['hiá»n lÃ nh', 'chÄƒm chá»‰', 'cÃ³ tÃ¢m há»“n Ä‘áº¹p'],
          background: 'Vá» nhÃ  chá»“ng Ä‘Æ°á»£c má»™t thá»i gian'
        });

        return characters;
      }

      generateVietnameseName(gender) {
        const maleNames = ['Anh DÅ©ng', 'Minh Tuáº¥n', 'VÄƒn Háº£i', 'Äá»©c Anh', 'Quang Huy'];
        const femaleNames = ['Thu HÃ ', 'Lan Anh', 'Thanh ThÃºy', 'Minh Ngá»c', 'HÆ°Æ¡ng Giang'];
        
        const names = gender === 'male' ? maleNames : femaleNames;
        return names[Math.floor(Math.random() * names.length)];
      }

      selectSmartSetting() {
        const commonPlaces = this.analysisInsights.commonPlaces || ['nhÃ ', 'lÃ ng quÃª'];
        return {
          primary: commonPlaces[0] || 'nhÃ ',
          time: 'hiá»‡n táº¡i',
          atmosphere: 'áº¥m cÃºng nhÆ°ng cÃ³ chÃºt cÄƒng tháº³ng'
        };
      }

      developSmartPlot(template, characters) {
        const plotPoints = [
          `Cuá»™c sá»‘ng hÃ ng ngÃ y cá»§a ${characters[0].name} vÃ  ${characters[1].name}`,
          `Nhá»¯ng khoáº£nh kháº¯c tÃ¢m lÃ½ phá»©c táº¡p náº£y sinh`,
          `Sá»± hiá»ƒu láº§m vÃ  cÄƒng tháº³ng gia tÄƒng`,
          `Nháº­n ra vÃ  giáº£i quyáº¿t váº¥n Ä‘á»`,
          `TÃ¬m láº¡i sá»± hÃ i hÃ²a trong gia Ä‘Ã¬nh`
        ];

        return plotPoints;
      }

      getTargetLength(lengthParam) {
        const targets = {
          short: { words: 1000, paragraphs: 6 },
          medium: { words: 1800, paragraphs: 8 },
          long: { words: 3000, paragraphs: 12 }
        };
        return targets[lengthParam] || targets.medium;
      }

      writeStory(storyData, params) {
        const { characters, setting, plot, targetLength } = storyData;
        
        let story = `${this.generateTitle(params.template)}\n\n`;
        
        // Opening
        story += this.writeOpening(characters, setting) + '\n\n';
        
        // Development paragraphs
        for (let i = 1; i < plot.length - 1; i++) {
          story += this.writeDevelopmentParagraph(plot[i], characters, i) + '\n\n';
        }
        
        // Conclusion
        story += this.writeConclusion(characters, setting);
        
        return story;
      }

      generateTitle(template) {
        const titles = {
          family_drama: ['TÃ¬nh Cáº£m Gia ÄÃ¬nh', 'Nhá»¯ng NgÃ y BÃ¬nh YÃªn', 'Gáº¯n Káº¿t YÃªu ThÆ°Æ¡ng'],
          romance: ['TÃ¬nh YÃªu Trong SÃ¡ng', 'NgÃ y Em Äáº¿n', 'Háº¡nh PhÃºc Nhá»'],
          adventure: ['Cuá»™c PhiÃªu LÆ°u', 'HÃ nh TrÃ¬nh KhÃ¡m PhÃ¡'],
          drama: ['Nhá»¯ng NgÃ y ÄÃ³', 'Cuá»™c Äá»i', 'KÃ­ á»¨c']
        };
        
        const templateTitles = titles[template] || titles.family_drama;
        return templateTitles[Math.floor(Math.random() * templateTitles.length)];
      }

      writeOpening(characters, setting) {
        const openings = [
          `Trong cÄƒn ${setting.primary} nhá», ${characters[0].name} ngá»“i uá»‘ng trÃ  vÃ  suy nghÄ© vá» cuá»™c sá»‘ng. ÄÃ£ lÃ¢u rá»“i ká»ƒ tá»« khi ${characters[1].name} vá» lÃ m dÃ¢u, ngÃ´i nhÃ  trá»Ÿ nÃªn áº¥m Ã¡p hÆ¡n nhiá»u.`,
          `Buá»•i sÃ¡ng yÃªn bÃ¬nh á»Ÿ ${setting.primary}, ${characters[0].name} thá»©c dáº­y vá»›i cáº£m giÃ¡c bÃ¬nh an. ${characters[1].name} Ä‘Ã£ trá»Ÿ thÃ nh má»™t pháº§n khÃ´ng thá»ƒ thiáº¿u trong gia Ä‘Ã¬nh.`,
          `Ãnh náº¯ng chiá»u chiáº¿u qua khung cá»­a sá»•, ${characters[0].name} nhÃ¬n ${characters[1].name} Ä‘ang táº¥t báº­t trong báº¿p vÃ  cáº£m tháº¥y lÃ²ng áº¥m Ã¡p láº¡ thÆ°á»ng.`
        ];
        
        return openings[Math.floor(Math.random() * openings.length)];
      }

      writeDevelopmentParagraph(plotPoint, characters, index) {
        const developments = [
          `${characters[0].name} nháº­n ra mÃ¬nh Ä‘ang cÃ³ nhá»¯ng cáº£m xÃºc phá»©c táº¡p. Nhá»¯ng khoáº£nh kháº¯c nhá» bÃªn ${characters[1].name} khiáº¿n Ã´ng cáº£m tháº¥y cuá»™c sá»‘ng cÃ³ Ã½ nghÄ©a hÆ¡n.`,
          `Trong lÃ²ng ${characters[1].name}, sá»± tÃ´n trá»ng dÃ nh cho ${characters[0].name} dáº§n chuyá»ƒn thÃ nh má»™t tÃ¬nh cáº£m sÃ¢u sáº¯c hÆ¡n. CÃ´ hiá»ƒu ráº±ng Ä‘Ã¢y lÃ  ngÆ°á»i Ä‘Ã n Ã´ng tá»‘t bá»¥ng vÃ  cÃ³ trÃ¡ch nhiá»‡m.`,
          `Nhá»¯ng cuá»™c trÃ² chuyá»‡n buá»•i tá»‘i giá»¯a hai ngÆ°á»i trá»Ÿ nÃªn thÃ¢n máº­t hÆ¡n. ${characters[0].name} chia sáº» vá» quÃ¡ khá»©, vá» nhá»¯ng khÃ³ khÄƒn trong cuá»™c sá»‘ng.`,
          `${characters[1].name} cáº£m tháº¥y mÃ¬nh Ä‘Æ°á»£c hiá»ƒu vÃ  Ä‘Æ°á»£c quan tÃ¢m má»™t cÃ¡ch chÃ¢n thÃ nh. Trong con máº¯t ${characters[0].name}, cÃ´ tháº¥y sá»± trÃ¢n trá»ng vÃ  yÃªu thÆ°Æ¡ng.`,
          `Cáº£ hai Ä‘á»u nháº­n ra ráº±ng tÃ¬nh cáº£m nÃ y tuy Ä‘áº¹p nhÆ°ng phá»©c táº¡p. Há» pháº£i Ä‘á»‘i máº·t vá»›i Ã¡p lá»±c xÃ£ há»™i vÃ  ká»³ vá»ng cá»§a gia Ä‘Ã¬nh.`
        ];
        
        return developments[index % developments.length];
      }

      writeConclusion(characters, setting) {
        const conclusions = [
          `Cuá»‘i cÃ¹ng, ${characters[0].name} vÃ  ${characters[1].name} hiá»ƒu ra ráº±ng tÃ¬nh cáº£m Ä‘áº¹p nháº¥t lÃ  sá»± tÃ´n trá»ng vÃ  quan tÃ¢m láº«n nhau. Há» quyáº¿t Ä‘á»‹nh giá»¯ má»‘i quan há»‡ gia Ä‘Ã¬nh hÃ i hÃ²a, vá»›i tÃ¬nh yÃªu thÆ°Æ¡ng trong sÃ¡ng vÃ  tÃ´n trá»ng.`,
          `Gia Ä‘Ã¬nh nhá» tÃ¬m láº¡i Ä‘Æ°á»£c sá»± cÃ¢n báº±ng. ${characters[0].name} vÃ  ${characters[1].name} trá»Ÿ thÃ nh nhá»¯ng ngÆ°á»i báº¡n tÃ¢m giao, luÃ´n há»— trá»£ nhau trong cuá»™c sá»‘ng vá»›i tÃ¬nh cáº£m chÃ¢n thÃ nh vÃ  trong sáº¡ch.`,
          `TÃ¬nh cáº£m gia Ä‘Ã¬nh Ä‘Æ°á»£c cá»§ng cá»‘ qua thá»­ thÃ¡ch. ${characters[0].name} vÃ  ${characters[1].name} há»c Ä‘Æ°á»£c cÃ¡ch yÃªu thÆ°Æ¡ng má»™t cÃ¡ch khÃ´n ngoan, tÃ´n trá»ng vÃ  cÃ³ trÃ¡ch nhiá»‡m.`
        ];
        
        return conclusions[Math.floor(Math.random() * conclusions.length)];
      }

      learnFromGeneration(story, params) {
        // Analyze the generated story
        const sentences = story.split('.').filter(s => s.trim().length > 20);
        const goodSentences = sentences.filter(s => this.isQualitySentence(s));
        
        // Store learning data
        this.patterns.goodSentences.push(...goodSentences.slice(0, 3));
        this.generationHistory.push({
          template: params.template,
          length: params.length,
          creativity: params.creativity,
          timestamp: new Date().toISOString(),
          wordCount: story.split(' ').length
        });
        
        // Keep only recent data to prevent memory bloat
        if (this.patterns.goodSentences.length > 100) {
          this.patterns.goodSentences = this.patterns.goodSentences.slice(-50);
        }
        
        this.saveLearningData();
      }

      isQualitySentence(sentence) {
        const criteria = [
          sentence.length > 50 && sentence.length < 200,
          /cáº£m tháº¥y|nháº­n ra|hiá»ƒu|yÃªu thÆ°Æ¡ng/.test(sentence),
          /,|;/.test(sentence),
          !sentence.includes('...') || sentence.includes('...')
        ];
        return criteria.filter(Boolean).length >= 3;
      }

      getImprovementSuggestions() {
        return [
          'ThÃªm chi tiáº¿t miÃªu táº£ cáº£m xÃºc',
          'PhÃ¡t triá»ƒn tÃ¢m lÃ½ nhÃ¢n váº­t sÃ¢u hÆ¡n',
          'Cáº£i thiá»‡n Ä‘á»‘i thoáº¡i tá»± nhiÃªn hÆ¡n',
          'TÄƒng cÆ°á»ng tÃ­nh há»£p lÃ½ trong cá»‘t truyá»‡n',
          'HoÃ n thiá»‡n káº¿t thÃºc cÃ³ Ã½ nghÄ©a'
        ];
      }
    }

    // ===== GOOGLE API FUNCTIONS =====
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC]
      });
      gapi_inited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
      });
      gsi_inited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapi_inited && gsi_inited) {
        document.getElementById('scanBtn').disabled = false;
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        gapi.client.setToken({access_token: resp.access_token});
        updateStatus('ğŸŸ¢ ÄÃ£ káº¿t ná»‘i Google Drive');
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('downloadAnalysisBtn').disabled = false;
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // ===== UI UPDATE FUNCTIONS =====
    function updateStatus(msg) {
      document.getElementById('statusInfo').innerText = msg;
    }

    function updateProgress(p) {
      document.getElementById('progressBar').style.width = p + '%';
    }

    function updateDetailedStatus(msg) {
      document.getElementById('detailedStatus').innerText = msg;
    }

    // ===== LOCAL STORAGE FUNCTIONS =====
    function saveAnalysisLocal() {
      const analysisContent = {
        analysisData: analysisData,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('analysisResults', JSON.stringify(analysisContent));
    }

    function loadAnalysisLocal() {
      const data = localStorage.getItem('analysisResults');
      if (data) {
        try {
          const parsed = JSON.parse(data);
          analysisData = parsed.analysisData || [];
          displayAdvancedAnalysisResults();
          updateStatus('âœ… ÄÃ£ táº£i cache local');
          updateAIStatus();
          return true;
        } catch (e) {
          console.error('Error loading local cache:', e);
          updateStatus('âŒ Lá»—i khi táº£i cache local');
        }
      } else {
        updateStatus('âš ï¸ KhÃ´ng cÃ³ cache local');
        displayEmptyState();
      }
      return false;
    }

    function clearLocalCache() {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ cache local?')) {
        localStorage.removeItem('analysisResults');
        localStorage.removeItem('storyAILearningData');
        analysisData = [];
        storyAI = null;
        displayEmptyState();
        updateStatus('ğŸ—‘ï¸ ÄÃ£ xÃ³a cache local');
        updateAIStatus();
      }
    }

    function displayEmptyState() {
      const container = document.getElementById('analysisResults');
      container.innerHTML = `
        <div class="empty-state">
          <p>ğŸ”­ ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>
          <p style="font-size: 0.9em; margin-top: 10px;">
            HÃ£y káº¿t ná»‘i Google Drive, quÃ©t thÆ° má»¥c vÃ  phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.
          </p>
        </div>
      `;
    }

    // ===== GOOGLE DRIVE FUNCTIONS =====
    function uploadAnalysisToDrive() {
      if (!analysisData || analysisData.length === 0) {
        alert("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch Ä‘á»ƒ upload!");
        return;
      }

      const fileContent = JSON.stringify(analysisData, null, 2);
      const file = new Blob([fileContent], { type: 'application/json' });

      const metadata = {
        name: "analysisData.json",
        mimeType: "application/json"
      };

      const accessToken = gapi.client.getToken().access_token;
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", file);

      fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
      }).then(res => res.json()).then(val => {
        alert("âœ… ÄÃ£ upload phÃ¢n tÃ­ch lÃªn Google Drive: " + val.id);
      }).catch(err => {
        console.error("Upload lá»—i:", err);
        alert("âŒ Lá»—i khi upload: " + err.message);
      });
    }

    async function downloadAnalysisFromDrive() {
      try {
        const accessToken = gapi.client.getToken().access_token;

        let res = await fetch(
          "https://www.googleapis.com/drive/v3/files?q=name='analysisData.json'&fields=files(id,name)",
          { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let data = await res.json();

        if (!data.files || data.files.length === 0) {
          alert("âš ï¸ KhÃ´ng tÃ¬m tháº¥y file analysisData.json trÃªn Google Drive!");
          return;
        }

        const fileId = data.files[0].id;

        let fileRes = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let content = await fileRes.json();

        analysisData = content;
        saveAnalysisLocal();

        alert("âœ… ÄÃ£ táº£i phÃ¢n tÃ­ch vá» tá»« Google Drive!");
        displayAdvancedAnalysisResults();
        updateAIStatus();

      } catch (err) {
        console.error("Download lá»—i:", err);
        alert("âŒ Lá»—i khi táº£i phÃ¢n tÃ­ch tá»« Google Drive: " + err.message);
      }
    }

    const ROOT_FOLDER_NAME = "QuanLyTruyen";

    // ===== SCAN FOLDER FUNCTION =====
    async function scanFolder() {
      updateStatus("ğŸ“ Äang quÃ©t thÆ° má»¥c QuanLyTruyen...");
      updateProgress(5);

      try {
        const folderRes = await gapi.client.drive.files.list({
          q: `mimeType='application/vnd.google-apps.folder' and name='${ROOT_FOLDER_NAME}' and trashed=false`,
          fields: "files(id, name)"
        });

        if (!folderRes.result.files || folderRes.result.files.length === 0) {
          updateStatus("âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c QuanLyTruyen trÃªn Google Drive!");
          return;
        }

        const rootFolderId = folderRes.result.files[0].id;
        txtFiles = [];
        await fetchFilesRecursive(rootFolderId, ROOT_FOLDER_NAME);

        if (txtFiles.length === 0) {
          updateStatus("âš ï¸ KhÃ´ng cÃ³ file .txt nÃ o trong QuanLyTruyen.");
          return;
        }

        updateStatus(`âœ… ÄÃ£ quÃ©t Ä‘Æ°á»£c ${txtFiles.length} file .txt`);
        updateProgress(100);
        document.getElementById("analyzeBtn").disabled = false;

      } catch (err) {
        console.error("âŒ Lá»—i khi quÃ©t thÆ° má»¥c:", err);
        updateStatus("âŒ Lá»—i khi quÃ©t thÆ° má»¥c: " + err.message);
      }
    }

    async function fetchFilesRecursive(folderId, folderPath) {
      let pageToken = null;
      do {
        const res = await gapi.client.drive.files.list({
          q: `'${folderId}' in parents and trashed=false`,
          fields: "nextPageToken, files(id, name, mimeType)",
          pageToken: pageToken
        });

        for (const file of res.result.files) {
          if (file.mimeType === "application/vnd.google-apps.folder") {
            await fetchFilesRecursive(file.id, `${folderPath}/${file.name}`);
          } else if (file.mimeType === "text/plain" || file.name.endsWith(".txt")) {
            txtFiles.push({
              id: file.id,
              name: file.name,
              folderPath: folderPath
            });
          }
        }
        pageToken = res.result.nextPageToken;
      } while (pageToken);
    }

    // ===== ANALYZE FILES FUNCTION =====
    async function analyzeFiles() {
      if (!txtFiles || txtFiles.length === 0) {
        alert('âš ï¸ Vui lÃ²ng quÃ©t thÆ° má»¥c trÆ°á»›c!');
        return;
      }

      // Load existing analysis from local cache
      let existingAnalysis = [];
      const localData = localStorage.getItem('analysisResults');
      if (localData) {
        try {
          existingAnalysis = JSON.parse(localData).analysisData || [];
        } catch (e) {
          console.error('Error loading existing analysis:', e);
        }
      }

      const analyzedFileNames = existingAnalysis.map(a => a.fileName);
      let filesToAnalyze = txtFiles.filter(f => !analyzedFileNames.includes(f.name));

      if (filesToAnalyze.length === 0) {
        updateStatus('âœ… Táº¥t cáº£ file Ä‘Ã£ Ä‘Æ°á»£c phÃ¢n tÃ­ch');
        analysisData = existingAnalysis;
        displayAdvancedAnalysisResults();
        updateAIStatus();
        return;
      }

      const totalFiles = Math.min(filesToAnalyze.length, 50);
      analysisData = [...existingAnalysis];
      
      updateStatus(`ğŸ§  Báº¯t Ä‘áº§u phÃ¢n tÃ­ch ${totalFiles} file...`);

      for (let i = 0; i < totalFiles; i++) {
        const file = filesToAnalyze[i];
        updateProgress((i / totalFiles) * 100);
        updateDetailedStatus(`Äang phÃ¢n tÃ­ch: ${file.name} (${i + 1}/${totalFiles})`);

        try {
          const content = await readFileFromDrive(file.id);
          const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
          analysisData.push(analysis);
          saveAnalysisLocal();
          
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (err) {
          console.error(`Error analyzing ${file.name}:`, err);
          analysisData.push({
            fileName: file.name,
            folderPath: file.folderPath,
            timestamp: new Date().toLocaleString('vi-VN'),
            error: err.message
          });
        }
      }

      displayAdvancedAnalysisResults();
      updateProgress(100);
      updateStatus(`âœ… HoÃ n thÃ nh phÃ¢n tÃ­ch ${totalFiles} file`);
      updateAIStatus();
      setTimeout(() => updateProgress(0), 2000);
    }

    // ===== READ FILE FROM DRIVE =====
    async function readFileFromDrive(fileId) {
      try {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`Failed to read file: ${response.status}`);
        }
        
        return await response.text();
      } catch (error) {
        throw new Error(`Error reading file: ${error.message}`);
      }
    }

    // ===== STORY ANALYSIS FUNCTIONS =====
    const sensitiveWords = {
      romantic: ['yÃªu', 'thÆ°Æ¡ng', 'hÃ´n', 'Ã´m', 'áº¥p Ã´m', 'áº¥m Ã¡p', 'say Ä‘áº¯m', 'Ä‘am mÃª', 'dá»‹u dÃ ng', 'ngá»t ngÃ o', 'quyáº¿n rÅ©', 'mÃª hoáº·c', 'thÃ¢n máº­t', 'gáº§n gÅ©i'],
      sexual: ['gá»‘i chÄƒn', 'phÃ²ng the', 'Ã¢n Ã¡i', 'lÃ m tÃ¬nh', 'quan há»‡', 'tÃ¬nh dá»¥c'],
      negative: ['ghÃ©t', 'háº­n', 'giáº­n', 'tá»©c', 'tá»§i', 'buá»“n', 'Ä‘au', 'khá»•', 'sáº§u', 'tháº£m', 'bi', 'tang', 'tá»­', 'cháº¿t', 'giáº¿t', 'háº¡i', 'Ã¡c', 'dá»¯', 'hung'],
      family: ['bá»‘', 'máº¹', 'cha', 'con', 'chá»“ng', 'vá»£', 'dÃ¢u', 'rá»ƒ', 'anh', 'chá»‹', 'em', 'Ã´ng', 'bÃ ', 'chÃº', 'bÃ¡c', 'cÃ´', 'dÃ¬', 'cáº­u', 'má»£'],
      secret: ['bÃ­ máº­t', 'giáº¥u giáº¿m', 'che giáº¥u', 'giáº¥u diáº¿m', 'lÃ©n lÃºt', 'vá»¥ng trá»™m', 'Ã¢m tháº§m', 'láº·ng láº½', 'kÃ­n Ä‘Ã¡o', 'riÃªng tÆ°']
    };

    const emotionalWords = {
      positive: ['vui', 'háº¡nh phÃºc', 'yÃªu', 'thÆ°Æ¡ng', 'tuyá»‡t vá»i', 'Ä‘áº¹p', 'tá»‘t', 'xuáº¥t sáº¯c', 'thÃ nh cÃ´ng', 'hy vá»ng'],
      negative: ['buá»“n', 'Ä‘au', 'khá»•', 'tá»‡', 'xáº¥u', 'tháº¥t báº¡i', 'tuyá»‡t vá»ng', 'ghÃ©t', 'tá»©c giáº­n', 'lo láº¯ng', 'sá»£ hÃ£i', 'khÃ³c', 'tang thÆ°Æ¡ng', 'báº¥t háº¡nh'],
      neutral: ['bÃ¬nh thÆ°á»ng', 'thÃ´ng thÆ°á»ng', 'trung bÃ¬nh', 'á»•n', 'Ä‘Æ°á»£c', 'táº¡m á»•n']
    };

    async function performAdvancedAnalysis(content, fileName, folderPath) {
      const structure = analyzeStoryStructure(content);
      const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;

      const sensitiveStats = {
        romanticCount: structure.romantic ? structure.romantic.length : 0,
        sexualCount: structure.sexual ? structure.sexual.length : 0,
        negativeCount: structure.negative ? structure.negative.length : 0,
        familyCount: structure.family ? structure.family.length : 0,
        secretCount: structure.secret ? structure.secret.length : 0
      };

      const emotionStats = {
        positiveCount: structure.emotion?.positive ? structure.emotion.positive.length : 0,
        negativeCount: structure.emotion?.negative ? structure.emotion.negative.length : 0,
        neutralCount: structure.emotion?.neutral ? structure.emotion.neutral.length : 0
      };

      return {
        fileName: fileName,
        folderPath: folderPath,
        timestamp: new Date().toLocaleString('vi-VN'),
        basicStats: { 
          wordCount: wordCount,
          charCount: content.length,
          lineCount: content.split('\n').length
        },
        contentSample: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
        storyStructure: structure,
        sensitiveStats: sensitiveStats,
        emotionStats: emotionStats
      };
    }

    function analyzeStoryStructure(content) {
      const lower = content.toLowerCase();
      
      function findMatches(words) {
        return words.filter(w => lower.includes(w.toLowerCase()));
      }

      const contentLength = content.length;
      const moBai = content.substring(0, Math.min(300, contentLength));
      const ketBai = contentLength > 300 ? content.substring(Math.max(0, contentLength - 300)) : '';
      const thanBai = contentLength > 600 ? content.substring(300, contentLength - 300) : content.substring(300);

      let ngoike = "NgÃ´i thá»© ba";
      if (/\btÃ´i\b|\bta\b|\bchÃºng tÃ´i\b/i.test(content)) ngoike = "NgÃ´i thá»© nháº¥t";
      if (/\bbáº¡n\b|\bcáº­u\b|\bmÃ y\b/i.test(content)) ngoike = "NgÃ´i thá»© hai";

      let characterMatches = content.match(/\b[A-ZÃ€Ãáº¢Ãƒáº Ã‚Ä‚ÄÃŠÃ“Æ Æ¯][a-zÃ Ã¡áº£Ã£áº¡Ã¢ÄƒÄ‘ÃªÃ´Æ¡Æ°]+\b/g) || [];
      let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

      let dialogues = [];
      const lines = content.split('\n');
      for (const line of lines) {
        if (/["'].*["']/.test(line) || /nÃ³i|báº£o|há»i|Ä‘Ã¡p|thÆ°a|kÃªu|gá»i|hÃ©t|la|thÃ©t/.test(line.toLowerCase())) {
          dialogues.push(line.trim());
          if (dialogues.length >= 5) break;
        }
      }

      const timeKeywords = ["sÃ¡ng", "trÆ°a", "chiá»u", "tá»‘i", "Ä‘Ãªm", "hÃ´m qua", "ngÃ y mai", "nÄƒm", "thÃ¡ng", "tuáº§n", "giá»"];
      const placeKeywords = ["nhÃ ", "lÃ ng", "thÃ nh phá»‘", "rá»«ng", "biá»ƒn", "nÃºi", "trÆ°á»ng", "chá»£", "sÃ´ng", "phá»‘", "quÃª"];
      const eventKeywords = ["gáº·p gá»¡", "chia ly", "thá»­ thÃ¡ch", "xung Ä‘á»™t", "chiáº¿n Ä‘áº¥u", "giáº£i cá»©u", "bÃ­ máº­t", "cÆ°á»›i", "cháº¿t"];

      let times = findMatches(timeKeywords);
      let places = findMatches(placeKeywords);
      let events = findMatches(eventKeywords);

      let romantic = findMatches(sensitiveWords.romantic);
      let sexual = findMatches(sensitiveWords.sexual);
      let negative = findMatches(sensitiveWords.negative);
      let family = findMatches(sensitiveWords.family);
      let secret = findMatches(sensitiveWords.secret);

      let emotionPos = findMatches(emotionalWords.positive);
      let emotionNeg = findMatches(emotionalWords.negative);
      let emotionNeu = findMatches(emotionalWords.neutral);

      return {
        moBai: moBai,
        thanBai: thanBai.substring(0, 500) + (thanBai.length > 500 ? '...' : ''),
        ketBai: ketBai,
        ngoike: ngoike,
        nhanVat: uniqueChars,
        hoiThoai: dialogues,
        thoiGian: times,
        diaDiem: places,
        tinhHuong: events,
        tuNgu18: sexual,
        romantic: romantic,
        sexual: sexual,
        negative: negative,
        family: family,
        secret: secret,
        emotion: {
          positive: emotionPos,
          negative: emotionNeg,
          neutral: emotionNeu
        }
      };
    }

    // ===== DISPLAY RESULTS FUNCTION =====
    function displayAdvancedAnalysisResults() {
      const safeArray = v => Array.isArray(v) ? v : [];
      const safeJoin = (value, separator = ', ') => {
        if (Array.isArray(value)) {
          return value.join(separator);
        }
        if (typeof value === "string") {
          return value;
        }
        return "";
      };

      const container = document.getElementById('analysisResults');
      if (!analysisData || analysisData.length === 0) {
        container.innerHTML = '<p>ChÆ°a cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch.</p>';
        return;
      }

      let html = `<h4>ğŸ“Š ÄÃ£ phÃ¢n tÃ­ch ${analysisData.length} file truyá»‡n</h4>`;

      const totalWords = analysisData.reduce((sum, d) => sum + (d.basicStats?.wordCount || 0), 0);
      const avgWords = Math.round(totalWords / analysisData.length);
      html += `<div style="background:#2c3e50;padding:10px;margin:10px 0;border-radius:8px;">
        <p><strong>ğŸ“ˆ Thá»‘ng kÃª tá»•ng quan:</strong></p>
        <p>â€¢ Tá»•ng sá»‘ tá»«: ${totalWords.toLocaleString()} tá»«</p>
        <p>â€¢ Trung bÃ¬nh: ${avgWords.toLocaleString()} tá»«/file</p>
      </div>`;

      analysisData.forEach((d, index) => {
        if (d.error) {
          html += `<div style="background:#e74c3c;padding:10px;margin:10px 0;border-radius:8px;">
            âŒ <strong>${d.fileName}</strong>: ${d.error}
          </div>`;
        } else {
          const struct = d.storyStructure || {};
          html += `<div style="background:#34495e;padding:15px;margin:10px 0;border-radius:8px;">
            <h5>ğŸ“„ ${d.fileName}</h5>
            <p style="color:#bdc3c7;font-size:0.9em;">${d.folderPath} â€¢ ${d.timestamp}</p>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
              <div><strong>ğŸ“Š Sá»‘ tá»«:</strong> ${(d.basicStats?.wordCount || 0).toLocaleString()}</div>
              <div><strong>ğŸ“ NgÃ´i ká»ƒ:</strong> ${struct.ngoike || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}</div>
            </div>

            <div style="margin:10px 0;">
              <p><strong>ğŸ‘¥ NhÃ¢n váº­t:</strong> ${safeJoin(struct.nhanVat)}</p>
              <p><strong>â° Thá»i gian:</strong> ${safeJoin(struct.thoiGian)}</p>
              <p><strong>ğŸŒ Äá»‹a Ä‘iá»ƒm:</strong> ${safeJoin(struct.diaDiem)}</p>
              <p><strong>ğŸ­ TÃ¬nh huá»‘ng:</strong> ${safeJoin(struct.tinhHuong)}</p>
            </div>

            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– Má»Ÿ bÃ i</strong></summary>
              <div class="story-content">${struct.moBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
            </details>
            
            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– ThÃ¢n bÃ i</strong></summary>
              <div class="story-content">${struct.thanBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
            </details>
            
            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>ğŸ“– Káº¿t bÃ i</strong></summary>
              <div class="story-content">${struct.ketBai || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
            </details>

            ${struct.hoiThoai && struct.hoiThoai.length > 0 ? `
            <details>
              <summary style="cursor:pointer;color:#2ecc71;"><strong>ğŸ’¬ Há»™i thoáº¡i (${struct.hoiThoai.length})</strong></summary>
              <div class="story-content">
                ${struct.hoiThoai.map(dialogue => `<p>â€¢ ${dialogue}</p>`).join('')}
              </div>
            </details>` : ''}

            <div style="margin:10px 0;">
              <p><strong>ğŸ˜Š Cáº£m xÃºc tÃ­ch cá»±c:</strong> ${safeJoin(safeArray(struct.emotion?.positive))}</p>
              <p><strong>ğŸ˜¢ Cáº£m xÃºc tiÃªu cá»±c:</strong> ${safeJoin(safeArray(struct.emotion?.negative))}</p>
              <p><strong>ğŸ˜ Cáº£m xÃºc trung tÃ­nh:</strong> ${safeJoin(safeArray(struct.emotion?.neutral))}</p>
            </div>

            <div style="margin:10px 0;">
              <p><strong>ğŸ’ NgÃ´n ngá»¯ tÃ¬nh cáº£m:</strong> ${safeJoin(struct.romantic)}</p>
              <p><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Gia Ä‘Ã¬nh:</strong> ${safeJoin(struct.family)}</p>
              <p><strong>ğŸ¤« BÃ­ máº­t:</strong> ${safeJoin(struct.secret)}</p>
              <p><strong>âš ï¸ TiÃªu cá»±c:</strong> ${safeJoin(struct.negative)}</p>
              ${struct.sexual && struct.sexual.length > 0 ? `
                <p><strong>ğŸ” Ná»™i dung nháº¡y cáº£m:</strong> <span style="color:#e74c3c;">${struct.sexual.length} tá»« khÃ³a phÃ¡t hiá»‡n</span></p>
              ` : ''}
            </div>

            <details>
              <summary style="cursor:pointer;color:#95a5a6;"><strong>ğŸ“„ Máº«u ná»™i dung</strong></summary>
              <div class="story-content" style="font-style:italic;">${d.contentSample || 'KhÃ´ng cÃ³ dá»¯ liá»‡u'}</div>
            </details>
          </div>`;
        }
      });

      container.innerHTML = html;
    }

    // ===== AI STATUS MANAGEMENT =====
    function updateAIStatus() {
      const aiStatus = document.getElementById('aiStatus');
      const currentModel = document.getElementById('currentModel');
      
      if (analysisData && analysisData.length > 0) {
        if (!storyAI) {
          storyAI = new IntelligentStoryAI();
          const insights = storyAI.analyzeExistingData(analysisData);
        }
        aiStatus.textContent = `Sáºµn sÃ ng (${analysisData.length} truyá»‡n Ä‘Ã£ phÃ¢n tÃ­ch)`;
        currentModel.textContent = 'Family Drama AI v1.2';
      } else {
        aiStatus.textContent = 'Chá» dá»¯ liá»‡u phÃ¢n tÃ­ch';
        currentModel.textContent = 'ChÆ°a khá»Ÿi táº¡o';
      }
    }

    // ===== ENHANCED STORY GENERATION =====
    async function generateIntelligentStory() {
      if (!analysisData || analysisData.length === 0) {
        alert('âš ï¸ Cáº§n cÃ³ dá»¯ liá»‡u phÃ¢n tÃ­ch trÆ°á»›c khi táº¡o truyá»‡n! Vui lÃ²ng phÃ¢n tÃ­ch má»™t sá»‘ file trÆ°á»›c.');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      generateBtn.innerHTML = 'ğŸ§  AI Ä‘ang sÃ¡ng tÃ¡c...';

      // Show learning process
      showLearningProcess();

      try {
        // Initialize AI if not already done
        if (!storyAI) {
          storyAI = new IntelligentStoryAI();
        }

        // Get generation parameters
        const params = getGenerationParams();
        
        // Analyze existing data for insights
        const insights = storyAI.analyzeExistingData(analysisData);
        
        // Generate intelligent story
        const storyResult = storyAI.generateIntelligentStory(params);
        
        // Display results
        generatedStoryContent = storyResult.story;
        displayGeneratedStory(storyResult.story);
        showAdvancedStats(storyResult);
        
        // Update learning status
        updateLearningStats(storyAI.patterns);
        
        enableActionButtons();

      } catch (error) {
        console.error('Story generation error:', error);
        alert('âŒ CÃ³ lá»—i khi táº¡o truyá»‡n: ' + error.message);
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ğŸš€ Táº¡o Truyá»‡n ThÃ´ng Minh';
      }
    }

    function getGenerationParams() {
      return {
        template: selectedTemplate,
        length: document.getElementById('storyLength').value,
        perspective: document.getElementById('narrativePerspective').value,
        creativity: parseInt(document.getElementById('creativityLevel').value),
        learningIntensity: parseInt(document.getElementById('learningIntensity').value),
        customPrompt: document.getElementById('customPrompt').value.trim()
      };
    }

    function showLearningProcess() {
      const learningDiv = document.getElementById('learningProgress');
      const content = document.getElementById('learningContent');
      
      content.innerHTML = `
        <p>ğŸ” PhÃ¢n tÃ­ch cÃ¡c máº«u truyá»‡n hiá»‡n cÃ³...</p>
        <p>ğŸ§  Ãp dá»¥ng cÃ¡c ká»¹ thuáº­t viáº¿t ká»‹ch tÃ¬nh...</p>
        <p>âœ¨ SÃ¡ng táº¡o ná»™i dung má»›i vá»›i tÃ¬nh tiáº¿t háº¥p dáº«n...</p>
        <p>ğŸ“š Há»c há»i tá»« ${analysisData.length} truyá»‡n Ä‘Ã£ phÃ¢n tÃ­ch...</p>
      `;
      
      learningDiv.style.display = 'block';
      
      // Hide after a few seconds
      setTimeout(() => {
        learningDiv.style.display = 'none';
      }, 3000);
    }

    function updateLearningStats(patterns) {
      const learningDiv = document.getElementById('learningProgress');
      const content = document.getElementById('learningContent');
      
      content.innerHTML = `
        <p>ğŸ“š ÄÃ£ há»c Ä‘Æ°á»£c ${patterns.goodSentences.length} cÃ¢u vÄƒn hay má»›i</p>
        <p>ğŸ­ Ãp dá»¥ng ${patterns.successfulPlots.length} cáº¥u trÃºc cá»‘t truyá»‡n</p>
        <p>ğŸ“ˆ Cáº£i thiá»‡n liÃªn tá»¥c qua tá»«ng láº§n táº¡o truyá»‡n</p>
        <p>ğŸ§  MÃ´ hÃ¬nh AI Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t vá»›i dá»¯ liá»‡u má»›i</p>
      `;
      
      learningDiv.style.display = 'block';
    }

    function showAdvancedStats(storyResult) {
      const statsDiv = document.getElementById('generationStats');
      const statsContent = document.getElementById('statsContent');
      
      const wordCount = storyResult.story.split(/\s+/).length;
      
      statsContent.innerHTML = `
        <p>â€¢ Sá»‘ tá»«: <strong>${wordCount.toLocaleString()}</strong></p>
        <p>â€¢ Template: <strong>${getTemplateName(selectedTemplate)}</strong></p>
        <p>â€¢ NhÃ¢n váº­t: <strong>${storyResult.metadata.characters.length}</strong></p>
        <p>â€¢ Äá»™ phá»©c táº¡p cá»‘t truyá»‡n: <strong>Cao</strong></p>
        <p>â€¢ Má»©c Ä‘á»™ sÃ¡ng táº¡o: <strong>${document.getElementById('creativityLevel').value}/10</strong></p>
        <p>â€¢ Há»c tá»« dá»¯ liá»‡u: <strong>${document.getElementById('learningIntensity').value}/10</strong></p>
        <p>â€¢ Dá»±a trÃªn: <strong>${analysisData.length} truyá»‡n Ä‘Ã£ phÃ¢n tÃ­ch</strong></p>
      `;
      
      statsDiv.style.display = 'block';
    }

    function getTemplateName(template) {
      const names = {
        'family_drama': 'Gia ÄÃ¬nh Drama',
        'romance': 'LÃ£ng Máº¡n', 
        'adventure': 'PhiÃªu LÆ°u',
        'drama': 'ChÃ­nh Ká»‹ch'
      };
      return names[template] || template;
    }

    function displayGeneratedStory(story) {
      const container = document.getElementById('generatedStory');
      
      // Split title and content
      const parts = story.split('\n\n');
      const title = parts[0];
      const content = parts.slice(1).join('\n\n');
      
      // Format with HTML
      const formattedContent = content
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      container.innerHTML = `
        <h3 class="story-title">${title}</h3>
        <div style="line-height: 1.8; font-size: 16px;">
          <p>${formattedContent}</p>
        </div>
      `;
    }

    function enableActionButtons() {
      document.getElementById('copyBtn').disabled = false;
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('regenBtn').disabled = false;
      document.getElementById('improveBtn').disabled = false;
    }

    // ===== ACTION FUNCTIONS =====
    function copyStory() {
      if (!generatedStoryContent) return;
      
      navigator.clipboard.writeText(generatedStoryContent).then(() => {
        alert('ğŸ“‹ ÄÃ£ sao chÃ©p truyá»‡n vÃ o clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('âŒ KhÃ´ng thá»ƒ sao chÃ©p. Vui lÃ²ng thá»­ láº¡i!');
      });
    }

    function saveStoryToDrive() {
      if (!generatedStoryContent) return;
      
      const fileName = `Generated_Story_${new Date().toISOString().slice(0, 10)}.txt`;
      const fileContent = generatedStoryContent;
      
      const metadata = {
        name: fileName,
        mimeType: "text/plain"
      };

      const accessToken = gapi.client.getToken().access_token;
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([fileContent], { type: "text/plain" }));

      fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
      }).then(res => res.json()).then(val => {
        alert(`ğŸ’¾ ÄÃ£ lÆ°u truyá»‡n lÃªn Google Drive: ${fileName}`);
      }).catch(err => {
        console.error("Save error:", err);
        alert("âŒ Lá»—i khi lÆ°u truyá»‡n: " + err.message);
      });
    }

    function improveStory() {
      if (!generatedStoryContent || !storyAI) {
        alert('ChÆ°a cÃ³ truyá»‡n Ä‘á»ƒ cáº£i thiá»‡n!');
        return;
      }
      
      const improvements = storyAI.getImprovementSuggestions();
      const improvement = improvements[Math.floor(Math.random() * improvements.length)];
      
      const improveBtn = document.getElementById('improveBtn');
      improveBtn.innerHTML = `âœ¨ Äang ${improvement.toLowerCase()}...`;
      improveBtn.disabled = true;
      
      // Simulate improvement process
      setTimeout(() => {
        // Here you could implement actual story improvement logic
        alert(`âœ… ÄÃ£ ${improvement.toLowerCase()} cho truyá»‡n!`);
        improveBtn.innerHTML = 'âœ¨ Cáº£i Thiá»‡n';
        improveBtn.disabled = false;
        
        // Update learning data with improvement
        if (storyAI) {
          storyAI.patterns.improvedVersions.push({
            original: generatedStoryContent.substring(0, 100),
            improvement: improvement,
            timestamp: new Date().toISOString()
          });
          storyAI.saveLearningData();
        }
      }, 2000);
    }

    function regenerateStory() {
      if (confirm('ğŸ”„ Báº¡n cÃ³ muá»‘n táº¡o láº¡i truyá»‡n vá»›i phiÃªn báº£n cáº£i tiáº¿n?')) {
        generateIntelligentStory();
      }
    }

    // ===== UI NAVIGATION =====
    function switchTab(id) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      
      document.getElementById(id).classList.add('active');
      event.target.classList.add('active');
      
      // Update AI status when switching to generator tab
      if (id === 'tab-generator') {
        updateAIStatus();
        setupTemplateSelector();
      }
    }

    function setupTemplateSelector() {
      document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
          // Remove previous selection
          document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
          // Add selection to clicked card
          this.classList.add('selected');
          selectedTemplate = this.dataset.template;
        });
      });
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // Try to load cached analysis on page load
      const hasLocalData = loadAnalysisLocal();
      
      // Initialize template selector
      setupTemplateSelector();
      
      // Set default template
      selectedTemplate = 'family_drama';
      
      // Update AI status
      updateAIStatus();
      
      console.log('Enhanced Story System initialized');
      console.log(`Local data loaded: ${hasLocalData}`);
      console.log(`Analysis data count: ${analysisData.length}`);
    });
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
