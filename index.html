<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Phân tích và Sáng tác Truyện</title>
    <style>
        :root {
            --primary-color: #3a506b;
            --secondary-color: #1c2541;
            --accent-color: #5d7592;
            --background-color: #f8f9fa;
            --text-color: #333;
            --light-text: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 1rem;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .upload-section, .analysis-section, .creation-section, .learning-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: var(--secondary-color);
        }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .analysis-result, .generated-story {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            white-space: pre-wrap;
        }
        
        .character-grid, .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .character-card, .theme-card {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--primary-color);
            color: var(--light-text);
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>Công cụ Phân tích và Sáng tác Truyện</h1>
    </header>
    
    <div class="container">
        <section class="upload-section">
            <h2>Tải lên dữ liệu truyện</h2>
            <textarea id="storyData" rows="10" placeholder="Dán nội dung truyện vào đây..."></textarea>
            <button id="analyzeBtn">Phân tích truyện</button>
        </section>
        
        <section id="analysisSection" class="analysis-section hidden">
            <h2>Kết quả phân tích</h2>
            <div class="analysis-result" id="analysisResult">
                <!-- Kết quả phân tích sẽ được hiển thị ở đây -->
            </div>
            
            <h3>Nhân vật chính</h3>
            <div class="character-grid" id="characterGrid">
                <!-- Thẻ nhân vật sẽ được thêm ở đây -->
            </div>
            
            <h3>Chủ đề và cảm xúc</h3>
            <div class="theme-grid" id="themeGrid">
                <!-- Thẻ chủ đề sẽ được thêm ở đây -->
            </div>
        </section>
        
        <section id="creationSection" class="creation-section hidden">
            <h2>Tạo truyện mới</h2>
            <input type="text" id="storyTitle" placeholder="Tiêu đề truyện">
            <textarea id="storyPrompt" rows="5" placeholder="Mô tả ý tưởng truyện hoặc để trống để tạo ngẫu nhiên"></textarea>
            <button id="generateBtn">Tạo truyện</button>
            
            <div class="generated-story hidden" id="generatedStory">
                <!-- Truyện được tạo sẽ hiển thị ở đây -->
            </div>
        </section>
        
        <section id="learningSection" class="learning-section hidden">
            <h2>Học từ truyện đã tạo</h2>
            <p>Hệ thống sẽ tự động học từ những truyện bạn đã tạo để cải thiện chất lượng trong tương lai.</p>
            <div id="learningStatus"></div>
        </section>
    </div>
    
    <footer>
        <p>Công cụ Phân tích và Sáng tác Truyện &copy; 2023</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const generateBtn = document.getElementById('generateBtn');
            const storyData = document.getElementById('storyData');
            const analysisSection = document.getElementById('analysisSection');
            const analysisResult = document.getElementById('analysisResult');
            const characterGrid = document.getElementById('characterGrid');
            const themeGrid = document.getElementById('themeGrid');
            const creationSection = document.getElementById('creationSection');
            const generatedStory = document.getElementById('generatedStory');
            const learningSection = document.getElementById('learningSection');
            const learningStatus = document.getElementById('learningStatus');
            
            // Lưu trữ dữ liệu đã phân tích và học
            let analyzedData = {
                characters: [],
                themes: [],
                emotions: [],
                plotPoints: []
            };
            
            let generatedStories = JSON.parse(localStorage.getItem('generatedStories')) || [];
            
            // Xử lý sự kiện phân tích
            analyzeBtn.addEventListener('click', function() {
                const text = storyData.value;
                if (text.trim() === '') {
                    alert('Vui lòng nhập nội dung truyện để phân tích');
                    return;
                }
                
                // Phân tích văn bản
                analyzeText(text);
                
                // Hiển thị phần phân tích
                analysisSection.classList.remove('hidden');
                creationSection.classList.remove('hidden');
                learningSection.classList.remove('hidden');
            });
            
            // Xử lý sự kiện tạo truyện
            generateBtn.addEventListener('click', function() {
                const title = document.getElementById('storyTitle').value || 'Truyện không tiêu đề';
                const prompt = document.getElementById('storyPrompt').value;
                
                // Tạo truyện mới dựa trên dữ liệu đã phân tích
                const newStory = generateStory(title, prompt);
                
                // Hiển thị truyện đã tạo
                generatedStory.textContent = newStory;
                generatedStory.classList.remove('hidden');
                
                // Lưu truyện đã tạo
                generatedStories.push({
                    title: title,
                    content: newStory,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem('generatedStories', JSON.stringify(generatedStories));
                
                // Cập nhật hệ thống học
                updateLearningSystem();
            });
            
            // Hàm phân tích văn bản
            function analyzeText(text) {
                // Phân tích nhân vật (đơn giản - tìm tên riêng)
                const characterRegex = /(\b[A-Z][a-z]+ [A-Z][a-z]+\b|\b[A-Z][a-z]+\b)/g;
                const characterMatches = text.match(characterRegex) || [];
                
                // Lọc và đếm tần suất xuất hiện
                const characterCounts = {};
                characterMatches.forEach(char => {
                    // Bỏ qua các từ có thể không phải tên riêng
                    const commonWords = ['ông', 'bà', 'anh', 'chị', 'em', 'tôi', 'nàng', 'cha', 'con'];
                    if (!commonWords.includes(char.toLowerCase())) {
                        characterCounts[char] = (characterCounts[char] || 0) + 1;
                    }
                });
                
                // Sắp xếp theo tần suất
                analyzedData.characters = Object.entries(characterCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10) // Lấy 10 nhân vật xuất hiện nhiều nhất
                    .map(([name, count]) => ({ name, count }));
                
                // Phân tích chủ đề (đơn giản - tìm từ khóa)
                const themes = ['tình yêu', 'gia đình', 'dục vọng', 'loạn luân', 'lừa dối', 'hối hận', 'kế hoạch', 'ghen tuông'];
                analyzedData.themes = themes.map(theme => {
                    const regex = new RegExp(theme, 'gi');
                    const matches = text.match(regex);
                    return {
                        theme,
                        count: matches ? matches.length : 0
                    };
                }).filter(item => item.count > 0);
                
                // Phân tích cảm xúc (đơn giản)
                const emotions = ['vui mừng', 'tức giận', 'buồn bã', 'sợ hãi', 'kinh ngạc', 'ghê tởm', 'hồi hộp', 'ghen tị'];
                analyzedData.emotions = emotions.map(emotion => {
                    const regex = new RegExp(emotion, 'gi');
                    const matches = text.match(regex);
                    return {
                        emotion,
                        count: matches ? matches.length : 0
                    };
                }).filter(item => item.count > 0);
                
                // Trích xuất các điểm cốt truyện quan trọng (đơn giản - câu có độ dài trên trung bình)
                const sentences = text.split(/[.!?]+/).filter(s => s.length > 0);
                analyzedData.plotPoints = sentences
                    .filter(s => s.split(' ').length > 10) // Câu có hơn 10 từ
                    .slice(0, 5) // Lấy 5 câu
                    .map(s => s.trim());
                
                // Hiển thị kết quả phân tích
                displayAnalysisResults();
            }
            
            // Hiển thị kết quả phân tích
            function displayAnalysisResults() {
                // Hiển thị tổng quan
                analysisResult.innerHTML = `
                    Đã phân tích thành công!
                    - Tìm thấy ${analyzedData.characters.length} nhân vật chính
                    - Xác định ${analyzedData.themes.length} chủ đề
                    - Nhận diện ${analyzedData.emotions.length} loại cảm xúc
                    - Trích xuất ${analyzedData.plotPoints.length} điểm cốt truyện quan trọng
                `;
                
                // Hiển thị nhân vật
                characterGrid.innerHTML = '';
                analyzedData.characters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    card.innerHTML = `<strong>${char.name}</strong> (xuất hiện ${char.count} lần)`;
                    characterGrid.appendChild(card);
                });
                
                // Hiển thị chủ đề
                themeGrid.innerHTML = '';
                analyzedData.themes.forEach(theme => {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    card.innerHTML = `<strong>${theme.theme}</strong> (xuất hiện ${theme.count} lần)`;
                    themeGrid.appendChild(card);
                });
                
                // Hiển thị cảm xúc
                analyzedData.emotions.forEach(emotion => {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    card.innerHTML = `<strong>${emotion.emotion}</strong> (xuất hiện ${emotion.count} lần)`;
                    themeGrid.appendChild(card);
                });
            }
            
            // Hàm tạo truyện mới
            function generateStory(title, prompt) {
                // Lấy ngẫu nhiên một số nhân vật
                const mainCharacters = analyzedData.characters
                    .slice(0, 3)
                    .map(c => c.name)
                    .join(', ');
                
                // Lấy ngẫu nhiên một số chủ đề
                const mainThemes = analyzedData.themes
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 2)
                    .map(t => t.theme)
                    .join(', ');
                
                // Lấy ngẫu nhiên một điểm cốt truyện
                const randomPlotPoint = analyzedData.plotPoints.length > 0 
                    ? analyzedData.plotPoints[Math.floor(Math.random() * analyzedData.plotPoints.length)]
                    : '';
                
                // Tạo truyện dựa trên dữ liệu đã phân tích
                let story = `Tiêu đề: ${title}\n\n`;
                
                if (prompt) {
                    story += `Dựa trên gợi ý: ${prompt}\n\n`;
                }
                
                story += `Truyện xoay quanh ${mainCharacters} với các chủ đề ${mainThemes}.\n\n`;
                
                story += `Mở đầu: ${randomPlotPoint}\n\n`;
                
                // Thêm nội dung dựa trên các truyện đã tạo trước đó (học máy đơn giản)
                if (generatedStories.length > 0) {
                    const lastStory = generatedStories[generatedStories.length - 1];
                    story += `Phát triển: ${lastStory.content.substring(0, 200)}...\n\n`;
                } else {
                    story += "Phát triển: Câu chuyện dần hé lộ những bí mật không ngờ, làm thay đổi mối quan hệ giữa các nhân vật.\n\n";
                }
                
                story += "Kết thúc: Mọi chuyện dần sáng tỏ, để lại những bài sâu sắc về cuộc sống và con người.";
                
                return story;
            }
            
            // Cập nhật hệ thống học
            function updateLearningSystem() {
                learningStatus.textContent = `Hệ thống đã học từ ${generatedStories.length} truyện được tạo. Chất lượng sẽ được cải thiện sau mỗi lần tạo.`;
                
                // Ở phiên bản nâng cao, đây sẽ là nơi cập nhật mô hình học máy
                // Ví dụ: lưu các từ khóa thường được sử dụng, cấu trúc câu, v.v.
            }
            
            // Khởi tạo nếu đã có dữ liệu trước đó
            if (generatedStories.length > 0) {
                learningSection.classList.remove('hidden');
                updateLearningSystem();
            }
        });
    </script>
</body>
</html>
