<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Truyện với Google Drive</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, textarea, button { display: block; margin: 10px 0; width: 100%; }
    #history { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h2>📚 Nhập truyện</h2>
  <button id="loginBtn" disabled>🔑 Đăng nhập Google</button>

  <input type="text" id="storyName" placeholder="Tên truyện">
  <input type="text" id="chapterName" placeholder="Tên chương">
  <textarea id="chapterContent" placeholder="Nội dung chương..."></textarea>
  <button onclick="saveChapter()">💾 Lưu chương</button>

  <h3>📖 Lịch sử truyện</h3>
  <div id="history"></div>

  <script>
    const CLIENT_ID = "199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // Load gapi
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      });
      gapiInited = true;
      maybeEnableLogin();
    }

    // Load GIS
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // gán sau
      });
      gisInited = true;
      maybeEnableLogin();
    }

    function maybeEnableLogin() {
      if (gapiInited && gisInited) {
        document.getElementById("loginBtn").disabled = false;
      }
    }

    document.getElementById("loginBtn").onclick = () => {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          console.error(resp);
          return;
        }
        alert("✅ Đăng nhập thành công!");
        await loadHistory();
      };

      if (gapi.client.getToken() === null) {
        // yêu cầu consent khi login lần đầu
        tokenClient.requestAccessToken({ prompt: "consent" });
      } else {
        // lấy token lại nếu đã login
        tokenClient.requestAccessToken({ prompt: "" });
      }
    };

    // === Tạo thư mục nếu chưa có ===
    async function createFolderIfNotExist(folderName) {
      let res = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: "files(id, name)"
      });
      if (res.result.files.length > 0) return res.result.files[0].id;

      let folder = await gapi.client.drive.files.create({
        resource: { name: folderName, mimeType: 'application/vnd.google-apps.folder' },
        fields: 'id'
      });
      return folder.result.id;
    }

    // === Lưu chương ===
    async function saveChapter() {
      let storyName = document.getElementById("storyName").value;
      let chapterName = document.getElementById("chapterName").value;
      let content = document.getElementById("chapterContent").value;

      if (!storyName || !chapterName || !content) {
        alert("⚠️ Vui lòng nhập đầy đủ thông tin!");
        return;
      }

      let folderId = await createFolderIfNotExist(storyName);

      const fileMetadata = { name: chapterName + ".txt", parents: [folderId] };
      const media = new Blob([content], { type: 'text/plain' });
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
      form.append('file', media);

      await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + gapi.client.getToken().access_token }),
        body: form
      });

      alert("✅ Đã lưu chương!");
      loadHistory();
    }

    // === Lịch sử truyện ===
    async function loadHistory() {
      let res = await gapi.client.drive.files.list({
        q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
        fields: "files(id, name)"
      });

      let historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "";

      res.result.files.forEach(folder => {
        let btn = document.createElement("button");
        btn.textContent = folder.name;
        btn.onclick = () => loadChapters(folder.id, folder.name);
        historyDiv.appendChild(btn);
      });
    }

    async function loadChapters(folderId, storyName) {
      let res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: "files(id, name)"
      });

      let historyDiv = document.getElementById("history");
      historyDiv.innerHTML = `<h4>${storyName}</h4>`;
      res.result.files.forEach(file => {
        let p = document.createElement("p");
        p.textContent = file.name;
        historyDiv.appendChild(p);
      });
    }

    gapiLoaded();
    window.gisLoaded = gisLoaded;
  </script>
</body>
</html>
