<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        .nav-menu button.active {
            background: linear-gradient(45deg, #ff9500, #ff7300);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Thêm style cho cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Ẩn nội dung nhạy cảm mặc định */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
        
        .training-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .training-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .training-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .training-item .count {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager Pro</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chủ đề chuyên biệt nâng cấp</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active" data-section="trainingSection">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success" data-section="generationSection">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn" data-section="managementSection">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn" data-section="historySection">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI Nâng Cao</h2>
                        <div class="training-details">
                            <div class="training-item">
                                <h4>📝 Tổng số file</h4>
                                <div class="count" id="totalFiles">0</div>
                            </div>
                            <div class="training-item">
                                <h4>✅ Đã huấn luyện</h4>
                                <div class="count" id="trainedFiles">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📖 Từ vựng học được</h4>
                                <div class="count" id="vocabularyCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>💬 Hội thoại</h4>
                                <div class="count" id="dialogueCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🏠 Bối cảnh</h4>
                                <div class="count" id="contextCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>👤 Chi tiết nhân vật</h4>
                                <div class="count" id="characterCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>❤️ Cảm xúc</h4>
                                <div class="count" id="emotionCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🔥 Nội dung 18+</h4>
                                <div class="count" id="adultCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>⏰ Thời gian</h4>
                                <div class="count" id="timeCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📍 Địa điểm</h4>
                                <div class="count" id="locationCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>📜 Cấu trúc câu</h4>
                                <div class="count" id="sentenceCount">0</div>
                            </div>
                            <div class="training-item">
                                <h4>🎭 Tình tiết</h4>
                                <div class="count" id="plotCount">0</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động</h2>
                        
                        <div class="adult-warning">
                            ⚠️ Cảnh báo: AI sẽ tạo nội dung theo ngôi thứ nhất và có thể chứa nội dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (50-200)" min="50" max="200" value="50">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">Nội dung:</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
                <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
                <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
                <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    dialogues: new Set(),
    contexts: new Set(),
    characterDetails: new Set(),
    emotions: new Set(),
    adultContent: new Set(),
    timeReferences: new Set(),
    locations: new Set(),
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    characterNames: new Set(),
    environmentDetails: new Set(),
    transitionWords: new Set(),
    generationHistory: []
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// Từ khóa và patterns mở rộng
const advancedPatterns = {
    dialoguePatterns: [
        '"[^"]*"', '"[^"]*"', '"[^"]*"', '- [A-Z][^.!?]*[.!?]'
    ],
    contextPatterns: [
        '(trong|ở|tại|khi|lúc|vào|giữa|trên|dưới|bên|cạnh|gần|xa|trước|sau) (.*?) (,|\\.)',
        '(buổi|ngày|đêm|sáng|chiều|tối|khuya) (.*?) (,|\\.)',
        '(phòng|nhà|vườn|sân|ban công|cầu thang|bếp|khách|ngủ) (.*?) (,|\\.)'
    ],
    characterPatterns: [
        '(anh|chị|em|cô|chú|bác|ông|bà) (.*?) (có|là|thường|đang)',
        '(người|con|cô) (.*?) (tuổi|tên|họ)',
        '(mắt|tóc|da|mặt|dáng) (.*?) (của|khiến)',
        '(cao|thấp|gầy|béo|đẹp|xấu|trắng|đen|dài|ngắn) (.*?) (,|\\.)'
    ],
    emotionPatterns: [
        '(cảm thấy|nhận ra|nghĩ rằng|tin rằng) (.*?) (khi|vì|do)',
        '(vui|buồn|giận|lo|sợ|hạnh phúc|đau khổ|thất vọng) (.*?) (,|\\.)',
        '(tim đập|run rẩy|nóng bừng|lạnh toát|căng thẳng) (.*?) (,|\\.)',
        '(yêu|thích|ghét|sợ|lo) (.*?) (một cách|rất|quá)'
    ],
    adultPatterns: [
        '(cơ thể|thân thể|da thịt|vòng|ngực|mông|đùi) (.*?) (,|\\.)',
        '(ôm|hôn|vuốt|chạm|sờ|nắm) (.*?) (nhẹ|mạnh|dịu dàng)',
        '(khao khát|thèm muốn|ham muốn|dục vọng|kích thích) (.*?) (,|\\.)',
        '(nóng bỏng|ướt át|căng cứng|mềm mại|nảy nở) (.*?) (,|\\.)'
    ],
    timePatterns: [
        '(hôm nay|hôm qua|mai|ngày|tuần|tháng|năm) (.*?) (,|\\.)',
        '(sáng|trưa|chiều|tối|đêm|khuya) (.*?) (,|\\.)',
        '(khi|lúc|sau khi|trước khi|trong khi) (.*?) (,|\\.)',
        '(bỗng nhiên|đột ngột|từ từ|nhanh chóng) (.*?) (,|\\.)'
    ],
    locationPatterns: [
        '(trong|ngoài|trên|dưới|bên|cạnh) (nhà|phòng|giường|bàn|ghế) (.*?) (,|\\.)',
        '(ở|tại|về|đến|từ) (.*?) (,|\\.)',
        '(công viên|trường học|siêu thị|bệnh viện|nhà hàng) (.*?) (,|\\.)',
        '(đường|phố|ngõ|hẻm|cầu|chợ) (.*?) (,|\\.)'
    ]
};

// Kho từ vựng chuyên sâu
const vocabularyBank = {
    characterNames: {
        male: ['Minh', 'Đức', 'Hùng', 'Nam', 'Tuấn', 'Bình', 'Thành', 'Hoàng', 'Quang', 'Khoa'],
        female: ['Linh', 'Hương', 'Mai', 'Lan', 'Hoa', 'Thủy', 'Nga', 'Trang', 'Nhung', 'Yến'],
        relationship: ['bố chồng', 'con dâu', 'chồng', 'vợ', 'anh', 'chị', 'em']
    },
    emotions: {
        positive: ['vui mừng', 'hạnh phúc', 'phấn khích', 'thỏa mãn', 'yên bình', 'ấm áp'],
        negative: ['buồn bã', 'lo lắng', 'căng thẳng', 'bối rối', 'tội lỗi', 'xấu hổ'],
        intense: ['khao khát', 'thèm muốn', 'kích thích', 'dục vọng', 'ham muốn', 'say đắm'],
        complex: ['mâu thuẫn nội tâm', 'giằng xé', 'phức tạp', 'khó hiểu', 'bất an', 'hoang mang']
    },
    physicalDescriptions: {
        appearance: ['đôi mắt', 'nụ cười', 'mái tóc', 'làn da', 'đôi môi', 'cánh mũi'],
        body: ['cơ thể', 'vóc dáng', 'đường cong', 'vòng eo', 'vai', 'lưng', 'chân tay'],
        clothing: ['váy', 'áo', 'quần', 'đầm', 'áo dài', 'bikini', 'đồ ngủ', 'đồ lót'],
        adult: ['vòng một', 'vòng ba', 'ngực', 'mông', 'đùi', 'bụng', 'cổ', 'vai trần']
    },
    settings: {
        timeOfDay: ['sáng sớm', 'buổi trưa', 'chiều tà', 'đêm khuya', 'lúc hoàng hôn', 'ban đêm'],
        locations: ['phòng khách', 'phòng ngủ', 'nhà bếp', 'phòng tắm', 'ban công', 'sân vườn', 'cầu thang'],
        atmosphere: ['yên tĩnh', 'ấm cúng', 'lãng mạn', 'căng thẳng', 'bí mật', 'riêng tư', 'thân mật']
    },
    actions: {
        gentle: ['vuốt ve', 'simhầm thí', 'ôm ấp', 'nắm tay', 'chạm nhẹ', 'hôn trán'],
        intense: ['ôm chặt', 'hôn nồng cháy', 'ép sát', 'kéo lại gần', 'nắm chặt', 'đè lên'],
        emotional: ['khóc', 'cười', 'thở dài', 'run rẩy', 'đỏ mặt', 'cúi đầu', 'nhìn trộm']
    }
};

// Template câu nâng cao
const advancedTemplates = {
    observation: [
        "Tôi để ý thấy {character} {action} một cách {manner}, điều này khiến tôi {emotion}.",
        "Khi {situation}, tôi nhận ra {character} có {characteristic}, và cảm giác {feeling} dâng trào trong lòng.",
        "Không thể không chú ý đến {physicalDetail} của {character}, đặc biệt khi {context}.",
        "Cách {character} {behavior} khiến tôi {emotionalResponse}, như thể {metaphor}."
    ],
    innerThought: [
        "Trong tâm trí tôi, {thought} về {subject}, khiến tôi {emotionalState}.",
        "Tôi tự hỏi liệu {question}, hay đây chỉ là {assumption} của tôi.",
        "Cảm giác {emotion} cứ ám ảnh tôi mỗi khi {trigger}.",
        "Tôi không thể ngừng suy nghĩ về {observation}, và {consequence} ngày càng rõ ràng."
    ],
    dialogue: [
        '"{character} nói với giọng {tone}: "{speech}"',
        '"Tôi thầm nghĩ: "{innerSpeech}" nhưng miệng chỉ nói: "{outerSpeech}"',
        '"{character} thì thầm: "{whisper}" khiến tôi {reaction}"'
    ],
    adult: [
        "Cảm giác {sensation} lan tỏa khắp cơ thể khi {situation}, khiến tôi {response}.",
        "Tôi không thể rời mắt khỏi {bodyPart} của {character}, đặc biệt khi {context}.",
        "Mỗi lần {intimateAction}, cơ thể tôi lại {physicalReaction} một cách {intensity}.",
        "Không gian giữa chúng tôi tràn ngập {atmosphere}, khiến {sensoryDetail} trở nên {adjective}."
    ],
    transition: [
        "Thời gian trôi qua, và tôi {change}.",
        "Những ngày sau đó, {development}.",
        "Từ đó trở đi, {newReality}.",
        "Cuối cùng, tôi {conclusion}."
    ]
};

// Initialize Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}

function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}

function maybeEnableButtons() { 
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'inline-block'; 
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { 
            showStatus('Lỗi đăng nhập: ' + resp.error, 'error'); 
            return; 
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '✅ Đã đăng nhập thành công!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { 
        google.accounts.oauth2.revoke(token.access_token); 
        gapi.client.setToken(''); 
    }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}

async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    await loadAiKnowledge();
    updateAiStats();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Khởi tạo ứng dụng thành công!', 'success');
    showLoading(false);
}

async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) {
        mainFolderId = response.result.files[0].id;
    } else {
        const folder = await gapi.client.drive.files.create({ 
            resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, 
            fields: 'id' 
        });
        mainFolderId = folder.result.id;
    }
}

async function createStoryFolder(storyTitle) {
    const folder = await gapi.client.drive.files.create({
        resource: { 
            name: storyTitle, 
            mimeType: 'application/vnd.google-apps.folder', 
            parents: [mainFolderId] 
        }, 
        fields: 'id'
    });
    return folder.result.id;
}

async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId) {
    const fileMetadata = { 
        name: `${chapterTitle}.txt`, 
        parents: [storyFolderId]
    };
    
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', 
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}

async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    const folders = response.result.files; 
    storyHistory = [];
    
    for (let folder of folders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime)'
        });
        storyHistory.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files
        });
    }
    displayHistory(); 
    displayFolders();
}

// HÀM HUẤN LUYỆN AI NÂNG CAO
async function trainAI() {
    showLoading(true);
    showStatus('Đang bắt đầu huấn luyện AI với phân tích chuyên sâu...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            await advancedContentAnalysis(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    await saveAiKnowledge();
    showLoading(false);
    showStatus(`Huấn luyện hoàn thành! Đã phân tích ${processedFiles} file với AI học sâu.`, 'success');
}

// HÀM PHÂN TÍCH NỘI DUNG NÂNG CAO
async function advancedContentAnalysis(content, storyTitle, fileName) {
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 5);
    const words = content.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    
    // 1. Học từ vựng cơ bản
    words.forEach(word => {
        const cleanWord = word.replace(/[^\wàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/g, '');
        if (cleanWord.length > 2) {
            aiKnowledge.vocabulary.add(cleanWord);
        }
    });
    
    // 2. Phân tích và học hội thoại
    analyzeDialogues(content);
    
    // 3. Phân tích bối cảnh và địa điểm
    analyzeContextsAndLocations(content);
    
    // 4. Phân tích chi tiết nhân vật
    analyzeCharacterDetails(content);
    
    // 5. Phân tích cảm xúc
    analyzeEmotions(content);
    
    // 6. Phân tích nội dung 18+
    analyzeAdultContent(content);
    
    // 7. Phân tích thời gian
    analyzeTimeReferences(content);
    
    // 8. Học cấu trúc câu
    sentences.forEach(sentence => {
        if (sentence.split(' ').length > 10) {
            aiKnowledge.sentenceStructures.add(sentence.trim());
        }
    });
    
    // 9. Phân tích tình tiết
    analyzePlotPoints(content);
    
    // 10. Lưu story để học
    aiKnowledge.stories.push({
        content: content,
        storyTitle: storyTitle,
        fileName: fileName,
        analysisTimestamp: new Date().toISOString()
    });
}

function analyzeDialogues(content) {
    // Tìm các đoạn hội thoại với nhiều pattern khác nhau
    const dialoguePatterns = [
        /"([^"]{10,})"/g,
        /"([^"]{10,})"/g,
        /"([^"]{10,})"/g,
        /- ([A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ][^.!?]{10,}[.!?])/g
    ];
    
    dialoguePatterns.forEach(pattern => {
        let match;
        while ((match = pattern.exec(content)) !== null) {
            const dialogue = match[1].trim();
            if (dialogue.length > 10 && !dialogue.includes('{')) {
                aiKnowledge.dialogues.add(dialogue);
            }
        }
    });
}

function analyzeContextsAndLocations(content) {
    const contextKeywords = [
        'trong phòng', 'ở nhà', 'tại', 'khi', 'lúc', 'vào lúc', 'buổi', 'ngày', 'đêm',
        'phòng khách', 'phòng ngủ', 'nhà bếp', 'phòng tắm', 'ban công', 'sân vườn',
        'trên giường', 'dưới bàn', 'bên cạnh', 'gần', 'xa', 'trước', 'sau'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        contextKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const context = sentence.trim();
                if (context.length > 20 && context.length < 200) {
                    aiKnowledge.contexts.add(context);
                }
            }
        });
        
        // Tìm địa điểm cụ thể
        const locationMatch = sentence.match(/(trong|ở|tại|đến|về) ([^,.\s]{2,})/gi);
        if (locationMatch) {
            locationMatch.forEach(loc => {
                aiKnowledge.locations.add(loc.trim());
            });
        }
    });
}

function analyzeCharacterDetails(content) {
    const characterKeywords = [
        'mắt', 'tóc', 'da', 'mặt', 'dáng', 'cao', 'thấp', 'gầy', 'béo', 'đẹp', 'xấu',
        'cô ấy', 'anh ấy', 'chị', 'em', 'bác', 'chú', 'cô', 'người', 'con',
        'bố chồng', 'con dâu', 'vợ tôi', 'chồng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        characterKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const detail = sentence.trim();
                if (detail.length > 15 && detail.length < 150) {
                    aiKnowledge.characterDetails.add(detail);
                }
            }
        });
        
        // Tìm tên nhân vật
        const nameMatch = sentence.match(/\b[A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ][a-zàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]{2,}\b/g);
        if (nameMatch) {
            nameMatch.forEach(name => {
                if (!['Tôi', 'Anh', 'Chị', 'Em', 'Bác', 'Chú', 'Cô'].includes(name)) {
                    aiKnowledge.characterNames.add(name);
                }
            });
        }
    });
}

function analyzeEmotions(content) {
    const emotionKeywords = [
        'cảm thấy', 'cảm giác', 'cảm xúc', 'tâm trí', 'tâm lý', 'lòng',
        'vui', 'buồn', 'giận', 'lo', 'sợ', 'hạnh phúc', 'đau khổ', 'thất vọng',
        'yêu', 'thích', 'ghét', 'căng thẳng', 'bối rối', 'xấu hổ', 'tội lỗi',
        'khao khát', 'thèm muốn', 'ham muốn', 'kích thích', 'dục vọng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        emotionKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const emotion = sentence.trim();
                if (emotion.length > 10 && emotion.length < 200) {
                    aiKnowledge.emotions.add(emotion);
                }
            }
        });
    });
}

function analyzeAdultContent(content) {
    const adultKeywords = [
        'cơ thể', 'thân thể', 'da thịt', 'vòng', 'ngực', 'mông', 'đùi',
        'ôm', 'hôn', 'vuốt', 'chạm', 'sờ', 'nắm',
        'khao khát', 'thèm muốn', 'ham muốn', 'dục vọng', 'kích thích',
        'nóng bỏng', 'ướt át', 'căng cứng', 'mềm mại', 'quyến rũ',
        'làm tình', 'quan hệ', 'yêu đương', 'ân ái'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        adultKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const adultSentence = sentence.trim();
                if (adultSentence.length > 15 && adultSentence.length < 250) {
                    aiKnowledge.adultContent.add(adultSentence);
                }
            }
        });
    });
}

function analyzeTimeReferences(content) {
    const timeKeywords = [
        'hôm nay', 'hôm qua', 'mai', 'ngày', 'tuần', 'tháng', 'năm',
        'sáng', 'trưa', 'chiều', 'tối', 'đêm', 'khuya',
        'khi', 'lúc', 'sau khi', 'trước khi', 'trong khi',
        'bỗng nhiên', 'đột ngột', 'từ từ', 'nhanh chóng'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        timeKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const timeRef = sentence.trim();
                if (timeRef.length > 10 && timeRef.length < 150) {
                    aiKnowledge.timeReferences.add(timeRef);
                }
            }
        });
    });
}

function analyzePlotPoints(content) {
    const plotKeywords = [
        'bỗng nhiên', 'đột ngột', 'sau đó', 'cuối cùng', 'kết quả',
        'phát hiện', 'nhận ra', 'hiểu ra', 'chợt', 'bất ngờ',
        'quyết định', 'dự định', 'kế hoạch', 'ý định'
    ];
    
    const sentences = content.split(/[.!?]+/);
    sentences.forEach(sentence => {
        plotKeywords.forEach(keyword => {
            if (sentence.toLowerCase().includes(keyword)) {
                const plot = sentence.trim();
                if (plot.length > 15 && plot.length < 200) {
                    aiKnowledge.plotPoints.add(plot);
                }
            }
        });
    });
}

// HÀM TẠO TRUYỆN AI NÂNG CAO
async function generateStory() {
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 50;
    if (chapterCount < 50 || chapterCount > 200) {
        showStatus('Số chương phải từ 50 đến 200!', 'error');
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI chưa được huấn luyện đủ! Hãy huấn luyện AI với ít nhất 100 từ vựng.', 'error');
        return;
    }
    
    showLoading(true);
    showStatus('AI đang tạo truyện với logic nâng cao...', 'success');
    
    // Tạo cốt truyện và nhân vật
    const storyContext = generateStoryContext();
    const title = generateIntelligentTitle();
    
    // Create folder for the new story
    const storyFolderId = await createStoryFolder(title);
    
    // Generate chapters with progressive storyline
    let generatedChapters = 0;
    const totalChapters = chapterCount;
    
    for (let i = 1; i <= totalChapters; i++) {
        const chapterTitle = `Chương ${i}: ${generateChapterTitle(i, totalChapters, storyContext)}`;
        const chapterContent = generateAdvancedChapterContent(i, totalChapters, storyContext);
        
        // Save chapter to Google Drive
        await saveStoryContent(title, chapterTitle, chapterContent, storyFolderId);
        
        generatedChapters++;
        
        // Update progress
        const progress = (generatedChapters / totalChapters) * 100;
        document.getElementById('generationProgressFill').style.width = progress + '%';
        document.getElementById('generationStatus').innerHTML = 
            `<div class="status success">Đang tạo chương ${generatedChapters}/${totalChapters}: ${chapterTitle}</div>`;
        
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // Reload stories and learn from generated content
    await loadStoryHistory();
    await learnFromGeneratedContent(title, totalChapters);
    
    showLoading(false);
    showStatus(`Đã tạo thành công truyện "${title}" với ${totalChapters} chương!`, 'success');
    document.getElementById('generationStatus').innerHTML = '';
}

// HÀM TẠO BỐI CẢNH TRUYỆN
function generateStoryContext() {
    const mainCharacters = {
        protagonist: getRandomFromSet(aiKnowledge.characterNames) || 'Minh',
        spouse: getRandomFromSet(aiKnowledge.characterNames) || 'Linh', 
        parentInLaw: getRandomFromSet(aiKnowledge.characterNames) || 'Hùng'
    };
    
    const setting = {
        primaryLocation: getRandomFromSet(aiKnowledge.locations) || 'trong nhà',
        timeOfDay: getRandomFromSet(aiKnowledge.timeReferences) || 'buổi tối',
        atmosphere: ['riêng tư', 'bí mật', 'thân mật', 'căng thẳng'][Math.floor(Math.random() * 4)]
    };
    
    const emotionalArc = {
        beginning: 'tò mò và quan sát',
        middle: 'nhận thức và xung đột nội tâm', 
        climax: 'khám phá và chấp nhận',
        ending: 'thấu hiểu và bình yên'
    };
    
    return { mainCharacters, setting, emotionalArc };
}

// HÀM TẠO TIÊU ĐỀ THÔNG MINH
function generateIntelligentTitle() {
    const titleTemplates = [
        "Những Điều Tôi Thầm Biết",
        "Bí Mật Trong Gia Đình", 
        "Góc Nhìn Của Người Chồng",
        "Quan Sát Trong Thầm Lặng",
        "Những Gì Tôi Không Nói Ra",
        "Ranh Giới Mờ Nhạt",
        "Câu Chuyện Chưa Kể",
        "Trong Sự Im Lặng",
        "Khám Phá Bản Thân",
        "Hành Trình Nội Tâm"
    ];
    
    return titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
}

// HÀM TẠO TIÊU ĐỀ CHƯƠNG
function generateChapterTitle(chapterNum, totalChapters, context) {
    const progress = chapterNum / totalChapters;
    
    if (progress < 0.2) {
        const beginningTitles = ["Khởi đầu quan sát", "Những dấu hiệu đầu tiên", "Sự tò mò bắt đầu", "Cảm giác lạ lùng"];
        return beginningTitles[Math.floor(Math.random() * beginningTitles.length)];
    } else if (progress < 0.5) {
        const developmentTitles = ["Nhận ra điều bất thường", "Quan sát kỹ hơn", "Những phát hiện mới", "Sự thay đổi"];
        return developmentTitles[Math.floor(Math.random() * developmentTitles.length)];
    } else if (progress < 0.8) {
        const climaxTitles = ["Xung đột nội tâm", "Khám phá sự thật", "Không thể phủ nhận", "Đối mặt với thực tế"];
        return climaxTitles[Math.floor(Math.random() * climaxTitles.length)];
    } else {
        const endingTitles = ["Sự thấu hiểu", "Chấp nhận thực tế", "Kết luận cuối cùng", "Bình yên tìm lại"];
        return endingTitles[Math.floor(Math.random() * endingTitles.length)];
    }
}

// HÀM TẠO NỘI DUNG CHƯƠNG NÂNG CAO
function generateAdvancedChapterContent(chapterNum, totalChapters, context) {
    const progress = chapterNum / totalChapters;
    let content = "";
    
    // Xác định giai đoạn cốt truyện
    let phase = 'beginning';
    if (progress > 0.25) phase = 'middle';
    if (progress > 0.65) phase = 'climax';
    if (progress > 0.85) phase = 'ending';
    
    // Tạo đoạn mở đầu
    content += generatePhaseIntroduction(phase, chapterNum, context) + "\n\n";
    
    // Tạo 3-5 đoạn văn chính
    const paragraphCount = 3 + Math.floor(Math.random() * 3);
    for (let i = 0; i < paragraphCount; i++) {
        content += generateIntelligentParagraph(phase, context, i, paragraphCount) + "\n\n";
    }
    
    // Thêm kết thúc chương
    content += generateChapterEnding(phase, context) + "\n";
    
    // Đảm bảo đủ độ dài (2500-4000 từ)
    while (content.split(/\s+/).length < 2500) {
        const additionalContent = generateAdditionalSmartContent(phase, context);
        content += additionalContent + "\n\n";
    }
    
    // Giới hạn tối đa 4000 từ
    const words = content.split(/\s+/);
    if (words.length > 4000) {
        content = words.slice(0, 4000).join(' ');
    }
    
    return content;
}

function generatePhaseIntroduction(phase, chapterNum, context) {
    const templates = {
        beginning: [
            `Hôm nay là ngày thứ ${chapterNum} kể từ khi tôi bắt đầu để ý đến những điều lạ lùng trong nhà.`,
            `Tôi không thể ngờ được rằng cuộc sống gia đình tôi lại có những bí mật như thế này.`,
            `Mọi thứ bắt đầu từ một cử chỉ nhỏ mà tôi tình cờ nhận ra.`
        ],
        middle: [
            `Càng quan sát, tôi càng thấy rõ hơn về mối quan hệ đặc biệt này.`,
            `Những nghi ngờ trong tôi ngày càng lớn dần theo thời gian.`,
            `Tôi bắt đầu hiểu tại sao mọi thứ trong nhà lại có những thay đổi tinh tế.`
        ],
        climax: [
            `Hôm nay, tôi không thể phủ nhận những gì đang diễn ra trước mắt mình.`,
            `Sự thật đã trở nên quá rõ ràng để tôi có thể bỏ qua.`,
            `Xung đột trong tâm trí tôi đạt đến điểm đỉnh.`
        ],
        ending: [
            `Cuối cùng, tôi cũng tìm được cách để hiểu và chấp nhận thực tế.`,
            `Nhìn lại chặng đường đã qua, tôi nhận ra nhiều điều về bản thân mình.`,
            `Giờ đây, tôi có thể nhìn nhận mọi thứ một cách bình tĩnh hơn.`
        ]
    };
    
    const phaseTemplates = templates[phase] || templates.beginning;
    return phaseTemplates[Math.floor(Math.random() * phaseTemplates.length)];
}

function generateIntelligentParagraph(phase, context, paragraphIndex, totalParagraphs) {
    let paragraph = "";
    
    // Tạo 4-6 câu cho mỗi đoạn
    const sentenceCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < sentenceCount; i++) {
        const sentenceType = determineSentenceType(phase, i, sentenceCount);
        paragraph += generateSmartSentence(sentenceType, context) + " ";
    }
    
    return paragraph.trim();
}

function determineSentenceType(phase, sentenceIndex, totalSentences) {
    const types = ['observation', 'innerThought', 'emotion', 'action', 'dialogue'];
    
    if (phase === 'climax' && Math.random() < 0.3) {
        types.push('adult');
    }
    
    return types[Math.floor(Math.random() * types.length)];
}

function generateSmartSentence(type, context) {
    const templates = advancedTemplates[type] || advancedTemplates.observation;
    let template = templates[Math.floor(Math.random() * templates.length)];
    
    // Thay thế placeholder bằng nội dung thực tế từ AI knowledge
    template = replaceSmartPlaceholders(template, context);
    
    return template;
}

function replaceSmartPlaceholders(text, context) {
    const replacements = {
        '{character}': context.mainCharacters.spouse,
        '{action}': getRandomFromSet(aiKnowledge.characterDetails) || 'cử động',
        '{manner}': ['nhẹ nhàng', 'dịu dàng', 'bí mật', 'thân mật', 'đặc biệt'][Math.floor(Math.random() * 5)],
        '{emotion}': getRandomFromArray(['bối rối', 'tò mò', 'lo lắng', 'kích thích', 'không yên']),
        '{situation}': getRandomFromSet(aiKnowledge.contexts) || 'khi ở nhà',
        '{characteristic}': getRandomFromSet(aiKnowledge.characterDetails) || 'điều đặc biệt',
        '{feeling}': getRandomFromSet(aiKnowledge.emotions) || 'cảm giác phức tạp',
        '{physicalDetail}': getRandomFromSet(aiKnowledge.characterDetails) || 'cách cử động',
        '{context}': getRandomFromSet(aiKnowledge.contexts) || 'trong những lúc riêng tư',
        '{behavior}': getRandomFromSet(aiKnowledge.characterDetails) || 'hành xử',
        '{emotionalResponse}': getRandomFromSet(aiKnowledge.emotions) || 'cảm xúc mạnh mẽ',
        '{metaphor}': ['như có điện chạy qua người', 'như bị thôi miên', 'như trong giấc mơ', 'như bị cuốn hút'][Math.floor(Math.random() * 4)],
        '{thought}': getRandomFromSet(aiKnowledge.emotions) || 'suy nghĩ',
        '{subject}': context.mainCharacters.spouse,
        '{emotionalState}': getRandomFromSet(aiKnowledge.emotions) || 'trạng thái phức tạp',
        '{question}': ['điều này có ý nghĩa gì', 'tôi có nên lo lắng', 'đây có phải điều bình thường', 'mọi thứ có đang thay đổi'][Math.floor(Math.random() * 4)],
        '{assumption}': ['sự tưởng tượng', 'hiểu lầm', 'suy đoán sai', 'nhận định thiếu căn cứ'][Math.floor(Math.random() * 4)],
        '{trigger}': getRandomFromSet(aiKnowledge.contexts) || 'những lúc nhất định',
        '{observation}': getRandomFromSet(aiKnowledge.characterDetails) || 'điều tôi quan sát',
        '{consequence}': ['sự thật', 'thực tế', 'bản chất vấn đề', 'điều ẩn giấu'][Math.floor(Math.random() * 4)],
        '{tone}': ['nhẹ nhàng', 'ấm áp', 'bí mật', 'thân mật', 'đặc biệt'][Math.floor(Math.random() * 5)],
        '{speech}': getRandomFromSet(aiKnowledge.dialogues) || 'Anh nghĩ sao về điều này?',
        '{innerSpeech}': getRandomFromSet(aiKnowledge.emotions) || 'Tôi cảm thấy bối rối',
        '{outerSpeech}': getRandomFromSet(aiKnowledge.dialogues) || 'Không có gì đặc biệt.',
        '{whisper}': getRandomFromSet(aiKnowledge.dialogues) || 'Em hiểu anh mà.',
        '{reaction}': getRandomFromSet(aiKnowledge.emotions) || 'tim đập nhanh',
        '{sensation}': ['nóng bừng', 'run rẩy', 'bồn chồn', 'ngứa ngáy', 'căng thẳng'][Math.floor(Math.random() * 5)],
        '{response}': getRandomFromSet(aiKnowledge.emotions) || 'không thể kiểm soát',
        '{bodyPart}': ['đôi mắt', 'nụ cười', 'cách cử động', 'đường cong cơ thể', 'làn da'][Math.floor(Math.random() * 5)],
        '{intimateAction}': getRandomFromArray(['chạm nhẹ', 'ôm ấp', 'thì thầm', 'trao đổi ánh mắt']),
        '{physicalReaction}': ['run lên', 'nóng ran', 'căng cứng', 'co rúm', 'rung động'][Math.floor(Math.random() * 5)],
        '{intensity}': ['mãnh liệt', 'không thể cưỡng lại', 'sâu sắc', 'tự nhiên', 'mạnh mẽ'][Math.floor(Math.random() * 5)],
        '{atmosphere}': ['căng thẳng', 'thân mật', 'bí mật', 'quyến rũ', 'nguy hiểm'][Math.floor(Math.random() * 5)],
        '{sensoryDetail}': ['hương thơm tỏa ra', 'hơi ấm cơ thể', 'tiếng thở dốc', 'ánh mắt thiêu đốt'][Math.floor(Math.random() * 4)],
        '{adjective}': ['mê hoặc', 'khó cưỡng', 'quyến rũ', 'nguy hiểm', 'thú vị'][Math.floor(Math.random() * 5)],
        '{change}': ['bắt đầu hiểu rõ hơn', 'có cái nhìn khác', 'chấp nhận thực tế', 'tìm được bình yên'][Math.floor(Math.random() * 4)],
        '{development}': ['mọi thứ dần rõ ràng', 'tôi học được nhiều điều', 'cuộc sống có ý nghĩa hơn', 'tôi trưởng thành hơn'][Math.floor(Math.random() * 4)],
        '{newReality}': ['tôi sống hài hòa hơn', 'gia đình tôi gắn kết hơn', 'tôi hiểu về tình yêu', 'mọi thứ có vị trí của nó'][Math.floor(Math.random() * 4)],
        '{conclusion}': ['tìm được đáp án', 'có cái nhìn toàn diện', 'sống chân thật hơn', 'chấp nhận bản thân'][Math.floor(Math.random() * 4)]
    };
    
    Object.keys(replacements).forEach(placeholder => {
        const regex = new RegExp(placeholder.replace(/[{}]/g, '\\        document.getElementById('generationStatus').innerHTML = '), 'g');
        text = text.replace(regex, replacements[placeholder]);
    });
    
    return text;
}

function generateAdditionalSmartContent(phase, context) {
    const contentTypes = ['reflection', 'observation', 'emotion', 'memory'];
    
    if (phase === 'climax') {
        contentTypes.push('adult', 'conflict');
    }
    
    const selectedType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
    return generateSmartSentence(selectedType, context);
}

function generateChapterEnding(phase, context) {
    const endings = {
        beginning: [
            "Tôi quyết định sẽ quan sát kỹ hơn trong những ngày tới.",
            "Có lẽ tôi cần thời gian để hiểu rõ hơn về tình hình này.",
            "Câu hỏi trong đầu tôi vẫn chưa có lời giải đáp."
        ],
        middle: [
            "Mọi thứ đang trở nên phức tạp hơn tôi nghĩ.",
            "Tôi cảm thấy mình đang đứng trước một bí ẩn lớn.",
            "Những mảnh ghép bắt đầu khớp với nhau trong tâm trí tôi."
        ],
        climax: [
            "Giờ đây tôi không thể làm ngơ trước sự thật này nữa.",
            "Cuộc sống của tôi sẽ không bao giờ như trước.",
            "Tôi phải đối mặt với thực tế dù có đau đớn đến đâu."
        ],
        ending: [
            "Cuối cùng tôi cũng tìm được sự bình yên trong tâm hồn.",
            "Tôi học được rằng cuộc sống luôn phức tạp hơn những gì ta nghĩ.",
            "Giờ đây tôi có thể nhìn mọi thứ với con mắt khác."
        ]
    };
    
    const phaseEndings = endings[phase] || endings.beginning;
    return phaseEndings[Math.floor(Math.random() * phaseEndings.length)];
}

// HÀM HỌC TỪ NỘI DUNG VỪA TẠO
async function learnFromGeneratedContent(storyTitle, chapterCount) {
    try {
        // Tìm story folder vừa tạo
        const story = storyHistory.find(s => s.storyTitle === storyTitle);
        if (!story) return;
        
        // Đọc và phân tích tất cả chapters vừa tạo
        for (let chapter of story.chapters) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: chapter.id,
                    alt: 'media'
                });
                
                const content = response.body;
                
                // Học từ nội dung vừa tạo để cải thiện lần sau
                await advancedContentAnalysis(content, storyTitle, chapter.name);
                
            } catch (error) {
                console.error('Error reading generated chapter:', error);
            }
        }
        
        // Lưu kiến thức đã học
        await saveAiKnowledge();
        updateAiStats();
        
        showStatus('AI đã học thêm từ truyện vừa tạo để cải thiện lần sau!', 'success');
        
    } catch (error) {
        console.error('Error learning from generated content:', error);
    }
}

// HÀM LẤY PHẦN TỬ NGẪU NHIÊN TỪ SET
function getRandomFromSet(set) {
    if (!set || set.size === 0) return null;
    const array = Array.from(set);
    return array[Math.floor(Math.random() * array.length)];
}

function getRandomFromArray(array) {
    if (!array || array.length === 0) return '';
    return array[Math.floor(Math.random() * array.length)];
}

// HÀM LƯU KIẾN THỨC AI
async function saveAiKnowledge() {
    const knowledgeData = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        stories: aiKnowledge.stories,
        trainedFiles: aiKnowledge.trainedFiles,
        dialogues: Array.from(aiKnowledge.dialogues),
        contexts: Array.from(aiKnowledge.contexts),
        characterDetails: Array.from(aiKnowledge.characterDetails),
        emotions: Array.from(aiKnowledge.emotions),
        adultContent: Array.from(aiKnowledge.adultContent),
        timeReferences: Array.from(aiKnowledge.timeReferences),
        locations: Array.from(aiKnowledge.locations),
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        plotPoints: Array.from(aiKnowledge.plotPoints),
        characterNames: Array.from(aiKnowledge.characterNames),
        environmentDetails: Array.from(aiKnowledge.environmentDetails),
        transitionWords: Array.from(aiKnowledge.transitionWords),
        generationHistory: aiKnowledge.generationHistory,
        lastUpdated: new Date().toISOString()
    };
    
    const knowledgeStr = JSON.stringify(knowledgeData);
    const fileName = 'ai_knowledge_advanced_v2.json';
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            await gapi.client.request({
                path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: knowledgeStr
            });
        } else {
            const fileMetadata = { 
                name: fileName, 
                parents: [mainFolderId] 
            };
            
            await gapi.client.request({
                path: 'https://www.googleapis.com/upload/drive/v3/files', 
                method: 'POST',
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
                body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                      JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n' +
                      knowledgeStr + '\r\n--foo_bar_baz--'
            });
        }
    } catch (error) {
        console.error('Error saving AI knowledge:', error);
    }
}

// HÀM TẢI KIẾN THỨC AI
async function loadAiKnowledge() {
    const fileName = 'ai_knowledge_advanced_v2.json';
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            const knowledge = JSON.parse(fileResponse.body);
            
            aiKnowledge.vocabulary = new Set(knowledge.vocabulary || []);
            aiKnowledge.stories = knowledge.stories || [];
            aiKnowledge.trainedFiles = knowledge.trainedFiles || 0;
            aiKnowledge.dialogues = new Set(knowledge.dialogues || []);
            aiKnowledge.contexts = new Set(knowledge.contexts || []);
            aiKnowledge.characterDetails = new Set(knowledge.characterDetails || []);
            aiKnowledge.emotions = new Set(knowledge.emotions || []);
            aiKnowledge.adultContent = new Set(knowledge.adultContent || []);
            aiKnowledge.timeReferences = new Set(knowledge.timeReferences || []);
            aiKnowledge.locations = new Set(knowledge.locations || []);
            aiKnowledge.sentenceStructures = new Set(knowledge.sentenceStructures || []);
            aiKnowledge.plotPoints = new Set(knowledge.plotPoints || []);
            aiKnowledge.characterNames = new Set(knowledge.characterNames || []);
            aiKnowledge.environmentDetails = new Set(knowledge.environmentDetails || []);
            aiKnowledge.transitionWords = new Set(knowledge.transitionWords || []);
            aiKnowledge.generationHistory = knowledge.generationHistory || [];
        }
    } catch (error) {
        console.error('Error loading AI knowledge:', error);
    }
}

function resetAI() {
    if (confirm('Bạn có chắc chắn muốn reset toàn bộ kiến thức của AI?')) {
        aiKnowledge = { 
            vocabulary: new Set(), 
            stories: [], 
            trainedFiles: 0,
            dialogues: new Set(),
            contexts: new Set(),
            characterDetails: new Set(),
            emotions: new Set(),
            adultContent: new Set(),
            timeReferences: new Set(),
            locations: new Set(),
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            characterNames: new Set(),
            environmentDetails: new Set(),
            transitionWords: new Set(),
            generationHistory: []
        };
        updateAiStats();
        saveAiKnowledge();
        showStatus('Đã reset kiến thức của AI!', 'success');
    }
}

// HÀM KIỂM TRA NỘI DUNG NHẠY CẢNH
function isSensitiveContent(content) {
    const sensitiveKeywords = [
        'bố chồng', 'con dâu', 'khao khát', 'kích thích', 'dục vọng', 'bí mật', 
        'thầm kín', 'cấm kỵ', 'ranh giới', 'quan hệ đặc biệt', 'không thể cưỡng lại',
        'ham muốn', 'thèm muốn', 'tội lỗi', 'xấu hổ', 'bối rối về tình dục', 'dâm dục',
        'quan hệ', 'ân ái', 'làm tình', 'yêu đương', 'gợi tình', 'quyến rũ', 'khoái cảm',
        'cơ thể', 'thân thể', 'ngực', 'mông', 'đùi', 'vòng một', 'vòng ba'
    ];
    
    return sensitiveKeywords.some(keyword => 
        content.toLowerCase().includes(keyword.toLowerCase())
    );
}

// HÀM HIỂN THỊ NỘI DUNG CHƯƠNG với xử lý AI học thêm
async function viewChapterContent(chapter, folderId) {
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapter.id,
            alt: 'media'
        });
        
        const content = response.body;
        chapterContent.textContent = content;
        chapterContent.style.display = 'block';
        chapterActions.style.display = 'block';
        currentEditingChapter = { id: chapter.id, content: content, name: chapter.name };
        
        // AI học từ chapter được xem
        const storyTitle = storyHistory.find(s => s.folderId === folderId)?.storyTitle || 'Unknown';
        await advancedContentAnalysis(content, storyTitle, chapter.name);
        await saveAiKnowledge();
        updateAiStats();
        
        // Kiểm tra và xử lý nội dung nhạy cảm
        if (isSensitiveContent(content)) {
            chapterContent.classList.add('sensitive-content');
            
            const revealBtn = document.createElement('button');
            revealBtn.className = 'reveal-btn';
            revealBtn.textContent = '👁️ Hiển thị nội dung nhạy cảm';
            revealBtn.onclick = function() {
                chapterContent.classList.toggle('revealed');
                this.textContent = chapterContent.classList.contains('revealed') ? 
                    '🙈 Ẩn nội dung nhạy cảm' : '👁️ Hiển thị nội dung nhạy cảm';
            };
            
            chapterContent.parentNode.insertBefore(revealBtn, chapterContent);
        }
    } catch (error) {
        console.error('Error loading chapter content:', error);
        showStatus('Có lỗi khi tải nội dung chương!', 'error');
    }
}

//
