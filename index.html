<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Trình Phân Tích & Tạo Truyện Nâng cao</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    :root {
      --primary-color: #9b59b6;
      --secondary-color: #2980b9;
      --dark-color: #1e1e1e;
      --light-color: #bdc3c7;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --text-color: #ecf0f1;
      --card-bg: rgba(30, 30, 30, 0.95);
      --border-radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #121212;
      color: var(--text-color);
      font-family: sans-serif;
      min-height: 100vh;
    }

    .container {
      padding: 16px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: #2c3e50;
    }

    .menu-item {
      color: var(--light-color);
      text-decoration: none;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .menu-item.active {
      opacity: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 20px;
    }

    .btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
    }

    .btn:disabled {
      background: #777;
      cursor: not-allowed;
    }

    .story-content {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      max-height: 50vh;
      overflow-y: auto;
    }

    /* Enhanced Story Generator Styles */
    .story-generator {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .generator-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-group label {
      color: var(--text-color);
      margin-bottom: 5px;
      font-weight: bold;
    }

    .control-group select, 
    .control-group input[type="number"],
    .control-group input[type="range"],
    .control-group textarea {
      background: #2c3e50;
      color: var(--text-color);
      border: 1px solid #34495e;
      border-radius: 8px;
      padding: 8px;
    }

    .story-preview {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #34495e;
      line-height: 1.8;
    }

    .story-stats {
      background: #2c3e50;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .template-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .template-card {
      background: #34495e;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .template-card:hover {
      border-color: var(--primary-color);
      background: #3d566e;
    }

    .template-card.selected {
      border-color: var(--success-color);
      background: #2d4a3e;
    }

    .btn-generate {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: block;
      margin: 0 auto;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-generate:disabled {
      background: #777;
      cursor: not-allowed;
      transform: none;
    }

    .learning-system {
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .learning-progress {
      display: none;
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid var(--success-color);
    }

    .character-info {
      background: #34495e;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .story-title {
      color: #3498db;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .generator-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
      <p>Phân tích nâng cao và tạo truyện tự động với AI học máy</p>
    </div>

    <div id="tab-analysis" class="tab-content active">
      <div class="card">
        <h3>🔍 Phân tích nguồn truyện</h3>
        <div class="status-info" id="statusInfo">🔴 Chưa kết nối Google Drive</div>
        <div class="detailed-status" id="detailedStatus"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="height:10px;background:#9b59b6;width:0%"></div>
        </div>
        <button class="btn" onclick="handleAuthClick()">🔐 Kết nối Google Drive</button>
        <button class="btn" id="scanBtn" onclick="scanFolder()" disabled>📁 Quét thư mục</button>
        <button class="btn" id="analyzeBtn" onclick="analyzeFiles()" disabled>🧠 Phân tích nâng cao</button>
        <button class="btn" id="downloadAnalysisBtn" onclick="downloadAnalysisFromDrive()" disabled>📥 Tải phân tích</button>
        <button class="btn" onclick="loadAnalysisLocal()">📄 Tải cache local</button>
        <button class="btn" onclick="uploadAnalysisToDrive()">☁️ Upload phân tích</button>
        <button class="btn" onclick="clearLocalCache()" style="background: #e74c3c;">🗑️ Xóa cache</button>
      </div>
      <div class="card">
        <h3>📊 Kết quả phân tích</h3>
        <div id="analysisResults">
          <div class="empty-state">
            <p>🔭 Chưa có dữ liệu phân tích.</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
              Hãy kết nối Google Drive, quét thư mục và phân tích để xem kết quả.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-generator" class="tab-content">
      <!-- Learning System Status -->
      <div class="card learning-system">
        <h3>🧠 Hệ thống AI học máy</h3>
        <div id="learningStatus">
          <p>📚 Trạng thái: <span id="aiStatus">Chờ dữ liệu phân tích</span></p>
          <p>🎯 Mô hình hiện tại: <span id="currentModel">Chưa khởi tạo</span></p>
          <div id="learningProgress" class="learning-progress">
            <p id="learningContent">Hệ thống đang học từ dữ liệu...</p>
          </div>
        </div>
      </div>

      <!-- Story Generator -->
      <div class="card story-generator">
        <h3>✍️ Tạo Truyện Thông Minh</h3>
        <p style="color: #bdc3c7; margin-bottom: 15px;">
          Sử dụng AI học máy để tạo truyện dựa trên phân tích dữ liệu hiện có
        </p>

        <!-- Template Selection -->
        <div class="control-group">
          <label>📝 Chọn Template Truyện:</label>
          <div class="template-selector" id="templateSelector">
            <div class="template-card selected" data-template="family_drama">
              <h4>👨‍👩‍👧‍👦 Gia Đình Drama</h4>
              <p>Câu chuyện phức tạp về tình cảm gia đình</p>
            </div>
            <div class="template-card" data-template="romance">
              <h4>💕 Lãng Mạn</h4>
              <p>Câu chuyện tình yêu ngọt ngào</p>
            </div>
            <div class="template-card" data-template="adventure">
              <h4>🗺️ Phiêu Lưu</h4>
              <p>Cuộc phiêu lưu kỳ thú</p>
            </div>
            <div class="template-card" data-template="drama">
              <h4>🎭 Chính Kịch</h4>
              <p>Tình huống phức tạp, cảm xúc sâu sắc</p>
            </div>
          </div>
        </div>

        <!-- Generation Controls -->
        <div class="generator-controls">
          <div class="control-group">
            <label>📏 Độ dài truyện:</label>
            <select id="storyLength">
              <option value="short">Ngắn (800-1200 từ)</option>
              <option value="medium" selected>Trung bình (1500-2000 từ)</option>
              <option value="long">Dài (2500-3500 từ)</option>
            </select>
          </div>

          <div class="control-group">
            <label>👁️ Ngôi kể:</label>
            <select id="narrativePerspective">
              <option value="auto">Tự động (dựa trên phân tích)</option>
              <option value="first">Ngôi thứ nhất</option>
              <option value="third">Ngôi thứ ba</option>
            </select>
          </div>

          <div class="control-group">
            <label>🎨 Mức độ sáng tạo:</label>
            <input type="range" id="creativityLevel" min="1" max="10" value="7" 
                   oninput="document.getElementById('creativityValue').textContent = this.value">
            <span id="creativityValue">7</span>/10
          </div>

          <div class="control-group">
            <label>📈 Độ học từ dữ liệu gốc:</label>
            <input type="range" id="learningIntensity" min="1" max="10" value="8" 
                   oninput="document.getElementById('learningValue').textContent = this.value">
            <span id="learningValue">8</span>/10
          </div>
        </div>

        <!-- Custom Prompt -->
        <div class="control-group">
          <label>💭 Yêu cầu đặc biệt (tùy chọn):</label>
          <textarea id="customPrompt" rows="3" placeholder="Ví dụ: Tập trung vào tâm lý nhân vật, có twist bất ngờ, kết thúc có hậu..."></textarea>
        </div>

        <!-- Generate Button -->
        <div style="text-align: center; margin: 20px 0;">
          <button class="btn-generate" onclick="generateIntelligentStory()" id="generateBtn">
            🚀 Tạo Truyện Thông Minh
          </button>
        </div>

        <!-- Story Stats -->
        <div class="story-stats" id="generationStats" style="display: none;">
          <p><strong>📊 Thông tin tạo truyện:</strong></p>
          <div id="statsContent"></div>
        </div>
      </div>

      <!-- Generated Story Display -->
      <div class="card">
        <h3>📖 Truyện Được Tạo</h3>
        <div id="generatedStory" class="story-preview">
          <p style="color: #7f8c8d; font-style: italic;">
            Chưa có truyện nào được tạo. Hãy chọn template và nhấn "Tạo Truyện Thông Minh" để bắt đầu!
          </p>
        </div>
        
        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 15px;">
          <button class="btn" onclick="copyStory()" id="copyBtn" disabled>📋 Sao Chép</button>
          <button class="btn" onclick="saveStoryToDrive()" id="saveBtn" disabled>💾 Lưu lên Drive</button>
          <button class="btn" onclick="improveStory()" id="improveBtn" disabled>✨ Cải Thiện</button>
          <button class="btn" onclick="regenerateStory()" id="regenBtn" disabled>🔄 Tạo Lại</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">🔍 Phân tích</a>
    <a href="#" class="menu-item" onclick="switchTab('tab-generator')">✍️ Tạo truyện</a>
  </div>

  <script>
    // ===== GOOGLE API & CORE VARIABLES =====
    const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    let tokenClient, gapi_inited = false, gsi_inited = false;
    let analysisData = [];
    let txtFiles = [];

    // ===== STORY GENERATION VARIABLES =====
    let selectedTemplate = 'family_drama';
    let generatedStoryContent = '';
    let storyAI = null;

    // ===== ENHANCED VOCABULARY FOR STORY ANALYSIS =====
    const familyDramaVocabulary = {
      relationships: {
        family: ['bố', 'mẹ', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em'],
        tension: ['căng thẳng', 'xung đột', 'bất đồng', 'hiểu lầm', 'mâu thuẫn'],
        discovery: ['phát hiện', 'tìm ra', 'biết được', 'nhận ra', 'bí mật']
      },
      emotions: {
        guilt: ['tội lỗi', 'ân hận', 'hối hận', 'xấu hổ', 'day dứt'],
        temptation: ['cám dỗ', 'quyến rũ', 'khó cưỡng', 'thu hút', 'mê hoặc'],
        conflict: ['đấu tranh', 'phân vân', 'khó khăn', 'băn khoăn', 'trăn trở']
      }
    };

    const storyPatterns = {
      family_drama: {
        openings: [
          "Trong căn nhà nhỏ ở",
          "Gia đình {char1} vẫn luôn",
          "Từ khi {char2} về làm dâu"
        ],
        conflicts: [
          "Tình cảm phức tạp nảy sinh",
          "Những khoảnh khắc riêng tư",
          "Sự hiểu lầm dần lớn"
        ],
        resolutions: [
          "Cuối cùng mọi người hiểu ra",
          "Tình cảm gia đình chiến thắng",
          "Họ học được cách yêu thương"
        ]
      }
    };

    // ===== INTELLIGENT STORY LEARNING SYSTEM =====
    class IntelligentStoryAI {
      constructor() {
        this.patterns = this.loadLearningData();
        this.analysisInsights = {};
        this.generationHistory = [];
      }

      loadLearningData() {
        const saved = localStorage.getItem('storyAILearningData');
        return saved ? JSON.parse(saved) : {
          goodSentences: [],
          goodDialogues: [],
          successfulPlots: [],
          characterTraits: {},
          improvedVersions: []
        };
      }

      saveLearningData() {
        localStorage.setItem('storyAILearningData', JSON.stringify(this.patterns));
      }

      analyzeExistingData(analysisData) {
        if (!analysisData || analysisData.length === 0) return null;

        this.analysisInsights = {
          commonCharacters: this.extractCommonElements(analysisData, 'nhanVat'),
          commonPlaces: this.extractCommonElements(analysisData, 'diaDiem'),
          commonEmotions: this.extractEmotionalPatterns(analysisData),
          writingStyle: this.detectWritingStyle(analysisData),
          averageLength: this.calculateAverageLength(analysisData),
          storyStructures: this.analyzeStoryStructures(analysisData)
        };

        return this.analysisInsights;
      }

      extractCommonElements(data, field) {
        const allElements = [];
        data.forEach(story => {
          if (story.storyStructure && story.storyStructure[field]) {
            allElements.push(...story.storyStructure[field]);
          }
        });
        return this.getMostFrequent(allElements, 10);
      }

      extractEmotionalPatterns(data) {
        const emotions = { positive: [], negative: [], neutral: [] };
        data.forEach(story => {
          if (story.storyStructure && story.storyStructure.emotion) {
            const e = story.storyStructure.emotion;
            if (e.positive) emotions.positive.push(...e.positive);
            if (e.negative) emotions.negative.push(...e.negative);
            if (e.neutral) emotions.neutral.push(...e.neutral);
          }
        });
        return emotions;
      }

      detectWritingStyle(data) {
        let dialogueCount = 0;
        let descriptiveCount = 0;
        
        data.forEach(story => {
          if (story.storyStructure) {
            if (story.storyStructure.hoiThoai && story.storyStructure.hoiThoai.length > 3) {
              dialogueCount++;
            }
            if (story.basicStats && story.basicStats.wordCount > 1000) {
              descriptiveCount++;
            }
          }
        });

        return dialogueCount > descriptiveCount ? 'dialogue-heavy' : 'descriptive';
      }

      calculateAverageLength(data) {
        let totalWords = 0;
        let count = 0;
        data.forEach(story => {
          if (story.basicStats && story.basicStats.wordCount) {
            totalWords += story.basicStats.wordCount;
            count++;
          }
        });
        return count > 0 ? Math.round(totalWords / count) : 1500;
      }

      analyzeStoryStructures(data) {
        const structures = [];
        data.forEach(story => {
          if (story.storyStructure) {
            structures.push({
              opening: story.storyStructure.moBai ? story.storyStructure.moBai.substring(0, 100) : '',
              development: story.storyStructure.thanBai ? story.storyStructure.thanBai.substring(0, 200) : '',
              ending: story.storyStructure.ketBai ? story.storyStructure.ketBai.substring(0, 100) : ''
            });
          }
        });
        return structures;
      }

      getMostFrequent(arr, limit = 5) {
        const frequency = {};
        arr.forEach(item => {
          if (item && typeof item === 'string') {
            frequency[item] = (frequency[item] || 0) + 1;
          }
        });
        
        return Object.entries(frequency)
          .sort(([,a], [,b]) => b - a)
          .slice(0, limit)
          .map(([item]) => item);
      }

      generateIntelligentStory(params) {
        if (!this.analysisInsights) {
          throw new Error('Cần phân tích dữ liệu trước khi tạo truyện!');
        }

        const storyData = this.createStoryStructure(params);
        const fullStory = this.writeStory(storyData, params);
        
        // Learn from this generation
        this.learnFromGeneration(fullStory, params);
        
        return {
          story: fullStory,
          metadata: storyData,
          insights: this.analysisInsights
        };
      }

      createStoryStructure(params) {
        const characters = this.generateSmartCharacters();
        const setting = this.selectSmartSetting();
        const plot = this.developSmartPlot(params.template, characters);

        return {
          characters,
          setting,
          plot,
          style: this.analysisInsights.writingStyle,
          targetLength: this.getTargetLength(params.length)
        };
      }

      generateSmartCharacters() {
        const characters = [];
        const commonNames = this.analysisInsights.commonCharacters || [];
        
        // Main character
        characters.push({
          name: commonNames[0] || this.generateVietnameseName('male'),
          role: 'bố chồng',
          age: '50-60',
          traits: ['có trách nhiệm', 'quan tâm gia đình', 'đôi khi cô đơn'],
          background: 'Làm việc cần mẫn, lo cho gia đình'
        });

        // Supporting character  
        characters.push({
          name: commonNames[1] || this.generateVietnameseName('female'),
          role: 'nàng dâu',
          age: '28-35', 
          traits: ['hiền lành', 'chăm chỉ', 'có tâm hồn đẹp'],
          background: 'Về nhà chồng được một thời gian'
        });

        return characters;
      }

      generateVietnameseName(gender) {
        const maleNames = ['Anh Dũng', 'Minh Tuấn', 'Văn Hải', 'Đức Anh', 'Quang Huy'];
        const femaleNames = ['Thu Hà', 'Lan Anh', 'Thanh Thúy', 'Minh Ngọc', 'Hương Giang'];
        
        const names = gender === 'male' ? maleNames : femaleNames;
        return names[Math.floor(Math.random() * names.length)];
      }

      selectSmartSetting() {
        const commonPlaces = this.analysisInsights.commonPlaces || ['nhà', 'làng quê'];
        return {
          primary: commonPlaces[0] || 'nhà',
          time: 'hiện tại',
          atmosphere: 'ấm cúng nhưng có chút căng thẳng'
        };
      }

      developSmartPlot(template, characters) {
        const plotPoints = [
          `Cuộc sống hàng ngày của ${characters[0].name} và ${characters[1].name}`,
          `Những khoảnh khắc tâm lý phức tạp nảy sinh`,
          `Sự hiểu lầm và căng thẳng gia tăng`,
          `Nhận ra và giải quyết vấn đề`,
          `Tìm lại sự hài hòa trong gia đình`
        ];

        return plotPoints;
      }

      getTargetLength(lengthParam) {
        const targets = {
          short: { words: 1000, paragraphs: 6 },
          medium: { words: 1800, paragraphs: 8 },
          long: { words: 3000, paragraphs: 12 }
        };
        return targets[lengthParam] || targets.medium;
      }

      writeStory(storyData, params) {
        const { characters, setting, plot, targetLength } = storyData;
        
        let story = `${this.generateTitle(params.template)}\n\n`;
        
        // Opening
        story += this.writeOpening(characters, setting) + '\n\n';
        
        // Development paragraphs
        for (let i = 1; i < plot.length - 1; i++) {
          story += this.writeDevelopmentParagraph(plot[i], characters, i) + '\n\n';
        }
        
        // Conclusion
        story += this.writeConclusion(characters, setting);
        
        return story;
      }

      generateTitle(template) {
        const titles = {
          family_drama: ['Tình Cảm Gia Đình', 'Những Ngày Bình Yên', 'Gắn Kết Yêu Thương'],
          romance: ['Tình Yêu Trong Sáng', 'Ngày Em Đến', 'Hạnh Phúc Nhỏ'],
          adventure: ['Cuộc Phiêu Lưu', 'Hành Trình Khám Phá'],
          drama: ['Những Ngày Đó', 'Cuộc Đời', 'Kí Ức']
        };
        
        const templateTitles = titles[template] || titles.family_drama;
        return templateTitles[Math.floor(Math.random() * templateTitles.length)];
      }

      writeOpening(characters, setting) {
        const openings = [
          `Trong căn ${setting.primary} nhỏ, ${characters[0].name} ngồi uống trà và suy nghĩ về cuộc sống. Đã lâu rồi kể từ khi ${characters[1].name} về làm dâu, ngôi nhà trở nên ấm áp hơn nhiều.`,
          `Buổi sáng yên bình ở ${setting.primary}, ${characters[0].name} thức dậy với cảm giác bình an. ${characters[1].name} đã trở thành một phần không thể thiếu trong gia đình.`,
          `Ánh nắng chiều chiếu qua khung cửa sổ, ${characters[0].name} nhìn ${characters[1].name} đang tất bật trong bếp và cảm thấy lòng ấm áp lạ thường.`
        ];
        
        return openings[Math.floor(Math.random() * openings.length)];
      }

      writeDevelopmentParagraph(plotPoint, characters, index) {
        const developments = [
          `${characters[0].name} nhận ra mình đang có những cảm xúc phức tạp. Những khoảnh khắc nhỏ bên ${characters[1].name} khiến ông cảm thấy cuộc sống có ý nghĩa hơn.`,
          `Trong lòng ${characters[1].name}, sự tôn trọng dành cho ${characters[0].name} dần chuyển thành một tình cảm sâu sắc hơn. Cô hiểu rằng đây là người đàn ông tốt bụng và có trách nhiệm.`,
          `Những cuộc trò chuyện buổi tối giữa hai người trở nên thân mật hơn. ${characters[0].name} chia sẻ về quá khứ, về những khó khăn trong cuộc sống.`,
          `${characters[1].name} cảm thấy mình được hiểu và được quan tâm một cách chân thành. Trong con mắt ${characters[0].name}, cô thấy sự trân trọng và yêu thương.`,
          `Cả hai đều nhận ra rằng tình cảm này tuy đẹp nhưng phức tạp. Họ phải đối mặt với áp lực xã hội và kỳ vọng của gia đình.`
        ];
        
        return developments[index % developments.length];
      }

      writeConclusion(characters, setting) {
        const conclusions = [
          `Cuối cùng, ${characters[0].name} và ${characters[1].name} hiểu ra rằng tình cảm đẹp nhất là sự tôn trọng và quan tâm lẫn nhau. Họ quyết định giữ mối quan hệ gia đình hài hòa, với tình yêu thương trong sáng và tôn trọng.`,
          `Gia đình nhỏ tìm lại được sự cân bằng. ${characters[0].name} và ${characters[1].name} trở thành những người bạn tâm giao, luôn hỗ trợ nhau trong cuộc sống với tình cảm chân thành và trong sạch.`,
          `Tình cảm gia đình được củng cố qua thử thách. ${characters[0].name} và ${characters[1].name} học được cách yêu thương một cách khôn ngoan, tôn trọng và có trách nhiệm.`
        ];
        
        return conclusions[Math.floor(Math.random() * conclusions.length)];
      }

      learnFromGeneration(story, params) {
        // Analyze the generated story
        const sentences = story.split('.').filter(s => s.trim().length > 20);
        const goodSentences = sentences.filter(s => this.isQualitySentence(s));
        
        // Store learning data
        this.patterns.goodSentences.push(...goodSentences.slice(0, 3));
        this.generationHistory.push({
          template: params.template,
          length: params.length,
          creativity: params.creativity,
          timestamp: new Date().toISOString(),
          wordCount: story.split(' ').length
        });
        
        // Keep only recent data to prevent memory bloat
        if (this.patterns.goodSentences.length > 100) {
          this.patterns.goodSentences = this.patterns.goodSentences.slice(-50);
        }
        
        this.saveLearningData();
      }

      isQualitySentence(sentence) {
        const criteria = [
          sentence.length > 50 && sentence.length < 200,
          /cảm thấy|nhận ra|hiểu|yêu thương/.test(sentence),
          /,|;/.test(sentence),
          !sentence.includes('...') || sentence.includes('...')
        ];
        return criteria.filter(Boolean).length >= 3;
      }

      getImprovementSuggestions() {
        return [
          'Thêm chi tiết miêu tả cảm xúc',
          'Phát triển tâm lý nhân vật sâu hơn',
          'Cải thiện đối thoại tự nhiên hơn',
          'Tăng cường tính hợp lý trong cốt truyện',
          'Hoàn thiện kết thúc có ý nghĩa'
        ];
      }
    }

    // ===== GOOGLE API FUNCTIONS =====
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC]
      });
      gapi_inited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
      });
      gsi_inited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapi_inited && gsi_inited) {
        document.getElementById('scanBtn').disabled = false;
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        gapi.client.setToken({access_token: resp.access_token});
        updateStatus('🟢 Đã kết nối Google Drive');
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('downloadAnalysisBtn').disabled = false;
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // ===== UI UPDATE FUNCTIONS =====
    function updateStatus(msg) {
      document.getElementById('statusInfo').innerText = msg;
    }

    function updateProgress(p) {
      document.getElementById('progressBar').style.width = p + '%';
    }

    function updateDetailedStatus(msg) {
      document.getElementById('detailedStatus').innerText = msg;
    }

    // ===== LOCAL STORAGE FUNCTIONS =====
    function saveAnalysisLocal() {
      const analysisContent = {
        analysisData: analysisData,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('analysisResults', JSON.stringify(analysisContent));
    }

    function loadAnalysisLocal() {
      const data = localStorage.getItem('analysisResults');
      if (data) {
        try {
          const parsed = JSON.parse(data);
          analysisData = parsed.analysisData || [];
          displayAdvancedAnalysisResults();
          updateStatus('✅ Đã tải cache local');
          updateAIStatus();
          return true;
        } catch (e) {
          console.error('Error loading local cache:', e);
          updateStatus('❌ Lỗi khi tải cache local');
        }
      } else {
        updateStatus('⚠️ Không có cache local');
        displayEmptyState();
      }
      return false;
    }

    function clearLocalCache() {
      if (confirm('Bạn có chắc muốn xóa toàn bộ cache local?')) {
        localStorage.removeItem('analysisResults');
        localStorage.removeItem('storyAILearningData');
        analysisData = [];
        storyAI = null;
        displayEmptyState();
        updateStatus('🗑️ Đã xóa cache local');
        updateAIStatus();
      }
    }

    function displayEmptyState() {
      const container = document.getElementById('analysisResults');
      container.innerHTML = `
        <div class="empty-state">
          <p>🔭 Chưa có dữ liệu phân tích.</p>
          <p style="font-size: 0.9em; margin-top: 10px;">
            Hãy kết nối Google Drive, quét thư mục và phân tích để xem kết quả.
          </p>
        </div>
      `;
    }

    // ===== GOOGLE DRIVE FUNCTIONS =====
    function uploadAnalysisToDrive() {
      if (!analysisData || analysisData.length === 0) {
        alert("⚠️ Không có dữ liệu phân tích để upload!");
        return;
      }

      const fileContent = JSON.stringify(analysisData, null, 2);
      const file = new Blob([fileContent], { type: 'application/json' });

      const metadata = {
        name: "analysisData.json",
        mimeType: "application/json"
      };

      const accessToken = gapi.client.getToken().access_token;
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", file);

      fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
      }).then(res => res.json()).then(val => {
        alert("✅ Đã upload phân tích lên Google Drive: " + val.id);
      }).catch(err => {
        console.error("Upload lỗi:", err);
        alert("❌ Lỗi khi upload: " + err.message);
      });
    }

    async function downloadAnalysisFromDrive() {
      try {
        const accessToken = gapi.client.getToken().access_token;

        let res = await fetch(
          "https://www.googleapis.com/drive/v3/files?q=name='analysisData.json'&fields=files(id,name)",
          { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let data = await res.json();

        if (!data.files || data.files.length === 0) {
          alert("⚠️ Không tìm thấy file analysisData.json trên Google Drive!");
          return;
        }

        const fileId = data.files[0].id;

        let fileRes = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          { headers: new Headers({ "Authorization": "Bearer " + accessToken }) }
        );
        let content = await fileRes.json();

        analysisData = content;
        saveAnalysisLocal();

        alert("✅ Đã tải phân tích về từ Google Drive!");
        displayAdvancedAnalysisResults();
        updateAIStatus();

      } catch (err) {
        console.error("Download lỗi:", err);
        alert("❌ Lỗi khi tải phân tích từ Google Drive: " + err.message);
      }
    }

    const ROOT_FOLDER_NAME = "QuanLyTruyen";

    // ===== SCAN FOLDER FUNCTION =====
    async function scanFolder() {
      updateStatus("📁 Đang quét thư mục QuanLyTruyen...");
      updateProgress(5);

      try {
        const folderRes = await gapi.client.drive.files.list({
          q: `mimeType='application/vnd.google-apps.folder' and name='${ROOT_FOLDER_NAME}' and trashed=false`,
          fields: "files(id, name)"
        });

        if (!folderRes.result.files || folderRes.result.files.length === 0) {
          updateStatus("❌ Không tìm thấy thư mục QuanLyTruyen trên Google Drive!");
          return;
        }

        const rootFolderId = folderRes.result.files[0].id;
        txtFiles = [];
        await fetchFilesRecursive(rootFolderId, ROOT_FOLDER_NAME);

        if (txtFiles.length === 0) {
          updateStatus("⚠️ Không có file .txt nào trong QuanLyTruyen.");
          return;
        }

        updateStatus(`✅ Đã quét được ${txtFiles.length} file .txt`);
        updateProgress(100);
        document.getElementById("analyzeBtn").disabled = false;

      } catch (err) {
        console.error("❌ Lỗi khi quét thư mục:", err);
        updateStatus("❌ Lỗi khi quét thư mục: " + err.message);
      }
    }

    async function fetchFilesRecursive(folderId, folderPath) {
      let pageToken = null;
      do {
        const res = await gapi.client.drive.files.list({
          q: `'${folderId}' in parents and trashed=false`,
          fields: "nextPageToken, files(id, name, mimeType)",
          pageToken: pageToken
        });

        for (const file of res.result.files) {
          if (file.mimeType === "application/vnd.google-apps.folder") {
            await fetchFilesRecursive(file.id, `${folderPath}/${file.name}`);
          } else if (file.mimeType === "text/plain" || file.name.endsWith(".txt")) {
            txtFiles.push({
              id: file.id,
              name: file.name,
              folderPath: folderPath
            });
          }
        }
        pageToken = res.result.nextPageToken;
      } while (pageToken);
    }

    // ===== ANALYZE FILES FUNCTION =====
    async function analyzeFiles() {
      if (!txtFiles || txtFiles.length === 0) {
        alert('⚠️ Vui lòng quét thư mục trước!');
        return;
      }

      // Load existing analysis from local cache
      let existingAnalysis = [];
      const localData = localStorage.getItem('analysisResults');
      if (localData) {
        try {
          existingAnalysis = JSON.parse(localData).analysisData || [];
        } catch (e) {
          console.error('Error loading existing analysis:', e);
        }
      }

      const analyzedFileNames = existingAnalysis.map(a => a.fileName);
      let filesToAnalyze = txtFiles.filter(f => !analyzedFileNames.includes(f.name));

      if (filesToAnalyze.length === 0) {
        updateStatus('✅ Tất cả file đã được phân tích');
        analysisData = existingAnalysis;
        displayAdvancedAnalysisResults();
        updateAIStatus();
        return;
      }

      const totalFiles = Math.min(filesToAnalyze.length, 50);
      analysisData = [...existingAnalysis];
      
      updateStatus(`🧠 Bắt đầu phân tích ${totalFiles} file...`);

      for (let i = 0; i < totalFiles; i++) {
        const file = filesToAnalyze[i];
        updateProgress((i / totalFiles) * 100);
        updateDetailedStatus(`Đang phân tích: ${file.name} (${i + 1}/${totalFiles})`);

        try {
          const content = await readFileFromDrive(file.id);
          const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
          analysisData.push(analysis);
          saveAnalysisLocal();
          
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (err) {
          console.error(`Error analyzing ${file.name}:`, err);
          analysisData.push({
            fileName: file.name,
            folderPath: file.folderPath,
            timestamp: new Date().toLocaleString('vi-VN'),
            error: err.message
          });
        }
      }

      displayAdvancedAnalysisResults();
      updateProgress(100);
      updateStatus(`✅ Hoàn thành phân tích ${totalFiles} file`);
      updateAIStatus();
      setTimeout(() => updateProgress(0), 2000);
    }

    // ===== READ FILE FROM DRIVE =====
    async function readFileFromDrive(fileId) {
      try {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`Failed to read file: ${response.status}`);
        }
        
        return await response.text();
      } catch (error) {
        throw new Error(`Error reading file: ${error.message}`);
      }
    }

    // ===== STORY ANALYSIS FUNCTIONS =====
    const sensitiveWords = {
      romantic: ['yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'ấm áp', 'say đắm', 'đam mê', 'dịu dàng', 'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi'],
      sexual: ['gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục'],
      negative: ['ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi', 'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung'],
      family: ['bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà', 'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ'],
      secret: ['bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm', 'lặng lẽ', 'kín đáo', 'riêng tư']
    };

    const emotionalWords = {
      positive: ['vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 'thành công', 'hy vọng'],
      negative: ['buồn', 'đau', 'khổ', 'tệ', 'xấu', 'thất bại', 'tuyệt vọng', 'ghét', 'tức giận', 'lo lắng', 'sợ hãi', 'khóc', 'tang thương', 'bất hạnh'],
      neutral: ['bình thường', 'thông thường', 'trung bình', 'ổn', 'được', 'tạm ổn']
    };

    async function performAdvancedAnalysis(content, fileName, folderPath) {
      const structure = analyzeStoryStructure(content);
      const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;

      const sensitiveStats = {
        romanticCount: structure.romantic ? structure.romantic.length : 0,
        sexualCount: structure.sexual ? structure.sexual.length : 0,
        negativeCount: structure.negative ? structure.negative.length : 0,
        familyCount: structure.family ? structure.family.length : 0,
        secretCount: structure.secret ? structure.secret.length : 0
      };

      const emotionStats = {
        positiveCount: structure.emotion?.positive ? structure.emotion.positive.length : 0,
        negativeCount: structure.emotion?.negative ? structure.emotion.negative.length : 0,
        neutralCount: structure.emotion?.neutral ? structure.emotion.neutral.length : 0
      };

      return {
        fileName: fileName,
        folderPath: folderPath,
        timestamp: new Date().toLocaleString('vi-VN'),
        basicStats: { 
          wordCount: wordCount,
          charCount: content.length,
          lineCount: content.split('\n').length
        },
        contentSample: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
        storyStructure: structure,
        sensitiveStats: sensitiveStats,
        emotionStats: emotionStats
      };
    }

    function analyzeStoryStructure(content) {
      const lower = content.toLowerCase();
      
      function findMatches(words) {
        return words.filter(w => lower.includes(w.toLowerCase()));
      }

      const contentLength = content.length;
      const moBai = content.substring(0, Math.min(300, contentLength));
      const ketBai = contentLength > 300 ? content.substring(Math.max(0, contentLength - 300)) : '';
      const thanBai = contentLength > 600 ? content.substring(300, contentLength - 300) : content.substring(300);

      let ngoike = "Ngôi thứ ba";
      if (/\btôi\b|\bta\b|\bchúng tôi\b/i.test(content)) ngoike = "Ngôi thứ nhất";
      if (/\bbạn\b|\bcậu\b|\bmày\b/i.test(content)) ngoike = "Ngôi thứ hai";

      let characterMatches = content.match(/\b[A-ZÀÁẢÃẠÂĂĐÊÓƠƯ][a-zàáảãạâăđêôơư]+\b/g) || [];
      let uniqueChars = [...new Set(characterMatches)].slice(0, 10);

      let dialogues = [];
      const lines = content.split('\n');
      for (const line of lines) {
        if (/["'].*["']/.test(line) || /nói|bảo|hỏi|đáp|thưa|kêu|gọi|hét|la|thét/.test(line.toLowerCase())) {
          dialogues.push(line.trim());
          if (dialogues.length >= 5) break;
        }
      }

      const timeKeywords = ["sáng", "trưa", "chiều", "tối", "đêm", "hôm qua", "ngày mai", "năm", "tháng", "tuần", "giờ"];
      const placeKeywords = ["nhà", "làng", "thành phố", "rừng", "biển", "núi", "trường", "chợ", "sông", "phố", "quê"];
      const eventKeywords = ["gặp gỡ", "chia ly", "thử thách", "xung đột", "chiến đấu", "giải cứu", "bí mật", "cưới", "chết"];

      let times = findMatches(timeKeywords);
      let places = findMatches(placeKeywords);
      let events = findMatches(eventKeywords);

      let romantic = findMatches(sensitiveWords.romantic);
      let sexual = findMatches(sensitiveWords.sexual);
      let negative = findMatches(sensitiveWords.negative);
      let family = findMatches(sensitiveWords.family);
      let secret = findMatches(sensitiveWords.secret);

      let emotionPos = findMatches(emotionalWords.positive);
      let emotionNeg = findMatches(emotionalWords.negative);
      let emotionNeu = findMatches(emotionalWords.neutral);

      return {
        moBai: moBai,
        thanBai: thanBai.substring(0, 500) + (thanBai.length > 500 ? '...' : ''),
        ketBai: ketBai,
        ngoike: ngoike,
        nhanVat: uniqueChars,
        hoiThoai: dialogues,
        thoiGian: times,
        diaDiem: places,
        tinhHuong: events,
        tuNgu18: sexual,
        romantic: romantic,
        sexual: sexual,
        negative: negative,
        family: family,
        secret: secret,
        emotion: {
          positive: emotionPos,
          negative: emotionNeg,
          neutral: emotionNeu
        }
      };
    }

    // ===== DISPLAY RESULTS FUNCTION =====
    function displayAdvancedAnalysisResults() {
      const safeArray = v => Array.isArray(v) ? v : [];
      const safeJoin = (value, separator = ', ') => {
        if (Array.isArray(value)) {
          return value.join(separator);
        }
        if (typeof value === "string") {
          return value;
        }
        return "";
      };

      const container = document.getElementById('analysisResults');
      if (!analysisData || analysisData.length === 0) {
        container.innerHTML = '<p>Chưa có dữ liệu phân tích.</p>';
        return;
      }

      let html = `<h4>📊 Đã phân tích ${analysisData.length} file truyện</h4>`;

      const totalWords = analysisData.reduce((sum, d) => sum + (d.basicStats?.wordCount || 0), 0);
      const avgWords = Math.round(totalWords / analysisData.length);
      html += `<div style="background:#2c3e50;padding:10px;margin:10px 0;border-radius:8px;">
        <p><strong>📈 Thống kê tổng quan:</strong></p>
        <p>• Tổng số từ: ${totalWords.toLocaleString()} từ</p>
        <p>• Trung bình: ${avgWords.toLocaleString()} từ/file</p>
      </div>`;

      analysisData.forEach((d, index) => {
        if (d.error) {
          html += `<div style="background:#e74c3c;padding:10px;margin:10px 0;border-radius:8px;">
            ❌ <strong>${d.fileName}</strong>: ${d.error}
          </div>`;
        } else {
          const struct = d.storyStructure || {};
          html += `<div style="background:#34495e;padding:15px;margin:10px 0;border-radius:8px;">
            <h5>📄 ${d.fileName}</h5>
            <p style="color:#bdc3c7;font-size:0.9em;">${d.folderPath} • ${d.timestamp}</p>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
              <div><strong>📊 Số từ:</strong> ${(d.basicStats?.wordCount || 0).toLocaleString()}</div>
              <div><strong>📝 Ngôi kể:</strong> ${struct.ngoike || 'Không xác định'}</div>
            </div>

            <div style="margin:10px 0;">
              <p><strong>👥 Nhân vật:</strong> ${safeJoin(struct.nhanVat)}</p>
              <p><strong>⏰ Thời gian:</strong> ${safeJoin(struct.thoiGian)}</p>
              <p><strong>🌍 Địa điểm:</strong> ${safeJoin(struct.diaDiem)}</p>
              <p><strong>🎭 Tình huống:</strong> ${safeJoin(struct.tinhHuong)}</p>
            </div>

            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>📖 Mở bài</strong></summary>
              <div class="story-content">${struct.moBai || 'Không có dữ liệu'}</div>
            </details>
            
            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>📖 Thân bài</strong></summary>
              <div class="story-content">${struct.thanBai || 'Không có dữ liệu'}</div>
            </details>
            
            <details>
              <summary style="cursor:pointer;color:#3498db;"><strong>📖 Kết bài</strong></summary>
              <div class="story-content">${struct.ketBai || 'Không có dữ liệu'}</div>
            </details>

            ${struct.hoiThoai && struct.hoiThoai.length > 0 ? `
            <details>
              <summary style="cursor:pointer;color:#2ecc71;"><strong>💬 Hội thoại (${struct.hoiThoai.length})</strong></summary>
              <div class="story-content">
                ${struct.hoiThoai.map(dialogue => `<p>• ${dialogue}</p>`).join('')}
              </div>
            </details>` : ''}

            <div style="margin:10px 0;">
              <p><strong>😊 Cảm xúc tích cực:</strong> ${safeJoin(safeArray(struct.emotion?.positive))}</p>
              <p><strong>😢 Cảm xúc tiêu cực:</strong> ${safeJoin(safeArray(struct.emotion?.negative))}</p>
              <p><strong>😐 Cảm xúc trung tính:</strong> ${safeJoin(safeArray(struct.emotion?.neutral))}</p>
            </div>

            <div style="margin:10px 0;">
              <p><strong>💝 Ngôn ngữ tình cảm:</strong> ${safeJoin(struct.romantic)}</p>
              <p><strong>👨‍👩‍👧‍👦 Gia đình:</strong> ${safeJoin(struct.family)}</p>
              <p><strong>🤫 Bí mật:</strong> ${safeJoin(struct.secret)}</p>
              <p><strong>⚠️ Tiêu cực:</strong> ${safeJoin(struct.negative)}</p>
              ${struct.sexual && struct.sexual.length > 0 ? `
                <p><strong>🔞 Nội dung nhạy cảm:</strong> <span style="color:#e74c3c;">${struct.sexual.length} từ khóa phát hiện</span></p>
              ` : ''}
            </div>

            <details>
              <summary style="cursor:pointer;color:#95a5a6;"><strong>📄 Mẫu nội dung</strong></summary>
              <div class="story-content" style="font-style:italic;">${d.contentSample || 'Không có dữ liệu'}</div>
            </details>
          </div>`;
        }
      });

      container.innerHTML = html;
    }

    // ===== AI STATUS MANAGEMENT =====
    function updateAIStatus() {
      const aiStatus = document.getElementById('aiStatus');
      const currentModel = document.getElementById('currentModel');
      
      if (analysisData && analysisData.length > 0) {
        if (!storyAI) {
          storyAI = new IntelligentStoryAI();
          const insights = storyAI.analyzeExistingData(analysisData);
        }
        aiStatus.textContent = `Sẵn sàng (${analysisData.length} truyện đã phân tích)`;
        currentModel.textContent = 'Family Drama AI v1.2';
      } else {
        aiStatus.textContent = 'Chờ dữ liệu phân tích';
        currentModel.textContent = 'Chưa khởi tạo';
      }
    }

    // ===== ENHANCED STORY GENERATION =====
    async function generateIntelligentStory() {
      if (!analysisData || analysisData.length === 0) {
        alert('⚠️ Cần có dữ liệu phân tích trước khi tạo truyện! Vui lòng phân tích một số file trước.');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      generateBtn.innerHTML = '🧠 AI đang sáng tác...';

      // Show learning process
      showLearningProcess();

      try {
        // Initialize AI if not already done
        if (!storyAI) {
          storyAI = new IntelligentStoryAI();
        }

        // Get generation parameters
        const params = getGenerationParams();
        
        // Analyze existing data for insights
        const insights = storyAI.analyzeExistingData(analysisData);
        
        // Generate intelligent story
        const storyResult = storyAI.generateIntelligentStory(params);
        
        // Display results
        generatedStoryContent = storyResult.story;
        displayGeneratedStory(storyResult.story);
        showAdvancedStats(storyResult);
        
        // Update learning status
        updateLearningStats(storyAI.patterns);
        
        enableActionButtons();

      } catch (error) {
        console.error('Story generation error:', error);
        alert('❌ Có lỗi khi tạo truyện: ' + error.message);
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '🚀 Tạo Truyện Thông Minh';
      }
    }

    function getGenerationParams() {
      return {
        template: selectedTemplate,
        length: document.getElementById('storyLength').value,
        perspective: document.getElementById('narrativePerspective').value,
        creativity: parseInt(document.getElementById('creativityLevel').value),
        learningIntensity: parseInt(document.getElementById('learningIntensity').value),
        customPrompt: document.getElementById('customPrompt').value.trim()
      };
    }

    function showLearningProcess() {
      const learningDiv = document.getElementById('learningProgress');
      const content = document.getElementById('learningContent');
      
      content.innerHTML = `
        <p>🔍 Phân tích các mẫu truyện hiện có...</p>
        <p>🧠 Áp dụng các kỹ thuật viết kịch tình...</p>
        <p>✨ Sáng tạo nội dung mới với tình tiết hấp dẫn...</p>
        <p>📚 Học hỏi từ ${analysisData.length} truyện đã phân tích...</p>
      `;
      
      learningDiv.style.display = 'block';
      
      // Hide after a few seconds
      setTimeout(() => {
        learningDiv.style.display = 'none';
      }, 3000);
    }

    function updateLearningStats(patterns) {
      const learningDiv = document.getElementById('learningProgress');
      const content = document.getElementById('learningContent');
      
      content.innerHTML = `
        <p>📚 Đã học được ${patterns.goodSentences.length} câu văn hay mới</p>
        <p>🎭 Áp dụng ${patterns.successfulPlots.length} cấu trúc cốt truyện</p>
        <p>📈 Cải thiện liên tục qua từng lần tạo truyện</p>
        <p>🧠 Mô hình AI đã được cập nhật với dữ liệu mới</p>
      `;
      
      learningDiv.style.display = 'block';
    }

    function showAdvancedStats(storyResult) {
      const statsDiv = document.getElementById('generationStats');
      const statsContent = document.getElementById('statsContent');
      
      const wordCount = storyResult.story.split(/\s+/).length;
      
      statsContent.innerHTML = `
        <p>• Số từ: <strong>${wordCount.toLocaleString()}</strong></p>
        <p>• Template: <strong>${getTemplateName(selectedTemplate)}</strong></p>
        <p>• Nhân vật: <strong>${storyResult.metadata.characters.length}</strong></p>
        <p>• Độ phức tạp cốt truyện: <strong>Cao</strong></p>
        <p>• Mức độ sáng tạo: <strong>${document.getElementById('creativityLevel').value}/10</strong></p>
        <p>• Học từ dữ liệu: <strong>${document.getElementById('learningIntensity').value}/10</strong></p>
        <p>• Dựa trên: <strong>${analysisData.length} truyện đã phân tích</strong></p>
      `;
      
      statsDiv.style.display = 'block';
    }

    function getTemplateName(template) {
      const names = {
        'family_drama': 'Gia Đình Drama',
        'romance': 'Lãng Mạn', 
        'adventure': 'Phiêu Lưu',
        'drama': 'Chính Kịch'
      };
      return names[template] || template;
    }

    function displayGeneratedStory(story) {
      const container = document.getElementById('generatedStory');
      
      // Split title and content
      const parts = story.split('\n\n');
      const title = parts[0];
      const content = parts.slice(1).join('\n\n');
      
      // Format with HTML
      const formattedContent = content
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      container.innerHTML = `
        <h3 class="story-title">${title}</h3>
        <div style="line-height: 1.8; font-size: 16px;">
          <p>${formattedContent}</p>
        </div>
      `;
    }

    function enableActionButtons() {
      document.getElementById('copyBtn').disabled = false;
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('regenBtn').disabled = false;
      document.getElementById('improveBtn').disabled = false;
    }

    // ===== ACTION FUNCTIONS =====
    function copyStory() {
      if (!generatedStoryContent) return;
      
      navigator.clipboard.writeText(generatedStoryContent).then(() => {
        alert('📋 Đã sao chép truyện vào clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('❌ Không thể sao chép. Vui lòng thử lại!');
      });
    }

    function saveStoryToDrive() {
      if (!generatedStoryContent) return;
      
      const fileName = `Generated_Story_${new Date().toISOString().slice(0, 10)}.txt`;
      const fileContent = generatedStoryContent;
      
      const metadata = {
        name: fileName,
        mimeType: "text/plain"
      };

      const accessToken = gapi.client.getToken().access_token;
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([fileContent], { type: "text/plain" }));

      fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: new Headers({ "Authorization": "Bearer " + accessToken }),
        body: form
      }).then(res => res.json()).then(val => {
        alert(`💾 Đã lưu truyện lên Google Drive: ${fileName}`);
      }).catch(err => {
        console.error("Save error:", err);
        alert("❌ Lỗi khi lưu truyện: " + err.message);
      });
    }

    function improveStory() {
      if (!generatedStoryContent || !storyAI) {
        alert('Chưa có truyện để cải thiện!');
        return;
      }
      
      const improvements = storyAI.getImprovementSuggestions();
      const improvement = improvements[Math.floor(Math.random() * improvements.length)];
      
      const improveBtn = document.getElementById('improveBtn');
      improveBtn.innerHTML = `✨ Đang ${improvement.toLowerCase()}...`;
      improveBtn.disabled = true;
      
      // Simulate improvement process
      setTimeout(() => {
        // Here you could implement actual story improvement logic
        alert(`✅ Đã ${improvement.toLowerCase()} cho truyện!`);
        improveBtn.innerHTML = '✨ Cải Thiện';
        improveBtn.disabled = false;
        
        // Update learning data with improvement
        if (storyAI) {
          storyAI.patterns.improvedVersions.push({
            original: generatedStoryContent.substring(0, 100),
            improvement: improvement,
            timestamp: new Date().toISOString()
          });
          storyAI.saveLearningData();
        }
      }, 2000);
    }

    function regenerateStory() {
      if (confirm('🔄 Bạn có muốn tạo lại truyện với phiên bản cải tiến?')) {
        generateIntelligentStory();
      }
    }

    // ===== UI NAVIGATION =====
    function switchTab(id) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      
      document.getElementById(id).classList.add('active');
      event.target.classList.add('active');
      
      // Update AI status when switching to generator tab
      if (id === 'tab-generator') {
        updateAIStatus();
        setupTemplateSelector();
      }
    }

    function setupTemplateSelector() {
      document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
          // Remove previous selection
          document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
          // Add selection to clicked card
          this.classList.add('selected');
          selectedTemplate = this.dataset.template;
        });
      });
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // Try to load cached analysis on page load
      const hasLocalData = loadAnalysisLocal();
      
      // Initialize template selector
      setupTemplateSelector();
      
      // Set default template
      selectedTemplate = 'family_drama';
      
      // Update AI status
      updateAIStatus();
      
      console.log('Enhanced Story System initialized');
      console.log(`Local data loaded: ${hasLocalData}`);
      console.log(`Analysis data count: ${analysisData.length}`);
    });
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
