<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Trình Phân Tích & Tạo Truyện Nâng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding-top: 12px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-bottom: calc(16px + var(--safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .menu-item.active {
            opacity: 1;
        }

        .menu-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 6px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .story-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary-color);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 50vh;
            overflow-y: auto;
        }

        .chapter-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #3498db);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .status-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .detailed-status {
            font-size: 0.9rem;
            color: #ecf0f1;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .character-profile {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(236, 240, 241, 0.3);
            border-radius: 10px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .character-details {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .character-desc {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .emotion-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 3px;
            background: #e74c3c;
            color: white;
        }

        .emotion-buon {
            background: #3498db;
        }

        .emotion-dau {
            background: #e74c3c;
        }

        .emotion-bat-luc {
            background: #95a5a6;
        }

        .sensitive-word {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .dialogue {
            font-style: italic;
            color: #2c3e50;
            margin: 5px 0;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }

        .analysis-result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media only screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .container {
                padding: 12px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .card {
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .story-content {
                font-size: 0.95rem;
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
            <p>Phân tích nâng cao và tạo truyện tự động</p>
        </div>

        <div id="tab-analysis" class="tab-content active">
            <div class="card">
                <h3>🔍 Phân tích nguồn truyện</h3>
                <p>Phân tích các file văn bản để tạo dữ liệu cho truyện</p>
                
                <div class="status-info" id="statusInfo">
                    <p>🔴 Chưa kết nối Google Drive</p>
                    <div class="detailed-status" id="detailedStatus"></div>
                </div>
                <div id="detailedStatus" style="margin-top:10px; color:#555; font-size:14px;"></div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="handleAuthClick()">
                    📁 Kết nối Google Drive
                </button>
                
                <button class="btn btn-secondary" id="scanBtn" onclick="scanFolder()" disabled>
                    🔍 Quét thư mục
                </button>
                
                <button class="btn btn-warning" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    🧠 Phân tích nâng cao
                </button>
                
                <div class="toggle-container">
                    <span>Bỏ qua file đã phân tích</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipAnalyzedFiles" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h3>📊 Kết quả phân tích</h3>
                <div id="analysisResults">
                    <p>Chưa có dữ liệu phân tích. Vui lòng quét và phân tích thư mục trước.</p>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="card">
                <h3>✍️ Viết truyện</h3>
                <p>Tạo truyện mới dựa trên dữ liệu đã phân tích</p>
                
                <div class="character-profile">
                    <div class="character-avatar">👨</div>
                    <div class="character-details">
                        <div class="character-name">Người kể chuyện</div>
                        <div class="character-desc">Tạo truyện từ dữ liệu đã phân tích</div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>Số chương (50+):</span>
                    <input type="number" id="minChapters" value="50" min="50" max="100" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                </div>

                <div class="toggle-container">
                    <span>Độ nhạy cảm:</span>
                    <input type="range" id="sensitivityLevel" min="1" max="10" value="5" style="width: 120px;">
                    <span id="sensitivityValue">5</span>
                </div>
                
                <button class="btn btn-success" id="generateBtn" onclick="generateStories()" disabled>
                    ✍️ Bắt đầu viết truyện
                </button>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="writeProgressBar"></div>
                    </div>
                </div>
                
                <div class="status-info">
                    <p id="writeStatus">Chưa bắt đầu viết truyện</p>
                    <div class="detailed-status" id="writeDetailedStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>📖 Truyện đang viết</h3>
                <div id="generatedStories">
                    <p>Chưa có truyện nào được tạo. Hãy bấm "Bắt đầu viết truyện" để bắt đầu.</p>
                </div>
            </div>
        </div>

        <div id="tab-stories" class="tab-content">
            <div class="card">
                <h3>📚 Thư viện truyện</h3>
                <p>Những truyện đã được tạo và lưu trữ</p>
                
                <div id="storiesLibrary">
                    <p>Chưa có truyện nào trong thư viện.</p>
                </div>
                
                <button class="btn btn-secondary" id="loadStoriesBtn" onclick="loadStories()">
                    🔄 Tải danh sách truyện
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3>⚙️ Cài đặt</h3>
                
                <div class="toggle-container">
                    <span>Tự động lưu tiến độ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveResults" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span>Gửi dữ liệu cải thiện AI</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sendImprovementData" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="clearCache()">
                    🗑️ Xóa dữ liệu tạm
                </button>
                
                <button class="btn btn-danger" onclick="handleSignoutClick()">
                    🚪 Đăng xuất
                </button>
            </div>
            
            <div class="card">
                <h3>ℹ️ Thông tin ứng dụng</h3>
                <p>Phiên bản: 2.1.0</p>
                <p>Phân tích nâng cao: Hội thoại & Từ nhạy cảm</p>
                <p>Góc nhìn: Linh hoạt theo phân tích</p>
            </div>
        </div>
    </div>

    <div class="bottom-menu">
        <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">
            <div class="menu-icon">🔍</div>
            <span>Phân tích</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-write')">
            <div class="menu-icon">✍️</div>
            <span>Viết truyện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-stories')">
            <div class="menu-icon">📚</div>
            <span>Thư viện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-settings')">
            <div class="menu-icon">⚙️</div>
            <span>Cài đặt</span>
        </a>
    </div>

    <script>
        // Google API Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapi_inited = false;
        let gsi_inited = false;

        // Global variables
        let analysisData = [];
        let generatedStories = [];
        let scanCache = {};
        const CACHE_FILE_NAME = 'ScanCache_QuanLyTruyen.json';
        const ANALYSIS_CACHE_NAME = 'AnalysisResults_QuanLyTruyen.json';
        const STORY_CACHE_NAME = 'GeneratedStories_QuanLyTruyen.json';

        // Vietnamese language processing data - Mở rộng cho phân tích nâng cao
        const vietnameseStopWords = [
            'là', 'của', 'và', 'có', 'một', 'được', 'trong', 'không', 'với', 'từ', 'để', 'đã', 'sẽ',
            'về', 'cho', 'theo', 'như', 'khi', 'vào', 'ra', 'lên', 'xuống', 'qua', 'tại', 'hay',
            'rằng', 'nếu', 'mà', 'thì', 'hoặc', 'nhưng', 'vì', 'nên', 'đến', 'bằng', 'trên', 'dưới'
        ];

        // Từ nhạy cảm cho phân tích nâng cao
        const sensitiveWords = {

// ⚡ Lưu ý: Các từ khóa 18+ ở trên sẽ được phát hiện trong analyzeSensitiveContent
// Sau đó sẽ được dùng để bổ sung logic vào generateSentence() và generateParagraph(),
// giúp truyện sinh ra logic, thuần Việt và phù hợp bối cảnh (không nhồi nhét vô lý).
// Hệ thống có thể "học lại" từ dữ liệu phân tích để lần sau viết tốt hơn.

            romantic: ['yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'âm áp', 'say đắm', 'đam mê', 'dịu dàng', 'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi'],
            sexual: [
        // Nhẹ / gợi tình
        'gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục',
        'dâm', 'dục', 'khoái cảm', 'kích thích', 'khoả thân', 'lõa thể',
        'sướng', 'rên rỉ', 'nứng', 'ướt át', 'cao trào', 'cực khoái', 'xuất tinh',
        'dương vật', 'cặc', 'buồi', 'chim', 'cái ấy',
        'âm đạo', 'lồn', 'bướm', 'âm hộ', 'hột le', 'mu', 'lỗ', 'xoạc',
        'bú vú', 'vú to', 'vú căng', 'bú mút', 'ngực trần', 'ngực khủng', 'đầu ti',
        
        // Thô tục / trực tiếp
        'bú lồn', 'bú cặc', 'liếm lồn', 'liếm bi', 'nuốt tinh', 'bú hột le', 'bú đầu cặc',
        'tử cung', 'bắn vào tử cung', 'cặc dài 20cm', 'ngậm tinh', 'chịch', 'địt', 'nắc',
        'thổi kèn', 'bj', 'hj', 'anal', 'doggy', '69', 'threesome', 'thủ dâm',
        'chơi gái', 'đĩ', 'gái mại dâm', 'mông to', 'thụt ra thụt vào', 'cắm sâu',
        
        // Biến thể thường gặp
        'sờ soạng', 'mút', 'cắn', 'xoa', 'vuốt ve', 'húp sò', 'phê', 'nghiện sex',
        'xoạc lồn', 'xoạc cặc', 'tra tấn tình dục', 'hành xác', 'chịu trận',
        'nhét', 'đút', 'làm nhục', 'bóp vú', 'tét đít', 'vỗ mông', 'túm tóc',
        
        // Mạnh bạo
        'bạo dâm', 'cưỡng hiếp', 'hiếp dâm', 'loạn luân', 'thằng cha', 'ông già dâm đãng',
        'con đĩ', 'con cave', 'chị dâu', 'em dâu', 'anh rể', 'chị gái', 'mẹ chồng', 'cha con', 'mẹ con',
        
        // Biểu đạt cực khoái
        'rên la', 'rên rỉ', 'hét lên vì sướng', 'mắt lờ đờ', 'mồ hôi nhễ nhại',
        'bắn tinh', 'phun tinh', 'tinh dịch', 'tinh tràn', 'nuốt sạch tinh',
        'mùi tanh', 'vị mặn', 'ướt đẫm', 'nước nhờn', 'dịch nhờn'
    ],
            negative: ['ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi', 'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung'],
            family: ['bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà', 'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ'],
            secret: ['bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm', 'lặng lẽ', 'kín đáo', 'riêng tư']
        };

        const emotionalWords = {
            positive: ['vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 'thành công', 'hy vọng'],
            negative: ['buồn', 'đau', 'khổ', 'tệ', 'xấu', 'thất bại', 'tuyệt vọng', 'ghét', 'tức giận', 'lo lắng', 'sợ hãi', 'khóc', 'tang thương', 'bất hạnh', 'dối trá', 'phản bội', 'lừa dối', 'xót xa', 'đau đớn', 'xấu hổ', 'tủi nhục'],
            neutral: ['bình thường', 'thông thường', 'trung bình', 'ổn', 'được', 'tạm ổn']
        };

        // Từ khóa đặc biệt cho phân tích hội thoại
        const dialogueIndicators = ['nói', 'bảo', 'hỏi', 'đáp', 'thưa', 'kêu', 'gọi', 'hét', 'la', 'thét', 'thì thầm', 'rủ rỉ', 'lên tiếng', 'phát biểu', 'trả lời', 'hỏi lại', 'đáp lại'];
        const dialoguePunctuation = ['"', "'", ':', ';', '-', '—', '–'];

        // Initialize Google APIs
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapi_inited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gsi_inited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapi_inited && gsi_inited) {
                document.getElementById('scanBtn').disabled = false;
            }
        }

        // Authentication functions
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                await showLoggedInState();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                showLoggedOutState();
            }
        }

        async function showLoggedInState() {
            updateStatus('🟢 Đã kết nối Google Drive');
            
            document.getElementById('scanBtn').disabled = false;
            
            try {
                const response = await gapi.client.request({
    path: 'https://openidconnect.googleapis.com/v1/userinfo'
});
                // Cập nhật thông tin người dùng nếu cần
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        function showLoggedOutState() {
            updateStatus('🔴 Chưa kết nối Google Drive');
            
            const buttons = ['scanBtn', 'analyzeBtn', 'generateBtn'];
            buttons.forEach(id => document.getElementById(id).disabled = true);
        }

        // Tab switching function
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const menuItems = document.querySelectorAll('.menu-item');
            for (let item of menuItems) {
                if (item.textContent.includes(
                    tabId === 'tab-analysis' ? 'Phân tích' :
                    tabId === 'tab-write' ? 'Viết truyện' :
                    tabId === 'tab-stories' ? 'Thư viện' : 'Cài đặt'
                )) {
                    item.classList.add('active');
                    break;
                }
            }
            
            return false;
        }

        // Advanced Analysis Functions
        async function analyzeFiles() {
            if (!window.txtFiles || window.txtFiles.length === 0) {
                alert('Vui lòng quét thư mục trước khi phân tích!');
                return;
            }
            
            updateStatus('🧠 Bắt đầu phân tích nâng cao...');
            analysisData = [];
            
            const skipAnalyzed = document.getElementById('skipAnalyzedFiles').checked;
            let filesToAnalyze = window.txtFiles;
            
            if (skipAnalyzed) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `name='${ANALYSIS_CACHE_NAME}' and trashed=false`,
                        fields: 'files(id)'
                    });
                    
                    if (response.result.files.length > 0) {
                        const analysisResponse = await gapi.client.drive.files.get({
                            fileId: response.result.files[0].id,
                            alt: 'media'
                        });
                        
                        const existingAnalysis = JSON.parse(analysisResponse.body);
                        const analyzedFileNames = existingAnalysis.analysisData.map(a => a.fileName);
                        
                        filesToAnalyze = window.txtFiles.filter(file => 
                            !analyzedFileNames.includes(file.name)
                        );
                        
                        if (filesToAnalyze.length === 0) {
                            updateStatus('✅ Tất cả file đã được phân tích trước đó');
                            analysisData = existingAnalysis.analysisData;
                            displayAdvancedAnalysisResults();
                            document.getElementById('generateBtn').disabled = false;
                            return;
                        }
                        
                        analysisData = existingAnalysis.analysisData;
                        updateStatus(`🔍 Bỏ qua ${window.txtFiles.length - filesToAnalyze.length} file đã phân tích, tiếp tục với ${filesToAnalyze.length} file mới`);
                    }
                } catch (error) {
                    console.log('No existing analysis found or error loading it, analyzing all files');
                }
            }
            
            const totalFiles = Math.min(filesToAnalyze.length, 50);
            
            for (let i = 0; i < totalFiles; i++) {
                const file = filesToAnalyze[i];
                updateProgress((i / totalFiles) * 100);
                updateStatus(`🧠 Đang phân tích: ${file.name} (${i+1}/${totalFiles})`);
                updateDetailedStatus(`Phân tích hội thoại và từ nhạy cảm...`);
                
                try {
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    
                    const content = response.body;
                    const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
                    analysisData.push(analysis);
                    
                    if (document.getElementById('autoSaveResults').checked) {
                        await autoSaveAnalysis();
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error analyzing file ${file.name}:`, error);
                    analysisData.push({
                        fileName: file.name,
                        error: error.message
                    });
                }
            }
            
            displayAdvancedAnalysisResults();
            document.getElementById('generateBtn').disabled = false;
            updateProgress(100);
            updateStatus(`✅ Hoàn thành phân tích ${totalFiles} file`);
            updateDetailedStatus('');
            
            setTimeout(() => updateProgress(0), 2000);
        }

        async function performAdvancedAnalysis(content, fileName, folderPath) {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const analysis = {
                fileName: fileName,
                folderPath: folderPath || 'Unknown',
                timestamp: new Date().toLocaleString('vi-VN'),
                
                // Phân tích cơ bản
                basicStats: analyzeBasicStats(content),
                
                // Phân tích cảm xúc
                emotionalAnalysis: analyzeEmotionsAdvanced(content),
                
                // Phân tích chủ đề
                thematicAnalysis: analyzeThemes(content),
                
                // Phân tích nhân vật
                characterAnalysis: analyzeCharactersAdvanced(content),
                
                // Phân tích hội thoại (mới)
                dialogueAnalysis: analyzeDialogues(content),
                
                // Phân tích từ nhạy cảm (mới)
                sensitiveAnalysis: analyzeSensitiveContent(content),
                
                // Phân tích cốt truyện
                narrativeAnalysis: analyzeNarrativeStructure(content),
                
                // Mẫu nội dung
                contentSample: content.substring(0, 1000) + (content.length > 1000 ? '...' : '')
            };
            
            return analysis;
        }

        function analyzeBasicStats(content) {
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            const words = content.split(/\s+/).filter(w => w.length > 0);
            const characters = content.length;
            const charactersNoSpaces = content.replace(/\s/g, '').length;
            
            return {
                wordCount: words.length,
                sentenceCount: sentences.length,
                paragraphCount: paragraphs.length,
                characterCount: characters,
                characterCountNoSpaces: charactersNoSpaces,
                avgWordsPerSentence: Math.round(words.length / sentences.length * 10) / 10,
                avgSentencesPerParagraph: Math.round(sentences.length / paragraphs.length * 10) / 10,
                avgWordLength: Math.round(charactersNoSpaces / words.length * 10) / 10
            };
        }

        function analyzeEmotionsAdvanced(content) {
            const emotionAnalysis = {};
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            Object.entries(emotionalWords).forEach(([category, words]) => {
                const mentions = words.reduce((count, word) => {
                    return count + (content.toLowerCase().match(new RegExp(word, 'g')) || []).length;
                }, 0);
                emotionAnalysis[category] = {
                    count: mentions,
                    percentage: ((mentions / sentences.length) * 100).toFixed(1) + '%'
                };
            });
            
            return {
                overallTone: determineOverallTone(emotionAnalysis),
                emotionBreakdown: emotionAnalysis,
                sentimentScore: calculateSentimentScore(emotionAnalysis)
            };
        }

        function analyzeThemes(content) {
            const themeKeywords = {
                'Tình yêu': ['yêu', 'thương', 'yêu thương', 'tình cảm', 'lãng mạn', 'tim', 'trái tim', 'hôn', 'ôm'],
                'Gia đình': ['gia đình', 'bố', 'mẹ', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'ông bà', 'nhà'],
                'Phản bội': ['phản bội', 'lừa dối', 'dối trá', 'lừa lọc', 'lừa gạt', 'phản', 'bội tín'],
                'Đau khổ': ['đau', 'khổ', 'đau khổ', 'buồn', 'sầu', 'thảm', 'bi', 'tang', 'xót', 'tủi'],
                'Bí mật': ['bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm']
            };
            
            const themes = [];
            Object.entries(themeKeywords).forEach(([theme, keywords]) => {
                const mentions = keywords.reduce((count, keyword) => {
                    return count + (content.toLowerCase().match(new RegExp(keyword, 'g')) || []).length;
                }, 0);
                if (mentions > 0) {
                    themes.push({
                        theme: theme,
                        mentions: mentions,
                        relevance: mentions
                    });
                }
            });
            
            return {
                mainThemes: themes.sort((a, b) => b.relevance - a.relevance).slice(0, 5),
                thematicComplexity: themes.length > 3 ? 'Phức tạp' : 'Đơn giản'
            };
        }

        function analyzeCharactersAdvanced(content) {
            const characters = [];
            const namePattern = /\b[A-ZÀ-Ỹ][a-zà-ỹ]{2,15}(?:\s[A-ZÀ-Ỹ][a-zà-ỹ]{2,15})*\b/g;
            const potentialNames = content.match(namePattern) || [];
            
            const nameCounts = {};
            potentialNames.forEach(name => {
                if (name.length > 2 && name.length < 30) {
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                }
            });
            
            Object.entries(nameCounts)
                .filter(([name, count]) => count >= 2)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .forEach(([name, count]) => {
                    characters.push({
                        name: name,
                        appearances: count,
                        importance: count > 5 ? 'Chính' : count > 2 ? 'Phụ' : 'Nền'
                    });
                });
            
            return {
                characterCount: characters.length,
                characters: characters
            };
        }

        // PHÂN TÍCH HỘI THOẠI MỚI
        function analyzeDialogues(content) {
            const dialogues = [];
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            for (const sentence of sentences) {
                // Tìm các chỉ báo hội thoại
                const hasDialogueIndicator = dialogueIndicators.some(indicator => 
                    sentence.toLowerCase().includes(indicator)
                );
                
                // Tìm các dấu hiệu trích dẫn
                const hasQuotes = dialoguePunctuation.some(punct => 
                    sentence.includes(punct)
                );
                
                if (hasDialogueIndicator || hasQuotes) {
                    // Trích xuất hội thoại tiềm năng
                    const potentialDialogue = extractDialogue(sentence);
                    if (potentialDialogue) {
                        dialogues.push({
                            text: potentialDialogue,
                            length: potentialDialogue.length,
                            hasQuotes: hasQuotes,
                            hasIndicator: hasDialogueIndicator
                        });
                    }
                }
            }
            
            return {
                dialogueCount: dialogues.length,
                dialogues: dialogues.slice(0, 10), // Giới hạn số lượng
                dialoguePercentage: ((dialogues.length / sentences.length) * 100).toFixed(1) + '%'
            };
        }

        function extractDialogue(sentence) {
            // Tìm văn bản trong ngoặc kép
            const quotedText = sentence.match(/["'](.*?)["']/);
            if (quotedText && quotedText[1].length > 5) {
                return quotedText[1];
            }
            
            // Tìm văn bản sau dấu hai chấm
            const colonIndex = sentence.indexOf(':');
            if (colonIndex !== -1 && colonIndex < sentence.length - 5) {
                return sentence.substring(colonIndex + 1).trim();
            }
            
            // Tìm văn bản sau các từ chỉ hội thoại
            for (const indicator of dialogueIndicators) {
                const indicatorIndex = sentence.toLowerCase().indexOf(indicator);
                if (indicatorIndex !== -1) {
                    const afterIndicator = sentence.substring(indicatorIndex + indicator.length);
                    if (afterIndicator.length > 5) {
                        // Tìm phần trích dẫn trong đoạn sau
                        const nextQuote = afterIndicator.match(/["'](.*?)["']/);
                        if (nextQuote) return nextQuote[1];
                        
                        // Hoặc trả về toàn bộ phần sau
                        return afterIndicator.trim();
                    }
                }
            }
            
            return null;
        }

        // PHÂN TÍCH TỪ NHẠY CẢM MỚI
        function analyzeSensitiveContent(content) {
            const sensitiveResults = {};
            let totalSensitiveWords = 0;
            
            for (const [category, words] of Object.entries(sensitiveWords)) {
                const foundWords = {};
                
                for (const word of words) {
                    const regex = new RegExp(word, 'gi');
                    const matches = content.match(regex);
                    if (matches) {
                        foundWords[word] = matches.length;
                        totalSensitiveWords += matches.length;
                    }
                }
                
                if (Object.keys(foundWords).length > 0) {
                    sensitiveResults[category] = {
                        words: foundWords,
                        count: Object.values(foundWords).reduce((a, b) => a + b, 0)
                    };
                }
            }
            
            return {
                totalSensitiveWords: totalSensitiveWords,
                categories: sensitiveResults,
                sensitivityScore: calculateSensitivityScore(totalSensitiveWords, content.length)
            };
        }

        function calculateSensitivityScore(sensitiveWordCount, totalCharacters) {
            if (totalCharacters === 0) return 0;
            const ratio = (sensitiveWordCount / (totalCharacters / 1000)); // Số từ nhạy cảm trên 1000 ký tự
            return Math.min(10, Math.round(ratio * 10) / 10); // Trả về điểm từ 0-10
        }

        function analyzeNarrativeStructure(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim());
            const totalLength = content.split(/\s+/).length;
            
            return {
                structure: analyzeThreeActStructure(paragraphs, totalLength),
                pacing: analyzePacing(paragraphs),
                climax: identifyClimax(content)
            };
        }

        function analyzeThreeActStructure(paragraphs, totalLength) {
            const act1End = Math.floor(paragraphs.length * 0.25);
            const act2End = Math.floor(paragraphs.length * 0.75);
            
            return {
                act1: {
                    paragraphs: act1End,
                    percentage: '25%',
                    description: 'Mở đầu, giới thiệu'
                },
                act2: {
                    paragraphs: act2End - act1End,
                    percentage: '50%',
                    description: 'Phát triển, xung đột'
                },
                act3: {
                    paragraphs: paragraphs.length - act2End,
                    percentage: '25%',
                    description: 'Cao trào, kết thúc'
                }
            };
        }

        function analyzePacing(paragraphs) {
            const avgParagraphLength = paragraphs.reduce((sum, p) => sum + p.split(/\s+/).length, 0) / paragraphs.length;
            
            return {
                averageParagraphLength: Math.round(avgParagraphLength),
                pacing: avgParagraphLength > 100 ? 'Chậm' : avgParagraphLength > 50 ? 'Vừa phải' : 'Nhanh'
            };
        }

        function identifyClimax(content) {
            const climaxIndicators = ['đột nhiên', 'bất ngờ', 'lúc này', 'cuối cùng', 'quyết định', 'quan trọng nhất'];
            const sentences = content.split(/[.!?]+/);
            
            let climaxSentence = '';
            let maxIndicators = 0;
            
            sentences.forEach(sentence => {
                const indicatorCount = climaxIndicators.reduce((count, indicator) => {
                    return count + (sentence.toLowerCase().includes(indicator) ? 1 : 0);
                }, 0);
                
                if (indicatorCount > maxIndicators && sentence.trim().length > 20) {
                    maxIndicators = indicatorCount;
                    climaxSentence = sentence.trim();
                }
            });
            
            return {
                identified: climaxSentence.length > 0,
                sentence: climaxSentence.substring(0, 200) + (climaxSentence.length > 200 ? '...' : ''),
                indicators: maxIndicators
            };
        }

        function determineOverallTone(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const neutral = emotionAnalysis.neutral?.count || 0;
            
            if (positive > negative && positive > neutral) return 'Tích cực';
            if (negative > positive && negative > neutral) return 'Tiêu cực';
            return 'Trung tính';
        }

        function calculateSentimentScore(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const total = positive + negative;
            
            if (total === 0) return 0;
            return ((positive - negative) / total * 100).toFixed(1);
        }

        // Story Generation Functions - Nâng cao với dữ liệu phân tích
        async function generateStories() {
            if (analysisData.length === 0) {
                alert('Vui lòng phân tích file trước khi tạo truyện!');
                return;
            }
            
            updateWriteStatus('✍️ Bắt đầu viết truyện...', 'Chuẩn bị dữ liệu và ý tưởng');
            updateWriteProgress(5);
            
            try {
                const minChapters = parseInt(document.getElementById('minChapters').value) || 50;
                const sensitivityLevel = parseInt(document.getElementById('sensitivityLevel').value) || 5;
                
                const storyTitle = generateStoryTitle(analysisData);
                updateWriteStatus(`📖 Đang viết: "${storyTitle}"`, `Kế hoạch ${minChapters} chương`);
                updateWriteProgress(10);
                
                const mainPlot = generateMainPlot(analysisData);
                
                const chapters = [];
                for (let i = 1; i <= minChapters; i++) {
                    updateWriteProgress(10 + (i / minChapters) * 80);
                    updateWriteStatus(`📖 Đang viết chương ${i}/${minChapters}`, `"${storyTitle}"`);
                    
                    const chapterTitle = generateChapterTitle(i, mainPlot, analysisData);
                    const chapterContent = generateChapterContent(i, chapterTitle, mainPlot, analysisData, sensitivityLevel);
                    
                    chapters.push({
                        number: i,
                        title: chapterTitle,
                        content: chapterContent,
                        wordCount: chapterContent.split(/\s+/).length
                    });
                    
                    if (document.getElementById('autoSaveResults').checked && i % 5 === 0) {
                        await autoSaveStory({
                            title: storyTitle,
                            chapters: chapters,
                            generatedAt: new Date().toISOString(),
                            basedOnAnalysis: analysisData.length
                        });
                    }
                    
                    if (i === 1 || i % 10 === 0 || i === minChapters) {
                        displayLatestChapter(storyTitle, chapters[chapters.length - 1]);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const generatedStory = {
                    title: storyTitle,
                    chapters: chapters,
                    generatedAt: new Date().toISOString(),
                    basedOnAnalysis: analysisData.length,
                    totalWords: chapters.reduce((sum, ch) => sum + ch.wordCount, 0)
                };
                
                generatedStories.push(generatedStory);
                
                displayGeneratedStories();
                
                updateWriteProgress(95);
                updateWriteStatus(`✅ Đã hoàn thành: "${storyTitle}"`, `${minChapters} chương, ${generatedStory.totalWords} từ`);
                
                updateWriteProgress(100);
                
                setTimeout(() => updateWriteProgress(0), 2000);
                
            } catch (error) {
                console.error('Error generating stories:', error);
                updateWriteStatus(`❌ Lỗi khi viết truyện: ${error.message}`, '');
                updateWriteProgress(0);
            }
        }

        function generateStoryTitle(analysisData) {
            const titleTemplates = [
                `Bóng Tối Trong Gia Đình`,
                `Mối Tình Oan Nghiệt`,
                `Sự Thật Đau Lòng Sau Cánh Cửa`,
                `Người Cha Và Con Dâu`,
                `Mất Mát Trong Im Lặng`,
                `Trái Tim Người Chồng`,
                `Mối Tình Cấm Đoán`,
                `Những Giấu Giếm Đau Đớn`,
                `Sự Phản Bội Thầm Lặng`,
                `Gia Đình Không Trọn Vẹn`
            ];
            
            return titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
        }

        function generateMainPlot(analysisData) {
            const emotionalTone = determineOverallEmotionalToneFromAnalysis(analysisData);
            const commonThemes = findCommonThemes(analysisData);
            const commonCharacters = findCommonCharacters(analysisData);
            
            return {
                themes: commonThemes.slice(0, 3),
                mainCharacters: commonCharacters.slice(0, 2),
                emotionalTone: emotionalTone,
                conflict: {
                    type: 'tình cảm gia đình',
                    intensity: 'cao',
                    resolution: 'không trọn vẹn'
                },
                sensitivity: calculateAverageSensitivity(analysisData)
            };
        }

        function determineOverallEmotionalToneFromAnalysis(analysisData) {
            let positive = 0, negative = 0, neutral = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    positive += analysis.emotionalAnalysis.emotionBreakdown.positive?.count || 0;
                    negative += analysis.emotionalAnalysis.emotionBreakdown.negative?.count || 0;
                    neutral += analysis.emotionalAnalysis.emotionBreakdown.neutral?.count || 0;
                }
            });
            
            if (negative > positive && negative > neutral) return 'negative';
            if (positive > negative && positive > neutral) return 'positive';
            return 'neutral';
        }

        function findCommonThemes(analysisData) {
            const allThemes = {};
            analysisData.forEach(analysis => {
                if (analysis.thematicAnalysis && analysis.thematicAnalysis.mainThemes) {
                    analysis.thematicAnalysis.mainThemes.forEach(theme => {
                        allThemes[theme.theme] = (allThemes[theme.theme] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allThemes)
                .sort(([,a], [,b]) => b - a)
                .map(([theme]) => theme);
        }

        function findCommonCharacters(analysisData) {
            const allCharacters = {};
            analysisData.forEach(analysis => {
                if (analysis.characterAnalysis && analysis.characterAnalysis.characters) {
                    analysis.characterAnalysis.characters.forEach(character => {
                        allCharacters[character.name] = (allCharacters[character.name] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allCharacters)
                .sort(([,a], [,b]) => b - a)
                .map(([character]) => character);
        }

        function calculateAverageSensitivity(analysisData) {
            let totalSensitivity = 0;
            let count = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis) {
                    totalSensitivity += analysis.sensitiveAnalysis.sensitivityScore || 0;
                    count++;
                }
            });
            
            return count > 0 ? totalSensitivity / count : 0;
        }

        function generateChapterTitle(chapterNumber, mainPlot, analysisData) {
            const chapterTemplates = [
                `Khúc Dạo Đầu Buồn`,
                `Những Nghi Ngờ Đầu Tiên`,
                `Dấu Hiệu Của Sự Dối Trá`,
                `Cuộc Chạm Trán Bất Ngờ`,
                `Sự Thật Phũ Phàng`,
                `Nỗi Đau Không Thể Nói Thành Lời`,
                `Lựa Chọn Khó Khăn`,
                `Sống Trong Dối Trá`,
                `Khoảnh Khắc Yếu Lòng`,
                `Im Lặng Là Vàng`,
                `Trái Tim Tan Vỡ`,
                `Ngày Tháng Dài Đằng Đẵng`,
                `Quyết Định Cuối Cùng`,
                `Lời Từ Biệt Không Lời`,
                `Bình Minh Cô Đơn`
            ];
            
            const templateIndex = chapterNumber % chapterTemplates.length;
            return `Chương ${chapterNumber}: ${chapterTemplates[templateIndex]}`;
        }

        function generateChapterContent(chapterNumber, chapterTitle, mainPlot, analysisData, sensitivityLevel) {
            let content = `# ${chapterTitle}\n\n`;
            
            const paragraphs = 8 + Math.floor(Math.random() * 6);
            
            for (let i = 0; i < paragraphs; i++) {
                content += generateParagraph(chapterNumber, i, paragraphs, mainPlot, analysisData, sensitivityLevel) + '\n\n';
            }
            
            return content;
        }

        function generateParagraph(chapterNumber, paragraphIndex, totalParagraphs, mainPlot, analysisData, sensitivityLevel) {
            const sentences = 3 + Math.floor(Math.random() * 3);
            let paragraph = '';
            
            for (let i = 0; i < sentences; i++) {
                paragraph += generateSentence(chapterNumber, paragraphIndex, totalParagraphs, i, sentences, mainPlot, analysisData, sensitivityLevel);
                if (i < sentences - 1) paragraph += ' ';
            }
            
            return paragraph;
        }

        function generateSentence(chapterNumber, paragraphIndex, totalParagraphs, sentenceIndex, totalSentences, mainPlot, analysisData, sensitivityLevel) {
            // Lấy các từ nhạy cảm từ phân tích
            const sensitiveWordsList = extractSensitiveWordsFromAnalysis(analysisData);
            
            // Mẫu câu cơ bản
            const sentenceTemplates = [
                `Tôi nhìn thấy ${mainPlot.mainCharacters[0] || 'bố'} và ${mainPlot.mainCharacters[1] || 'vợ tôi'} trao đổi ánh mắt mà không dám lên tiếng.`,
                `Trái tim tôi đau nhói khi chứng kiến cảnh tượng đó nhưng không thể làm gì.`,
                `Mỗi lần thấy họ gần nhau, lòng tôi lại quặn thắt vì ghen tuông và tủi nhục.`,
                `Tôi tự hỏi mình đã làm gì sai để phải chịu đựng sự phản bội này.`,
                `Đêm nay lại một đêm dài trằn trọc với những suy nghĩ miên man.`,
                `Tôi muốn hét lên cho cả thế giới biết sự thật, nhưng lại im lặng.`,
                `Gia đình - hai tiếng ấy giờ đây trở nên thật xa lạ và giả dối.`,
                `Tôi thấy mình thật bất lực, không dám đối mặt với sự thật phũ phàng.`,
                `Nụ cười của vợ tôi với bố tôi sao có thể tươi đến thế, còn với tôi thì không?`,
                `Tôi tự dằn vặt bản thân, có phải mình đã quá vô tâm với vợ?`,
                `Nhưng không, tôi biết rõ ai là người có lỗi trong chuyện này.`,
                `Im lặng có phải là vàng? Hay tôi chỉ đang hèn nhát không dám đối diện?`,
                `Mỗi ngày trôi qua là một ngày tôi phải diễn những vở kịch không có hồi kết.`,
                `Tôi muốn trốn chạy khỏi tất cả, nhưng không biết phải đi đâu.`,
                `Liệu có ai hiểu được nỗi lòng của một người chồng trong hoàn cảnh của tôi?`
            ];
            
            // Chọn mẫu
            const templateIndex = (chapterNumber + paragraphIndex + sentenceIndex) % sentenceTemplates.length;
            let sentence = sentenceTemplates[templateIndex];
            
            // Thêm từ nhạy cảm nếu có và nếu độ nhạy cảm đủ cao
if (sensitiveWordsList.length > 0 && sensitivityLevel >= 7) {
    const sensitiveWord = sensitiveWordsList[Math.floor(Math.random() * sensitiveWordsList.length)];
    sentence = sentence.replace('.', ` ${sensitiveWord}.`);
}

const shouldAddSensitive = Math.random() < (sensitivityLevel / 10);
if (shouldAddSensitive) {
    const sensitiveWord = sensitiveWordsList[Math.floor(Math.random() * sensitiveWordsList.length)];
    sentence = sentence.replace('.', ` ${sensitiveWord}.`);
}
            
            // Thêm hội thoại nếu có
            if (analysisData.some(a => a.dialogueAnalysis && a.dialogueAnalysis.dialogueCount > 0)) {
                const shouldAddDialogue = Math.random() < 0.3;
                if (shouldAddDialogue) {
                    const dialogueTemplate = [
                        `Bỗng tôi nghe thấy giọng nói: "Sao em có thể làm vậy với anh?"`,
                        `Tôi không thể quên được câu nói: "Chuyện này đừng để ai biết."`,
                        `Giọng nói thì thầm: "Anh yêu em, nhưng không thể tiếp tục được."`,
                        `Tôi nghe rõ mồn một: "Đây là lần cuối cùng, tôi hứa."`
                    ];
                    const dialogue = dialogueTemplate[Math.floor(Math.random() * dialogueTemplate.length)];
                    sentence += ' ' + dialogue;
                }
            }
            
            return sentence;
        }

        function extractSensitiveWordsFromAnalysis(analysisData) {
            const words = [];
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis && analysis.sensitiveAnalysis.categories) {
                    for (const category of Object.values(analysis.sensitiveAnalysis.categories)) {
                        for (const word of Object.keys(category.words)) {
                            if (!words.includes(word)) {
                                words.push(word);
                            }
                        }
                    }
                }
            });
            
            return words;
        }

        // UI Update Functions
        function updateStatus(message) {
            document.getElementById('statusInfo').innerHTML = `<p>${message}</p>`;
        }

        function updateDetailedStatus(message) {
            document.getElementById('detailedStatus').textContent = message;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function updateWriteStatus(message, detail) {
            document.getElementById('writeStatus').textContent = message;
            document.getElementById('writeDetailedStatus').textContent = detail;
        }

        function updateWriteProgress(percent) {
            document.getElementById('writeProgressBar').style.width = percent + '%';
        }

        function displayAdvancedAnalysisResults() {
            const container = document.getElementById('analysisResults');
            container.innerHTML = '';
            
            if (analysisData.length === 0) {
                container.innerHTML = '<p>Chưa có dữ liệu phân tích.</p>';
                return;
            }
            
            // Phân tích tổng quan
            let emotionalScore = 0;
            let themeCount = 0;
            let dialogueCount = 0;
            let sensitiveWordCount = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    emotionalScore += parseFloat(analysis.emotionalAnalysis.sentimentScore) || 0;
                }
                if (analysis.thematicAnalysis) {
                    themeCount += analysis.thematicAnalysis.mainThemes.length;
                }
                if (analysis.dialogueAnalysis) {
                    dialogueCount += analysis.dialogueAnalysis.dialogueCount || 0;
                }
                if (analysis.sensitiveAnalysis) {
                    sensitiveWordCount += analysis.sensitiveAnalysis.totalSensitiveWords || 0;
                }
            });
            
            emotionalScore = (emotionalScore / analysisData.length).toFixed(1);
            
            container.innerHTML = `
                <div class="status-info">
                    <p>📊 Tổng quan phân tích</p>
                    <p>Điểm cảm xúc: ${emotionalScore}%</p>
                    <p>Số chủ đề phát hiện: ${themeCount}</p>
                    <p>Hội thoại phát hiện: ${dialogueCount}</p>
                    <p>Từ nhạy cảm: ${sensitiveWordCount}</p>
                    <p>Số file đã phân tích: ${analysisData.length}</p>
                </div>
            `;
            
            // Hiển thị các cảm xúc chính
            const emotionalThemes = analysisData.flatMap(a => 
                a.emotionalAnalysis ? [a.emotionalAnalysis.overallTone] : []
            );
            
            const emotionalCounts = emotionalThemes.reduce((acc, tone) => {
                acc[tone] = (acc[tone] || 0) + 1;
                return acc;
            }, {});
            
            let emotionalHTML = '<p>Cảm xúc chủ đạo:</p>';
            for (const [tone, count] of Object.entries(emotionalCounts)) {
                emotionalHTML += `<span class="emotion-tag">${tone} (${count})</span>`;
            }
            
            container.innerHTML += emotionalHTML;
            
            // Hiển thị từ nhạy cảm
            const sensitiveWords = extractSensitiveWordsFromAnalysis(analysisData);
            if (sensitiveWords.length > 0) {
                container.innerHTML += `<p>Từ nhạy cảm phát hiện: ${sensitiveWords.slice(0, 10).join(', ')}${sensitiveWords.length > 10 ? '...' : ''}</p>`;
            }
            
            // Hiển thị mẫu hội thoại
            const sampleDialogues = [];
            analysisData.forEach(analysis => {
                if (analysis.dialogueAnalysis && analysis.dialogueAnalysis.dialogues) {
                    analysis.dialogueAnalysis.dialogues.forEach(dialogue => {
                        if (sampleDialogues.length < 3) {
                            sampleDialogues.push(dialogue.text);
                        }
                    });
                }
            });
            
            if (sampleDialogues.length > 0) {
                container.innerHTML += `<p>Mẫu hội thoại:</p>`;
                sampleDialogues.forEach(dialogue => {
                    container.innerHTML += `<div class="dialogue">"${dialogue}"</div>`;
                });
            }
        }

        function displayLatestChapter(storyTitle, chapter) {
            const container = document.getElementById('generatedStories');
            container.innerHTML = `
                <div class="story-content">
                    <div class="chapter-title">${storyTitle} - ${chapter.title}</div>
                    <div>${chapter.content.substring(0, 300)}...</div>
                    <p><i>${chapter.wordCount} từ</i></p>
                </div>
            `;
        }

        function displayGeneratedStories() {
            const container = document.getElementById('generatedStories');
            
            if (generatedStories.length === 0) {
                container.innerHTML = '<p>Chưa có truyện nào được tạo.</p>';
                return;
            }
            
            const story = generatedStories[generatedStories.length - 1];
            const latestChapter = story.chapters[story.chapters.length - 1];
            
            container.innerHTML = `
                <div class="story-content">
                    <div class="chapter-title">${story.title} - ${latestChapter.title}</div>
                    <div>${latestChapter.content.substring(0, 500)}...</div>
                    <p><i>Chương ${story.chapters.length}/${story.chapters.length} • ${story.totalWords} từ</i></p>
                </div>
                <button class="btn btn-success" onclick="saveToGoogleDrive()">
                    💾 Lưu truyện
                </button>
            `;
        }

        // Các hàm utility khác
        async function scanFolder() {
            updateStatus('🔍 Đang quét thư mục QuanLyTruyen...');
            updateDetailedStatus('Đang tìm kiếm tất cả file .txt trong thư mục và thư mục con...');

            try {
                const response = await gapi.client.drive.files.list({
                    q: "name contains 'QuanLyTruyen' and mimeType = 'application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                });

                if (response.result.files.length === 0) {
                    updateStatus('❌ Không tìm thấy thư mục "QuanLyTruyen" trong Google Drive');
                    return;
                }

                const rootFolderId = response.result.files[0].id;
                window.txtFiles = [];

                async function listFilesInFolder(folderId, folderPath = '') {
                    const res = await gapi.client.drive.files.list({
                        q: `'${folderId}' in parents and trashed=false`,
                        fields: 'files(id, name, mimeType)'
                    });

                    for (const file of res.result.files) {
                        if (file.mimeType === 'application/vnd.google-apps.folder') {
                            await listFilesInFolder(file.id, folderPath + '/' + file.name);
                        } else if (file.name.endsWith('.txt')) {
                            window.txtFiles.push({
                                id: file.id,
                                name: file.name,
                                folderPath: folderPath
                            });
                        }
                    }
                }

                await listFilesInFolder(rootFolderId, 'QuanLyTruyen');

                if (window.txtFiles.length === 0) {
                    updateStatus('⚠️ Không tìm thấy file .txt nào trong thư mục');
                } else {
                    updateStatus(`✅ Đã quét ${window.txtFiles.length} file .txt`);
                    document.getElementById('analyzeBtn').disabled = false;

                    // Lưu cache
                    if (document.getElementById('autoSaveResults').checked) {
                        await gapi.client.request({
                            path: '/upload/drive/v3/files',
                            method: 'POST',
                            params: { uploadType: 'media' },
                            body: JSON.stringify({ txtFiles: window.txtFiles }),
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                }

            } catch (error) {
                console.error('Error scanning folder:', error);
                updateStatus('❌ Lỗi khi quét thư mục: ' + error.message);
            }
        }

        async function saveToGoogleDrive() {
            updateWriteStatus('💾 Đang lưu truyện...', '');
            // Triển khai lưu truyện
        }

        async function autoSaveAnalysis() {
            try {
                // Kiểm tra file phân tích đã tồn tại trên Drive chưa
                const response = await gapi.client.drive.files.list({
                    q: `name='${ANALYSIS_CACHE_NAME}' and trashed=false`,
                    fields: 'files(id, name)'
                });

                let fileId;
                if (response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                    // Cập nhật file cũ
                    await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        body: JSON.stringify({ analysisData }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                } else {
                    // Tạo file mới
                    const createResponse = await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'media' },
                        body: JSON.stringify({ analysisData }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    fileId = createResponse.result.id;
                }

                console.log('✅ Analysis auto-saved to Google Drive:', fileId);
            } catch (error) {
                console.error('❌ Error auto-saving analysis:', error);
            }
        }

        async function autoSaveStory(story) {
            try {
                // Kiểm tra file truyện đã tồn tại chưa
                const response = await gapi.client.drive.files.list({
                    q: `name='${STORY_CACHE_NAME}' and trashed=false`,
                    fields: 'files(id, name)'
                });

                let fileId;
                if (response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                    await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        body: JSON.stringify(story),
                        headers: { 'Content-Type': 'application/json' }
                    });
                } else {
                    const createResponse = await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'media' },
                        body: JSON.stringify(story),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    fileId = createResponse.result.id;
                }

                console.log('✅ Story auto-saved to Google Drive:', fileId);
            } catch (error) {
                console.error('❌ Error auto-saving story:', error);
            }
        }

        async function clearCache() {
            if (confirm('Bạn có chắc chắn muốn xóa dữ liệu tạm?')) {
                updateStatus('🗑️ Đang xóa dữ liệu tạm...');
                // Triển khai xóa cache
            }
        }

        async function loadStories() {
            updateStatus('📚 Đang tải danh sách truyện...');
            // Triển khai tải truyện
        }

        // Initialize when page loads
        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            }
            
            updateStatus('🔴 Chưa kết nối Google Drive');
            
            // Cập nhật giá trị độ nhạy cảm
            document.getElementById('sensitivityLevel').addEventListener('input', function() {
                document.getElementById('sensitivityValue').textContent = this.value;
            });
        };
    </script>
</body>
</html>
