<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Thêm style cho cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Style cho tính năng đánh giá */
        .rating-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }
        
        .rating-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rating-btn.like {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .rating-btn.dislike {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
        }
        
        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Style cho giao diện đọc truyện */
        .reader-mode {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            line-height: 1.8;
            font-size: 18px;
            text-align: justify;
        }
        
        .reader-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .chapter-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Style cho lịch sử đọc */
        .reading-history-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .history-info {
            flex: 1;
            min-width: 200px;
        }
        
        .continue-reading-btn {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* Cải tiến giao diện trên mobile */
        @media (max-width: 768px) {
            .reader-content {
                padding: 15px;
                font-size: 16px;
            }
            
            .rating-section {
                flex-direction: column;
            }
            
            .reader-controls, .chapter-nav {
                flex-direction: column;
            }
            
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
            .chapter-actions { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(102, 126, 234, 0.7); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager - Bố Chồng Con Dâu</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chuyên đề Bố Chồng Con Dâu</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI - Chuyên đề Bố Chồng Con Dâu</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>Tổng số file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Đã huấn luyện:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Từ vựng học được:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Tâm lý nhân vật:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Tình huống quan hệ:</span>
                                <span id="relationshipScenes">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Mâu thuẫn gia đình:</span>
                                <span id="familyConflicts">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động - Bố Chồng Con Dâu</h2>
                        
                        <div class="adult-warning">
                            ⚠️ CẢNH BÁO: Nội dung 18+ - AI sẽ tạo truyện theo ngôi thứ nhất (người chồng) kể về mối quan hệ giữa bố chồng và con dâu (vợ mình)
                        </div>
                        
                        <div class="form-group">
                            <label for="storyTheme">Chọn chủ đề chính:</label>
                            <select id="storyTheme">
                                <option value="psychological">Tâm lý - Tình cảm phức tạp</option>
                                <option value="forbidden">Cấm kỵ - Mối quan hệ bí mật</option>
                                <option value="familyDrama">Gia đình - Mâu thuẫn nội tâm</option>
                                <option value="emotional">Cảm xúc - Diễn biến tâm trạng</option>
                                <option value="fullJourney">Hành trình đầy đủ từ đầu đến cuối</option>
                            </select>
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (10-50)" min="10" max="50" value="20">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới - Chủ đề Bố Chồng Con Dâu</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                           <div class="form-group">
                                <label for="storyContent">Nội dung (kể từ ngôi thứ nhất - người chồng):</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>📚 Lịch sử Đọc Truyện</h2></div>
                            <div class="history-list" id="readingHistoryList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI - Bố Chồng Con Dâu</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" id="editChapterBtn">✏️ Sửa Chương</button>
                <button class="btn danger" id="deleteChapterBtn">🗑️ Xóa Chương</button>
                <button class="btn" id="saveChapterBtn" style="display: none;">💾 Lưu Thay Đổi</button>
                <button class="btn" id="cancelEditBtn" style="display: none;">❌ Hủy</button>
            </div>
        </div>
    </div>

    <!-- Giao diện đọc truyện -->
    <div id="readerMode" class="reader-mode">
        <div class="reader-header">
            <h2 id="readerTitle">Tiêu đề truyện</h2>
            <button class="btn danger" id="closeReaderBtn">✖ Đóng</button>
        </div>
        
        <div class="reader-content" id="readerContent">
            <!-- Nội dung truyện sẽ được hiển thị ở đây -->
        </div>
        
        <div class="rating-section" id="ratingSection">
            <p>Bạn thấy chương này như thế nào?</p>
            <button class="rating-btn like" id="rateChapterGood">👍 Truyện hay</button>
            <button class="rating-btn dislike" id="rateChapterBad">👎 Truyện chưa hay</button>
        </div>
        
        <div class="reader-controls">
            <div class="chapter-nav">
                <button class="btn" id="prevChapterBtn">⬅ Chương trước</button>
                <span id="chapterIndicator">Chương 1/100</span>
                <button class="btn" id="nextChapterBtn">Chương sau ➡</button>
            </div>
        </div>
    </div>

<script>
// Khởi tạo các biến toàn cục
let tokenClient, gapiInited = false, gisInited = false;
let mainFolderId = null;
let storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    trainedFiles: 0,
    emotionalPatterns: new Set(),
    relationshipScenes: new Set(),
    familyConflicts: new Set(),
    processedFiles: new Set(),
    fatherInLawRelations: new Set(),
    daughterInLawRelations: new Set(),
    psychologicalStates: new Set(),
    forbiddenSituations: new Set(),
    goodSentences: new Set(),
    badSentences: new Set(),
    preferredVocabulary: {},
    avoidedVocabulary: {}
};
let aiGeneratedStories = [];
let currentEditingChapter = null;
let currentReadingStory = null;
let currentChapterIndex = 0;
let currentChaptersList = [];
let readingHistory = [];

// Từ vựng chuyên biệt cho chủ đề Bố Chồng Con Dâu
const specializedVocabulary = {
    familyRelations: ['bố chồng', 'con dâu', 'chồng', 'vợ', 'gia đình', 'họ hàng', 'mối quan hệ', 'phép tắc', 'ranh giới', 'gia đình vợ', 'nhà chồng', 'bố mẹ chồng'],
    emotions: ['căng thẳng', 'bối rối', 'ghen tị', 'tò mò', 'lo lắng', 'thèm muốn', 'khao khát', 'tội lỗi', 'xấu hổ', 'day dứt', 'dằn vặt', 'mâu thuẫn', 'giằng xé', 'đam mê', 'say đắm'],
    actions: ['quan sát', 'nhìn trộm', 'theo dõi', 'chú ý', 'phát hiện', 'để ý', 'nhận ra', 'thấy được', 'cảm nhận', 'tiếp xúc', 'va chạm', 'chạm nhẹ', 'ôm', 'hôn', 'vuốt ve'],
    innerThoughts: ['tôi nghĩ', 'trong tâm trí tôi', 'tôi tự hỏi', 'có lẽ', 'liệu rằng', 'tôi không thể tin được', 'tôi cảm thấy', 'tôi nhận ra', 'tôi muốn', 'tôi khao khát'],
    secretive: ['bí mật', 'giấu kín', 'che giấu', 'lén lút', 'thầm kín', 'kín đáo', 'âm thầm', 'không ai biết', 'sau lưng', 'vụng trộm', 'lén lút'],
    physicalDescriptions: ['đôi mắt', 'nụ cười', 'cử chỉ', 'ánh mắt', 'cách di chuyển', 'giọng nói', 'cách cười', 'mái tóc', 'làn da', 'vòng eo', 'cơ thể', 'vẻ đẹp', 'sức hút'],
    situations: ['bữa cơm gia đình', 'khi vợ đi vắng', 'cuối tuần', 'những buổi tối', 'lúc một mình', 'khi không ai chú ý', 'trong phòng ngủ', 'nhà tắm', 'phòng khách', 'bếp', 'ban công'],
    adultElements: ['ham muốn', 'dục vọng', 'khát khao', 'bí mật cấm kị', 'ranh giới mờ nhạt', 'cám dỗ', 'sự quyến rũ', 'kích thích', 'khoái cảm', 'thân thể', 'gợi cảm', 'mơn trớn'],
    psychologicalTerms: ['vô thức', 'tiềm thức', 'bản năng', 'ức chế', 'dồn nén', 'phòng thủ', 'phủ nhận', 'mặc cảm', 'ám ảnh', 'dục vọng', 'đam mê'],
    transitionWords: ['tuy nhiên', 'bên cạnh đó', 'ngoài ra', 'hơn nữa', 'đặc biệt là', 'thêm vào đó', 'mặt khác', 'một ngày nọ', 'rồi một hôm', 'theo thời gian'],
    characterNames: ['Minh', 'Hương', 'Lan', 'Hạnh', 'An', 'Bình', 'Dũng', 'Hải', 'Phương', 'Thảo', 'Nam', 'Linh', 'Ngọc', 'My'],
    locations: ['phòng khách', 'nhà bếp', 'phòng ngủ', 'phòng tắm', 'ban công', 'sân vườn', 'cầu thang', 'phòng làm việc', 'phòng ăn', 'nhà kho', 'garage'],
    timeFrames: ['sáng sớm', 'buổi trưa', 'chiều tà', 'đêm khuya', 'nửa đêm', 'rạng sáng', 'hoàng hôn', 'cuối tuần', 'ngày lễ', 'kỳ nghỉ', 'dịp Tết']
};

// Danh sách từ dừng (stop words)
const stopWords = new Set(['và', 'hoặc', 'là', 'thì', 'mà', 'nhưng', 'để', 'nên', 'vì', 'do', 'bởi', 'của', 'cho', 'với', 'từ', 'vào', 'ở', 'tại', 'trên', 'dưới', 'trong', 'ngoài', 'trước', 'sau', 'giữa', 'cùng', 'các', 'những', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín', 'mười']);

// Hàm khởi tạo ứng dụng
function init() {
    // Thiết lập các event listener
    setupEventListeners();
    
    // Khởi tạo Google API
    gapiLoaded();
    gisLoaded();
    
    // Tải dữ liệu từ localStorage
    loadStoryHistory();
    loadAIKnowledge();
    loadAIGeneratedStories();
    loadReadingHistory();
}

// Khởi tạo Google API Client
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        gapiInited = true;
        maybeEnableButtons();
    } catch (error) {
        console.error('Lỗi khởi tạo Google API:', error);
        showStatus('Lỗi khởi tạo Google API: ' + error.message, 'error');
    }
}

// Khởi tạo Google Identity Services
function gisLoaded() {
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file',
            callback: '',
        });
        gisInited = true;
        maybeEnableButtons();
    } catch (error) {
        console.error('Lỗi khởi tạo Google Identity Services:', error);
        showStatus('Lỗi khởi tạo Google Identity Services: ' + error.message, 'error');
    }
}

// Kích hoạt nút khi cả hai API đã sẵn sàng
function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

// Thiết lập các event listener
function setupEventListeners() {
    // Xác thực
    document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
    document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
    
    // Form truyện
    document.getElementById('storyForm').addEventListener('submit', saveStory);
    document.getElementById('storyMode').addEventListener('change', toggleStoryMode);
    
    // Huấn luyện AI
    document.getElementById('trainAiButton').addEventListener('click', trainAI);
    document.getElementById('resetAiButton').addEventListener('click', resetAI);
    
    // Tạo truyện AI
    document.getElementById('generateStoryButton').addEventListener('click', generateAIStory);
    document.getElementById('viewAiStoriesButton').addEventListener('click', viewAIStories);
    
    // Navigation
    document.getElementById('menuTraining').addEventListener('click', () => showSection('trainingSection'));
    document.getElementById('menuGeneration').addEventListener('click', () => showSection('generationSection'));
    document.getElementById('menuManagement').addEventListener('click', () => showSection('managementSection'));
    document.getElementById('menuHistory').addEventListener('click', () => showSection('historySection'));
    
    // Modal
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.closest('.modal').id;
            closeModal(modalId);
        });
    });
    
    // Reader
    document.getElementById('closeReaderBtn').addEventListener('click', closeReader);
    document.getElementById('prevChapterBtn').addEventListener('click', () => navigateChapter(-1));
    document.getElementById('nextChapterBtn').addEventListener('click', () => navigateChapter(1));
    
    // Đánh giá chương
    document.getElementById('rateChapterGood').addEventListener('click', () => rateChapter(true));
    document.getElementById('rateChapterBad').addEventListener('click', () => rateChapter(false));
    
    // Chapter actions
    document.getElementById('editChapterBtn').addEventListener('click', editChapter);
    document.getElementById('deleteChapterBtn').addEventListener('click', deleteChapter);
    document.getElementById('saveChapterBtn').addEventListener('click', saveChapterChanges);
    document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
    
    // Đóng modal khi click bên ngoài
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    });
}

// Xử lý đăng nhập
function handleAuthClick() {
    showLoading(true);
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            showStatus('Đăng nhập thất bại: ' + resp.error, 'error');
            showLoading(false);
            return;
        }
        
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        // Tải hoặc tạo thư mục chính
        await loadOrCreateMainFolder();
        
        // Tải lịch sử và dữ liệu
        loadStoryHistory();
        loadFolderContents();
        loadExistingStories();
        
        showStatus('Đăng nhập thành công!', 'success');
        showLoading(false);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

// Xử lý đăng xuất
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showStatus('Đã đăng xuất', 'success');
    }
}

// Tải hoặc tạo thư mục chính
async function loadOrCreateMainFolder() {
    showLoading(true);
    try {
        // Tìm thư mục chính QuanLyTruyen
        const response = await gapi.client.drive.files.list({
            q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        if (folders.length > 0) {
            mainFolderId = folders[0].id;
            showStatus('Đã tìm thấy thư mục QuanLyTruyen', 'success');
        } else {
            // Tạo thư mục mới nếu không tìm thấy
            const fileMetadata = {
                name: 'QuanLyTruyen',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            const createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            mainFolderId = createResponse.result.id;
            showStatus('Đã tạo thư mục QuanLyTruyen mới', 'success');
        }
    } catch (error) {
        console.error('Lỗi khi tạo/tìm thư mục:', error);
        showStatus('Lỗi khi tạo/tìm thư mục: ' + error.message, 'error');
    }
    showLoading(false);
}

// Huấn luyện AI - ĐÃ SỬA LỖI
async function trainAI() {
    showLoading(true);
    
    try {
        if (!mainFolderId) {
            showStatus('Chưa có thư mục chính', 'error');
            showLoading(false);
            return;
        }
        
        // Lấy danh sách tất cả các file văn bản trong thư mục chính và các thư mục con
        const response = await gapi.client.drive.files.list({
            q: `('${mainFolderId}' in parents or parents in '${mainFolderId}') and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, parents)',
            pageSize: 1000
        });
        
        const textFiles = response.result.files;
        let processedCount = 0;
        let skippedCount = 0;
        
        document.getElementById('progressFill').style.width = '0%';
        
        // Xử lý từng file
        for (const file of textFiles) {
            // Kiểm tra nếu file đã được xử lý
            if (aiKnowledge.processedFiles.has(file.id)) {
                skippedCount++;
                continue;
            }
            
            try {
                // Đọc nội dung file
                const contentResponse = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });
                
                const content = contentResponse.body;
                
                // Cập nhật kiến thức AI từ nội dung
                updateAIKnowledge(content, file.id);
                processedCount++;
                
                // Cập nhật tiến trình
                const progress = Math.floor((processedCount / textFiles.length) * 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Nghỉ một chút để tránh quá tải API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('Lỗi khi xử lý file:', file.name, error);
            }
        }
        
        showStatus(`Đã huấn luyện AI với ${processedCount} file mới (${skippedCount} file đã được xử lý trước đó)`, 'success');
        
    } catch (error) {
        console.error('Lỗi khi huấn luyện AI:', error);
        showStatus('Lỗi khi huấn luyện AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

// Cập nhật kiến thức AI từ nội dung
function updateAIKnowledge(content, fileId) {
    // Kiểm tra nếu file đã được xử lý
    if (fileId && aiKnowledge.processedFiles.has(fileId)) {
        return;
    }
    
    // Đánh dấu file đã xử lý
    if (fileId) {
        aiKnowledge.processedFiles.add(fileId);
    }
    
    // Phân tích nội dung để cập nhật kiến thức cho AI
    const words = content.split(/\s+/);
    words.forEach(word => {
        if (word.length > 3) {
            aiKnowledge.vocabulary.add(word.toLowerCase());
        }
    });
    
    // Phân tích câu
    const sentences = content.split(/[.!?]+/);
    aiKnowledge.trainedFiles += sentences.length;
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Phân tích từ khóa cảm xúc
            specializedVocabulary.emotions.forEach(emotion => {
                if (sentence.toLowerCase().includes(emotion)) {
                    aiKnowledge.emotionalPatterns.add(emotion);
                }
            });
            
            // Phân tích quan hệ bố chồng - con dâu
            if (sentence.toLowerCase().includes('bố chồng') || sentence.toLowerCase().includes('con dâu')) {
                aiKnowledge.fatherInLawRelations.add(sentence.trim());
            }
            
            // Phân tích tình huống cấm kỵ
            specializedVocabulary.adultElements.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.forbiddenSituations.add(sentence.trim());
                }
            });
            
            // Phân tích mâu thuẫn gia đình
            if (sentence.toLowerCase().includes('gia đình') || sentence.toLowerCase().includes('mâu thuẫn') || 
                sentence.toLowerCase().includes('xung đột')) {
                aiKnowledge.familyConflicts.add(sentence.trim());
            }
            
            // Phân tích tâm lý nhân vật
            specializedVocabulary.psychologicalTerms.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.psychologicalStates.add(sentence.trim());
                }
            });
        }
    });
    
    // Lưu kiến thức AI
    saveAIKnowledge();
    updateAIStats();
}

// Các hàm khác giữ nguyên từ code trước đó (hiển thị lịch sử, quản lý truyện, v.v.)
// ... (giữ nguyên các hàm khác)

// Hiển thị section
function showSection(sectionId) {
    // Ẩn tất cả sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Hiển thị section được chọn
    document.getElementById(sectionId).classList.add('active');
    
    // Cập nhật nút menu active
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

// Hiển thị trạng thái
function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Hiển thị/ẩn loading
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Mở modal
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

// Đóng modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Khởi chạy ứng dụng khi trang tải xong
window.addEventListener('load', init);
</script>
</body>
</html>
