<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Trình Phân Tích & Tạo Truyện Nâng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding-top: 12px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-bottom: calc(16px + var(--safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .menu-item.active {
            opacity: 1;
        }

        .menu-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 6px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .story-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary-color);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 50vh;
            overflow-y: auto;
        }

        .chapter-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #3498db);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .status-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .detailed-status {
            font-size: 0.9rem;
            color: #ecf0f1;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .character-profile {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(236, 240, 241, 0.3);
            border-radius: 10px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .character-details {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .character-desc {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .emotion-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 3px;
            background: #e74c3c;
            color: white;
        }

        .emotion-buon {
            background: #3498db;
        }

        .emotion-dau {
            background: #e74c3c;
        }

        .emotion-bat-luc {
            background: #95a5a6;
        }

        .sensitive-word {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .dialogue {
            font-style: italic;
            color: #2c3e50;
            margin: 5px 0;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }

        .analysis-result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .adult-content-warning {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        @media only screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .container {
                padding: 12px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .card {
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .story-content {
                font-size: 0.95rem;
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
            <p>Phân tích nâng cao và tạo truyện tự động</p>
        </div>

        <div id="tab-analysis" class="tab-content active">
            <div class="card">
                <h3>🔍 Phân tích nguồn truyện</h3>
                <p>Phân tích các file văn bản trong thư mục "QuanLyTruyen"</p>
                
                <div class="status-info" id="statusInfo">
                    <p>🔴 Chưa kết nối Google Drive</p>
                    <div class="detailed-status" id="detailedStatus"></div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="handleAuthClick()">
                    📁 Kết nối Google Drive
                </button>
                
                <button class="btn btn-secondary" id="scanBtn" onclick="scanQuanLyTruyenFolder()" disabled>
                    🔍 Quét thư mục QuanLyTruyen
                </button>
                
                <button class="btn btn-warning" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    🧠 Phân tích nâng cao
                </button>

                <button class="btn btn-success" id="downloadDataBtn" onclick="downloadScanData()" disabled>
                    💾 Tải xuống dữ liệu quét
                </button>

                <button class="btn btn-secondary" onclick="document.getElementById('uploadDataInput').click()">
                    📤 Tải lên dữ liệu quét
                </button>
                <input type="file" id="uploadDataInput" accept=".json" style="display: none;" onchange="uploadScanData(event)">
                
                <div class="toggle-container">
                    <span>Bỏ qua file đã phân tích</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipAnalyzedFiles" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="scannedFiles" style="max-height: 200px; overflow-y: auto; margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h3>📊 Kết quả phân tích</h3>
                <div id="analysisResults">
                    <p>Chưa có dữ liệu phân tích. Vui lòng quét và phân tích thư mục trước.</p>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="card">
                <h3>✍️ Viết truyện</h3>
                <p>Tạo truyện mới dựa trên dữ liệu đã phân tích</p>
                
                <div class="character-profile">
                    <div class="character-avatar">👨</div>
                    <div class="character-details">
                        <div class="character-name">Người kể chuyện</div>
                        <div class="character-desc">Tạo truyện từ dữ liệu đã phân tích</div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>Số chương (50+):</span>
                    <input type="number" id="minChapters" value="50" min="50" max="100" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                </div>

                <div class="toggle-container">
                    <span>Độ nhạy cảm:</span>
                    <input type="range" id="sensitivityLevel" min="1" max="10" value="5" style="width: 120px;">
                    <span id="sensitivityValue">5</span>
                </div>

                <div class="toggle-container">
                    <span>Bao gồm nội dung 18+:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="includeAdultContent">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-success" id="generateBtn" onclick="generateStories()" disabled>
                    ✍️ Bắt đầu viết truyện
                </button>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="writeProgressBar"></div>
                    </div>
                </div>
                
                <div class="status-info">
                    <p id="writeStatus">Chưa bắt đầu viết truyện</p>
                    <div class="detailed-status" id="writeDetailedStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>📖 Truyện đang viết</h3>
                <div id="generatedStories">
                    <p>Chưa có truyện nào được tạo. Hãy bấm "Bắt đầu viết truyện" để bắt đầu.</p>
                </div>
            </div>
        </div>

        <div id="tab-stories" class="tab-content">
            <div class="card">
                <h3>📚 Thư viện truyện</h3>
                <p>Những truyện đã được tạo và lưu trữ</p>
                
                <div id="storiesLibrary">
                    <p>Chưa có truyện nào trong thư viện.</p>
                </div>
                
                <button class="btn btn-secondary" id="loadStoriesBtn" onclick="loadStories()">
                    🔄 Tải danh sách truyện
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3>⚙️ Cài đặt</h3>
                
                <div class="toggle-container">
                    <span>Tự động lưu tiến độ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveResults" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span>Gửi dữ liệu cải thiện AI</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sendImprovementData" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="clearCache()">
                    🗑️ Xóa dữ liệu tạm
                </button>
                
                <button class="btn btn-danger" onclick="handleSignoutClick()">
                    🚪 Đăng xuất
                </button>
            </div>
            
            <div class="card">
                <h3>ℹ️ Thông tin ứng dụng</h3>
                <p>Phiên bản: 2.2.0</p>
                <p>Phân tích nâng cao: Hội thoại, Từ nhạy cảm, Nội dung 18+</p>
                <p>Lưu trữ: Có thể tải xuống và tải lên dữ liệu</p>
                <p>Góc nhìn: Linh hoạt theo phân tích</p>
            </div>
        </div>
    </div>

    <div class="bottom-menu">
        <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">
            <div class="menu-icon">🔍</div>
            <span>Phân tích</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-write')">
            <div class="menu-icon">✍️</div>
            <span>Viết truyện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-stories')">
            <div class="menu-icon">📚</div>
            <span>Thư viện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-settings')">
            <div class="menu-icon">⚙️</div>
            <span>Cài đặt</span>
        </a>
    </div>

    <script>
        // Google API Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapi_inited = false;
        let gsi_inited = false;

        // Global variables
        let analysisData = [];
        let generatedStories = [];
        let txtFiles = []; // Lưu trữ danh sách file đã quét
        let scanData = null; // Lưu trữ dữ liệu quét đầy đủ

        // Từ dừng tiếng Việt mở rộng
        const vietnameseStopWords = [
            'là', 'của', 'và', 'có', 'một', 'được', 'trong', 'không', 'với', 'từ', 'để', 'đã', 'sẽ',
            'về', 'cho', 'theo', 'như', 'khi', 'vào', 'ra', 'lên', 'xuống', 'qua', 'tại', 'hay',
            'rằng', 'nếu', 'mà', 'thì', 'hoặc', 'nhưng', 'vì', 'nên', 'đến', 'bằng', 'trên', 'dưới',
            'giữa', 'sau', 'trước', 'cùng', 'cũng', 'chỉ', 'những', 'này', 'đó', 'thế', 'nào', 'ai',
            'gì', 'đâu', 'sao', 'bao', 'lúc', 'lại', 'rất', 'tất', 'cả', 'mọi', 'bất', 'cuộc', 'việc'
        ];

        // Từ nhạy cảm mở rộng với nhiều danh mục
        const sensitiveWords = {
            romantic: [
                'yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'âm áp', 'say đắm', 'đam mê', 'dịu dàng', 
                'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi', 'tình tứ', 'lãng mạn',
                'khao khát', 'khát khao', 'nuông chiều', 'cưng nựng', 'yêu thương', 'mê mải',
                'si mê', 'điên cuồng', 'say mê', 'đắm đuối', 'thổn thức', 'rung động'
            ],
            intimate: [
                'cởi', 'khỏa thân', 'lõa thể', 'khoả thân', 'trần truồng', 'nóng bỏng', 'nóng nực',
                'thân thể', 'cơ thể', 'da thịt', 'lông lá', 'mịn màng', 'trơn tru', 'săn chắc',
                'đùi', 'chân', 'tay', 'cổ', 'vai', 'lưng', 'bụng', 'ngực', 'má', 'môi', 'hơi thở'
            ],
            sexual: [
                'gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục', 'dâm', 'dục',
                'khoái cảm', 'kích thích', 'sung sướng', 'cực khoái', 'thỏa mãn', 'dục vọng',
                'ham muốn', 'thèm khát', 'khao khát', 'điên dại', 'cuồng nhiệt', 'bùng cháy',
                'rên rỉ', 'thổn thức', 'run rẩy', 'co giật', 'căng cứng', 'ướt át', 'nóng ran'
            ],
            emotional_negative: [
                'ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi',
                'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung', 'độc', 'tàn', 'nhẫn',
                'phẫn nộ', 'căm thù', 'thù hận', 'oán hận', 'cay đắng', 'xót xa', 'đau đớn',
                'tuyệt vọng', 'chán nản', 'thất vọng', 'bất lực', 'vô vọng', 'tuyệt望'
            ],
            family_conflict: [
                'bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà',
                'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ', 'thông gia', 'họ hàng', 'gia đình',
                'phản bội gia đình', 'lừa dối gia đình', 'bê bối gia đình', 'scandal gia đình'
            ],
            secret_affair: [
                'bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm',
                'lặng lẽ', 'kín đáo', 'riêng tư', 'ngoại tình', 'tình nhân', 'bồ nhí', 'tiểu tam',
                'thứ ba', 'chen chân', 'phá hoại', 'cướp chồng', 'cướp vợ', 'lừa dối'
            ],
            violence: [
                'đánh', 'đập', 'tát', '때리다', 'bạo lực', 'bạo hành', 'hành hạ', 'tra tấn',
                'dí dỏm', 'ép buộc', 'cưỡng bức', 'cưỡng chế', 'uy hiếp', 'đe dọa',
                'máu', 'chảy máu', 'đẫm máu', 'thương tích', 'vết thương'
            ],
            adult_explicit: [
                'địt', 'đụ', 'chịch', 'doggy', 'blowjob', 'oral', 'anal', 'hardcore',
                'cumshot', 'creampie', 'fingering', 'masturbate', 'orgasm', 'climax',
                'penetrate', 'thrust', 'moan', 'scream', 'wet', 'tight', 'hard', 'soft',
                'lick', 'suck', 'kiss', 'bite', 'squeeze', 'grab', 'touch', 'feel',
                'pussy', 'cock', 'dick', 'tits', 'boobs', 'ass', 'butt', 'hole',
                'lồn', 'cặc', 'cu', 'vú', 'đít', 'mông', 'núm vú', 'âm đạo', 'dương vật'
            ]
        };

        // Từ cảm xúc mở rộng
        const emotionalWords = {
            positive: [
                'vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 
                'thành công', 'hy vọng', 'phấn khích', 'hào hứng', 'tự hào', 'mãn nguyện',
                'thỏa mãn', 'sung sướng', 'rạng rỡ', 'tươi cười', 'lạc quan', 'nhiệt tình'
            ],
            negative: [
                'buồn', 'đau', 'khổ', 'tệ', 'xấu', 'thất bại', 'tuyệt vọng', 'ghét', 'tức giận', 
                'lo lắng', 'sợ hãi', 'khóc', 'tang thương', 'bất hạnh', 'dối trá', 'phản bội', 
                'lừa dối', 'xót xa', 'đau đớn', 'xấu hổ', 'tủi nhục', 'cô đơn', 'trống rỗng',
                'chán chường', 'chán nản', 'bi quan', 'u sầu', 'thê lương', 'khốn khổ'
            ],
            neutral: [
                'bình thường', 'thông thường', 'trung bình', 'ổn', 'được', 'tạm ổn', 'bình yên',
                'lặng lẽ', 'yên tĩnh', 'thong thả', 'nhẹ nhàng'
            ]
        };

        // Từ khóa hội thoại mở rộng
        const dialogueIndicators = [
            'nói', 'bảo', 'hỏi', 'đáp', 'thưa', 'kêu', 'gọi', 'hét', 'la', 'thét', 'thì thầm', 
            'rủ rỉ', 'lên tiếng', 'phát biểu', 'trả lời', 'hỏi lại', 'đáp lại', 'tự nhủ', 'nghĩ thầm',
            'thốt lên', 'cất tiếng', 'lẩm bẩm', 'lầm bầm', 'reo lên', 'than thở', 'thở dài',
            'khẳng định', 'phủ nhận', 'đồng ý', 'từ chối', 'thú nhận', 'kể', 'tâm sự', 'bộc bạch'
        ];

        const dialoguePunctuation = ['"', "'", ':', ';', '-', '—', '–', '»', '«'];

        // Từ khóa bối cảnh và môi trường
        const contextWords = {
            location: [
                'nhà', 'phòng', 'giường', 'bàn', 'ghế', 'cửa', 'cửa sổ', 'vườn', 'sân', 'bếp',
                'phòng tắm', 'phòng ngủ', 'phòng khách', 'tầng lầu', 'gác xép', 'hầm', 'ban công',
                'khách sạn', 'motel', 'resort', 'biệt thự', 'căn hộ', 'chung cư', 'nhà trọ'
            ],
            time: [
                'sáng', 'chiều', 'tối', 'khuya', 'đêm', 'nửa đêm', 'rạng sáng', 'hoàng hôn',
                'lúc', 'giờ', 'phút', 'giây', 'hôm nay', 'hôm qua', 'ngày mai', 'tuần', 'tháng',
                'năm', 'mùa', 'xuân', 'hạ', 'thu', 'đông'
            ],
            weather: [
                'nắng', 'mưa', 'gió', 'bão', 'sương', 'nóng', 'lạnh', 'ấm', 'mát', 'ẩm', 'khô',
                'trong', 'đục', 'sáng', 'tối', 'mây', 'trời', 'không khí'
            ]
        };

        // Initialize Google APIs
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapi_inited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gsi_inited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapi_inited && gsi_inited) {
                document.getElementById('scanBtn').disabled = false;
            }
        }

        // Authentication functions
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                await showLoggedInState();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                showLoggedOutState();
            }
        }

        async function showLoggedInState() {
            updateStatus('🟢 Đã kết nối Google Drive');
            document.getElementById('scanBtn').disabled = false;
        }

        function showLoggedOutState() {
            updateStatus('🔴 Chưa kết nối Google Drive');
            const buttons = ['scanBtn', 'analyzeBtn', 'generateBtn', 'downloadDataBtn'];
            buttons.forEach(id => document.getElementById(id).disabled = true);
        }

        // QUÉT THỦ MỤC QUANLYTRUYEN - SỬA LỖI
        async function scanQuanLyTruyenFolder() {
            updateStatus('🔍 Đang tìm thư mục QuanLyTruyen...');
            updateProgress(5);
            
            try {
                // Tìm thư mục QuanLyTruyen
                const folderResponse = await gapi.client.drive.files.list({
                    q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                });
                
                if (folderResponse.result.files.length === 0) {
                    updateStatus('❌ Không tìm thấy thư mục QuanLyTruyen');
                    updateProgress(0);
                    return;
                }
                
                const folderId = folderResponse.result.files[0].id;
                updateStatus('📁 Đang quét tất cả file trong QuanLyTruyen và thư mục con...');
                updateProgress(10);
                
                txtFiles = [];
                await scanFolderRecursively(folderId, 'QuanLyTruyen');
                
                updateProgress(90);
                updateStatus(`✅ Tìm thấy ${txtFiles.length} file txt`);
                updateProgress(100);
                
                // Lưu dữ liệu quét
                scanData = {
                    scannedAt: new Date().toISOString(),
                    folderName: 'QuanLyTruyen',
                    totalFiles: txtFiles.length,
                    files: txtFiles
                };
                
                displayScannedFiles();
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('downloadDataBtn').disabled = false;
                
                setTimeout(() => updateProgress(0), 2000);
                
            } catch (error) {
                console.error('Error scanning folder:', error);
                updateStatus(`❌ Lỗi khi quét thư mục: ${error.message}`);
                updateProgress(0);
            }
        }

        // Quét đệ quy tất cả thư mục con
        async function scanFolderRecursively(folderId, folderPath) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, mimeType)',
                    pageSize: 1000
                });
                
                const files = response.result.files;
                
                for (const file of files) {
                    if (file.mimeType === 'application/vnd.google-apps.folder') {
                        // Nếu là thư mục, quét đệ quy
                        await scanFolderRecursively(file.id, `${folderPath}/${file.name}`);
                    } else if (file.name.toLowerCase().endsWith('.txt')) {
                        // Nếu là file txt, thêm vào danh sách
                        txtFiles.push({
                            id: file.id,
                            name: file.name,
                            folderPath: folderPath,
                            fullPath: `${folderPath}/${file.name}`
                        });
                    }
                }
                
                // Cập nhật tiến độ
                const progress = 10 + (txtFiles.length * 0.8);
                updateProgress(Math.min(progress, 85));
                updateDetailedStatus(`Đã tìm thấy ${txtFiles.length} file txt...`);
                
            } catch (error) {
                console.error(`Error scanning folder ${folderPath}:`, error);
            }
        }

        // Hiển thị danh sách file đã quét
        function displayScannedFiles() {
            const container = document.getElementById('scannedFiles');
            
            if (txtFiles.length === 0) {
                container.innerHTML = '<p>Chưa quét được file nào.</p>';
                return;
            }
            
            let html = `<h4>📄 Danh sách ${txtFiles.length} file txt đã quét:</h4>`;
            
            // Nhóm theo thư mục
            const filesByFolder = {};
            txtFiles.forEach(file => {
                if (!filesByFolder[file.folderPath]) {
                    filesByFolder[file.folderPath] = [];
                }
                filesByFolder[file.folderPath].push(file);
            });
            
            for (const [folderPath, files] of Object.entries(filesByFolder)) {
                html += `<div style="margin: 8px 0;"><strong>📁 ${folderPath} (${files.length} files)</strong></div>`;
                files.slice(0, 5).forEach(file => {
                    html += `<div class="file-item">📄 ${file.name}</div>`;
                });
                if (files.length > 5) {
                    html += `<div class="file-item" style="opacity: 0.7;">... và ${files.length - 5} file khác</div>`;
                }
            }
            
            container.innerHTML = html;
        }

        // TẢI XUỐNG VÀ TẢI LÊN DỮ LIỆU QUÉT
        function downloadScanData() {
            if (!scanData) {
                alert('Chưa có dữ liệu quét để tải xuống!');
                return;
            }
            
            const dataStr = JSON.stringify(scanData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `QuanLyTruyen_ScanData_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus('💾 Đã tải xuống dữ liệu quét');
        }

        function uploadScanData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.files && Array.isArray(data.files)) {
                        scanData = data;
                        txtFiles = data.files;
                        
                        updateStatus(`📤 Đã tải lên dữ liệu quét: ${txtFiles.length} file`);
                        displayScannedFiles();
                        
                        document.getElementById('analyzeBtn').disabled = false;
                        document.getElementById('downloadDataBtn').disabled = false;
                    } else {
                        alert('File không đúng định dạng!');
                    }
                } catch (error) {
                    alert('Lỗi khi đọc file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // PHÂN TÍCH NÂNG CAP MỞ RỘNG
        async function analyzeFiles() {
            if (!txtFiles || txtFiles.length === 0) {
                alert('Vui lòng quét thư mục trước khi phân tích!');
                return;
            }
            
            updateStatus('🧠 Bắt đầu phân tích nâng cao...');
            analysisData = [];
            
            const totalFiles = Math.min(txtFiles.length, 50);
            
            for (let i = 0; i < totalFiles; i++) {
                const file = txtFiles[i];
                updateProgress((i / totalFiles) * 100);
                updateStatus(`🧠 Đang phân tích: ${file.name} (${i+1}/${totalFiles})`);
                updateDetailedStatus(`Phân tích hội thoại, từ nhạy cảm, nội dung 18+...`);
                
                try {
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    
                    const content = response.body;
                    const analysis = await performAdvancedAnalysis(content, file.name, file.folderPath);
                    analysisData.push(analysis);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                } catch (error) {
                    console.error(`Error analyzing file ${file.name}:`, error);
                    analysisData.push({
                        fileName: file.name,
                        folderPath: file.folderPath,
                        error: error.message
                    });
                }
            }
            
            displayAdvancedAnalysisResults();
            document.getElementById('generateBtn').disabled = false;
            updateProgress(100);
            updateStatus(`✅ Hoàn thành phân tích ${totalFiles} file`);
            updateDetailedStatus('');
            
            setTimeout(() => updateProgress(0), 2000);
        }

        // PHÂN TÍCH NÂNG CAO MỚI VỚI NHIỀU CHI TIẾT HƠN
        async function performAdvancedAnalysis(content, fileName, folderPath) {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const analysis = {
                fileName: fileName,
                folderPath: folderPath || 'Unknown',
                timestamp: new Date().toLocaleString('vi-VN'),
                
                // Phân tích cơ bản
                basicStats: analyzeBasicStats(content),
                
                // Phân tích cảm xúc nâng cao
                emotionalAnalysis: analyzeEmotionsAdvanced(content),
                
                // Phân tích chủ đề
                thematicAnalysis: analyzeThemes(content),
                
                // Phân tích nhân vật nâng cao
                characterAnalysis: analyzeCharactersAdvanced(content),
                
                // Phân tích hội thoại nâng cao
                dialogueAnalysis: analyzeDialoguesAdvanced(content),
                
                // Phân tích từ nhạy cảm nâng cao
                sensitiveAnalysis: analyzeSensitiveContentAdvanced(content),
                
                // Phân tích bối cảnh
                contextAnalysis: analyzeContext(content),
                
                // Phân tích nội dung 18+
                adultContentAnalysis: analyzeAdultContent(content),
                
                // Phân tích cốt truyện
                narrativeAnalysis: analyzeNarrativeStructure(content),
                
                // Mẫu nội dung
                contentSample: content.substring(0, 1500) + (content.length > 1500 ? '...' : '')
            };
            
            return analysis;
        }

        function analyzeBasicStats(content) {
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            const words = content.split(/\s+/).filter(w => w.length > 0);
            const characters = content.length;
            const charactersNoSpaces = content.replace(/\s/g, '').length;
            
            return {
                wordCount: words.length,
                sentenceCount: sentences.length,
                paragraphCount: paragraphs.length,
                characterCount: characters,
                characterCountNoSpaces: charactersNoSpaces,
                avgWordsPerSentence: Math.round(words.length / sentences.length * 10) / 10,
                avgSentencesPerParagraph: Math.round(sentences.length / paragraphs.length * 10) / 10,
                avgWordLength: Math.round(charactersNoSpaces / words.length * 10) / 10,
                readingTime: Math.ceil(words.length / 200) // phút
            };
        }

        function analyzeEmotionsAdvanced(content) {
            const emotionAnalysis = {};
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            const contentLower = content.toLowerCase();
            
            Object.entries(emotionalWords).forEach(([category, words]) => {
                let totalMentions = 0;
                const wordDetails = {};
                
                words.forEach(word => {
                    const regex = new RegExp(word, 'g');
                    const matches = contentLower.match(regex) || [];
                    if (matches.length > 0) {
                        wordDetails[word] = matches.length;
                        totalMentions += matches.length;
                    }
                });
                
                emotionAnalysis[category] = {
                    count: totalMentions,
                    percentage: ((totalMentions / sentences.length) * 100).toFixed(1) + '%',
                    words: wordDetails
                };
            });
            
            const sentimentScore = calculateSentimentScore(emotionAnalysis);
            const dominantEmotion = findDominantEmotion(emotionAnalysis);
            
            return {
                overallTone: determineOverallTone(emotionAnalysis),
                emotionBreakdown: emotionAnalysis,
                sentimentScore: sentimentScore,
                dominantEmotion: dominantEmotion,
                emotionalIntensity: calculateEmotionalIntensity(emotionAnalysis)
            };
        }

        function analyzeCharactersAdvanced(content) {
            const characters = [];
            const namePattern = /\b[A-ZÀ-Ỹ][a-zà-ỹ]{2,15}(?:\s[A-ZÀ-Ỹ][a-zà-ỹ]{2,15})*\b/g;
            const potentialNames = content.match(namePattern) || [];
            
            const nameCounts = {};
            const nameContexts = {};
            
            potentialNames.forEach(name => {
                if (name.length > 2 && name.length < 30 && !vietnameseStopWords.includes(name.toLowerCase())) {
                    nameCounts[name] = (nameCounts[name] || 0) + 1;
                    
                    // Lấy ngữ cảnh xung quanh tên
                    const nameIndex = content.indexOf(name);
                    if (nameIndex !== -1) {
                        const context = content.substring(
                            Math.max(0, nameIndex - 50),
                            Math.min(content.length, nameIndex + name.length + 50)
                        );
                        nameContexts[name] = context;
                    }
                }
            });
            
            Object.entries(nameCounts)
                .filter(([name, count]) => count >= 2)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8)
                .forEach(([name, count]) => {
                    const importance = count > 10 ? 'Chính' : count > 5 ? 'Phụ' : 'Nền';
                    const relationship = analyzeCharacterRelationship(name, content);
                    
                    characters.push({
                        name: name,
                        appearances: count,
                        importance: importance,
                        relationship: relationship,
                        context: nameContexts[name]?.substring(0, 100) + '...'
                    });
                });
            
            return {
                characterCount: characters.length,
                characters: characters,
                relationshipComplexity: characters.length > 4 ? 'Phức tạp' : 'Đơn giản'
            };
        }

        function analyzeCharacterRelationship(characterName, content) {
            const familyWords = sensitiveWords.family_conflict;
            const relationshipContext = content.toLowerCase();
            
            for (const familyTerm of familyWords) {
                if (relationshipContext.includes(characterName.toLowerCase()) && 
                    relationshipContext.includes(familyTerm)) {
                    return familyTerm;
                }
            }
            return 'Không rõ';
        }

        // PHÂN TÍCH HỘI THOẠI NÂNG CAO
        function analyzeDialoguesAdvanced(content) {
            const dialogues = [];
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            for (const sentence of sentences) {
                const dialogue = extractDialogueAdvanced(sentence);
                if (dialogue) {
                    const emotion = analyzeDialogueEmotion(dialogue.text);
                    const speaker = extractSpeaker(sentence);
                    
                    dialogues.push({
                        text: dialogue.text,
                        speaker: speaker,
                        emotion: emotion,
                        length: dialogue.text.length,
                        hasQuotes: dialogue.hasQuotes,
                        hasIndicator: dialogue.hasIndicator,
                        context: sentence.substring(0, 200) + '...'
                    });
                }
            }
            
            return {
                dialogueCount: dialogues.length,
                dialogues: dialogues.slice(0, 15),
                dialoguePercentage: ((dialogues.length / sentences.length) * 100).toFixed(1) + '%',
                averageDialogueLength: dialogues.length > 0 ? 
                    Math.round(dialogues.reduce((sum, d) => sum + d.length, 0) / dialogues.length) : 0,
                emotionalDialogues: dialogues.filter(d => d.emotion !== 'trung tính').length
            };
        }

        function extractDialogueAdvanced(sentence) {
            // Tìm văn bản trong ngoặc kép
            const quotedText = sentence.match(/["'»«](.*?)["'»«]/);
            if (quotedText && quotedText[1].length > 5) {
                return {
                    text: quotedText[1],
                    hasQuotes: true,
                    hasIndicator: false
                };
            }
            
            // Tìm văn bản sau dấu hai chấm hoặc gạch ngang
            const colonMatch = sentence.match(/[:—–]\s*(.+)$/);
            if (colonMatch && colonMatch[1].length > 10) {
                return {
                    text: colonMatch[1].trim(),
                    hasQuotes: false,
                    hasIndicator: true
                };
            }
            
            // Tìm văn bản sau các từ chỉ hội thoại
            for (const indicator of dialogueIndicators) {
                const regex = new RegExp(`${indicator}\\s*[:"]?\\s*(.+)<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Trình Phân Tích & Tạo Truyện Nâng Cao</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #8e44ad 0%, #2c3e50 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding-top: 12px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            padding-bottom: calc(16px + var(--safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-color);
            text-decoration: none;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .menu-item.active {
            opacity: 1;
        }

        .menu-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 6px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .story-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid var(--primary-color);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 50vh;
            overflow-y: auto;
        }

        .chapter-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #3498db);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .status-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .detailed-status {
            font-size: 0.9rem;
            color: #ecf0f1;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .character-profile {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(236, 240, 241, 0.3);
            border-radius: 10px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .character-details {
            flex: 1;
        }

        .character-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .character-desc {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .emotion-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 3px;
            background: #e74c3c;
            color: white;
        }

        .emotion-buon {
            background: #3498db;
        }

        .emotion-dau {
            background: #e74c3c;
        }

        .emotion-bat-luc {
            background: #95a5a6;
        }

        .sensitive-word {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .dialogue {
            font-style: italic;
            color: #2c3e50;
            margin: 5px 0;
            padding-left: 15px;
            border-left: 3px solid #3498db;
        }

        .analysis-result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .adult-content-warning {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        @media only screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .container {
                padding: 12px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .card {
                padding: 16px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .story-content {
                font-size: 0.95rem;
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📖 Trình Phân Tích & Tạo Truyện</h1>
            <p>Phân tích nâng cao và tạo truyện tự động</p>
        </div>

        <div id="tab-analysis" class="tab-content active">
            <div class="card">
                <h3>🔍 Phân tích nguồn truyện</h3>
                <p>Phân tích các file văn bản trong thư mục "QuanLyTruyen"</p>
                
                <div class="status-info" id="statusInfo">
                    <p>🔴 Chưa kết nối Google Drive</p>
                    <div class="detailed-status" id="detailedStatus"></div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="handleAuthClick()">
                    📁 Kết nối Google Drive
                </button>
                
                <button class="btn btn-secondary" id="scanBtn" onclick="scanQuanLyTruyenFolder()" disabled>
                    🔍 Quét thư mục QuanLyTruyen
                </button>
                
                <button class="btn btn-warning" id="analyzeBtn" onclick="analyzeFiles()" disabled>
                    🧠 Phân tích nâng cao
                </button>

                <button class="btn btn-success" id="downloadDataBtn" onclick="downloadScanData()" disabled>
                    💾 Tải xuống dữ liệu quét
                </button>

                <button class="btn btn-secondary" onclick="document.getElementById('uploadDataInput').click()">
                    📤 Tải lên dữ liệu quét
                </button>
                <input type="file" id="uploadDataInput" accept=".json" style="display: none;" onchange="uploadScanData(event)">
                
                <div class="toggle-container">
                    <span>Bỏ qua file đã phân tích</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipAnalyzedFiles" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="scannedFiles" style="max-height: 200px; overflow-y: auto; margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h3>📊 Kết quả phân tích</h3>
                <div id="analysisResults">
                    <p>Chưa có dữ liệu phân tích. Vui lòng quét và phân tích thư mục trước.</p>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="card">
                <h3>✍️ Viết truyện</h3>
                <p>Tạo truyện mới dựa trên dữ liệu đã phân tích</p>
                
                <div class="character-profile">
                    <div class="character-avatar">👨</div>
                    <div class="character-details">
                        <div class="character-name">Người kể chuyện</div>
                        <div class="character-desc">Tạo truyện từ dữ liệu đã phân tích</div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>Số chương (50+):</span>
                    <input type="number" id="minChapters" value="50" min="50" max="100" style="width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                </div>

                <div class="toggle-container">
                    <span>Độ nhạy cảm:</span>
                    <input type="range" id="sensitivityLevel" min="1" max="10" value="5" style="width: 120px;">
                    <span id="sensitivityValue">5</span>
                </div>

                <div class="toggle-container">
                    <span>Bao gồm nội dung 18+:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="includeAdultContent">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-success" id="generateBtn" onclick="generateStories()" disabled>
                    ✍️ Bắt đầu viết truyện
                </button>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="writeProgressBar"></div>
                    </div>
                </div>
                
                <div class="status-info">
                    <p id="writeStatus">Chưa bắt đầu viết truyện</p>
                    <div class="detailed-status" id="writeDetailedStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>📖 Truyện đang viết</h3>
                <div id="generatedStories">
                    <p>Chưa có truyện nào được tạo. Hãy bấm "Bắt đầu viết truyện" để bắt đầu.</p>
                </div>
            </div>
        </div>

        <div id="tab-stories" class="tab-content">
            <div class="card">
                <h3>📚 Thư viện truyện</h3>
                <p>Những truyện đã được tạo và lưu trữ</p>
                
                <div id="storiesLibrary">
                    <p>Chưa có truyện nào trong thư viện.</p>
                </div>
                
                <button class="btn btn-secondary" id="loadStoriesBtn" onclick="loadStories()">
                    🔄 Tải danh sách truyện
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h3>⚙️ Cài đặt</h3>
                
                <div class="toggle-container">
                    <span>Tự động lưu tiến độ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSaveResults" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-container">
                    <span>Gửi dữ liệu cải thiện AI</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sendImprovementData" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="btn" onclick="clearCache()">
                    🗑️ Xóa dữ liệu tạm
                </button>
                
                <button class="btn btn-danger" onclick="handleSignoutClick()">
                    🚪 Đăng xuất
                </button>
            </div>
            
            <div class="card">
                <h3>ℹ️ Thông tin ứng dụng</h3>
                <p>Phiên bản: 2.2.0</p>
                <p>Phân tích nâng cao: Hội thoại, Từ nhạy cảm, Nội dung 18+</p>
                <p>Lưu trữ: Có thể tải xuống và tải lên dữ liệu</p>
                <p>Góc nhìn: Linh hoạt theo phân tích</p>
            </div>
        </div>
    </div>

    <div class="bottom-menu">
        <a href="#" class="menu-item active" onclick="switchTab('tab-analysis')">
            <div class="menu-icon">🔍</div>
            <span>Phân tích</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-write')">
            <div class="menu-icon">✍️</div>
            <span>Viết truyện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-stories')">
            <div class="menu-icon">📚</div>
            <span>Thư viện</span>
        </a>
        <a href="#" class="menu-item" onclick="switchTab('tab-settings')">
            <div class="menu-icon">⚙️</div>
            <span>Cài đặt</span>
        </a>
    </div>

    <script>
        // Google API Configuration
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let tokenClient;
        let gapi_inited = false;
        let gsi_inited = false;

        // Global variables
        let analysisData = [];
        let generatedStories = [];
        let txtFiles = []; // Lưu trữ danh sách file đã quét
        let scanData = null; // Lưu trữ dữ liệu quét đầy đủ

        // Từ dừng tiếng Việt mở rộng
        const vietnameseStopWords = [
            'là', 'của', 'và', 'có', 'một', 'được', 'trong', 'không', 'với', 'từ', 'để', 'đã', 'sẽ',
            'về', 'cho', 'theo', 'như', 'khi', 'vào', 'ra', 'lên', 'xuống', 'qua', 'tại', 'hay',
            'rằng', 'nếu', 'mà', 'thì', 'hoặc', 'nhưng', 'vì', 'nên', 'đến', 'bằng', 'trên', 'dưới',
            'giữa', 'sau', 'trước', 'cùng', 'cũng', 'chỉ', 'những', 'này', 'đó', 'thế', 'nào', 'ai',
            'gì', 'đâu', 'sao', 'bao', 'lúc', 'lại', 'rất', 'tất', 'cả', 'mọi', 'bất', 'cuộc', 'việc'
        ];

        // Từ nhạy cảm mở rộng với nhiều danh mục
        const sensitiveWords = {
            romantic: [
                'yêu', 'thương', 'hôn', 'ôm', 'ấp ôm', 'âm áp', 'say đắm', 'đam mê', 'dịu dàng', 
                'ngọt ngào', 'quyến rũ', 'mê hoặc', 'thân mật', 'gần gũi', 'tình tứ', 'lãng mạn',
                'khao khát', 'khát khao', 'nuông chiều', 'cưng nựng', 'yêu thương', 'mê mải',
                'si mê', 'điên cuồng', 'say mê', 'đắm đuối', 'thổn thức', 'rung động'
            ],
            intimate: [
                'cởi', 'khỏa thân', 'lõa thể', 'khoả thân', 'trần truồng', 'nóng bỏng', 'nóng nực',
                'thân thể', 'cơ thể', 'da thịt', 'lông lá', 'mịn màng', 'trơn tru', 'săn chắc',
                'đùi', 'chân', 'tay', 'cổ', 'vai', 'lưng', 'bụng', 'ngực', 'má', 'môi', 'hơi thở'
            ],
            sexual: [
                'gối chăn', 'phòng the', 'ân ái', 'làm tình', 'quan hệ', 'tình dục', 'dâm', 'dục',
                'khoái cảm', 'kích thích', 'sung sướng', 'cực khoái', 'thỏa mãn', 'dục vọng',
                'ham muốn', 'thèm khát', 'khao khát', 'điên dại', 'cuồng nhiệt', 'bùng cháy',
                'rên rỉ', 'thổn thức', 'run rẩy', 'co giật', 'căng cứng', 'ướt át', 'nóng ran'
            ],
            emotional_negative: [
                'ghét', 'hận', 'giận', 'tức', 'tủi', 'buồn', 'đau', 'khổ', 'sầu', 'thảm', 'bi',
                'tang', 'tử', 'chết', 'giết', 'hại', 'ác', 'dữ', 'hung', 'độc', 'tàn', 'nhẫn',
                'phẫn nộ', 'căm thù', 'thù hận', 'oán hận', 'cay đắng', 'xót xa', 'đau đớn',
                'tuyệt vọng', 'chán nản', 'thất vọng', 'bất lực', 'vô vọng', 'tuyệt望'
            ],
            family_conflict: [
                'bố', 'mẹ', 'cha', 'con', 'chồng', 'vợ', 'dâu', 'rể', 'anh', 'chị', 'em', 'ông', 'bà',
                'chú', 'bác', 'cô', 'dì', 'cậu', 'mợ', 'thông gia', 'họ hàng', 'gia đình',
                'phản bội gia đình', 'lừa dối gia đình', 'bê bối gia đình', 'scandal gia đình'
            ],
            secret_affair: [
                'bí mật', 'giấu giếm', 'che giấu', 'giấu diếm', 'lén lút', 'vụng trộm', 'âm thầm',
                'lặng lẽ', 'kín đáo', 'riêng tư', 'ngoại tình', 'tình nhân', 'bồ nhí', 'tiểu tam',
                'thứ ba', 'chen chân', 'phá hoại', 'cướp chồng', 'cướp vợ', 'lừa dối'
            ],
            violence: [
                'đánh', 'đập', 'tát', '때리다', 'bạo lực', 'bạo hành', 'hành hạ', 'tra tấn',
                'dí dỏm', 'ép buộc', 'cưỡng bức', 'cưỡng chế', 'uy hiếp', 'đe dọa',
                'máu', 'chảy máu', 'đẫm máu', 'thương tích', 'vết thương'
            ],
            adult_explicit: [
                'địt', 'đụ', 'chịch', 'doggy', 'blowjob', 'oral', 'anal', 'hardcore',
                'cumshot', 'creampie', 'fingering', 'masturbate', 'orgasm', 'climax',
                'penetrate', 'thrust', 'moan', 'scream', 'wet', 'tight', 'hard', 'soft',
                'lick', 'suck', 'kiss', 'bite', 'squeeze', 'grab', 'touch', 'feel',
                'pussy', 'cock', 'dick', 'tits', 'boobs', 'ass', 'butt', 'hole',
                'lồn', 'cặc', 'cu', 'vú', 'đít', 'mông', 'núm vú', 'âm đạo', 'dương vật'
            ]
        };

        // Từ cảm xúc mở rộng
        const emotionalWords = {
            positive: [
                'vui', 'hạnh phúc', 'yêu', 'thương', 'tuyệt vời', 'đẹp', 'tốt', 'xuất sắc', 
                'thành công', 'hy vọng', 'phấn khích', 'hào hứng', 'tự hào', 'mãn nguyện',
, 'i');
                const match = sentence.match(regex);
                if (match && match[1].length > 10) {
                    return {
                        text: match[1].trim().replace(/["'»«]/g, ''),
                        hasQuotes: false,
                        hasIndicator: true
                    };
                }
            }
            
            return null;
        }

        function extractSpeaker(sentence) {
            // Tìm người nói trong câu
            const speakerPattern = /([A-ZÀ-Ỹ][a-zà-ỹ]+)\s+(?:nói|bảo|hỏi|đáp|thưa|kêu)/i;
            const match = sentence.match(speakerPattern);
            return match ? match[1] : 'Không rõ';
        }

        function analyzeDialogueEmotion(dialogueText) {
            const text = dialogueText.toLowerCase();
            
            const positiveWords = emotionalWords.positive.filter(word => text.includes(word));
            const negativeWords = emotionalWords.negative.filter(word => text.includes(word));
            
            if (positiveWords.length > negativeWords.length) return 'tích cực';
            if (negativeWords.length > positiveWords.length) return 'tiêu cực';
            return 'trung tính';
        }

        // PHÂN TÍCH TỪ NHẠY CẢM NÂNG CAO
        function analyzeSensitiveContentAdvanced(content) {
            const sensitiveResults = {};
            const contentLower = content.toLowerCase();
            let totalSensitiveWords = 0;
            
            for (const [category, words] of Object.entries(sensitiveWords)) {
                const foundWords = {};
                const contexts = [];
                
                for (const word of words) {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    const matches = contentLower.match(regex);
                    if (matches) {
                        foundWords[word] = matches.length;
                        totalSensitiveWords += matches.length;
                        
                        // Lấy ngữ cảnh xung quanh từ nhạy cảm
                        const wordIndex = contentLower.indexOf(word);
                        if (wordIndex !== -1 && contexts.length < 3) {
                            const context = content.substring(
                                Math.max(0, wordIndex - 30),
                                Math.min(content.length, wordIndex + word.length + 30)
                            );
                            contexts.push(context);
                        }
                    }
                }
                
                if (Object.keys(foundWords).length > 0) {
                    sensitiveResults[category] = {
                        words: foundWords,
                        count: Object.values(foundWords).reduce((a, b) => a + b, 0),
                        contexts: contexts
                    };
                }
            }
            
            const sensitivityLevel = calculateSensitivityLevel(totalSensitiveWords, content.length);
            const riskLevel = determineRiskLevel(sensitiveResults);
            
            return {
                totalSensitiveWords: totalSensitiveWords,
                categories: sensitiveResults,
                sensitivityScore: calculateSensitivityScore(totalSensitiveWords, content.length),
                sensitivityLevel: sensitivityLevel,
                riskLevel: riskLevel,
                hasAdultContent: Object.keys(sensitiveResults).some(cat => 
                    ['sexual', 'adult_explicit', 'intimate'].includes(cat))
            };
        }

        function calculateSensitivityLevel(sensitiveWordCount, totalCharacters) {
            if (totalCharacters === 0) return 'Thấp';
            const ratio = (sensitiveWordCount / (totalCharacters / 1000));
            
            if (ratio > 5) return 'Rất cao';
            if (ratio > 3) return 'Cao';
            if (ratio > 1) return 'Trung bình';
            return 'Thấp';
        }

        function determineRiskLevel(sensitiveResults) {
            const highRiskCategories = ['sexual', 'adult_explicit', 'violence'];
            const hasHighRisk = Object.keys(sensitiveResults).some(cat => 
                highRiskCategories.includes(cat));
            
            if (hasHighRisk) return 'Cao';
            if (Object.keys(sensitiveResults).length > 3) return 'Trung bình';
            return 'Thấp';
        }

        // PHÂN TÍCH BỐI CẢNH
        function analyzeContext(content) {
            const contextAnalysis = {};
            const contentLower = content.toLowerCase();
            
            Object.entries(contextWords).forEach(([category, words]) => {
                const foundWords = {};
                let totalCount = 0;
                
                words.forEach(word => {
                    const count = (contentLower.match(new RegExp(`\\b${word}\\b`, 'g')) || []).length;
                    if (count > 0) {
                        foundWords[word] = count;
                        totalCount += count;
                    }
                });
                
                if (totalCount > 0) {
                    contextAnalysis[category] = {
                        words: foundWords,
                        count: totalCount
                    };
                }
            });
            
            return {
                contexts: contextAnalysis,
                primarySetting: determinePrimarySetting(contextAnalysis),
                timeOfDay: determineTimeOfDay(contextAnalysis),
                atmosphere: determineAtmosphere(content)
            };
        }

        function determinePrimarySetting(contextAnalysis) {
            if (!contextAnalysis.location) return 'Không rõ';
            
            const locationWords = contextAnalysis.location.words;
            const mostCommon = Object.entries(locationWords)
                .sort(([,a], [,b]) => b - a)[0];
            
            return mostCommon ? mostCommon[0] : 'Không rõ';
        }

        function determineTimeOfDay(contextAnalysis) {
            if (!contextAnalysis.time) return 'Không rõ';
            
            const timeWords = contextAnalysis.time.words;
            const mostCommon = Object.entries(timeWords)
                .sort(([,a], [,b]) => b - a)[0];
            
            return mostCommon ? mostCommon[0] : 'Không rõ';
        }

        function determineAtmosphere(content) {
            const darkWords = ['tối', 'u ám', 'âm thầm', 'bí mật', 'lén lút', 'sợ hãi'];
            const lightWords = ['sáng', 'tươi', 'vui', 'hạnh phúc', 'yên bình'];
            
            const contentLower = content.toLowerCase();
            const darkCount = darkWords.reduce((count, word) => 
                count + (contentLower.match(new RegExp(word, 'g')) || []).length, 0);
            const lightCount = lightWords.reduce((count, word) => 
                count + (contentLower.match(new RegExp(word, 'g')) || []).length, 0);
            
            if (darkCount > lightCount) return 'U ám';
            if (lightCount > darkCount) return 'Tích cực';
            return 'Trung tính';
        }

        // PHÂN TÍCH NỘI DUNG 18+
        function analyzeAdultContent(content) {
            const contentLower = content.toLowerCase();
            const adultWords = sensitiveWords.adult_explicit;
            const sexualWords = sensitiveWords.sexual;
            const intimateWords = sensitiveWords.intimate;
            
            const adultContent = {};
            let totalAdultWords = 0;
            const adultContexts = [];
            
            [...adultWords, ...sexualWords, ...intimateWords].forEach(word => {
                const count = (contentLower.match(new RegExp(`\\b${word}\\b`, 'g')) || []).length;
                if (count > 0) {
                    adultContent[word] = count;
                    totalAdultWords += count;
                    
                    // Lấy ngữ cảnh
                    const wordIndex = contentLower.indexOf(word);
                    if (wordIndex !== -1 && adultContexts.length < 3) {
                        const context = content.substring(
                            Math.max(0, wordIndex - 50),
                            Math.min(content.length, wordIndex + word.length + 50)
                        );
                        adultContexts.push({
                            word: word,
                            context: context
                        });
                    }
                }
            });
            
            const adultLevel = determineAdultContentLevel(totalAdultWords);
            
            return {
                hasAdultContent: totalAdultWords > 0,
                adultWords: adultContent,
                totalAdultWords: totalAdultWords,
                adultLevel: adultLevel,
                contexts: adultContexts,
                warningRequired: totalAdultWords > 5
            };
        }

        function determineAdultContentLevel(adultWordCount) {
            if (adultWordCount === 0) return 'Không có';
            if (adultWordCount < 3) return 'Nhẹ';
            if (adultWordCount < 10) return 'Trung bình';
            if (adultWordCount < 20) return 'Cao';
            return 'Rất cao';
        }

        function analyzeNarrativeStructure(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim());
            const sentences = content.split(/[.!?]+/).filter(s => s.trim());
            
            return {
                structure: analyzeThreeActStructure(paragraphs),
                pacing: analyzePacing(paragraphs),
                climax: identifyClimax(content),
                narrativeStyle: determineNarrativeStyle(content)
            };
        }

        function analyzeThreeActStructure(paragraphs) {
            const act1End = Math.floor(paragraphs.length * 0.25);
            const act2End = Math.floor(paragraphs.length * 0.75);
            
            return {
                act1: {
                    paragraphs: act1End,
                    percentage: '25%',
                    description: 'Mở đầu, giới thiệu'
                },
                act2: {
                    paragraphs: act2End - act1End,
                    percentage: '50%',
                    description: 'Phát triển, xung đột'
                },
                act3: {
                    paragraphs: paragraphs.length - act2End,
                    percentage: '25%',
                    description: 'Cao trào, kết thúc'
                }
            };
        }

        function analyzePacing(paragraphs) {
            const avgParagraphLength = paragraphs.reduce((sum, p) => 
                sum + p.split(/\s+/).length, 0) / paragraphs.length;
            
            return {
                averageParagraphLength: Math.round(avgParagraphLength),
                pacing: avgParagraphLength > 100 ? 'Chậm' : 
                        avgParagraphLength > 50 ? 'Vừa phải' : 'Nhanh'
            };
        }

        function identifyClimax(content) {
            const climaxIndicators = [
                'đột nhiên', 'bất ngờ', 'lúc này', 'cuối cùng', 'quyết định', 
                'quan trọng nhất', 'không thể', 'phải', 'tuyệt đối'
            ];
            const sentences = content.split(/[.!?]+/);
            
            let climaxSentence = '';
            let maxIndicators = 0;
            
            sentences.forEach(sentence => {
                const indicatorCount = climaxIndicators.reduce((count, indicator) => {
                    return count + (sentence.toLowerCase().includes(indicator) ? 1 : 0);
                }, 0);
                
                if (indicatorCount > maxIndicators && sentence.trim().length > 20) {
                    maxIndicators = indicatorCount;
                    climaxSentence = sentence.trim();
                }
            });
            
            return {
                identified: climaxSentence.length > 0,
                sentence: climaxSentence.substring(0, 300) + (climaxSentence.length > 300 ? '...' : ''),
                indicators: maxIndicators
            };
        }

        function determineNarrativeStyle(content) {
            const firstPersonIndicators = ['tôi', 'mình', 'em', 'anh'];
            const thirdPersonIndicators = ['cô ấy', 'anh ấy', 'họ', 'người'];
            
            const contentLower = content.toLowerCase();
            const firstPersonCount = firstPersonIndicators.reduce((count, indicator) => 
                count + (contentLower.match(new RegExp(`\\b${indicator}\\b`, 'g')) || []).length, 0);
            const thirdPersonCount = thirdPersonIndicators.reduce((count, indicator) => 
                count + (contentLower.match(new RegExp(`\\b${indicator}\\b`, 'g')) || []).length, 0);
            
            if (firstPersonCount > thirdPersonCount * 2) return 'Ngôi thứ nhất';
            if (thirdPersonCount > firstPersonCount) return 'Ngôi thứ ba';
            return 'Hỗn hợp';
        }

        // Utility functions
        function determineOverallTone(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const neutral = emotionAnalysis.neutral?.count || 0;
            
            if (positive > negative && positive > neutral) return 'Tích cực';
            if (negative > positive && negative > neutral) return 'Tiêu cực';
            return 'Trung tính';
        }

        function calculateSentimentScore(emotionAnalysis) {
            const positive = emotionAnalysis.positive?.count || 0;
            const negative = emotionAnalysis.negative?.count || 0;
            const total = positive + negative;
            
            if (total === 0) return 0;
            return ((positive - negative) / total * 100).toFixed(1);
        }

        function findDominantEmotion(emotionAnalysis) {
            let maxCount = 0;
            let dominantEmotion = 'Không rõ';
            
            Object.entries(emotionAnalysis).forEach(([emotion, data]) => {
                if (data.count > maxCount) {
                    maxCount = data.count;
                    dominantEmotion = emotion;
                }
            });
            
            return dominantEmotion;
        }

        function calculateEmotionalIntensity(emotionAnalysis) {
            const totalEmotions = Object.values(emotionAnalysis)
                .reduce((sum, data) => sum + data.count, 0);
            
            if (totalEmotions < 5) return 'Thấp';
            if (totalEmotions < 15) return 'Trung bình';
            if (totalEmotions < 30) return 'Cao';
            return 'Rất cao';
        }

        function calculateSensitivityScore(sensitiveWordCount, totalCharacters) {
            if (totalCharacters === 0) return 0;
            const ratio = (sensitiveWordCount / (totalCharacters / 1000));
            return Math.min(10, Math.round(ratio * 10) / 10);
        }

        // STORY GENERATION - NÂNG CAP VỚI NỘI DUNG 18+
        async function generateStories() {
            if (analysisData.length === 0) {
                alert('Vui lòng phân tích file trước khi tạo truyện!');
                return;
            }
            
            updateWriteStatus('✍️ Bắt đầu viết truyện...', 'Chuẩn bị dữ liệu và ý tưởng');
            updateWriteProgress(5);
            
            try {
                const minChapters = parseInt(document.getElementById('minChapters').value) || 50;
                const sensitivityLevel = parseInt(document.getElementById('sensitivityLevel').value) || 5;
                const includeAdultContent = document.getElementById('includeAdultContent').checked;
                
                const storyTitle = generateStoryTitle(analysisData, includeAdultContent);
                updateWriteStatus(`📖 Đang viết: "${storyTitle}"`, `Kế hoạch ${minChapters} chương`);
                updateWriteProgress(10);
                
                const mainPlot = generateMainPlot(analysisData, includeAdultContent);
                
                const chapters = [];
                for (let i = 1; i <= minChapters; i++) {
                    updateWriteProgress(10 + (i / minChapters) * 80);
                    updateWriteStatus(`📖 Đang viết chương ${i}/${minChapters}`, `"${storyTitle}"`);
                    
                    const chapterTitle = generateChapterTitle(i, mainPlot, analysisData, includeAdultContent);
                    const chapterContent = generateChapterContent(i, chapterTitle, mainPlot, analysisData, sensitivityLevel, includeAdultContent);
                    
                    chapters.push({
                        number: i,
                        title: chapterTitle,
                        content: chapterContent,
                        wordCount: chapterContent.split(/\s+/).length,
                        hasAdultContent: includeAdultContent && (i % 5 === 0 || Math.random() < 0.3)
                    });
                    
                    if (i === 1 || i % 10 === 0 || i === minChapters) {
                        displayLatestChapter(storyTitle, chapters[chapters.length - 1], includeAdultContent);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 150));
                }
                
                const generatedStory = {
                    title: storyTitle,
                    chapters: chapters,
                    generatedAt: new Date().toISOString(),
                    basedOnAnalysis: analysisData.length,
                    totalWords: chapters.reduce((sum, ch) => sum + ch.wordCount, 0),
                    hasAdultContent: includeAdultContent,
                    sensitivityLevel: sensitivityLevel
                };
                
                generatedStories.push(generatedStory);
                displayGeneratedStories();
                
                updateWriteProgress(95);
                updateWriteStatus(`✅ Đã hoàn thành: "${storyTitle}"`, 
                    `${minChapters} chương, ${generatedStory.totalWords} từ${includeAdultContent ? ' (18+)' : ''}`);
                
                updateWriteProgress(100);
                setTimeout(() => updateWriteProgress(0), 2000);
                
            } catch (error) {
                console.error('Error generating stories:', error);
                updateWriteStatus(`❌ Lỗi khi viết truyện: ${error.message}`, '');
                updateWriteProgress(0);
            }
        }

        function generateStoryTitle(analysisData, includeAdultContent) {
            const normalTitles = [
                `Bóng Tối Trong Gia Đình`,
                `Mối Tình Oan Nghiệt`,
                `Sự Thật Đau Lòng Sau Cánh Cửa`,
                `Người Cha Và Con Dâu`,
                `Mất Mát Trong Im Lặng`,
                `Trái Tim Người Chồng`,
                `Mối Tình Cấm Đoán`,
                `Những Giấu Giếm Đau Đớn`,
                `Sự Phản Bội Thầm Lặng`,
                `Gia Đình Không Trọn Vẹn`
            ];
            
            const adultTitles = [
                `Đam Mê Cấm Đoán`,
                `Lửa Yêu Thiêu Đốt`,
                `Cuồng Nhiệt Trong Đêm`,
                `Khao Khát Bí Mật`,
                `Đêm Nay Em Là Của Anh`,
                `Cơ Thể Và Tâm Hồn`,
                `Nóng Bỏng Từng Đêm`,
                `Ham Muốn Không Kiểm Soát`,
                `Tình Dục Và Tình Yêu`,
                `Khoái Cảm Tột Độ`
            ];
            
            const titles = includeAdultContent ? adultTitles : normalTitles;
            return titles[Math.floor(Math.random() * titles.length)];
        }

        function generateMainPlot(analysisData, includeAdultContent) {
            const emotionalTone = determineOverallEmotionalToneFromAnalysis(analysisData);
            const commonThemes = findCommonThemes(analysisData);
            const commonCharacters = findCommonCharacters(analysisData);
            const averageSensitivity = calculateAverageSensitivity(analysisData);
            
            return {
                themes: commonThemes.slice(0, 3),
                mainCharacters: commonCharacters.slice(0, 3),
                emotionalTone: emotionalTone,
                conflict: {
                    type: includeAdultContent ? 'tình dục và tình cảm' : 'tình cảm gia đình',
                    intensity: averageSensitivity > 5 ? 'cao' : 'trung bình',
                    resolution: 'phức tạp'
                },
                sensitivity: averageSensitivity,
                includeAdultContent: includeAdultContent
            };
        }

        function determineOverallEmotionalToneFromAnalysis(analysisData) {
            let positive = 0, negative = 0, neutral = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    positive += analysis.emotionalAnalysis.emotionBreakdown.positive?.count || 0;
                    negative += analysis.emotionalAnalysis.emotionBreakdown.negative?.count || 0;
                    neutral += analysis.emotionalAnalysis.emotionBreakdown.neutral?.count || 0;
                }
            });
            
            if (negative > positive && negative > neutral) return 'negative';
            if (positive > negative && positive > neutral) return 'positive';
            return 'neutral';
        }

        function findCommonThemes(analysisData) {
            const allThemes = {};
            analysisData.forEach(analysis => {
                if (analysis.thematicAnalysis && analysis.thematicAnalysis.mainThemes) {
                    analysis.thematicAnalysis.mainThemes.forEach(theme => {
                        allThemes[theme.theme] = (allThemes[theme.theme] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allThemes)
                .sort(([,a], [,b]) => b - a)
                .map(([theme]) => theme);
        }

        function findCommonCharacters(analysisData) {
            const allCharacters = {};
            analysisData.forEach(analysis => {
                if (analysis.characterAnalysis && analysis.characterAnalysis.characters) {
                    analysis.characterAnalysis.characters.forEach(character => {
                        allCharacters[character.name] = (allCharacters[character.name] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(allCharacters)
                .sort(([,a], [,b]) => b - a)
                .map(([character]) => character);
        }

        function calculateAverageSensitivity(analysisData) {
            let totalSensitivity = 0;
            let count = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis) {
                    totalSensitivity += analysis.sensitiveAnalysis.sensitivityScore || 0;
                    count++;
                }
            });
            
            return count > 0 ? totalSensitivity / count : 0;
        }

        function generateChapterTitle(chapterNumber, mainPlot, analysisData, includeAdultContent) {
            const normalTemplates = [
                `Khúc Dạo Đầu Buồn`,
                `Những Nghi Ngờ Đầu Tiên`,
                `Dấu Hiệu Của Sự Dối Trá`,
                `Cuộc Chạm Trán Bất Ngờ`,
                `Sự Thật Phũ Phàng`,
                `Nỗi Đau Không Thể Nói`,
                `Lựa Chọn Khó Khăn`,
                `Sống Trong Dối Trá`,
                `Khoảnh Khắc Yếu Lòng`,
                `Im Lặng Là Vàng`,
                `Trái Tim Tan Vỡ`,
                `Ngày Tháng Dài`,
                `Quyết Định Cuối Cùng`,
                `Lời Từ Biệt`,
                `Bình Minh Cô Đơn`
            ];
            
            const adultTemplates = [
                `Đêm Đầu Tiên`,
                `Cơn Khát Không Dập Tắt`,
                `Làn Da Nóng Bỏng`,
                `Ham Muốn Bùng Cháy`,
                `Cuồng Nhiệt Trong Tối`,
                `Khoái Cảm Tột Độ`,
                `Thân Thể Và Tâm Hồn`,
                `Đam Mê Không Kiềm Chế`,
                `Lần Đầu Tiên Em`,
                `Nóng Nực Cả Đêm`,
                `Tình Dục Và Yêu Thương`,
                `Cực Khoái Trong Đêm`,
                `Cuộc Yêu Điên Dại`,
                `Sung Sướng Tột Bậc`,
                `Hoàn Hồn Cùng Anh`
            ];
            
            const templates = includeAdultContent ? adultTemplates : normalTemplates;
            const templateIndex = chapterNumber % templates.length;
            return `Chương ${chapterNumber}: ${templates[templateIndex]}`;
        }

        function generateChapterContent(chapterNumber, chapterTitle, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            let content = `# ${chapterTitle}\n\n`;
            
            const paragraphs = 6 + Math.floor(Math.random() * 4);
            
            for (let i = 0; i < paragraphs; i++) {
                content += generateParagraph(chapterNumber, i, paragraphs, mainPlot, analysisData, sensitivityLevel, includeAdultContent) + '\n\n';
            }
            
            return content;
        }

        function generateParagraph(chapterNumber, paragraphIndex, totalParagraphs, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            const sentences = 3 + Math.floor(Math.random() * 3);
            let paragraph = '';
            
            for (let i = 0; i < sentences; i++) {
                paragraph += generateSentence(chapterNumber, paragraphIndex, totalParagraphs, i, sentences, mainPlot, analysisData, sensitivityLevel, includeAdultContent);
                if (i < sentences - 1) paragraph += ' ';
            }
            
            return paragraph;
        }

        function generateSentence(chapterNumber, paragraphIndex, totalParagraphs, sentenceIndex, totalSentences, mainPlot, analysisData, sensitivityLevel, includeAdultContent) {
            const sensitiveWordsList = extractSensitiveWordsFromAnalysis(analysisData);
            const dialogues = extractDialoguesFromAnalysis(analysisData);
            
            let sentenceTemplates = [];
            
            if (includeAdultContent && sensitivityLevel > 6) {
                sentenceTemplates = [
                    `Tôi cảm nhận được hơi thở nóng của ${mainPlot.mainCharacters[0] || 'cô ấy'} trên làn da mình.`,
                    `Đôi tay của tôi run rẩy khi chạm vào cơ thể mềm mại của ${mainPlot.mainCharacters[1] || 'em'}.`,
                    `Tiếng rên rỉ nhẹ nhàng của em khiến máu tôi sôi sục trong huyết quản.`,
                    `Chúng tôi hòa quyện trong nhau như hai dòng sông cuồn cuộn chảy về biển.`,
                    `Em bé nhỏ trong vòng tay tôi, những tiếng thở dốc của em khiến tôi điên cuồng.`,
                    `Căn phòng tối chỉ còn tiếng thở gấp của đôi ta và tiếng tim đập thình thịch.`,
                    `Tôi hôn lên từng inch da thịt của em, từ cổ xuống vai, rồi xuống thấp hơn.`,
                    `Em siết chặt tôi, móng tay cào vào lưng tôi khiến tôi cảm thấy đau đớn mà khoái cảm.`,
                    `"Anh yêu... em muốn..." em thì thầm vào tai tôi bằng giọng run rẩy.`,
                    `Chúng tôi cùng lên đỉnh trong sự cuồng nhiệt không thể kiểm soát.`
                ];
            } else if (includeAdultContent) {
                sentenceTemplates = [
                    `Ánh mắt ${mainPlot.mainCharacters[0] || 'cô ấy'} nhìn tôi đầy khao khát và ham muốn.`,
                    `Tôi cảm nhận được sức hút mạnh mẽ từ ${mainPlot.mainCharacters[1] || 'em'} mà không thể cưỡng lại.`,
                    `Những cái chạm tay tưởng chừng vô tình nhưng lại làm tim tôi rung động.`,
                    `Em nhìn tôi với đôi mắt ướt át, đầy ý nghĩa mà tôi hiểu ngay.`,
                    `Không khí trong phòng dần trở nên nóng bỏng và căng thẳng.`,
                    `Tôi biết rằng chúng ta đang vượt qua ranh giới mà không nên vượt.`,
                    `Cảm giác có em trong vòng tay thật ấm áp và tự nhiên đến lạ.`,
                    `"Em yêu anh..." câu nói ấy như một lời thú tội đầy tội lỗi.`,
                    `Chúng tôi biết điều này sai trái nhưng không thể dừng lại.`,
                    `Đêm nay sẽ thay đổi mọi thứ giữa chúng ta mãi mãi.`
                ];
            } else {
                sentenceTemplates = [
                    `Tôi nhìn thấy ${mainPlot.mainCharacters[0] || 'bố'} và ${mainPlot.mainCharacters[1] || 'vợ tôi'} trao đổi ánh mắt mà không dám lên tiếng.`,
                    `Trái tim tôi đau nhói khi chứng kiến cảnh tượng đó nhưng không thể làm gì.`,
                    `Mỗi lần thấy họ gần nhau, lòng tôi lại quặn thắt vì ghen tuông và tủi nhục.`,
                    `Tôi tự hỏi mình đã làm gì sai để phải chịu đựng sự phản bội này.`,
                    `Đêm nay lại một đêm dài trằn trọc với những suy nghĩ miên man.`,
                    `Tôi muốn hét lên cho cả thế giới biết sự thật, nhưng lại im lặng.`,
                    `Gia đình - hai tiếng ấy giờ đây trở nên thật xa lạ và giả dối.`,
                    `Tôi thấy mình thật bất lực, không dám đối mặt với sự thật phũ phàng.`,
                    `Nụ cười của vợ tôi với bố tôi sao có thể tươi đến thế?`,
                    `Im lặng có phải là vàng? Hay tôi chỉ đang hèn nhát?`
                ];
            }
            
            const templateIndex = (chapterNumber + paragraphIndex + sentenceIndex) % sentenceTemplates.length;
            let sentence = sentenceTemplates[templateIndex];
            
            // Thêm từ nhạy cảm nếu có
            if (sensitiveWordsList.length > 0 && Math.random() < (sensitivityLevel / 15)) {
                const sensitiveWord = sensitiveWordsList[Math.floor(Math.random() * sensitiveWordsList.length)];
                sentence = sentence.replace('.', ` ${sensitiveWord}.`);
            }
            
            // Thêm hội thoại
            if (dialogues.length > 0 && Math.random() < 0.25) {
                const dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
                sentence += ` Tôi nghe thấy: "${dialogue}"`;
            }
            
            return sentence;
        }

        function extractSensitiveWordsFromAnalysis(analysisData) {
            const words = [];
            
            analysisData.forEach(analysis => {
                if (analysis.sensitiveAnalysis && analysis.sensitiveAnalysis.categories) {
                    for (const category of Object.values(analysis.sensitiveAnalysis.categories)) {
                        for (const word of Object.keys(category.words)) {
                            if (!words.includes(word)) {
                                words.push(word);
                            }
                        }
                    }
                }
            });
            
            return words;
        }

        function extractDialoguesFromAnalysis(analysisData) {
            const dialogues = [];
            
            analysisData.forEach(analysis => {
                if (analysis.dialogueAnalysis && analysis.dialogueAnalysis.dialogues) {
                    analysis.dialogueAnalysis.dialogues.forEach(dialogue => {
                        if (dialogue.text && dialogue.text.length < 100) {
                            dialogues.push(dialogue.text);
                        }
                    });
                }
            });
            
            return dialogues.slice(0, 20);
        }

        // UI DISPLAY FUNCTIONS
        function displayAdvancedAnalysisResults() {
            const container = document.getElementById('analysisResults');
            container.innerHTML = '';
            
            if (analysisData.length === 0) {
                container.innerHTML = '<p>Chưa có dữ liệu phân tích.</p>';
                return;
            }
            
            // Tính toán tổng quan
            let emotionalScore = 0;
            let themeCount = 0;
            let dialogueCount = 0;
            let sensitiveWordCount = 0;
            let adultContentCount = 0;
            
            analysisData.forEach(analysis => {
                if (analysis.emotionalAnalysis) {
                    emotionalScore += parseFloat(analysis.emotionalAnalysis.sentimentScore) || 0;
                }
                if (analysis.thematicAnalysis) {
                    themeCount += analysis.thematicAnalysis.mainThemes.length;
                }
                if (analysis.dialogueAnalysis) {
                    dialogueCount += analysis.dialogueAnalysis.dialogueCount || 0;
                }
                if (analysis.sensitiveAnalysis) {
                    sensitiveWordCount += analysis.sensitiveAnalysis.totalSensitiveWords || 0;
                }
                if (analysis.adultContentAnalysis) {
                    adultContentCount += analysis.adultContentAnalysis.totalAdultWords || 0;
                }
            });
            
            emotionalScore = (emotionalScore / analysisData.length).toFixed(1);
            
            let html = `
                <div class="status-info">
                    <p>📊 Tổng quan phân tích ${analysisData.length} file</p>
                    <p>Điểm cảm xúc: ${emotionalScore}%</p>
                    <p>Số chủ đề phát hiện: ${themeCount}</p>
                    <p>Hội thoại phát hiện: ${dialogueCount}</p>
                    <p>Từ nhạy cảm: ${sensitiveWordCount}</p>
                    ${adultContentCount > 0 ? `<p class="adult-content-warning">⚠️ Nội dung 18+: ${adultContentCount} từ</p>` : ''}
                </div>
            `;
            
            // Hiển thị các cảm xúc chính
            const emotionalThemes = analysisData.flatMap(a => 
                a.emotionalAnalysis ? [a.emotionalAnalysis.overallTone] : []
            );
            
            const emotionalCounts = emotionalThemes.reduce((acc, tone) => {
                acc[tone] = (acc[tone] || 0) + 1;
                return acc;
            }, {});
            
            html += '<p>Cảm xúc chủ đạo:</p>';
            for (const [tone, count] of Object.entries(emotionalCounts)) {
                const emotionClass = tone === 'Tiêu cực' ? 'emotion-dau' : 
                                   tone === 'Tích cực' ? 'emotion-buon' : 'emotion-bat-luc';
                html += `<span class="emotion-tag ${emotionClass}">${tone} (${count})</span>`;
            }
            
            // Hiển thị từ nhạy cảm
            const sensitiveWords = extractSensitiveWordsFromAnalysis(analysisData);
            if (sensitiveWords.length > 0) {
                html += `<div style="margin: 10px 0;"><strong>Từ nhạy cảm phát hiện:</strong><br>`;
                sensitiveWords.slice(0, 15).forEach(word => {
                    html += `<span class="sensitive-word">${word}</span> `;
                });
                if (sensitiveWords.length > 15) {
                    html += `<span>... và ${sensitiveWords.length - 15} từ khác</span>`;
                }
                html += '</div>';
            }
            
            // Hiển thị mẫu hội thoại
            const sampleDialogues = [];
            analysisData.forEach(analysis => {
                if (analysis.dialogueAnalysis && analysis.dialogueAnalysis.dialogues) {
                    analysis.dialogueAnalysis.dialogues.forEach(dialogue => {
                        if (sampleDialogues.length < 5 && dialogue.text.length < 150) {
                            sampleDialogues.push(dialogue.text);
                        }
                    });
                }
            });
            
            if (sampleDialogues.length > 0) {
                html += `<div style="margin: 10px 0;"><strong>Mẫu hội thoại:</strong></div>`;
                sampleDialogues.forEach(dialogue => {
                    html += `<div class="dialogue">"${dialogue}"</div>`;
                });
            }
            
            // Hiển thị cảnh báo nội dung 18+ nếu có
            if (adultContentCount > 0) {
                html += `
                    <div class="adult-content-warning">
                        ⚠️ CẢNH BÁO: Phát hiện ${adultContentCount} từ/cụm từ 18+<br>
                        Nội dung có thể không phù hợp với mọi độ tuổi
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function displayLatestChapter(storyTitle, chapter, includeAdultContent) {
            const container = document.getElementById('generatedStories');
            let warningHtml = '';
            
            if (includeAdultContent || chapter.hasAdultContent) {
                warningHtml = `
                    <div class="adult-content-warning">
                        ⚠️ CẢNH BÁO 18+: Nội dung dành cho người trưởng thành
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${warningHtml}
                <div class="story-content">
                    <div class="chapter-title">${storyTitle} - ${chapter.title}</div>
                    <div>${chapter.content.substring(0, 400)}...</div>
                    <p><i>${chapter.wordCount} từ${chapter.hasAdultContent ? ' • 18+' : ''}</i></p>
                </div>
            `;
        }

        function displayGeneratedStories() {
            const container = document.getElementById('generatedStories');
            
            if (generatedStories.length === 0) {
                container.innerHTML = '<p>Chưa có truyện nào được tạo.</p>';
                return;
            }
            
            const story = generatedStories[generatedStories.length - 1];
            const latestChapter = story.chapters[story.chapters.length - 1];
            
            let warningHtml = '';
            if (story.hasAdultContent) {
                warningHtml = `
                    <div class="adult-content-warning">
                        ⚠️ CẢNH BÁO 18+: Truyện chứa nội dung dành cho người trưởng thành
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${warningHtml}
                <div class="story-content">
                    <div class="chapter-title">${story.title} - ${latestChapter.title}</div>
                    <div>${latestChapter.content.substring(0, 600)}...</div>
                    <p><i>Chương ${story.chapters.length}/${story.chapters.length} • ${story.totalWords} từ${story.hasAdultContent ? ' • 18+' : ''}</i></p>
                </div>
                <button class="btn btn-success" onclick="downloadStory()">
                    💾 Tải xuống truyện
                </button>
                <button class="btn btn-secondary" onclick="saveToGoogleDrive()">
                    ☁️ Lưu lên Drive
                </button>
            `;
        }

        // Tab switching function
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const menuItems = document.querySelectorAll('.menu-item');
            for (let item of menuItems) {
                if (item.textContent.includes(
                    tabId === 'tab-analysis' ? 'Phân tích' :
                    tabId === 'tab-write' ? 'Viết truyện' :
                    tabId === 'tab-stories' ? 'Thư viện' : 'Cài đặt'
                )) {
                    item.classList.add('active');
                    break;
                }
            }
            
            return false;
        }

        // UI Update Functions
        function updateStatus(message) {
            document.getElementById('statusInfo').innerHTML = `<p>${message}</p>`;
        }

        function updateDetailedStatus(message) {
            document.getElementById('detailedStatus').textContent = message;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function updateWriteStatus(message, detail) {
            document.getElementById('writeStatus').textContent = message;
            document.getElementById('writeDetailedStatus').textContent = detail;
        }

        function updateWriteProgress(percent) {
            document.getElementById('writeProgressBar').style.width = percent + '%';
        }

        // DOWNLOAD AND SAVE FUNCTIONS
        function downloadStory() {
            if (generatedStories.length === 0) {
                alert('Chưa có truyện nào để tải xuống!');
                return;
            }
            
            const story = generatedStories[generatedStories.length - 1];
            let content = `${story.title}\n`;
            content += `Tạo ngày: ${new Date(story.generatedAt).toLocaleString('vi-VN')}\n`;
            content += `Tổng số từ: ${story.totalWords}\n`;
            content += `Dựa trên phân tích: ${story.basedOnAnalysis} file\n`;
            if (story.hasAdultContent) {
                content += `⚠️ CẢNH BÁO: Nội dung 18+ - Dành cho người trưởng thành\n`;
            }
            content += `\n${'='.repeat(50)}\n\n`;
            
            story.chapters.forEach(chapter => {
                content += `${chapter.title}\n`;
                content += `${chapter.content}\n\n`;
                content += `--- Kết thúc ${chapter.title} ---\n\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${story.title.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateWriteStatus('💾 Đã tải xuống truyện', story.title);
        }

        async function saveToGoogleDrive() {
            if (generatedStories.length === 0) {
                alert('Chưa có truyện nào để lưu!');
                return;
            }
            
            updateWriteStatus('☁️ Đang lưu truyện lên Google Drive...', '');
            
            try {
                const story = generatedStories[generatedStories.length - 1];
                let content = `${story.title}\n`;
                content += `Tạo ngày: ${new Date(story.generatedAt).toLocaleString('vi-VN')}\n`;
                content += `Tổng số từ: ${story.totalWords}\n`;
                if (story.hasAdultContent) {
                    content += `⚠️ CẢNH BÁO: Nội dung 18+\n`;
                }
                content += `\n${'='.repeat(50)}\n\n`;
                
                story.chapters.forEach(chapter => {
                    content += `${chapter.title}\n`;
                    content += `${chapter.content}\n\n`;
                });
                
                const fileName = `${story.title.replace(/[^\w\s]/gi, '')}_${new Date().toISOString().split('T')[0]}.txt`;
                
                const fileMetadata = {
                    name: fileName,
                    parents: [''] // Lưu ở root, có thể thay đổi để lưu vào thư mục cụ thể
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([content], {type: 'text/plain'}));
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    }),
                    body: form
                });
                
                if (response.ok) {
                    updateWriteStatus('✅ Đã lưu truyện lên Google Drive', story.title);
                } else {
                    throw new Error('Lỗi khi lưu file');
                }
                
            } catch (error) {
                console.error('Error saving to Drive:', error);
                updateWriteStatus('❌ Lỗi khi lưu lên Google Drive', error.message);
            }
        }

        async function loadStories() {
            updateStatus('📚 Đang tải danh sách truyện từ Google Drive...');
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: "name contains 'Truyện' or name contains '.txt'",
                    fields: 'files(id, name, createdTime, size)',
                    orderBy: 'createdTime desc',
                    pageSize: 20
                });
                
                const files = response.result.files;
                const container = document.getElementById('storiesLibrary');
                
                if (files.length === 0) {
                    container.innerHTML = '<p>Không tìm thấy truyện nào trên Google Drive.</p>';
                    return;
                }
                
                let html = '<h4>📚 Danh sách truyện trên Google Drive:</h4>';
                files.forEach(file => {
                    const size = file.size ? `(${Math.round(file.size / 1024)} KB)` : '';
                    const date = new Date(file.createdTime).toLocaleDateString('vi-VN');
                    html += `
                        <div class="file-item">
                            <strong>📖 ${file.name}</strong><br>
                            <small>Tạo: ${date} ${size}</small>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateStatus('✅ Đã tải danh sách truyện');
                
            } catch (error) {
                console.error('Error loading stories:', error);
                updateStatus('❌ Lỗi khi tải danh sách truyện');
            }
        }

        async function clearCache() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu tạm? Điều này sẽ xóa dữ liệu quét và phân tích.')) {
                analysisData = [];
                txtFiles = [];
                scanData = null;
                generatedStories = [];
                
                document.getElementById('scannedFiles').innerHTML = '';
                document.getElementById('analysisResults').innerHTML = '<p>Chưa có dữ liệu phân tích.</p>';
                document.getElementById('generatedStories').innerHTML = '<p>Chưa có truyện nào được tạo.</p>';
                document.getElementById('storiesLibrary').innerHTML = '<p>Chưa có truyện nào trong thư viện.</p>';
                
                const buttons = ['analyzeBtn', 'generateBtn', 'downloadDataBtn'];
                buttons.forEach(id => document.getElementById(id).disabled = true);
                
                updateStatus('🗑️ Đã xóa tất cả dữ liệu tạm');
            }
        }

        // Initialize when page loads
        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            }
            
            updateStatus('🔴 Chưa kết nối Google Drive - Hãy kết nối để bắt đầu');
            
            // Cập nhật giá trị độ nhạy cảm
            document.getElementById('sensitivityLevel').addEventListener('input', function() {
                document.getElementById('sensitivityValue').textContent = this.value;
            });
            
            // Cảnh báo khi bật nội dung 18+
            document.getElementById('includeAdultContent').addEventListener('change', function() {
                if (this.checked) {
                    if (!confirm('⚠️ CẢNH BÁO: Bạn đang bật chế độ tạo nội dung 18+.\n\nNội dung này chỉ dành cho người trưởng thành và có thể chứa các yếu tố nhạy cảm.\n\nBạn có chắc chắn muốn tiếp tục?')) {
                        this.checked = false;
                    }
                }
            });
        };
    </script>
</body>
</html>
