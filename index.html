<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .auth-section { text-align: center; margin-bottom: 30px; }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; border: none; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; cursor: pointer;
            transition: all 0.3s ease; margin: 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-section {
            background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease;
        }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .history-section {
            background: #fff; border-radius: 15px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .history-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; }
        .history-list { max-height: 400px; overflow-y: auto; padding: 10px; }
        .history-item { padding: 15px 20px; border-bottom: 1px solid #eee; transition: background-color 0.3s ease; }
        .history-item:hover { background-color: #f8f9fa; }
        .story-title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .story-chapter { color: #666; font-size: 14px; margin-bottom: 5px; }
        .story-date { color: #999; font-size: 12px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Qu·∫£n l√Ω Truy·ªán</h1>
            <p>S·ª≠ d·ª•ng Google Drive l√†m Database</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            <div class="status" id="status"></div>
            <div id="mainApp" style="display: none;">
                <div class="form-section">
                    <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                    <form id="storyForm">
                        <div class="form-group">
                            <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                            <select id="storyMode" onchange="toggleStoryMode()">
                                <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                            </select>
                        </div>
                        <div class="form-group" id="newStoryGroup">
                            <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                            <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                        </div>
                        <div class="form-group" id="existingStoryGroup" style="display: none;">
                            <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                            <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                        </div>
                        <div class="form-group">
                            <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                            <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                        </div>
                        <div class="form-group">
                            <label for="storyContent">N·ªôi dung:</label>
                            <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                        </div>
                        <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                    </form>
                </div>
                <div class="grid">
                    <div class="history-section">
                        <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                        <div class="history-list" id="historyList"></div>
                    </div>
                    <div class="history-section">
                        <div class="history-header"><h2>üìÅ Th∆∞ m·ª•c Google Drive</h2></div>
                        <div class="history-list" id="folderList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];

// Kh·ªüi t·∫°o Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}
function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}
function maybeEnableButtons() { if (gapi_inited && gis_inited) document.getElementById('authorizeButton').style.display = 'inline-block'; }
function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { showStatus('L·ªói ƒëƒÉng nh·∫≠p: ' + resp.error, 'error'); return; }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
    else tokenClient.requestAccessToken({prompt: ''});
}
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(''); }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}
async function initializeApp() {
    showLoading(true);
    await createMainFolder(); await loadStoryHistory();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Kh·ªüi t·∫°o ·ª©ng d·ª•ng th√†nh c√¥ng!', 'success');
    showLoading(false);
}
async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) mainFolderId = response.result.files[0].id;
    else {
        const folder = await gapi.client.drive.files.create({ resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, fields: 'id' });
        mainFolderId = folder.result.id;
    }
}
async function createStoryFolder(storyTitle) {
    const folder = await gapi.client.drive.files.create({
        resource: { name: storyTitle, mimeType: 'application/vnd.google-apps.folder', parents: [mainFolderId] }, fields: 'id'
    });
    return folder.result.id;
}
async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId) {
    const fileMetadata = { name: `${chapterTitle}.txt`, parents: [storyFolderId] };
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}
async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', orderBy: 'createdTime desc'
    });
    const folders = response.result.files; storyHistory = [];
    for (let folder of folders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime)'
        });
        storyHistory.push({ storyTitle: folder.name, folderId: folder.id, createdTime: folder.createdTime, chapters: filesResponse.result.files });
    }
    displayHistory(); displayFolders();
}
function displayHistory() {
    const historyList = document.getElementById('historyList'); historyList.innerHTML = '';
    if (storyHistory.length === 0) { historyList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ truy·ªán n√†o</div>'; return; }
    storyHistory.forEach(story => {
        const historyItem = document.createElement('div'); historyItem.className = 'history-item';
        const chaptersText = story.chapters.map(ch => ch.name).join(', ');
        const date = new Date(story.createdTime).toLocaleString('vi-VN');
        historyItem.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">Ch∆∞∆°ng: ${chaptersText || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</div>
            <div class="story-date">${date}</div>
            <button class="btn" onclick="openStoryDetail('${story.folderId}')">üìñ Xem & Th√™m ch∆∞∆°ng</button>
        `;
        historyList.appendChild(historyItem);
    });
}
function openStoryDetail(folderId) {
    const story = storyHistory.find(s => s.folderId === folderId);
    if (!story) return;
    const detailHtml = `
        <h3>${story.storyTitle}</h3>
        <p><b>C√°c ch∆∞∆°ng:</b> ${story.chapters.map(ch => ch.name).join(', ') || 'Ch∆∞a c√≥ ch∆∞∆°ng'}</p>
        <form onsubmit="addChapter(event, '${story.folderId}', '${story.storyTitle}')">
            <input type="text" id="newChapterTitle" placeholder="T√™n ch∆∞∆°ng m·ªõi" required>
            <textarea id="newChapterContent" placeholder="N·ªôi dung ch∆∞∆°ng..." required></textarea>
            <button type="submit" class="btn">‚ûï Th√™m ch∆∞∆°ng</button>
        </form>
    `;
    document.getElementById('historyList').innerHTML = detailHtml;
}
async function addChapter(e, folderId, storyTitle) {
    e.preventDefault();
    const chapterTitle = document.getElementById('newChapterTitle').value.trim();
    const content = document.getElementById('newChapterContent').value.trim();
    if (!chapterTitle || !content) { showStatus("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); return; }
    showLoading(true);
    try {
        await saveStoryContent(storyTitle, chapterTitle, content, folderId);
        await loadStoryHistory();
        showStatus(`ƒê√£ th√™m ch∆∞∆°ng "${chapterTitle}" v√†o truy·ªán "${storyTitle}" th√†nh c√¥ng!`, "success");
    } catch (error) { showStatus("L·ªói th√™m ch∆∞∆°ng: " + error.message, "error"); }
    showLoading(false);
}
function displayFolders() {
    const folderList = document.getElementById('folderList'); folderList.innerHTML = '';
    if (storyHistory.length === 0) { folderList.innerHTML = '<div class="history-item">Ch∆∞a c√≥ th∆∞ m·ª•c n√†o</div>'; return; }
    storyHistory.forEach(story => {
        const folderItem = document.createElement('div'); folderItem.className = 'history-item';
        folderItem.innerHTML = `<div class="story-title">üìÅ ${story.storyTitle}</div><div class="story-chapter">${story.chapters.length} file(s)</div><div class="story-date">ID: ${story.folderId}</div>`;
        folderList.appendChild(folderItem);
    });
}
document.getElementById('storyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const storyTitle = document.getElementById('storyTitle').value.trim();
    const chapterTitle = document.getElementById('chapterTitle').value.trim();
    const storyContent = document.getElementById('storyContent').value.trim();
    if (!storyTitle || !chapterTitle || !storyContent) { showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error'); return; }
    showLoading(true);
    try {
        let storyFolderId = null;
        const existingStory = storyHistory.find(story => story.storyTitle === storyTitle);
        if (existingStory) storyFolderId = existingStory.folderId;
        else storyFolderId = await createStoryFolder(storyTitle);
        await saveStoryContent(storyTitle, chapterTitle, storyContent, storyFolderId);
        document.getElementById('storyForm').reset();
        await loadStoryHistory();
        showStatus(`ƒê√£ l∆∞u truy·ªán "${storyTitle}" - Ch∆∞∆°ng "${chapterTitle}" th√†nh c√¥ng!`, 'success');
    } catch (error) { showStatus('L·ªói l∆∞u truy·ªán: ' + error.message, 'error'); }
    showLoading(false);
});
function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
function showStatus(message, type) {
    const status = document.getElementById('status');
    status.textContent = message; status.className = `status ${type}`; status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 5000);
}
document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
window.addEventListener('load', function() { if (CLIENT_ID && API_KEY) { setTimeout(() => { initializeGapi(); initializeGis(); }, 1000); } });
</script>
</body>
</html>
