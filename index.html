<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Truy·ªán</title>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .auth-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: none;
        }

        .story-form {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .story-list {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .story-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .story-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .story-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .story-chapters {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .chapter-list {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .chapter-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #e1e1e1;
        }

        .chapter-title {
            font-weight: 600;
            color: #444;
            margin-bottom: 5px;
        }

        .chapter-content {
            color: #666;
            font-size: 14px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .toggle-chapters {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .toggle-chapters:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .story-form, .story-list {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Qu·∫£n l√Ω Truy·ªán</h1>
            <p style="color: rgba(255,255,255,0.8); font-size: 1.1em;">L∆∞u tr·ªØ v√† qu·∫£n l√Ω truy·ªán c·ªßa b·∫°n tr√™n Google Drive</p>
        </div>

        <div class="auth-section">
            <div id="auth-content">
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <h2 style="margin-bottom: 10px; font-size: 1.8em;">üöÄ S·∫µn s√†ng b·∫Øt ƒë·∫ßu</h2>
                    <p style="opacity: 0.95; font-size: 1.1em;">Qu·∫£n l√Ω truy·ªán c·ªßa b·∫°n v·ªõi Google Drive</p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìö T√≠nh nƒÉng</h3>
                    <ul style="color: #666; margin-bottom: 0; padding-left: 20px; line-height: 1.6;">
                        <li>L∆∞u tr·ªØ truy·ªán tr√™n Google Drive c·ªßa b·∫°n</li>
                        <li>T·ª± ƒë·ªông t·∫°o th∆∞ m·ª•c cho t·ª´ng truy·ªán</li>
                        <li>Qu·∫£n l√Ω c√°c ch∆∞∆°ng m·ªôt c√°ch c√≥ t·ªï ch·ª©c</li>
                        <li>Xem l·∫°i l·ªãch s·ª≠ truy·ªán ƒë√£ vi·∫øt</li>
                    </ul>
                </div>
                <button id="manual-auth-btn" class="btn" style="font-size: 1.1em; padding: 18px 35px;">
                    üîê K·∫øt n·ªëi v·ªõi Google Drive
                </button>
                <p style="margin-top: 20px; color: #888; font-size: 13px; line-height: 1.4;">
                    <strong>üîí B·∫£o m·∫≠t:</strong> ·ª®ng d·ª•ng ch·ªâ c√≥ th·ªÉ truy c·∫≠p v√† ch·ªânh s·ª≠a c√°c file do ch√≠nh n√≥ t·∫°o ra. 
                    Kh√¥ng th·ªÉ xem hay s·ª≠a ƒë·ªïi file kh√°c tr√™n Google Drive c·ªßa b·∫°n.
                </p>
                <div id="connection-status" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="main-content" id="main-content">
            <div class="story-form">
                <h2 style="margin-bottom: 25px; color: #333;">‚úçÔ∏è Th√™m truy·ªán m·ªõi</h2>
                <form id="story-form">
                    <div class="form-group">
                        <label for="story-name">T√™n truy·ªán:</label>
                        <input type="text" id="story-name" required placeholder="Nh·∫≠p t√™n truy·ªán...">
                    </div>
                    <div class="form-group">
                        <label for="chapter-title">Ti√™u ƒë·ªÅ ch∆∞∆°ng:</label>
                        <input type="text" id="chapter-title" required placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1 - B·∫Øt ƒë·∫ßu">
                    </div>
                    <div class="form-group">
                        <label for="chapter-content">N·ªôi dung ch∆∞∆°ng:</label>
                        <textarea id="chapter-content" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                    </div>
                    <button type="submit" class="btn" id="save-btn">üíæ L∆∞u truy·ªán</button>
                </form>
                <div id="message-area"></div>
            </div>

            <div class="story-list">
                <h2 style="margin-bottom: 25px; color: #333;">üìñ L·ªãch s·ª≠ truy·ªán</h2>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i danh s√°ch truy·ªán...</p>
                </div>
                <div id="story-list-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyAbcWr0UPvC4YpsunE6uAa7E5pan9iys2o';
        const CLIENT_ID = '398509518475-7bjid324tkuuh9gv8b0g92lhsgv8nrl5.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapi, tokenClient;
        let isSignedIn = false;
        let mainFolderId = null;

        // Kh·ªüi t·∫°o Google API
        async function initializeGapi() {
            try {
                console.log('Initializing GAPI...');
                
                // Ki·ªÉm tra l·∫°i GAPI m·ªôt l·∫ßn n·ªØa
                if (typeof gapi === 'undefined' || !gapi.load) {
                    throw new Error('GAPI ch∆∞a s·∫µn s√†ng');
                }
                
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                    throw new Error('Google Sign-In ch∆∞a s·∫µn s√†ng');
                }
                
                console.log('Both GAPI and Google Sign-In are ready');
                
                // Load gapi client v·ªõi timeout
                console.log('Loading GAPI client...');
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('GAPI client load timeout'));
                    }, 10000);
                    
                    gapi.load('client', {
                        callback: () => {
                            clearTimeout(timeout);
                            console.log('GAPI client loaded successfully');
                            resolve();
                        },
                        onerror: (error) => {
                            clearTimeout(timeout);
                            console.error('GAPI client load error:', error);
                            reject(new Error('Kh√¥ng th·ªÉ t·∫£i GAPI client'));
                        }
                    });
                });
                
                console.log('Initializing GAPI client...');
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC]
                });

                console.log('GAPI client initialized successfully');

                // Initialize OAuth2 token client
                console.log('Initializing OAuth2 token client...');
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                    error_callback: (error) => {
                        console.error('OAuth error:', error);
                        showMessage('L·ªói x√°c th·ª±c OAuth: ' + (error.type || error.message), 'error');
                    }
                });

                console.log('All initialization completed successfully!');
                
                // Update UI to show success
                updateConnectionStatus('K·∫øt n·ªëi th√†nh c√¥ng! S·∫µn s√†ng ƒëƒÉng nh·∫≠p.', 'success');
                
                document.getElementById('auth-content').innerHTML = `
                    <div style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                        <h2 style="margin-bottom: 10px; font-size: 1.8em;">üéâ S·∫µn s√†ng k·∫øt n·ªëi!</h2>
                        <p style="opacity: 0.95; font-size: 1.1em;">Google Drive API ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p th√†nh c√¥ng</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">üîê ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h3>
                        <p style="margin-bottom: 15px; color: #666;">
                            Click n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Google c·ªßa b·∫°n v√† c·∫•p quy·ªÅn truy c·∫≠p Google Drive.
                        </p>
                        <ul style="color: #666; margin-bottom: 15px; padding-left: 20px;">
                            <li>·ª®ng d·ª•ng s·∫Ω t·∫°o th∆∞ m·ª•c "Truy·ªán" tr√™n Drive</li>
                            <li>M·ªói truy·ªán s·∫Ω c√≥ th∆∞ m·ª•c ri√™ng</li>
                            <li>C√°c ch∆∞∆°ng ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng file .txt</li>
                        </ul>
                    </div>
                    <button id="auth-btn" class="btn" style="font-size: 1.1em; padding: 18px 35px;">
                        üîê ƒêƒÉng nh·∫≠p v·ªõi Google Drive
                    </button>
                    <p style="margin-top: 20px; color: #888; font-size: 13px; line-height: 1.4;">
                        <strong>üîí B·∫£o m·∫≠t:</strong> ·ª®ng d·ª•ng ch·ªâ c√≥ th·ªÉ truy c·∫≠p v√† ch·ªânh s·ª≠a c√°c file do ch√≠nh n√≥ t·∫°o ra. 
                        Kh√¥ng th·ªÉ xem hay s·ª≠a ƒë·ªïi file kh√°c tr√™n Google Drive c·ªßa b·∫°n.
                    </p>
                `;
                
                setupAuthButton();
                
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showConnectionError(error.message || 'L·ªói kh·ªüi t·∫°o Google API');
            }
        }

        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connection-status');
            if (!statusDiv) return;
            
            let bgColor, borderColor, textColor;
            
            switch(type) {
                case 'loading':
                    bgColor = '#e3f2fd';
                    borderColor = '#2196f3';
                    textColor = '#1565c0';
                    break;
                case 'success':
                    bgColor = '#e8f5e8';
                    borderColor = '#4CAF50';
                    textColor = '#2e7d32';
                    break;
                case 'error':
                    bgColor = '#ffebee';
                    borderColor = '#f44336';
                    textColor = '#c62828';
                    break;
            }
            
            statusDiv.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; color: ${textColor}; padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px;">
                    ${type === 'loading' ? '<div class="spinner" style="margin: 0 auto 10px auto;"></div>' : ''}
                    <p style="margin: 0;">${message}</p>
                </div>
            `;
        }

        function showConnectionError(errorMessage) {
            const manualAuthBtn = document.getElementById('manual-auth-btn');
            if (manualAuthBtn) {
                manualAuthBtn.disabled = false;
                manualAuthBtn.textContent = 'üîÑ Th·ª≠ l·∫°i k·∫øt n·ªëi';
            }
            
            updateConnectionStatus(errorMessage, 'error');
            
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML += `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 10px; margin-top: 10px;">
                    <h4 style="margin-bottom: 10px;">üí° Th·ª≠ c√°c c√°ch sau:</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                        <li>Ki·ªÉm tra k·∫øt n·ªëi internet</li>
                        <li>T·∫Øt tr√¨nh ch·∫∑n qu·∫£ng c√°o (AdBlock, uBlock Origin)</li>
                        <li>Th·ª≠ tr√¨nh duy·ªát kh√°c (Chrome ƒë∆∞·ª£c khuy√™n d√πng)</li>
                        <li>T·∫Øt VPN n·∫øu ƒëang s·ª≠ d·ª•ng</li>
                    </ul>
                </div>
            `;
        }

        function setupAuthButton() {
            const authBtn = document.getElementById('auth-btn');
            authBtn.onclick = () => {
                tokenClient.requestAccessToken();
            };
        }

        function handleAuthCallback(response) {
            if (response.error) {
                console.error('Auth error:', response);
                showMessage('L·ªói x√°c th·ª±c: ' + response.error, 'error');
                return;
            }

            isSignedIn = true;
            document.querySelector('.auth-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            initializeApp();
        }

        async function initializeApp() {
            try {
                await createMainFolder();
                await loadStories();
                setupForm();
            } catch (error) {
                console.error('Error initializing app:', error);
                showMessage('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: ' + error.message, 'error');
            }
        }

        async function createMainFolder() {
            try {
                // T√¨m th∆∞ m·ª•c ch√≠nh
                const response = await gapi.client.drive.files.list({
                    q: "name='Truy·ªán' and mimeType='application/vnd.google-apps.folder'",
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    mainFolderId = response.result.files[0].id;
                    console.log('Found existing main folder:', mainFolderId);
                } else {
                    // T·∫°o th∆∞ m·ª•c ch√≠nh m·ªõi
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'Truy·ªán',
                            mimeType: 'application/vnd.google-apps.folder'
                        }
                    });
                    mainFolderId = createResponse.result.id;
                    console.log('Created new main folder:', mainFolderId);
                }
            } catch (error) {
                console.error('Error creating main folder:', error);
                throw error;
            }
        }

        async function createStoryFolder(storyName) {
            try {
                // Ki·ªÉm tra xem th∆∞ m·ª•c truy·ªán ƒë√£ t·ªìn t·∫°i ch∆∞a
                const response = await gapi.client.drive.files.list({
                    q: `name='${storyName}' and parents='${mainFolderId}' and mimeType='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // T·∫°o th∆∞ m·ª•c truy·ªán m·ªõi
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: storyName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [mainFolderId]
                    }
                });

                return createResponse.result.id;
            } catch (error) {
                console.error('Error creating story folder:', error);
                throw error;
            }
        }

        async function saveChapter(storyName, chapterTitle, chapterContent) {
            try {
                const storyFolderId = await createStoryFolder(storyName);
                
                // T·∫°o file ch∆∞∆°ng
                const fileMetadata = {
                    name: `${chapterTitle}.txt`,
                    parents: [storyFolderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([chapterContent], {type: 'text/plain'}));

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    },
                    body: form
                });

                if (!response.ok) {
                    throw new Error('Failed to upload chapter');
                }

                return await response.json();
            } catch (error) {
                console.error('Error saving chapter:', error);
                throw error;
            }
        }

        async function loadStories() {
            const loadingEl = document.getElementById('loading');
            const storyListEl = document.getElementById('story-list-content');
            
            try {
                loadingEl.style.display = 'block';
                storyListEl.innerHTML = '';

                // L·∫•y danh s√°ch th∆∞ m·ª•c truy·ªán
                const response = await gapi.client.drive.files.list({
                    q: `parents='${mainFolderId}' and mimeType='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name, createdTime)',
                    orderBy: 'createdTime desc'
                });

                const stories = response.result.files;

                if (stories.length === 0) {
                    storyListEl.innerHTML = '<p style="text-align: center; color: #666;">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                } else {
                    for (const story of stories) {
                        await renderStoryItem(story, storyListEl);
                    }
                }
            } catch (error) {
                console.error('Error loading stories:', error);
                storyListEl.innerHTML = '<p style="text-align: center; color: #d32f2f;">L·ªói t·∫£i danh s√°ch truy·ªán.</p>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        async function renderStoryItem(story, container) {
            try {
                // L·∫•y danh s√°ch ch∆∞∆°ng
                const chaptersResponse = await gapi.client.drive.files.list({
                    q: `parents='${story.id}' and mimeType!='application/vnd.google-apps.folder'`,
                    fields: 'files(id, name, createdTime)',
                    orderBy: 'createdTime asc'
                });

                const chapters = chaptersResponse.result.files;
                
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story-item';
                storyDiv.innerHTML = `
                    <div class="story-title">${story.name}</div>
                    <div class="story-chapters">${chapters.length} ch∆∞∆°ng</div>
                    <button class="toggle-chapters" onclick="toggleChapters('${story.id}')">
                        Xem ch∆∞∆°ng
                    </button>
                    <div class="chapter-list" id="chapters-${story.id}">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>ƒêang t·∫£i ch∆∞∆°ng...</p>
                        </div>
                    </div>
                `;

                container.appendChild(storyDiv);

                // L∆∞u tr·ªØ th√¥ng tin ch∆∞∆°ng ƒë·ªÉ s·ª≠ d·ª•ng sau
                storyDiv.dataset.chapters = JSON.stringify(chapters);
            } catch (error) {
                console.error('Error rendering story item:', error);
            }
        }

        async function toggleChapters(storyId) {
            const chaptersDiv = document.getElementById(`chapters-${storyId}`);
            
            if (chaptersDiv.style.display === 'block') {
                chaptersDiv.style.display = 'none';
                return;
            }

            chaptersDiv.style.display = 'block';
            
            // N·∫øu ƒë√£ t·∫£i r·ªìi th√¨ kh√¥ng t·∫£i l·∫°i
            if (chaptersDiv.querySelector('.chapter-item')) {
                return;
            }

            try {
                const storyDiv = chaptersDiv.closest('.story-item');
                const chapters = JSON.parse(storyDiv.dataset.chapters);
                
                chaptersDiv.innerHTML = '';
                
                for (const chapter of chapters) {
                    const content = await getFileContent(chapter.id);
                    const chapterDiv = document.createElement('div');
                    chapterDiv.className = 'chapter-item';
                    chapterDiv.innerHTML = `
                        <div class="chapter-title">${chapter.name.replace('.txt', '')}</div>
                        <div class="chapter-content">${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</div>
                    `;
                    chaptersDiv.appendChild(chapterDiv);
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
                chaptersDiv.innerHTML = '<p style="color: #d32f2f;">L·ªói t·∫£i ch∆∞∆°ng.</p>';
            }
        }

        async function getFileContent(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                console.error('Error getting file content:', error);
                return 'Kh√¥ng th·ªÉ t·∫£i n·ªôi dung';
            }
        }

        function setupForm() {
            const form = document.getElementById('story-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';
                saveBtn.disabled = true;

                try {
                    const storyName = document.getElementById('story-name').value.trim();
                    const chapterTitle = document.getElementById('chapter-title').value.trim();
                    const chapterContent = document.getElementById('chapter-content').value.trim();

                    if (!storyName || !chapterTitle || !chapterContent) {
                        throw new Error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                    }

                    await saveChapter(storyName, chapterTitle, chapterContent);
                    
                    showMessage('‚úÖ L∆∞u truy·ªán th√†nh c√¥ng!', 'success');
                    
                    // Reset form
                    document.getElementById('chapter-title').value = '';
                    document.getElementById('chapter-content').value = '';
                    
                    // T·∫£i l·∫°i danh s√°ch truy·ªán
                    await loadStories();
                    
                } catch (error) {
                    console.error('Error saving story:', error);
                    showMessage('‚ùå L·ªói l∆∞u truy·ªán: ' + error.message, 'error');
                } finally {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            });
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        function initApp() {
            console.log('App ready, waiting for user to click login button');
            setupManualAuth();
        }

        function setupManualAuth() {
            const manualAuthBtn = document.getElementById('manual-auth-btn');
            const statusDiv = document.getElementById('connection-status');
            
            manualAuthBtn.onclick = () => {
                manualAuthBtn.disabled = true;
                manualAuthBtn.textContent = '‚è≥ ƒêang k·∫øt n·ªëi...';
                
                statusDiv.innerHTML = `
                    <div style="background: #e3f2fd; border: 1px solid #2196f3; color: #1565c0; padding: 15px; border-radius: 10px; text-align: center;">
                        <div class="spinner" style="margin: 0 auto 10px auto;"></div>
                        <p style="margin: 0;">ƒêang t·∫£i Google API v√† thi·∫øt l·∫≠p k·∫øt n·ªëi...</p>
                    </div>
                `;
                
                loadGoogleAPI();
            };
        }

        function loadGoogleAPI() {
            console.log('Loading Google API...');
            updateConnectionStatus('ƒêang t·∫£i Google API...', 'loading');
            
            // X√≥a script c≈© n·∫øu c√≥
            const existingScript = document.querySelector('script[src*="apis.google.com"]');
            if (existingScript) {
                existingScript.remove();
            }
            
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                console.log('GAPI script loaded, waiting for initialization...');
                updateConnectionStatus('Google API ƒë√£ t·∫£i, ƒëang kh·ªüi t·∫°o...', 'loading');
                // ƒê·ª£i gapi ƒë∆∞·ª£c kh·ªüi t·∫°o ho√†n to√†n
                waitForGapi().then(() => {
                    console.log('GAPI ready, loading Google Sign-In...');
                    loadGoogleSignIn();
                }).catch(error => {
                    console.error('GAPI wait failed:', error);
                    showConnectionError('Google API kh√¥ng th·ªÉ kh·ªüi t·∫°o. ' + error.message);
                });
            };
            script.onerror = () => {
                console.error('Failed to load GAPI script');
                showConnectionError('Kh√¥ng th·ªÉ t·∫£i Google API. Ki·ªÉm tra k·∫øt n·ªëi internet v√† t·∫Øt tr√¨nh ch·∫∑n qu·∫£ng c√°o.');
            };
            document.head.appendChild(script);
        }

        function waitForGapi() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30;
                
                const checkGapi = () => {
                    attempts++;
                    console.log(`Checking GAPI availability... attempt ${attempts}`);
                    
                    if (typeof gapi !== 'undefined' && gapi.load) {
                        console.log('GAPI is available');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('GAPI kh√¥ng t·∫£i ƒë∆∞·ª£c sau nhi·ªÅu l·∫ßn th·ª≠'));
                    } else {
                        setTimeout(checkGapi, 200);
                    }
                };
                
                checkGapi();
            });
        }

        function loadGoogleSignIn() {
            console.log('Loading Google Sign-In...');
            updateConnectionStatus('ƒêang t·∫£i Google Sign-In...', 'loading');
            
            // X√≥a script c≈© n·∫øu c√≥
            const existingScript = document.querySelector('script[src*="accounts.google.com"]');
            if (existingScript) {
                existingScript.remove();
            }
            
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = () => {
                console.log('Google Sign-In script loaded, waiting for initialization...');
                updateConnectionStatus('Google Sign-In ƒë√£ t·∫£i, ƒëang thi·∫øt l·∫≠p...', 'loading');
                waitForGoogleSignIn().then(() => {
                    console.log('Google Sign-In ready, initializing GAPI...');
                    initializeGapi();
                }).catch(error => {
                    console.error('Google Sign-In wait failed:', error);
                    showConnectionError('Google Sign-In kh√¥ng th·ªÉ kh·ªüi t·∫°o. ' + error.message);
                });
            };
            script.onerror = () => {
                console.error('Failed to load Google Sign-In script');
                showConnectionError('Kh√¥ng th·ªÉ t·∫£i Google Sign-In. Ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.');
            };
            document.head.appendChild(script);
        }

        function waitForGoogleSignIn() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30;
                
                const checkGoogle = () => {
                    attempts++;
                    console.log(`Checking Google Sign-In availability... attempt ${attempts}`);
                    
                    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        console.log('Google Sign-In is available');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Google Sign-In kh√¥ng t·∫£i ƒë∆∞·ª£c sau nhi·ªÅu l·∫ßn th·ª≠'));
                    } else {
                        setTimeout(checkGoogle, 200);
                    }
                };
                
                checkGoogle();
            });
        }

        function showInitError(message) {
            showConnectionError(message);
        }

        // Kh·ªüi t·∫°o khi DOM s·∫µn s√†ng
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Backup: th·ª≠ l·∫°i sau 3 gi√¢y n·∫øu ch∆∞a kh·ªüi t·∫°o
        setTimeout(() => {
            if (!isSignedIn && document.getElementById('main-content').style.display !== 'block') {
                console.log('Backup initialization attempt...');
                initApp();
            }
        }, 3000);
    </script>
</body>
</html>
