<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qu·∫£n l√Ω Truy·ªán - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Th√™m style cho c·∫£nh b√°o n·ªôi dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* ·∫®n n·ªôi dung nh·∫°y c·∫£m m·∫∑c ƒë·ªãnh */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Truy·ªán Manager</h1>
            <p>Qu·∫£n l√Ω & Hu·∫•n luy·ªán AI v·ªõi Google Drive - Ch·ªß ƒë·ªÅ chuy√™n bi·ªát</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">üîê ƒêƒÉng nh·∫≠p Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">üß† Hu·∫•n luy·ªán AI</button>
                    <button id="menuGeneration" class="btn success">üìñ AI T·∫°o Truy·ªán</button>
                    <button id="menuManagement" class="btn">‚úèÔ∏è Qu·∫£n l√Ω Truy·ªán</button>
                    <button id="menuHistory" class="btn">üìö L·ªãch s·ª≠ Truy·ªán</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>üß† Hu·∫•n luy·ªán AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>T·ªïng s·ªë file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>ƒê√£ hu·∫•n luy·ªán:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>C·∫•u tr√∫c c√¢u:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>T√¨nh ti·∫øt:</span>
                                <span id="plotPoints">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Di·ªÖn bi·∫øn c·∫£m x√∫c:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                            <div class="stat-item">
                                <span>H·ªôi tho·∫°i:</span>
                                <span id="dialoguesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>B·ªëi c·∫£nh:</span>
                                <span id="contextsCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Nh√¢n v·∫≠t:</span>
                                <span id="charactersCount">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">üéØ B·∫Øt ƒë·∫ßu hu·∫•n luy·ªán AI</button>
                        <button id="resetAiButton" class="btn danger">üîÑ Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>üìñ AI T·∫°o Truy·ªán T·ª± ƒê·ªông</h2>
                        
                        <div class="adult-warning">
                            ‚ö†Ô∏è C·∫£nh b√°o: AI s·∫Ω t·∫°o n·ªôi dung theo ng√¥i th·ª© nh·∫•t v√† c√≥ th·ªÉ ch·ª©a n·ªôi dung 18+.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="S·ªë ch∆∞∆°ng (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">üöÄ AI T·∫°o Truy·ªán M·ªõi</button>
                            <button id="viewAiStoriesButton" class="btn">üìö Xem Truy·ªán AI ƒê√£ T·∫°o</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>‚úèÔ∏è Th√™m Truy·ªán / Ch∆∞∆°ng M·ªõi</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Ch·∫ø ƒë·ªô:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">T·∫°o truy·ªán m·ªõi</option>
                                    <option value="existing">Th√™m ch∆∞∆°ng v√†o truy·ªán c√≥ s·∫µn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">T√™n Truy·ªán M·ªõi:</label>
                                <input type="text" id="storyTitle" placeholder="Nh·∫≠p t√™n truy·ªán m·ªõi...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Ch·ªçn Truy·ªán C√≥ S·∫µn:</label>
                                <select id="existingStory"><option value="">-- Ch·ªçn truy·ªán --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">T√™n Ch∆∞∆°ng:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nh·∫≠p t√™n ch∆∞∆°ng...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">N·ªôi dung:</label>
                                <textarea id="storyContent" required placeholder="Nh·∫≠p n·ªôi dung truy·ªán..."></textarea>
                            </div>
                            <button type="submit" class="btn">üíæ <span id="submitButtonText">L∆∞u Truy·ªán M·ªõi</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>üìñ L·ªãch s·ª≠ Truy·ªán</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>üóÇ Th∆∞ m·ª•c Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>üìö Truy·ªán ƒê∆∞·ª£c T·∫°o B·ªüi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Ch∆∞∆°ng Truy·ªán</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">‚úèÔ∏è S·ª≠a Ch∆∞∆°ng</button>
                <button class="btn danger" onclick="deleteChapter()">üóëÔ∏è X√≥a Ch∆∞∆°ng</button>
                <button class="btn" onclick="saveChapterChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
                <button class="btn" onclick="cancelEdit()">‚ùå H·ªßy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set(),
    transitionWords: new Set(),
    psychologicalTerms: new Set(),
    descriptivePatterns: new Set(),
    metaphors: new Set(),
    adultTerms: new Set(),
    characterNames: new Set(),
    locations: new Set(),
    timeFrames: new Set(),
    situations: new Set(),
    generationHistory: [],
    processedFiles: new Set(), // L∆∞u tr·ªØ ID c√°c file ƒë√£ x·ª≠ l√Ω
    qualityMetrics: {
        complexityThreshold: 0.6,
        coherenceThreshold: 0.7,
        emotionThreshold: 0.65,
        targetWordCount: 3500
    }
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// T·ª´ v·ª±ng v√† c·∫•u tr√∫c chuy√™n bi·ªát
const specializedVocabulary = {
    familyRelations: ['b·ªë ch·ªìng', 'con d√¢u', 'ch·ªìng', 'v·ª£', 'gia ƒë√¨nh', 'h·ªç h√†ng', 'm·ªëi quan h·ªá', 'ph√©p t·∫Øc', 'ranh gi·ªõi', 
                     'quy·ªÅn l·ª±c gia tr∆∞·ªüng', 'vai v·∫ø', 't√¥n ti tr·∫≠t t·ª±', 'n·ªÅ n·∫øp gia ƒë√¨nh', 'quan h·ªá huy·∫øt th·ªëng'],
    emotions: ['cƒÉng th·∫≥ng', 'b·ªëi r·ªëi', 'ghen t·ªã', 't√≤ m√≤', 'lo l·∫Øng', 'th√®m mu·ªën', 'khao kh√°t', 't·ªôi l·ªói', 'x·∫•u h·ªï', 
              'k√≠ch th√≠ch', 'd·ª•c v·ªçng', 'b·∫•t an', 'day d·ª©t', 'd·∫±n v·∫∑t', 'gi·∫±ng x√©', 'ng·ªù v·ª±c', '√°m ·∫£nh', 'kh·∫Øc kho·∫£i',
              'x√≥t xa', 'ƒëau ƒë·ªõn', 't√™ t√°i', 'ng·ªôt ng·∫°t', 'b·ª©c b·ªëi', 'r·ªëi b·ªùi', 'hoang mang'],
    observations: ['quan s√°t', 'nh√¨n tr·ªôm', 'theo d√µi', 'ch√∫ √Ω', 'ph√°t hi·ªán', 'ƒë·ªÉ √Ω', 'nh·∫≠n ra', 'th·∫•y ƒë∆∞·ª£c', 'c·∫£m nh·∫≠n', 
                  'nghe ƒë∆∞·ª£c', 'kh√°m ph√°', 'v√¥ t√¨nh ch·ª©ng ki·∫øn', 'b·∫Øt g·∫∑p', 'nh·∫≠n th·∫•y', 'th·∫•u hi·ªÉu', 'th·∫•u c·∫£m'],
    innerThoughts: ['t√¥i nghƒ©', 'trong t√¢m tr√≠ t√¥i', 't√¥i t·ª± h·ªèi', 'c√≥ l·∫Ω', 'li·ªáu r·∫±ng', 't√¥i kh√¥ng th·ªÉ tin ƒë∆∞·ª£c', 
                   't√¥i c·∫£m th·∫•y', 'ƒëi·ªÅu n√†y khi·∫øn t√¥i', 't√¥i nh·∫≠n ra', 't√¥i ch·ª£t hi·ªÉu', 't√¥i ng·ª° ng√†ng', 
                   't√¥i gi·∫≠t m√¨nh nh·∫≠n th·∫•y', 't√¥i b√†ng ho√†ng', 't√¥i s·ª≠ng s·ªët'],
    secretive: ['b√≠ m·∫≠t', 'gi·∫•u k√≠n', 'che gi·∫•u', 'l√©n l√∫t', 'th·∫ßm k√≠n', 'k√≠n ƒë√°o', '√¢m th·∫ßm', 'kh√¥ng ai bi·∫øt', 
               'ch·ªâ m√¨nh t√¥i', 'im l·∫∑ng', 'n√©n ch·∫∑t', 'gi·ªØ k√≠n trong l√≤ng', 'kh√¥ng d√°m th·ªï l·ªô'],
    physicalDescriptions: ['ƒë√¥i m·∫Øt', 'n·ª• c∆∞·ªùi', 'c·ª≠ ch·ªâ', '√°nh m·∫Øt', 'c√°ch di chuy·ªÉn', 'gi·ªçng n√≥i', 'c√°ch c∆∞·ªùi', 
                          'bi·ªÉu c·∫£m', 'd√°ng v·∫ª', 'b·ªù m√¥i', 'm√°i t√≥c', 'b√†n tay', 'v√≤ng eo', 'c·ª≠ ƒë·ªông', 'h∆°i th·ªü',
                          'nh·ªãp tim', 'l√†n da', 'n√©t m·∫∑t', 'c∆° th·ªÉ', 'v√≤ng m·ªôt', 'v√≤ng ba', 'v√≥c d√°ng', 'ƒë∆∞·ªùng cong'],
    situations: ['b·ªØa c∆°m gia ƒë√¨nh', 'khi v·ª£ ƒëi v·∫Øng', 'cu·ªëi tu·∫ßn', 'nh·ªØng bu·ªïi t·ªëi', 'l√∫c m·ªôt m√¨nh', 'khi kh√¥ng ai ch√∫ √Ω',
                'ƒë√™m khuya', 's√°ng s·ªõm', 'khi t·∫Øm r·ª≠a', 'l√∫c thay ƒë·ªì', 'khi u·ªëng r∆∞·ª£u', 'trong ph√≤ng ng·ªß', 
                'ngo√†i v∆∞·ªùn', 'trong b·∫øp', 'tr√™n gh·∫ø sofa', 'trong ph√≤ng t·∫Øm', 'khi say r∆∞·ª£u'],
    adultElements: ['ham mu·ªën', 'd·ª•c v·ªçng', 'kh√°t khao', 'b√≠ m·∫≠t c·∫•m k·ªã', 'ranh gi·ªõi m·ªù nh·∫°t', 'c√°m d·ªó', 's·ª± quy·∫øn r≈©', 
                   'kh√¥ng th·ªÉ c∆∞·ª°ng l·∫°i', 'kho√°i c·∫£m', 'say ƒë·∫Øm', 'm√™ ho·∫∑c', 'th√¢n th·ªÉ', 'g·ª£i c·∫£m', 'quy·∫øn r≈©',
                   'd·ª•c t√≠nh', 'k√≠ch ƒë·ªông', 'm∆°n tr·ªõn', 'vu·ªët ve', 'th√¢n m·∫≠t', 'g·∫ßn g≈©i', 's·ªù so·∫°ng', '√¥m ·∫•p',
                   'h√¥n', 'h√¥n n·ªìng ch√°y', '√¢n √°i', 'l√†m t√¨nh', 'quan h·ªá', 'y√™u ƒë∆∞∆°ng'],
    psychologicalTerms: ['v√¥ th·ª©c', 'ti·ªÅm th·ª©c', 'b·∫£n nƒÉng', '·ª©c ch·∫ø', 'd·ªìn n√©n', 'ph√≤ng th·ªß', 'ph·ªß nh·∫≠n', 'chi·∫øu di·ªÖn',
                        'ƒë·ªìng nh·∫•t h√≥a', 'm·∫∑c c·∫£m', 'm√¢u thu·∫´n n·ªôi t√¢m', 'xung ƒë·ªôt t√¢m l√Ω', '√°mm ·∫£nh', 'd·∫±n v·∫∑t'],
    transitionWords: ['tuy nhi√™n', 'b√™n c·∫°nh ƒë√≥', 'ngo√†i ra', 'h∆°n n·ªØa', 'ƒë·∫∑c bi·ªát l√†', 'th√™m v√†o ƒë√≥', 'm·∫∑t kh√°c',
                     'ng∆∞·ª£c l·∫°i', 'th·ª±c t·∫ø th√¨', 'qu·∫£ th·∫≠t', 'ch·∫Øc ch·∫Øn', 'c√≥ l·∫Ω', 'd∆∞·ªùng nh∆∞', 'r√µ r√†ng l√†',
                     'cu·ªëi c√πng th√¨', 'k·∫øt qu·∫£ l√†', 'v√¨ v·∫≠y', 'do ƒë√≥', 'cho n√™n', 'ƒë·ªìng th·ªùi'],
    characterNames: ['Minh', 'H∆∞∆°ng', 'Lan', 'H·∫°nh', 'An', 'B√¨nh', 'D≈©ng', 'H·∫£i', 'Ph∆∞∆°ng', 'Th·∫£o', 'Ng·ªçc', 'Trang'],
    locations: ['ph√≤ng kh√°ch', 'nh√† b·∫øp', 'ph√≤ng ng·ªß', 'ph√≤ng t·∫Øm', 'ban c√¥ng', 's√¢n v∆∞·ªùn', 'c·∫ßu thang', 'nh√† kho', 'garage'],
    timeFrames: ['s√°ng s·ªõm', 'bu·ªïi tr∆∞a', 'chi·ªÅu t√†', 'ƒë√™m khuya', 'n·ª≠a ƒë√™m', 'r·∫°ng s√°ng', 'ho√†ng h√¥n', 'b√¨nh minh']
};

// H√†m kh·ªüi t·∫°o
function init() {
    gapiLoaded();
    gisLoaded();
    setupEventListeners();
}

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
    gapi_inited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
    });
    gis_inited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'block';
    }
}

function setupEventListeners() {
    document.getElementById('authorizeButton').onclick = handleAuthClick;
    document.getElementById('signoutButton').onclick = handleSignoutClick;
    document.getElementById('storyForm').onsubmit = saveStory;
    document.getElementById('trainAiButton').onclick = trainAI;
    document.getElementById('resetAiButton').onclick = resetAI;
    document.getElementById('generateStoryButton').onclick = generateAIStory;
    document.getElementById('viewAiStoriesButton').onclick = viewAIStories;
    
    // Menu navigation
    document.getElementById('menuTraining').onclick = () => showSection('trainingSection');
    document.getElementById('menuGeneration').onclick = () => showSection('generationSection');
    document.getElementById('menuManagement').onclick = () => showSection('managementSection');
    document.getElementById('menuHistory').onclick = () => showSection('historySection');
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show the selected section
    document.getElementById(sectionId).classList.add('active');
    
    // Update active menu button
    document.querySelectorAll('.nav-menu button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load data if needed
    if (sectionId === 'historySection') {
        loadStoryHistory();
        loadFolderContents();
    } else if (sectionId === 'managementSection') {
        loadExistingStories();
    }
}

function handleAuthClick() {
    showLoading(true);
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            showStatus('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + resp.error, 'error');
            showLoading(false);
            return;
        }
        document.getElementById('signoutButton').style.display = 'block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        showStatus('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        
        // Load data
        await loadOrCreateMainFolder();
        loadStoryHistory();
        loadAIKnowledge();
        showLoading(false);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('mainApp').style.display = 'none';
        showStatus('ƒê√£ ƒëƒÉng xu·∫•t', 'success');
    }
}

async function loadOrCreateMainFolder() {
    showLoading(true);
    try {
        // T√¨m th∆∞ m·ª•c ch√≠nh QuanLyTruyen
        const response = await gapi.client.drive.files.list({
            q: "name='QuanLyTruyen' and mimeType='application/vnd.google-apps.folder' and trashed=false",
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        if (folders.length > 0) {
            mainFolderId = folders[0].id;
            showStatus('ƒê√£ t√¨m th·∫•y th∆∞ m·ª•c QuanLyTruyen', 'success');
        } else {
            // T·∫°o th∆∞ m·ª•c m·ªõi n·∫øu kh√¥ng t√¨m th·∫•y
            const fileMetadata = {
                name: 'QuanLyTruyen',
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            const createResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            mainFolderId = createResponse.result.id;
            showStatus('ƒê√£ t·∫°o th∆∞ m·ª•c QuanLyTruyen m·ªõi', 'success');
        }
        
    } catch (error) {
        showStatus('L·ªói khi t·∫°o/t√¨m th∆∞ m·ª•c: ' + error.message, 'error');
    }
    showLoading(false);
}

async function saveStory(e) {
    e.preventDefault();
    showLoading(true);
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = mode === 'new' ? document.getElementById('storyTitle').value : document.getElementById('existingStory').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const content = document.getElementById('storyContent').value;
    
    if (!storyTitle || !chapterTitle || !content) {
        showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        showLoading(false);
        return;
    }
    
    try {
        let storyFolderId;
        
        if (mode === 'new') {
            // T·∫°o th∆∞ m·ª•c m·ªõi cho truy·ªán
            const fileMetadata = {
                name: storyTitle,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [mainFolderId]
            };
            
            const folderResponse = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            
            storyFolderId = folderResponse.result.id;
            
        } else {
            // T√¨m th∆∞ m·ª•c truy·ªán ƒë√£ c√≥
            const response = await gapi.client.drive.files.list({
                q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
                fields: 'files(id, name)'
            });
            
            if (response.result.files.length === 0) {
                showStatus('Kh√¥ng t√¨m th·∫•y truy·ªán', 'error');
                showLoading(false);
                return;
            }
            
            storyFolderId = response.result.files[0].id;
        }
        
        // T·∫°o file ch∆∞∆°ng m·ªõi
        const fileMetadata = {
            name: `${chapterTitle}.txt`,
            parents: [storyFolderId],
            mimeType: 'text/plain'
        };
        
        const contentBlob = new Blob([content], {type: 'text/plain'});
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        formData.append('file', contentBlob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token
            }),
            body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error.message);
        }
        
        // C·∫≠p nh·∫≠t l·ªãch s·ª≠
        storyHistory.unshift({
            title: storyTitle,
            chapter: chapterTitle,
            date: new Date().toISOString(),
            fileId: result.id
        });
        
        saveStoryHistory();
        updateAIKnowledge(content, result.id);
        
        showStatus(`ƒê√£ l∆∞u ch∆∞∆°ng "${chapterTitle}" v√†o truy·ªán "${storyTitle}"`, 'success');
        document.getElementById('storyForm').reset();
        
    } catch (error) {
        showStatus('L·ªói khi l∆∞u truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function saveStoryHistory() {
    localStorage.setItem('storyHistory', JSON.stringify(storyHistory));
    displayStoryHistory();
}

function loadStoryHistory() {
    const savedHistory = localStorage.getItem('storyHistory');
    if (savedHistory) {
        storyHistory = JSON.parse(savedHistory);
    }
    displayStoryHistory();
}

function displayStoryHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    if (storyHistory.length === 0) {
        historyList.innerHTML = '<div class="history-item"><p>Ch∆∞a c√≥ l·ªãch s·ª≠ truy·ªán</p></div>';
        return;
    }
    
    storyHistory.slice(0, 10).forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.onclick = () => viewStory(item.title);
        
        historyItem.innerHTML = `
            <div class="story-title">${item.title}</div>
            <div class="story-chapter">Ch∆∞∆°ng: ${item.chapter}</div>
            <div class="story-date">${new Date(item.date).toLocaleDateString('vi-VN')}</div>
        `;
        
        historyList.appendChild(historyItem);
    });
}

async function loadFolderContents() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, createdTime)',
            orderBy: 'createdTime desc'
        });
        
        const folders = response.result.files;
        const folderList = document.getElementById('folderList');
        folderList.innerHTML = '';
        
        if (folders.length === 0) {
            folderList.innerHTML = '<div class="history-item"><p>Ch∆∞a c√≥ th∆∞ m·ª•c truy·ªán</p></div>';
            return;
        }
        
        folders.forEach(folder => {
            const folderItem = document.createElement('div');
            folderItem.className = 'history-item';
            folderItem.onclick = () => viewStory(folder.name);
            
            folderItem.innerHTML = `
                <div class="story-title">${folder.name}</div>
                <div class="story-date">T·∫°o ng√†y: ${new Date(folder.createdTime).toLocaleDateString('vi-VN')}</div>
            `;
            
            folderList.appendChild(folderItem);
        });
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch th∆∞ m·ª•c:', error);
    }
}

async function viewStory(storyTitle) {
    showLoading(true);
    
    try {
        // T√¨m th∆∞ m·ª•c truy·ªán
        const response = await gapi.client.drive.files.list({
            q: `name='${storyTitle}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        
        if (response.result.files.length === 0) {
            showStatus('Kh√¥ng t√¨m th·∫•y truy·ªán', 'error');
            showLoading(false);
            return;
        }
        
        const storyFolderId = response.result.files[0].id;
        
        // L·∫•y danh s√°ch ch∆∞∆°ng
        const chaptersResponse = await gapi.client.drive.files.list({
            q: `'${storyFolderId}' in parents and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, modifiedTime)',
            orderBy: 'name'
        });
        
        const chapters = chaptersResponse.result.files;
        
        // Hi·ªÉn th·ªã modal v·ªõi danh s√°ch ch∆∞∆°ng
        document.getElementById('chaptersModalTitle').textContent = `Ch∆∞∆°ng truy·ªán: ${storyTitle}`;
        const chapterList = document.getElementById('chapterList');
        chapterList.innerHTML = '';
        
        if (chapters.length === 0) {
            chapterList.innerHTML = '<div class="chapter-item">Ch∆∞a c√≥ ch∆∞∆°ng n√†o</div>';
        } else {
            chapters.forEach(chapter => {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'chapter-item';
                chapterItem.textContent = chapter.name.replace('.txt', '');
                chapterItem.onclick = () => loadChapterContent(chapter.id, chapter.name.replace('.txt', ''), storyTitle);
                chapterList.appendChild(chapterItem);
            });
        }
        
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
        openModal('chaptersModal');
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i ch∆∞∆°ng truy·ªán: ' + error.message, 'error');
    }
    
    showLoading(false);
}

async function loadChapterContent(chapterId, chapterTitle, storyTitle) {
    showLoading(true);
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapterId,
            alt: 'media'
        });
        
        const content = response.body;
        
        document.getElementById('chapterList').style.display = 'none';
        document.getElementById('chapterContent').style.display = 'block';
        document.getElementById('chapterContent').textContent = content;
        document.getElementById('chapterActions').style.display = 'flex';
        
        // L∆∞u th√¥ng tin ch∆∞∆°ng ƒëang xem
        currentEditingChapter = {
            id: chapterId,
            title: chapterTitle,
            storyTitle: storyTitle,
            content: content
        };
        
    } catch (error) {
        showStatus('L·ªói khi t·∫£i n·ªôi dung ch∆∞∆°ng: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function editChapter() {
    const contentDiv = document.getElementById('chapterContent');
    const currentContent = contentDiv.textContent;
    
    contentDiv.innerHTML = `<textarea id="editChapterContent" style="width: 100%; height: 400px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 15px;">${currentContent}</textarea>`;
}

async function saveChapterChanges() {
    showLoading(true);
    
    try {
        const editedContent = document.getElementById('editChapterContent').value;
        
        // C·∫≠p nh·∫≠t file tr√™n Google Drive
        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}?uploadType=media`, {
            method: 'PATCH',
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'text/plain'
            }),
            body: editedContent
        });
        
        if (!response.ok) {
            throw new Error('L·ªói khi l∆∞u thay ƒë·ªïi');
        }
        
        // C·∫≠p nh·∫≠t n·ªôi dung hi·ªÉn th·ªã
        document.getElementById('chapterContent').innerHTML = '';
        document.getElementById('chapterContent').textContent = editedContent;
        
        showStatus('ƒê√£ l∆∞u thay ƒë·ªïi', 'success');
        
        // C·∫≠p nh·∫≠t l·∫°i knowledge base
        updateAIKnowledge(editedContent, currentEditingChapter.id);
        
    } catch (error) {
        showStatus('L·ªói khi l∆∞u thay ƒë·ªïi: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function cancelEdit() {
    document.getElementById('chapterContent').innerHTML = '';
    document.getElementById('chapterContent').textContent = currentEditingChapter.content;
}

async function deleteChapter() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y?')) return;
    
    showLoading(true);
    
    try {
        await gapi.client.drive.files.delete({
            fileId: currentEditingChapter.id
        });
        
        showStatus('ƒê√£ x√≥a ch∆∞∆°ng', 'success');
        closeModal('chaptersModal');
        
    } catch (error) {
        showStatus('L·ªói khi x√≥a ch∆∞∆°ng: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Reset modal state
    if (modalId === 'chaptersModal') {
        document.getElementById('chapterList').style.display = 'block';
        document.getElementById('chapterContent').style.display = 'none';
        document.getElementById('chapterActions').style.display = 'none';
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'L∆∞u Truy·ªán M·ªõi';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Th√™m Ch∆∞∆°ng M·ªõi';
        loadExistingStories();
    }
}

async function loadExistingStories() {
    if (!mainFolderId) return;
    
    try {
        const response = await gapi.client.drive.files.list({
            q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)'
        });
        
        const folders = response.result.files;
        const select = document.getElementById('existingStory');
        select.innerHTML = '<option value="">-- Ch·ªçn truy·ªán --</option>';
        
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.name;
            option.textContent = folder.name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch truy·ªán:', error);
    }
}

function updateAIKnowledge(content, fileId) {
    // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
    if (fileId && aiKnowledge.processedFiles.has(fileId)) {
        return; // B·ªè qua n·∫øu ƒë√£ x·ª≠ l√Ω
    }
    
    // ƒê√°nh d·∫•u file ƒë√£ x·ª≠ l√Ω
    if (fileId) {
        aiKnowledge.processedFiles.add(fileId);
    }
    
    // Ph√¢n t√≠ch n·ªôi dung ƒë·ªÉ c·∫≠p nh·∫≠t ki·∫øn th·ª©c cho AI
    const words = content.split(/\s+/);
    words.forEach(word => {
        if (word.length > 3) {
            aiKnowledge.vocabulary.add(word.toLowerCase());
        }
    });
    
    // Ph√¢n t√≠ch c√¢u
    const sentences = content.split(/[.!?]+/);
    aiKnowledge.trainedFiles += sentences.length;
    
    sentences.forEach(sentence => {
        if (sentence.length > 10) {
            // Ph√¢n t√≠ch c·∫•u tr√∫c c√¢u
            aiKnowledge.sentenceStructures.add(sentence.trim());
            
            // Ph√¢n t√≠ch t·ª´ kh√≥a c·∫£m x√∫c
            specializedVocabulary.emotions.forEach(emotion => {
                if (sentence.toLowerCase().includes(emotion)) {
                    aiKnowledge.emotionalPatterns.add(emotion);
                }
            });
            
            // Ph√¢n t√≠ch h·ªôi tho·∫°i
            if (sentence.includes(':"') || sentence.includes(':"')) {
                aiKnowledge.dialogues.push(sentence.trim());
            }
            
            // Ph√¢n t√≠ch b·ªëi c·∫£nh
            specializedVocabulary.locations.forEach(location => {
                if (sentence.toLowerCase().includes(location)) {
                    aiKnowledge.contexts.push({location, context: sentence.trim()});
                }
            });
            
            // Ph√¢n t√≠ch t√™n nh√¢n v·∫≠t
            specializedVocabulary.characterNames.forEach(name => {
                if (sentence.includes(name)) {
                    aiKnowledge.characterNames.add(name);
                }
            });
            
            // Ph√¢n t√≠ch y·∫øu t·ªë 18+
            specializedVocabulary.adultElements.forEach(term => {
                if (sentence.toLowerCase().includes(term)) {
                    aiKnowledge.adultTerms.add(term);
                }
            });
        }
    });
    
    // L∆∞u ki·∫øn th·ª©c AI
    saveAIKnowledge();
    updateAIStats();
}

function saveAIKnowledge() {
    // Chuy·ªÉn Set th√†nh Array ƒë·ªÉ l∆∞u tr·ªØ
    const knowledgeToSave = {
        vocabulary: Array.from(aiKnowledge.vocabulary),
        trainedFiles: aiKnowledge.trainedFiles,
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        emotionalPatterns: Array.from(aiKnowledge.emotionalPatterns),
        dialogues: aiKnowledge.dialogues,
        contexts: aiKnowledge.contexts,
        characterNames: Array.from(aiKnowledge.characterNames),
        adultTerms: Array.from(aiKnowledge.adultTerms),
        generationHistory: aiKnowledge.generationHistory,
        processedFiles: Array.from(aiKnowledge.processedFiles)
    };
    
    localStorage.setItem('aiKnowledge', JSON.stringify(knowledgeToSave));
}

function loadAIKnowledge() {
    const savedKnowledge = localStorage.getItem('aiKnowledge');
    if (savedKnowledge) {
        const parsedKnowledge = JSON.parse(savedKnowledge);
        
        // Kh√¥i ph·ª•c c√°c Set t·ª´ Array
        aiKnowledge.vocabulary = new Set(parsedKnowledge.vocabulary || []);
        aiKnowledge.trainedFiles = parsedKnowledge.trainedFiles || 0;
        aiKnowledge.sentenceStructures = new Set(parsedKnowledge.sentenceStructures || []);
        aiKnowledge.emotionalPatterns = new Set(parsedKnowledge.emotionalPatterns || []);
        aiKnowledge.dialogues = parsedKnowledge.dialogues || [];
        aiKnowledge.contexts = parsedKnowledge.contexts || [];
        aiKnowledge.characterNames = new Set(parsedKnowledge.characterNames || []);
        aiKnowledge.adultTerms = new Set(parsedKnowledge.adultTerms || []);
        aiKnowledge.generationHistory = parsedKnowledge.generationHistory || [];
        aiKnowledge.processedFiles = new Set(parsedKnowledge.processedFiles || []);
    }
    updateAIStats();
}

function updateAIStats() {
    document.getElementById('totalFiles').textContent = aiKnowledge.processedFiles.size;
    document.getElementById('trainedFiles').textContent = aiKnowledge.trainedFiles;
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('sentenceStructures').textContent = aiKnowledge.sentenceStructures.size;
    document.getElementById('emotionalPatterns').textContent = aiKnowledge.emotionalPatterns.size;
    document.getElementById('dialoguesCount').textContent = aiKnowledge.dialogues.length;
    document.getElementById('contextsCount').textContent = aiKnowledge.contexts.length;
    document.getElementById('charactersCount').textContent = aiKnowledge.characterNames.size;
    
    // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
    const progress = Math.min(100, (aiKnowledge.processedFiles.size / 500) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
}

async function trainAI() {
    showLoading(true);
    
    try {
        // Thu th·∫≠p t·∫•t c·∫£ n·ªôi dung t·ª´ c√°c truy·ªán ƒë√£ l∆∞u ƒë·ªÉ hu·∫•n luy·ªán AI
        if (!mainFolderId) {
            showStatus('Ch∆∞a c√≥ th∆∞ m·ª•c ch√≠nh', 'error');
            showLoading(false);
            return;
        }
        
        // L·∫•y danh s√°ch t·∫•t c·∫£ file .txt trong th∆∞ m·ª•c QuanLyTruyen v√† c√°c th∆∞ m·ª•c con
        const response = await gapi.client.drive.files.list({
            q: `('${mainFolderId}' in parents or parents in '${mainFolderId}') and mimeType='text/plain' and trashed=false`,
            fields: 'files(id, name, parents)',
            pageSize: 1000
        });
        
        const textFiles = response.result.files;
        let processedCount = 0;
        let skippedCount = 0;
        
        document.getElementById('progressFill').style.width = '0%';
        
        for (const file of textFiles) {
            // Ki·ªÉm tra n·∫øu file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
            if (aiKnowledge.processedFiles.has(file.id)) {
                skippedCount++;
                continue;
            }
            
            try {
                // ƒê·ªçc n·ªôi dung file
                const contentResponse = await gapi.client.drive.files.get({
                    fileId: file.id,
                    alt: 'media'
                });
                
                const content = contentResponse.body;
                
                // C·∫≠p nh·∫≠t ki·∫øn th·ª©c AI t·ª´ n·ªôi dung
                updateAIKnowledge(content, file.id);
                processedCount++;
                
                // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
                const progress = Math.floor((processedCount / textFiles.length) * 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω file:', file.name, error);
            }
        }
        
        showStatus(`ƒê√£ hu·∫•n luy·ªán AI v·ªõi ${processedCount} file m·ªõi (${skippedCount} file ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω tr∆∞·ªõc ƒë√≥)`, 'success');
        
    } catch (error) {
        showStatus('L·ªói khi hu·∫•n luy·ªán AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function resetAI() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset to√†n b·ªô ki·∫øn th·ª©c c·ªßa AI? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        aiKnowledge = {
            vocabulary: new Set(),
            stories: [],
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set(),
            transitionWords: new Set(),
            psychologicalTerms: new Set(),
            descriptivePatterns: new Set(),
            metaphors: new Set(),
            adultTerms: new Set(),
            characterNames: new Set(),
            locations: new Set(),
            timeFrames: new Set(),
            situations: new Set(),
            generationHistory: [],
            processedFiles: new Set(),
            qualityMetrics: {
                complexityThreshold: 0.6,
                coherenceThreshold: 0.7,
                emotionThreshold: 0.65,
                targetWordCount: 3500
            }
        };
        
        localStorage.removeItem('aiKnowledge');
        updateAIStats();
        showStatus('ƒê√£ reset ki·∫øn th·ª©c AI', 'success');
    }
}

async function generateAIStory() {
    showLoading(true);
    
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
    
    if (chapterCount < 100 || chapterCount > 150) {
        showStatus('S·ªë ch∆∞∆°ng ph·∫£i t·ª´ 100 ƒë·∫øn 150', 'error');
        showLoading(false);
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI ch∆∞a ƒë∆∞·ª£c hu·∫•n luy·ªán ƒë·ªß. Vui l√≤ng hu·∫•n luy·ªán AI tr∆∞·ªõc.', 'error');
        showLoading(false);
        return;
    }
    
    try {
        // T·∫°o th∆∞ m·ª•c m·ªõi cho truy·ªán AI
        const storyTitle = `AI Truy·ªán - ${new Date().toLocaleDateString('vi-VN')}`;
        const fileMetadata = {
            name: storyTitle,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [mainFolderId]
        };
        
        const folderResponse = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        
        const storyFolderId = folderResponse.result.id;
        
        // T·∫°o c√°c ch∆∞∆°ng
        let progress = 0;
        document.getElementById('generationProgressFill').style.width = '0%';
        document.getElementById('generationStatus').innerHTML = '<div class="status info">ƒêang t·∫°o truy·ªán... 0%</div>';
        
        for (let i = 1; i <= chapterCount; i++) {
            const chapterTitle = `Ch∆∞∆°ng ${i}`;
            const chapterContent = generateChapterContent(i, chapterCount);
            
            const fileMetadata = {
                name: `${chapterTitle}.txt`,
                parents: [storyFolderId],
                mimeType: 'text/plain'
            };
            
            const contentBlob = new Blob([chapterContent], {type: 'text/plain'});
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            formData.append('file', contentBlob);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                }),
                body: formData
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error.message);
            }
            
            // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
            progress = Math.floor((i / chapterCount) * 100);
            document.getElementById('generationProgressFill').style.width = `${progress}%`;
            document.getElementById('generationStatus').innerHTML = `<div class="status info">ƒêang t·∫°o truy·ªán... ${progress}%</div>`;
            
            // Ngh·ªâ m·ªôt ch√∫t ƒë·ªÉ tr√°nh qu√° t·∫£i API
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // L∆∞u th√¥ng tin truy·ªán AI
        aiGeneratedStories.push({
            title: storyTitle,
            chapters: chapterCount,
            date: new Date().toISOString(),
            folderId: storyFolderId
        });
        
        saveAIGeneratedStories();
        
        showStatus(`ƒê√£ t·∫°o th√†nh c√¥ng truy·ªán "${storyTitle}" v·ªõi ${chapterCount} ch∆∞∆°ng`, 'success');
        document.getElementById('generationStatus').innerHTML = '';
        
    } catch (error) {
        showStatus('L·ªói khi t·∫°o truy·ªán AI: ' + error.message, 'error');
    }
    
    showLoading(false);
}

function generateChapterContent(chapterNumber, totalChapters) {
    // T·∫°o n·ªôi dung ch∆∞∆°ng ƒë∆°n gi·∫£n d·ª±a tr√™n ki·∫øn th·ª©c AI
    let content = `Ch∆∞∆°ng ${chapterNumber}\n\n`;
    
    // S·ª≠ d·ª•ng t·ª´ v·ª±ng ƒë√£ h·ªçc ƒë·ªÉ t·∫°o n·ªôi dung
    const vocabulary = Array.from(aiKnowledge.vocabulary);
    const emotions = Array.from(aiKnowledge.emotionalPatterns);
    const names = Array.from(aiKnowledge.characterNames);
    
    // T·∫°o m·ªôt s·ªë ƒëo·∫°n vƒÉn ng·∫´u nhi√™n
    for (let i = 0; i < 10; i++) {
        const sentenceLength = 5 + Math.floor(Math.random() * 10);
        let sentence = '';
        
        for (let j = 0; j < sentenceLength; j++) {
            if (j > 0) sentence += ' ';
            sentence += vocabulary[Math.floor(Math.random() * vocabulary.length)];
        }
        
        content += sentence + '. ';
        
        // Th√™m c·∫£m x√∫c ng·∫´u nhi√™n
        if (Math.random() > 0.7) {
            content += `T√¥i c·∫£m th·∫•y ${emotions[Math.floor(Math.random() * emotions.length)]}. `;
        }
        
        // Th√™m t√™n nh√¢n v·∫≠t ng·∫´u nhi√™n
        if (Math.random() > 0.8 && names.length > 0) {
            content += `${names[Math.floor(Math.random() * names.length)]} `;
        }
        
        content += '\n\n';
    }
    
    return content;
}

function saveAIGeneratedStories() {
    localStorage.setItem('aiGeneratedStories', JSON.stringify(aiGeneratedStories));
}

function loadAIGeneratedStories() {
    const savedStories = localStorage.getItem('aiGeneratedStories');
    if (savedStories) {
        aiGeneratedStories = JSON.parse(savedStories);
    }
}

async function viewAIStories() {
    loadAIGeneratedStories();
    
    const aiStoryList = document.getElementById('aiStoryList');
    aiStoryList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        aiStoryList.innerHTML = '<div class="chapter-item">Ch∆∞a c√≥ truy·ªán n√†o ƒë∆∞·ª£c t·∫°o b·ªüi AI</div>';
    } else {
        aiGeneratedStories.forEach(story => {
            const storyItem = document.createElement('div');
            storyItem.className = 'chapter-item';
            storyItem.onclick = () => viewStory(story.title);
            
            storyItem.innerHTML = `
                <div class="story-title">${story.title}</div>
                <div class="story-chapter">${story.chapters} ch∆∞∆°ng</div>
                <div class="story-date">${new Date(story.date).toLocaleDateString('vi-VN')}</div>
            `;
            
            aiStoryList.appendChild(storyItem);
        });
    }
    
    openModal('aiStoriesModal');
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
window.onload = init;
</script>
</body>
</html>
