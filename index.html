<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý Truyện - Google Drive Database</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; 
            color: #ffffff;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 20px 15px;
            text-align: center; 
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header h1 { 
            font-size: 1.8em; 
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .main-content { 
            padding: 15px;
            padding-bottom: 80px;
        }
        .auth-section { 
            text-align: center; 
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 20px;
            border-radius: 25px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s ease; 
            margin: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover, .btn:active { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .btn.success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        .btn.info {
            background: linear-gradient(45deg, #45aaf2, #2d98da);
            box-shadow: 0 4px 15px rgba(69, 170, 242, 0.3);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .form-section h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.3em;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #ffffff;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; 
            padding: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        .form-group textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; 
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px; 
            text-align: center;
        }
        .history-header h2 {
            font-size: 1.2em;
        }
        .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: background-color 0.3s ease;
        }
        .history-item:hover, .history-item:active { 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .story-title { 
            font-weight: 600; 
            color: #ffffff; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .story-chapter { 
            color: rgba(255, 255, 255, 0.7); 
            font-size: 14px; 
            margin-bottom: 5px; 
        }
        .story-date { 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 12px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: none;
            font-weight: 600;
        }
        .status.success { 
            background: rgba(78, 205, 196, 0.2); 
            color: #4ecdc4; 
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        .status.error { 
            background: rgba(255, 107, 107, 0.2); 
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin: 20px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1); 
            border-top: 3px solid #667eea;
            border-radius: 50%; 
            width: 40px; 
            height: 40px;
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
           100% { transform: rotate(360deg); } 
        }
        .grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
            margin-top: 20px; 
        }
        
        /* AI Training Section */
        .ai-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* AI Generated Stories Section */
        .ai-generated-section {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(44, 160, 141, 0.1));
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .ai-generated-section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .ai-story-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .ai-story-controls input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-menu button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
        }
        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .chapter-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .chapter-content {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Thêm style cho cảnh báo nội dung 18+ */
        .adult-warning {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Ẩn nội dung nhạy cảm mặc định */
        .sensitive-content {
            filter: blur(8px);
            transition: filter 0.3s ease;
            user-select: none;
        }
        
        .sensitive-content.revealed {
            filter: none;
            user-select: text;
        }
        
        .reveal-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.6em; }
            .main-content { padding: 10px; }
            .form-section, .history-section { margin-bottom: 15px; }
            .btn { font-size: 14px; padding: 10px 16px; }
            .modal-content { margin: 20px 10px; padding: 15px; }
            .nav-menu { flex-direction: column; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.5); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Truyện Manager</h1>
            <p>Quản lý & Huấn luyện AI với Google Drive - Chủ đề chuyên biệt</p>
        </div>
        <div class="main-content">
            <div class="auth-section">
                <button id="authorizeButton" class="btn">🔐 Đăng nhập Google Drive</button>
                <button id="signoutButton" class="btn danger" style="display: none;">🚪 Đăng xuất</button>
                <div id="authStatus"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang xử lý...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div id="mainApp" style="display: none;">
                <!-- Navigation Menu -->
                <div class="nav-menu">
                    <button id="menuTraining" class="btn info active">🧠 Huấn luyện AI</button>
                    <button id="menuGeneration" class="btn success">📖 AI Tạo Truyện</button>
                    <button id="menuManagement" class="btn">✏️ Quản lý Truyện</button>
                    <button id="menuHistory" class="btn">📚 Lịch sử Truyện</button>
                </div>
                
                <!-- AI Training Section -->
                <div id="trainingSection" class="content-section active">
                    <div class="ai-section">
                        <h2>🧠 Huấn luyện AI</h2>
                        <div class="ai-stats" id="aiStats">
                            <div class="stat-item">
                                <span>Tổng số file:</span>
                                <span id="totalFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Đã huấn luyện:</span>
                                <span id="trainedFiles">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Từ vựng học được:</span>
                                <span id="vocabularyCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Cấu trúc câu:</span>
                                <span id="sentenceStructures">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Tình tiết:</span>
                                <span id="plotPoints">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Diễn biến cảm xúc:</span>
                                <span id="emotionalPatterns">0</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <button id="trainAiButton" class="btn success">🎯 Bắt đầu huấn luyện AI</button>
                        <button id="resetAiButton" class="btn danger">🔄 Reset AI</button>
                    </div>
                </div>
                
                <!-- AI Story Generation Section -->
                <div id="generationSection" class="content-section">
                    <div class="ai-generated-section">
                        <h2>📖 AI Tạo Truyện Tự Động</h2>
                        
                        <div class="adult-warning">
                            ⚠️ Cảnh báo: AI sẽ tạo nội dung theo ngôi thứ nhất.
                        </div>
                        
                        <div class="ai-story-controls">
                            <input type="number" id="chapterCount" placeholder="Số chương (100-150)" min="100" max="150" value="100">
                            <button id="generateStoryButton" class="btn success">🚀 AI Tạo Truyện Mới</button>
                            <button id="viewAiStoriesButton" class="btn">📚 Xem Truyện AI Đã Tạo</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="generationProgressFill"></div>
                        </div>
                        <div id="generationStatus"></div>
                    </div>
                </div>
                
                <!-- Story Management Section -->
                <div id="managementSection" class="content-section">
                    <div class="form-section">
                        <h2>✏️ Thêm Truyện / Chương Mới</h2>
                        <form id="storyForm">
                            <div class="form-group">
                                <label for="storyMode">Chế độ:</label>
                                <select id="storyMode" onchange="toggleStoryMode()">
                                    <option value="new">Tạo truyện mới</option>
                                    <option value="existing">Thêm chương vào truyện có sẵn</option>
                                </select>
                            </div>
                            <div class="form-group" id="newStoryGroup">
                                <label for="storyTitle">Tên Truyện Mới:</label>
                                <input type="text" id="storyTitle" placeholder="Nhập tên truyện mới...">
                            </div>
                            <div class="form-group" id="existingStoryGroup" style="display: none;">
                                <label for="existingStory">Chọn Truyện Có Sẵn:</label>
                                <select id="existingStory"><option value="">-- Chọn truyện --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="chapterTitle">Tên Chương:</label>
                                <input type="text" id="chapterTitle" required placeholder="Nhập tên chương...">
                            </div>
                            <div class="form-group">
                                <label for="storyContent">Nội dung:</label>
                                <textarea id="storyContent" required placeholder="Nhập nội dung truyện..."></textarea>
                            </div>
                            <button type="submit" class="btn">💾 <span id="submitButtonText">Lưu Truyện Mới</span></button>
                        </form>
                    </div>
                </div>
                
                <!-- History Section -->
                <div id="historySection" class="content-section">
                    <div class="grid">
                        <div class="history-section">
                            <div class="history-header"><h2>📖 Lịch sử Truyện</h2></div>
                            <div class="history-list" id="historyList"></div>
                        </div>
                        <div class="history-section">
                            <div class="history-header"><h2>🗂 Thư mục Google Drive</h2></div>
                            <div class="history-list" id="folderList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for AI Generated Stories -->
    <div id="aiStoriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aiStoriesModal')">&times;</span>
            <h2>📚 Truyện Được Tạo Bởi AI</h2>
            <div class="chapter-list" id="aiStoryList">
                <!-- AI stories will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Chapters -->
    <div id="chaptersModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('chaptersModal')">&times;</span>
            <h2 id="chaptersModalTitle">Chương Truyện</h2>
            <div class="chapter-list" id="chapterList">
                <!-- Chapters will be listed here -->
            </div>
            <div class="chapter-content" id="chapterContent" style="display: none;">
                <!-- Chapter content will be displayed here -->
            </div>
            <div class="chapter-actions" id="chapterActions" style="display: none;">
                <button class="btn" onclick="editChapter()">✏️ Sửa Chương</button>
                <button class="btn danger" onclick="deleteChapter()">🗑️ Xóa Chương</button>
                <button class="btn" onclick="saveChapterChanges()">💾 Lưu Thay Đổi</button>
                <button class="btn" onclick="cancelEdit()">❌ Hủy</button>
            </div>
        </div>
    </div>

<script>
const CLIENT_ID = '199144324956-rsc4tttep6uq67poepa2nclieqi82avj.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBGHB5FnrtMXliWtk3X6FZAl0CE2neNgZM';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient, gapi_inited = false, gis_inited = false, mainFolderId = null, storyHistory = [];
let aiKnowledge = { 
    vocabulary: new Set(), 
    stories: [], 
    trainedFiles: 0,
    sentenceStructures: new Set(),
    plotPoints: new Set(),
    emotionalPatterns: new Set(),
    dialogues: [],
    contexts: [],
    characterRelationships: new Set(),
    narrativeStyles: new Set()
};
let aiGeneratedStories = [];
let currentEditingChapter = null;

// Từ vựng và cấu trúc chuyên biệt cho chủ đề bố chồng con dâu
const specializedVocabulary = {
    familyRelations: ['bố chồng', 'con dâu', 'chồng', 'vợ', 'gia đình', 'họ hàng', 'mối quan hệ', 'phép tắc', 'ranh giới'],
    emotions: ['căng thẳng', 'bối rối', 'ghen tị', 'tò mò', 'lo lắng', 'thèm muốn', 'khao khát', 'tội lỗi', 'xấu hổ', 'kích thích', 'dục vọng', 'bất an'],
    observations: ['quan sát', 'nhìn trộm', 'theo dõi', 'chú ý', 'phát hiện', 'để ý', 'nhận ra', 'thấy được', 'cảm nhận', 'nghe được'],
    innerThoughts: ['tôi nghĩ', 'trong tâm trí tôi', 'tôi tự hỏi', 'có lẽ', 'liệu rằng', 'tôi không thể tin được', 'tôi cảm thấy', 'điều này khiến tôi'],
    secretive: ['bí mật', 'giấu kín', 'che giấu', 'lén lút', 'thầm kín', 'kín đáo', 'âm thầm', 'không ai biết', 'chỉ mình tôi'],
    physicalDescriptions: ['đôi mắt', 'nụ cười', 'cử chỉ', 'ánh mắt', 'cách di chuyển', 'giọng nói', 'cách cười', 'biểu cảm'],
    situations: ['bữa cơm gia đình', 'khi vợ đi vắng', 'cuối tuần', 'những buổi tối', 'lúc một mình', 'khi không ai chú ý'],
    adultElements: ['ham muốn', 'dục vọng', 'khát khao', 'bí mật cấm kị', 'ranh giới mờ nhạt', 'cám dỗ', 'sự quyến rũ', 'không thể cưỡng lại']
};

// Cấu trúc câu chuyển biệt cho ngôi thứ nhất của người chồng
const narrativePatterns = {
    observation: [
        "Tôi để ý thấy {situation} giữa bố và {wife}.",
        "Trong {timeFrame}, tôi nhận ra {observation} về mối quan hệ của họ.",
        "Tôi không thể không chú ý đến {physicalDescription} khi {situation}.",
        "Có điều gì đó trong {observation} khiến tôi {emotion}.",
        "Tôi thấy {wife} và bố {action} một cách {manner}."
    ],
    innerMonologue: [
        "Trong tâm trí tôi, {innerThought} về những gì đang diễn ra.",
        "Tôi tự hỏi liệu {question} có phải là điều tôi nghĩ không.",
        "Cảm giác {emotion} cứ ám ảnh tôi khi {situation}.",
        "Tôi không thể ngừng nghĩ về {observation} mà tôi đã thấy.",
        "Điều này khiến tôi {emotion} một cách {intensity}.",
        "Có lẽ tôi đang {doubt} nhưng {feeling} này không thể phủ nhận."
    ],
    conflict: [
        "Tôi biết mình không nên {action} nhưng {desire} quá mạnh.",
        "Ranh giới giữa {rightWrong} ngày càng {blur}.",
        "Tôi cảm thấy {guilty} vì {thought} về {situation}.",
        "Làm thế nào để tôi có thể {cope} với {feeling} này?",
        "Mỗi lần {trigger}, tôi lại {reaction}."
    ],
    escalation: [
        "Những {timeFrame} gần đây, {situation} ngày càng {intensity}.",
        "Tôi nhận ra {realization} về bản thân mình.",
        "Không thể phủ nhận rằng {truth} đang xảy ra.",
        "Cách {wife} {action} với bố khiến tôi {emotion}.",
        "Tôi bắt đầu {change} cách nhìn về {relationship}."
    ]
};

// Các yếu tố tình tiết chuyên biệt
const plotElements = {
    triggers: ['khi vợ tôi cúi xuống', 'lúc bố giúp con dâu', 'những cử chỉ thân mật', 'ánh mắt trao đổi', 'tiếng cười nhẹ', 'cách họ đứng gần nhau'],
    timeFrames: ['những ngày', 'buổi tối', 'cuối tuần', 'khi tôi về nhà', 'lúc ăn cơm', 'những lúc yên tĩnh'],
    locations: ['trong nhà bếp', 'ở phòng khách', 'ngoài sân', 'trên cầu thang', 'trong phòng tắm', 'ở ban công'],
    discoveries: ['tôi phát hiện ra', 'tôi tình cờ thấy', 'tôi nghe được', 'tôi nhận ra', 'tôi không thể tin'],
    consequences: ['tôi mất ngủ', 'tôi không thể tập trung', 'tôi bắt đầu tránh', 'tôi càng quan sát nhiều hơn', 'tôi cảm thấy bối rối']
};

// Initialize Google API
async function initializeGapi() {
    await gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapi_inited = true; maybeEnableButtons();
    });
}

function initializeGis() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: ''
    });
    gis_inited = true; maybeEnableButtons();
}

function maybeEnableButtons() { 
    if (gapi_inited && gis_inited) {
        document.getElementById('authorizeButton').style.display = 'inline-block'; 
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) { 
            showStatus('Lỗi đăng nhập: ' + resp.error, 'error'); 
            return; 
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('authStatus').innerHTML = '✅ Đã đăng nhập thành công!';
        await initializeApp();
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) { 
        google.accounts.oauth2.revoke(token.access_token); 
        gapi.client.setToken(''); 
    }
    document.getElementById('authorizeButton').style.display = 'inline-block';
    document.getElementById('signoutButton').style.display = 'none';
    document.getElementById('authStatus').innerHTML = '';
    document.getElementById('mainApp').style.display = 'none';
}

async function initializeApp() {
    showLoading(true);
    await createMainFolder(); 
    await loadStoryHistory();
    await loadAiKnowledge();
    await loadAiGeneratedStories();
    updateAiStats();
    document.getElementById('mainApp').style.display = 'block';
    showStatus('Khởi tạo ứng dụng thành công!', 'success');
    showLoading(false);
}

async function createMainFolder() {
    const folderName = 'QuanLyTruyen';
    const response = await gapi.client.drive.files.list({
        q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    if (response.result.files.length > 0) {
        mainFolderId = response.result.files[0].id;
    } else {
        const folder = await gapi.client.drive.files.create({ 
            resource: {name: folderName, mimeType: 'application/vnd.google-apps.folder'}, 
            fields: 'id' 
        });
        mainFolderId = folder.result.id;
    }
    
    // Create AI Stories folder if it doesn't exist
    const aiFolderName = 'AI_Generated_Stories';
    const aiResponse = await gapi.client.drive.files.list({
        q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id, name)'
    });
    if (aiResponse.result.files.length === 0) {
        const aiFolder = await gapi.client.drive.files.create({ 
            resource: {
                name: aiFolderName, 
                mimeType: 'application/vnd.google-apps.folder', 
                parents: [mainFolderId]
            }, 
            fields: 'id' 
        });
    }
}

async function createStoryFolder(storyTitle, isAiGenerated = false) {
    let parentId = mainFolderId;
    
    if (isAiGenerated) {
        // Find AI Stories folder
        const aiFolderName = 'AI_Generated_Stories';
        const response = await gapi.client.drive.files.list({
            q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id, name)'
        });
        if (response.result.files.length > 0) {
            parentId = response.result.files[0].id;
        }
    }
    
    const folder = await gapi.client.drive.files.create({
        resource: { 
            name: storyTitle, 
            mimeType: 'application/vnd.google-apps.folder', 
            parents: [parentId] 
        }, 
        fields: 'id'
    });
    return folder.result.id;
}

async function saveStoryContent(storyTitle, chapterTitle, content, storyFolderId, isAiGenerated = false) {
    const fileMetadata = { 
        name: `${chapterTitle}.txt`, 
        parents: [storyFolderId],
        description: isAiGenerated ? "AI-Generated" : "User-Created"
    };
    
    await gapi.client.request({
        path: 'https://www.googleapis.com/upload/drive/v3/files', 
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
        body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: text/plain\r\n\r\n' +
              content + '\r\n--foo_bar_baz--'
    });
}

async function loadStoryHistory() {
    const response = await gapi.client.drive.files.list({
        q: `'${mainFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    const folders = response.result.files; 
    storyHistory = [];
    
    for (let folder of folders) {
        if (folder.name === 'AI_Generated_Stories') continue;
        
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime, description)'
        });
        storyHistory.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files,
            isAiGenerated: false
        });
    }
    displayHistory(); 
    displayFolders();
}

async function loadAiGeneratedStories() {
    const aiFolderName = 'AI_Generated_Stories';
    const response = await gapi.client.drive.files.list({
        q: `name='${aiFolderName}' and mimeType='application/vnd.google-apps.folder' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id, name)'
    });
    
    if (response.result.files.length === 0) {
        aiGeneratedStories = [];
        return;
    }
    
    const aiFolderId = response.result.files[0].id;
    const aiFoldersResponse = await gapi.client.drive.files.list({
        q: `'${aiFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name, createdTime)', 
        orderBy: 'createdTime desc'
    });
    
    const aiFolders = aiFoldersResponse.result.files;
    aiGeneratedStories = [];
    
    for (let folder of aiFolders) {
        const filesResponse = await gapi.client.drive.files.list({
            q: `'${folder.id}' in parents and trashed=false`,
            fields: 'files(id, name, createdTime, description)'
        });
        aiGeneratedStories.push({ 
            storyTitle: folder.name, 
            folderId: folder.id, 
            createdTime: folder.createdTime, 
            chapters: filesResponse.result.files,
            isAiGenerated: true
        });
    }
}

// AI Training Functions - CẢI TIẾN CHO HỌC SÂUHƠN
async function trainAI() {
    showLoading(true);
    showStatus('Đang bắt đầu huấn luyện AI chuyên sâu...', 'success');
    
    const allFiles = [];
    for (let story of storyHistory) {
        for (let chapter of story.chapters) {
            if (chapter.name.endsWith('.txt')) {
                allFiles.push({...chapter, storyTitle: story.storyTitle});
            }
        }
    }
    
    document.getElementById('totalFiles').textContent = allFiles.length;
    let processedFiles = 0;
    
    for (let file of allFiles) {
        try {
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const content = response.body;
            await deepProcessContent(content, file.storyTitle, file.name);
            processedFiles++;
            
            // Update progress
            const progress = (processedFiles / allFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('trainedFiles').textContent = processedFiles;
            
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.error('Error processing file:', file.name, error);
        }
    }
    
    aiKnowledge.trainedFiles = processedFiles;
    updateAiStats();
    await saveAiKnowledge();
    showLoading(false);
    showStatus(`Huấn luyện hoàn thành! Đã xử lý ${processedFiles} file với học sâu.`, 'success');
}

// HÀM HỌC SÂU - PHÂN TÍCH CHUYÊN SÂU NỘI DUNG
async function deepProcessContent(content, storyTitle, fileName) {
    const sentences = content.split(/[.!?]+/).filter(s => s.length > 5);
    const paragraphs = content.split(/\n\s*\n/).filter(p => p.length > 10);
    
    sentences.forEach((sentence, index) => {
        // Học từ vựng cơ bản
        const words = sentence.toLowerCase()
            .replace(/[^\w\sàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/g, '')
            .split(/\s+/);
        
        words.forEach(word => {
            if (word.length > 2) {
                aiKnowledge.vocabulary.add(word);
            }
        });
        
        // Học cấu trúc câu phức tạp
        if (sentence.match(/tôi (cảm thấy|nghĩ|thấy|nhận ra|để ý)/i)) {
            aiKnowledge.sentenceStructures.add(sentence.trim());
        }
        
        // Phát hiện diễn biến tình tiết
        if (sentence.match(/(khi|lúc|sau khi|trước khi|trong lúc|bỗng nhiên|đột ngột)/i)) {
            aiKnowledge.plotPoints.add(sentence.trim());
        }
        
        // Học pattern cảm xúc và tâm lý
        if (sentence.match(/(căng thẳng|lo lắng|bối rối|kích thích|khao khát|tội lỗi|không thể|phải chăng)/i)) {
            aiKnowledge.emotionalPatterns.add(sentence.trim());
        }
        
        // Phân tích mối quan hệ
        if (sentence.match(/(bố (chồng|tôi)|con dâu|vợ tôi|họ|chúng tôi)/i)) {
            aiKnowledge.characterRelationships.add(sentence.trim());
        }
        
        // Học style tường thuật ngôi thứ nhất
        if (sentence.match(/^(tôi|trong tâm trí|cảm giác|điều này khiến)/i)) {
            aiKnowledge.narrativeStyles.add(sentence.trim());
        }
        
        // Lưu dialogue
        if (sentence.includes('"') || sentence.includes('"') || sentence.includes('"')) {
            const dialogueMatch = sentence.match(/["'"](.*?)["'"]/);
            if (dialogueMatch && !aiKnowledge.dialogues.includes(dialogueMatch[1])) {
                aiKnowledge.dialogues.push(dialogueMatch[1]);
            }
        }
        
        // Lưu context
        if (sentence.match(/(trong|khi|lúc|sau|trước|vào|giữa|ở)/)) {
            if (!aiKnowledge.contexts.includes(sentence) && aiKnowledge.contexts.length < 1000) {
                aiKnowledge.contexts.push(sentence);
            }
        }
    });
    
    // Phân tích paragraph để học cấu trúc dài hơn
    paragraphs.forEach(paragraph => {
        if (paragraph.length > 100 && paragraph.length < 500) {
            // Học cấu trúc đoạn văn
            if (!aiKnowledge.paragraphStructures) aiKnowledge.paragraphStructures = [];
            if (aiKnowledge.paragraphStructures.length < 500) {
                aiKnowledge.paragraphStructures.push(paragraph.trim());
            }
        }
    });
    
    // Lưu thông tin truyện
    if (!aiKnowledge.stories.includes(storyTitle)) {
        aiKnowledge.stories.push(storyTitle);
    }
}

function updateAiStats() {
    document.getElementById('vocabularyCount').textContent = aiKnowledge.vocabulary.size;
    document.getElementById('sentenceStructures').textContent = aiKnowledge.sentenceStructures.size;
    document.getElementById('plotPoints').textContent = aiKnowledge.plotPoints.size;
    document.getElementById('emotionalPatterns').textContent = aiKnowledge.emotionalPatterns.size;
}

// HÀM TẠO TRUYỆN CẢI TIẾN - LOGIC THÔNG MINH HỚN
async function generateStory() {
    const chapterCount = parseInt(document.getElementById('chapterCount').value) || 100;
    if (chapterCount < 100 || chapterCount > 150) {
        showStatus('Số chương phải từ 100 đến 150!', 'error');
        return;
    }
    
    if (aiKnowledge.vocabulary.size < 100) {
        showStatus('AI chưa được huấn luyện đủ! Hãy huấn luyện AI với ít nhất 100 từ vựng.', 'error');
        return;
    }
    
    showLoading(true);
    showStatus('AI đang tạo truyện với logic nâng cao...', 'success');
    
    // Tạo cốt truyện tổng thể trước
    const overallPlot = generateOverallPlot();
    const title = generateIntelligentTitle();
    
    // Create folder for the new story
    const storyFolderId = await createStoryFolder(title, true);
    
    // Generate chapters with progressive storyline
    let generatedChapters = 0;
    const totalChapters = chapterCount;
    
    for (let i = 1; i <= totalChapters; i++) {
        const chapterTitle = `Chương ${i}: ${generateChapterTitle(i, totalChapters)}`;
        const chapterContent = generateIntelligentChapterContent(i, totalChapters, overallPlot);
        
        // Save chapter to Google Drive
        await saveStoryContent(title, chapterTitle, chapterContent, storyFolderId, true);
        
        generatedChapters++;
        
        // Update progress
        const progress = (generatedChapters / totalChapters) * 100;
        document.getElementById('generationProgressFill').style.width = progress + '%';
        document.getElementById('generationStatus').innerHTML = 
            `<div class="status success">Đang tạo chương ${generatedChapters}/${totalChapters}: ${chapterTitle}</div>`;
        
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // Reload stories
    await loadAiGeneratedStories();
    await loadStoryHistory();
    showLoading(false);
    showStatus(`Đã tạo thành công truyện "${title}" với ${totalChapters} chương!`, 'success');
    document.getElementById('generationStatus').innerHTML = '';
}

// HÀM TẠO CỐT TRUYỆN TỔNG THỂ
function generateOverallPlot() {
    const plotPhases = {
        introduction: "Khởi đầu với sự quan sát đầu tiên của người chồng về mối quan hệ đặc biệt",
        development: "Phát triển các tình tiết phức tạp và sự thay đổi trong mối quan hệ",
        climax: "Đỉnh cao của xung đột nội tâm và những khám phá quan trọng",
        resolution: "Giải quyết và kết thúc với sự thấu hiểu sâu sắc"
    };
    
    return {
        mainTheme: "Mối quan hệ phức tạp trong gia đình qua góc nhìn của người chồng",
        characterDevelopment: "Sự thay đổi nhận thức và cảm xúc của nhân vật chính",
        emotionalArc: "Từ tò mò ban đầu đến hiểu biết sâu sắc về bản chất con người",
        phases: plotPhases
    };
}

// HÀM TẠO TIÊU ĐỀ THÔNG MINH
function generateIntelligentTitle() {
    const titleTemplates = [
        "Những Điều Tôi Thầm Biết",
        "Bí Mật Trong Gia Đình",
        "Góc Nhìn Của Người Chồng",
        "Quan Sát Trong Thầm Lặng",
        "Những Gì Tôi Không Nói Ra",
        "Ranh Giới Mờ Nhạt",
        "Câu Chuyện Chưa Kể",
        "Trong Sự Im Lặng"
    ];
    
    return titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
}

// HÀM TẠO TIÊU ĐỀ CHƯƠNG
function generateChapterTitle(chapterNum, totalChapters) {
    const progress = chapterNum / totalChapters;
    
    if (progress < 0.2) {
        // Giai đoạn mở đầu
        const beginningTitles = ["Khởi đầu quan sát", "Những dấu hiệu đầu tiên", "Sự tò mò bắt đầu", "Cảm giác lạ lùng"];
        return beginningTitles[Math.floor(Math.random() * beginningTitles.length)];
    } else if (progress < 0.5) {
        // Giai đoạn phát triển
        const developmentTitles = ["Nhận ra điều bất thường", "Quan sát kỹ hơn", "Những phát hiện mới", "Sự thay đổi"];
        return developmentTitles[Math.floor(Math.random() * developmentTitles.length)];
    } else if (progress < 0.8) {
        // Giai đoạn cao trào
        const climaxTitles = ["Xung đột nội tâm", "Khám phá sự thật", "Không thể phủ nhận", "Đối mặt với thực tế"];
        return climaxTitles[Math.floor(Math.random() * climaxTitles.length)];
    } else {
        // Giai đoạn kết thúc
        const endingTitles = ["Sự thấu hiểu", "Chấp nhận thực tế", "Kết luận cuối cùng", "Bình yên tìm lại"];
        return endingTitles[Math.floor(Math.random() * endingTitles.length)];
    }
}

// HÀM TẠO NỘI DUNG CHƯƠNG THÔNG MINH
function generateIntelligentChapterContent(chapterNum, totalChapters, overallPlot) {
    const progress = chapterNum / totalChapters;
    let content = "";
    
    // Xác định giai đoạn cốt truyện
    let phase = 'introduction';
    if (progress > 0.25) phase = 'development';
    if (progress > 0.65) phase = 'climax';
    if (progress > 0.85) phase = 'resolution';
    
    // Tạo đoạn mở đầu phù hợp với giai đoạn
    content += generatePhaseIntro(phase, chapterNum) + "\n\n";
    
    // Tạo 3-5 đoạn văn chính
    const paragraphCount = 3 + Math.floor(Math.random() * 3);
    for (let i = 0; i < paragraphCount; i++) {
        content += generateIntelligentParagraph(phase, i, paragraphCount) + "\n\n";
    }
    
    // Thêm kết thúc chương
    content += generateChapterEnding(phase) + "\n";
    
    return content;
}

// HÀM TẠO ĐOẠN MỞ ĐẦU THEO GIAI ĐOẠN
function generatePhaseIntro(phase, chapterNum) {
    const templates = {
        introduction: [
            `Hôm nay là ngày thứ ${chapterNum} kể từ khi tôi bắt đầu để ý đến những điều lạ lùng trong nhà.`,
            `Tôi không thể ngờ được rằng cuộc sống gia đình tôi lại có những bí mật như thế này.`,
            `Mọi thứ bắt đầu từ một cử chỉ nhỏ mà tôi tình cờ nhận ra.`
        ],
        development: [
            `Càng quan sát, tôi càng thấy rõ hơn về mối quan hệ đặc biệt này.`,
            `Những nghi ngờ trong tôi ngày càng lớn dần theo thời gian.`,
            `Tôi bắt đầu hiểu tại sao mọi thứ trong nhà lại có những thay đổi tinh tế.`
        ],
        climax: [
            `Hôm nay, tôi không thể phủ nhận những gì đang diễn ra trước mắt mình.`,
            `Sự thật đã trở nên quá rõ ràng để tôi có thể bỏ qua.`,
            `Xung đột trong tâm trí tôi đạt đến đỉnh điểm.`
        ],
        resolution: [
            `Cuối cùng, tôi cũng tìm được cách để hiểu và chấp nhận thực tế.`,
            `Nhìn lại chặng đường đã qua, tôi nhận ra nhiều điều về bản thân mình.`,
            `Giờ đây, tôi có thể nhìn nhận mọi thứ một cách bình tĩnh hơn.`
        ]
    };
    
    const phaseTemplates = templates[phase] || templates.introduction;
    return phaseTemplates[Math.floor(Math.random() * phaseTemplates.length)];
}

// HÀM TẠO ĐOẠN VĂN THÔNG MINH
function generateIntelligentParagraph(phase, paragraphIndex, totalParagraphs) {
    let paragraph = "";
    
    // Tạo 4-6 câu cho mỗi đoạn
    const sentenceCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < sentenceCount; i++) {
        paragraph += generateContextualSentence(phase, i, sentenceCount) + " ";
    }
    
    return paragraph.trim();
}

// HÀM TẠO CÂU VỚI NGỮ CẢNH
function generateContextualSentence(phase, sentenceIndex, totalSentences) {
    // Sử dụng kiến thức đã học để tạo câu có nghĩa
    const learnedStructures = Array.from(aiKnowledge.sentenceStructures);
    const learnedEmotions = Array.from(aiKnowledge.emotionalPatterns);
    const learnedPlots = Array.from(aiKnowledge.plotPoints);
    
    if (learnedStructures.length > 0 && Math.random() < 0.3) {
        // Sử dụng cấu trúc đã học
        return adaptLearnedSentence(getRandomElement(learnedStructures));
    }
    
    // Tạo câu mới dựa trên pattern
    const patterns = narrativePatterns[phase === 'climax' ? 'conflict' : 'observation'] || narrativePatterns.innerMonologue;
    let sentence = getRandomElement(patterns);
    
    // Thay thế placeholder
    sentence = replacePlaceholders(sentence);
    
    return sentence;
}

// HÀM CHUYỂN ĐỔI CÂU ĐÃ HỌC
function adaptLearnedSentence(sentence) {
    // Thay đổi nhẹ cấu trúc để tạo sự đa dạng
    sentence = sentence.replace(/\b(tôi|mình)\b/gi, Math.random() < 0.3 ? 'bản thân tôi' : 'tôi');
    sentence = sentence.replace(/\b(thấy|nhìn)\b/gi, Math.random() < 0.3 ? 'quan sát' : 'thấy');
    sentence = sentence.replace(/\b(cảm thấy|cảm giác)\b/gi, Math.random() < 0.3 ? 'nhận thức' : 'cảm thấy');
    
    return sentence;
}

// HÀM THAY THẾ PLACEHOLDER
function replacePlaceholders(sentence) {
    const replacements = {
        '{situation}': getRandomElement(['bữa cơm tối', 'lúc xem TV', 'khi tôi về nhà', 'những buổi chiều', 'cuối tuần']),
        '{wife}': getRandomElement(['vợ tôi', 'con dâu', 'cô ấy', 'người phụ nữ trong nhà']),
        '{observation}': getRandomElement(['cách nhìn', 'cử chỉ', 'ánh mắt', 'nụ cười', 'cách cư xử']),
        '{emotion}': getRandomElement(['bối rối', 'tò mò', 'lo lắng', 'kích thích', 'không yên']),
        '{action}': getRandomElement(['nói chuyện', 'cười đùa', 'giúp đỡ', 'đứng gần', 'trao đổi']),
        '{manner}': getRandomElement(['thân mật', 'kín đáo', 'tự nhiên', 'đặc biệt', 'khác thường']),
        '{innerThought}': getRandomElement(['tôi thắc mắc', 'tôi băn khoăn', 'tôi suy ngẫm', 'tôi tự hỏi']),
        '{question}': getRandomElement(['điều này có ý nghĩa gì', 'tôi có nên lo lắng', 'đây có phải điều bình thường', 'mọi thứ có đang thay đổi']),
        '{feeling}': getRandomElement(['căng thẳng', 'bất an', 'tò mò', 'khó hiểu', 'phức tạp']),
        '{intensity}': getRandomElement(['mạnh mẽ', 'sâu sắc', 'không thể phủ nhận', 'ngày càng rõ ràng']),
        '{physicalDescription}': getRandomElement(['ánh mắt', 'nụ cười', 'cách di chuyển', 'cử chỉ tay', 'biểu cảm']),
        '{timeFrame}': getRandomElement(['những ngày gần đây', 'thời gian qua', 'tuần vừa rồi', 'gần đây'])
    };
    
    Object.keys(replacements).forEach(placeholder => {
        sentence = sentence.replace(new RegExp(placeholder, 'g'), replacements[placeholder]);
    });
    
    return sentence;
}

// HÀM TẠO KẾT THÚC CHƯƠNG
function generateChapterEnding(phase) {
    const endings = {
        introduction: [
            "Tôi quyết định sẽ quan sát kỹ hơn trong những ngày tới.",
            "Có lẽ tôi cần thời gian để hiểu rõ hơn về tình hình này.",
            "Câu hỏi trong đầu tôi vẫn chưa có lời giải đáp."
        ],
        development: [
            "Mọi thứ đang trở nên phức tạp hơn tôi nghĩ.",
            "Tôi cảm thấy mình đang đứng trước một bí ẩn lớn.",
            "Những mảnh ghép bắt đầu khớp với nhau trong tâm trí tôi."
        ],
        climax: [
            "Giờ đây tôi không thể làm ngơ trước sự thật này nữa.",
            "Cuộc sống của tôi sẽ không bao giờ như trước.",
            "Tôi phải đối mặt với thực tế dù có đau đớn đến đâu."
        ],
        resolution: [
            "Cuối cùng tôi cũng tìm được sự bình yên trong tâm hồn.",
            "Tôi học được rằng cuộc sống luôn phức tạp hơn những gì ta nghĩ.",
            "Giờ đây tôi có thể nhìn mọi thứ với con mắt khác."
        ]
    };
    
    const phaseEndings = endings[phase] || endings.introduction;
    return phaseEndings[Math.floor(Math.random() * phaseEndings.length)];
}

// HÀM LẤY PHẦN TỬ NGẪU NHIÊN
function getRandomElement(array) {
    if (!array || array.length === 0) return '';
    return array[Math.floor(Math.random() * array.length)];
}

// HÀM LỰU KIẾN THỨC AI
async function saveAiKnowledge() {
    const knowledgeStr = JSON.stringify({
        vocabulary: Array.from(aiKnowledge.vocabulary),
        stories: aiKnowledge.stories,
        trainedFiles: aiKnowledge.trainedFiles,
        sentenceStructures: Array.from(aiKnowledge.sentenceStructures),
        plotPoints: Array.from(aiKnowledge.plotPoints),
        emotionalPatterns: Array.from(aiKnowledge.emotionalPatterns),
        dialogues: aiKnowledge.dialogues || [],
        contexts: aiKnowledge.contexts || [],
        characterRelationships: Array.from(aiKnowledge.characterRelationships || new Set()),
        narrativeStyles: Array.from(aiKnowledge.narrativeStyles || new Set()),
        paragraphStructures: aiKnowledge.paragraphStructures || []
    });
    
    const fileName = 'ai_knowledge_advanced.json';
    const response = await gapi.client.drive.files.list({
        q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
        fields: 'files(id)'
    });
    
    if (response.result.files.length > 0) {
        const fileId = response.result.files[0].id;
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${fileId}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: knowledgeStr
        });
    } else {
        const fileMetadata = { 
            name: fileName, 
            parents: [mainFolderId] 
        };
        
        await gapi.client.request({
            path: 'https://www.googleapis.com/upload/drive/v3/files', 
            method: 'POST',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': 'multipart/related; boundary="foo_bar_baz"' },
            body: '--foo_bar_baz\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                  JSON.stringify(fileMetadata) + '\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n' +
                  knowledgeStr + '\r\n--foo_bar_baz--'
        });
    }
}

// HÀM TẢI KIẾN THỨC AI
async function loadAiKnowledge() {
    const fileName = 'ai_knowledge_advanced.json';
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${fileName}' and '${mainFolderId}' in parents and trashed=false`,
            fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            const knowledge = JSON.parse(fileResponse.body);
            aiKnowledge.vocabulary = new Set(knowledge.vocabulary);
            aiKnowledge.stories = knowledge.stories;
            aiKnowledge.trainedFiles = knowledge.trainedFiles;
            aiKnowledge.sentenceStructures = new Set(knowledge.sentenceStructures || []);
            aiKnowledge.plotPoints = new Set(knowledge.plotPoints || []);
            aiKnowledge.emotionalPatterns = new Set(knowledge.emotionalPatterns || []);
            aiKnowledge.dialogues = knowledge.dialogues || [];
            aiKnowledge.contexts = knowledge.contexts || [];
            aiKnowledge.characterRelationships = new Set(knowledge.characterRelationships || []);
            aiKnowledge.narrativeStyles = new Set(knowledge.narrativeStyles || []);
            aiKnowledge.paragraphStructures = knowledge.paragraphStructures || [];
        }
    } catch (error) {
        console.error('Error loading AI knowledge:', error);
    }
}

function resetAI() {
    if (confirm('Bạn có chắc chắn muốn reset toàn bộ kiến thức của AI?')) {
        aiKnowledge = { 
            vocabulary: new Set(), 
            stories: [], 
            trainedFiles: 0,
            sentenceStructures: new Set(),
            plotPoints: new Set(),
            emotionalPatterns: new Set(),
            dialogues: [],
            contexts: [],
            characterRelationships: new Set(),
            narrativeStyles: new Set()
        };
        updateAiStats();
        saveAiKnowledge();
        showStatus('Đã reset kiến thức của AI!', 'success');
    }
}

// HÀM KIỂM TRA NỘI DUNG NHẠY CẢM
function isSensitiveContent(content) {
    const sensitiveKeywords = [
        'bố chồng', 'con dâu', 'khao khát', 'kích thích', 'dục vọng', 'bí mật', 
        'thầm kín', 'cấm kị', 'ranh giới', 'quan hệ đặc biệt', 'không thể cưỡng lại',
        'ham muốn', 'thèm muốn', 'tội lỗi', 'xấu hổ', 'bối rối về tình dục'
    ];
    
    return sensitiveKeywords.some(keyword => 
        content.toLowerCase().includes(keyword.toLowerCase())
    );
}

// HÀM HIỂN THỊ NỘI DUNG CHƯƠNG
async function viewChapterContent(chapter, folderId) {
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    try {
        const response = await gapi.client.drive.files.get({
            fileId: chapter.id,
            alt: 'media'
        });
        
        const content = response.body;
        chapterContent.textContent = content;
        chapterContent.style.display = 'block';
        chapterActions.style.display = 'block';
        currentEditingChapter = { id: chapter.id, content: content, name: chapter.name };
        
        // Kiểm tra và xử lý nội dung nhạy cảm
        if (isSensitiveContent(content)) {
            chapterContent.classList.add('sensitive-content');
            
            const revealBtn = document.createElement('button');
            revealBtn.className = 'reveal-btn';
            revealBtn.textContent = '👁️ Hiển thị nội dung nhạy cảm';
            revealBtn.onclick = function() {
                chapterContent.classList.toggle('revealed');
                this.textContent = chapterContent.classList.contains('revealed') ? 
                    '🙈 Ẩn nội dung nhạy cảm' : '👁️ Hiển thị nội dung nhạy cảm';
            };
            
            chapterContent.parentNode.insertBefore(revealBtn, chapterContent);
        }
    } catch (error) {
        console.error('Error loading chapter content:', error);
        showStatus('Có lỗi khi tải nội dung chương!', 'error');
    }
}

// UI Functions
function displayHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    const allStories = [...storyHistory, ...aiGeneratedStories];
    
    if (allStories.length === 0) {
        historyList.innerHTML = '<div class="history-item">Chưa có truyện nào.</div>';
        return;
    }
    
    allStories.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = () => viewStoryChapters(story);
        
        let adultTag = story.isAiGenerated ? ' <span style="color:#ff9a3d">[AI-18+]</span>' : '';
        
        item.innerHTML = `
            <div class="story-title">${story.storyTitle}${adultTag}</div>
            <div class="story-chapter">${story.chapters.length} chương</div>
            <div class="story-date">${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
        `;
        historyList.appendChild(item);
    });
}

function displayFolders() {
    const folderList = document.getElementById('folderList');
    const existingStory = document.getElementById('existingStory');
    folderList.innerHTML = '';
    existingStory.innerHTML = '<option value="">-- Chọn truyện --</option>';
    
    if (storyHistory.length === 0) {
        folderList.innerHTML = '<div class="history-item">Chưa có thư mục nào.</div>';
        return;
    }
    
    storyHistory.forEach(story => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        item.innerHTML = `
            <div class="story-title">${story.storyTitle}</div>
            <div class="story-chapter">${story.chapters.length} chương</div>
        `;
        folderList.appendChild(item);
        
        const option = document.createElement('option');
        option.value = story.folderId;
        option.textContent = story.storyTitle;
        existingStory.appendChild(option);
    });
}

function toggleStoryMode() {
    const mode = document.getElementById('storyMode').value;
    if (mode === 'new') {
        document.getElementById('newStoryGroup').style.display = 'block';
        document.getElementById('existingStoryGroup').style.display = 'none';
        document.getElementById('submitButtonText').textContent = 'Lưu Truyện Mới';
    } else {
        document.getElementById('newStoryGroup').style.display = 'none';
        document.getElementById('existingStoryGroup').style.display = 'block';
        document.getElementById('submitButtonText').textContent = 'Thêm Chương Mới';
    }
}

async function handleStoryFormSubmit(e) {
    e.preventDefault();
    showLoading(true);
    
    const mode = document.getElementById('storyMode').value;
    const storyTitle = document.getElementById('storyTitle').value;
    const chapterTitle = document.getElementById('chapterTitle').value;
    const storyContent = document.getElementById('storyContent').value;
    
    try {
        let storyFolderId;
        if (mode === 'new') {
            storyFolderId = await createStoryFolder(storyTitle);
        } else {
            storyFolderId = document.getElementById('existingStory').value;
            if (!storyFolderId) {
                showStatus('Vui lòng chọn một truyện có sẵn!', 'error');
                showLoading(false);
                return;
            }
        }
        
        await saveStoryContent(storyTitle, chapterTitle, storyContent, storyFolderId);
        await loadStoryHistory();
        
        document.getElementById('storyForm').reset();
        showStatus('Đã lưu truyện thành công!', 'success');
    } catch (error) {
        console.error('Error saving story:', error);
        showStatus('Có lỗi xảy ra khi lưu truyện!', 'error');
    }
    showLoading(false);
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = `status ${type}`;
    statusEl.style.display = 'block';
    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Modal Functions
function viewStoryChapters(story) {
    const modal = document.getElementById('chaptersModal');
    const title = document.getElementById('chaptersModalTitle');
    const chapterList = document.getElementById('chapterList');
    const chapterContent = document.getElementById('chapterContent');
    const chapterActions = document.getElementById('chapterActions');
    
    title.textContent = story.storyTitle;
    chapterList.innerHTML = '';
    chapterContent.style.display = 'none';
    chapterActions.style.display = 'none';
    
    story.chapters.forEach(chapter => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.onclick = () => viewChapterContent(chapter, story.folderId);
        item.textContent = chapter.name.replace('.txt', '');
        chapterList.appendChild(item);
    });
    
    modal.style.display = 'block';
}

function editChapter() {
    const chapterContent = document.getElementById('chapterContent');
    chapterContent.contentEditable = true;
    chapterContent.focus();
    chapterContent.style.background = 'rgba(255, 255, 255, 0.1)';
    chapterContent.style.border = '1px solid rgba(102, 126, 234, 0.5)';
}

async function saveChapterChanges() {
    if (!currentEditingChapter) return;
    
    const chapterContent = document.getElementById('chapterContent');
    const newContent = chapterContent.textContent;
    
    try {
        await gapi.client.request({
            path: `https://www.googleapis.com/upload/drive/v3/files/${currentEditingChapter.id}`,
            method: 'PATCH',
            params: { uploadType: 'media' },
            body: newContent
        });
        
        chapterContent.contentEditable = false;
        chapterContent.style.background = 'rgba(255, 255, 255, 0.05)';
        chapterContent.style.border = 'none';
        currentEditingChapter.content = newContent;
        
        showStatus('Đã lưu thay đổi thành công!', 'success');
    } catch (error) {
        console.error('Error saving chapter changes:', error);
        showStatus('Có lỗi khi lưu thay đổi!', 'error');
    }
}

function cancelEdit() {
    const chapterContent = document.getElementById('chapterContent');
    chapterContent.textContent = currentEditingChapter.content;
    chapterContent.contentEditable = false;
    chapterContent.style.background = 'rgba(255, 255, 255, 0.05)';
    chapterContent.style.border = 'none';
}

async function deleteChapter() {
    if (!currentEditingChapter || !confirm('Bạn có chắc chắn muốn xóa chương này?')) return;
    
    try {
        await gapi.client.drive.files.delete({ fileId: currentEditingChapter.id });
        closeModal('chaptersModal');
        await loadStoryHistory();
        showStatus('Đã xóa chương thành công!', 'success');
    } catch (error) {
        console.error('Error deleting chapter:', error);
        showStatus('Có lỗi khi xóa chương!', 'error');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    currentEditingChapter = null;
    
    // Remove reveal buttons
    const revealBtns = document.querySelectorAll('.reveal-btn');
    revealBtns.forEach(btn => btn.remove());
}

function viewAiStories() {
    const modal = document.getElementById('aiStoriesModal');
    const aiStoryList = document.getElementById('aiStoryList');
    
    aiStoryList.innerHTML = '';
    
    if (aiGeneratedStories.length === 0) {
        aiStoryList.innerHTML = '<div class="history-item">Chưa có truyện nào được AI tạo.</div>';
    } else {
        aiGeneratedStories.forEach(story => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.onclick = () => {
                closeModal('aiStoriesModal');
                viewStoryChapters(story);
            };
            
            item.innerHTML = `
                <div class="story-title">${story.storyTitle} <span style="color:#ff9a3d">[AI-18+]</span></div>
                <div class="story-chapter">${story.chapters.length} chương - ${new Date(story.createdTime).toLocaleDateString('vi-VN')}</div>
            `;
            aiStoryList.appendChild(item);
        });
    }
    
    modal.style.display = 'block';
}

// Menu Navigation
function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.getElementById(sectionId).classList.add('active');
    
    document.querySelectorAll('.nav-menu button').forEach(button => {
        button.classList.remove('active');
    });
    document.querySelector(`.nav-menu button[data-section="${sectionId}"]`).classList.add('active');
}

// Event Listeners
document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
document.getElementById('storyForm').addEventListener('submit', handleStoryFormSubmit);
document.getElementById('trainAiButton').addEventListener('click', trainAI);
document.getElementById('resetAiButton').addEventListener('click', resetAI);
document.getElementById('generateStoryButton').addEventListener('click', generateStory);
document.getElementById('viewAiStoriesButton').addEventListener('click', viewAiStories);

// Menu navigation event listeners
document.getElementById('menuTraining').addEventListener('click', () => showSection('trainingSection'));
document.getElementById('menuGeneration').addEventListener('click', () => showSection('generationSection'));
document.getElementById('menuManagement').addEventListener('click', () => showSection('managementSection'));
document.getElementById('menuHistory').addEventListener('click', () => showSection('historySection'));

// Add data-section attributes to menu buttons
document.getElementById('menuTraining').setAttribute('data-section', 'trainingSection');
document.getElementById('menuGeneration').setAttribute('data-section', 'generationSection');
document.getElementById('menuManagement').setAttribute('data-section', 'managementSection');
document.getElementById('menuHistory').setAttribute('data-section', 'historySection');

// Initialize the app
window.onload = () => {
    initializeGapi();
    initializeGis();
};
</script>
</body>
</html>
